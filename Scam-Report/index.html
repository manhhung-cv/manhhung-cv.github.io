<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Danh Sách Đen Công Ty & Kền - Cảnh Báo Lừa Đảo</title>
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <!-- Font Awesome CDN -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" xintegrity="sha512-DTOQO9RWCH3ppGqcWaEA1BIZOC6xxalwEsw9c2QQeAIftl+Vegovlnee1c9QX4TctnWMn13TZye+giMm8e2LwA==" crossorigin="anonymous" referrerpolicy="no-referrer" />
    <!-- Masonry & ImagesLoaded CDN -->
    <script src="https://unpkg.com/masonry-layout@4/dist/masonry.pkgd.min.js"></script>
    <script src="https://unpkg.com/imagesloaded@5/imagesloaded.pkgd.min.js"></script>
    <style>
        /* --- CSS Variables for Theming --- */
        :root {
            /* Light Theme */
            --bg-color: #f8fafc;
            --card-bg: #ffffff;
            --text-primary: #1e293b;
            --text-secondary: #475569;
            --text-tertiary: #64748b;
            --border-color: #e2e8f0;
            --grid-line-color: rgba(0, 0, 0, 0.05);
            --control-bg: rgba(255, 255, 255, 0.7);
            --shadow-color: 220 3% 15%;
            --shadow-elevation-low:
                0.3px 0.5px 0.7px hsl(var(--shadow-color) / 0.2),
                0.4px 0.8px 1px -1.2px hsl(var(--shadow-color) / 0.2),
                1px 2px 2.5px -2.5px hsl(var(--shadow-color) / 0.2);
            --shadow-elevation-medium:
                0.3px 0.5px 0.7px hsl(var(--shadow-color) / 0.25),
                0.8px 1.6px 2px -0.8px hsl(var(--shadow-color) / 0.25),
                2.1px 4.1px 5.2px -1.7px hsl(var(--shadow-color) / 0.25),
                5px 10px 12.6px -2.5px hsl(var(--shadow-color) / 0.25);
            
            --red-500: #ef4444; --red-600: #dc2626; --red-700: #b91c1c; --red-bg: #fef2f2;
            --blue-600: #2563eb; --blue-700: #1d4ed8;
            --green-500: #22c55e; --green-600: #16a34a; --green-bg: #f0fdf4; --green-border: #bbf7d0;
            --gray-50: #f8fafc; --gray-100: #f1f5f9; --gray-200: #e2e8f0; --gray-300: #cbd5e1; --gray-400: #94a3b8;
        }

        html.dark {
            /* Dark Theme */
            --bg-color: #0f172a;
            --card-bg: #1e293b;
            --text-primary: #e2e8f0;
            --text-secondary: #94a3b8;
            --text-tertiary: #64748b;
            --border-color: #334155;
            --grid-line-color: rgba(255, 255, 255, 0.05);
            --control-bg: rgba(30, 41, 59, 0.7);
            --shadow-color: 220 3% 5%;
            
            --red-bg: rgba(220, 38, 38, 0.1);
            --green-bg: rgba(34, 197, 94, 0.1);
            --green-border: #22c55e;
            --gray-50: #334155;
            --gray-100: #1e293b;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        @keyframes fadeOut { from { opacity: 1; } to { opacity: 0; } }
        @keyframes scaleUp { from { transform: scale(0.95); opacity: 0; } to { transform: scale(1); opacity: 1; } }
        @keyframes slideIn { from { transform: translateX(100%); opacity: 0; } to { transform: translateX(0); opacity: 1; } }

        body {
            font-family: 'Inter', sans-serif;
            scroll-behavior: smooth;
            background-color: var(--bg-color);
            color: var(--text-primary);
            /* Grid pattern background */
            background-image:
                linear-gradient(var(--grid-line-color) 1px, transparent 1px),
                linear-gradient(90deg, var(--grid-line-color) 1px, transparent 1px);
            background-size: 40px 40px;
            transition: background-color 0.3s ease, color 0.3s ease;
        }
        
        button, input, select, textarea {
            font-family: inherit;
            color: inherit;
        }

        /* --- Main Layout --- */
        .container {
            max-width: 1280px;
            margin-left: auto;
            margin-right: auto;
            padding: 1rem;
        }
        @media (min-width: 768px) { .container { padding: 1.5rem; } }

        /* --- Header --- */
        .page-header {
            text-align: center;
            margin-bottom: 2rem;
        }
        .page-header h1 {
            font-size: 2rem;
            font-weight: 700;
            color: var(--red-600);
        }
        @media (min-width: 768px) { .page-header h1 { font-size: 2.25rem; } }
        .page-header p {
            color: var(--text-secondary);
            margin-top: 0.25rem;
            font-size: 1rem;
        }

        /* --- Controls Section (Optimized) --- */
        .controls-section {
            background-color: var(--control-bg);
            backdrop-filter: blur(8px);
            padding: 1rem;
            border-radius: 1rem;
            box-shadow: var(--shadow-elevation-low);
            border: 1px solid var(--card-bg);
            margin-bottom: 2rem;
            position: sticky;
            top: 1rem;
            z-index: 10;
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }
        .controls-main-row {
            display: flex;
            flex-wrap: wrap;
            gap: 0.75rem;
            align-items: center;
        }
        .search-wrapper { position: relative; flex-grow: 1; min-width: 200px; }
        .search-wrapper i {
            position: absolute;
            left: 1rem;
            top: 50%;
            transform: translateY(-50%);
            color: var(--text-tertiary);
        }
        .controls-actions {
            display: flex;
            gap: 0.75rem;
            flex-shrink: 0;
        }
        
        /* --- Filter Buttons (Segmented Control) --- */
        .filter-container {
            display: inline-flex;
            border-radius: 0.5rem;
            overflow: hidden;
            border: 1px solid var(--border-color);
            background-color: var(--card-bg);
            width: 100%;
        }
        @media (min-width: 768px) { .filter-container { width: auto; } }

        .filter-btn {
            padding: 0.5rem 1rem;
            border: none;
            border-right: 1px solid var(--border-color);
            font-size: 0.875rem;
            font-weight: 500;
            background-color: transparent;
            cursor: pointer;
            transition: all 0.2s ease;
            flex-grow: 1;
            text-align: center;
        }
        .filter-btn:last-child { border-right: none; }
        .filter-btn:hover { background-color: var(--gray-100); }
        .filter-btn.active {
            background-color: var(--red-600);
            color: white;
            box-shadow: inset 0 1px 3px rgba(0,0,0,0.1);
        }

        /* --- Form Elements --- */
        .form-input, .form-select, .form-textarea {
            width: 100%;
            padding: 0.625rem 1rem;
            border: 1px solid var(--border-color);
            border-radius: 0.5rem;
            background-color: var(--card-bg);
            transition: box-shadow 0.2s, border-color 0.2s;
            font-size: 0.9rem;
        }
        .form-input:focus, .form-select:focus, .form-textarea:focus {
            outline: none;
            border-color: var(--blue-600);
            box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.2);
        }
        .search-input { padding-left: 2.5rem; }
        
        .action-button, .settings-button {
            background-color: var(--red-600);
            color: white;
            font-weight: 600;
            padding: 0.625rem 1rem;
            border-radius: 0.5rem;
            border: none;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
            transition: background-color 0.2s ease;
            font-size: 0.9rem;
        }
        .action-button:hover { background-color: var(--red-700); }
        
        .settings-button {
            background-color: var(--card-bg);
            border: 1px solid var(--border-color);
            width: 40px;
            height: 100%;
            color: var(--text-secondary);
            transition: all 0.2s ease;
            flex-shrink: 0;
            padding: 0.625rem;
        }
        .settings-button:hover {
            background-color: var(--gray-100);
            border-color: var(--text-tertiary);
        }

        /* --- Masonry Grid & Cards --- */
        #company-list { margin: auto; }
        .grid-sizer, .company-card { width: 100%; }
        @media (min-width: 768px) { .grid-sizer, .company-card { width: calc(50% - 8px); } }
        @media (min-width: 1024px) { .grid-sizer, .company-card { width: calc(33.333% - 11px); } }
        
        .company-card {
            margin-bottom: 1rem;
            padding: 1.25rem;
            border-radius: 1rem;
            box-shadow: var(--shadow-elevation-low);
            background-color: var(--card-bg);
            transition: transform 0.2s ease, box-shadow 0.2s ease;
        }
        .company-card:hover {
            transform: translateY(-4px);
            box-shadow: var(--shadow-elevation-medium);
        }
        .company-card.highly-verified {
            border: 2px solid var(--red-500);
            box-shadow: 0 0 15px rgba(220, 38, 38, 0.2);
        }
        .highly-verified-banner {
            position: absolute;
            top: 0;
            left: 0;
            background-color: var(--red-600);
            color: white;
            font-size: 0.7rem;
            font-weight: 700;
            padding: 0.25rem 0.75rem;
            border-bottom-right-radius: 0.75rem;
            border-top-left-radius: 0.875rem;
            display: flex;
            align-items: center;
            gap: 0.375rem;
        }
        .card-content.has-banner { padding-top: 1rem; }
        
        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 0.5rem;
        }
        .card-header h3 {
            font-size: 1.125rem;
            font-weight: 600;
            padding-right: 0.5rem;
            flex-grow: 1;
        }
        .card-header-actions {
            display: flex;
            gap: 0.5rem;
            flex-shrink: 0;
        }
        .card-button-icon {
            background: none;
            border: none;
            color: var(--text-tertiary);
            cursor: pointer;
            padding: 0.25rem;
            width: 28px;
            height: 28px;
            border-radius: 50%;
            transition: background-color 0.2s ease, color 0.2s ease;
        }
        .card-button-icon:hover {
            background-color: var(--gray-100);
            color: var(--text-primary);
        }
        .card-location {
            font-size: 0.8rem;
            color: var(--text-secondary);
            margin-bottom: 0.75rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        .card-location i { width: 1rem; text-align: center; color: var(--text-tertiary); }
        .card-issues {
            font-size: 0.875rem;
            background-color: var(--gray-50);
            padding: 0.75rem;
            border-radius: 0.5rem;
            border: 1px solid var(--border-color);
        }
        .card-footer {
            font-size: 0.7rem;
            color: var(--text-tertiary);
            border-top: 1px solid var(--border-color);
            margin-top: 0.75rem;
            padding-top: 0.5rem;
        }
        .card-footer p { margin-bottom: 0.25rem; }
        .card-actions {
             margin-top: 0.75rem;
             padding-top: 0.75rem;
             border-top: 1px solid var(--border-color);
             display: flex;
             justify-content: space-between;
             align-items: center;
             gap: 0.5rem;
        }
        .card-button {
            width: 100%;
            font-size: 0.8rem;
            font-weight: 600;
            padding: 0.5rem 0.75rem;
            border-radius: 0.5rem;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
            border: 1px solid transparent;
            transition: all 0.2s ease;
        }
        .card-button.verify-btn {
            background-color: var(--green-bg);
            color: var(--green-600);
            border-color: var(--green-border);
        }
        html.dark .card-button.verify-btn { color: #6ee7b7; }
        .card-button.verify-btn:hover { background-color: var(--green-bg); opacity: 0.8; }
        .card-button.verify-btn:disabled {
            background-color: var(--gray-100);
            color: var(--text-tertiary);
            border-color: var(--border-color);
            cursor: not-allowed;
        }
        .card-button.report-item-btn {
            background-color: transparent;
            border-color: var(--border-color);
            color: var(--text-secondary);
        }
        .card-button.report-item-btn:hover {
            background-color: var(--gray-100);
            border-color: var(--text-tertiary);
            color: var(--text-primary);
        }
        .classification-badge {
            font-size: 0.7rem;
            font-weight: 500;
            padding: 0.2rem 0.5rem;
            border-radius: 9999px;
            white-space: nowrap;
        }
        .classification-hakken { background-color: var(--red-bg); color: var(--red-700); }
        .classification-company { background-color: #eff6ff; color: #1e40af; }
        .classification-individual { background-color: #fefce8; color: #a16207; }
        .classification-organization { background-color: #faf5ff; color: #6b21a8; }
        .classification-default { background-color: var(--gray-100); color: var(--text-primary); }
        html.dark .classification-company { background-color: rgba(37, 99, 235, 0.1); color: #93c5fd; }
        html.dark .classification-individual { background-color: rgba(234, 179, 8, 0.1); color: #fde047; }
        html.dark .classification-organization { background-color: rgba(126, 34, 206, 0.1); color: #d8b4fe; }
        
        /* --- Financial Scam Details (Updated) --- */
        .financial-scam-container {
            margin-top: 1rem;
            padding: 1rem;
            border-top: 1px dashed var(--red-500);
            background-color: var(--red-bg);
            border-radius: 0.75rem;
        }
        .financial-scam-container h4 {
            font-size: 0.875rem;
            font-weight: 700;
            color: var(--red-700);
            display: flex;
            align-items: center;
            gap: 0.5rem;
            margin-bottom: 0.75rem;
        }
        .financial-scam-grid {
            display: grid;
            grid-template-columns: 1fr;
            gap: 0.5rem;
        }
        @media (min-width: 640px) {
            .financial-scam-grid {
                grid-template-columns: 1fr 1fr;
                gap: 0.5rem 1rem;
            }
        }
        .scam-info-item {
            display: grid;
            grid-template-columns: 20px 1fr;
            gap: 0.75rem;
            font-size: 0.875rem;
            align-items: center;
            margin-bottom: 0.25rem;
        }
        .scam-info-icon {
            color: var(--text-secondary);
            text-align: center;
        }
        .scam-info-value {
            font-weight: 500;
            word-break: break-word;
        }
        .scam-info-value.amount {
            font-weight: 700;
            color: var(--red-600);
        }

        /* --- Modal Styles --- */
        .modal {
            display: none;
            position: fixed; inset: 0; z-index: 50;
            align-items: center; justify-content: center;
            padding: 1rem;
            background-color: rgba(15, 23, 42, 0.6);
            backdrop-filter: blur(4px);
        }
        .modal.active { display: flex; animation: fadeIn 0.3s ease; }
        .modal-content {
            background-color: var(--card-bg);
            border-radius: 1rem;
            box-shadow: var(--shadow-elevation-medium);
            width: 100%;
            max-height: 90vh;
            overflow-y: auto;
            animation: scaleUp 0.3s ease;
        }
        #add-report-modal .modal-content, #register-modal .modal-content, #user-profile-modal .modal-content { max-width: 36rem; }
        #report-item-modal .modal-content, #settings-modal .modal-content, #login-modal .modal-content, #forgot-password-modal .modal-content, #delete-confirm-modal .modal-content { max-width: 28rem; }

        .modal-form { padding: 1.5rem; }
        @media (min-width: 640px) { .modal-form { padding: 2rem; } }
        .modal-form > div:not(:last-child) { margin-bottom: 1.25rem; }
        
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding-bottom: 1rem;
            border-bottom: 1px solid var(--border-color);
            margin-bottom: 1.5rem;
        }
        .modal-header h2 { font-size: 1.25rem; font-weight: 600; }
        .modal-close-btn {
            color: var(--text-tertiary);
            font-size: 1.5rem;
            background: none; border: none; cursor: pointer;
            width: 32px; height: 32px;
            display: grid; place-items: center;
            border-radius: 99px;
            transition: background-color 0.2s ease, color 0.2s ease;
        }
        .modal-close-btn:hover { background-color: var(--gray-100); color: var(--text-primary); }
        
        .form-label {
            display: block;
            font-size: 0.875rem;
            font-weight: 500;
            color: var(--text-secondary);
            margin-bottom: 0.375rem;
        }
        .form-label .required { color: var(--red-500); }
        
        .form-submit-btn {
            width: 100%;
            background-color: var(--blue-600);
            color: white;
            font-weight: 600;
            padding: 0.75rem 1rem;
            border-radius: 0.5rem;
            border: none; cursor: pointer;
            transition: background-color 0.2s;
        }
        .form-submit-btn:hover { background-color: var(--blue-700); }
        .form-section-divider { padding-top: 1.25rem; border-top: 1px solid var(--border-color); margin-top: 1.25rem; }
        .hidden { display: none !important; }
        
        #financial-scam-details { border-top-style: dashed; }
        #financial-scam-details > div:not(:last-child) { margin-bottom: 1.25rem; }
        
        .toggle-label { display: flex; align-items: center; gap: 0.5rem; cursor: pointer; }
        .toggle-label input { width: 1em; height: 1em; }
        
        #report-item-form .form-submit-btn, #logout-button, #delete-confirm-btn { background-color: var(--red-600); }
        #report-item-form .form-submit-btn:hover, #logout-button:hover, #delete-confirm-btn:hover { background-color: var(--red-700); }

        /* Settings & User Profile Modal */
        .settings-group, .profile-group {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }
        .settings-label, .profile-label {
            font-weight: 600;
            color: var(--text-primary);
        }
        .theme-options {
            display: flex;
            border-radius: 0.5rem;
            border: 1px solid var(--border-color);
            overflow: hidden;
        }
        .theme-options label {
            flex: 1;
            padding: 0.75rem;
            text-align: center;
            cursor: pointer;
            transition: background-color 0.2s ease;
            background-color: var(--card-bg);
            border-right: 1px solid var(--border-color);
        }
        .theme-options label:last-child { border-right: none; }
        .theme-options label:hover { background-color: var(--gray-100); }
        .theme-options input { display: none; }
        .theme-options input:checked + span {
            color: var(--blue-600);
            font-weight: 600;
        }
        .user-info {
            padding: 1rem;
            background-color: var(--gray-50);
            border-radius: 0.5rem;
            border: 1px solid var(--border-color);
        }
        .profile-info-grid {
            display: grid;
            grid-template-columns: auto 1fr;
            gap: 0.5rem 1rem;
        }

        /* Auth Modals */
        .auth-link {
            font-size: 0.875rem;
            color: var(--blue-600);
            text-decoration: none;
            cursor: pointer;
        }
        .auth-link:hover { text-decoration: underline; }

        /* Admin Panel */
        #admin-panel {
            background-color: var(--red-bg);
            border: 1px solid var(--red-500);
            padding: 0;
            border-radius: 1rem;
            margin-bottom: 2rem;
            overflow: hidden;
        }
        .admin-panel-header {
            padding: 1rem;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .admin-panel-header h2 { color: var(--red-700); margin: 0; }
        .admin-panel-header .toggle-icon { transition: transform 0.3s ease; }
        #admin-panel.expanded .toggle-icon { transform: rotate(180deg); }

        #flagged-reports-list {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.5s ease-in-out, padding 0.5s ease-in-out;
            padding: 0 1rem;
        }
        #admin-panel.expanded #flagged-reports-list {
            max-height: 500px; /* Adjust as needed */
            padding: 0 1rem 1rem 1rem;
            overflow-y: auto;
        }
        .flagged-report-item {
            background-color: var(--card-bg);
            padding: 0.75rem;
            border-radius: 0.5rem;
            margin-bottom: 0.5rem;
            border: 1px solid var(--border-color);
        }
        .flagged-report-item p { margin: 0.25rem 0; }
        .reporter-link { cursor: pointer; color: var(--blue-600); text-decoration: underline; }

        /* --- Notification Toast --- */
        #notification {
            position: fixed;
            top: 1.25rem;
            right: 1.25rem;
            color: white;
            padding: 0.75rem 1.25rem;
            border-radius: 0.5rem;
            box-shadow: var(--shadow-elevation-medium);
            z-index: 100;
            animation: slideIn 0.4s ease forwards;
        }
        #notification.hidden { animation: fadeOut 0.3s ease forwards; }
        #notification.success { background-color: var(--green-500); }
        #notification.error { background-color: var(--red-600); }

        /* --- Footer Card --- */
        .footer-card {
            padding: 1.5rem;
            border-radius: 1rem;
            background-color: transparent;
            display: flex;
            align-items: center;
            justify-content: center;
            text-align: center;
            color: var(--text-tertiary);
            box-shadow: none;
        }
        .footer-card:hover { transform: none; box-shadow: none; }
        .footer-card p:first-child { font-weight: 500; }
        .footer-card p:last-child { font-size: 0.75rem; margin-top: 0.25rem; }

    </style>
</head>
<body>

    <!-- Main Container -->
    <div class="container">
        
        <header class="page-header">
            <h1>Cảnh Báo Lừa Đảo tại Nhật Bản</h1>
            <p>Cộng đồng chia sẻ và xác thực thông tin để phòng tránh rủi ro.</p>
        </header>

        <!-- Controls Section -->
        <div class="controls-section">
            <div class="controls-main-row">
                <div class="search-wrapper">
                    <input type="search" id="search-input" placeholder="Tìm kiếm theo tên, địa điểm, vấn đề..." class="form-input search-input">
                    <i class="fa-solid fa-magnifying-glass"></i>
                </div>
                <div class="controls-actions">
                    <select id="sort-select" class="form-select">
                        <option value="newest">Mới nhất</option>
                        <option value="oldest">Cũ nhất</option>
                        <option value="name-asc">Tên A-Z</option>
                        <option value="name-desc">Tên Z-A</option>
                    </select>
                    <button id="add-report-button" class="action-button">
                        <i class="fa-solid fa-flag"></i>
                    </button>
                    <button id="settings-button" class="settings-button" title="Cài đặt">
                        <i class="fa-solid fa-gear"></i>
                    </button>
                </div>
            </div>
            <div id="filter-container" class="filter-container">
                <button class="filter-btn active" data-filter="all">Tất cả</button>
                <button class="filter-btn" data-filter="hakken">Kền</button>
                <button class="filter-btn" data-filter="company">Công ty</button>
                <button class="filter-btn" data-filter="individual">Cá nhân</button>
                <button class="filter-btn" data-filter="organization">Tổ chức</button>
            </div>
        </div>

        <!-- Admin Panel -->
        <div id="admin-panel" class="hidden">
            <div class="admin-panel-header">
                <h2><i class="fa-solid fa-triangle-exclamation"></i> Báo cáo sai phạm từ người dùng</h2>
                <i class="fa-solid fa-chevron-down toggle-icon"></i>
            </div>
            <div id="flagged-reports-list"></div>
        </div>

        <!-- Company List Container for Masonry -->
        <div id="company-list">
             <div class="grid-sizer"></div>
            <!-- Cards will be inserted here by JS and arranged by Masonry -->
        </div>
    </div>

    <!-- Add/Edit Report Modal -->
    <div id="add-report-modal" class="modal">
        <div class="modal-content">
            <form id="add-report-form" class="modal-form">
                <input type="hidden" id="report-id-input">
                <div class="modal-header">
                    <h2 id="report-modal-title">Báo Cáo Đối Tượng Mới</h2>
                    <button type="button" class="modal-close-btn">&times;</button>
                </div>
                <!-- Main form fields -->
                <div><label for="report-name" class="form-label">Tên công ty / cá nhân <span class="required">*</span></label><input type="text" id="report-name" class="form-input" required></div>
                <div><label for="report-location" class="form-label">Địa điểm <span class="required">*</span></label><input type="text" id="report-location" class="form-input" required></div>
                <div><label for="report-issues" class="form-label">Vấn đề gặp phải (Phốt) <span class="required">*</span></label><textarea id="report-issues" rows="4" class="form-textarea" required></textarea></div>
                <div><label for="report-reporter-display" class="form-label">Người báo cáo</label><input type="text" id="report-reporter-display" class="form-input" disabled></div>
                <div><label for="report-source" class="form-label">Nguồn thông tin</label><input type="text" id="report-source" placeholder="Vd: Facebook, bạn bè, trải nghiệm cá nhân" class="form-input"></div>
                <div><label for="report-classification" class="form-label">Phân loại <span class="required">*</span></label><select id="report-classification" class="form-select" required><option value="">-- Chọn phân loại --</option><option value="hakken">Kền (Công ty phái cử)</option><option value="company">Công ty (Trực tiếp)</option><option value="individual">Cá nhân</option><option value="organization">Tổ chức</option><option value="other">Khác</option></select></div>
                <div id="other-classification-input" class="hidden"><label for="report-other-classification" class="form-label">Ghi rõ phân loại khác <span class="required">*</span></label><input type="text" id="report-other-classification" class="form-input"></div>
                
                <!-- Financial Scam Toggle -->
                <div class="form-section-divider"><label class="toggle-label"><input type="checkbox" id="toggle-financial-scam"><span class="form-label" style="margin-bottom: 0;">Thêm thông tin lừa đảo tài chính</span></label></div>
                
                <!-- Financial Scam Details Section (hidden by default) -->
                <div id="financial-scam-details" class="hidden">
                    <h3 style="font-size: 1rem; font-weight: 600; color: var(--red-700);">Chi tiết Lừa đảo Tài chính</h3>
                    <div style="display: flex; gap: 0.5rem;">
                        <div style="flex-grow: 1;"><label for="scam-amount" class="form-label">Số tiền bị lừa</label><input type="number" id="scam-amount" class="form-input"></div>
                        <div><label for="scam-currency" class="form-label">Loại tiền</label><select id="scam-currency" class="form-select"><option>JPY</option><option>VND</option><option>USD</option></select></div>
                    </div>
                    <div>
                        <label for="scam-category" class="form-label">Hạng mục lừa đảo</label>
                        <select id="scam-category" class="form-select">
                            <option value="">-- Chọn hạng mục --</option>
                            <option value="lừa đảo chung">Lừa đảo chung</option>
                            <option value="lừa cọc">Lừa cọc</option>
                            <option value="other">Khác (nhập bên dưới)</option>
                        </select>
                    </div>
                    <div id="scam-category-other-input" class="hidden"><label for="scam-category-other" class="form-label">Ghi rõ hạng mục khác</label><input type="text" id="scam-category-other" class="form-input"></div>
                    <p style="padding-top: 0.5rem; font-size: 0.875rem; font-weight: 500; color: var(--text-secondary);">Thông tin ngân hàng nhận tiền:</p>
                    <div><label for="bank-name" class="form-label">Tên ngân hàng</label><input type="text" id="bank-name" class="form-input"></div>
                    <div><label for="account-name" class="form-label">Tên chủ tài khoản</label><input type="text" id="account-name" class="form-input"></div>
                    <div><label for="account-number" class="form-label">Số tài khoản</label><input type="text" id="account-number" class="form-input"></div>
                </div>

                <div class="form-section-divider"><button type="submit" id="report-submit-btn" class="form-submit-btn">Gửi Báo Cáo</button></div>
            </form>
        </div>
    </div>
    
    <!-- Report Item Modal -->
    <div id="report-item-modal" class="modal">
        <div class="modal-content">
            <form id="report-item-form" class="modal-form">
                <div class="modal-header"><h2>Báo cáo nội dung</h2><button type="button" class="modal-close-btn">&times;</button></div>
                <p style="font-size: 0.875rem;">Bạn đang báo cáo: <strong id="item-to-report-name" style="color: var(--blue-600);"></strong></p>
                <input type="hidden" id="item-to-report-id">
                <div>
                    <label class="form-label">Lý do báo cáo <span class="required">*</span></label>
                    <select id="report-item-reason" class="form-select" required><option value="">-- Chọn lý do --</option><option value="untrue">Sai sự thật</option><option value="fake_news">Tin giả, bịa đặt</option><option value="insulting">Nội dung xúc phạm, bôi nhọ</option><option value="outdated">Thông tin đã cũ, không còn đúng</option><option value="other">Lý do khác</option></select>
                </div>
                <div><label for="report-item-details" class="form-label">Chi tiết (nếu có)</label><textarea id="report-item-details" rows="3" class="form-textarea"></textarea></div>
                <div class="form-section-divider"><button type="submit" class="form-submit-btn">Gửi Báo Cáo</button></div>
            </form>
        </div>
    </div>

    <!-- Settings Modal -->
    <div id="settings-modal" class="modal">
        <div class="modal-content">
            <div class="modal-form">
                <div class="modal-header">
                    <h2>Cài đặt</h2>
                    <button type="button" class="modal-close-btn">&times;</button>
                </div>
                <div id="user-info-container" class="hidden">
                    <div class="user-info">
                        <p>Đã đăng nhập với tên <strong id="user-info-name"></strong></p>
                        <p id="user-info-email" style="font-size: 0.8rem;"></p>
                    </div>
                    <div class="form-section-divider">
                        <button id="logout-button" class="form-submit-btn">Đăng xuất</button>
                    </div>
                </div>
                <div class="settings-group">
                    <span class="settings-label">Giao diện</span>
                    <div class="theme-options">
                        <label>
                            <input type="radio" name="theme" value="light">
                            <span>Sáng</span>
                        </label>
                        <label>
                            <input type="radio" name="theme" value="dark">
                            <span>Tối</span>
                        </label>
                        <label>
                            <input type="radio" name="theme" value="system" checked>
                            <span>Hệ thống</span>
                        </label>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Login Modal -->
    <div id="login-modal" class="modal">
        <div class="modal-content">
            <form id="login-form" class="modal-form">
                <div class="modal-header">
                    <h2>Đăng nhập</h2>
                    <button type="button" class="modal-close-btn">&times;</button>
                </div>
                <div><label for="login-email" class="form-label">Email</label><input type="email" id="login-email" class="form-input" required></div>
                <div><label for="login-password" class="form-label">Mật khẩu</label><input type="password" id="login-password" class="form-input" required></div>
                <div style="display: flex; justify-content: space-between; align-items: center;">
                    <a href="#" class="auth-link" id="forgot-password-link">Quên mật khẩu?</a>
                    <a href="#" class="auth-link" id="go-to-register-link">Chưa có tài khoản? Đăng ký</a>
                </div>
                <div class="form-section-divider"><button type="submit" class="form-submit-btn">Đăng nhập</button></div>
            </form>
        </div>
    </div>

    <!-- Register Modal -->
    <div id="register-modal" class="modal">
        <div class="modal-content">
            <form id="register-form" class="modal-form">
                <div class="modal-header">
                    <h2>Đăng ký tài khoản</h2>
                    <button type="button" class="modal-close-btn">&times;</button>
                </div>
                <div><label for="register-fullname" class="form-label">Họ và tên <span class="required">*</span></label><input type="text" id="register-fullname" class="form-input" required></div>
                <div><label for="register-email" class="form-label">Email <span class="required">*</span></label><input type="email" id="register-email" class="form-input" required></div>
                <div><label for="register-password" class="form-label">Mật khẩu <span class="required">*</span></label><input type="password" id="register-password" class="form-input" required></div>
                <div><label for="register-phone" class="form-label">Số điện thoại <span class="required">*</span></label><input type="tel" id="register-phone" class="form-input" required></div>
                <div>
                    <label for="register-social-select" class="form-label">Tài khoản mạng xã hội <span class="required">*</span></label>
                    <div style="display:flex; gap: 0.5rem;">
                        <select id="register-social-select" class="form-select" style="flex-shrink: 0; width: auto;">
                            <option>Facebook</option><option>Zalo</option><option>Line</option><option>Khác</option>
                        </select>
                        <input type="text" id="register-social-input" class="form-input" placeholder="Link hoặc ID tài khoản..." required>
                    </div>
                </div>
                <div style="text-align: right;"><a href="#" class="auth-link" id="go-to-login-link">Đã có tài khoản? Đăng nhập</a></div>
                <div class="form-section-divider"><button type="submit" class="form-submit-btn">Đăng ký</button></div>
            </form>
        </div>
    </div>

    <!-- Forgot Password Modal -->
    <div id="forgot-password-modal" class="modal">
        <div class="modal-content">
            <form id="forgot-password-form" class="modal-form">
                <div class="modal-header">
                    <h2>Quên mật khẩu</h2>
                    <button type="button" class="modal-close-btn">&times;</button>
                </div>
                <p class="form-label" style="margin-bottom: 1rem;">Nhập email của bạn để nhận link đặt lại mật khẩu.</p>
                <div><label for="forgot-email" class="form-label">Email</label><input type="email" id="forgot-email" class="form-input" required></div>
                <div class="form-section-divider"><button type="submit" class="form-submit-btn">Gửi link</button></div>
            </form>
        </div>
    </div>

    <!-- Delete Confirmation Modal -->
    <div id="delete-confirm-modal" class="modal">
        <div class="modal-content">
            <div class="modal-form">
                <div class="modal-header">
                    <h2>Xác nhận xóa</h2>
                    <button type="button" class="modal-close-btn">&times;</button>
                </div>
                <p>Bạn có chắc chắn muốn xóa báo cáo này không? Hành động này sẽ chuyển báo cáo vào thùng rác.</p>
                <div class="form-section-divider" style="display: flex; gap: 1rem;">
                    <button type="button" id="delete-cancel-btn" class="form-submit-btn" style="background-color: var(--text-tertiary);">Hủy</button>
                    <button type="button" id="delete-confirm-btn" class="form-submit-btn">Xóa</button>
                </div>
            </div>
        </div>
    </div>

    <!-- User Profile Modal -->
    <div id="user-profile-modal" class="modal">
        <div class="modal-content">
            <div id="user-profile-content" class="modal-form">
                <!-- Content will be injected by JS -->
            </div>
        </div>
    </div>

    <!-- Notification Toast -->
    <div id="notification" class="hidden"><p id="notification-message"></p></div>

    <script type="module">
        // --- Firebase SDK ---
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { 
            getAuth, 
            onAuthStateChanged, 
            createUserWithEmailAndPassword, 
            signInWithEmailAndPassword, 
            signOut,
            sendPasswordResetEmail,
            updateProfile
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { 
            getFirestore, 
            collection, 
            onSnapshot,
            query,
            where,
            addDoc,
            doc,
            getDoc,
            setDoc,
            updateDoc,
            arrayUnion,
            serverTimestamp,
            increment
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- Firebase Config ---
        const firebaseConfig = {
            apiKey: "AIzaSyCeY5-00_um64cX4JELeEQ4pCVpcmdtHnA",
            authDomain: "scamreport-abc.firebaseapp.com",
            projectId: "scamreport-abc",
            storageBucket: "scamreport-abc.appspot.com",
            messagingSenderId: "1023539306816",
            appId: "1:1023539306816:web:114fd7c4e677d10d645aa5",
            measurementId: "G-0H95S0QFJR"
        };

        // --- Initialize Firebase ---
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const ADMIN_EMAIL = "admin@example.com"; // Replace with your actual admin email

        // --- STATE VARIABLES ---
        let currentFilter = 'all';
        let currentSort = 'newest';
        let msnry = null; 
        let currentUserData = null; // Will hold both auth and firestore data
        let unsubscribeReports = null;
        let unsubscribeFlags = null;
        let allReports = [];

        // --- DOM ELEMENTS ---
        const searchInput = document.getElementById('search-input');
        const companyListDiv = document.getElementById('company-list');
        const sortSelect = document.getElementById('sort-select');
        const filterContainer = document.getElementById('filter-container');
        const notification = document.getElementById('notification');
        const notificationMessage = document.getElementById('notification-message');
        
        // Modals
        const addReportModal = document.getElementById('add-report-modal');
        const reportItemModal = document.getElementById('report-item-modal');
        const settingsModal = document.getElementById('settings-modal');
        const loginModal = document.getElementById('login-modal');
        const registerModal = document.getElementById('register-modal');
        const forgotPasswordModal = document.getElementById('forgot-password-modal');
        const deleteConfirmModal = document.getElementById('delete-confirm-modal');
        const userProfileModal = document.getElementById('user-profile-modal');
        
        // Forms
        const addReportForm = document.getElementById('add-report-form');
        const reportItemForm = document.getElementById('report-item-form');
        const loginForm = document.getElementById('login-form');
        const registerForm = document.getElementById('register-form');
        const forgotPasswordForm = document.getElementById('forgot-password-form');
        
        // Buttons & Links
        const addReportButton = document.getElementById('add-report-button');
        const settingsButton = document.getElementById('settings-button');
        const logoutButton = document.getElementById('logout-button');
        const goToRegisterLink = document.getElementById('go-to-register-link');
        const goToLoginLink = document.getElementById('go-to-login-link');
        const forgotPasswordLink = document.getElementById('forgot-password-link');
        const deleteConfirmBtn = document.getElementById('delete-confirm-btn');
        const deleteCancelBtn = document.getElementById('delete-cancel-btn');
        
        // Settings & User Info
        const userInfoContainer = document.getElementById('user-info-container');
        const userInfoName = document.getElementById('user-info-name');
        const userInfoEmail = document.getElementById('user-info-email');
        const themeRadios = document.querySelectorAll('input[name="theme"]');
        const htmlEl = document.documentElement;

        // Admin Panel
        const adminPanel = document.getElementById('admin-panel');
        const adminPanelHeader = document.querySelector('.admin-panel-header');
        const flaggedReportsList = document.getElementById('flagged-reports-list');

        // --- FUNCTIONS ---

        function showNotification(message, type = 'success') {
            notificationMessage.textContent = message;
            notification.classList.remove('hidden', 'success', 'error');
            notification.classList.add(type);
            setTimeout(() => {
                notification.classList.add('hidden');
            }, 3000);
        }
        
        function getVietnameseClassification(classification) {
            const map = { hakken: 'Kền (Phái cử)', company: 'Công ty (Trực tiếp)', individual: 'Cá nhân', organization: 'Tổ chức' };
            return map[classification] || classification;
        }
        
        function formatDate(date) {
            if (!date) return 'Không rõ';
            // Convert Firestore Timestamp to JS Date
            const jsDate = date.toDate();
            const options = { year: 'numeric', month: '2-digit', day: '2-digit' };
            return jsDate.toLocaleDateString('vi-VN', options);
        }

        function processAndRender(reports) {
            allReports = reports; // Store all reports for filtering
            let reportsToRender = [...reports];
            const searchTerm = searchInput.value.toLowerCase().trim();

            if (searchTerm) {
                reportsToRender = reportsToRender.filter(c => 
                    c.name.toLowerCase().includes(searchTerm) || 
                    c.location.toLowerCase().includes(searchTerm) || 
                    c.issues.toLowerCase().includes(searchTerm)
                );
            }

            if (currentFilter !== 'all') {
                reportsToRender = reportsToRender.filter(c => c.classification === currentFilter);
            }

            reportsToRender.sort((a, b) => {
                const dateA = a.reportDate?.toDate() || 0;
                const dateB = b.reportDate?.toDate() || 0;
                switch (currentSort) {
                    case 'oldest': return dateA - dateB;
                    case 'name-asc': return a.name.localeCompare(b.name);
                    case 'name-desc': return b.name.localeCompare(a.name);
                    case 'newest':
                    default: return dateB - dateA;
                }
            });

            renderCompanies(reportsToRender);
        }

        function renderCompanies(reportsToRender) {
            companyListDiv.innerHTML = '<div class="grid-sizer"></div>';
            
            const fragment = document.createDocumentFragment();
            reportsToRender.forEach(report => {
                const card = document.createElement('div');
                card.className = 'company-card';
                card.dataset.id = report.id;

                const verifications = report.verifiedBy?.length || 0;
                const isHighlyVerified = verifications >= 10;
                
                if (isHighlyVerified) card.classList.add('highly-verified');
                
                const classificationText = getVietnameseClassification(report.classification);
                const classificationClass = `classification-${report.classification}` || 'classification-default';
                
                const highlyVerifiedBanner = isHighlyVerified ? `
                    <div class="highly-verified-banner">
                        <i class="fa-solid fa-shield-halved"></i>
                        <span>Cảnh Báo Cao</span>
                    </div>` : '';

                let financialScamHTML = '';
                if (report.financialScam) {
                    const { amount, currency, category, bankDetails } = report.financialScam;
                    const formattedAmount = amount ? new Intl.NumberFormat('ja-JP').format(amount) + ` ${currency}` : 'Không rõ';
                    
                    financialScamHTML = `
                        <div class="financial-scam-container">
                            <h4><i class="fa-solid fa-sack-xmark"></i>Chi tiết lừa đảo</h4>
                            <div class="financial-scam-grid">
                                <div class="scam-info-column">
                                    <div class="scam-info-item">
                                        <i class="fa-solid fa-tags scam-info-icon" title="Hạng mục"></i>
                                        <span class="scam-info-value">${category || 'Không rõ'}</span>
                                    </div>
                                    <div class="scam-info-item">
                                        <i class="fa-solid fa-coins scam-info-icon" title="Số tiền"></i>
                                        <span class="scam-info-value amount">${formattedAmount}</span>
                                    </div>
                                </div>
                                <div class="scam-info-column">
                                    ${(bankDetails?.bankName) ? `<div class="scam-info-item"><i class="fa-solid fa-building-columns scam-info-icon" title="Ngân hàng"></i><span class="scam-info-value">${bankDetails.bankName}</span></div>` : ''}
                                    ${(bankDetails?.accountName) ? `<div class="scam-info-item"><i class="fa-solid fa-user scam-info-icon" title="Chủ tài khoản"></i><span class="scam-info-value">${bankDetails.accountName}</span></div>` : ''}
                                    ${(bankDetails?.accountNumber) ? `<div class="scam-info-item"><i class="fa-solid fa-hashtag scam-info-icon" title="Số tài khoản"></i><span class="scam-info-value">${bankDetails.accountNumber}</span></div>` : ''}
                                </div>
                            </div>
                        </div>`;
                }

                const isVerifiedByCurrentUser = currentUserData && report.verifiedBy?.includes(currentUserData.uid);
                const isAdmin = currentUserData && currentUserData.isAdmin;
                const isOwner = currentUserData && report.reporterId === currentUserData.uid;
                
                let ownerActionsHTML = '';
                if (isAdmin || isOwner) {
                    ownerActionsHTML = `
                        <div class="card-header-actions">
                            <button class="card-button-icon edit-btn" title="Chỉnh sửa"><i class="fa-solid fa-pen-to-square"></i></button>
                            <button class="card-button-icon delete-btn" title="Xóa"><i class="fa-solid fa-trash-can"></i></button>
                        </div>
                    `;
                }

                let editedByAdminText = report.editedByAdmin ? ' <span style="font-style: italic; color: var(--text-tertiary); font-size: 0.9em;">[Đã sửa bởi Admin]</span>' : '';

                card.innerHTML = `
                    ${highlyVerifiedBanner}
                    <div class="card-content ${isHighlyVerified ? 'has-banner' : ''}">
                        <div class="card-header">
                            <h3>${report.name}</h3>
                            ${ownerActionsHTML}
                        </div>
                        <p class="card-location"><i class="fa-solid fa-location-dot"></i><span>${report.location}</span></p>
                        <p class="card-issues"><strong>Vấn đề:</strong> ${report.issues}</p>
                    </div>
                    <div class="card-footer">
                        <p><strong>Nguồn:</strong> ${report.source || 'Không rõ'}</p>
                        <p><strong>Báo cáo bởi:</strong> <a href="#" class="reporter-link" data-reporter-id="${report.reporterId}">${report.reporterName || 'Ẩn danh'}</a>${editedByAdminText} - <strong>Ngày:</strong> ${formatDate(report.reportDate)}</p>
                    </div>
                    ${financialScamHTML}
                    <div class="card-actions">
                        <button class="card-button verify-btn" data-id="${report.id}" ${isVerifiedByCurrentUser ? 'disabled' : ''}>
                            <i class="fa-solid fa-check"></i> Xác nhận (${verifications})
                        </button>
                        <button class="card-button report-item-btn" data-id="${report.id}" data-name="${report.name}">
                            <i class="fa-solid fa-triangle-exclamation"></i> Báo cáo
                        </button>
                    </div>`;
                fragment.appendChild(card);
            });

            const footerCard = document.createElement('div');
            footerCard.className = 'company-card footer-card';
            footerCard.innerHTML = `<div><p>Design & Dev by H</p><p>Scam Alert Platform</p></div>`;
            fragment.appendChild(footerCard);

            companyListDiv.appendChild(fragment);

            imagesLoaded( companyListDiv, function() {
                if (msnry) {
                    msnry.reloadItems();
                    msnry.layout();
                } else {
                    msnry = new Masonry(companyListDiv, {
                        itemSelector: '.company-card',
                        columnWidth: '.grid-sizer',
                        percentPosition: true,
                        gutter: 16,
                        transitionDuration: 0
                    });
                }
            });
        }

        // --- MODAL HANDLING ---
        function openModal(modal) { modal.classList.add('active'); }
        function closeModal(modal) { modal.classList.remove('active'); }

        // --- THEME HANDLING ---
        function applyTheme() {
            const savedTheme = localStorage.getItem('theme') || 'system';
            const systemPrefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;

            if (savedTheme === 'dark' || (savedTheme === 'system' && systemPrefersDark)) {
                htmlEl.classList.add('dark');
            } else {
                htmlEl.classList.remove('dark');
            }
        }

        function saveThemeChoice(theme) {
            localStorage.setItem('theme', theme);
            applyTheme();
        }

        // --- UI Update on Auth State Change ---
        async function updateUIForAuthState(user) {
            if (user) {
                const userDoc = await getDoc(doc(db, "users", user.uid));
                currentUserData = { 
                    uid: user.uid, 
                    email: user.email, 
                    displayName: user.displayName, 
                    isAdmin: user.email === ADMIN_EMAIL,
                    ...(userDoc.exists() ? userDoc.data() : {})
                };
                userInfoContainer.classList.remove('hidden');
                userInfoName.textContent = user.displayName || 'Người dùng mới';
                userInfoEmail.textContent = user.email;
                if (currentUserData.isAdmin) {
                    adminPanel.classList.remove('hidden');
                    listenToFlaggedReports();
                }
            } else {
                currentUserData = null;
                userInfoContainer.classList.add('hidden');
                adminPanel.classList.add('hidden');
                if (unsubscribeFlags) unsubscribeFlags();
            }
        }

        // --- Firestore Listeners ---
        function listenToReports() {
            const reportsRef = collection(db, "reports");
            const q = query(reportsRef, where("status", "==", "published"));
            
            if (unsubscribeReports) unsubscribeReports(); 
            
            unsubscribeReports = onSnapshot(q, (snapshot) => {
                const reports = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                processAndRender(reports);
            }, (error) => {
                console.error("Error fetching reports: ", error);
                showNotification("Không thể tải dữ liệu. Vui lòng thử lại.", "error");
            });
        }

        function listenToFlaggedReports() {
            const flagsRef = collection(db, "flags");
            if (unsubscribeFlags) unsubscribeFlags();

            unsubscribeFlags = onSnapshot(flagsRef, (snapshot) => {
                flaggedReportsList.innerHTML = '';
                if (snapshot.empty) {
                    flaggedReportsList.innerHTML = '<p>Chưa có báo cáo sai phạm nào.</p>';
                    return;
                }
                snapshot.docs.forEach(doc => {
                    const flag = doc.data();
                    const item = document.createElement('div');
                    item.className = 'flagged-report-item';
                    item.innerHTML = `
                        <p><strong>Đối tượng:</strong> ${flag.reportName}</p>
                        <p><strong>Lý do:</strong> ${flag.reason}</p>
                        <p><strong>Chi tiết:</strong> ${flag.details || 'Không có'}</p>
                        <p><strong>Người báo cáo:</strong> <a href="#" class="reporter-link" data-reporter-id="${flag.flaggerId}">${flag.flaggerName}</a></p>
                    `;
                    flaggedReportsList.appendChild(item);
                });
            });
        }
        
        // --- Open Modals ---
        function openEditModal(reportId, data) {
            addReportForm.reset();
            document.getElementById('report-id-input').value = reportId;
            document.getElementById('report-modal-title').textContent = "Chỉnh sửa báo cáo";
            document.getElementById('report-submit-btn').textContent = "Cập nhật";

            document.getElementById('report-name').value = data.name || '';
            document.getElementById('report-location').value = data.location || '';
            document.getElementById('report-issues').value = data.issues || '';
            document.getElementById('report-reporter-display').value = data.reporterName || '';
            document.getElementById('report-source').value = data.source || '';
            document.getElementById('report-classification').value = data.classification || '';

            const financialDetailsDiv = document.getElementById('financial-scam-details');
            const toggle = document.getElementById('toggle-financial-scam');
            if (data.financialScam) {
                toggle.checked = true;
                financialDetailsDiv.classList.remove('hidden');
                
                document.getElementById('scam-amount').value = data.financialScam.amount || '';
                document.getElementById('scam-currency').value = data.financialScam.currency || 'JPY';
                document.getElementById('scam-category').value = data.financialScam.category || '';
                document.getElementById('bank-name').value = data.financialScam.bankDetails?.bankName || '';
                document.getElementById('account-name').value = data.financialScam.bankDetails?.accountName || '';
                document.getElementById('account-number').value = data.financialScam.bankDetails?.accountNumber || '';
            } else {
                 toggle.checked = false;
                 financialDetailsDiv.classList.add('hidden');
            }

            openModal(addReportModal);
        }

        async function openUserProfileModal(userId) {
            const userDocRef = doc(db, "users", userId);
            const userDoc = await getDoc(userDocRef);

            if (!userDoc.exists()) {
                showNotification("Không tìm thấy thông tin người dùng.", "error");
                return;
            }

            const userData = userDoc.data();
            const strikes = userData.strikes || 0;
            const contentDiv = document.getElementById('user-profile-content');
            
            contentDiv.innerHTML = `
                <div class="modal-header">
                    <h2>Hồ sơ người dùng</h2>
                    <button type="button" class="modal-close-btn">&times;</button>
                </div>
                <div class="profile-group">
                    <div class="profile-info-grid">
                        <span class="profile-label">Họ tên:</span> <span>${userData.fullName}</span>
                        <span class="profile-label">Email:</span> <span>${userData.email}</span>
                        <span class="profile-label">SĐT:</span> <span>${userData.phone}</span>
                        <span class="profile-label">MXH:</span> <span>${userData.social.platform}: ${userData.social.id}</span>
                        <span class="profile-label">Vi phạm:</span> <span>${strikes} lần</span>
                    </div>
                </div>
                <div class="form-section-divider" style="display: flex; gap: 1rem;">
                    <button id="remove-strike-btn" data-user-id="${userId}" class="form-submit-btn" style="background-color: var(--text-tertiary);" ${strikes === 0 ? 'disabled' : ''}>Gỡ gậy</button>
                    <button id="add-strike-btn" data-user-id="${userId}" class="form-submit-btn">Đánh dấu vi phạm (Gậy)</button>
                </div>
            `;
            
            contentDiv.querySelector('.modal-close-btn').addEventListener('click', () => closeModal(userProfileModal));
            contentDiv.querySelector('#add-strike-btn').addEventListener('click', handleStrikeUser);
            contentDiv.querySelector('#remove-strike-btn').addEventListener('click', handleRemoveStrikeUser);
            openModal(userProfileModal);
        }

        async function handleStrikeUser(e) {
            const userId = e.target.dataset.userId;
            if (!userId) return;

            const userRef = doc(db, "users", userId);
            try {
                await updateDoc(userRef, {
                    strikes: increment(1)
                });
                showNotification("Đã đánh dấu vi phạm cho người dùng.", "success");
                closeModal(userProfileModal);
            } catch (error) {
                showNotification("Lỗi khi đánh dấu vi phạm.", "error");
                console.error("Error striking user:", error);
            }
        }

        async function handleRemoveStrikeUser(e) {
            const userId = e.target.dataset.userId;
            if (!userId) return;

            const userRef = doc(db, "users", userId);
            try {
                await updateDoc(userRef, {
                    strikes: increment(-1)
                });
                showNotification("Đã gỡ 1 gậy cho người dùng.", "success");
                closeModal(userProfileModal);
            } catch (error) {
                showNotification("Lỗi khi gỡ gậy.", "error");
                console.error("Error removing strike:", error);
            }
        }

        // --- EVENT LISTENERS ---
        document.addEventListener('DOMContentLoaded', () => {
            const currentTheme = localStorage.getItem('theme') || 'system';
            document.querySelector(`input[name="theme"][value="${currentTheme}"]`).checked = true;
            applyTheme();
            
            listenToReports();

            onAuthStateChanged(auth, (user) => {
                updateUIForAuthState(user);
                listenToReports();
            });

            // General Controls
            searchInput.addEventListener('input', () => processAndRender(allReports));
            sortSelect.addEventListener('change', (e) => {
                currentSort = e.target.value;
                processAndRender(allReports);
            });
            filterContainer.addEventListener('click', (e) => {
                if (e.target.classList.contains('filter-btn')) {
                    filterContainer.querySelector('.active').classList.remove('active');
                    e.target.classList.add('active');
                    currentFilter = e.target.dataset.filter;
                    processAndRender(allReports);
                }
            });

            // Card Actions
            companyListDiv.addEventListener('click', async (e) => {
                const verifyBtn = e.target.closest('.verify-btn');
                const reportBtn = e.target.closest('.report-item-btn');
                const editBtn = e.target.closest('.edit-btn');
                const deleteBtn = e.target.closest('.delete-btn');
                const reporterLink = e.target.closest('.reporter-link');

                if (verifyBtn) {
                    if (!currentUserData) { showNotification("Bạn cần đăng nhập để xác nhận.", "error"); openModal(loginModal); return; }
                    const reportId = verifyBtn.closest('.company-card').dataset.id;
                    try {
                        await updateDoc(doc(db, "reports", reportId), { verifiedBy: arrayUnion(currentUserData.uid) });
                        showNotification("Đã xác nhận thành công!", "success");
                    } catch (error) { showNotification("Có lỗi xảy ra khi xác nhận.", "error"); }
                }

                if (reportBtn) {
                    if (!currentUserData) { showNotification("Bạn cần đăng nhập để báo cáo nội dung.", "error"); openModal(loginModal); return; }
                    document.getElementById('item-to-report-id').value = reportBtn.closest('.company-card').dataset.id;
                    document.getElementById('item-to-report-name').textContent = reportBtn.dataset.name;
                    openModal(reportItemModal);
                }

                if (editBtn) {
                    const reportId = editBtn.closest('.company-card').dataset.id;
                    const reportDoc = await getDoc(doc(db, "reports", reportId));
                    if (reportDoc.exists()) {
                        openEditModal(reportId, reportDoc.data());
                    }
                }

                if (deleteBtn) {
                    const reportId = deleteBtn.closest('.company-card').dataset.id;
                    deleteConfirmBtn.dataset.reportId = reportId;
                    openModal(deleteConfirmModal);
                }

                if (reporterLink) {
                    e.preventDefault();
                    if (!currentUserData?.isAdmin) {
                        showNotification("Chỉ quản trị viên mới có thể xem hồ sơ người dùng.", "error");
                        return;
                    }
                    const reporterId = reporterLink.dataset.reporterId;
                    openUserProfileModal(reporterId);
                }
            });
        
            // Modals
            document.querySelectorAll('.modal-close-btn').forEach(btn => {
                btn.addEventListener('click', () => closeModal(btn.closest('.modal')));
            });
            document.querySelectorAll('.modal').forEach(modal => {
                modal.addEventListener('click', (e) => { if(e.target === modal) closeModal(modal) });
            });

            // Add/Edit Report
            addReportButton.addEventListener('click', () => {
                if (currentUserData) {
                    if (currentUserData.strikes && currentUserData.strikes >= 3) {
                        showNotification("Tài khoản của bạn đã bị hạn chế đăng bài do vi phạm.", "error");
                        return;
                    }
                    addReportForm.reset();
                    document.getElementById('report-id-input').value = '';
                    document.getElementById('report-modal-title').textContent = "Báo Cáo Đối Tượng Mới";
                    document.getElementById('report-submit-btn').textContent = "Gửi Báo Cáo";
                    document.getElementById('report-reporter-display').value = currentUserData.displayName || currentUserData.email;
                    document.getElementById('financial-scam-details').classList.add('hidden');
                    document.getElementById('toggle-financial-scam').checked = false;
                    openModal(addReportModal);
                } else {
                    showNotification("Vui lòng đăng nhập để tạo báo cáo.", "error");
                    openModal(loginModal);
                }
            });

            addReportForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                if (!currentUserData) return;

                const reportId = document.getElementById('report-id-input').value;
                const isEditMode = !!reportId;

                let classification = document.getElementById('report-classification').value;
                if (classification === 'other') {
                    classification = document.getElementById('report-other-classification').value.trim();
                }

                const reportData = {
                    name: document.getElementById('report-name').value.trim(),
                    location: document.getElementById('report-location').value.trim(),
                    issues: document.getElementById('report-issues').value.trim(),
                    classification: classification,
                    source: document.getElementById('report-source').value.trim() || 'Không rõ',
                };

                if (document.getElementById('toggle-financial-scam').checked) {
                    const amount = parseInt(document.getElementById('scam-amount').value, 10);
                    let category = document.getElementById('scam-category').value;
                    if (category === 'other') category = document.getElementById('scam-category-other').value.trim();
                    
                    reportData.financialScam = {
                        amount: isNaN(amount) ? null : amount,
                        currency: document.getElementById('scam-currency').value,
                        category: category,
                        bankDetails: {
                            bankName: document.getElementById('bank-name').value.trim(),
                            accountName: document.getElementById('account-name').value.trim(),
                            accountNumber: document.getElementById('account-number').value.trim()
                        }
                    };
                } else {
                    reportData.financialScam = null;
                }

                try {
                    if (isEditMode) {
                        const originalReportDoc = await getDoc(doc(db, "reports", reportId));
                        if(currentUserData.isAdmin && currentUserData.uid !== originalReportDoc.data().reporterId) {
                            reportData.editedByAdmin = true;
                        }
                        await updateDoc(doc(db, "reports", reportId), reportData);
                        showNotification('Cập nhật báo cáo thành công!', 'success');
                    } else {
                        reportData.reporterId = currentUserData.uid;
                        reportData.reporterName = currentUserData.displayName;
                        reportData.reportDate = serverTimestamp();
                        reportData.verifiedBy = [];
                        reportData.flaggedBy = [];
                        reportData.status = 'published';
                        await addDoc(collection(db, "reports"), reportData);
                        showNotification('Báo cáo mới đã được thêm thành công!', 'success');
                    }
                    closeModal(addReportModal);
                    addReportForm.reset();
                } catch (error) {
                    console.error("Error saving report: ", error);
                    showNotification("Có lỗi xảy ra khi lưu báo cáo.", "error");
                }
            });
            
            document.getElementById('toggle-financial-scam').addEventListener('change', (e) => {
                document.getElementById('financial-scam-details').classList.toggle('hidden', !e.target.checked);
            });
            
            // Delete Confirmation
            deleteCancelBtn.addEventListener('click', () => closeModal(deleteConfirmModal));
            deleteConfirmBtn.addEventListener('click', async (e) => {
                const reportId = e.target.dataset.reportId;
                if (!reportId) return;
                try {
                    await updateDoc(doc(db, "reports", reportId), { status: 'trashed' });
                    showNotification("Đã chuyển báo cáo vào thùng rác.", "success");
                    closeModal(deleteConfirmModal);
                } catch (error) {
                    showNotification("Lỗi khi xóa báo cáo.", "error");
                    console.error("Error soft deleting report: ", error);
                }
            });

            // Report Item Form
            reportItemForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                if (!currentUserData) return;
                const reportId = document.getElementById('item-to-report-id').value;
                const reportName = document.getElementById('item-to-report-name').textContent;
                try {
                    await addDoc(collection(db, "flags"), {
                        reportId,
                        reportName,
                        reason: document.getElementById('report-item-reason').value,
                        details: document.getElementById('report-item-details').value,
                        flaggerId: currentUserData.uid,
                        flaggerName: currentUserData.displayName,
                        timestamp: serverTimestamp()
                    });
                    showNotification("Đã gửi báo cáo sai phạm thành công.", "success");
                    closeModal(reportItemModal);
                } catch (error) {
                    showNotification("Lỗi khi gửi báo cáo sai phạm.", "error");
                }
            });

            // Settings
            settingsButton.addEventListener('click', () => openModal(settingsModal));
            themeRadios.forEach(radio => {
                radio.addEventListener('change', (e) => saveThemeChoice(e.target.value));
            });
            window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', applyTheme);

            // Admin Panel
            adminPanelHeader.addEventListener('click', () => {
                adminPanel.classList.toggle('expanded');
            });

            // Auth
            logoutButton.addEventListener('click', () => {
                signOut(auth).then(() => {
                    closeModal(settingsModal);
                    showNotification("Đã đăng xuất thành công.", "success");
                }).catch((error) => console.error("Sign out error", error));
            });

            loginForm.addEventListener('submit', (e) => {
                e.preventDefault();
                const email = document.getElementById('login-email').value;
                const password = document.getElementById('login-password').value;
                signInWithEmailAndPassword(auth, email, password)
                    .then(() => {
                        closeModal(loginModal);
                        showNotification(`Chào mừng trở lại!`, "success");
                    })
                    .catch(() => showNotification("Email hoặc mật khẩu không đúng.", "error"));
            });

            registerForm.addEventListener('submit', (e) => {
                e.preventDefault();
                const fullName = document.getElementById('register-fullname').value;
                const email = document.getElementById('register-email').value;
                const password = document.getElementById('register-password').value;
                const phone = document.getElementById('register-phone').value;
                const socialPlatform = document.getElementById('register-social-select').value;
                const socialId = document.getElementById('register-social-input').value;

                createUserWithEmailAndPassword(auth, email, password)
                    .then((userCredential) => {
                        const user = userCredential.user;
                        updateProfile(user, { displayName: fullName });
                        // Fix: Ensure email from auth is saved to Firestore
                        setDoc(doc(db, "users", user.uid), {
                            fullName, 
                            email: user.email, // Use email from auth object
                            phone, 
                            strikes: 0, 
                            isBanned: false, 
                            social: { platform: socialPlatform, id: socialId }, 
                            createdAt: serverTimestamp()
                        }).then(() => {
                            closeModal(registerModal);
                            showNotification("Đăng ký thành công! Chào mừng bạn.", "success");
                        });
                    })
                    .catch((error) => {
                        if (error.code == 'auth/email-already-in-use') {
                            showNotification('Email này đã được sử dụng.', 'error');
                        } else {
                            showNotification('Đã có lỗi xảy ra khi đăng ký.', 'error');
                        }
                    });
            });

            forgotPasswordForm.addEventListener('submit', (e) => {
                e.preventDefault();
                const email = document.getElementById('forgot-email').value;
                sendPasswordResetEmail(auth, email)
                    .then(() => {
                        closeModal(forgotPasswordModal);
                        showNotification("Link đặt lại mật khẩu đã được gửi tới email của bạn.", "success");
                    })
                    .catch(() => showNotification("Không thể gửi email. Vui lòng kiểm tra lại địa chỉ email.", "error"));
            });

            // Auth Modal Navigation
            goToRegisterLink.addEventListener('click', (e) => { e.preventDefault(); closeModal(loginModal); openModal(registerModal); });
            goToLoginLink.addEventListener('click', (e) => { e.preventDefault(); closeModal(registerModal); openModal(loginModal); });
            forgotPasswordLink.addEventListener('click', (e) => { e.preventDefault(); closeModal(loginModal); openModal(forgotPasswordModal); });
        });
    </script>
</body>
</html>
