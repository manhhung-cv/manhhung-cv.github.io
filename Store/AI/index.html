<!DOCTYPE html>
<html lang="vi" class="light">
<head>
    <meta charset="UTF-8">
     <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Hunq Store AI</title>

    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="mobile-web-app-capable" content="yes">
    <link rel="icon" href="/Asset/logo/logo.png" />
    <link rel="apple-touch-icon" href="/Asset/logo/iconApps.png" sizes="150x150" />

    <meta property="og:image" content="/Asset/img/Banner.png" />
    <meta property="og:title" content="Hunq Store AI" />
    <meta property="og:description" content="Thi·∫øt k·∫ø v√† l·∫≠p tr√¨nh ƒêinh M·∫°nh H√πng" />
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: { extend: { colors: { theme: 'var(--theme-color)', } } }
        }
    </script>

    <style>
        :root { --theme-color: #3b82f6; }
        /* Background & Glass Effect */
        .blob-container { position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: -1; overflow: hidden; background: #f0f4f8; transition: background 0.5s; }
        .dark .blob-container { background: #0f172a; }
        .blob { position: absolute; border-radius: 50%; filter: blur(80px); opacity: 0.6; animation: float 10s infinite alternate ease-in-out; }
        .blob-1 { top: -10%; left: -10%; width: 50vw; height: 50vw; background: var(--theme-color); animation-duration: 12s; }
        .blob-2 { bottom: -10%; right: -10%; width: 50vw; height: 50vw; background: #8b5cf6; animation-duration: 15s; }
        .blob-3 { top: 40%; left: 40%; width: 40vw; height: 40vw; background: #ec4899; animation-duration: 18s; animation-name: floatReverse; }
        @keyframes float { 0% { transform: translate(0, 0) scale(1); } 100% { transform: translate(30px, 50px) scale(1.1); } }
        @keyframes floatReverse { 0% { transform: translate(0, 0) scale(1); } 100% { transform: translate(-30px, -50px) scale(0.9); } }
        
        .glass-panel { background: rgba(255, 255, 255, 0.65); backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px); border: 1px solid rgba(255, 255, 255, 0.5); box-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.15); }
        .dark .glass-panel { background: rgba(17, 24, 39, 0.75); border: 1px solid rgba(255, 255, 255, 0.08); box-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.5); }
        
        /* UI Elements */
        .scrollbar-hide::-webkit-scrollbar { display: none; }
        .chat-bubble { max-width: min(90%, 800px); padding: 14px 20px; border-radius: 18px; font-size: 15px; line-height: 1.6; position: relative; word-wrap: break-word; animation: fadeIn 0.3s ease-out forwards; }
        .bot-bubble { background: rgba(255, 255, 255, 0.85); color: #1f2937; border-bottom-left-radius: 4px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
        .dark .bot-bubble { background: rgba(55, 65, 81, 0.9); color: #e5e7eb; }
        .user-bubble { background: var(--theme-color); color: white; border-bottom-right-radius: 4px; box-shadow: 0 4px 12px rgba(0,0,0,0.15); }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        
        .app-container { width: 96%; max-width: 1600px; height: 94vh; border-radius: 24px; transition: all 0.3s ease; position: relative; display: flex; flex-direction: column; overflow: hidden; margin: auto; }
        @media (max-width: 768px) { .app-container { width: 100%; height: 100vh; border-radius: 0; border: none; margin: 0; } .blob-container { opacity: 0.4; } .chat-bubble { padding: 12px 16px; } }
        
        .typing-dot { width: 6px; height: 6px; background: currentColor; border-radius: 50%; animation: typing 1.4s infinite ease-in-out both; margin: 0 1px; opacity: 0.7; }
        .typing-dot:nth-child(1) { animation-delay: -0.32s; } .typing-dot:nth-child(2) { animation-delay: -0.16s; }
        @keyframes typing { 0%, 80%, 100% { transform: scale(0); } 40% { transform: scale(1); } }
        
        .glass-btn { background: rgba(255,255,255,0.5); border: 1px solid rgba(255,255,255,0.4); transition: 0.2s; }
        .glass-btn:hover { background: rgba(255,255,255,0.8); }
        .dark .glass-btn { background: rgba(0,0,0,0.2); border-color: rgba(255,255,255,0.1); }
        .dark .glass-btn:hover { background: rgba(0,0,0,0.4); }
        
        .action-btn { background: rgba(255,255,255,0.6); border: 1px solid rgba(0,0,0,0.05); color: #1f2937; padding: 10px 14px; border-radius: 12px; text-align: left; font-size: 14px; font-weight: 500; cursor: pointer; transition: all 0.2s; display: flex; align-items: center; gap: 8px; width: 100%; }
        .dark .action-btn { background: rgba(255,255,255,0.08); border-color: rgba(255,255,255,0.05); color: #e5e7eb; }
        .action-btn:hover { background: var(--theme-color); color: white; border-color: transparent; transform: translateY(-2px); box-shadow: 0 4px 10px rgba(0,0,0,0.1); }
    </style>
</head>
<body class="flex items-center justify-center h-screen w-full font-sans text-gray-800 dark:text-gray-100 transition-colors duration-300">

    <div class="blob-container">
        <div class="blob blob-1"></div>
        <div class="blob blob-2"></div>
        <div class="blob blob-3"></div>
    </div>

    <div class="app-container glass-panel shadow-2xl flex flex-col relative">
        <!-- HEADER -->
        <div class="px-6 py-4 flex items-center justify-between border-b border-gray-200/20 dark:border-gray-700/30 z-20 backdrop-blur-md sticky top-0">
            <div class="flex items-center gap-4">
                <div class="relative group cursor-pointer">
                    <div class="w-11 h-11 rounded-full flex items-center justify-center text-white shadow-lg transition-transform group-hover:scale-105" style="background: var(--theme-color)">
                        <img src="/Asset/logo/logo.png" alt="" srcset="">
                    </div>
                    <span class="absolute bottom-0 right-0 w-3.5 h-3.5 bg-green-400 border-2 border-white dark:border-gray-800 rounded-full animate-pulse"></span>
                </div>
                <div>
                    <h1 class="font-bold text-xl leading-tight">Hunq Store AI</h1>
                    <p class="text-xs opacity-70 flex items-center gap-1" id="status-text"><i class="fa-solid fa-circle text-[8px] text-yellow-500"></i> ƒêang k·∫øt n·ªëi...</p>
                </div>
            </div>
            <div class="flex gap-3">
                <button onclick="toggleSettings()" class="w-10 h-10 rounded-full glass-btn flex items-center justify-center text-gray-600 dark:text-gray-300 hover:rotate-45 transition-transform duration-300"><i class="fa-solid fa-gear text-lg"></i></button>
            </div>
        </div>

        <!-- CHAT AREA -->
        <div id="chat-container" class="flex-1 overflow-y-auto px-4 md:px-10 py-6 space-y-5 scroll-smooth scrollbar-hide z-10"></div>

        <!-- SETTINGS PANEL -->
        <div id="settings-panel" class="absolute inset-0 bg-white/95 dark:bg-gray-900/95 backdrop-blur-xl z-30 transform translate-x-full transition-transform duration-300 flex flex-col md:max-w-sm md:border-l md:border-gray-200/20 ml-auto">
            <div class="p-4 border-b border-gray-200 dark:border-gray-700 flex justify-between items-center">
                <h2 class="font-bold text-lg">C√†i ƒë·∫∑t</h2>
                <button onclick="toggleSettings()" class="w-8 h-8 flex items-center justify-center rounded-full hover:bg-gray-200 dark:hover:bg-gray-700 transition"><i class="fa-solid fa-xmark"></i></button>
            </div>
            <div class="p-6 space-y-8 flex-1 overflow-y-auto">
                <div class="flex items-center justify-between p-3 rounded-xl bg-gray-50 dark:bg-gray-800/50">
                    <span class="font-medium flex items-center gap-2"><div class="w-8 h-8 rounded-full bg-purple-100 dark:bg-purple-900/30 text-purple-500 flex items-center justify-center"><i class="fa-solid fa-moon"></i></div> Ch·∫ø ƒë·ªô t·ªëi</span>
                    <button id="dark-mode-toggle" onclick="toggleTheme()" class="w-12 h-6 bg-gray-300 rounded-full relative transition-colors duration-300"><div class="w-4 h-4 bg-white rounded-full absolute top-1 left-1 transition-transform duration-300 shadow-sm"></div></button>
                </div>
                <div>
                    <div class="mb-3 font-medium flex items-center gap-2"><div class="w-8 h-8 rounded-full bg-pink-100 dark:bg-pink-900/30 text-pink-500 flex items-center justify-center"><i class="fa-solid fa-palette"></i></div> M√†u ch·ªß ƒë·∫°o</div>
                    <div class="grid grid-cols-4 gap-3">
                        <button onclick="changeColor('#3b82f6')" class="h-10 rounded-lg bg-blue-500 hover:scale-110 transition shadow-sm"></button>
                        <button onclick="changeColor('#8b5cf6')" class="h-10 rounded-lg bg-purple-500 hover:scale-110 transition shadow-sm"></button>
                        <button onclick="changeColor('#ec4899')" class="h-10 rounded-lg bg-pink-500 hover:scale-110 transition shadow-sm"></button>
                        <button onclick="changeColor('#10b981')" class="h-10 rounded-lg bg-emerald-500 hover:scale-110 transition shadow-sm"></button>
                        <button onclick="changeColor('#f59e0b')" class="h-10 rounded-lg bg-amber-500 hover:scale-110 transition shadow-sm"></button>
                        <button onclick="changeColor('#ef4444')" class="h-10 rounded-lg bg-red-500 hover:scale-110 transition shadow-sm"></button>
                    </div>
                </div>
                <button onclick="resetChatAndCloseSettings()" class="w-full py-3.5 rounded-xl bg-red-50 text-red-600 dark:bg-red-900/20 dark:text-red-400 font-bold hover:bg-red-100 dark:hover:bg-red-900/40 transition flex items-center justify-center gap-2"><i class="fa-solid fa-rotate-left"></i> Reset Chat</button>
            </div>
        </div>

        <!-- INPUT AREA -->
        <div class="p-4 border-t border-gray-200/20 dark:border-gray-700/30 flex items-center gap-3 relative z-20 backdrop-blur-md bg-white/30 dark:bg-gray-900/30">
            <button onclick="toggleMenu()" class="w-12 h-12 rounded-full flex items-center justify-center text-white transition hover:scale-105 shadow-lg flex-shrink-0" style="background: var(--theme-color)"><i class="fa-solid fa-bars text-xl"></i></button>
            
            <div id="quick-menu" class="absolute bottom-full left-4 mb-3 w-56 glass-panel rounded-2xl overflow-hidden hidden transform origin-bottom-left transition-all duration-200 scale-95 opacity-0 shadow-2xl">
                <div class="flex flex-col text-sm font-medium">
                    <button onclick="handleMenuAction('all')" class="px-5 py-3.5 hover:bg-gray-100/30 text-left flex items-center gap-3 border-b border-gray-100/10"><i class="fa-solid fa-list opacity-70 w-5"></i> T·∫•t c·∫£ s·∫£n ph·∫©m</button>
                    <button onclick="handleMenuAction('bestseller')" class="px-5 py-3.5 hover:bg-gray-100/30 text-left flex items-center gap-3 border-b border-gray-100/10"><i class="fa-solid fa-fire text-red-500 w-5"></i> Best Seller</button>
                    <button onclick="handleMenuAction('sale')" class="px-5 py-3.5 hover:bg-gray-100/30 text-left flex items-center gap-3 border-b border-gray-100/10"><i class="fa-solid fa-tags text-orange-500 w-5"></i> ƒêang Sale</button>
                    <button onclick="handleMenuAction('lookup')" class="px-5 py-3.5 hover:bg-gray-100/30 text-left flex items-center gap-3 border-b border-gray-100/10"><i class="fa-solid fa-magnifying-glass text-purple-500 w-5"></i> Tra c·ª©u ƒë∆°n h√†ng</button>
                    <button onclick="handleMenuAction('contact')" class="px-5 py-3.5 hover:bg-gray-100/30 text-left flex items-center gap-3 border-b border-gray-100/10"><i class="fa-brands fa-facebook-messenger text-blue-500 w-5"></i> Nh·∫Øn tin Admin</button>
                    <button onclick="handleMenuAction('help')" class="px-5 py-3.5 hover:bg-gray-100/30 text-left flex items-center gap-3"><i class="fa-solid fa-circle-question text-gray-500 w-5"></i> H∆∞·ªõng d·∫´n</button>
                </div>
            </div>

            <form id="chat-form" class="flex-1 relative">
                <input type="text" id="user-input" class="w-full bg-white/60 dark:bg-gray-800/60 text-gray-800 dark:text-gray-100 rounded-full pl-6 pr-14 py-3.5 focus:outline-none focus:ring-2 focus:ring-[var(--theme-color)] border border-transparent transition-all placeholder-gray-500 shadow-inner backdrop-blur-sm text-base" placeholder="Nh·∫≠p t√™n s·∫£n ph·∫©m ho·∫∑c 'help'..." autocomplete="off">
                <button type="submit" class="absolute right-2 top-1/2 transform -translate-y-1/2 w-10 h-10 flex items-center justify-center text-[var(--theme-color)] hover:bg-white/50 rounded-full transition"><i class="fa-solid fa-paper-plane text-lg"></i></button>
            </form>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js';
        import { getAuth, signInAnonymously } from 'https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js';
        import { getFirestore, collection, onSnapshot, addDoc, query, where, getDocs } from 'https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js';

        // --- FIREBASE CONFIG (USER PROVIDED) ---
        const firebaseConfig = {
            apiKey: "AIzaSyATk8l02r44KE2c_PPytEg1Zv43rZZRcN8",
            authDomain: "store-hunq.firebaseapp.com",
            databaseURL: "https://store-hunq-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "store-hunq",
            storageBucket: "store-hunq.firebasestorage.app",
            messagingSenderId: "879933378644",
            appId: "1:879933378644:web:41911950a1872b31df1dc1",
            measurementId: "G-D8TNFCSHQD"
        };
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        
        // Use Global App ID for path consistency if available, else default
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';

        let productList = [];
        let chatState = { step: 'IDLE', selectedProduct: null, selectedType: null, selectedPrice: 0, contactMethod: null };
        const statusText = document.getElementById('status-text');

        // --- INIT ---
        async function init() {
            try {
                await signInAnonymously(auth);
                statusText.innerHTML = '<i class="fa-solid fa-circle text-[8px] text-green-500"></i> Online 24/7';
                
                // Realtime Products
                const productsRef = collection(db, 'artifacts', appId, 'public', 'data', 'products');
                onSnapshot(productsRef, (snapshot) => {
                    productList = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                }, (error) => {
                    console.error("Firestore Error:", error);
                    statusText.innerHTML = '<i class="fa-solid fa-circle text-[8px] text-red-500"></i> L·ªói k·∫øt n·ªëi (Ch·∫∑n QC?)';
                });
            } catch (error) {
                console.error("Auth Error:", error);
                statusText.innerHTML = '<i class="fa-solid fa-circle text-[8px] text-red-500"></i> M·∫•t k·∫øt n·ªëi';
            }
        }
        init();

        // --- UI HELPERS ---
        const chatContainer = document.getElementById('chat-container');
        const userInput = document.getElementById('user-input');
        const darkModeToggle = document.getElementById('dark-mode-toggle');
        const quickMenu = document.getElementById('quick-menu');
        const root = document.documentElement;
        
        // LOAD LOCAL STORAGE SETTINGS
        let isDarkMode = localStorage.getItem('shopBot_darkMode') === 'true';
        let currentThemeColor = localStorage.getItem('shopBot_themeColor') || '#3b82f6';

        // APPLY INITIAL SETTINGS
        if (isDarkMode) root.classList.add('dark');
        root.style.setProperty('--theme-color', currentThemeColor);

        // SYNC UI TOGGLE
        if (isDarkMode) {
            darkModeToggle.classList.remove('bg-gray-300');
            darkModeToggle.style.backgroundColor = currentThemeColor;
            darkModeToggle.children[0].classList.remove('left-1');
            darkModeToggle.children[0].classList.add('translate-x-6');
        }

        window.toggleSettings = () => document.getElementById('settings-panel').classList.toggle('translate-x-full');
        
        // Updated toggleMenu with animations
        window.toggleMenu = () => {
            if (quickMenu.classList.contains('hidden')) {
                quickMenu.classList.remove('hidden');
                setTimeout(() => {
                    quickMenu.classList.remove('scale-95', 'opacity-0');
                    quickMenu.classList.add('scale-100', 'opacity-100');
                }, 10);
            } else {
                quickMenu.classList.remove('scale-100', 'opacity-100');
                quickMenu.classList.add('scale-95', 'opacity-0');
                setTimeout(() => {
                    quickMenu.classList.add('hidden');
                }, 200);
            }
        };

        // Add click outside listener for menu
        document.addEventListener('click', (e) => {
            const menuBtn = document.querySelector('button[onclick="toggleMenu()"]');
            if (quickMenu && !quickMenu.contains(e.target) && menuBtn && !menuBtn.contains(e.target)) {
                if (!quickMenu.classList.contains('hidden')) {
                    window.toggleMenu();
                }
            }
        });
        
        window.toggleTheme = () => {
            isDarkMode = !isDarkMode;
            localStorage.setItem('shopBot_darkMode', isDarkMode); // SAVE
            
            root.classList.toggle('dark', isDarkMode);
            
            if (isDarkMode) {
                darkModeToggle.classList.remove('bg-gray-300');
                darkModeToggle.style.backgroundColor = getComputedStyle(root).getPropertyValue('--theme-color').trim();
                darkModeToggle.children[0].classList.remove('left-1');
                darkModeToggle.children[0].classList.add('translate-x-6');
            } else {
                darkModeToggle.style.backgroundColor = '';
                darkModeToggle.classList.add('bg-gray-300');
                darkModeToggle.children[0].classList.remove('translate-x-6');
                darkModeToggle.children[0].classList.add('left-1');
            }
        };

        window.changeColor = (color) => {
            root.style.setProperty('--theme-color', color);
            localStorage.setItem('shopBot_themeColor', color); // SAVE
            if(isDarkMode) darkModeToggle.style.backgroundColor = color;
        };

        window.resetChatAndCloseSettings = () => {
            chatContainer.innerHTML = '';
            chatState = { step: 'IDLE', selectedProduct: null, selectedType: null, selectedPrice: 0, contactMethod: null };
            addMessage("Xin ch√†o! B·∫°n c·∫ßn t√¨m g√¨ h√¥m nay? (G√µ 'Help' ƒë·ªÉ xem h∆∞·ªõng d·∫´n)");
            document.getElementById('settings-panel').classList.add('translate-x-full');
        };

        function addMessage(content, sender = 'bot') {
            const wrapper = document.createElement('div');
            wrapper.className = `flex w-full mb-6 ${sender === 'user' ? 'justify-end' : 'justify-start'}`;
            let avatar = sender === 'bot' ? `<div class="w-10 h-10 rounded-full flex items-center justify-center text-white text-sm mr-3 mt-auto shadow-md" style="background: var(--theme-color)">
                <img src="/Asset/logo/logo.png" alt="" srcset="">
                </div>` : '';
            const bubble = document.createElement('div');
            // If content contains carousel class, don't style wrapper
            if (sender === 'bot' && content.includes('product-carousel')) bubble.className = 'w-full overflow-hidden';
            else bubble.className = `chat-bubble ${sender === 'user' ? 'user-bubble' : 'bot-bubble'}`;
            
            bubble.innerHTML = content;
            wrapper.innerHTML = sender === 'bot' ? avatar : '';
            wrapper.appendChild(bubble);
            chatContainer.appendChild(wrapper);
            chatContainer.scrollTop = chatContainer.scrollHeight;
        }

        function showTyping() {
            const id = 'typing-' + Date.now();
            const wrapper = document.createElement('div');
            wrapper.id = id; wrapper.className = 'flex w-full mb-6 justify-start';
            wrapper.innerHTML = `<div class="w-10 h-10 rounded-full bg-gray-200/50 dark:bg-gray-700/50 mr-3 mt-auto"></div><div class="chat-bubble bot-bubble flex items-center h-[48px] min-w-[70px] justify-center gap-1.5"><div class="typing-dot text-gray-400"></div><div class="typing-dot text-gray-400"></div><div class="typing-dot text-gray-400"></div></div>`;
            chatContainer.appendChild(wrapper); chatContainer.scrollTop = chatContainer.scrollHeight; return id;
        }
        
        function removeTyping(id) { const el = document.getElementById(id); if (el) el.remove(); }

        // --- LOGIC FUNCTIONS ---
        function cleanInput(str) {
            const stopWords = ['c√≥', 'kh√¥ng', 'b√°n', 'cho', 'm√¨nh', 'h·ªèi', 'gi√°', 'shop', '∆°i', 'c·∫ßn', 'mua', 'bao', 'nhi√™u', 'n√†o', 'v·ªõi', 't∆∞', 'v·∫•n', 'em', 'anh', 'ch·ªã', 'ad', 'admin', 'g√≥i', 't√†i', 'kho·∫£n', 'tk', 'acc', 'account', 'b√™n', 'nh√©', '·∫°', 'c√≤n', 'h√†ng'];
            let cleaned = str.toLowerCase().replace(/[?.,!]/g, ' ');
            stopWords.forEach(word => cleaned = cleaned.replace(new RegExp(`\\b${word}\\b`, 'gi'), ' '));
            return cleaned.replace(/\s+/g, ' ').trim();
        }
        function escapeStr(str) { return str ? str.replace(/'/g, "\\'") : ''; }
        function validateLink(link) { return /(facebook\.com|fb\.com)\//i.test(link); }
        function validateEmail(email) { return /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email); }
        
        function maskUserInfo(info) {
            if (!info) return "Unknown";
            if (info.includes('/')) return info.split('/').pop().substring(0, 3) + "*** (Facebook)";
            if (info.includes('@')) return info.substring(0, 3) + "***@" + info.split('@')[1];
            return info.substring(0, 3) + "***";
        }

        // PRICE FORMATTER: Auto detect short vs full
        function formatPrice(priceVal) {
            let val = parseInt(priceVal);
            if(isNaN(val)) return '0ƒë';
            if (val < 10000) val = val * 1000;
            return val.toLocaleString('vi-VN') + 'ƒë';
        }

        // PRICE NORMALIZER: For calculations
        function getRealPrice(priceVal) {
            let val = parseInt(priceVal);
            if(isNaN(val)) return 0;
            if (val < 10000) val = val * 1000;
            return val;
        }

        function getDaysRemaining(expDateStr) {
            if(!expDateStr || expDateStr === 'Ch·ªù duy·ªát') return null;
            // Assuming admin saves date as YYYY-MM-DD
            const exp = new Date(expDateStr);
            const now = new Date();
            if(isNaN(exp.getTime())) return null;
            return Math.ceil((exp - now) / (1000 * 60 * 60 * 24));
        }

        async function lookupOrder(code) {
            try {
                const ordersRef = collection(db, 'artifacts', appId, 'public', 'data', 'orders');
                const q = query(ordersRef, where("code", "==", code));
                const querySnapshot = await getDocs(q);
                if (querySnapshot.empty) return null;
                return querySnapshot.docs[0].data();
            } catch (e) { return null; }
        }

        // --- MAIN BOT LOGIC ---
        async function processBotLogic(message) {
            const lowerMsg = message.toLowerCase();
            const cleanedMsg = cleanInput(message);

            // TRA C·ª®U
            if (lowerMsg.startsWith('tc#')) {
                const code = message.substring(3).trim().toUpperCase();
                const order = await lookupOrder(code);

                if (order) {
                    const daysLeft = getDaysRemaining(order.expDate);
                    let expiryInfo = '';
                    
                    if (daysLeft === null) {
                        expiryInfo = `<span class="text-gray-500">ƒêang c·∫≠p nh·∫≠t</span>`;
                    } else if (daysLeft < 0) {
                        expiryInfo = `<span class="text-red-500 font-bold">H·∫øt h·∫°n ${Math.abs(daysLeft)} ng√†y</span>`;
                    } else {
                        const color = daysLeft <= 5 ? "text-orange-500" : "text-green-600";
                        expiryInfo = `<span class="${color} font-bold">C√≤n ${daysLeft} ng√†y</span>`;
                    }

                    return `
                        <div class="font-bold text-lg mb-2" style="color:var(--theme-color)">ƒê∆°n h√†ng #${order.code}</div>
                        <div class="bg-gray-50 dark:bg-gray-800/50 p-4 rounded-xl text-sm border border-gray-100 dark:border-gray-700 space-y-2">
                            <div class="flex justify-between border-b pb-2 dark:border-gray-700"><span class="text-gray-500">Kh√°ch:</span> <span class="font-medium">${maskUserInfo(order.contact)}</span></div>
                            <div class="flex justify-between"><span class="text-gray-500">SP:</span> <span class="font-bold">${order.productName}</span></div>
                            <div class="flex justify-between"><span class="text-gray-500">Ng√†y mua:</span> <span>${order.date}</span></div>
                            <div class="flex justify-between"><span class="text-gray-500">Gi√°:</span> <span class="font-bold text-[var(--theme-color)]">${parseInt(order.amount).toLocaleString()}ƒë</span></div>
                            <div class="flex justify-between"><span class="text-gray-500">Ghi ch√∫:</span> <span class="italic">${order.note || 'Kh√¥ng'}</span></div>
                            <div class="pt-2 mt-2 border-t flex justify-between dark:border-gray-700"><span class="text-gray-500">H·∫°n:</span> ${expiryInfo}</div>
                            <div class="text-xs text-right text-gray-400">Exp: ${order.expDate || '---'}</div>
                        </div>`;
                }
                return `Kh√¥ng t√¨m th·∫•y m√£ "<b>${code}</b>".`;
            }

            // COMMANDS
            if (['h·ªßy', 'cancel', 'reset'].includes(lowerMsg)) {
                chatState = { step: 'IDLE', selectedProduct: null, selectedType: null, selectedPrice: 0, contactMethod: null };
                return "ƒê√£ l√†m m·ªõi. B·∫°n c·∫ßn t√¨m g√¨ ·∫°?";
            }
            if (['help', 'l·ªánh', 'hd', 'h∆∞·ªõng d·∫´n'].includes(lowerMsg)) {
                return `<div class="font-bold mb-2 text-[var(--theme-color)]">üìò H∆∞·ªõng d·∫´n:</div><ul class="list-disc pl-5 text-sm"><li><b>T√¨m SP:</b> Nh·∫≠p t√™n (vd: Netflix).</li><li><b>Tra c·ª©u:</b> TC#M√£ƒê∆°n.</li><li><b>Reset:</b> H·ªßy thao t√°c.</li></ul>`;
            }
            if (lowerMsg === 'all' || message === 'T·∫•t c·∫£ s·∫£n ph·∫©m') {
                if(productList.length === 0) return "Ch∆∞a c√≥ s·∫£n ph·∫©m n√†o.";
                let html = `<div class="product-carousel"><div class="mb-2 font-bold ml-1 text-gray-700 dark:text-gray-300">Danh s√°ch s·∫£n ph·∫©m:</div><div class="flex gap-4 overflow-x-auto pb-4 pt-2 snap-x scrollbar-hide w-full px-1">`;
                productList.forEach(p => {
                    html += `<button onclick="handleUserAction('${escapeStr(p.name)}', '${escapeStr(p.name)}')" class="chat-bubble bot-bubble !max-w-[220px] !min-w-[200px] !p-4 flex flex-col items-start gap-2 flex-shrink-0 snap-center hover:scale-[1.02] transition-transform cursor-pointer !m-0 !rounded-2xl"><div class="w-10 h-10 rounded-full bg-blue-100 dark:bg-blue-900/40 text-blue-500 flex items-center justify-center mb-1"><i class="fa-solid fa-cube text-lg"></i></div><div class="font-bold text-sm truncate w-full text-left" title="${p.name}">${p.name}</div><div class="text-xs opacity-60 line-clamp-2 text-left">${p.category}</div><div class="mt-2 text-xs font-bold text-[var(--theme-color)]">Xem chi ti·∫øt <i class="fa-solid fa-arrow-right ml-1"></i></div></button>`;
                });
                return html + `</div></div>`;
            }

            // IDLE: SEARCH
            if (chatState.step === 'IDLE') {
                const searchKey = cleanedMsg.length > 0 ? cleanedMsg : lowerMsg;
                let results = productList.filter(p => p.name.toLowerCase().includes(searchKey) || p.category.toLowerCase().includes(searchKey));
                
                if (results.length === 0 && searchKey.includes(' ')) {
                    const keywords = searchKey.split(' ');
                    results = productList.filter(p => keywords.every(kw => (p.name + ' ' + p.category).toLowerCase().includes(kw)));
                }

                if (results.length === 0) return `Kh√¥ng t√¨m th·∫•y "<b>${message}</b>". Th·ª≠ <b>All</b> xem sao nh√©.`;
                
                if (results.length === 1) {
                    const p = results[0];
                    chatState.selectedProduct = p;
                    chatState.step = 'SELECT_TYPE';
                    
                    let html = `<div class="font-bold text-xl mb-1 text-[var(--theme-color)]">${p.name}</div><div class="text-sm opacity-70 mb-4 italic pl-3 border-l-2 dark:border-gray-600">${p.desc}</div><div class="font-medium mb-2">Ch·ªçn g√≥i:</div>`;
                    const types = typeof p.types === 'string' ? p.types.split(',') : p.types;
                    const prices = typeof p.prices === 'string' ? p.prices.split(',') : p.prices;
                    
                    types.forEach((t, i) => {
                        let displayPrice = formatPrice(prices[i]);
                        html += `<button onclick="handleUserAction('${i}', '${t.trim()}')" class="action-btn flex justify-between group my-2"><span>${t.trim()}</span><span class="font-bold bg-gray-100 dark:bg-black/20 px-2 py-0.5 rounded">${displayPrice}</span></button>`;
                    });
                    return html;
                } else {
                    let html = `<div class="product-carousel"><div class="mb-2 ml-1">T√¨m th·∫•y ${results.length} k·∫øt qu·∫£:</div><div class="flex gap-4 overflow-x-auto pb-4 pt-2 snap-x scrollbar-hide w-full px-1">`;
                    results.forEach(p => html += `<button onclick="handleUserAction('${escapeStr(p.name)}', '${escapeStr(p.name)}')" class="chat-bubble bot-bubble !max-w-[220px] !min-w-[200px] !p-4 flex flex-col items-start gap-2 flex-shrink-0 snap-center hover:scale-[1.02] transition-transform cursor-pointer !m-0 !rounded-2xl"><div class="w-10 h-10 rounded-full bg-blue-100 dark:bg-blue-900/40 text-blue-500 flex items-center justify-center mb-1"><i class="fa-solid fa-cube text-lg"></i></div><div class="font-bold text-sm truncate w-full text-left" title="${p.name}">${p.name}</div></button>`);
                    return html + `</div></div>`;
                }
            }

            // SELECT TYPE
            if (chatState.step === 'SELECT_TYPE') {
                if(!chatState.selectedProduct) { chatState.step = 'IDLE'; return "L·ªói d·ªØ li·ªáu. Vui l√≤ng t√¨m l·∫°i s·∫£n ph·∫©m."; }
                
                const p = chatState.selectedProduct;
                const types = typeof p.types === 'string' ? p.types.split(',') : p.types;
                const prices = typeof p.prices === 'string' ? p.prices.split(',') : p.prices;

                let idx = -1;
                // Check if input matches a type
                if (!isNaN(message) && parseInt(message) >= 0 && parseInt(message) < types.length) idx = parseInt(message);
                else idx = types.findIndex(t => message.toLowerCase().includes(t.trim().toLowerCase()));

                if (idx !== -1) {
                    chatState.selectedType = types[idx].trim();
                    chatState.selectedPrice = getRealPrice(prices[idx]); 
                    
                    chatState.step = 'CHOOSE_CONTACT';
                    return `<div class="bg-blue-50 dark:bg-blue-900/20 p-4 rounded-xl border border-blue-100 dark:border-gray-700 mb-3"><div class="flex justify-between"><span>SP:</span> <b>${p.name}</b></div><div class="flex justify-between"><span>G√≥i:</span> <b>${chatState.selectedType}</b></div><div class="text-right font-bold text-xl text-[var(--theme-color)] mt-2">${chatState.selectedPrice.toLocaleString('vi-VN')}ƒë</div></div><div>Ch·ªçn c√°ch nh·∫≠n h√†ng:</div><div class="grid grid-cols-2 gap-2 mt-2"><button onclick="handleUserAction('messenger', 'Messenger')" class="action-btn justify-center"><i class="fa-brands fa-facebook-messenger text-blue-500"></i> Messenger</button><button onclick="handleUserAction('email', 'Email')" class="action-btn justify-center"><i class="fa-solid fa-envelope text-red-500"></i> Email</button></div>`;
                } else {
                    // Smart switch: Check if user typed another product name
                    const searchKey = cleanedMsg.length > 0 ? cleanedMsg : lowerMsg;
                    const results = productList.filter(prod => prod.name.toLowerCase().includes(searchKey));
                    
                    if(results.length === 1) {
                        const newP = results[0];
                        chatState.selectedProduct = newP;
                        // Show type selection for NEW product
                        let html = `<div class="mb-2 text-sm italic opacity-70">ƒê√£ chuy·ªÉn sang:</div><div class="font-bold text-xl mb-1 text-[var(--theme-color)]">${newP.name}</div><div class="font-medium mb-2">Ch·ªçn g√≥i:</div>`;
                        const newTypes = typeof newP.types === 'string' ? newP.types.split(',') : newP.types;
                        const newPrices = typeof newP.prices === 'string' ? newP.prices.split(',') : newP.prices;
                        newTypes.forEach((t, i) => {
                            let displayPrice = formatPrice(newPrices[i]);
                            html += `<button onclick="handleUserAction('${i}', '${t.trim()}')" class="action-btn flex justify-between group"><span>${t.trim()}</span><span class="font-bold bg-gray-100 dark:bg-black/20 px-2 py-0.5 rounded">${displayPrice}</span></button>`;
                        });
                        return html;
                    }
                    else if (results.length > 1) {
                        chatState.step = 'IDLE'; // Reset to IDLE to show list
                        let html = `<div class="product-carousel"><div class="mb-2 ml-1">C√≥ ph·∫£i b·∫°n t√¨m s·∫£n ph·∫©m kh√°c? (${results.length}):</div><div class="flex gap-4 overflow-x-auto pb-4 pt-2 snap-x scrollbar-hide w-full px-1">`;
                        results.forEach(p => html += `<button onclick="handleUserAction('${escapeStr(p.name)}', '${escapeStr(p.name)}')" class="chat-bubble bot-bubble !max-w-[220px] !min-w-[200px] !p-4 flex flex-col items-start gap-2 flex-shrink-0 snap-center hover:scale-[1.02] transition-transform cursor-pointer !m-0 !rounded-2xl"><div class="w-10 h-10 rounded-full bg-blue-100 dark:bg-blue-900/40 text-blue-500 flex items-center justify-center mb-1"><i class="fa-solid fa-cube text-lg"></i></div><div class="font-bold text-sm truncate w-full text-left">${p.name}</div></button>`);
                        return html + `</div></div>`;
                    }

                    return "G√≥i kh√¥ng h·ª£p l·ªá. Vui l√≤ng ch·ªçn g√≥i ho·∫∑c nh·∫≠p t√™n s·∫£n ph·∫©m kh√°c.";
                }
            }

            if (chatState.step === 'CHOOSE_CONTACT') {
                if(!chatState.selectedProduct) { chatState.step = 'IDLE'; return "L·ªói d·ªØ li·ªáu. Vui l√≤ng t√¨m l·∫°i."; }
                if (lowerMsg.includes('mess')) { chatState.contactMethod = 'Messenger'; chatState.step = 'INPUT_CONTACT'; return "Nh·∫≠p <b>Link Facebook</b> c·ªßa b·∫°n:"; }
                if (lowerMsg.includes('mail')) { chatState.contactMethod = 'Email'; chatState.step = 'INPUT_CONTACT'; return "Nh·∫≠p <b>Email</b> c·ªßa b·∫°n:"; }
                return "Vui l√≤ng ch·ªçn Messenger ho·∫∑c Email.";
            }

            if (chatState.step === 'INPUT_CONTACT') {
                if(!chatState.selectedProduct) { chatState.step = 'IDLE'; return "L·ªói d·ªØ li·ªáu. Vui l√≤ng t√¨m l·∫°i."; }
                if (chatState.contactMethod === 'Email' && !validateEmail(message)) return "Email sai ƒë·ªãnh d·∫°ng.";
                if (chatState.contactMethod === 'Messenger' && !validateLink(message)) return "Link FB sai ƒë·ªãnh d·∫°ng (ph·∫£i c√≥ facebook.com).";

                const orderCode = "DH" + Math.floor(1000 + Math.random() * 9000);
                const realAmount = chatState.selectedPrice; 
                
                // SAVE ORDER
                try {
                    await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'orders'), {
                        code: orderCode,
                        productName: chatState.selectedProduct.name,
                        type: chatState.selectedType,
                        amount: realAmount,
                        contact: message,
                        method: chatState.contactMethod,
                        date: new Date().toLocaleDateString('vi-VN'),
                        expDate: "Ch·ªù duy·ªát",
                        status: "New",
                        note: "ƒêang x·ª≠ l√Ω"
                    });
                } catch(e) { console.error("Save Error", e); }

                const paymentLink = `https://mhung.site/PayGate/?AMOUT=${realAmount}`;
                
                const info = { p: chatState.selectedProduct.name, t: chatState.selectedType, pr: chatState.selectedPrice.toLocaleString('vi-VN') };
                chatState = { step: 'IDLE', selectedProduct: null, selectedType: null, selectedPrice: 0, contactMethod: null };

                setTimeout(() => addMessage(`N·∫øu sau khi thanh to√°n v√† ch·ªù qu√° l√¢u, h√£y nh·∫Øn Admin t·∫°i: <a href="https://m.me/HunqD" target="_blank" class="text-blue-500 font-bold underline">Messenger</a>`, 'bot'), 1500);

                return `
                    <div class="text-center mb-3"><div class="inline-flex items-center justify-center w-12 h-12 rounded-full bg-green-100 text-green-500 mb-2"><i class="fa-solid fa-check text-xl"></i></div><div class="font-bold text-green-600">ƒê√£ l√™n ƒë∆°n: ${orderCode}</div></div>
                    <div class="bg-gray-50 dark:bg-gray-800 p-3 rounded text-sm mb-3 border dark:border-gray-700">
                        <div class="flex justify-between"><span>SP:</span> <b>${info.p}</b></div>
                        <div class="flex justify-between"><span>G√≥i:</span> <b>${info.t}</b></div>
                        <div class="flex justify-between border-t mt-2 pt-2 dark:border-gray-700"><span>T·ªïng:</span> <b class="text-[var(--theme-color)]">${info.pr}ƒë</b></div>
                    </div>
                    <a href="${paymentLink}" target="_blank" class="block w-full text-center text-white font-bold py-3 rounded-xl shadow-lg hover:opacity-90 transition" style="background:var(--theme-color)">THANH TO√ÅN NGAY</a>
                `;
            }
            return "M√¨nh kh√¥ng hi·ªÉu. G√µ 'Help' nh√©.";
        }

        // --- HANDLERS ---
        window.handleUserAction = (val, txt, isSys) => {
            addMessage(txt || val, 'user');
            userInput.value = '';
            const tId = showTyping();
            setTimeout(async () => {
                const res = await processBotLogic(val);
                removeTyping(tId);
                addMessage(res, 'bot');
            }, 600);
        };

        document.getElementById('chat-form').addEventListener('submit', (e) => {
            e.preventDefault();
            const v = userInput.value.trim();
            if(v) window.handleUserAction(v, v);
        });

        window.handleMenuAction = (action) => {
            document.getElementById('quick-menu').classList.add('hidden');
            if(action === 'lookup') { addMessage("H√£y nh·∫≠p m√£ ƒë∆°n h√†ng (VD: TC#DH1234)", 'bot'); }
            else if(action === 'contact') { window.open('https://m.me/HunqD'); }
            else if(action === 'help') window.handleUserAction('help', 'H∆∞·ªõng d·∫´n');
            else window.handleUserAction(action, action === 'all' ? 'T·∫•t c·∫£ s·∫£n ph·∫©m' : action);
        };

        setTimeout(() => addMessage("üëã Xin ch√†o! M√¨nh c√≥ th·ªÉ gi√∫p g√¨ cho b·∫°n?"), 500);
    </script>
</body>
</html>