<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard - Shop Bot</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>
<body class="bg-gray-100 font-sans text-gray-800">

    <!-- LOGIN SCREEN -->
    <div id="login-screen" class="fixed inset-0 z-50 flex items-center justify-center bg-gray-900 bg-opacity-90 backdrop-blur-sm">
        <div class="bg-white p-8 rounded-2xl shadow-2xl w-full max-w-md">
            <div class="text-center mb-6">
                <div class="w-16 h-16 bg-blue-600 rounded-full flex items-center justify-center mx-auto mb-4 text-white text-2xl"><i class="fa-solid fa-user-shield"></i></div>
                <h2 class="text-2xl font-bold text-gray-800">Admin Login</h2>
            </div>
            <form id="login-form" class="space-y-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Email</label>
                    <input type="email" id="email" class="w-full border border-gray-300 rounded-lg px-4 py-2 focus:ring-2 focus:ring-blue-500 outline-none" required>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Mật khẩu</label>
                    <input type="password" id="password" class="w-full border border-gray-300 rounded-lg px-4 py-2 focus:ring-2 focus:ring-blue-500 outline-none" required>
                </div>
                <button type="submit" class="w-full bg-blue-600 text-white font-bold py-3 rounded-lg hover:bg-blue-700 transition">Đăng Nhập</button>
                <div id="login-error" class="text-red-500 text-sm text-center hidden">Sai thông tin đăng nhập!</div>
            </form>
            <div class="mt-4 text-center text-xs text-gray-400">
                <button onclick="toggleRegister()" class="hover:underline">Chưa có tài khoản? Đăng ký</button>
            </div>
        </div>
    </div>

    <!-- MAIN DASHBOARD -->
    <div id="dashboard" class="hidden min-h-screen flex flex-col md:flex-row">
        <!-- Sidebar -->
        <div class="bg-white w-full md:w-64 border-r border-gray-200 flex flex-col">
            <div class="p-6 border-b border-gray-100 flex items-center gap-3">
                <div class="w-8 h-8 bg-blue-600 rounded-lg flex items-center justify-center text-white"><i class="fa-solid fa-bolt"></i></div>
                <span class="font-bold text-xl">Admin Panel</span>
            </div>
            <nav class="flex-1 p-4 space-y-2">
                <button onclick="switchTab('products')" id="tab-products" class="w-full flex items-center gap-3 px-4 py-3 rounded-xl bg-blue-50 text-blue-600 font-medium transition"><i class="fa-solid fa-box"></i> Sản phẩm</button>
                <button onclick="switchTab('orders')" id="tab-orders" class="w-full flex items-center gap-3 px-4 py-3 rounded-xl text-gray-600 hover:bg-gray-50 transition"><i class="fa-solid fa-clipboard-list"></i> Đơn hàng</button>
            </nav>
            <div class="p-4 border-t">
                <button onclick="logout()" class="w-full flex items-center gap-3 px-4 py-2 text-red-500 hover:bg-red-50 rounded-lg transition"><i class="fa-solid fa-right-from-bracket"></i> Đăng xuất</button>
            </div>
        </div>

        <!-- Content -->
        <div class="flex-1 p-4 md:p-8 overflow-y-auto">
            
            <!-- PRODUCTS TAB -->
            <div id="view-products" class="space-y-6">
                <div class="flex justify-between items-center">
                    <h1 class="text-2xl font-bold">Quản lý Sản phẩm</h1>
                    <button onclick="openProductModal()" class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 flex items-center gap-2 shadow-lg"><i class="fa-solid fa-plus"></i> Thêm mới</button>
                </div>
                
                <div class="bg-white rounded-xl shadow-sm border border-gray-200 overflow-hidden">
                    <table class="w-full text-left border-collapse">
                        <thead class="bg-gray-50 text-gray-500 text-xs uppercase font-semibold">
                            <tr>
                                <th class="px-6 py-4">Tên SP</th>
                                <th class="px-6 py-4">Danh mục</th>
                                <th class="px-6 py-4 text-center">Sale</th>
                                <th class="px-6 py-4 text-right">Hành động</th>
                            </tr>
                        </thead>
                        <tbody id="product-list" class="divide-y divide-gray-100 text-sm">
                            <!-- JS will inject rows here -->
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- ORDERS TAB -->
            <div id="view-orders" class="space-y-6 hidden">
                <div class="flex justify-between items-center">
                    <h1 class="text-2xl font-bold">Quản lý Đơn hàng</h1>
                    <div class="text-sm text-gray-500">Tự động cập nhật</div>
                </div>

                <div class="grid gap-4" id="order-list">
                    <!-- Cards for orders -->
                </div>
            </div>

        </div>
    </div>

    <!-- MODAL ADD/EDIT PRODUCT -->
    <div id="product-modal" class="fixed inset-0 z-50 hidden flex items-center justify-center bg-black bg-opacity-50 backdrop-blur-sm px-4">
        <div class="bg-white w-full max-w-lg rounded-2xl shadow-2xl overflow-hidden animate-[fadeIn_0.2s]">
            <div class="p-5 border-b flex justify-between items-center bg-gray-50">
                <h3 class="font-bold text-lg" id="modal-title">Thêm sản phẩm</h3>
                <button onclick="closeModal()" class="text-gray-400 hover:text-gray-600"><i class="fa-solid fa-xmark text-xl"></i></button>
            </div>
            <form id="product-form" class="p-6 space-y-4">
                <input type="hidden" id="p-id">
                <div>
                    <label class="block text-xs font-bold text-gray-500 uppercase mb-1">Tên Sản Phẩm</label>
                    <input type="text" id="p-name" class="w-full border rounded-lg px-3 py-2 outline-none focus:border-blue-500" required>
                </div>
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-xs font-bold text-gray-500 uppercase mb-1">Danh mục</label>
                        <input type="text" id="p-category" class="w-full border rounded-lg px-3 py-2 outline-none focus:border-blue-500" required>
                    </div>
                    <div>
                        <label class="block text-xs font-bold text-gray-500 uppercase mb-1">Giảm giá (%)</label>
                        <input type="number" id="p-sale" class="w-full border rounded-lg px-3 py-2 outline-none focus:border-blue-500" value="0">
                    </div>
                </div>
                <div>
                    <label class="block text-xs font-bold text-gray-500 uppercase mb-1">Mô tả ngắn</label>
                    <textarea id="p-desc" class="w-full border rounded-lg px-3 py-2 outline-none focus:border-blue-500 h-20"></textarea>
                </div>
                <div>
                    <label class="block text-xs font-bold text-gray-500 uppercase mb-1">Các gói (Cách nhau dấu phẩy)</label>
                    <input type="text" id="p-types" placeholder="1 Tháng, 6 Tháng, 1 Năm" class="w-full border rounded-lg px-3 py-2 outline-none focus:border-blue-500">
                </div>
                <div>
                    <label class="block text-xs font-bold text-gray-500 uppercase mb-1">Giá tương ứng (Nghìn đồng, cách dấu phẩy)</label>
                    <input type="text" id="p-prices" placeholder="100, 500, 900" class="w-full border rounded-lg px-3 py-2 outline-none focus:border-blue-500">
                </div>
                <div class="pt-4 flex gap-3">
                    <button type="button" onclick="closeModal()" class="flex-1 py-2.5 rounded-lg border border-gray-300 hover:bg-gray-50 font-medium">Hủy</button>
                    <button type="submit" class="flex-1 py-2.5 rounded-lg bg-blue-600 text-white hover:bg-blue-700 font-bold shadow-lg shadow-blue-200">Lưu lại</button>
                </div>
            </form>
        </div>
    </div>

    <!-- MODAL EDIT ORDER -->
    <div id="order-modal" class="fixed inset-0 z-50 hidden flex items-center justify-center bg-black bg-opacity-50 backdrop-blur-sm px-4">
        <div class="bg-white w-full max-w-md rounded-2xl shadow-2xl p-6">
            <h3 class="font-bold text-lg mb-4">Cập nhật đơn hàng</h3>
            <form id="order-form" class="space-y-4">
                <input type="hidden" id="o-id">
                <div>
                    <label class="block text-xs font-bold text-gray-500 uppercase mb-1">Ghi chú (Admin)</label>
                    <textarea id="o-note" class="w-full border rounded-lg px-3 py-2 outline-none h-20"></textarea>
                </div>
                <div>
                    <label class="block text-xs font-bold text-gray-500 uppercase mb-1">Ngày hết hạn (YYYY-MM-DD)</label>
                    <input type="date" id="o-exp" class="w-full border rounded-lg px-3 py-2 outline-none">
                </div>
                <div>
                    <label class="block text-xs font-bold text-gray-500 uppercase mb-1">Trạng thái</label>
                    <select id="o-status" class="w-full border rounded-lg px-3 py-2 outline-none">
                        <option value="New">Mới</option>
                        <option value="Done">Hoàn thành</option>
                        <option value="Cancel">Hủy</option>
                    </select>
                </div>
                <button type="submit" class="w-full bg-green-600 text-white font-bold py-2.5 rounded-lg mt-2">Cập nhật</button>
            </form>
            <button onclick="document.getElementById('order-modal').classList.add('hidden')" class="w-full mt-2 text-gray-500 hover:underline">Đóng</button>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js';
        import { getAuth, signInWithEmailAndPassword, createUserWithEmailAndPassword, onAuthStateChanged, signOut } from 'https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js';
        import { getFirestore, collection, onSnapshot, addDoc, updateDoc, deleteDoc, doc, query, orderBy, getDoc, setDoc } from 'https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js';

        const firebaseConfig = {
            apiKey: "AIzaSyATk8l02r44KE2c_PPytEg1Zv43rZZRcN8",
            authDomain: "store-hunq.firebaseapp.com",
            databaseURL: "https://store-hunq-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "store-hunq",
            storageBucket: "store-hunq.firebasestorage.app",
            messagingSenderId: "879933378644",
            appId: "1:879933378644:web:41911950a1872b31df1dc1",
            measurementId: "G-D8TNFCSHQD"
        };
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';

        // --- AUTH LOGIC ---
        const loginScreen = document.getElementById('login-screen');
        const dashboard = document.getElementById('dashboard');
        const loginError = document.getElementById('login-error');
        
        // Auto check login with Admin verification
        onAuthStateChanged(auth, async (user) => {
            if (user) {
                // Kiểm tra xem user có trong collection 'users' và có role admin không
                const userRef = doc(db, 'artifacts', appId, 'public', 'data', 'users', user.uid);
                try {
                    const userSnap = await getDoc(userRef);
                    if (userSnap.exists() && userSnap.data().role === 'admin') {
                        loginScreen.classList.add('hidden');
                        dashboard.classList.remove('hidden');
                        initData();
                    } else {
                        // Không phải admin hoặc không tồn tại trong db
                        await signOut(auth);
                        loginError.textContent = "Tài khoản không có quyền Admin!";
                        loginError.classList.remove('hidden');
                        loginScreen.classList.remove('hidden');
                        dashboard.classList.add('hidden');
                    }
                } catch (error) {
                    console.error("Check admin error:", error);
                    loginScreen.classList.remove('hidden');
                }
            } else {
                loginScreen.classList.remove('hidden');
                dashboard.classList.add('hidden');
            }
        });

        // Login Handler
        document.getElementById('login-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const email = document.getElementById('email').value;
            const pass = document.getElementById('password').value;
            try {
                await signInWithEmailAndPassword(auth, email, pass);
            } catch (error) {
                loginError.classList.remove('hidden');
                loginError.textContent = error.message;
            }
        });

        window.toggleRegister = async () => {
            const email = prompt("Nhập Email đăng ký Admin:");
            const pass = prompt("Nhập Mật khẩu:");
            if(email && pass) {
                try {
                    const userCredential = await createUserWithEmailAndPassword(auth, email, pass);
                    const user = userCredential.user;
                    
                    // Tạo thông tin admin trong Firestore tại /users/
                    await setDoc(doc(db, 'artifacts', appId, 'public', 'data', 'users', user.uid), {
                        email: email,
                        role: 'admin',
                        createdAt: new Date().toISOString()
                    });

                    alert("Đăng ký thành công! Đã tự động đăng nhập.");
                } catch(e) { alert("Lỗi: " + e.message); }
            }
        };

        window.logout = () => signOut(auth);

        // --- DASHBOARD LOGIC ---
        window.switchTab = (tab) => {
            document.getElementById('view-products').classList.toggle('hidden', tab !== 'products');
            document.getElementById('view-orders').classList.toggle('hidden', tab !== 'orders');
            
            // UI Active State
            document.getElementById('tab-products').classList.toggle('bg-blue-50', tab === 'products');
            document.getElementById('tab-products').classList.toggle('text-blue-600', tab === 'products');
            document.getElementById('tab-orders').classList.toggle('bg-blue-50', tab === 'orders');
            document.getElementById('tab-orders').classList.toggle('text-blue-600', tab === 'orders');
        };

        function initData() {
            // 1. Fetch Products
            const prodRef = collection(db, 'artifacts', appId, 'public', 'data', 'products');
            onSnapshot(prodRef, (snap) => {
                const list = document.getElementById('product-list');
                list.innerHTML = '';
                snap.forEach(docSnap => {
                    const p = { id: docSnap.id, ...docSnap.data() };
                    list.innerHTML += `
                        <tr class="hover:bg-gray-50 border-b border-gray-100 last:border-0 group">
                            <td class="px-6 py-4 font-medium text-gray-900">${p.name}</td>
                            <td class="px-6 py-4 text-gray-500">${p.category}</td>
                            <td class="px-6 py-4 text-center"><span class="bg-red-100 text-red-600 px-2 py-1 rounded text-xs font-bold">-${p.sale}%</span></td>
                            <td class="px-6 py-4 text-right">
                                <button onclick='editProduct(${JSON.stringify(p).replace(/'/g, "&#39;")})' class="text-blue-600 hover:bg-blue-100 p-2 rounded mr-1"><i class="fa-solid fa-pen"></i></button>
                                <button onclick="deleteItem('products', '${p.id}')" class="text-red-600 hover:bg-red-100 p-2 rounded"><i class="fa-solid fa-trash"></i></button>
                            </td>
                        </tr>
                    `;
                });
            });

            // 2. Fetch Orders
            const orderRef = collection(db, 'artifacts', appId, 'public', 'data', 'orders');
            // Note: Firestore limitation in simple mode, no complex orderBy without index. Using client sort.
            onSnapshot(orderRef, (snap) => {
                const list = document.getElementById('order-list');
                list.innerHTML = '';
                const orders = snap.docs.map(d => ({id: d.id, ...d.data()})).sort((a,b) => b.code?.localeCompare(a.code)); // Sort by Code Desc
                
                orders.forEach(o => {
                    const statusColor = o.status === 'Done' ? 'bg-green-100 text-green-600' : 'bg-yellow-100 text-yellow-600';
                    list.innerHTML += `
                        <div class="bg-white p-4 rounded-xl border border-gray-200 shadow-sm flex flex-col md:flex-row justify-between items-start md:items-center gap-4">
                            <div>
                                <div class="flex items-center gap-2 mb-1">
                                    <span class="font-bold text-lg text-blue-600">#${o.code}</span>
                                    <span class="${statusColor} px-2 py-0.5 rounded text-xs font-bold uppercase">${o.status}</span>
                                </div>
                                <div class="text-sm text-gray-600"><b>${o.contact}</b> mua <b>${o.productName}</b> (${o.type})</div>
                                <div class="text-xs text-gray-400 mt-1">Ngày: ${o.date} | Exp: ${o.expDate}</div>
                                <div class="text-xs text-gray-500 mt-1 italic">Note: ${o.note}</div>
                            </div>
                            <div class="flex items-center gap-4 w-full md:w-auto justify-between">
                                <span class="font-bold text-lg">${parseInt(o.amount).toLocaleString()}đ</span>
                                <div class="flex gap-2">
                                    <button onclick='editOrder(${JSON.stringify(o).replace(/'/g, "&#39;")})' class="bg-gray-100 hover:bg-gray-200 text-gray-600 px-3 py-2 rounded-lg"><i class="fa-solid fa-pen-to-square"></i></button>
                                    <button onclick="deleteItem('orders', '${o.id}')" class="bg-red-50 hover:bg-red-100 text-red-500 px-3 py-2 rounded-lg"><i class="fa-solid fa-trash"></i></button>
                                </div>
                            </div>
                        </div>
                    `;
                });
            });
        }

        // --- CRUD ACTIONS ---
        const pModal = document.getElementById('product-modal');
        const pForm = document.getElementById('product-form');

        window.openProductModal = () => {
            pForm.reset();
            document.getElementById('p-id').value = '';
            document.getElementById('modal-title').textContent = 'Thêm sản phẩm mới';
            pModal.classList.remove('hidden');
        };

        window.closeModal = () => pModal.classList.add('hidden');

        window.editProduct = (p) => {
            document.getElementById('p-id').value = p.id;
            document.getElementById('p-name').value = p.name;
            document.getElementById('p-category').value = p.category;
            document.getElementById('p-desc').value = p.desc;
            document.getElementById('p-types').value = Array.isArray(p.types) ? p.types.join(',') : p.types;
            document.getElementById('p-prices').value = Array.isArray(p.prices) ? p.prices.join(',') : p.prices;
            document.getElementById('p-sale').value = p.sale;
            document.getElementById('modal-title').textContent = 'Sửa sản phẩm';
            pModal.classList.remove('hidden');
        };

        pForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const id = document.getElementById('p-id').value;
            const data = {
                name: document.getElementById('p-name').value,
                category: document.getElementById('p-category').value,
                desc: document.getElementById('p-desc').value,
                types: document.getElementById('p-types').value.split(',').map(s => s.trim()),
                prices: document.getElementById('p-prices').value.split(',').map(s => s.trim()),
                sale: document.getElementById('p-sale').value,
                warranty: "Có"
            };

            try {
                if(id) await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'products', id), data);
                else await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'products'), data);
                closeModal();
            } catch(err) { alert("Lỗi lưu: " + err.message); }
        });

        // Delete Generic
        window.deleteItem = async (col, id) => {
            if(confirm("Bạn chắc chắn muốn xóa?")) {
                await deleteDoc(doc(db, 'artifacts', appId, 'public', 'data', col, id));
            }
        };

        // Edit Order
        const oModal = document.getElementById('order-modal');
        const oForm = document.getElementById('order-form');
        
        window.editOrder = (o) => {
            document.getElementById('o-id').value = o.id;
            document.getElementById('o-note').value = o.note || '';
            document.getElementById('o-exp').value = o.expDate || '';
            document.getElementById('o-status').value = o.status || 'New';
            oModal.classList.remove('hidden');
        };

        oForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const id = document.getElementById('o-id').value;
            await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'orders', id), {
                note: document.getElementById('o-note').value,
                expDate: document.getElementById('o-exp').value,
                status: document.getElementById('o-status').value
            });
            oModal.classList.add('hidden');
        });

    </script>
</body>
</html>