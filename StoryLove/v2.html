
<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Love Story - Kỷ niệm tình yêu</title>
    <link href="https://fonts.googleapis.com/css2?family=Quicksand:wght@300..700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <style>
        /* General Body and Font Styling */
        body {
            font-family: 'Quicksand', sans-serif;
            background-color: #fde4e4; /* Soft pink background */
            color: #1f2937; /* text-gray-800 */
            margin: 0;
        }

        /* Basic Elements */
        * {
            box-sizing: border-box;
        }

        button, input, select {
            font-family: inherit;
        }

        a {
            color: #ec4899; /* pink-500 */
            text-decoration: none;
        }
        a:hover {
            text-decoration: underline;
        }

        /* Main Container */
        .container {
            width: 100%;
            margin-left: auto;
            margin-right: auto;
            padding-left: 1rem;
            padding-right: 1rem;
        }

        /* --- UTILITY CLASSES REPLACEMENTS --- */
        .hidden { display: none !important; }

        /* --- LOADING OVERLAY --- */
        #loading-overlay {
            position: fixed;
            top: 0; right: 0; bottom: 0; left: 0;
            background-color: rgba(255, 255, 255, 0.8);
            z-index: 50;
            display: flex;
            align-items: center;
            justify-content: center;
            text-align: center;
        }
        #loading-overlay .fa-heart {
            color: #ec4899;
            font-size: 3.75rem; /* text-6xl */
        }
        #loading-text {
            margin-top: 1rem;
            color: #ec4899;
            font-weight: 600;
        }

        /* --- AUTH, COUPLE CODE, PROFILE SCREENS --- */
        .auth-screen-container {
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 1rem;
        }
        .auth-card {
            width: 100%;
            max-width: 28rem; /* max-w-md */
            background-color: #ffffff;
            border-radius: 1rem; /* rounded-2xl */
            box-shadow: 0 10px 15px -3px rgba(0,0,0,0.1), 0 4px 6px -2px rgba(0,0,0,0.05);
            padding: 2rem;
        }
        .auth-card h2 {
            font-size: 1.875rem; /* text-3xl */
            font-weight: 700;
            text-align: center;
            color: #ec4899;
            margin-bottom: 1.5rem;
        }
        .auth-card .error-message {
            color: #ef4444; /* red-500 */
            font-size: 0.875rem; /* text-sm */
            margin-bottom: 1rem;
        }
        .auth-card input, .auth-card select {
            width: 100%;
            padding: 0.75rem 1rem; /* px-4 py-3 */
            margin-bottom: 1rem;
            border: 1px solid #d1d5db; /* border-gray-300 */
            border-radius: 0.5rem; /* rounded-lg */
        }
        .auth-card input:focus, .auth-card select:focus {
            outline: none;
            box-shadow: 0 0 0 2px #f9a8d4; /* ring-2 ring-pink-400 */
        }
        .auth-card .auth-button {
            width: 100%;
            background-color: #ec4899;
            color: #ffffff;
            padding: 0.75rem 0;
            border-radius: 0.5rem;
            font-weight: 600;
            border: none;
            cursor: pointer;
            transition: background-color 0.2s;
        }
        .auth-card .auth-button:hover {
            background-color: #db2777; /* hover:bg-pink-600 */
        }
        .auth-card .form-switch-text {
            text-align: center;
            margin-top: 1rem;
        }
        #couple-code-screen .auth-card { text-align: center; }
        #couple-code-screen p { margin-bottom: 1.5rem; color: #4b5563; }
        #couple-code-input { text-align: center; }
        #join-couple-btn { margin-bottom: 0.5rem; }
        #create-custom-couple-btn {
            background-color: #22c55e; /* green-500 */
        }
        #create-custom-couple-btn:hover {
            background-color: #16a34a; /* hover:bg-green-600 */
        }

        /* --- MAIN APP --- */
        #main-app header {
            background-color: rgba(255, 255, 255, 0.8);
            backdrop-filter: blur(4px);
            box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1), 0 2px 4px -1px rgba(0,0,0,0.06);
            position: sticky;
            top: 0;
            z-index: 30;
        }
        #main-app header .container {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding-top: 0.5rem;
            padding-bottom: 0.5rem;
        }
        #main-app header h1 {
            font-size: 1.5rem; /* text-2xl */
            font-weight: 700;
            color: #ec4899;
        }
        #logout-btn {
            color: #6b7280; /* text-gray-500 */
            background: none;
            border: none;
            cursor: pointer;
            font-size: 1.25rem; /* text-xl */
        }
        #logout-btn:hover { color: #ec4899; }
        
        main { padding: 1rem; }
        
        /* Tab Navigation */
        nav {
            background-color: #ffffff;
            border-radius: 0.75rem; /* rounded-xl */
            box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1), 0 2px 4px -1px rgba(0,0,0,0.06);
            padding: 0.5rem;
            margin-bottom: 1.5rem;
            display: flex;
            justify-content: space-around;
            align-items: center;
            font-size: 0.875rem; /* text-sm */
        }
        .nav-link {
            cursor: pointer;
            transition: all 0.3s ease;
            border-bottom: 2px solid transparent;
            padding: 0.5rem 1rem;
        }
        .nav-link i { margin-right: 0.5rem; }
        .nav-link.active {
            color: #ec4899;
            border-bottom-color: #ec4899;
        }
        .tab-content { display: none; }
        .tab-content.active { display: block; }
        
        /* Main Tab Content */
        .card {
            background-color: #ffffff;
            border-radius: 1rem; /* rounded-2xl */
            box-shadow: 0 10px 15px -3px rgba(0,0,0,0.1), 0 4px 6px -2px rgba(0,0,0,0.05);
            padding: 1.5rem;
            margin-bottom: 1.5rem;
        }
        .day-counter-card { text-align: center; }
        .day-counter-card h2 {
            font-size: 1.5rem; /* text-2xl */
            font-weight: 600;
            color: #ec4899;
            margin-bottom: 0.5rem;
        }
        #day-counter {
            font-size: 3rem; /* text-5xl */
            font-weight: 700;
            margin: 1rem 0;
        }
        #ymd-counter { font-size: 1.125rem; color: #4b5563; }
        #start-date-display { color: #6b7280; font-size: 0.875rem; margin-top: 1rem; }
        
        .partner-cards-grid {
            display: grid;
            grid-template-columns: 1fr;
            gap: 1.5rem;
        }
        .partner-card {
            display: flex;
            flex-direction: column;
            align-items: center;
            position: relative;
        }
        .partner-card .feeling-bubble {
            margin-bottom: 0.75rem;
            background-color: #fce7f3; /* pink-100 */
            color: #be185d; /* pink-700 */
            padding: 0.25rem 0.75rem;
            border-radius: 9999px;
            font-size: 0.875rem;
            font-style: italic;
        }
        .partner-card img {
            width: 8rem; /* w-32 */
            height: 8rem; /* h-32 */
            border-radius: 9999px;
            object-fit: cover;
            margin-bottom: 1rem;
            border: 4px solid #f9a8d4; /* border-pink-300 */
        }
        .partner-card h3 { font-size: 1.5rem; font-weight: 700; }
        .partner-card p { color: #4b5563; }
        .partner-card p i { margin-right: 0.5rem; }
        .partner-card .gender-icon {
            margin-top: 0.5rem;
            font-size: 1.5rem;
        }
        .partner-card .gender-icon .fa-mars { color: #3b82f6; /* blue-500 */ }
        .partner-card .gender-icon .fa-venus { color: #ec4899; /* pink-500 */ }
        .edit-feeling-btn {
            position: absolute;
            top: 1rem;
            right: 1rem;
            color: #9ca3af; /* text-gray-400 */
            background: none; border: none; cursor: pointer;
        }
        .edit-feeling-btn:hover { color: #ec4899; }

        /* Story Tab */
        .story-controls { text-align: right; margin-bottom: 1rem; }
        .story-controls .btn-pink {
             background-color: #ec4899; color: #fff;
             padding: 0.5rem 1.5rem; border-radius: 0.5rem;
             font-weight: 600; border:none; cursor: pointer;
        }
        .story-controls .btn-pink:hover { background-color: #db2777; }
        
        .story-feed, .settings-content, .filter-container {
            max-width: 42rem; /* max-w-2xl */
            margin-left: auto;
            margin-right: auto;
        }
        .story-feed { display: flex; flex-direction: column; gap: 1.5rem; }
        .story-card {
            background-color: #fff;
            border-radius: 0.75rem; /* rounded-xl */
            box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1), 0 2px 4px -1px rgba(0,0,0,0.06);
            overflow: hidden;
        }
        .story-card .content { padding: 1.25rem; }
        .story-card .author { display: flex; align-items: center; margin-bottom: 0.75rem; }
        .story-card .author img {
            width: 3rem; height: 3rem; border-radius: 9999px;
            margin-right: 1rem; object-fit: cover;
        }
        .story-card .author .author-name { font-weight: 700; color: #ec4899; }
        .story-card .author .timestamp { font-size: 0.75rem; color: #9ca3af; }
        .story-card .title { font-weight: 700; font-size: 1.25rem; margin-bottom: 0.5rem; color: #1f2937; }
        .story-card .text-content { color: #374151; white-space: pre-wrap; margin-bottom: 1rem; }
        .story-card .meta { display: flex; justify-content: space-between; align-items: center; font-size: 0.875rem; color: #6b7280; }
        .story-card .location i { margin-right: 0.25rem; }
        .story-card .tags { display: flex; flex-wrap: wrap; gap: 0.5rem; }
        .story-card .tag { background-color: #e5e7eb; color: #374151; padding: 0.25rem 0.5rem; border-radius: 9999px; font-size: 0.75rem; }
        
        .story-card .actions {
            background-color: #f9fafb; /* bg-gray-50 */
            padding: 0.75rem 1.25rem;
            border-top: 1px solid #e5e7eb;
        }
        .story-card .action-buttons {
            display: flex; align-items: center; gap: 1.5rem; /* space-x-6 */
            color: #4b5563; margin-bottom: 0.5rem;
        }
        .story-card .action-buttons button {
            background: none; border: none; cursor: pointer;
            font-size: 1.125rem; /* text-lg */
            color: inherit;
        }
        .story-card .like-btn.liked, .comment-like-btn.liked { color: #ec4899; }
        .story-card .like-display { font-size: 0.875rem; color: #4b5563; }
        .story-card .like-count { font-weight: 600; }
        .story-card .liker-names-display { color: #6b7280; margin-left: 0.25rem; }
        .story-card .comment-input-area-toplevel { margin-top: 0.75rem; }
        .story-card .comment-input-area-toplevel .comment-input-container { display: flex; align-items: center; gap: 0.5rem; }
        .story-card .comment-input-area-toplevel img { width: 2rem; height: 2rem; border-radius: 9999px; object-fit: cover; }
        .story-card .comment-input-toplevel {
            width: 100%; padding: 0.5rem; border: 1px solid #d1d5db;
            border-radius: 9999px; font-size: 0.875rem;
        }
        .comment-section {
            background-color: #f3f4f6; /* bg-gray-100 */
            margin-top: 0.75rem;
            margin-left: -1.25rem; margin-right: -1.25rem;
            padding: 1rem 1.25rem;
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.5s ease-in-out;
        }
        .comment-section.active { max-height: 1000px; }

        /* Filter Controls */
        .filter-container { background-color: #fff; border-radius: 0.75rem; box-shadow: 0 1px 3px 0 rgba(0,0,0,.1), 0 1px 2px -1px rgba(0,0,0,.1); padding: 1rem; margin-bottom: 1.5rem; }
        #toggle-filters-btn { width: 100%; text-align: left; font-weight: 600; color: #374151; margin-bottom: 0.5rem; background: none; border: none; cursor: pointer; }
        #toggle-filters-btn i:first-child { margin-right: 0.5rem; }
        #toggle-filters-btn i:last-child { float: right; transition: transform 0.3s; }
        #toggle-filters-btn i:last-child.rotate-180 { transform: rotate(180deg); }
        #filter-controls { max-height: 0; overflow: hidden; transition: max-height 0.5s ease-in-out; }
        #filter-controls.active { max-height: 1000px; }
        .filter-grid { display: grid; grid-template-columns: 1fr; gap: 1rem; align-items: end; padding-top: 1rem; border-top: 1px solid #d1d5db; }
        .filter-grid label { font-size: 0.875rem; font-weight: 500; color: #374151; display: block; margin-bottom: 0.25rem; }
        .filter-grid input, .filter-grid select { width: 100%; padding: 0.5rem; border: 1px solid #d1d5db; border-radius: 0.5rem; font-size: 0.875rem; }
        #reset-filters-btn { margin-top: 1rem; width: 100%; font-size: 0.875rem; color: #2563eb; background: none; border: none; cursor: pointer; text-align: left; }
        #reset-filters-btn:hover { text-decoration: underline; }

        /* Comments in Story */
        .comment-item { margin-top: 0.75rem; }
        .comment-item-container { display: flex; align-items: flex-start; gap: 0.5rem; }
        .comment-item-container img { width: 2rem; height: 2rem; border-radius: 9999px; object-fit: cover; }
        .comment-bubble { background-color: #fff; padding: 0.5rem; border-radius: 0.5rem; flex: 1; }
        .comment-bubble .author-name { font-weight: 600; font-size: 0.875rem; }
        .comment-bubble .comment-content { font-size: 0.875rem; }
        .comment-bubble .edit-comment-area input { width: 100%; padding: 0.25rem; border: 1px solid #d1d5db; border-radius: 0.25rem; font-size: 0.875rem; }
        .comment-bubble .edit-comment-area button { font-size: 0.75rem; background: none; border: none; cursor: pointer; }
        .comment-bubble .edit-comment-area .save-edit-btn { color: #2563eb; }
        .comment-bubble .edit-comment-area .cancel-edit-btn { color: #6b7280; }

        .comment-actions { margin-left: 2.5rem; /* ml-10 */ font-size: 0.75rem; margin-top: 0.25rem; display: flex; align-items: center; gap: 0.75rem; }
        .comment-actions button { font-weight: 600; color: #4b5563; background: none; border: none; cursor: pointer; }
        .comment-actions .delete-comment-btn { color: #ef4444; }
        .comment-actions .comment-like-btn { color: #4b5563; }

        .replies { margin-left: 2.5rem; margin-top: 0.5rem; border-left: 2px solid #e5e7eb; padding-left: 0.75rem; }
        .reply-input-container { margin-left: 2.5rem; margin-top: 0.5rem; }
        .reply-input-container input { width: 100%; padding: 0.5rem; border: 1px solid #d1d5db; border-radius: 0.5rem; font-size: 0.875rem; }
        .reply-input-container button { margin-top: 0.5rem; background-color: #3b82f6; color: #fff; padding: 0.25rem 1rem; font-size: 0.875rem; border-radius: 0.5rem; border: none; cursor: pointer; }

        /* Events Tab */
        .event-controls { text-align: right; margin-bottom: 1rem; }
        .event-controls .btn-blue {
            background-color: #3b82f6; color: #fff;
             padding: 0.5rem 1.5rem; border-radius: 0.5rem;
             font-weight: 600; border:none; cursor: pointer;
        }
        .event-controls .btn-blue:hover { background-color: #2563eb; }
        #event-list { display: flex; flex-direction: column; gap: 1rem; }
        .event-card {
            background-color: #fff; border-radius: 0.75rem;
            box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1), 0 2px 4px -1px rgba(0,0,0,0.06);
            padding: 1rem; display: flex; align-items: center; gap: 1rem;
        }
        .event-card img { width: 5rem; height: 5rem; border-radius: 0.5rem; object-fit: cover; }
        .event-card .details { flex-grow: 1; }
        .event-card .details h4 { font-weight: 700; font-size: 1.125rem; color: #2563eb; }
        .event-card .details p { font-size: 0.875rem; color: #6b7280; }
        .event-card .countdown { text-align: center; }
        .event-card .countdown .days { font-size: 1.875rem; font-weight: 700; color: #3b82f6; }
        .event-card .countdown .label { font-size: 0.875rem; color: #4b5563; }

        /* Settings Tab */
        .settings-content h2, .settings-content h3 {
            font-weight: 700;
            color: #ec4899;
            margin-bottom: 1.5rem;
            border-bottom: 1px solid #d1d5db;
            padding-bottom: 1rem;
        }
        .settings-content h2 { font-size: 1.5rem; }
        .settings-content h3 { font-size: 1.25rem; margin-top: 2rem; }
        
        .settings-group { margin-bottom: 1.5rem; }
        .settings-group label, .settings-partner-group h4, .partner-setting-item label {
            display: block;
            font-weight: 600;
            margin-bottom: 0.5rem;
        }
        .settings-group .input-group { display: flex; align-items: center; }
        .settings-group input[readonly] { background-color: #f3f4f6; }
        .settings-group input, .settings-group select { width: 100%; padding: 0.5rem 1rem; border: 1px solid #d1d5db; border-radius: 0.5rem; }
        .settings-group button {
            margin-left: 0.5rem; padding: 0.5rem 1rem; background-color: #e5e7eb;
            border-radius: 0.5rem; border: none; cursor: pointer;
        }
        .settings-group button:hover { background-color: #d1d5db; }
        
        #change-code-note { font-size: 0.875rem; color: #6b7280; margin-bottom: 0.5rem; }
        #change-code-group { display: flex; align-items: center; gap: 0.5rem; }
        #change-code-group input { flex-grow: 1; }
        #change-code-btn { flex-shrink: 0; background-color: #3b82f6; color: #fff; }
        #change-code-btn:hover { background-color: #2563eb; }
        
        .settings-partner-group { margin-top: 1.5rem; }
        .settings-partner-group h4 { font-size: 1.125rem; margin-bottom: 0.5rem; }
        .partner-setting-item { margin-bottom: 0.75rem; }
        .partner-setting-item label { font-size: 0.875rem; font-weight: 500; }
        
        #save-settings-btn {
            width: 100%; margin-top: 2rem; background-color: #ec4899; color: #fff;
            padding: 0.75rem 0; border-radius: 0.5rem; font-weight: 600;
            border: none; cursor: pointer;
        }
        #save-settings-btn:hover { background-color: #db2777; }
        
        /* Modals */
        .modal-backdrop {
            position: fixed; top: 0; left: 0; right: 0; bottom: 0;
            z-index: 40;
            display: flex;
            align-items: center;
            justify-content: center;
            background-color: rgba(0,0,0,0.5);
            padding: 1rem;
        }
        .modal-content {
            background-color: #fff;
            border-radius: 1rem; /* rounded-2xl */
            box-shadow: 0 10px 15px -3px rgba(0,0,0,0.1), 0 4px 6px -2px rgba(0,0,0,0.05);
            padding: 1.5rem;
            width: 100%;
            max-width: 32rem; /* max-w-lg */
        }
        .modal-content h2 {
            font-size: 1.5rem; font-weight: 700; margin-bottom: 1rem;
        }
        #story-modal h2, #feeling-modal h2 { color: #ec4899; }
        #event-modal h2 { color: #3b82f6; }
        .modal-content input, .modal-content textarea, .modal-content select {
            width: 100%;
            padding: 0.5rem 1rem;
            margin-bottom: 0.75rem;
            border: 1px solid #d1d5db;
            border-radius: 0.5rem;
        }
        .modal-content textarea {
            resize: vertical;
        }
        .modal-footer {
            display: flex;
            justify-content: flex-end;
            margin-top: 1rem;
            gap: 1rem;
        }
        .modal-footer .btn {
            padding: 0.5rem 1.5rem;
            border-radius: 0.5rem;
            border: none; cursor: pointer;
        }
        .modal-footer .btn-gray { background-color: #d1d5db; }
        .modal-footer .btn-gray:hover { background-color: #9ca3af; }
        .modal-footer .btn-pink { background-color: #ec4899; color: #fff; }
        .modal-footer .btn-pink:hover { background-color: #db2777; }
        .modal-footer .btn-blue { background-color: #3b82f6; color: #fff; }
        .modal-footer .btn-blue:hover { background-color: #2563eb; }
        
        #confirm-modal .modal-content { max-width: 24rem; text-align: center; }
        #confirm-modal p { font-size: 1.125rem; margin-bottom: 1.5rem; }
        #confirm-modal .modal-footer { justify-content: center; }
        #confirm-ok-btn { background-color: #ef4444; color: #fff; }
        #confirm-ok-btn:hover { background-color: #dc2626; }
        
        /* Heartbeat Animation */
        .heart-beat {
            animation: heartBeat 1.5s infinite;
        }
        @keyframes heartBeat {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.15); }
        }

        /* Chat FAB & Popup */
        #chat-fab {
            position: fixed;
            bottom: 1.5rem;
            right: 1.5rem;
            width: 4rem; height: 4rem;
            background-color: #ec4899;
            border-radius: 9999px;
            color: #fff;
            font-size: 1.875rem;
            box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1), 0 2px 4px -1px rgba(0,0,0,0.06);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 40;
            border: none;
            cursor: pointer;
            transition: transform 0.3s ease;
        }
        #chat-fab:hover { transform: scale(1.1); }
        
        #chat-popup {
            position: fixed;
            bottom: 6rem; /* bottom-24 */
            right: 1.5rem;
            width: 90vw;
            max-width: 24rem; /* max-w-sm */
            height: 60vh;
            background-color: #fff;
            border-radius: 1rem;
            box-shadow: 0 10px 15px -3px rgba(0,0,0,0.1), 0 4px 6px -2px rgba(0,0,0,0.05);
            display: flex;
            flex-direction: column;
            z-index: 40;
            transition: transform 0.3s ease-out, opacity 0.3s ease-out;
            transform: scale(0.5) translateY(20px);
            opacity: 0;
            pointer-events: none;
        }
        #chat-popup.active {
            transform: scale(1) translateY(0);
            opacity: 1;
            pointer-events: auto;
        }
        #chat-header {
            padding: 1rem;
            border-bottom: 1px solid #e5e7eb;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-top-left-radius: 1rem;
            border-top-right-radius: 1rem;
            background-color: #fff;
            transition: background-color 0.3s;
        }
        #toggle-chat-mode-btn {
            font-size: 0.875rem;
            font-weight: 600;
            padding: 0.25rem 0.75rem;
            border-radius: 9999px;
            transition: all 0.3s;
            border: none;
            cursor: pointer;
        }
        #close-chat-btn {
            color: #9ca3af;
            background: none; border: none; cursor: pointer;
        }
        #close-chat-btn:hover { color: #374151; }
        #chat-messages {
            flex: 1;
            padding: 1rem;
            overflow-y: auto;
            display: flex;
            flex-direction: column-reverse;
        }
        .message-container { display: flex; align-items: flex-end; gap: 0.5rem; margin-bottom: 0.75rem; }
        .message-container.justify-end { justify-content: flex-end; }
        .message-container.justify-start { justify-content: flex-start; }
        .message-content { max-width: 18rem; }
        .message-bubble { border-radius: 1rem; padding: 0.5rem 1rem; }
        .message-bubble.sent { background-color: #ec4899; color: #fff; }
        .message-bubble.received { background-color: #e5e7eb; color: #1f2937; }
        .message-timestamp { font-size: 0.75rem; color: #9ca3af; margin-top: 0.25rem; padding: 0 0.5rem; }
        .message-timestamp.text-right { text-align: right; }
        .message-timestamp.text-left { text-align: left; }

        .delete-msg-btn {
            opacity: 0; transition: opacity 0.2s;
            background: none; border: none; cursor: pointer;
            color: #9ca3af; margin-bottom: 0.25rem;
        }
        .message-container:hover .delete-msg-btn { opacity: 1; }
        .delete-msg-btn:hover { color: #ef4444; }

        #chat-input-area {
            padding: 1rem; border-top: 1px solid #e5e7eb;
        }
        #chat-input-container { display: flex; align-items: center; gap: 0.5rem; }
        #chat-input {
            width: 100%;
            padding: 0.5rem 1rem;
            border: 1px solid #d1d5db;
            border-radius: 9999px;
        }
        #chat-input:focus { outline: none; box-shadow: 0 0 0 2px #f9a8d4; }
        #chat-send-btn {
            background-color: #ec4899; color: #fff;
            border-radius: 9999px;
            width: 2.5rem; height: 2.5rem;
            flex-shrink: 0;
            display: flex; align-items: center; justify-content: center;
            border: none; cursor: pointer;
        }
        #chat-send-btn:hover { background-color: #db2777; }
        
        /* Responsive Design */
        @media (min-width: 768px) { /* md: */
            nav { font-size: 1rem; }
            #day-counter { font-size: 4.5rem; }
            .partner-cards-grid { grid-template-columns: repeat(2, 1fr); }
            .filter-grid { grid-template-columns: repeat(2, 1fr); }
            .filter-grid .span-2 { grid-column: span 2 / span 2; }
            #reset-filters-btn { width: auto; }
        }
        @media (min-width: 1024px) { /* lg: */
            .filter-grid .lg-span-2 { grid-column: span 2 / span 2; }
        }

    </style>
</head>
<body>

    <div id="loading-overlay" class="hidden">
        <div>
            <i class="fas fa-heart heart-beat"></i>
            <p id="loading-text">Đang xử lý...</p>
        </div>
    </div>

    <div id="auth-screen" class="auth-screen-container">
        <div class="auth-card">
            <div id="auth-container">
                <div id="login-form">
                    <h2>Đăng Nhập</h2>
                    <div id="login-error" class="error-message"></div>
                    <input id="login-email" type="email" placeholder="Email">
                    <input id="login-password" type="password" placeholder="Mật khẩu">
                    <button id="login-btn" class="auth-button">Đăng Nhập</button>
                    <p class="form-switch-text">Chưa có tài khoản? <a href="#" id="show-register">Đăng ký ngay</a></p>
                </div>
                <div id="register-form" class="hidden">
                    <h2>Đăng Ký</h2>
                    <div id="register-error" class="error-message"></div>
                    <input id="register-email" type="email" placeholder="Email">
                    <input id="register-password" type="password" placeholder="Mật khẩu">
                    <input id="register-invite-code" type="text" placeholder="Mã mời">
                    <button id="register-btn" class="auth-button">Đăng Ký</button>
                    <p class="form-switch-text">Đã có tài khoản? <a href="#" id="show-login">Đăng nhập</a></p>
                </div>
            </div>
        </div>
    </div>

    <div id="couple-code-screen" class="hidden auth-screen-container">
        <div class="auth-card">
            <h2>Mã Cặp Đôi</h2>
            <p>Nhập mã để tham gia, hoặc nhập mã riêng của bạn để tạo mới.</p>
            <div id="couple-code-error" class="error-message"></div>
            <input id="couple-code-input" type="text" placeholder="Nhập mã cặp đôi...">
            <button id="join-couple-btn" class="auth-button">Tham Gia</button>
            <p class="form-switch-text">hoặc</p>
            <button id="create-custom-couple-btn" class="auth-button">Tạo Cặp Đôi với Mã Này</button>
        </div>
    </div>

    <div id="profile-setup-screen" class="hidden auth-screen-container">
        <div class="auth-card">
            <h2>Thiết Lập Thông Tin</h2>
            <div id="profile-setup-error" class="error-message"></div>
            <input id="profile-name" type="text" placeholder="Tên của bạn">
            <input id="profile-dob" type="text" onfocus="(this.type='date')" onblur="(this.type='text')" placeholder="Ngày sinh">
            <select id="profile-gender">
                <option value="" disabled selected>Chọn giới tính</option>
                <option value="male">Nam</option>
                <option value="female">Nữ</option>
            </select>
            <button id="save-profile-btn" class="auth-button">Lưu Thông Tin</button>
        </div>
    </div>

    <div id="main-app" class="hidden">
        <header>
            <div class="container">
                <h1>Love Story</h1>
                <button id="logout-btn"><i class="fas fa-sign-out-alt"></i></button>
            </div>
        </header>

        <main>
            <nav>
                <a class="nav-link active" data-tab="main"><i class="fas fa-heart"></i>Trang Chính</a>
                <a class="nav-link" data-tab="story"><i class="fas fa-book-open"></i>Story</a>
                <a class="nav-link" data-tab="events"><i class="fas fa-calendar-alt"></i>Sự Kiện</a>
                <a class="nav-link" data-tab="settings"><i class="fas fa-cog"></i>Cài Đặt</a>
            </nav>

            <div id="main-content" class="tab-content active">
                <div class="card day-counter-card">
                    <h2>Chúng ta đã bên nhau</h2>
                    <div id="day-counter">...</div>
                    <div id="ymd-counter">... năm ... tháng ... ngày</div>
                    <div id="start-date-display">Ngày bắt đầu: <span>...</span></div>
                </div>
                <div class="partner-cards-grid">
                    <div id="partner-1-card" class="card partner-card"></div>
                    <div id="partner-2-card" class="card partner-card"></div>
                </div>
            </div>

            <div id="story-content" class="tab-content">
                <div class="story-controls">
                    <button id="add-story-btn" class="btn-pink"><i class="fas fa-plus"></i> Viết Story Mới</button>
                </div>
                <div class="filter-container">
                    <button id="toggle-filters-btn">
                        <i class="fas fa-filter"></i> Mở bộ lọc <i class="fas fa-chevron-down"></i>
                    </button>
                    <div id="filter-controls">
                        <div class="filter-grid">
                            <div>
                                <label for="filter-author">Người đăng</label>
                                <select id="filter-author">
                                    <option value="all">Tất cả</option>
                                </select>
                            </div>
                            <div>
                                <label for="filter-date">Ngày đăng</label>
                                <input type="date" id="filter-date">
                            </div>
                            <div>
                                <label for="filter-location">Vị trí</label>
                                <input type="text" id="filter-location" placeholder="Tìm theo vị trí...">
                            </div>
                            <div>
                                <label for="filter-tag">Thẻ (Tag)</label>
                                <input type="text" id="filter-tag" placeholder="vd: #kiniem">
                            </div>
                            <div class="span-2 lg-span-2">
                                <label for="sort-stories">Sắp xếp</label>
                                <select id="sort-stories">
                                    <option value="desc">Mới nhất</option>
                                    <option value="asc">Cũ nhất</option>
                                </select>
                            </div>
                        </div>
                        <button id="reset-filters-btn">Xóa bộ lọc</button>
                    </div>
                </div>
                <div id="story-feed" class="story-feed">
                    </div>
            </div>

            <div id="events-content" class="tab-content">
                 <div class="event-controls">
                    <button id="add-event-btn" class="btn-blue"><i class="fas fa-plus"></i>Thêm Sự Kiện</button>
                </div>
                <div id="event-list">
                    </div>
            </div>

            <div id="settings-content" class="tab-content settings-content card">
                <h2>Cài Đặt Chung</h2>
                <div class="settings-group">
                    <label for="setting-couple-code">Mã Cặp Đôi của bạn:</label>
                    <div class="input-group">
                       <input id="setting-couple-code" type="text" readonly>
                       <button id="copy-code-btn"><i class="fas fa-copy"></i></button>
                    </div>
                </div>
                <div class="settings-group">
                    <label for="setting-start-date">Ngày bắt đầu yêu</label>
                    <input id="setting-start-date" type="date">
                </div>

                <h3>Đổi Mã Cặp Đôi</h3>
                <div class="settings-group">
                    <label for="setting-new-couple-code">Mã Cặp Đôi Mới</label>
                    <p id="change-code-note">Lưu ý: Hành động này sẽ thay đổi mã cho cả hai bạn. Mã cũ sẽ không còn hiệu lực.</p>
                    <div id="change-code-group">
                        <input id="setting-new-couple-code" type="text" placeholder="Nhập mã mới">
                        <button id="change-code-btn">Đổi Mã</button>
                    </div>
                    <div id="change-code-error" class="error-message"></div>
                </div>
                
                <h3>Thông Tin Cá Nhân</h3>
                <div id="settings-partner-1" class="settings-partner-group"></div>
                <div id="settings-partner-2" class="settings-partner-group"></div>

                <button id="save-settings-btn">Lưu Thay Đổi</button>
            </div>
        </main>
    </div>

    <button id="chat-fab" class="hidden">
        <i class="fas fa-heart"></i>
    </button>

    <div id="chat-popup">
        <div id="chat-header">
            <button id="toggle-chat-mode-btn">
                </button>
            <button id="close-chat-btn">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <div id="chat-messages">
            </div>
        <div id="chat-input-area">
            <div id="chat-input-container">
                <input id="chat-input" type="text" placeholder="Nhập tin nhắn...">
                <button id="chat-send-btn">
                    <i class="fas fa-paper-plane"></i>
                </button>
            </div>
        </div>
    </div>

    <div id="story-modal" class="hidden modal-backdrop">
        <div class="modal-content">
            <h2>Viết Story Mới</h2>
            <input id="story-title" type="text" placeholder="Tiêu đề">
            <textarea id="story-textarea" rows="6" placeholder="Bạn đang nghĩ gì..."></textarea>
            <input id="story-location" type="text" placeholder="Vị trí (ví dụ: Cafe The Lofi)">
            <input id="story-tags" type="text" placeholder="Gắn thẻ (ví dụ: #kiniem, #henho)">
            <div class="modal-footer">
                <button id="cancel-story-btn" class="btn btn-gray">Hủy</button>
                <button id="post-story-btn" class="btn btn-pink">Đăng</button>
            </div>
        </div>
    </div>
    <div id="feeling-modal" class="hidden modal-backdrop">
        <div class="modal-content">
            <h2>Cảm nhận của bạn</h2>
            <input id="feeling-input" type="text" placeholder="Hôm nay bạn thấy thế nào?">
            <div class="modal-footer">
                <button id="cancel-feeling-btn" class="btn btn-gray">Hủy</button>
                <button id="save-feeling-btn" class="btn btn-pink">Lưu</button>
            </div>
        </div>
    </div>
    <div id="event-modal" class="hidden modal-backdrop">
        <div class="modal-content">
            <h2>Thêm Sự Kiện Mới</h2>
            <input id="event-name" type="text" placeholder="Tên sự kiện">
            <input id="event-date" type="date">
            <input id="event-image-url" type="text" placeholder="URL hình ảnh (tùy chọn)">
            <select id="event-repeat">
                <option value="none">Không lặp lại</option>
                <option value="daily">Mỗi ngày</option>
                <option value="weekly">Mỗi tuần</option>
                <option value="monthly">Mỗi tháng</option>
                <option value="yearly">Mỗi năm</option>
                <option value="interval">Khoảng ngày</option>
            </select>
            <input id="event-interval-days" type="number" placeholder="Lặp lại sau bao nhiêu ngày?" class="hidden">
            <div class="modal-footer">
                <button id="cancel-event-btn" class="btn btn-gray">Hủy</button>
                <button id="save-event-btn" class="btn btn-blue">Lưu</button>
            </div>
        </div>
    </div>
    <div id="confirm-modal" class="hidden modal-backdrop">
        <div class="modal-content">
            <p id="confirm-message"></p>
            <div class="modal-footer">
                <button id="confirm-cancel-btn" class="btn btn-gray">Hủy</button>
                <button id="confirm-ok-btn" class="btn">OK</button>
            </div>
        </div>
    </div>


    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { 
            getAuth, 
            createUserWithEmailAndPassword, 
            signInWithEmailAndPassword, 
            onAuthStateChanged, 
            signOut 
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { 
            getFirestore, 
            doc, 
            getDoc, 
            setDoc, 
            updateDoc, 
            collection, 
            addDoc,
            query, 
            where,
            getDocs,
            onSnapshot,
            orderBy,
            Timestamp,
            writeBatch,
            deleteDoc,
            arrayUnion,
            arrayRemove
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Cấu hình Firebase của bạn
        const firebaseConfig = {
            apiKey: "AIzaSyAr9tTx-Q0OWrJ4Iaslb33-o1PJLe1S3GQ",
            authDomain: "lovstory-b6e07.firebaseapp.com",
            projectId: "lovstory-b6e07",
            storageBucket: "lovstory-b6e07.appspot.com",
            messagingSenderId: "810969018898",
            appId: "1:810969018898:web:c8e525581a77ed7d515ecb",
            measurementId: "G-1RP88QT28C"
        };

        // Khởi tạo Firebase
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // Biến toàn cục
        let currentUser = null;
        let userId = null;
        let coupleCode = null;
        let coupleData = null;
        let allStories = []; // Lưu trữ tất cả story để lọc
        let localLastMessageTimestamp = null;
        let unsubscribeCouple = null;
        let unsubscribeEvents = null;
        let unsubscribeNormalChat = null;
        let unsubscribeSecretChat = null;
        let storyCommentListeners = {};
        let currentChatMode = 'normal';
        let wasInSecretChat = false;

        // DOM Elements
        const loadingOverlay = document.getElementById('loading-overlay');
        const loadingText = document.getElementById('loading-text');
        const authScreen = document.getElementById('auth-screen');
        const coupleCodeScreen = document.getElementById('couple-code-screen');
        const profileSetupScreen = document.getElementById('profile-setup-screen');
        const mainApp = document.getElementById('main-app');
        const chatFab = document.getElementById('chat-fab');
        const chatPopup = document.getElementById('chat-popup');
        const closeChatBtn = document.getElementById('close-chat-btn');
        const chatHeader = document.getElementById('chat-header');
        const chatMessages = document.getElementById('chat-messages');
        const chatInput = document.getElementById('chat-input');
        const toggleChatModeBtn = document.getElementById('toggle-chat-mode-btn');
        const filterAuthor = document.getElementById('filter-author');
        const filterDate = document.getElementById('filter-date');
        const filterLocation = document.getElementById('filter-location');
        const filterTag = document.getElementById('filter-tag');
        const sortStories = document.getElementById('sort-stories');
        const resetFiltersBtn = document.getElementById('reset-filters-btn');
        const toggleFiltersBtn = document.getElementById('toggle-filters-btn');
        const navLinks = document.querySelectorAll('.nav-link');
        const tabContents = document.querySelectorAll('.tab-content');

        // --- HÀM TIỆN ÍCH ---
        const showView = (viewId) => {
            [authScreen, coupleCodeScreen, profileSetupScreen, mainApp].forEach(screen => screen.classList.add('hidden'));
            document.getElementById(viewId).classList.remove('hidden');
            loadingOverlay.classList.add('hidden');
        };
        
        const showConfirm = (message, onOk, onCancel = () => {}) => {
            const confirmModal = document.getElementById('confirm-modal');
            document.getElementById('confirm-message').textContent = message;
            document.getElementById('confirm-cancel-btn').classList.remove('hidden');
            confirmModal.classList.remove('hidden');

            const okBtn = document.getElementById('confirm-ok-btn');
            const cancelBtn = document.getElementById('confirm-cancel-btn');

            const okListener = () => {
                onOk();
                cleanup();
            };
            const cancelListener = () => {
                onCancel();
                cleanup();
            };
            
            function cleanup() {
                confirmModal.classList.add('hidden');
                okBtn.removeEventListener('click', okListener);
                cancelBtn.removeEventListener('click', cancelListener);
            }

            okBtn.addEventListener('click', okListener);
            cancelBtn.addEventListener('click', cancelListener);
        };
        
        const showAlert = (message) => {
             showConfirm(message, () => {});
             document.getElementById('confirm-cancel-btn').classList.add('hidden');
        };


        // --- QUẢN LÝ XÁC THỰC ---
        onAuthStateChanged(auth, async (user) => {
            if (user) {
                currentUser = user;
                userId = user.uid;
                // Dọn dẹp listener cũ
                if (unsubscribeCouple) unsubscribeCouple();
                if (unsubscribeEvents) unsubscribeEvents();
                if (unsubscribeNormalChat) unsubscribeNormalChat();
                if (unsubscribeSecretChat) unsubscribeSecretChat();
                Object.values(storyCommentListeners).forEach(unsub => unsub());
                storyCommentListeners = {};
                allStories = [];

                const userDocRef = doc(db, "users", userId);
                const userDocSnap = await getDoc(userDocRef);

                if (userDocSnap.exists() && userDocSnap.data().coupleCode) {
                    coupleCode = userDocSnap.data().coupleCode;
                    await setupRealtimeListeners();
                    showView('main-app');
                    chatFab.classList.remove('hidden');
                } else {
                    showView('couple-code-screen');
                    chatFab.classList.add('hidden');
                }
            } else {
                currentUser = null;
                userId = null;
                coupleCode = null;
                coupleData = null;
                if (unsubscribeCouple) unsubscribeCouple();
                if (unsubscribeEvents) unsubscribeEvents();
                if (unsubscribeNormalChat) unsubscribeNormalChat();
                if (unsubscribeSecretChat) unsubscribeSecretChat();
                Object.values(storyCommentListeners).forEach(unsub => unsub());
                storyCommentListeners = {};
                allStories = [];
                showView('auth-screen');
                chatFab.classList.add('hidden');
                chatPopup.classList.remove('active');
            }
        });

        // --- XỬ LÝ FORM ĐĂNG NHẬP/ĐĂNG KÝ ---
        document.getElementById('show-register').addEventListener('click', (e) => { e.preventDefault(); document.getElementById('login-form').classList.add('hidden'); document.getElementById('register-form').classList.remove('hidden'); });
        document.getElementById('show-login').addEventListener('click', (e) => { e.preventDefault(); document.getElementById('register-form').classList.add('hidden'); document.getElementById('login-form').classList.remove('hidden'); });
        document.getElementById('register-btn').addEventListener('click', async () => {
            const email = document.getElementById('register-email').value, password = document.getElementById('register-password').value, inviteCode = document.getElementById('register-invite-code').value, errorDiv = document.getElementById('register-error');
            errorDiv.textContent = '';
            if (!email || !password || !inviteCode) { errorDiv.textContent = 'Vui lòng nhập đầy đủ thông tin.'; return; }
            try {
                const inviteCodeRef = doc(db, "invitationCodes", inviteCode);
                const inviteCodeSnap = await getDoc(inviteCodeRef);
                if (!inviteCodeSnap.exists() || inviteCodeSnap.data().used) { errorDiv.textContent = 'Mã mời không hợp lệ hoặc đã được sử dụng.'; return; }
                await createUserWithEmailAndPassword(auth, email, password);
            } catch (error) { console.error("Lỗi đăng ký:", error); errorDiv.textContent = "Đã xảy ra lỗi. Vui lòng thử lại. " + error.message; }
        });
        document.getElementById('login-btn').addEventListener('click', async () => {
            const email = document.getElementById('login-email').value, password = document.getElementById('login-password').value, errorDiv = document.getElementById('login-error');
            errorDiv.textContent = '';
            if (!email || !password) { errorDiv.textContent = 'Vui lòng nhập email và mật khẩu.'; return; }
            try { await signInWithEmailAndPassword(auth, email, password); } catch (error) { console.error("Lỗi đăng nhập:", error); errorDiv.textContent = "Email hoặc mật khẩu không đúng."; }
        });
        document.getElementById('logout-btn').addEventListener('click', async () => { 
            if(wasInSecretChat) {
                showConfirm("Bạn có muốn xóa cuộc trò chuyện bí mật trước khi đăng xuất?", async () => {
                    await clearSecretChat();
                    await signOut(auth);
                });
            } else {
                await signOut(auth); 
            }
        });

        // --- XỬ LÝ CẶP ĐÔI & PROFILE ---
        document.getElementById('join-couple-btn').addEventListener('click', async () => {
            const code = document.getElementById('couple-code-input').value.trim(), errorDiv = document.getElementById('couple-code-error'); errorDiv.textContent = '';
            if (!code) { errorDiv.textContent = 'Vui lòng nhập mã.'; return; }
            const coupleDocRef = doc(db, "couples", code);
            const coupleDocSnap = await getDoc(coupleDocRef);
            if (!coupleDocSnap.exists()) { errorDiv.textContent = 'Mã cặp đôi không tồn tại.'; return; }
            const data = coupleDocSnap.data();
            if (data.partner1 && data.partner2) { errorDiv.textContent = 'Cặp đôi này đã đủ thành viên.'; return; }
            coupleCode = code; await prepareProfileSetup(data); showView('profile-setup-screen');
        });
        
        document.getElementById('create-custom-couple-btn').addEventListener('click', async () => {
            const code = document.getElementById('couple-code-input').value.trim();
            const errorDiv = document.getElementById('couple-code-error');
            errorDiv.textContent = '';

            if (!code) {
                errorDiv.textContent = 'Vui lòng nhập một mã để tạo.';
                return;
            }

            const coupleDocRef = doc(db, "couples", code);
            const coupleDocSnap = await getDoc(coupleDocRef);

            if (coupleDocSnap.exists()) {
                errorDiv.textContent = 'Mã này đã tồn tại. Vui lòng chọn mã khác hoặc nhấn "Tham Gia".';
                return;
            }
            
            coupleCode = code;
            await setDoc(doc(db, "couples", coupleCode), {
                createdAt: Timestamp.now(),
                startDate: null,
                partner1: null,
                partner2: null
            });

            await prepareProfileSetup({});
            showView('profile-setup-screen');
        });

        const prepareProfileSetup = async (coupleData) => {
            const genderSelect = document.getElementById('profile-gender'); genderSelect.disabled = false; genderSelect.value = '';
            if (coupleData.partner1) { const existingGender = coupleData.partner1.gender; const otherGender = existingGender === 'male' ? 'female' : 'male'; genderSelect.value = otherGender; genderSelect.disabled = true; }
        };

        document.getElementById('save-profile-btn').addEventListener('click', async () => {
            const name = document.getElementById('profile-name').value, dob = document.getElementById('profile-dob').value, gender = document.getElementById('profile-gender').value, errorDiv = document.getElementById('profile-setup-error'); errorDiv.textContent = '';
            if (!name || !dob || !gender) { errorDiv.textContent = 'Vui lòng điền đầy đủ thông tin.'; return; }
            const coupleDocRef = doc(db, "couples", coupleCode); const coupleDocSnap = await getDoc(coupleDocRef); const data = coupleDocSnap.data();
            const newPartnerInfo = { userId: userId, name: name, dob: dob, gender: gender, photoURL: `https://placehold.co/150x150/fbcfe8/ec4899?text=${name.charAt(0)}`, feeling: "" };
            let updateData = {}; if (!data.partner1) { updateData.partner1 = newPartnerInfo; } else { updateData.partner2 = newPartnerInfo; }
            try { await updateDoc(coupleDocRef, updateData); await setDoc(doc(db, "users", userId), { coupleCode: coupleCode }); window.location.reload(); } catch (error) { console.error("Lỗi lưu profile:", error); errorDiv.textContent = "Đã có lỗi xảy ra."; }
        });


        // --- REALTIME LISTENERS ---
        async function setupRealtimeListeners() {
            const coupleDocRef = doc(db, "couples", coupleCode);
            unsubscribeCouple = onSnapshot(coupleDocRef, (docSnap) => {
                if (docSnap.exists()) {
                    const oldData = coupleData;
                    coupleData = docSnap.data();
                    
                    if (oldData && coupleData.lastMessage && coupleData.lastMessage.senderId !== userId) {
                        const newTimestamp = coupleData.lastMessage.timestamp;
                        if (!localLastMessageTimestamp || newTimestamp.toMillis() > localLastMessageTimestamp.toMillis()) {
                            if (!chatPopup.classList.contains('active')) {
                                chatPopup.classList.add('active');
                            }
                        }
                    }
                    localLastMessageTimestamp = coupleData.lastMessage?.timestamp;

                    renderMainPage();
                    renderSettings();
                } else {
                    signOut(auth);
                }
            });

            const storiesColRef = collection(db, "couples", coupleCode, "stories");
            onSnapshot(storiesColRef, (snapshot) => {
                allStories = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                updateStoryDisplay();
            });
            
            const eventsColRef = collection(db, "couples", coupleCode, "events");
            const eventsQuery = query(eventsColRef, orderBy("date", "asc"));
            unsubscribeEvents = onSnapshot(eventsQuery, (snapshot) => {
                renderEvents(snapshot.docs);
            });

            setupChatListeners();
        }

        // --- RENDER FUNCTIONS ---
        function renderMainPage() {
            if (!coupleData) return;
            const startDateDisplay = document.querySelector('#start-date-display span');
            if (coupleData.startDate) {
                const start = coupleData.startDate.toDate(); startDateDisplay.textContent = start.toLocaleDateString('vi-VN');
                const now = new Date(); const diffTime = Math.abs(now - start); const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
                let years = now.getFullYear() - start.getFullYear(); let months = now.getMonth() - start.getMonth(); let days = now.getDate() - start.getDate();
                if (days < 0) { months--; days += new Date(now.getFullYear(), now.getMonth(), 0).getDate(); }
                if (months < 0) { years--; months += 12; }
                document.getElementById('day-counter').textContent = diffDays; document.getElementById('ymd-counter').textContent = `${years} năm ${months} tháng ${days} ngày`;
            } else {
                startDateDisplay.textContent = 'Chưa thiết lập'; document.getElementById('day-counter').textContent = '♡'; document.getElementById('ymd-counter').textContent = 'Hãy vào Cài đặt để chọn ngày bắt đầu nhé!';
            }
            renderPartnerCard('partner-1-card', coupleData.partner1);
            renderPartnerCard('partner-2-card', coupleData.partner2);
        }

        function renderPartnerCard(elementId, partner) {
            const card = document.getElementById(elementId);
            if (!partner) { card.innerHTML = `<p>Đang chờ nửa kia...</p>`; return; }
            const dob = new Date(partner.dob);
            const isCurrentUser = partner.userId === userId;
            card.innerHTML = `
                ${partner.feeling ? `<div class="feeling-bubble">"${partner.feeling}"</div>` : ''}
                <img src="${partner.photoURL}" alt="${partner.name}">
                <h3>${partner.name}</h3>
                <p><i class="fas fa-birthday-cake"></i>${dob.toLocaleDateString('vi-VN')}</p>
                <div class="gender-icon">${partner.gender === 'male' ? '<i class="fas fa-mars"></i>' : '<i class="fas fa-venus"></i>'}</div>
                ${isCurrentUser ? `<button data-partner-id="${partner.userId}" class="edit-feeling-btn"><i class="fas fa-pencil-alt"></i></button>` : ''}
            `;
        }
        
        function renderEvents(docs) {
            const list = document.getElementById('event-list');
             if (docs.length === 0) {
                list.innerHTML = `<div class="card" style="text-align: center; color: #6b7280;">Chưa có sự kiện nào được thêm.</div>`;
                return;
            }
            list.innerHTML = docs.map(doc => {
                const event = doc.data();
                const eventDate = event.date.toDate();
                const now = new Date();
                now.setHours(0,0,0,0);
                
                let nextDate = new Date(eventDate);
                nextDate.setHours(0,0,0,0);

                if (nextDate < now) {
                    switch(event.repeat) {
                        case 'daily': nextDate = now; break;
                        case 'weekly': while(nextDate < now) nextDate.setDate(nextDate.getDate() + 7); break;
                        case 'monthly': while(nextDate < now) nextDate.setMonth(nextDate.getMonth() + 1); break;
                        case 'yearly': while(nextDate < now) nextDate.setFullYear(nextDate.getFullYear() + 1); break;
                        case 'interval': while(nextDate < now) nextDate.setDate(nextDate.getDate() + event.intervalDays); break;
                    }
                }
                
                const diffTime = nextDate - now;
                const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));

                return `
                    <div class="event-card">
                        <img src="${event.imageUrl || 'https://placehold.co/100x100/a5b4fc/4338ca?text=Event'}">
                        <div class="details">
                            <h4>${event.name}</h4>
                            <p>${nextDate.toLocaleDateString('vi-VN')}</p>
                            <p><i class="far fa-clock"></i> Lặp lại: ${getRepeatText(event.repeat, event.intervalDays)}</p>
                        </div>
                        <div class="countdown">
                            <div class="days">${diffDays > 0 ? diffDays : 'Hôm nay'}</div>
                            <div class="label">${diffDays > 0 ? 'ngày nữa' : ''}</div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        function getRepeatText(repeatType, interval) {
            const map = {'none': 'Không', 'daily': 'Hàng ngày', 'weekly': 'Hàng tuần', 'monthly': 'Hàng tháng', 'yearly': 'Hàng năm'};
            return repeatType === 'interval' ? `Sau ${interval} ngày` : map[repeatType] || 'Không rõ';
        }

        function renderSettings() {
            if (!coupleData) return;
            document.getElementById('setting-couple-code').value = coupleCode;
            document.getElementById('setting-start-date').value = coupleData.startDate ? coupleData.startDate.toDate().toISOString().split('T')[0] : '';
            
            renderPartnerSettings('settings-partner-1', coupleData.partner1);
            renderPartnerSettings('settings-partner-2', coupleData.partner2);
        }

        function renderPartnerSettings(elementId, partner) {
            const container = document.getElementById(elementId);
            if (!partner) {
                container.innerHTML = `<p>Thông tin nửa kia chưa có.</p>`;
                return;
            }
            container.innerHTML = `
                <h4>${partner.name} (${partner.gender === 'male' ? 'Nam' : 'Nữ'})</h4>
                <div>
                    <div class="partner-setting-item">
                        <label>Tên</label>
                        <input type="text" data-partner-id="${partner.userId}" data-field="name" value="${partner.name}">
                    </div>
                    <div class="partner-setting-item">
                        <label>Ngày sinh</label>
                        <input type="date" data-partner-id="${partner.userId}" data-field="dob" value="${partner.dob}">
                    </div>
                     <div class="partner-setting-item">
                        <label>URL Ảnh đại diện</label>
                        <input type="text" data-partner-id="${partner.userId}" data-field="photoURL" value="${partner.photoURL}">
                    </div>
                </div>
            `;
        }

        // --- STORY FILTER & SORT ---
        toggleFiltersBtn.addEventListener('click', () => {
            const filterControls = document.getElementById('filter-controls');
            filterControls.classList.toggle('active');
            toggleFiltersBtn.querySelector('.fa-chevron-down').classList.toggle('rotate-180');
        });

        function updateStoryDisplay() {
            if (!coupleData) return;

            if (filterAuthor.options.length <= 1) {
                filterAuthor.innerHTML = '<option value="all">Tất cả</option>'; // Reset before adding
                if (coupleData.partner1) filterAuthor.innerHTML += `<option value="${coupleData.partner1.userId}">${coupleData.partner1.name}</option>`;
                if (coupleData.partner2) filterAuthor.innerHTML += `<option value="${coupleData.partner2.userId}">${coupleData.partner2.name}</option>`;
            }

            let storiesToDisplay = [...allStories];

            const authorId = filterAuthor.value;
            if (authorId !== 'all') {
                storiesToDisplay = storiesToDisplay.filter(story => story.authorId === authorId);
            }

            const dateStr = filterDate.value;
            if (dateStr) {
                const selectedDate = new Date(dateStr);
                const startOfDay = new Date(selectedDate).setHours(0, 0, 0, 0);
                const endOfDay = new Date(selectedDate).setHours(23, 59, 59, 999);
                storiesToDisplay = storiesToDisplay.filter(story => {
                    const storyDate = story.timestamp.toDate().getTime();
                    return storyDate >= startOfDay && storyDate <= endOfDay;
                });
            }
            
            const location = filterLocation.value.trim().toLowerCase();
            if (location) {
                storiesToDisplay = storiesToDisplay.filter(story => 
                    story.location && story.location.toLowerCase().includes(location)
                );
            }

            const tag = filterTag.value.trim().toLowerCase();
            if (tag) {
                storiesToDisplay = storiesToDisplay.filter(story => 
                    story.tags && story.tags.toLowerCase().includes(tag)
                );
            }

            const sortOrder = sortStories.value;
            storiesToDisplay.sort((a, b) => {
                const timeA = a.timestamp.toDate().getTime();
                const timeB = b.timestamp.toDate().getTime();
                return sortOrder === 'asc' ? timeA - timeB : timeB - timeA;
            });

            renderStories(storiesToDisplay);
        }
        
        [filterAuthor, filterDate, sortStories, filterLocation, filterTag].forEach(el => el.addEventListener('input', updateStoryDisplay));
        resetFiltersBtn.addEventListener('click', () => {
            filterAuthor.value = 'all';
            filterDate.value = '';
            filterLocation.value = '';
            filterTag.value = '';
            sortStories.value = 'desc';
            updateStoryDisplay();
        });

        function renderStories(stories) {
            const feed = document.getElementById('story-feed');
            if (stories.length === 0) {
                feed.innerHTML = `<div class="card" style="text-align: center; color: #6b7280;">Không tìm thấy story nào phù hợp.</div>`;
                return;
            }
            const currentUserPartnerData = coupleData.partner1?.userId === userId ? coupleData.partner1 : coupleData.partner2;
            const currentUserPhoto = currentUserPartnerData?.photoURL || 'https://placehold.co/150x150/fbcfe8/ec4899?text=?';

            feed.innerHTML = stories.map(story => {
                const date = story.timestamp.toDate();
                const partner = story.authorId === coupleData.partner1?.userId ? coupleData.partner1 : coupleData.partner2;
                const tagsHTML = story.tags ? story.tags.split(',').map(tag => `<span class="tag">${tag.trim()}</span>`).join(' ') : '';
                const isLiked = story.likes?.includes(userId);
                
                const likerNames = (story.likes || []).map(uid => {
                    if (coupleData.partner1?.userId === uid) return coupleData.partner1.name;
                    if (coupleData.partner2?.userId === uid) return coupleData.partner2.name;
                    return 'Một người';
                }).join(', ');

                return `
                    <div class="story-card" id="story-${story.id}">
                        <div class="content">
                            <div class="author">
                                <img src="${partner?.photoURL || 'https://placehold.co/150x150/fbcfe8/ec4899?text=?'}">
                                <div>
                                    <p class="author-name">${story.authorName}</p>
                                    <p class="timestamp">${date.toLocaleString('vi-VN')}</p>
                                </div>
                            </div>
                            <h3 class="title">${story.title || ''}</h3>
                            <p class="text-content">${story.content}</p>
                            <div class="meta">
                                <div class="location">
                                    ${story.location ? `<i class="fas fa-map-marker-alt"></i> ${story.location}` : ''}
                                </div>
                                <div class="tags">
                                    ${tagsHTML}
                                </div>
                            </div>
                        </div>
                        <div class="actions">
                            <div class="action-buttons">
                                <button class="like-btn ${isLiked ? 'liked' : ''}" data-story-id="${story.id}">
                                    <i class="fas fa-heart"></i>
                                </button>
                                <button class="comment-toggle-btn" data-story-id="${story.id}">
                                    <i class="fas fa-comment-alt"></i> <span class="comment-count">0</span>
                                </button>
                            </div>
                            <div class="like-display">
                                <span class="like-count">${story.likes?.length || 0}</span> lượt thích
                                <span class="liker-names-display">${likerNames ? `bởi ${likerNames}` : ''}</span>
                            </div>
                            <div class="comment-input-area-toplevel">
                                <div class="comment-input-container">
                                    <img src="${currentUserPhoto}">
                                    <input type="text" placeholder="Viết bình luận..." class="comment-input-toplevel" data-story-id="${story.id}">
                                </div>
                            </div>
                            <div class="comment-section" id="comments-${story.id}">
                                </div>
                        </div>
                    </div>
                `;
            }).join('');
            
            attachStoryInteractionListeners();
        }
        
        function attachStoryInteractionListeners() {
            document.querySelectorAll('.like-btn').forEach(btn => {
                btn.onclick = () => toggleLike(btn.dataset.storyId);
            });
            document.querySelectorAll('.comment-toggle-btn').forEach(btn => {
                btn.onclick = () => toggleCommentSection(btn.dataset.storyId);
            });
            document.querySelectorAll('.comment-input-toplevel').forEach(input => {
                input.onkeypress = (e) => {
                    if (e.key === 'Enter') {
                        postComment(input.dataset.storyId, null, input);
                    }
                }
            });
        }
        
        async function toggleLike(storyId) {
            const storyRef = doc(db, "couples", coupleCode, "stories", storyId);
            const storyDoc = await getDoc(storyRef);
            const likes = storyDoc.data().likes || [];
            
            if (likes.includes(userId)) {
                await updateDoc(storyRef, { likes: arrayRemove(userId) });
            } else {
                await updateDoc(storyRef, { likes: arrayUnion(userId) });
            }
        }

        function toggleCommentSection(storyId) {
            const commentSection = document.getElementById(`comments-${storyId}`);
            if (commentSection) {
                const isActive = commentSection.classList.toggle('active');
                if (isActive && !commentSection.querySelector('.comment-list')) { // Load comments only on first open
                    renderComments(storyId);
                }
            }
        }

        function renderComments(storyId) {
            const container = document.getElementById(`comments-${storyId}`);
            if (!container) return;

            if (storyCommentListeners[storyId]) {
                storyCommentListeners[storyId]();
            }

            container.innerHTML = `<div class="comment-list" id="comment-list-${storyId}"></div>`;
            
            const commentList = document.getElementById(`comment-list-${storyId}`);

            const q = query(collection(db, "couples", coupleCode, "stories", storyId, "comments"), orderBy("timestamp", "asc"));
            storyCommentListeners[storyId] = onSnapshot(q, (snapshot) => {
                const allComments = snapshot.docs.map(d => ({ id: d.id, ...d.data() }));
                
                const commentCountSpan = document.querySelector(`#story-${storyId} .comment-count`);
                if(commentCountSpan) commentCountSpan.textContent = allComments.length;

                const topLevelComments = allComments.filter(c => !c.parentId);
                commentList.innerHTML = topLevelComments.map(comment => {
                    const replies = allComments.filter(r => r.parentId === comment.id);
                    return getCommentHTML(comment, replies);
                }).join('');
                
                attachCommentActionListeners(storyId);
            });
        }
        
        function attachCommentActionListeners(storyId) {
            const container = document.getElementById(`comments-${storyId}`);
            if (!container) return;

            container.querySelectorAll('.reply-btn').forEach(btn => {
                btn.onclick = () => showReplyInput(btn.dataset.commentId, storyId);
            });
            container.querySelectorAll('.comment-like-btn').forEach(btn => {
                btn.onclick = () => handleLikeComment(storyId, btn.dataset.commentId);
            });
            container.querySelectorAll('.edit-comment-btn').forEach(btn => {
                btn.onclick = () => handleEditComment(btn.dataset.commentId);
            });
            container.querySelectorAll('.delete-comment-btn').forEach(btn => {
                btn.onclick = () => handleDeleteComment(storyId, btn.dataset.commentId);
            });
        }

        function getCommentHTML(comment, replies = []) {
             const partner = comment.authorId === coupleData.partner1?.userId ? coupleData.partner1 : coupleData.partner2;
             const repliesHTML = replies.map(reply => getCommentHTML(reply)).join('');
             const isMyComment = comment.authorId === userId;
             const isLiked = comment.likes?.includes(userId);

             return `
                <div class="comment-item" id="comment-item-${comment.id}">
                    <div class="comment-item-container">
                        <img src="${partner?.photoURL || ''}">
                        <div class="comment-bubble">
                            <p class="author-name">${comment.authorName}</p>
                            <p class="comment-content">${comment.content}</p>
                            <div class="edit-comment-area hidden">
                                <input type="text" value="${comment.content}">
                                <button class="save-edit-btn">Lưu</button>
                                <button class="cancel-edit-btn">Hủy</button>
                            </div>
                        </div>
                    </div>
                    <div class="comment-actions">
                        <button class="comment-like-btn ${isLiked ? 'liked' : ''}" data-comment-id="${comment.id}">
                            <i class="fas fa-heart fa-xs"></i> <span>${comment.likes?.length || 0}</span>
                        </button>
                        <button class="reply-btn" data-comment-id="${comment.id}">Trả lời</button>
                        ${isMyComment ? `<button class="edit-comment-btn" data-comment-id="${comment.id}">Sửa</button>` : ''}
                        ${isMyComment ? `<button class="delete-comment-btn" data-comment-id="${comment.id}">Xóa</button>` : ''}
                    </div>
                    <div class="replies" id="replies-for-${comment.id}">${repliesHTML}</div>
                    <div class="reply-input-container" id="reply-input-for-${comment.id}"></div>
                </div>
             `;
        }
        
        async function handleLikeComment(storyId, commentId) {
            const commentRef = doc(db, "couples", coupleCode, "stories", storyId, "comments", commentId);
            const commentDoc = await getDoc(commentRef);
            const likes = commentDoc.data().likes || [];
            
            if (likes.includes(userId)) {
                await updateDoc(commentRef, { likes: arrayRemove(userId) });
            } else {
                await updateDoc(commentRef, { likes: arrayUnion(userId) });
            }
        }

        function handleEditComment(commentId) {
            const item = document.getElementById(`comment-item-${commentId}`);
            const contentP = item.querySelector('.comment-content');
            const editArea = item.querySelector('.edit-comment-area');
            const input = editArea.querySelector('input');

            contentP.classList.add('hidden');
            editArea.classList.remove('hidden');
            input.focus();

            item.querySelector('.save-edit-btn').onclick = async () => {
                const newContent = input.value.trim();
                if (newContent) {
                    const storyId = item.closest('.story-card').id.split('-')[1];
                    const commentRef = doc(db, "couples", coupleCode, "stories", storyId, "comments", commentId);
                    await updateDoc(commentRef, { content: newContent });
                }
                // UI will update automatically via onSnapshot
            };
            item.querySelector('.cancel-edit-btn').onclick = () => {
                editArea.classList.add('hidden');
                contentP.classList.remove('hidden');
            };
        }

        async function handleDeleteComment(storyId, commentId) {
            showConfirm("Bạn có chắc muốn xóa bình luận này?", async () => {
                const commentRef = doc(db, "couples", coupleCode, "stories", storyId, "comments", commentId);
                await deleteDoc(commentRef);
            });
        }


        function showReplyInput(commentId, storyId) {
            const container = document.getElementById(`reply-input-for-${commentId}`);
            if (container.innerHTML) { // Hide if already shown
                container.innerHTML = '';
                return;
            }
            container.innerHTML = `
                <input type="text" placeholder="Trả lời..." id="reply-text-${commentId}">
                <button class="post-reply-btn" data-story-id="${storyId}" data-parent-id="${commentId}">Gửi</button>
            `;
            container.querySelector('.post-reply-btn').onclick = (e) => {
                const btn = e.target;
                postComment(btn.dataset.storyId, btn.dataset.parentId);
            };
        }

        async function postComment(storyId, parentId = null, inputElement = null) {
            let input;
            if (inputElement) {
                input = inputElement;
            } else {
                const inputId = `reply-text-${parentId}`;
                input = document.getElementById(inputId);
            }

            const content = input.value.trim();
            if (!content) return;

            const partner = coupleData.partner1.userId === userId ? coupleData.partner1 : coupleData.partner2;
            const commentData = {
                content,
                authorId: userId,
                authorName: partner.name,
                timestamp: Timestamp.now(),
                likes: []
            };
            if (parentId) {
                commentData.parentId = parentId;
            }

            await addDoc(collection(db, "couples", coupleCode, "stories", storyId, "comments"), commentData);
            input.value = '';
            if(parentId) document.getElementById(`reply-input-for-${parentId}`).innerHTML = '';
        }


        // --- CHAT POPUP LOGIC ---
        function setupChatListeners() {
            if (unsubscribeNormalChat) unsubscribeNormalChat();
            if (unsubscribeSecretChat) unsubscribeSecretChat();

            const normalChatRef = collection(db, "couples", coupleCode, "chat_normal");
            const normalQuery = query(normalChatRef, orderBy("timestamp", "desc"));
            unsubscribeNormalChat = onSnapshot(normalQuery, (snapshot) => {
                if (currentChatMode === 'normal') renderChatMessages(snapshot.docs.map(d => ({id: d.id, ...d.data()})));
            });

            const secretChatRef = collection(db, "couples", coupleCode, "chat_secret");
            const secretQuery = query(secretChatRef, orderBy("timestamp", "desc"));
            unsubscribeSecretChat = onSnapshot(secretQuery, (snapshot) => {
                if (currentChatMode === 'secret') renderChatMessages(snapshot.docs.map(d => ({id: d.id, ...d.data()})));
            });
        }

        function renderChatMessages(docs) {
            if (!coupleData) return;
            chatMessages.innerHTML = docs.map(msg => {
                const isMe = msg.authorId === userId;
                return `
                    <div class="message-container ${isMe ? 'justify-end' : 'justify-start'}">
                        ${isMe && currentChatMode === 'normal' ? `<button class="delete-msg-btn" data-message-id="${msg.id}"><i class="fas fa-trash-alt fa-xs"></i></button>` : ''}
                        <div class="message-content">
                            <div class="message-bubble ${isMe ? 'sent' : 'received'}">
                                ${msg.content}
                            </div>
                            <div class="message-timestamp ${isMe ? 'text-right' : 'text-left'}">
                                ${msg.timestamp.toDate().toLocaleTimeString('vi-VN', {hour: '2-digit', minute:'2-digit'})}
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        }
        
        async function handleChatCommand(command) {
            if (command === '@del-me') {
                showConfirm("Bạn có chắc muốn xóa tất cả tin nhắn của mình không?", async () => {
                    const q = query(collection(db, "couples", coupleCode, "chat_normal"), where("authorId", "==", userId));
                    const snapshot = await getDocs(q);
                    const batch = writeBatch(db);
                    snapshot.forEach(doc => batch.delete(doc.ref));
                    await batch.commit();
                    showAlert("Đã xóa tất cả tin nhắn của bạn.");
                });
                return true;
            }
            if (command === '@del-all') {
                showConfirm("Bạn có chắc muốn xóa TOÀN BỘ cuộc trò chuyện không? Hành động này không thể hoàn tác.", async () => {
                    const q = query(collection(db, "couples", coupleCode, "chat_normal"));
                    const snapshot = await getDocs(q);
                    const batch = writeBatch(db);
                    snapshot.forEach(doc => batch.delete(doc.ref));
                    await batch.commit();
                    showAlert("Đã xóa toàn bộ cuộc trò chuyện.");
                });
                return true;
            }
            return false;
        }

        async function sendMessage() {
            const content = chatInput.value.trim();
            if (!content) return;

            if (currentChatMode === 'normal' && await handleChatCommand(content)) {
                chatInput.value = '';
                return;
            }

            const collectionName = currentChatMode === 'normal' ? 'chat_normal' : 'chat_secret';
            try {
                await addDoc(collection(db, "couples", coupleCode, collectionName), {
                    content: content,
                    authorId: userId,
                    timestamp: Timestamp.now()
                });
                await updateDoc(doc(db, "couples", coupleCode), {
                    lastMessage: {
                        senderId: userId,
                        timestamp: Timestamp.now()
                    }
                });
                chatInput.value = '';
            } catch (error) {
                console.error("Lỗi gửi tin nhắn:", error);
                showAlert("Không thể gửi tin nhắn.");
            }
        }

        async function clearSecretChat() {
            const secretChatRef = collection(db, "couples", coupleCode, "chat_secret");
            const q = query(secretChatRef);
            const querySnapshot = await getDocs(q);
            if(querySnapshot.empty) return;

            const batch = writeBatch(db);
            querySnapshot.forEach((doc) => {
                batch.delete(doc.ref);
            });
            await batch.commit();
            wasInSecretChat = false;
        }

        chatFab.addEventListener('click', () => {
            chatPopup.classList.toggle('active');
        });

        closeChatBtn.addEventListener('click', () => {
            chatPopup.classList.remove('active');
            if (wasInSecretChat) {
                showConfirm("Bạn có muốn xóa cuộc trò chuyện bí mật không?", async () => {
                    await clearSecretChat();
                });
            }
        });

        function updateChatModeVisuals(isSecret) {
            chatHeader.style.backgroundColor = isSecret ? '#fecaca' : '#fff'; /* bg-red-200 */
            toggleChatModeBtn.style.backgroundColor = isSecret ? '#ef4444' : '#3b82f6'; /* bg-red-500 or bg-blue-500 */
            toggleChatModeBtn.style.color = '#fff';
            toggleChatModeBtn.innerHTML = isSecret ? '<i class="fas fa-user-secret"></i>Bí mật' : '<i class="fas fa-comments"></i>Bình thường';
            toggleChatModeBtn.querySelector('i').style.marginRight = '0.5rem';
        }

        async function setChatMode(isSecret) {
            currentChatMode = isSecret ? 'secret' : 'normal';
            wasInSecretChat = isSecret;
            updateChatModeVisuals(isSecret);

            const collectionName = currentChatMode === 'normal' ? 'chat_normal' : 'chat_secret';
            const ref = collection(db, "couples", coupleCode, collectionName);
            const q = query(ref, orderBy("timestamp", "desc"));
            const snapshot = await getDocs(q);
            renderChatMessages(snapshot.docs.map(d => ({id: d.id, ...d.data()})));
        }
        
        // Initialize chat mode button
        updateChatModeVisuals(false);

        toggleChatModeBtn.addEventListener('click', () => {
            const isCurrentlySecret = currentChatMode === 'secret';
            if (isCurrentlySecret) { // Switching from secret to normal
                showConfirm("Bạn có muốn xóa cuộc trò chuyện bí mật không?", 
                    async () => {
                       await clearSecretChat();
                       setChatMode(false);
                    }, 
                    () => {
                        setChatMode(false);
                    }
                );
            } else { // Switching from normal to secret
                setChatMode(true);
            }
        });

        document.getElementById('chat-send-btn').addEventListener('click', sendMessage);
        chatInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') sendMessage();
        });

        chatMessages.addEventListener('click', async (e) => {
            const deleteBtn = e.target.closest('.delete-msg-btn');
            if (deleteBtn && currentChatMode === 'normal') {
                const messageId = deleteBtn.dataset.messageId;
                showConfirm("Bạn có chắc muốn xóa tin nhắn này?", async () => {
                    await deleteDoc(doc(db, "couples", coupleCode, "chat_normal", messageId));
                });
            }
        });

        // --- QUẢN LÝ TAB ---
        navLinks.forEach(link => {
            link.addEventListener('click', () => {
                navLinks.forEach(l => l.classList.remove('active'));
                link.classList.add('active');
                
                const tabId = link.dataset.tab + '-content';
                tabContents.forEach(content => {
                    if (content.id === tabId) {
                        content.classList.add('active');
                    } else {
                        content.classList.remove('active');
                    }
                });
            });
        });
        
        // --- MODAL STORY ---
        const storyModal = document.getElementById('story-modal');
        document.getElementById('add-story-btn').addEventListener('click', () => storyModal.classList.remove('hidden'));
        document.getElementById('cancel-story-btn').addEventListener('click', () => storyModal.classList.add('hidden'));
        document.getElementById('post-story-btn').addEventListener('click', async () => {
            const title = document.getElementById('story-title').value.trim();
            const content = document.getElementById('story-textarea').value.trim();
            const location = document.getElementById('story-location').value.trim();
            const tags = document.getElementById('story-tags').value.trim();

            if (!content) { showAlert('Vui lòng nhập nội dung.'); return; }
            
            const partner = coupleData.partner1.userId === userId ? coupleData.partner1 : coupleData.partner2;

            try {
                await addDoc(collection(db, "couples", coupleCode, "stories"), {
                    title: title, content: content, location: location, tags: tags,
                    authorId: userId, authorName: partner.name, timestamp: Timestamp.now(),
                    likes: []
                });
                document.getElementById('story-title').value = '';
                document.getElementById('story-textarea').value = '';
                document.getElementById('story-location').value = '';
                document.getElementById('story-tags').value = '';
                storyModal.classList.add('hidden');
            } catch (error) { console.error("Lỗi đăng story:", error); showAlert("Không thể đăng story."); }
        });
        
        // --- MODAL FEELING ---
        const feelingModal = document.getElementById('feeling-modal');
        document.body.addEventListener('click', (e) => {
            const btn = e.target.closest('.edit-feeling-btn');
            if (btn) {
                const partnerId = btn.dataset.partnerId;
                const partner = coupleData.partner1.userId === partnerId ? coupleData.partner1 : coupleData.partner2;
                document.getElementById('feeling-input').value = partner.feeling || '';
                feelingModal.classList.remove('hidden');
            }
        });
        document.getElementById('cancel-feeling-btn').addEventListener('click', () => feelingModal.classList.add('hidden'));
        document.getElementById('save-feeling-btn').addEventListener('click', async () => {
            const newFeeling = document.getElementById('feeling-input').value.trim();
            const partnerKey = coupleData.partner1.userId === userId ? 'partner1.feeling' : 'partner2.feeling';
            
            try {
                await updateDoc(doc(db, "couples", coupleCode), { [partnerKey]: newFeeling });
                feelingModal.classList.add('hidden');
            } catch (error) { console.error("Lỗi lưu cảm nhận:", error); showAlert("Không thể lưu cảm nhận."); }
        });


        // --- EVENT & SETTINGS LOGIC ---
        const eventModal = document.getElementById('event-modal');
        const eventIntervalInput = document.getElementById('event-interval-days');
        document.getElementById('event-repeat').addEventListener('change', (e) => { eventIntervalInput.classList.toggle('hidden', e.target.value !== 'interval'); });
        document.getElementById('add-event-btn').addEventListener('click', () => eventModal.classList.remove('hidden'));
        document.getElementById('cancel-event-btn').addEventListener('click', () => { eventModal.classList.add('hidden'); document.getElementById('event-name').value = ''; document.getElementById('event-date').value = ''; document.getElementById('event-image-url').value = ''; document.getElementById('event-repeat').value = 'none'; eventIntervalInput.classList.add('hidden'); eventIntervalInput.value = ''; });
        document.getElementById('save-event-btn').addEventListener('click', async () => {
            const name = document.getElementById('event-name').value, date = document.getElementById('event-date').value, repeat = document.getElementById('event-repeat').value, intervalDays = document.getElementById('event-interval-days').value;
            if (!name || !date || !repeat || (repeat === 'interval' && !intervalDays)) { showAlert('Vui lòng điền đủ thông tin sự kiện.'); return; }
            try {
                await addDoc(collection(db, "couples", coupleCode, "events"), { name: name, date: Timestamp.fromDate(new Date(date)), imageUrl: document.getElementById('event-image-url').value, repeat: repeat, intervalDays: repeat === 'interval' ? parseInt(intervalDays) : null, createdAt: Timestamp.now() });
                document.getElementById('cancel-event-btn').click();
            } catch (error) { console.error("Lỗi lưu sự kiện:", error); showAlert("Không thể lưu sự kiện."); }
        });
        
        document.getElementById('save-settings-btn').addEventListener('click', async () => {
            try {
                const startDate = document.getElementById('setting-start-date').value;
                let updateData = {};

                if (startDate) {
                    updateData.startDate = Timestamp.fromDate(new Date(startDate));
                }

                const inputs = document.querySelectorAll('#settings-content input[data-partner-id]');
                inputs.forEach(input => {
                    const partnerKey = coupleData.partner1.userId === input.dataset.partnerId ? 'partner1' : 'partner2';
                    const field = input.dataset.field;
                    if (!updateData[partnerKey]) updateData[partnerKey] = { ...coupleData[partnerKey] };
                    updateData[partnerKey][field] = input.value;
                });

                await updateDoc(doc(db, "couples", coupleCode), updateData);
                showAlert('Đã lưu cài đặt thành công!');
            } catch (error) {
                console.error("Lỗi lưu cài đặt:", error);
                showAlert('Có lỗi xảy ra khi lưu cài đặt.');
            }
        });
        
        document.getElementById('copy-code-btn').addEventListener('click', () => {
            const codeInput = document.getElementById('setting-couple-code');
            codeInput.select();
            codeInput.setSelectionRange(0, 99999);
            try {
                navigator.clipboard.writeText(codeInput.value).then(() => {
                     showAlert('Đã sao chép mã!');
                });
            } catch (err) {
                 showAlert('Không thể sao chép.');
            }
        });

        document.getElementById('change-code-btn').addEventListener('click', async () => {
            const newCode = document.getElementById('setting-new-couple-code').value.trim();
            const errorDiv = document.getElementById('change-code-error');
            errorDiv.textContent = '';

            if (!newCode) {
                errorDiv.textContent = 'Vui lòng nhập mã mới.';
                return;
            }
            if (newCode === coupleCode) {
                errorDiv.textContent = 'Mã mới phải khác với mã hiện tại.';
                return;
            }

            loadingText.textContent = "Đang kiểm tra mã mới...";
            loadingOverlay.classList.remove('hidden');
            const newCodeRef = doc(db, "couples", newCode);
            const newCodeSnap = await getDoc(newCodeRef);
            loadingOverlay.classList.add('hidden');

            if (newCodeSnap.exists()) {
                errorDiv.textContent = 'Mã này đã có người sử dụng. Vui lòng chọn mã khác.';
                return;
            }

            showConfirm(`Bạn có chắc muốn đổi mã cặp đôi thành "${newCode}" không? Mã cũ "${coupleCode}" sẽ bị xóa vĩnh viễn.`, async () => {
                try {
                    loadingText.textContent = "Đang di chuyển dữ liệu...";
                    loadingOverlay.classList.remove('hidden');
                    await migrateCoupleData(coupleCode, newCode);
                    showAlert('Đổi mã cặp đôi thành công! Ứng dụng sẽ tải lại.');
                    setTimeout(() => window.location.reload(), 3000);
                } catch (error) {
                    console.error("Lỗi khi đổi mã cặp đôi:", error);
                    showAlert(`Đã xảy ra lỗi nghiêm trọng: ${error.message}`);
                    loadingOverlay.classList.add('hidden');
                }
            });
        });

        async function migrateCoupleData(oldCode, newCode) {
            const oldCoupleDocRef = doc(db, "couples", oldCode);
            const oldCoupleSnap = await getDoc(oldCoupleDocRef);
            if (!oldCoupleSnap.exists()) throw new Error("Không tìm thấy dữ liệu cặp đôi cũ.");
            const coupleDataToMigrate = oldCoupleSnap.data();

            const newCoupleDocRef = doc(db, "couples", newCode);
            await setDoc(newCoupleDocRef, coupleDataToMigrate);

            const subcollectionsToMove = ['stories', 'events', 'chat_normal', 'chat_secret'];
            for (const scName of subcollectionsToMove) {
                loadingText.textContent = `Đang chuyển ${scName}...`;
                const oldSubCollectionRef = collection(db, "couples", oldCode, scName);
                const oldDocsSnapshot = await getDocs(oldSubCollectionRef);
                
                if (!oldDocsSnapshot.empty) {
                    const batch = writeBatch(db);
                    oldDocsSnapshot.forEach(d => {
                        const newDocRef = doc(db, "couples", newCode, scName, d.id);
                        batch.set(newDocRef, d.data());
                        // Also move sub-subcollections like comments
                        // This part needs to be recursive for full migration
                    });

                    // Delete old documents after setting new ones
                    oldDocsSnapshot.forEach(d => {
                         batch.delete(d.ref);
                    });

                    await batch.commit();
                }
            }
            
            // Note: This simplified migration doesn't move sub-subcollections like comments on stories.
            // A production-ready migration would require a more complex recursive function, possibly run in a server environment (Cloud Function) for reliability.
             showAlert("Migration is complex. This demo migrates top-level collections but not nested ones like comments.");


            loadingText.textContent = "Đang cập nhật thông tin người dùng...";
            if (coupleDataToMigrate.partner1) {
                await updateDoc(doc(db, "users", coupleDataToMigrate.partner1.userId), { coupleCode: newCode });
            }
            if (coupleDataToMigrate.partner2) {
                await updateDoc(doc(db, "users", coupleDataToMigrate.partner2.userId), { coupleCode: newCode });
            }

            loadingText.textContent = "Đang dọn dẹp...";
            await deleteDoc(oldCoupleDocRef);
        }

    </script>
</body>
</html>