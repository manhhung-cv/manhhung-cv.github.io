<!DOCTYPE html>
<html lang="vi">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BioLink</title>
   <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="mobile-web-app-capable" content="yes">
    <link rel="icon" href="/Asset/logo/iconApps.png" />
    <link rel="apple-touch-icon" href="/Asset/logo/iconApps.png" sizes="150x150" />

    <meta property="og:image" content="/Asset/Banner/Banner.png" />
    <meta property="og:title" content="Bio Link" />
    <meta property="og:description" content="Thi·∫øt k·∫ø v√† l·∫≠p tr√¨nh ƒêinh M·∫°nh H√πng" />

    <script src="https://cdn.tailwindcss.com"></script>
<script src="/Asset/Extend/IABD.js"></script>
    <link
        href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Outfit:wght@500;700;800&family=Fira+Code:wght@400;600&display=swap"
        rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                        display: ['Outfit', 'sans-serif'],
                        mono: ['Fira Code', 'monospace'],
                    },
                    animation: {
                        'fade-in': 'fadeIn 0.6s cubic-bezier(0.22, 1, 0.36, 1)',
                        'spin-slow': 'spin 8s linear infinite',
                    },
                    keyframes: {
                        fadeIn: { '0%': { opacity: '0', transform: 'translateY(20px)' }, '100%': { opacity: '1', transform: 'translateY(0)' } }
                    }
                }
            }
        }
        
        // --- ‚ö†Ô∏è C·∫§U H√åNH FILE LOCAL ---
        // 1. Danh s√°ch ·∫£nh b√¨a (trong th∆∞ m·ª•c ./Cover/)
        const AVAILABLE_COVERS = ['1.png', '2.png', '3.png', '4.gif'];
        
        // 2. Danh s√°ch nh·∫°c (trong th∆∞ m·ª•c ./Sounds/)
        const AVAILABLE_SOUNDS = ['1.mp3', 'ncs1.mp3']; 
    </script>

    <style>
        /* --- GLOBAL & UTILS --- */
        body { overflow-x: hidden; }
        
        /* Background Layer */
        #global-bg {
            position: fixed; inset: 0; z-index: -1;
            background-size: cover; background-position: center;
            transition: background-image 0.5s ease;
            filter: blur(15px) brightness(0.9); transform: scale(1.1);
        }
        
        #global-overlay {
            position: fixed; inset: 0; z-index: -1;
            background: rgba(0, 0, 0, 0.2); transition: background 0.5s;
        }

        .toast {
            position: fixed; top: 20px; right: 20px; z-index: 9999;
            background: #fff; padding: 12px 20px; border-radius: 12px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.15);
            border-left: 4px solid #22c55e;
            animation: slideIn 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            display: flex; align-items: center; font-weight: 500;
        }
        @keyframes slideIn { from { transform: translateX(120%); } to { transform: translateX(0); } }

        /* Music Player Button */
        .music-btn {
            position: fixed; bottom: 20px; right: 20px; z-index: 50;
            width: 50px; height: 50px;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.2);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.4);
            display: flex; align-items: center; justify-content: center;
            cursor: pointer;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
            transition: transform 0.3s;
        }
        .music-btn:active { transform: scale(0.9); }
        .music-disc { width: 100%; height: 100%; border-radius: 50%; display: flex; align-items: center; justify-content: center; }
        .playing .music-disc { animation: spin 4s linear infinite; }

        /* --- THEMES --- */
        .theme-glass { --text-color: #fff; }
        .theme-glass #global-overlay { background: linear-gradient(180deg, rgba(0, 0, 0, 0.1), rgba(0, 0, 0, 0.3)); }
        .theme-glass .bio-card {
            background: rgba(255, 255, 255, 0.15); backdrop-filter: blur(25px) saturate(180%);
            border: 1px solid rgba(255, 255, 255, 0.3); border-radius: 32px;
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25); color: white;
        }
        .theme-glass .btn-item {
            background: rgba(255, 255, 255, 0.1); border: 1px solid rgba(255, 255, 255, 0.2);
            color: white; border-radius: 18px; transition: all 0.3s;
        }
        .theme-glass .btn-item:hover { background: rgba(255, 255, 255, 0.3); transform: scale(1.02); }

        .theme-win11 { --text-color: #202020; }
        .theme-win11 #global-overlay { background: rgba(243, 243, 243, 0.6); backdrop-filter: blur(40px); }
        .theme-win11 .bio-card { background: rgba(255, 255, 255, 0.85); border-radius: 12px; color: #202020; box-shadow: 0 10px 30px rgba(0,0,0,0.05);}
        .theme-win11 .btn-item { background: white; border-bottom: 2px solid #e5e5e5; border-radius: 6px; color: #333; }
        .theme-win11 .btn-item:hover { background: #f0f0f0; border-color: #0078D4; color: #0078D4; }

        .theme-hacker { --text-color: #0f0; }
        .theme-hacker #global-overlay { background: rgba(0, 10, 0, 0.9); }
        .theme-hacker .bio-card { background: rgba(0, 0, 0, 0.8); border: 1px solid #00ff41; border-radius: 0; color: #00ff41; font-family: 'Fira Code', monospace; }
        .theme-hacker .btn-item { background: transparent; border: 1px solid #333; color: #00ff41; border-radius: 0; }
        .theme-hacker .btn-item:hover { background: #00ff41; color: black; }
        .theme-hacker img.avatar { border-radius: 0 !important; border: 2px solid #00ff41; filter: grayscale(1); }

        .theme-minimal { --text-color: #fff; }
        .theme-minimal #global-overlay { background: rgba(10, 10, 10, 0.85); }
        .theme-minimal .bio-card { background: #000; border: 1px solid #333; border-radius: 24px; color: white; }
        .theme-minimal .btn-item { background: transparent; border: 1px solid #333; border-radius: 50px; color: #aaa; text-transform: uppercase; font-size: 0.8rem; letter-spacing: 1px; }
        .theme-minimal .btn-item:hover { border-color: white; color: white; background: #111; }

        .theme-paper { --text-color: #000; }
        .theme-paper #global-overlay { background: rgba(255, 240, 245, 0.5); backdrop-filter: grayscale(100%); }
        .theme-paper .bio-card { background: #fff; border: 3px solid #000; border-radius: 0; box-shadow: 8px 8px 0px #000; color: black; }
        .theme-paper .btn-item { background: #fff; border: 2px solid #000; color: #000; border-radius: 0; font-weight: 800; box-shadow: 4px 4px 0px #000; margin-bottom: 8px; }
        .theme-paper .btn-item:hover { transform: translate(2px, 2px); box-shadow: 2px 2px 0px #000; background: #FFE600; }
        .theme-paper img.avatar { border: 3px solid #000; border-radius: 0 !important; }

        .theme-cute { --text-color: #6d5b5b; }
        .theme-cute #global-overlay { background: rgba(255, 255, 255, 0.4); }
        .theme-cute .bio-card { background: #fff; border-radius: 40px; border: 4px dashed #FFB6C1; color: #6d5b5b; }
        .theme-cute .btn-item { background: #FFF0F5; border: 2px solid transparent; color: #6d5b5b; border-radius: 25px; }
        .theme-cute .btn-item:hover { background: #FFB6C1; color: white; border-color: #FF69B4; transform: rotate(-1deg); }

        /* Responsive */
        .preview-phone { width: 320px; height: 640px; border: 12px solid #333; border-radius: 40px; overflow: hidden; position: relative; background: #333; margin: 0 auto; box-shadow: 0 20px 50px rgba(0,0,0,0.2); }
        .preview-screen { width: 100%; height: 100%; background: white; overflow-y: auto; position: relative; }
        .preview-screen::-webkit-scrollbar { width: 0px; }
    </style>
</head>

<body class="text-gray-800 antialiased min-h-screen">

    <audio id="bg-audio" loop></audio>

    <div id="global-bg"></div>
    <div id="global-overlay"></div>
    <div id="toast-container"></div>

    <div id="music-control" class="music-btn hidden" onclick="toggleMusic()">
        <div class="music-disc">
            <i id="music-icon" class="fa-solid fa-music text-white text-lg drop-shadow-md"></i>
        </div>
    </div>

    <div id="loader" class="fixed inset-0 z-50 bg-white flex items-center justify-center transition-opacity duration-500">
        <div class="flex flex-col items-center gap-4">
            <div class="w-12 h-12 border-4 border-blue-600 border-t-transparent rounded-full animate-spin"></div>
            <p class="text-sm font-bold text-gray-500 tracking-widest animate-pulse">LOADING BIO...</p>
        </div>
    </div>

    <div id="public-view" class="hidden min-h-screen flex items-center justify-center p-4 relative z-10">
        <div id="public-card-container" class="w-full max-w-md"></div>
    </div>

    <div id="admin-view" class="hidden min-h-screen bg-gray-50/95 relative z-10 pb-20">
        <nav class="bg-white/80 backdrop-blur border-b border-gray-200 sticky top-0 z-40 px-6 py-3 flex justify-between items-center shadow-sm">
            <div class="flex items-center gap-2">
                <i class="fa-solid fa-layer-group text-blue-600"></i>
                <span class="font-bold text-lg text-gray-800">BioLink Manager</span>
            </div>
            <button onclick="logout()" class="text-sm bg-red-50 text-red-500 px-4 py-2 rounded-lg font-bold hover:bg-red-100 transition"><i class="fa-solid fa-arrow-right-from-bracket mr-1"></i> Tho√°t</button>
        </nav>

        <div class="max-w-7xl mx-auto p-4 lg:p-8">
            <div id="auth-box" class="max-w-md mx-auto bg-white p-8 rounded-2xl shadow-xl text-center space-y-5 mt-10">
                <h2 class="text-2xl font-bold font-display text-gray-800">Welcome Back!</h2>
                <div class="space-y-3 text-left">
                    <input id="l-email" type="email" placeholder="Email" class="w-full p-3 bg-gray-50 border rounded-xl outline-none">
                    <input id="l-pass" type="password" placeholder="Password" class="w-full p-3 bg-gray-50 border rounded-xl outline-none">
                </div>
                <button onclick="login()" class="w-full bg-blue-600 text-white p-3.5 rounded-xl font-bold">ƒêƒÉng nh·∫≠p</button>
            </div>

            <div id="dash-box" class="hidden grid grid-cols-1 lg:grid-cols-2 gap-8 items-start">
                <div class="space-y-6">
                    
                    <div class="bg-white p-6 rounded-2xl shadow-sm border border-gray-100">
                        <h3 class="font-bold text-lg mb-4 text-blue-600"><i class="fa-regular fa-id-card mr-2"></i>Th√¥ng tin Profile</h3>
                        <div class="space-y-4">
                            <div class="flex items-center">
                                <span class="bg-gray-100 p-3 rounded-l-lg text-gray-500 border border-r-0 text-sm">/Bio#</span>
                                <input id="e-username" oninput="livePreview()" class="w-full p-3 border rounded-r-lg outline-none" placeholder="Username">
                            </div>
                            <div class="grid grid-cols-2 gap-4">
                                <input id="e-name" oninput="livePreview()" class="w-full p-3 bg-gray-50 border rounded-lg outline-none" placeholder="T√™n hi·ªÉn th·ªã">
                                <input id="e-avatar" oninput="livePreview()" class="w-full p-3 bg-gray-50 border rounded-lg outline-none" placeholder="Avatar URL">
                            </div>
                            <textarea id="e-bio" oninput="livePreview()" class="w-full p-3 bg-gray-50 border rounded-lg outline-none" rows="2" placeholder="Bio..."></textarea>
                        </div>
                    </div>

                    <div class="bg-white p-6 rounded-2xl shadow-sm border border-gray-100">
                        <h3 class="font-bold text-lg mb-4 text-pink-500"><i class="fa-solid fa-share-nodes mr-2"></i>M·∫°ng x√£ h·ªôi</h3>
                        <div class="grid grid-cols-2 gap-3">
                            <input id="s-fb" oninput="livePreview()" placeholder="Facebook URL" class="col-span-2 w-full p-2.5 bg-gray-50 border rounded-lg text-sm">
                            <input id="s-zalo" oninput="livePreview()" placeholder="Zalo URL" class="w-full p-2.5 bg-gray-50 border rounded-lg text-sm">
                            <input id="s-ig" oninput="livePreview()" placeholder="Instagram URL" class="w-full p-2.5 bg-gray-50 border rounded-lg text-sm">
                            <input id="s-tele" oninput="livePreview()" placeholder="Telegram URL" class="w-full p-2.5 bg-gray-50 border rounded-lg text-sm">
                            <input id="s-tiktok" oninput="livePreview()" placeholder="TikTok URL" class="w-full p-2.5 bg-gray-50 border rounded-lg text-sm">
                        </div>
                    </div>

                    <div class="bg-white p-6 rounded-2xl shadow-sm border border-gray-100">
                        <h3 class="font-bold text-lg mb-4 text-purple-600"><i class="fa-solid fa-palette mr-2"></i>Giao di·ªán & Nh·∫°c</h3>
                        
                        <label class="text-xs font-bold text-gray-400 uppercase block mb-2">·∫¢nh b√¨a</label>
                        <div class="grid grid-cols-5 gap-2 mb-4" id="cover-grid"></div>
                        <input type="hidden" id="e-cover">

                        <label class="text-xs font-bold text-gray-400 uppercase block mb-2">Theme</label>
                        <select id="e-theme" onchange="livePreview()" class="w-full p-3 bg-gray-50 border rounded-lg outline-none mb-4">
                            <option value="theme-glass">MacOS 26 Liquid</option>
                            <option value="theme-win11">Windows 11</option>
                            <option value="theme-minimal">Minimal Luxury</option>
                            <option value="theme-hacker">Cyberpunk Hacker</option>
                            <option value="theme-paper">Neo-Brutalism Paper</option>
                            <option value="theme-cute">Pastel Cute</option>
                        </select>

                        <div class="border-t border-gray-100 pt-4 mt-4">
                            <label class="text-xs font-bold text-gray-400 uppercase block mb-2"><i class="fa-solid fa-music mr-1"></i> Nh·∫°c n·ªÅn</label>
                            <div class="flex flex-col gap-3">
                                <select id="e-music-file" onchange="$('e-music-url').value=''; livePreview()" class="w-full p-2 bg-gray-50 border rounded-lg text-sm">
                                    <option value="">-- Kh√¥ng ch·ªçn file c√≥ s·∫µn --</option>
                                    </select>
                                <input id="e-music-url" oninput="$('e-music-file').value=''; livePreview()" class="w-full p-2 bg-gray-50 border rounded-lg text-sm" placeholder="Ho·∫∑c d√°n Link MP3 Online (∆Øu ti√™n)">
                            </div>
                        </div>
                    </div>

                    <div class="bg-white p-6 rounded-2xl shadow-sm border border-gray-100">
                        <div class="flex justify-between items-center mb-4">
                            <h3 class="font-bold text-lg text-green-600"><i class="fa-solid fa-link mr-2"></i>Li√™n k·∫øt</h3>
                            <button onclick="addLinkRow(); livePreview()" class="text-xs bg-blue-50 text-blue-600 px-3 py-1.5 rounded-lg font-bold hover:bg-blue-100">+ Th√™m</button>
                        </div>
                        <div id="link-list" class="space-y-3"></div>
                    </div>

                    <button onclick="saveProfile()" class="w-full bg-gray-900 text-white py-4 rounded-xl font-bold shadow-xl hover:shadow-2xl transition">L∆ØU T·∫§T C·∫¢</button>
                    
                    <div id="result-box" class="hidden p-4 bg-green-50 text-green-800 rounded-xl border border-green-200 flex justify-between items-center mt-4">
                        <a id="final-link" href="#" target="_blank" class="underline font-bold text-sm">...</a>
                        <button onclick="copyLink()" class="bg-white p-2 rounded hover:bg-green-100"><i class="fa-regular fa-copy"></i></button>
                    </div>
                </div>

                <div class="sticky top-24 hidden lg:block">
                    <div class="text-center mb-2 font-bold text-gray-400 text-sm uppercase">Live Preview</div>
                    <div class="preview-phone">
                        <div class="absolute top-0 left-1/2 -translate-x-1/2 w-32 h-6 bg-black z-20 rounded-b-xl"></div>
                        <div id="preview-screen-inner" class="preview-screen relative">
                            <div id="preview-bg" class="absolute inset-0 bg-cover bg-center transition-all duration-300"></div>
                            <div id="preview-overlay" class="absolute inset-0 transition-all duration-300"></div>
                            <div class="relative z-10 min-h-full flex items-center justify-center p-4">
                                <div id="preview-card" class="w-full"></div>
                            </div>
                            <div id="preview-music-icon" class="absolute bottom-4 right-4 w-10 h-10 rounded-full bg-white/20 backdrop-blur border border-white/40 flex items-center justify-center hidden">
                                <i class="fa-solid fa-music text-white animate-spin-slow"></i>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <template id="bio-template">
        <div class="bio-card w-full animate-fade-in overflow-hidden relative pb-6">
            <div class="h-20 w-full"></div>
            <div class="p-6 pt-0 flex flex-col items-center">
                <div class="relative -mt-16 mb-4">
                    <img class="avatar w-28 h-28 object-cover rounded-full shadow-xl bg-white" src="" alt="Avatar">
                    <div class="absolute bottom-0 right-4 translate-x-1 translate-y-1 bg-white text-blue-500 rounded-full border-1 border-white flex items-center justify-center w-6 h-6 text-lg shadow-sm" title="Verified">
                        <i class="fa-solid fa-circle-check"></i>
                    </div>
                </div>
                <h1 class="name-text text-2xl font-display font-bold mb-1 text-center"></h1>
                <p class="bio-text text-center opacity-80 mb-6 text-sm max-w-xs"></p>
                <div class="links-container w-full space-y-3 flex flex-col"></div>
                <div class="socials-container mt-8 mb-2 flex justify-center gap-5 text-2xl"></div>
            </div>
        </div>
    </template>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, signInWithEmailAndPassword, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, getDoc, collection, query, where, getDocs } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyA2q7kd8ful3qoVGfizjf9NneZsfnx0Z88",
            authDomain: "biolink-hunq.firebaseapp.com",
            projectId: "biolink-hunq",
            storageBucket: "biolink-hunq.firebasestorage.app",
            messagingSenderId: "920676442748",
            appId: "1:920676442748:web:833cd333eda3480ab05ff9",
            measurementId: "G-FK3T8JLEVE"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const $ = id => document.getElementById(id);
        const toast = (msg) => {
            const div = document.createElement('div');
            div.className = 'toast';
            div.innerHTML = `<i class="fa-solid fa-check mr-2"></i> ${msg}`;
            $('toast-container').appendChild(div);
            setTimeout(() => div.remove(), 3000);
        };

        // --- MUSIC LOGIC ---
        let audioEl = $('bg-audio');
        let isPlaying = false;

        window.toggleMusic = () => {
            if(isPlaying) {
                audioEl.pause();
                $('music-control').classList.remove('playing');
                $('music-icon').className = 'fa-solid fa-play text-white text-lg';
            } else {
                audioEl.play();
                $('music-control').classList.add('playing');
                $('music-icon').className = 'fa-solid fa-music text-white text-lg';
            }
            isPlaying = !isPlaying;
        }

        function initMusic(musicUrl) {
            if(!musicUrl) {
                $('music-control').classList.add('hidden');
                return;
            }
            
            $('music-control').classList.remove('hidden');
            audioEl.src = musicUrl;
            audioEl.volume = 0.5;

            // Try Auto-play
            const playPromise = audioEl.play();
            if (playPromise !== undefined) {
                playPromise.then(_ => {
                    // Auto-play started
                    isPlaying = true;
                    $('music-control').classList.add('playing');
                }).catch(error => {
                    // Auto-play blocked
                    console.log("Autoplay blocked. Waiting for interaction.");
                    isPlaying = false;
                    $('music-icon').className = 'fa-solid fa-play text-white text-lg'; // Show play icon
                    
                    // Fallback: Play on first interaction
                    const unlockAudio = () => {
                        audioEl.play();
                        isPlaying = true;
                        $('music-control').classList.add('playing');
                        $('music-icon').className = 'fa-solid fa-music text-white text-lg';
                        document.removeEventListener('click', unlockAudio);
                        document.removeEventListener('touchstart', unlockAudio);
                        toast("ƒêang ph√°t nh·∫°c n·ªÅn üéµ");
                    };
                    document.addEventListener('click', unlockAudio);
                    document.addEventListener('touchstart', unlockAudio);
                });
            }
        }

        // --- CORE RENDER ---
        function generateCardHTML(data, isPreview = false) {
            const template = $('bio-template').content.cloneNode(true);
            const card = template.querySelector('.bio-card');
            
            template.querySelector('.name-text').textContent = data.displayName || 'T√™n c·ªßa b·∫°n';
            template.querySelector('.bio-text').textContent = data.bio || 'Ti·ªÉu s·ª≠...';
            
            let avt = data.avatar;
            if(!avt) avt = `https://ui-avatars.com/api/?name=${data.displayName || 'User'}&background=random`;
            else if (/^\d+$/.test(avt)) avt = `https://graph.facebook.com/${avt}/picture?width=500&access_token=6628568379|c1e620fa708a1d5696fb991c1bde5662`;
            template.querySelector('.avatar').src = avt;

            const container = template.querySelector('.links-container');
            container.innerHTML = '';
            (data.links || []).forEach(l => {
                const isLink = l.type === 'link';
                const el = document.createElement(isLink ? 'a' : 'div');
                let iconClass = 'fa-link';
                if(!isLink) iconClass = 'fa-quote-left';
                if(l.url.includes('facebook')) iconClass = 'fa-facebook';
                if(l.url.includes('bank') || l.url.includes('momo')) iconClass = 'fa-credit-card';
                if(l.url.includes('zalo')) iconClass = 'fa-comment-dots';

                el.className = "btn-item block w-full py-4 px-5 flex items-center justify-between cursor-pointer group relative overflow-hidden select-none";
                el.innerHTML = `
                    <div class="flex items-center gap-4 relative z-10">
                        <div class="w-8 h-8 flex items-center justify-center rounded-full bg-white/10">
                            <i class="fa-solid ${iconClass} fa-solid text-lg opacity-80"></i>
                        </div>
                        <span class="font-semibold text-sm tracking-wide">${l.title}</span>
                    </div>
                    ${isLink ? '<i class="fa-solid fa-chevron-right text-xs opacity-50"></i>' : '<span class="text-xs opacity-60 bg-black/5 px-2 py-1 rounded"><i class="fa-solid fa-copy"></i></span>'}
                `;
                if(isLink) { el.href = l.url; el.target = "_blank"; if(isPreview) el.onclick = e => e.preventDefault(); }
                else { el.onclick = () => { if(!isPreview) { navigator.clipboard.writeText(l.url); toast(`ƒê√£ ch√©p`); } } }
                container.appendChild(el);
            });

            const sContainer = template.querySelector('.socials-container');
            const s = data.socials || {};
            const addIcon = (u, i, c) => {
                if(!u) return;
                const a = document.createElement('a'); a.href = u; a.target = '_blank';
                a.className = `opacity-70 hover:opacity-100 transition transform hover:scale-110 hover:-translate-y-1 ${c}`;
                a.innerHTML = `<i class="${i}"></i>`;
                if(isPreview) a.onclick = e => e.preventDefault();
                sContainer.appendChild(a);
            };
            addIcon(s.facebook, 'fa-brands fa-facebook', 'text-blue-600');
            addIcon(s.zalo, 'fa-solid fa-comment', 'text-blue-500');
            addIcon(s.instagram, 'fa-brands fa-instagram', 'text-pink-600');
            addIcon(s.telegram, 'fa-brands fa-telegram', 'text-blue-400');
            addIcon(s.tiktok, 'fa-brands fa-tiktok', 'text-black dark:text-white');

            return card;
        }

        // --- ADMIN & ROUTING ---
        function initAdminUI() {
            // Covers
            const cGrid = $('cover-grid');
            if(cGrid.children.length === 0) {
                AVAILABLE_COVERS.forEach(f => {
                    const img = document.createElement('img'); img.src = `./Cover/${f}`;
                    img.className = "w-full aspect-square object-cover rounded-lg border-2 border-transparent cursor-pointer hover:opacity-80 transition";
                    img.onclick = () => { 
                        $('e-cover').value = f; 
                        Array.from(cGrid.children).forEach(c => c.classList.remove('border-blue-500', 'ring-2'));
                        img.classList.add('border-blue-500', 'ring-2'); livePreview(); 
                    };
                    cGrid.appendChild(img);
                });
            }
            // Music Files
            const mSelect = $('e-music-file');
            if(mSelect.options.length === 1) {
                AVAILABLE_SOUNDS.forEach(s => {
                    const opt = document.createElement('option'); opt.value = s; opt.textContent = s;
                    mSelect.appendChild(opt);
                });
            }
        }

        async function loadAdminData(u) {
            currentUser = u;
            $('auth-box').classList.add('hidden'); $('dash-box').classList.remove('hidden');
            initAdminUI();
            
            const snap = await getDoc(doc(db, "users", u.uid));
            if(snap.exists()) {
                const d = snap.data();
                $('e-username').value = d.username || '';
                $('e-name').value = d.displayName || '';
                $('e-avatar').value = d.avatar || '';
                $('e-bio').value = d.bio || '';
                $('e-theme').value = d.theme || 'theme-glass';
                $('e-cover').value = d.cover || AVAILABLE_COVERS[0];
                
                // Music
                if(d.music) {
                   if(d.music.type === 'file') $('e-music-file').value = d.music.path;
                   else $('e-music-url').value = d.music.path;
                }

                // Socials
                if(d.socials) {
                    $('s-fb').value = d.socials.facebook || ''; $('s-zalo').value = d.socials.zalo || '';
                    $('s-ig').value = d.socials.instagram || ''; $('s-tele').value = d.socials.telegram || ''; $('s-tiktok').value = d.socials.tiktok || '';
                }

                // Cover Highlight
                Array.from($('cover-grid').children).forEach(img => {
                    if(img.src.includes(d.cover || '1.png')) img.classList.add('border-blue-500', 'ring-2');
                });

                // Links
                $('link-list').innerHTML = '';
                (d.links || []).forEach(l => addLinkRow(l.title, l.url, l.type));

                if(d.username) showLink(d.username);
                livePreview();
            }
        }

        window.livePreview = () => {
            // Determine music source
            let mPath = $('e-music-url').value.trim();
            if(!mPath) mPath = $('e-music-file').value;
            
            // Show icon in preview if music is selected
            if(mPath) $('preview-music-icon').classList.remove('hidden');
            else $('preview-music-icon').classList.add('hidden');

            const data = {
                displayName: $('e-name').value, bio: $('e-bio').value, avatar: $('e-avatar').value,
                theme: $('e-theme').value, cover: $('e-cover').value,
                socials: { facebook: $('s-fb').value, zalo: $('s-zalo').value, instagram: $('s-ig').value, telegram: $('s-tele').value, tiktok: $('s-tiktok').value },
                links: []
            };
            document.querySelectorAll('#link-list > div').forEach(row => {
                const t = row.querySelector('.lnk-title').value; const u = row.querySelector('.lnk-val').value;
                const tp = row.querySelector('.type-radio:checked').value;
                if(t) data.links.push({title: t, url: u, type: tp});
            });

            // Update Preview CSS
            $('preview-screen-inner').className = `preview-screen relative ${data.theme}`;
            $('preview-bg').style.backgroundImage = `url('./Cover/${data.cover || '1.png'}')`;
            $('preview-bg').style.filter = 'blur(10px)';
            
            const card = generateCardHTML(data, true);
            $('preview-card').innerHTML = ''; $('preview-card').appendChild(card);
        }

        // --- SAVE ---
        window.saveProfile = async () => {
            if(!currentUser) return;
            const btn = document.querySelector('button[onclick="saveProfile()"]');
            btn.innerText = "ƒêang l∆∞u..."; btn.disabled = true;

            try {
                // Determine Music Data
                let musicData = null;
                const mUrl = $('e-music-url').value.trim();
                const mFile = $('e-music-file').value;
                if(mUrl) musicData = { type: 'url', path: mUrl };
                else if(mFile) musicData = { type: 'file', path: mFile };

                const u = $('e-username').value.trim();
                const links = [];
                document.querySelectorAll('#link-list > div').forEach(row => {
                    const t = row.querySelector('.lnk-title').value; const v = row.querySelector('.lnk-val').value;
                    const tp = row.querySelector('.type-radio:checked').value;
                    if(t && v) links.push({ title: t, url: v, type: tp });
                });

                await setDoc(doc(db, "users", currentUser.uid), {
                    username: u, displayName: $('e-name').value, avatar: $('e-avatar').value,
                    bio: $('e-bio').value, theme: $('e-theme').value, cover: $('e-cover').value,
                    socials: { facebook: $('s-fb').value, zalo: $('s-zalo').value, instagram: $('s-ig').value, telegram: $('s-tele').value, tiktok: $('s-tiktok').value },
                    music: musicData,
                    links: links
                });
                toast('ƒê√£ l∆∞u th√†nh c√¥ng!'); showLink(u);
            } catch (e) { alert(e.message); } 
            finally { btn.innerText = "L∆ØU T·∫§T C·∫¢"; btn.disabled = false; }
        };

        // --- ENTRY POINT ---
        let currentUser = null;
        async function route() {
            const hash = window.location.hash.substring(1);
            $('loader').classList.remove('hidden'); $('public-view').classList.add('hidden'); $('admin-view').classList.add('hidden');
            document.body.className = "text-gray-800 antialiased min-h-screen"; $('global-bg').style.backgroundImage = 'none';

            if(hash) {
                // Public View
                const q = query(collection(db, "users"), where("username", "==", hash));
                const snap = await getDocs(q);
                if(snap.empty) { alert("User not found"); return; }
                const d = snap.docs[0].data();
                
                document.title = d.displayName;
                $('global-bg').style.backgroundImage = `url('./Cover/${d.cover || '1.png'}')`;
                document.body.classList.add(d.theme || 'theme-glass');
                
                const card = generateCardHTML(d);
                $('public-card-container').innerHTML = ''; $('public-card-container').appendChild(card);
                $('public-view').classList.remove('hidden');

                // Handle Music
                if(d.music && d.music.path) {
                    let mSrc = d.music.path;
                    if(d.music.type === 'file') mSrc = `./Sounds/${d.music.path}`;
                    initMusic(mSrc);
                }
            } else {
                // Admin View
                onAuthStateChanged(auth, u => {
                    if(u) loadAdminData(u); else { $('auth-box').classList.remove('hidden'); $('dash-box').classList.add('hidden'); }
                    $('admin-view').classList.remove('hidden');
                });
            }
            setTimeout(() => $('loader').classList.add('hidden'), 500);
        }

        window.onload = route; window.onhashchange = route;
        window.login = async () => { try { await signInWithEmailAndPassword(auth, $('l-email').value, $('l-pass').value) } catch (e) { alert(e.message) } };
        window.logout = () => signOut(auth);
        
        window.addLinkRow = (t='', u='', type='link') => {
            const d = document.createElement('div');
            d.className = "bg-gray-50 p-4 rounded-xl border border-gray-200 relative group animate-fade-in";
            d.innerHTML = `
                <div class="flex justify-between mb-2"><span class="text-xs font-bold text-gray-400">ITEM</span>
                <div class="flex gap-4 text-xs font-medium"><label><input type="radio" name="tp-${Date.now()}" value="link" class="type-radio" ${type==='link'?'checked':''} onchange="livePreview()"> Link</label><label><input type="radio" name="tp-${Date.now()}" value="text" class="type-radio" ${type==='text'?'checked':''} onchange="livePreview()"> Copy</label></div></div>
                <div class="space-y-2"><input class="lnk-title w-full p-2 bg-white border rounded text-sm font-semibold" placeholder="Title" value="${t}" oninput="livePreview()"><input class="lnk-val w-full p-2 bg-white border rounded text-sm font-mono text-gray-500" placeholder="Value" value="${u}" oninput="livePreview()"></div>
                <button onclick="this.parentElement.remove(); livePreview()" class="absolute -top-2 -right-2 w-6 h-6 bg-red-500 text-white rounded-full flex items-center justify-center shadow hover:scale-110 opacity-0 group-hover:opacity-100 transition">x</button>
            `;
            $('link-list').appendChild(d);
        };
        
        function showLink(u) {
            let url = window.location.href.split('#')[0].replace(/\/index\.html$/, '/') + (window.location.href.endsWith('/')?'':'') + '#' + u;
            $('result-box').classList.remove('hidden'); $('final-link').href = url; $('final-link').innerText = url;
        }
        window.copyLink = () => { navigator.clipboard.writeText($('final-link').innerText); toast('Copied!'); }
    </script>
</body>
</html>