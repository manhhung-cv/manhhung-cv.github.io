<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Trình Theo Dõi Mục Tiêu</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        /* --- ANIMATIONS --- */
        @keyframes background-pan {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        @keyframes modal-pop {
            from { opacity: 0; transform: scale(0.9); }
            to { opacity: 1; transform: scale(1); }
        }
        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* --- COLOR VARIABLES --- */
        :root {
            --background-color-start: #e9eefc;
            --background-color-end: #d5e0f3;
            --card-background: rgba(255, 255, 255, 0.3);
            --text-color: #1a1a1a;
            --secondary-text-color: #5a5a5a;
            --border-color: rgba(255, 255, 255, 0.4);
            --accent-color: #007aff;
            --accent-color-darker: #005bb5;
            --danger-color: #ff3b30;
            --success-color: #34c759;
            --shadow-color: rgba(48, 68, 104, 0.15); /* Softer, blue-ish shadow */
            --modal-overlay-bg: rgba(0, 0, 0, 0.4);
            --input-bg: rgba(255, 255, 255, 0.2);
            --input-border: rgba(255, 255, 255, 0.3);
            --progress-bar-bg: rgba(0, 0, 0, 0.08);
            --progress-bar-fill: var(--accent-color);
            --inner-shadow: inset 0 2px 4px rgba(0, 0, 0, 0.04);
        }

        body.dark-mode {
            --background-color-start: #1c1c1e;
            --background-color-end: #0d0d10;
            --card-background: rgba(44, 44, 46, 0.25);
            --text-color: #ffffff;
            --secondary-text-color: #a0a0a0;
            --border-color: rgba(255, 255, 255, 0.1);
            --accent-color: #0a84ff;
            --accent-color-darker: #006ee6;
            --danger-color: #ff453a;
            --success-color: #30d158;
            --shadow-color: rgba(0, 0, 0, 0.25);
            --modal-overlay-bg: rgba(0, 0, 0, 0.6);
            --input-bg: rgba(58, 58, 60, 0.2);
            --input-border: rgba(255, 255, 255, 0.1);
            --progress-bar-bg: rgba(255, 255, 255, 0.15);
        }

        /* --- BASE STYLES --- */
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            margin: 0;
            padding: 20px;
            background: linear-gradient(135deg, var(--background-color-start), var(--background-color-end));
            background-size: 200% 200%; /* For animation */
            animation: background-pan 20s linear infinite;
            color: var(--text-color);
            transition: background 0.6s ease;
            display: flex;
            flex-direction: column;
            align-items: center;
            min-height: 100vh;
            box-sizing: border-box;
            overflow-x: hidden;
        }

        h1 {
            color: var(--text-color);
            margin-bottom: 30px;
            font-size: 3em;
            font-weight: 700;
            text-align: center;
            text-shadow: 0 3px 8px var(--shadow-color);
        }

        .header {
            width: 100%;
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 40px;
            padding: 0 10px;
            box-sizing: border-box;
        }

        .dark-mode-toggle {
            background: var(--card-background);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border: 1px solid var(--border-color);
            color: var(--text-color);
            font-size: 1.5em;
            cursor: pointer;
            padding: 12px 18px;
            border-radius: 18px;
            transition: all 0.3s ease;
            box-shadow: 0 8px 20px var(--shadow-color);
        }
        .dark-mode-toggle:hover {
            transform: translateY(-3px) scale(1.05);
            box-shadow: 0 12px 25px var(--shadow-color);
        }

        /* --- FORM STYLES --- */
        .form-group { margin-bottom: 20px; }
        .form-group label {
            display: block;
            margin-bottom: 10px;
            font-weight: 500;
            color: var(--secondary-text-color);
            font-size: 1.1em;
        }
        .form-group input[type="text"],
        .form-group input[type="date"],
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 18px 20px;
            border: 1px solid var(--input-border);
            border-radius: 18px;
            background-color: var(--input-bg);
            color: var(--text-color);
            font-size: 1.15em;
            transition: all 0.3s ease;
            box-sizing: border-box;
            box-shadow: var(--inner-shadow);
            backdrop-filter: blur(5px);
            -webkit-backdrop-filter: blur(5px);
        }
        .form-group input:focus, .form-group select:focus, .form-group textarea:focus {
            outline: none;
            border-color: var(--accent-color);
            box-shadow: 0 0 0 4px rgba(0, 122, 255, 0.3), var(--inner-shadow);
        }
        .form-group textarea { min-height: 140px; }
        .form-group select {
            appearance: none; -webkit-appearance: none;
            background-repeat: no-repeat; background-position: right 20px center; background-size: 1.3em;
            padding-right: 50px;
        }

        /* --- IMAGE UPLOAD --- */
        .image-upload-section { display: flex; flex-direction: column; gap: 15px; }
        .image-option-switch {
            display: flex; background-color: var(--input-bg); border: 1px solid var(--input-border);
            border-radius: 18px; overflow: hidden; position: relative; box-shadow: var(--inner-shadow);
            height: 50px;
        }
        .image-option-switch .switch-option {
            flex: 1; display: flex; justify-content: center; align-items: center; padding: 10px 15px;
            font-size: 1.05em; font-weight: 500; color: var(--secondary-text-color); cursor: pointer;
            z-index: 1; transition: color 0.3s ease;
        }
        .image-option-switch .switch-option.active { color: var(--text-color); font-weight: 600; }
        .image-option-switch .switch-thumb {
            position: absolute; top: 2px; bottom: 2px; left: 2px; width: calc(50% - 4px);
            background-color: var(--card-background); border: 1px solid var(--border-color);
            border-radius: 16px; transition: left 0.3s cubic-bezier(0.25, 0.46, 0.45, 0.94);
            box-shadow: 0 3px 10px rgba(0,0,0,0.1); backdrop-filter: blur(10px); -webkit-backdrop-filter: blur(10px);
            z-index: 0;
        }
        .image-option-switch.upload-active .switch-thumb { left: calc(50% - 2px); }
        .image-preview {
            width: 100%; max-height: 200px; border-radius: 18px; object-fit: cover;
            margin-top: 15px; border: 1px solid var(--input-border);
            display: none; /* Hidden by default */
        }

        /* --- BUTTONS --- */
        .button {
            display: inline-flex; align-items: center; justify-content: center; gap: 10px;
            padding: 18px 40px; border-radius: 18px; font-size: 1.15em; font-weight: 600;
            cursor: pointer; text-align: center; transition: all 0.3s ease; border: none;
            box-shadow: 0 8px 20px var(--shadow-color);
            color: white; text-shadow: 0 1px 2px rgba(0,0,0,0.15);
        }
        .button.primary { background: linear-gradient(145deg, var(--accent-color), var(--accent-color-darker)); }
        .button.primary:hover { transform: translateY(-3px); box-shadow: 0 12px 28px var(--shadow-color); }
        .button.danger { background: linear-gradient(145deg, var(--danger-color), #c92f28); }
        .button.danger:hover { transform: translateY(-3px); box-shadow: 0 12px 28px var(--shadow-color); }
        .button.secondary {
            background-color: var(--input-bg); color: var(--text-color); border: 1px solid var(--input-border);
            box-shadow: none; text-shadow: none; backdrop-filter: blur(5px);
        }
        .button.secondary:hover { background-color: rgba(255,255,255,0.1); border-color: var(--accent-color); color: var(--accent-color); }
        .button:disabled { cursor: not-allowed; opacity: 0.7; transform: none; box-shadow: 0 6px 15px var(--shadow-color); }
        .spinner {
            width: 20px; height: 20px; border: 2px solid rgba(255,255,255,0.3);
            border-top-color: #fff; border-radius: 50%; animation: spin 1s linear infinite;
            display: none;
        }
        .button.loading .spinner { display: inline-block; }
        .button.loading .button-text { display: none; }

        /* --- GOALS CONTAINER & CARDS --- */
        .goals-container {
            display: grid; grid-template-columns: repeat(auto-fill, minmax(380px, 1fr));
            gap: 40px; width: 100%; max-width: 1400px; padding: 0 10px;
            box-sizing: border-box; margin-bottom: 100px;
        }
        .empty-state {
            grid-column: 1 / -1; text-align: center; padding: 80px 20px;
            background: var(--card-background); border-radius: 30px; border: 1px solid var(--border-color);
            backdrop-filter: blur(10px); -webkit-backdrop-filter: blur(10px);
            animation: fadeIn 0.8s ease-out;
        }
        .empty-state i { font-size: 5em; color: var(--accent-color); margin-bottom: 20px; text-shadow: 0 4px 15px var(--shadow-color); }
        .empty-state h3 { font-size: 2em; color: var(--text-color); margin-bottom: 10px; }
        .empty-state p { font-size: 1.2em; color: var(--secondary-text-color); margin-bottom: 30px; }

        .goal-card {
            background-color: var(--card-background); backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px);
            padding: 35px; border-radius: 30px; box-shadow: 0 15px 35px var(--shadow-color);
            display: flex; flex-direction: column; gap: 25px; transition: all 0.4s ease;
            box-sizing: border-box; position: relative; border: 1px solid var(--border-color);
            opacity: 0; /* For animation */
            animation: fadeIn 0.5s ease-out forwards;
        }
        .goal-card.completed {
            border-color: var(--success-color);
            box-shadow: 0 0 30px -5px var(--success-color);
        }
        .goal-card.completed::after {
            content: '\f00c'; font-family: "Font Awesome 6 Free"; font-weight: 900;
            position: absolute; top: 25px; right: 25px; color: var(--success-color);
            font-size: 3em; filter: drop-shadow(0 4px 10px rgba(0,0,0,0.3));
        }
        .goal-card:hover { transform: translateY(-8px) scale(1.02); box-shadow: 0 25px 45px var(--shadow-color); }
        .goal-card-header { display: flex; align-items: center; gap: 25px; }
        .goal-card-image {
            width: 110px; height: 110px; border-radius: 20px; object-fit: cover;
            border: 2px solid var(--accent-color); flex-shrink: 0; box-shadow: 0 6px 15px rgba(0,0,0,0.15);
        }
        .goal-card-info h3 { margin: 0; font-size: 2em; font-weight: 600; color: var(--text-color); line-height: 1.3; }
        .goal-card-info p { margin: 10px 0 0; font-size: 1.05em; color: var(--secondary-text-color); }
        .goal-card-progress-bar {
            width: 100%; height: 12px; background-color: var(--progress-bar-bg);
            border-radius: 6px; overflow: hidden; margin-top: 15px; box-shadow: var(--inner-shadow);
        }
        .goal-card-progress-fill {
            height: 100%; background: linear-gradient(90deg, var(--progress-bar-fill), var(--accent-color-darker));
            width: 0%; border-radius: 6px; transition: width 0.8s ease-out, background-color 0.3s ease;
        }
        .goal-card.completed .goal-card-progress-fill { background: linear-gradient(90deg, var(--success-color), #28a745); }
        .goal-card-progress-text {
            font-size: 1.1em; font-weight: 600; color: var(--accent-color); margin-top: 10px;
            text-align: right;
        }
        .goal-card-progress-text span.current { color: var(--success-color); }
        .goal-card-notes {
            font-size: 1em; color: var(--secondary-text-color); line-height: 1.7; max-height: 105px;
            overflow: hidden; text-overflow: ellipsis; display: -webkit-box;
            -webkit-line-clamp: 6; -webkit-box-orient: vertical;
        }
        .goal-card-actions { display: flex; flex-wrap: wrap; gap: 15px; margin-top: 20px; }
        .goal-card-actions .button {
            flex: 1 1 auto; min-width: 120px; padding: 12px 18px;
            font-size: 0.9em;
        }

        /* --- MODALS --- */
        .modal-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background-color: var(--modal-overlay-bg); display: flex; justify-content: center;
            align-items: center; z-index: 1000; opacity: 0; visibility: hidden;
            transition: opacity 0.4s ease, visibility 0.4s ease;
        }
        .modal-overlay.active { opacity: 1; visibility: visible; }
        .modal-overlay.active .modal-content {
            animation: modal-pop 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards;
        }
        .modal-content {
            background-color: var(--card-background); backdrop-filter: blur(25px); -webkit-backdrop-filter: blur(25px);
            padding: 45px; border-radius: 35px; box-shadow: 0 20px 60px var(--shadow-color);
            width: 90%; max-width: 650px;
            position: relative; box-sizing: border-box; border: 1px solid var(--border-color);
            max-height: 90vh; overflow-y: auto;
            opacity: 0; /* For animation */
        }
        .modal-content h2 {
            margin-top: 0; margin-bottom: 35px; color: var(--text-color);
            font-size: 2.2em; font-weight: 600; text-align: center;
        }
        .modal-content .button-group { display: flex; justify-content: center; gap: 20px; margin-top: 40px; }
        .modal-close-button {
            position: absolute; top: 20px; right: 20px; background: none; border: none;
            font-size: 2em; color: var(--secondary-text-color); cursor: pointer;
            padding: 10px; border-radius: 50%; transition: all 0.3s ease;
        }
        .modal-close-button:hover { transform: scale(1.1) rotate(90deg); color: var(--text-color); }

        /* --- HISTORY MODAL --- */
        .history-list {
            max-height: 450px; overflow-y: auto; border: 1px solid var(--input-border);
            border-radius: 18px; padding: 25px; background-color: var(--input-bg);
            box-shadow: var(--inner-shadow);
        }
        .history-item {
            padding: 18px 0; border-bottom: 1px solid var(--input-border);
            font-size: 1.1em; color: var(--text-color);
        }
        .history-item:last-child { border-bottom: none; }
        .history-item span { display: block; margin-bottom: 8px; }
        .history-item .date { font-size: 1em; color: var(--secondary-text-color); text-align: right; }

        /* --- MESSAGE BOX --- */
        #messageBox {
            position: fixed; top: 40px; left: 50%;
            transform: translateX(-50%) translateY(-20px);
            padding: 18px 35px; border-radius: 20px; color: white; font-weight: 600;
            z-index: 1001; opacity: 0; visibility: hidden; transition: all 0.5s ease;
            box-shadow: 0 8px 25px rgba(0,0,0,0.3);
        }
        #messageBox.active { opacity: 1; visibility: visible; transform: translateX(-50%) translateY(0); }

        /* --- FAB --- */
        .fab-button {
            position: fixed; bottom: 30px; right: 30px;
            background: linear-gradient(145deg, var(--accent-color), var(--accent-color-darker));
            color: white; width: 60px; height: 60px; border-radius: 50%;
            display: flex; justify-content: center; align-items: center;
            font-size: 2em; box-shadow: 0 10px 25px var(--shadow-color); cursor: pointer;
            transition: all 0.3s ease; z-index: 999; border: 1px solid var(--border-color);
        }
        .fab-button:hover {
            transform: scale(1.1) rotate(90deg);
            box-shadow: 0 15px 30px var(--shadow-color);
        }

        /* --- RESPONSIVE --- */
        @media (max-width: 768px) {
            body { padding: 15px; }
            h1 { font-size: 2.5em; }
            .modal-content { padding: 30px 15px; border-radius: 25px; }
            .goals-container { grid-template-columns: 1fr; gap: 30px; }
            .goal-card-header { flex-direction: column; align-items: flex-start; }
            .goal-card-actions { flex-direction: column; }
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>Taget</h1>
        <button id="darkModeToggle" class="dark-mode-toggle" aria-label="Toggle dark mode">
            <i class="fas fa-moon"></i>
        </button>
    </div>

    <div class="goals-container" id="goalsContainer">
        <!-- Goal cards will be rendered here -->
    </div>

    <div id="addGoalFab" class="fab-button" onclick="openModal('newGoalModal')">
        <i class="fas fa-plus"></i>
    </div>

    <!-- New Goal Modal -->
    <div id="newGoalModal" class="modal-overlay">
        <div class="modal-content">
            <button class="modal-close-button" onclick="closeModal('newGoalModal')"><i class="fas fa-times"></i></button>
            <h2>Tạo Mục Tiêu Mới</h2>
            <form id="goalForm">
                <div class="form-group image-upload-section">
                    <label>Hình ảnh Mục Tiêu (tùy chọn):</label>
                    <div class="image-option-switch" data-form-type="new">
                        <div class="switch-option active" data-option="url">Link ảnh</div>
                        <div class="switch-option" data-option="upload">Tải ảnh lên</div>
                        <div class="switch-thumb"></div>
                    </div>
                    <div id="imageURLInputContainer_new" class="image-input-container">
                        <input type="text" id="goalImageURL_new" placeholder="Nhập URL ảnh">
                    </div>
                    <div id="imageUploadInputContainer_new" class="image-input-container" style="display: none;">
                        <label for="goalImageUpload_new" class="custom-file-upload button secondary">
                            <i class="fas fa-upload"></i> Chọn tệp ảnh
                        </label>
                        <input type="file" id="goalImageUpload_new" accept="image/*" style="display: none;">
                    </div>
                    <img id="imagePreview_new" class="image-preview" alt="Xem trước ảnh">
                </div>
                <div class="form-group">
                    <label for="goalName_new">Tên Mục Tiêu:</label>
                    <input type="text" id="goalName_new" required placeholder="Ví dụ: Tiết kiệm tiền mua nhà">
                </div>
                <div class="form-group">
                    <label for="goalType_new">Loại Mục Tiêu:</label>
                    <select id="goalType_new" required>
                        <option value="">Chọn loại mục tiêu</option>
                        <option value="money">Tiền</option>
                        <option value="steps">Bước</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="goalTarget_new">Giá Trị Mục Tiêu:</label>
                    <input type="text" id="goalTarget_new" required placeholder="Ví dụ: 5.000.000 (cho tiền)">
                </div>
                <div class="form-group">
                    <label for="goalDeadline_new">Thời Hạn (tùy chọn):</label>
                    <input type="date" id="goalDeadline_new">
                </div>
                <div class="form-group">
                    <label for="goalNotes_new">Ghi Chú:</label>
                    <textarea id="goalNotes_new" placeholder="Thêm ghi chú về mục tiêu của bạn..."></textarea>
                </div>
                <button type="submit" class="button primary">
                    <span class="button-text">Tạo Mục Tiêu</span>
                    <div class="spinner"></div>
                </button>
            </form>
        </div>
    </div>
    
    <!-- Edit Goal Modal -->
    <div id="editGoalModal" class="modal-overlay">
        <div class="modal-content">
            <button class="modal-close-button" onclick="closeModal('editGoalModal')"><i class="fas fa-times"></i></button>
            <h2>Chỉnh Sửa Mục Tiêu</h2>
            <form id="editGoalForm">
                <input type="hidden" id="editGoalId">
                <div class="form-group image-upload-section">
                    <label>Hình ảnh Mục Tiêu (tùy chọn):</label>
                    <div class="image-option-switch" data-form-type="edit">
                        <div class="switch-option active" data-option="url">Link ảnh</div>
                        <div class="switch-option" data-option="upload">Tải ảnh lên</div>
                        <div class="switch-thumb"></div>
                    </div>
                    <div id="imageURLInputContainer_edit" class="image-input-container">
                        <input type="text" id="goalImageURL_edit" placeholder="Nhập URL ảnh">
                    </div>
                    <div id="imageUploadInputContainer_edit" class="image-input-container" style="display: none;">
                        <label for="goalImageUpload_edit" class="custom-file-upload button secondary">
                            <i class="fas fa-upload"></i> Chọn tệp ảnh
                        </label>
                        <input type="file" id="goalImageUpload_edit" accept="image/*" style="display: none;">
                    </div>
                    <img id="imagePreview_edit" class="image-preview" alt="Xem trước ảnh">
                </div>
                <div class="form-group">
                    <label for="goalName_edit">Tên Mục Tiêu:</label>
                    <input type="text" id="goalName_edit" required>
                </div>
                <div class="form-group">
                    <label for="goalType_edit">Loại Mục Tiêu:</label>
                    <select id="goalType_edit" required>
                        <option value="money">Tiền</option>
                        <option value="steps">Bước</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="goalTarget_edit">Giá Trị Mục Tiêu:</label>
                    <input type="text" id="goalTarget_edit" required>
                </div>
                <div class="form-group">
                    <label for="goalDeadline_edit">Thời Hạn (tùy chọn):</label>
                    <input type="date" id="goalDeadline_edit">
                </div>
                <div class="form-group">
                    <label for="goalNotes_edit">Ghi Chú:</label>
                    <textarea id="goalNotes_edit"></textarea>
                </div>
                <button type="submit" class="button primary">
                    <span class="button-text">Lưu Thay Đổi</span>
                    <div class="spinner"></div>
                </button>
            </form>
        </div>
    </div>

    <!-- Progress Modal -->
    <div id="progressModal" class="modal-overlay">
        <div class="modal-content">
            <button class="modal-close-button" onclick="closeModal('progressModal')"><i class="fas fa-times"></i></button>
            <h2>Chỉnh Tiến Độ Mục Tiêu</h2>
            <form id="progressForm">
                <input type="hidden" id="progressGoalId">
                <div class="form-group">
                    <label for="currentProgressDisplay">Tiến độ hiện tại:</label>
                    <input type="text" id="currentProgressDisplay" readonly style="background-color: var(--input-bg); border: 1px solid var(--input-border); color: var(--text-color);">
                </div>
                <div class="form-group">
                    <label for="progressAmount">Số Lượng:</label>
                    <input type="text" id="progressAmount" required placeholder="Nhập số lượng để thêm/bớt">
                </div>
                <div class="form-group">
                    <label for="progressType">Loại Điều Chỉnh:</label>
                    <select id="progressType" required>
                        <option value="add">Thêm</option>
                        <option value="subtract">Bớt</option>
                    </select>
                </div>
                <div class="button-group">
                    <button type="button" class="button secondary" onclick="closeModal('progressModal')">Hủy</button>
                    <button type="submit" class="button primary">
                        <span class="button-text">Cập Nhật</span>
                        <div class="spinner"></div>
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- History Modal -->
    <div id="historyModal" class="modal-overlay">
        <div class="modal-content">
            <button class="modal-close-button" onclick="closeModal('historyModal')"><i class="fas fa-times"></i></button>
            <h2>Lịch Sử Mục Tiêu</h2>
            <div id="historyList" class="history-list"></div>
            <div class="button-group">
                <button type="button" class="button secondary" onclick="closeModal('historyModal')">Đóng</button>
            </div>
        </div>
    </div>

    <div id="messageBox"></div>

    <script>
        // --- GLOBAL STATE ---
        let goals = [];
        let darkModeEnabled = false;

        // --- DOM ELEMENTS ---
        const goalsContainer = document.getElementById('goalsContainer');
        const darkModeToggle = document.getElementById('darkModeToggle');
        const messageBox = document.getElementById('messageBox');
        
        // Forms
        const goalForm = document.getElementById('goalForm');
        const editGoalForm = document.getElementById('editGoalForm');
        const progressForm = document.getElementById('progressForm');

        // --- INITIALIZATION ---
        document.addEventListener('DOMContentLoaded', () => {
            // Load preferences
            loadDarkMode();
            loadGoals();

            // Render initial state
            applyDarkMode();
            renderGoals();

            // Attach event listeners
            darkModeToggle.addEventListener('click', toggleDarkMode);
            goalForm.addEventListener('submit', handleCreateGoal);
            editGoalForm.addEventListener('submit', handleSaveChanges);
            progressForm.addEventListener('submit', handleUpdateProgress);

            // Setup number formatting
            ['goalTarget_new', 'goalTarget_edit', 'progressAmount'].forEach(id => {
                document.getElementById(id).addEventListener('input', formatNumberInput);
            });
            
            // Setup image input switches and previews
            setupImageInput('new');
            setupImageInput('edit');

            // Setup modal closing
            document.querySelectorAll('.modal-overlay').forEach(modal => {
                modal.addEventListener('click', (e) => {
                    if (e.target === modal) closeModal(modal.id);
                });
            });
        });

        // --- DATA HANDLING (localStorage) ---
        function saveGoals() {
            localStorage.setItem('goals', JSON.stringify(goals));
        }

        function loadGoals() {
            const storedGoals = localStorage.getItem('goals');
            if (storedGoals) {
                goals = JSON.parse(storedGoals);
            }
        }

        function saveDarkMode() {
            localStorage.setItem('darkModeEnabled', JSON.stringify(darkModeEnabled));
        }

        function loadDarkMode() {
            const storedDarkMode = localStorage.getItem('darkModeEnabled');
            if (storedDarkMode !== null) {
                darkModeEnabled = JSON.parse(storedDarkMode);
            }
        }

        // --- CORE LOGIC ---
        function handleCreateGoal(event) {
            event.preventDefault();
            const submitButton = event.target.querySelector('button[type="submit"]');
            showLoading(submitButton);

            const name = document.getElementById('goalName_new').value.trim();
            const type = document.getElementById('goalType_new').value;
            const target = parseFloat(document.getElementById('goalTarget_new').value.replace(/\./g, ''));
            const deadline = document.getElementById('goalDeadline_new').value;
            const notes = document.getElementById('goalNotes_new').value.trim();
            const imageFile = document.getElementById('goalImageUpload_new').files[0];
            let imageURL = document.getElementById('goalImageURL_new').value.trim();

            if (!name || !type || isNaN(target) || target <= 0) {
                showMessage('Vui lòng điền đầy đủ và chính xác các trường bắt buộc.', 'error');
                hideLoading(submitButton);
                return;
            }

            const processGoalCreation = (finalImageSrc) => {
                const newGoal = {
                    id: crypto.randomUUID(),
                    name,
                    image: finalImageSrc,
                    type,
                    target,
                    deadline,
                    notes,
                    currentAmount: type === 'money' ? 0 : null,
                    currentSteps: type === 'steps' ? 0 : null,
                    history: [],
                    createdAt: new Date().toISOString()
                };

                goals.unshift(newGoal); // Add to the beginning
                saveGoals();
                renderGoals();
                resetAndCloseForm(goalForm, 'newGoalModal', 'new');
                showMessage('Mục tiêu đã được tạo thành công!', 'success');
                hideLoading(submitButton);
            };

            if (imageFile) {
                const reader = new FileReader();
                reader.onload = (e) => {
                    processGoalCreation(e.target.result); // Use Base64 string
                };
                reader.onerror = () => {
                    showMessage('Lỗi đọc tệp hình ảnh.', 'error');
                    hideLoading(submitButton);
                };
                reader.readAsDataURL(imageFile);
            } else {
                processGoalCreation(imageURL); // Use URL or empty string
            }
        }

        function handleSaveChanges(event) {
            event.preventDefault();
            const submitButton = event.target.querySelector('button[type="submit"]');
            showLoading(submitButton);

            const goalId = document.getElementById('editGoalId').value;
            const name = document.getElementById('goalName_edit').value.trim();
            const type = document.getElementById('goalType_edit').value;
            const target = parseFloat(document.getElementById('goalTarget_edit').value.replace(/\./g, ''));
            const deadline = document.getElementById('goalDeadline_edit').value;
            const notes = document.getElementById('goalNotes_edit').value.trim();
            const imageFile = document.getElementById('goalImageUpload_edit').files[0];
            let imageURL = document.getElementById('goalImageURL_edit').value.trim();

            if (!name || !type || isNaN(target) || target <= 0) {
                showMessage('Vui lòng điền đầy đủ và chính xác các trường.', 'error');
                hideLoading(submitButton);
                return;
            }

            const goalIndex = goals.findIndex(g => g.id === goalId);
            if (goalIndex === -1) {
                showMessage('Không tìm thấy mục tiêu để cập nhật.', 'error');
                hideLoading(submitButton);
                return;
            }
            
            const processGoalUpdate = (finalImageSrc) => {
                const goal = goals[goalIndex];
                goal.name = name;
                goal.type = type;
                goal.target = target;
                goal.deadline = deadline;
                goal.notes = notes;
                goal.image = finalImageSrc;
                
                saveGoals();
                renderGoals();
                resetAndCloseForm(editGoalForm, 'editGoalModal', 'edit');
                showMessage('Mục tiêu đã được cập nhật!', 'success');
                hideLoading(submitButton);
            };

            if (imageFile) {
                const reader = new FileReader();
                reader.onload = (e) => {
                    processGoalUpdate(e.target.result); // New Base64 image
                };
                 reader.onerror = () => {
                    showMessage('Lỗi đọc tệp hình ảnh.', 'error');
                    hideLoading(submitButton);
                };
                reader.readAsDataURL(imageFile);
            } else {
                // If no new file, use the URL from the input. 
                // If the input is also empty, it will clear the image.
                processGoalUpdate(imageURL);
            }
        }
        
        function handleUpdateProgress(event) {
            event.preventDefault();
            const submitButton = event.target.querySelector('button[type="submit"]');
            showLoading(submitButton);

            const goalId = document.getElementById('progressGoalId').value;
            const amount = parseFloat(document.getElementById('progressAmount').value.replace(/\./g, ''));
            const type = document.getElementById('progressType').value;

            if (isNaN(amount) || amount <= 0) {
                showMessage('Vui lòng nhập số lượng hợp lệ.', 'error');
                hideLoading(submitButton);
                return;
            }

            const goalIndex = goals.findIndex(g => g.id === goalId);
            if (goalIndex === -1) {
                hideLoading(submitButton);
                return;
            }

            const goal = goals[goalIndex];
            let currentProgressField = goal.type === 'money' ? 'currentAmount' : 'currentSteps';
            let oldValue = goal[currentProgressField] || 0;
            let newValue;

            if (type === 'add') {
                newValue = oldValue + amount;
            } else {
                newValue = Math.max(0, oldValue - amount);
            }

            goal[currentProgressField] = newValue;
            goal.history.push({
                date: new Date().toISOString(),
                type: type === 'add' ? 'Thêm' : 'Bớt',
                amount, oldValue, newValue,
                unit: goal.type === 'money' ? 'VNĐ' : 'bước'
            });

            saveGoals();
            renderGoals();
            closeModal('progressModal');
            showMessage('Tiến độ đã được cập nhật!', 'success');
            hideLoading(submitButton);
        }

        window.deleteGoal = function(goalId) {
            showConfirmModal('Bạn có chắc chắn muốn xóa mục tiêu này không? Hành động này không thể hoàn tác.', () => {
                goals = goals.filter(g => g.id !== goalId);
                saveGoals();
                renderGoals();
                showMessage('Mục tiêu đã được xóa.', 'success');
            });
        }
        
        // --- UI RENDERING & HELPERS ---
        function renderGoals() {
            goalsContainer.innerHTML = '';
            // Sort by creation date before rendering
            const sortedGoals = [...goals].sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt));

            if (sortedGoals.length === 0) {
                goalsContainer.innerHTML = `
                    <div class="empty-state">
                        <i class="fas fa-bullseye"></i>
                        <h3>Chưa có mục tiêu nào</h3>
                        <p>Hãy bắt đầu hành trình của bạn bằng cách tạo một mục tiêu mới.</p>
                        <button class="button primary" onclick="openModal('newGoalModal')">
                            <i class="fas fa-plus"></i> Tạo Mục Tiêu Mới
                        </button>
                    </div>`;
                return;
            }

            sortedGoals.forEach((goal, index) => {
                const goalCard = document.createElement('div');
                goalCard.className = 'goal-card';
                goalCard.dataset.id = goal.id;
                goalCard.style.animationDelay = `${index * 100}ms`;

                const currentProgress = goal.type === 'money' ? goal.currentAmount : goal.currentSteps;
                const target = goal.target;
                const progressPercentage = target > 0 ? Math.min(100, (currentProgress / target * 100)).toFixed(1) : 0;
                const isCompleted = parseFloat(progressPercentage) >= 100;
                
                if (isCompleted) goalCard.classList.add('completed');

                const imageSrc = goal.image || 'https://placehold.co/110x110/e0eafc/1a1a1a?text=Mục+Tiêu';

                goalCard.innerHTML = `
                    <div class="goal-card-header">
                        <img src="${imageSrc}" alt="Hình ảnh mục tiêu" class="goal-card-image" onerror="this.onerror=null;this.src='https://placehold.co/110x110/e0eafc/1a1a1a?text=Lỗi+Ảnh';">
                        <div class="goal-card-info">
                            <h3>${escapeHtml(goal.name)}</h3>
                            <p>Loại: ${goal.type === 'money' ? 'Tiền' : 'Bước'}</p>
                            <p>Thời hạn: ${calculateRemainingDays(goal.deadline)}</p>
                        </div>
                    </div>
                    <div>
                        <div class="goal-card-progress-bar">
                            <div class="goal-card-progress-fill" style="width: ${progressPercentage}%;"></div>
                        </div>
                        <p class="goal-card-progress-text">
                            <span class="current">${formatNumber(currentProgress)}</span> / ${formatNumber(target)} ${goal.type === 'money' ? 'VNĐ' : 'bước'} (${progressPercentage}%)
                        </p>
                    </div>
                    ${goal.notes ? `<p class="goal-card-notes">Ghi chú: ${escapeHtml(goal.notes)}</p>` : ''}
                    <div class="goal-card-actions">
                        <button class="button secondary" onclick="openProgressModal('${goal.id}')"><i class="fas fa-plus-minus"></i> Tiến Độ</button>
                        <button class="button secondary" onclick="openEditModal('${goal.id}')"><i class="fas fa-edit"></i> Sửa</button>
                        <button class="button secondary" onclick="openHistoryModal('${goal.id}')"><i class="fas fa-history"></i> Lịch Sử</button>
                        <button class="button danger" onclick="deleteGoal('${goal.id}')"><i class="fas fa-trash-alt"></i> Xóa</button>
                    </div>
                `;
                goalsContainer.appendChild(goalCard);
            });
        }
        
        window.openEditModal = function(goalId) {
            const goal = goals.find(g => g.id === goalId);
            if (!goal) return;

            document.getElementById('editGoalId').value = goal.id;
            document.getElementById('goalName_edit').value = goal.name;
            document.getElementById('goalType_edit').value = goal.type;
            document.getElementById('goalTarget_edit').value = formatNumber(goal.target);
            document.getElementById('goalDeadline_edit').value = goal.deadline;
            document.getElementById('goalNotes_edit').value = goal.notes;
            
            const imageUrlInput = document.getElementById('goalImageURL_edit');
            const imagePreview = document.getElementById('imagePreview_edit');
            
            document.getElementById('goalImageUpload_edit').value = '';
            imageUrlInput.value = '';
            imagePreview.style.display = 'none';
            imagePreview.src = '';

            if (goal.image) {
                imagePreview.src = goal.image;
                imagePreview.style.display = 'block';
                // If it's a URL, populate the URL input
                if (goal.image.startsWith('http')) {
                    imageUrlInput.value = goal.image;
                    toggleImageInput('url', 'edit');
                } else { // It's a Base64 string from a previous upload
                    toggleImageInput('upload', 'edit');
                }
            } else {
                toggleImageInput('url', 'edit');
            }
            
            openModal('editGoalModal');
        }

        window.openProgressModal = function(goalId) {
            const goal = goals.find(g => g.id === goalId);
            if (!goal) return;

            document.getElementById('progressGoalId').value = goalId;
            const currentProgress = goal.type === 'money' ? goal.currentAmount : goal.currentSteps;
            const unit = goal.type === 'money' ? 'VNĐ' : 'bước';
            document.getElementById('currentProgressDisplay').value = `${formatNumber(currentProgress)} ${unit}`;
            document.getElementById('progressAmount').value = '';
            document.getElementById('progressAmount').placeholder = `Số lượng (${unit})`;
            openModal('progressModal');
        }

        window.openHistoryModal = function(goalId) {
            const goal = goals.find(g => g.id === goalId);
            if (!goal || !goal.history) return;

            const historyList = document.getElementById('historyList');
            historyList.innerHTML = '';
            if (goal.history.length === 0) {
                historyList.innerHTML = '<p style="text-align: center; color: var(--secondary-text-color);">Chưa có lịch sử cho mục tiêu này.</p>';
            } else {
                [...goal.history].reverse().forEach(item => {
                    const historyItem = document.createElement('div');
                    historyItem.className = 'history-item';
                    historyItem.innerHTML = `
                        <span><strong>${item.type}:</strong> ${formatNumber(item.amount)} ${item.unit}</span>
                        <span>Tiến độ cũ: ${formatNumber(item.oldValue)} ${item.unit}</span>
                        <span>Tiến độ mới: ${formatNumber(item.newValue)} ${item.unit}</span>
                        <span class="date">${new Date(item.date).toLocaleString('vi-VN')}</span>
                    `;
                    historyList.appendChild(historyItem);
                });
            }
            openModal('historyModal');
        }

        // --- UI/UX & Theming ---
        function toggleDarkMode() {
            darkModeEnabled = !darkModeEnabled;
            saveDarkMode();
            applyDarkMode();
        }

        function applyDarkMode() {
            document.body.classList.toggle('dark-mode', darkModeEnabled);
            darkModeToggle.innerHTML = darkModeEnabled ? '<i class="fas fa-sun"></i>' : '<i class="fas fa-moon"></i>';
            updateSelectArrowColor();
        }

        function updateSelectArrowColor() {
            const color = getComputedStyle(document.documentElement).getPropertyValue('--secondary-text-color').trim();
            const encodedColor = encodeURIComponent(color);
            const svg = `<svg fill="${encodedColor}" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><path clip-rule="evenodd" d="M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z" fill-rule="evenodd"></path></svg>`;
            document.querySelectorAll('.form-group select').forEach(select => {
                select.style.backgroundImage = `url('data:image/svg+xml;utf8,${svg}')`;
            });
        }

        function setupImageInput(formType) {
            const switchContainer = document.querySelector(`.image-option-switch[data-form-type="${formType}"]`);
            const urlOption = switchContainer.querySelector('.switch-option[data-option="url"]');
            const uploadOption = switchContainer.querySelector('.switch-option[data-option="upload"]');
            const fileInput = document.getElementById(`goalImageUpload_${formType}`);
            const urlInput = document.getElementById(`goalImageURL_${formType}`);
            const preview = document.getElementById(`imagePreview_${formType}`);

            urlOption.addEventListener('click', () => toggleImageInput('url', formType));
            uploadOption.addEventListener('click', () => toggleImageInput('upload', formType));

            fileInput.addEventListener('change', () => {
                const file = fileInput.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        preview.src = e.target.result;
                        preview.style.display = 'block';
                    };
                    reader.readAsDataURL(file);
                }
            });

            urlInput.addEventListener('input', () => {
                if (urlInput.value.trim()) {
                    preview.src = urlInput.value.trim();
                    preview.style.display = 'block';
                } else {
                    preview.style.display = 'none';
                }
            });
        }

        function toggleImageInput(activeOption, formType) {
            const switchContainer = document.querySelector(`.image-option-switch[data-form-type="${formType}"]`);
            const urlOption = switchContainer.querySelector('.switch-option[data-option="url"]');
            const uploadOption = switchContainer.querySelector('.switch-option[data-option="upload"]');
            const urlInputContainer = document.getElementById(`imageURLInputContainer_${formType}`);
            const uploadInputContainer = document.getElementById(`imageUploadInputContainer_${formType}`);
            
            if (activeOption === 'url') {
                urlOption.classList.add('active');
                uploadOption.classList.remove('active');
                urlInputContainer.style.display = 'block';
                uploadInputContainer.style.display = 'none';
                switchContainer.classList.remove('upload-active');
            } else {
                uploadOption.classList.add('active');
                urlOption.classList.remove('active');
                urlInputContainer.style.display = 'none';
                uploadInputContainer.style.display = 'block';
                switchContainer.classList.add('upload-active');
            }
        }
        
        function resetAndCloseForm(formElement, modalId, formType) {
            formElement.reset();
            const preview = document.getElementById(`imagePreview_${formType}`);
            if (preview) {
                preview.style.display = 'none';
                preview.src = '';
            }
            toggleImageInput('url', formType);
            closeModal(modalId);
        }

        // --- UTILITY FUNCTIONS ---
        function formatNumber(amount) {
            return (typeof amount === 'number') ? amount.toLocaleString('vi-VN') : (amount || 0);
        }

        function formatNumberInput(event) {
            let value = event.target.value.replace(/\D/g, '');
            event.target.value = value ? parseFloat(value).toLocaleString('vi-VN') : '';
        }

        function calculateRemainingDays(deadline) {
            if (!deadline) return 'Không có thời hạn';
            const diff = new Date(deadline).setHours(23, 59, 59, 999) - new Date();
            if (diff < 0) return 'Đã quá hạn';
            const days = Math.ceil(diff / (1000 * 60 * 60 * 24));
            return days === 0 ? 'Hôm nay' : `${days} ngày còn lại`;
        }
        
        function escapeHtml(unsafe) {
            if (typeof unsafe !== 'string') return '';
            return unsafe
                 .replace(/&/g, "&amp;")
                 .replace(/</g, "&lt;")
                 .replace(/>/g, "&gt;")
                 .replace(/"/g, "&quot;")
                 .replace(/'/g, "&#039;");
        }

        window.openModal = (modalId) => document.getElementById(modalId).classList.add('active');
        window.closeModal = (modalId) => document.getElementById(modalId).classList.remove('active');

        function showMessage(message, type = 'info') {
            messageBox.textContent = message;
            messageBox.className = 'active';
            messageBox.style.backgroundColor = type === 'success' ? 'var(--success-color)' : type === 'error' ? 'var(--danger-color)' : 'var(--accent-color)';
            setTimeout(() => messageBox.classList.remove('active'), 3500);
        }

        function showConfirmModal(message, onConfirm) {
            const overlay = document.createElement('div');
            overlay.className = 'modal-overlay active';
            overlay.style.zIndex = '1002';
            overlay.innerHTML = `
                <div class="modal-content">
                    <h2>Xác Nhận</h2>
                    <p style="text-align: center; margin-bottom: 25px; font-size: 1.1em;">${message}</p>
                    <div class="button-group">
                        <button class="button secondary">Hủy</button>
                        <button class="button danger">Xác Nhận</button>
                    </div>
                </div>`;
            document.body.appendChild(overlay);
            overlay.querySelector('.secondary').addEventListener('click', () => overlay.remove());
            overlay.querySelector('.danger').addEventListener('click', () => { onConfirm(); overlay.remove(); });
            overlay.addEventListener('click', e => { if (e.target === overlay) overlay.remove(); });
        }

        function showLoading(button) {
            button.disabled = true;
            button.classList.add('loading');
        }

        function hideLoading(button) {
            button.disabled = false;
            button.classList.remove('loading');
        }

    </script>
</body>
</html>
