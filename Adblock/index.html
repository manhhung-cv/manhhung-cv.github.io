<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pro Filter Manager</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        .glass-effect { background: rgba(30, 30, 30, 0.8); backdrop-filter: blur(10px); border: 1px solid rgba(255, 255, 255, 0.1); }
        #editor { font-family: 'Fira Code', monospace; resize: none; }
        .file-item.active { background: rgba(59, 130, 246, 0.2); border-left: 4px solid #3b82f6; }
    </style>
</head>
<body class="bg-[#0d1117] text-gray-200 min-h-screen flex flex-col md:flex-row">

    <aside class="w-full md:w-64 glass-effect p-4 flex flex-col gap-4 border-r border-white/10">
        <h2 class="text-xl font-bold flex items-center gap-2"><i class="fas fa-layer-group"></i> My Filters</h2>
        <button onclick="createNewFilter()" class="w-full py-2 bg-blue-600 hover:bg-blue-500 rounded text-sm transition font-bold">
            + Thêm bộ lọc mới
        </button>
        <div id="fileList" class="flex-1 overflow-y-auto space-y-1">
            </div>
        <div class="pt-4 border-t border-white/10 space-y-2">
            <input type="file" id="importFile" hidden onchange="handleImport(this)">
            <button onclick="document.getElementById('importFile').click()" class="w-full py-2 bg-gray-700 hover:bg-gray-600 rounded text-sm transition">
                <i class="fas fa-upload mr-2"></i> Nhập .txt
            </button>
            <button onclick="exportCurrentFile()" class="w-full py-2 bg-gray-700 hover:bg-gray-600 rounded text-sm transition">
                <i class="fas fa-download mr-2"></i> Xuất .txt
            </button>
        </div>
    </aside>

    <main class="flex-1 p-4 md:p-8 flex flex-col gap-6">
        <div class="glass-effect p-6 rounded-xl">
            <div class="flex justify-between items-center mb-4">
                <h1 id="currentFileName" class="text-2xl font-bold text-blue-400">AdbFilter.txt</h1>
                <div class="flex gap-2">
                    <button id="editBtn" onclick="toggleEdit()" class="px-4 py-1.5 bg-gray-700 hover:bg-gray-600 rounded-md text-sm">Sửa</button>
                    <button id="saveBtn" onclick="saveFilter()" disabled class="px-4 py-1.5 bg-green-600 hover:bg-green-500 disabled:opacity-50 rounded-md text-sm font-bold">Lưu</button>
                </div>
            </div>
            <div class="flex items-center bg-black/40 p-3 rounded-lg border border-white/5 text-sm">
                <span class="text-gray-500 mr-2 shrink-0">Raw:</span>
                <input id="rawUrl" type="text" readonly class="bg-transparent border-none outline-none text-blue-400 w-full" value="">
                <button onclick="copyLink()" class="ml-2 text-gray-400 hover:text-white"><i class="fas fa-copy"></i></button>
            </div>
        </div>

        <textarea id="editor" readonly class="flex-1 bg-[#1e1e1e] p-6 outline-none text-sm leading-relaxed text-gray-300 rounded-xl border border-white/10" placeholder="Nội dung filter..."></textarea>
    </main>

    <script>
       const SUPABASE_URL = 'https://mehpnuxvxongkdtgaeob.supabase.co';
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im1laHBudXh2eG9uZ2tkdGdhZW9iIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjU2MjgxMzIsImV4cCI6MjA4MTIwNDEzMn0.5XaDtVfw6t5ipKXUJ6f-BtusJLJdfiJ-TSUCvBAkZCw';

        const { createClient } = supabase;
        const client = createClient(SUPABASE_URL, SUPABASE_KEY);

        let currentFile = 'AdbFilter.txt';
        let isEditing = false;

        async function init() {
            await loadFileList();
            await loadFileData(currentFile);
        }

        // Lấy danh sách file từ DB
        async function loadFileList() {
            const { data } = await client.from('adblock_filters').select('name');
            const listEl = document.getElementById('fileList');
            listEl.innerHTML = data.map(f => `
                <div onclick="switchFile('${f.name}')" class="file-item p-3 rounded cursor-pointer transition hover:bg-white/5 flex justify-between group ${f.name === currentFile ? 'active' : ''}">
                    <span class="truncate">${f.name}</span>
                    <i onclick="deleteFile(event, '${f.name}')" class="fas fa-trash text-red-500 opacity-0 group-hover:opacity-100 transition"></i>
                </div>
            `).join('');
        }

        async function loadFileData(name) {
            currentFile = name;
            document.getElementById('currentFileName').innerText = name;
            const { data } = await client.from('adblock_filters').select('content').eq('name', name).single();
            document.getElementById('editor').value = data ? data.content : '';
            
            const { data: urlData } = client.storage.from('public-filters').getPublicUrl(name);
            document.getElementById('rawUrl').value = urlData.publicUrl;
            await loadFileList();
        }

        async function switchFile(name) {
            if (isEditing) { if(!confirm("Bạn chưa lưu thay đổi. Chuyển file?")) return; toggleEdit(); }
            await loadFileData(name);
        }

        async function createNewFilter() {
            const name = prompt("Nhập tên file (ví dụ: myrules.txt):");
            if (!name || !name.endsWith('.txt')) return alert("Tên phải kết thúc bằng .txt");
            await client.from('adblock_filters').insert({ name, content: '! New Filter' });
            await loadFileData(name);
        }

        async function saveFilter() {
            const content = document.getElementById('editor').value;
            const { error } = await client.from('adblock_filters').update({ content }).eq('name', currentFile);
            
            const blob = new Blob([content], { type: 'text/plain' });
            await client.storage.from('public-filters').upload(currentFile, blob, { upsert: true });
            
            alert("✅ Đã lưu!");
            toggleEdit();
        }

        // Xuất file .txt
        function exportCurrentFile() {
            const content = document.getElementById('editor').value;
            const blob = new Blob([content], { type: 'text/plain' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = currentFile;
            a.click();
        }

        // Nhập file .txt
        function handleImport(input) {
            const file = input.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = (e) => {
                document.getElementById('editor').value = e.target.result;
                if (!isEditing) toggleEdit();
                alert("Đã nhập nội dung! Nhấn LƯU để áp dụng.");
            };
            reader.readAsText(file);
        }

        function toggleEdit() {
            isEditing = !isEditing;
            const ed = document.getElementById('editor');
            ed.readOnly = !isEditing;
            document.getElementById('saveBtn').disabled = !isEditing;
            document.getElementById('editBtn').innerText = isEditing ? "Hủy" : "Sửa";
            if(isEditing) ed.focus();
        }

        function copyLink() {
            navigator.clipboard.writeText(document.getElementById('rawUrl').value);
            alert("Đã copy link!");
        }

        init();
    </script>
</body>
</html>