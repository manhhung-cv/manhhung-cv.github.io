<!DOCTYPE html>
<html lang="vi">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Sổ Nợ Cá Nhân - iOS Liquid v5</title>
    <!-- Tích hợp Font & Icon -->
     <meta name="apple-mobile-web-app-status-bar-style" content="black">

    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css"
        xintegrity="sha512-SnH5WK+bZxgPHs44uWIX+LLJAJ9/2PkPKZ5QiAj6Ta86w+fsb2TkcmfRyVX3pBnMFcV7oQPJkl9QevSCWr3W6A=="
        crossorigin="anonymous" referrerpolicy="no-referrer" />
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">



    <!-- Biểu tượng cho web -->
    <link rel="icon" href="/Asset/logo/logo.png">

    <!-- Biểu tượng iPhone -->
    <link rel="apple-touch-icon" href="/Asset/logo/logo.png" sizes="150x150">

    <!-- Primary Meta Tags -->
    <title>Hunq PayGate</title>
    <meta name="title" content="Hunq PayGate" />
    <meta name="description" content="Cổng thanh toán của Đinh Mạnh Hùng" />

    <style>
        /* --- HỆ THỐNG GIAO DIỆN "LIQUID GLASS" --- */
        :root {
            /* Bảng màu - Chế độ Sáng */
            --bg-color: #f0f2f5;
            --bg-gradient: radial-gradient(circle at 10% 20%, rgba(137, 211, 255, 0.2), transparent 50%),
                radial-gradient(circle at 80% 90%, rgba(255, 168, 229, 0.2), transparent 50%);
            --glass-bg: rgba(255, 255, 255, 0.5);
            --glass-border: rgba(255, 255, 255, 0.8);
            --text-primary: #1d1d1f;
            --text-secondary: #6e6e73;
            --accent-color-start: #007aff;
            --accent-color-end: #0a84ff;
            --danger-color: #ff3b30;
            --success-color: #34c759;
            --shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.1);
            --br-lg: 24px;
            --br-md: 16px;
            --br-sm: 12px;
            --glass-opacity: 0.5;
        }

        html[data-theme="dark"] {
            /* Bảng màu - Chế độ Tối */
            --bg-color: #000000;
            --bg-gradient: radial-gradient(circle at 10% 20%, rgba(0, 122, 255, 0.2), transparent 50%),
                radial-gradient(circle at 80% 90%, rgba(255, 45, 85, 0.15), transparent 50%);
            --glass-bg: rgba(29, 29, 31, 0.6);
            --glass-border: rgba(255, 255, 255, 0.1);
            --text-primary: #f5f5f7;
            --text-secondary: #86868b;
            --accent-color-start: #0a84ff;
            --accent-color-end: #3499ff;
            --danger-color: #ff453a;
            --success-color: #32d74b;
            --shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.25);
            --glass-opacity: 0.6;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, "Helvetica Neue", "Arial", sans-serif;
        }

        body {
            background-color: var(--bg-color);
            background-image: var(--bg-gradient);
            background-attachment: fixed;
            color: var(--text-primary);
            line-height: 1.5;
            font-size: 16px;
            transition: background-color 0.4s, color 0.4s;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }

        .container {
            max-width: 1000px;
            margin: 0 auto;
            padding: 30px 20px;
        }

        .hidden {
            display: none !important;
        }

        .glass-ui {
            background: rgba(from var(--glass-bg) r g b / var(--glass-opacity));
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border: 1px solid var(--glass-border);
            border-radius: var(--br-lg);
            box-shadow: var(--shadow);
            transition: background 0.4s ease;
        }

        .main-title {
            font-size: 2.5em;
            font-weight: 800;
            text-align: center;
            margin-bottom: 30px;
        }

        .dashboard {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 25px;
            margin-bottom: 40px;
        }

        .card {
            padding: 25px;
        }

        .card h3 {
            margin-bottom: 15px;
            font-size: 1em;
            font-weight: 500;
            color: var(--text-secondary);
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .amount-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(100px, 1fr));
            gap: 15px;
        }

        .currency-total {
            font-size: 1.5em;
            font-weight: 700;
            letter-spacing: -1px;
            line-height: 1.2;
        }

        .currency-total span {
            display: block;
        }

        .currency-label {
            font-size: 0.6em;
            font-weight: 500;
            color: var(--text-secondary);
        }


        .debt-list-container h2 {
            font-size: 1.5em;
            font-weight: 600;
            padding: 0 0 20px 10px;
        }

        .debt-list {
            display: grid;
            grid-template-columns: 1fr;
            gap: 20px;
        }

        .debt-item {
            padding: 20px;
            transition: transform 0.2s ease, box-shadow 0.2s ease;
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .debt-item-main {
            flex-grow: 1;
            cursor: pointer;
        }

        .debt-item:hover {
            transform: scale(1.02);
            box-shadow: 0 12px 40px rgba(0, 0, 0, 0.15);
        }

        .debt-item-header {
            display: flex;
            align-items: center;
            gap: 15px;
            margin-bottom: 15px;
        }

        .debt-item-icon {
            font-size: 1.2em;
            width: 40px;
            height: 40px;
            display: grid;
            place-items: center;
            border-radius: 50%;
        }

        .debt-item-icon.thu {
            background-color: rgba(52, 199, 89, 0.15);
            color: var(--success-color);
        }

        .debt-item-icon.chi {
            background-color: rgba(255, 59, 48, 0.15);
            color: var(--danger-color);
        }

        .debt-item-info h4 {
            font-size: 1.1em;
            font-weight: 600;
        }

        .debt-item-amount {
            margin-left: auto;
            text-align: right;
        }

        .debt-item-amount .remaining {
            font-size: 1.2em;
            font-weight: 600;
        }

        .progress-bar-container {
            width: 100%;
            height: 6px;
            background-color: rgba(120, 120, 128, 0.16);
            border-radius: 3px;
            overflow: hidden;
            margin-top: 10px;
        }

        .progress-bar {
            height: 100%;
            background: linear-gradient(90deg, var(--accent-color-start), var(--accent-color-end));
            transition: width 0.5s cubic-bezier(0.2, 0.8, 0.2, 1);
        }

        .btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            padding: 14px 25px;
            border: none;
            border-radius: 50px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
            font-size: 1em;
        }

        .btn-primary {
            background: linear-gradient(45deg, var(--accent-color-start), var(--accent-color-end));
            color: white;
            box-shadow: 0 4px 15px rgba(0, 122, 255, 0.3);
        }

        .btn-primary:hover {
            transform: translateY(-3px);
            box-shadow: 0 7px 20px rgba(0, 122, 255, 0.4);
        }

        .btn-secondary {
            background: var(--glass-bg);
            border: 1px solid var(--glass-border);
            color: var(--text-primary);
        }

        .btn-secondary:hover {
            background: rgba(120, 120, 128, 0.2);
        }

        .btn-subtle {
            background: rgba(120, 120, 128, 0.1);
            color: var(--text-primary);
            border-radius: var(--br-md);
            padding: 10px 15px;
            border: none;
        }

        .btn-subtle:hover {
            background: rgba(120, 120, 128, 0.2);
        }

        .btn-danger {
            background-color: var(--danger-color);
            color: white;
        }

        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 1000;
            background-color: rgba(0, 0, 0, 0.4);
            backdrop-filter: blur(5px);
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }

        .modal-content {
            animation: slide-up-fade 0.4s cubic-bezier(0.16, 1, 0.3, 1);
            padding: 0;
            width: 100%;
            max-width: 500px;
        }

        @keyframes slide-up-fade {
            from {
                transform: translateY(30px);
                opacity: 0;
            }

            to {
                transform: translateY(0);
                opacity: 1;
            }
        }

        .modal-header {
            padding: 20px 25px;
            border-bottom: 1px solid var(--glass-border);
            position: relative;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-header .btn-subtle {
            padding: 5px 10px;
            font-size: 0.8em;
            border-radius: var(--br-sm);
        }

        .modal-body {
            padding: 25px;
            max-height: 70vh;
            overflow-y: auto;
        }

        .modal-footer {
            padding: 20px 25px;
            border-top: 1px solid var(--glass-border);
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 15px;
        }

        .close-btn {
            width: 32px;
            height: 32px;
            background: rgba(120, 120, 128, 0.2);
            color: var(--text-secondary);
            border: none;
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
            position: absolute;
            top: 15px;
            right: 15px;
        }

        .close-btn:hover {
            background: rgba(120, 120, 128, 0.4);
            color: var(--text-primary);
        }

        .form-group {
            margin-bottom: 25px;
        }

        .form-group label {
            display: block;
            margin-bottom: 10px;
            font-weight: 500;
            color: var(--text-secondary);
        }

        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 14px 5px;
            border: none;
            background: transparent;
            font-size: 1.1em;
            transition: all 0.3s ease;
            color: var(--text-primary);
            border-bottom: 2px solid rgba(120, 120, 128, 0.2);
        }

        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            outline: none;
            border-image: linear-gradient(to right, var(--accent-color-start), var(--accent-color-end)) 1;
        }

        .search-container {
            position: relative;
            margin: 40px auto;
            max-width: 600px;
        }

        #search-input {
            width: 100%;
            padding: 18px 25px 18px 60px;
            font-size: 1.1em;
            border-radius: 50px;
            background: var(--glass-bg);
            border: 1px solid var(--glass-border);
            color: var(--text-primary);
        }

        #search-input::placeholder {
            color: var(--text-secondary);
        }

        .search-container::before {
            content: "\f002";
            font-family: "Font Awesome 6 Free";
            font-weight: 900;
            position: absolute;
            left: 25px;
            top: 50%;
            transform: translateY(-50%);
            color: var(--text-secondary);
            font-size: 1.2em;
        }

        .form-stepper {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin-bottom: 30px;
        }

        .step-dot {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            background-color: rgba(120, 120, 128, 0.2);
            transition: all 0.4s ease;
        }

        .step-dot.active {
            background: linear-gradient(45deg, var(--accent-color-start), var(--accent-color-end));
            transform: scale(1.3);
        }

        .form-step-content {
            display: none;
        }

        .form-step-content.active {
            display: block;
            animation: fade-in 0.5s ease;
        }

        @keyframes fade-in {
            from {
                opacity: 0;
                transform: translateY(10px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .label-with-checkbox {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }

        .checkbox-wrapper {
            display: flex;
            align-items: center;
            gap: 5px;
            cursor: pointer;
        }

        .checkbox-wrapper input {
            width: auto;
        }

        .checkbox-wrapper label {
            margin: 0;
            font-weight: normal;
            font-size: 1em;
            color: var(--text-secondary);
        }

        .loader {
            width: 50px;
            height: 50px;
            border: 4px solid var(--glass-bg);
            border-top-color: var(--accent-color-start);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            z-index: 2000;
        }

        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(360deg);
            }
        }

        .settings-section {
            margin-bottom: 30px;
        }

        .settings-section h3 {
            font-size: 1em;
            font-weight: 600;
            color: var(--text-secondary);
            margin-bottom: 15px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .setting-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 0;
            flex-wrap: wrap;
            gap: 10px;
        }

        .theme-switcher {
            display: flex;
            background: rgba(120, 120, 128, 0.1);
            border-radius: var(--br-md);
            padding: 4px;
        }

        .theme-switcher button {
            flex: 1;
            background: transparent;
            border: none;
            cursor: pointer;
            padding: 6px 8px;
            border-radius: var(--br-sm);
            color: var(--text-secondary);
            font-size: 14px;
            transition: all 0.2s ease;
        }

        .theme-switcher button.active {
            background: linear-gradient(45deg, var(--accent-color-start), var(--accent-color-end));
            color: white;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
        }

        #opacity-slider {
            width: 120px;
            -webkit-appearance: none;
            appearance: none;
            background: transparent;
            cursor: pointer;
        }

        #opacity-slider::-webkit-slider-runnable-track {
            height: 4px;
            background: rgba(120, 120, 128, 0.2);
            border-radius: 2px;
        }

        #opacity-slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            margin-top: -6px;
            height: 16px;
            width: 16px;
            background-color: white;
            border-radius: 50%;
            border: 1px solid var(--glass-border);
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        }

        .data-actions {
            display: flex;
            gap: 15px;
        }

        .payment-item-actions {
            display: flex;
            gap: 10px;
        }

        .payment-item-actions button,
        .payment-item-actions a {
            background: none;
            border: none;
            color: var(--text-secondary);
            cursor: pointer;
            font-size: 0.9em;
            padding: 5px;
            border-radius: 50%;
            width: 28px;
            height: 28px;
            display: grid;
            place-items: center;
            text-decoration: none;
        }

        .payment-item-actions button:hover,
        .payment-item-actions a:hover {
            background: rgba(120, 120, 128, 0.1);
            color: var(--text-primary);
        }

        .notification {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            padding: 12px 20px;
            border-radius: var(--br-md);
            color: white;
            font-weight: 500;
            z-index: 9999;
            opacity: 0;
            transition: opacity 0.3s ease, transform 0.3s ease;
            animation: fade-in-out 3s ease-in-out;
        }

        .notification.success {
            background: var(--success-color);
        }

        .notification.error {
            background: var(--danger-color);
        }

        @keyframes fade-in-out {

            0%,
            100% {
                opacity: 0;
                transform: translate(-50%, 10px);
            }

            10%,
            90% {
                opacity: 1;
                transform: translate(-50%, 0);
            }
        }


        @media (max-width: 820px) {
            .container {
                padding: 20px 15px;
                padding-bottom: 100px;
            }

            .main-title {
                font-size: 2em;
            }

            .debt-list {
                grid-template-columns: 1fr;
            }

            .modal-content {
                max-width: 95%;
            }

            .modal-footer {
                flex-wrap: wrap;
                justify-content: center;
            }
        }
    </style>
</head>

<body>

    <div id="loader" class="loader hidden"></div>

    <div id="auth-screen" class="container hidden">
        <div class="glass-ui" style="padding: 40px; width: 100%; max-width: 420px; margin: auto;">
            <form id="login-form">
                <h2 style="text-align: center; margin-bottom: 30px; font-weight: 600; font-size: 1.8em;">Đăng Nhập</h2>
                <div id="login-error" style="color:var(--danger-color); text-align:center; margin-bottom: 15px;"></div>
                <div class="form-group"><label for="login-email">Email</label><input type="email" id="login-email"
                        required></div>
                <div class="form-group"><label for="login-password">Mật khẩu</label><input type="password"
                        id="login-password" required></div>
                <button type="submit" class="btn btn-primary" style="width: 100%; margin-top: 10px;">Đăng Nhập</button>
            </form>
            <form id="register-form" class="hidden">
                <h2 style="text-align: center; margin-bottom: 30px; font-weight: 600; font-size: 1.8em;">Đăng Ký</h2>
                <div id="register-error" style="color:var(--danger-color); text-align:center; margin-bottom: 15px;">
                </div>
                <div class="form-group"><label for="register-email">Email</label><input type="email" id="register-email"
                        required></div>
                <div class="form-group"><label for="register-password">Mật khẩu (ít nhất 6 ký tự)</label><input
                        type="password" id="register-password" required></div>
                <button type="submit" class="btn btn-primary" style="width: 100%; margin-top: 10px;">Đăng Ký</button>
            </form>
            <form id="forgot-password-form" class="hidden">
                <h2 style="text-align: center; margin-bottom: 30px; font-weight: 600; font-size: 1.8em;">Quên Mật Khẩu
                </h2>
                <p style="color: var(--text-secondary); text-align: center; margin-bottom: 20px;">Nhập email của bạn để
                    nhận liên kết đặt lại mật khẩu.</p>
                <div class="form-group"><label for="forgot-email">Email</label><input type="email" id="forgot-email"
                        required></div>
                <button type="submit" class="btn btn-primary" style="width: 100%; margin-top: 10px;">Gửi liên
                    kết</button>
            </form>

            <p style="text-align: center; margin-top: 25px; color: var(--text-secondary);">
                <span id="auth-toggles">
                    <a href="#" id="forgot-password-link"
                        style="color: var(--accent-color-start); font-weight: 500; text-decoration: none;">Quên mật
                        khẩu?</a>
                    <span style="margin: 0 10px;">|</span>
                    <span id="toggle-to-register">Chưa có tài khoản? <a href="#"
                            style="color: var(--accent-color-start); font-weight: 600; text-decoration: none;">Đăng
                            ký</a></span>
                </span>
                <span id="toggle-to-login" class="hidden">Đã có tài khoản? <a href="#"
                        style="color: var(--accent-color-start); font-weight: 600; text-decoration: none;">Đăng
                        nhập</a></span>
            </p>
        </div>
    </div>

    <div id="app-screen" class="container hidden">
        <main>
            <h1 class="main-title">Sổ Nợ</h1>
            <section class="dashboard">
                <div class="card glass-ui">
                    <h3><i class="fas fa-hand-holding-usd"></i> Cho Vay Còn Lại</h3>
                    <div id="total-thu" class="amount-grid"></div>
                </div>
                <div class="card glass-ui">
                    <h3><i class="fas fa-file-invoice-dollar"></i> Nợ Còn Lại</h3>
                    <div id="total-chi" class="amount-grid"></div>
                </div>
            </section>

            <div class="search-container">
                <input type="search" id="search-input" placeholder="Tìm kiếm khoản nợ...">
            </div>

            <section class="debt-list-container">
                <h2>Tất cả giao dịch</h2>
                <div id="debt-list" class="debt-list"></div>
            </section>
        </main>
    </div>

    <div style="position: fixed; top: 20px; right: 20px; z-index: 100;">
        <button id="settings-btn" class="btn btn-secondary"
            style="width: 50px; height: 50px; padding: 0; font-size: 1.2em; border-radius: 50%;"><i
                class="fas fa-cog"></i></button>
    </div>
    <div style="position: fixed; bottom: 30px; right: 30px; z-index: 100;">
        <button id="add-debt-btn" class="btn btn-primary"
            style="width: 60px; height: 60px; padding: 0; font-size: 1.5em;"><i class="fas fa-plus"></i></button>
    </div>

    <div id="modal-container"></div>
    <input type="file" id="import-file-input" class="hidden" accept=".json">

    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-storage.js"></script>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // --- CÀI ĐẶT & BIẾN TOÀN CỤC ---
            const firebaseConfig = {
                apiKey: "AIzaSyC1qeU_x_mpm5g01B3lzNKkOq3PL9ymUAU",
                authDomain: "so-no-4d452.firebaseapp.com",
                projectId: "so-no-4d452",
                storageBucket: "so-no-4d452.appspot.com",
                messagingSenderId: "852098567588",
                appId: "1:852098567588:web:2840cbbe6bdaac04198531",
                measurementId: "G-D56RHF5F9C"
            };

            let storageMode = localStorage.getItem('storageMode') || 'local';
            let jpyDisplayMode = localStorage.getItem('jpyDisplayMode') || 'man'; // 'man' or 'yen'
            let currentUser = null;
            let debtsCollection = null;
            let unsubscribe = null;
            let debtsCache = [];
            let gradientColor1 = localStorage.getItem('gradientColor1') || '#89d3ff';
            let gradientColor2 = localStorage.getItem('gradientColor2') || '#ffa8e5';

            // --- DOM ELEMENTS ---
            const loader = document.getElementById('loader');
            const authScreen = document.getElementById('auth-screen');
            const appScreen = document.getElementById('app-screen');
            const loginForm = document.getElementById('login-form');
            const registerForm = document.getElementById('register-form');
            const forgotPasswordForm = document.getElementById('forgot-password-form');
            const authToggles = document.getElementById('auth-toggles');
            const toggleToRegister = document.getElementById('toggle-to-register');
            const toggleToLogin = document.getElementById('toggle-to-login');
            const forgotPasswordLink = document.getElementById('forgot-password-link');
            const loginError = document.getElementById('login-error');
            const registerError = document.getElementById('register-error');
            const totalThuEl = document.getElementById('total-thu');
            const totalChiEl = document.getElementById('total-chi');
            const debtListEl = document.getElementById('debt-list');
            const searchInput = document.getElementById('search-input');
            const addDebtBtn = document.getElementById('add-debt-btn');
            const settingsBtn = document.getElementById('settings-btn');
            const modalContainer = document.getElementById('modal-container');
            const importFileInput = document.getElementById('import-file-input');

            let auth, db, storage;

            // --- HÀM TIỆN ÍCH ---
            const showLoader = () => loader.classList.remove('hidden');
            const hideLoader = () => loader.classList.add('hidden');

            const showNotification = (message, type = 'success') => {
                const notification = document.createElement('div');
                notification.className = `notification ${type}`;
                notification.textContent = message;
                document.body.appendChild(notification);
                setTimeout(() => {
                    notification.remove();
                }, 3000);
            };

            const copyToClipboard = (text) => {
                const textArea = document.createElement("textarea");
                textArea.value = text;
                textArea.style.position = "fixed";
                textArea.style.left = "-9999px";
                document.body.appendChild(textArea);
                textArea.focus();
                textArea.select();
                try {
                    document.execCommand('copy');
                    showNotification('Đã sao chép vào clipboard!');
                } catch (err) {
                    showNotification('Sao chép thất bại', 'error');
                }
                document.body.removeChild(textArea);
            };

            const downloadAsFile = (text, filename) => {
                const blob = new Blob([text], { type: 'text/plain' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = filename;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
            };

            const formatCurrency = (num, currency) => {
                const effectiveCurrency = currency || 'VND';
                num = num || 0;

                if (effectiveCurrency === 'JPY') {
                    if (jpyDisplayMode === 'man' && Math.abs(num) >= 10000) {
                        const manPart = Math.floor(num / 10000);
                        const remainderPart = num % 10000;
                        const manFormatted = new Intl.NumberFormat('ja-JP').format(manPart);

                        if (remainderPart === 0) {
                            return `${manFormatted}万`;
                        } else {
                            const remainderFormatted = new Intl.NumberFormat('ja-JP').format(remainderPart);
                            return `${manFormatted}万${remainderFormatted}円`;
                        }
                    }
                    return new Intl.NumberFormat('ja-JP', { style: 'currency', currency: 'JPY' }).format(num);
                }
                const options = { style: 'currency', currency: effectiveCurrency, maximumFractionDigits: 0 };
                const locales = { 'VND': 'vi-VN', 'USD': 'en-US', 'EUR': 'de-DE' };
                return new Intl.NumberFormat(locales[effectiveCurrency] || 'vi-VN', options).format(num);
            };

            const formatDate = (dateString) => dateString ? new Date(dateString).toLocaleDateString('vi-VN') : 'Vô thời hạn';
            const getRawAmount = (formattedAmount) => Number(String(formattedAmount).replace(/[^0-9]/g, ''));
            const showScreen = (screen) => { authScreen.classList.add('hidden'); appScreen.classList.add('hidden'); screen.classList.remove('hidden'); };
            const closeModal = () => modalContainer.innerHTML = '';

            // --- LOGIC GIAO DIỆN & CHỦ ĐỀ ---
            const hexToRgb = (hex) => {
                let result = /^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(hex);
                return result ? {
                    r: parseInt(result[1], 16),
                    g: parseInt(result[2], 16),
                    b: parseInt(result[3], 16)
                } : null;
            };

            const applyGradientColors = (hex1, hex2) => {
                const rgb1 = hexToRgb(hex1);
                const rgb2 = hexToRgb(hex2);
                if (rgb1 && rgb2) {
                    const gradient = `radial-gradient(circle at 10% 20%, rgba(${rgb1.r}, ${rgb1.g}, ${rgb1.b}, 0.2), transparent 50%), radial-gradient(circle at 80% 90%, rgba(${rgb2.r}, ${rgb2.g}, ${rgb2.b}, 0.2), transparent 50%)`;
                    document.documentElement.style.setProperty('--bg-gradient', gradient);
                }
            };

            const applyTheme = (theme) => {
                const htmlEl = document.documentElement;
                htmlEl.removeAttribute('data-theme');
                if (theme === 'dark') htmlEl.setAttribute('data-theme', 'dark');
                else if (theme === 'system') {
                    if (window.matchMedia?.('(prefers-color-scheme: dark)').matches) {
                        htmlEl.setAttribute('data-theme', 'dark');
                    }
                }
                const settingsModal = document.getElementById('settings-modal');
                if (settingsModal) {
                    const themeButtons = settingsModal.querySelectorAll('.theme-switcher button');
                    themeButtons.forEach(btn => btn.classList.toggle('active', btn.dataset.themeValue === theme));
                }
            };

            const applyOpacity = (value) => {
                document.documentElement.style.setProperty('--glass-opacity', value / 100);
            };

            const loadInitialSettings = () => {
                const savedTheme = localStorage.getItem('theme') || 'system';
                const savedOpacity = localStorage.getItem('glassOpacity') || '60';
                applyTheme(savedTheme);
                applyOpacity(savedOpacity);
                applyGradientColors(gradientColor1, gradientColor2);
            };

            // --- DỊCH VỤ LƯU TRỮ (STORAGE SERVICE) ---
            const storageService = {
                init: (mode, user) => {
                    storageMode = mode;
                    localStorage.setItem('storageMode', mode);
                    if (mode === 'firebase' && user) {
                        currentUser = user;
                        debtsCollection = db.collection('users').doc(user.uid).collection('debts');
                    } else {
                        currentUser = null;
                        debtsCollection = null;
                    }
                },
                add: async (debtData) => {
                    debtData.createdAt = new Date().toISOString();
                    debtData.updatedAt = new Date().toISOString();
                    debtData.payments = [];
                    debtData.totalPaid = 0;
                    debtData.status = 'pending';
                    if (storageMode === 'firebase') return await debtsCollection.add(debtData);
                    else {
                        const debts = storageService.getAll();
                        debtData.id = Date.now().toString();
                        debts.push(debtData);
                        localStorage.setItem('debts', JSON.stringify(debts));
                        filterAndRender();
                    }
                },
                getAll: () => storageMode === 'firebase' ? [] : JSON.parse(localStorage.getItem('debts')) || [],
                update: async (id, updates) => {
                    updates.updatedAt = new Date().toISOString();
                    if (storageMode === 'firebase') return await debtsCollection.doc(id).update(updates);
                    else {
                        let debts = storageService.getAll();
                        debts = debts.map(d => d.id === id ? { ...d, ...updates } : d);
                        localStorage.setItem('debts', JSON.stringify(debts));
                        filterAndRender();
                    }
                },
                delete: async (id) => {
                    if (storageMode === 'firebase') {
                        const debt = debtsCache.find(d => d.id === id);
                        if (debt && debt.payments) {
                            for (const payment of debt.payments) {
                                if (payment.imagePath) {
                                    try { await storage.ref(payment.imagePath).delete(); }
                                    catch (error) { console.warn("Could not delete image:", error); }
                                }
                            }
                        }
                        return await debtsCollection.doc(id).delete();
                    } else {
                        let debts = storageService.getAll();
                        debts = debts.filter(d => d.id !== id);
                        localStorage.setItem('debts', JSON.stringify(debts));
                        filterAndRender();
                    }
                },
                addPayment: async (debtId, payment) => {
                    if (storageMode === 'firebase') {
                        const debtRef = debtsCollection.doc(debtId);
                        return db.runTransaction(async (transaction) => {
                            const debtDoc = await transaction.get(debtRef);
                            if (!debtDoc.exists) throw "Khoản nợ không tồn tại!";
                            const debtData = debtDoc.data();
                            const newPayments = [...(debtData.payments || []), payment];
                            const newTotalPaid = newPayments.reduce((sum, p) => sum + p.amount, 0);
                            transaction.update(debtRef, {
                                payments: newPayments,
                                totalPaid: newTotalPaid,
                                status: newTotalPaid >= debtData.amount ? 'paid' : 'pending',
                                updatedAt: new Date().toISOString()
                            });
                        });
                    } else {
                        let debts = storageService.getAll();
                        const debt = debts.find(d => d.id === debtId);
                        if (!debt) throw "Khoản nợ không tồn tại!";
                        debt.payments = [...(debt.payments || []), payment];
                        debt.totalPaid = debt.payments.reduce((sum, p) => sum + p.amount, 0);
                        debt.status = debt.totalPaid >= debt.amount ? 'paid' : 'pending';
                        debt.updatedAt = new Date().toISOString();
                        localStorage.setItem('debts', JSON.stringify(debts));
                        filterAndRender();
                    }
                },
                listen: (callback) => {
                    if (storageMode === 'firebase' && debtsCollection) {
                        if (unsubscribe) unsubscribe();
                        unsubscribe = debtsCollection.orderBy('createdAt', 'desc').onSnapshot(snapshot => {
                            const debts = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                            callback(debts);
                        }, error => {
                            console.error("Lỗi Firestore:", error);
                            showNotification("Không thể tải dữ liệu từ Cloud.", 'error');
                            hideLoader();
                        });
                    }
                },
                importData: async (newDebts) => {
                    if (!Array.isArray(newDebts)) {
                        showNotification("Lỗi: Dữ liệu import không hợp lệ.", 'error');
                        return;
                    }
                    if (storageMode === 'firebase') {
                        const batch = db.batch();
                        const oldSnapshot = await debtsCollection.get();
                        oldSnapshot.docs.forEach(doc => batch.delete(doc.ref));
                        newDebts.forEach(debt => {
                            const { id, ...debtData } = debt;
                            const newDocRef = debtsCollection.doc();
                            batch.set(newDocRef, debtData);
                        });
                        await batch.commit();
                    } else {
                        localStorage.setItem('debts', JSON.stringify(newDebts));
                        debtsCache = newDebts;
                        filterAndRender();
                    }
                }
            };

            // --- RENDER & UI LOGIC ---
            const filterAndRender = () => {
                const searchTerm = searchInput.value.toLowerCase().trim();
                const filteredDebts = debtsCache.filter(debt =>
                    debt.name.toLowerCase().includes(searchTerm) ||
                    (debt.reason && debt.reason.toLowerCase().includes(searchTerm))
                );
                renderUI(filteredDebts);
            };

            const renderUI = (debtsToRender) => {
                if (searchInput.value.trim() === '') {
                    debtsCache.sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt));
                    debtsToRender = debtsCache;
                }

                debtListEl.innerHTML = '';
                const totals = debtsCache.reduce((acc, debt) => {
                    const currency = debt.currency || 'VND';
                    if (!acc[currency]) {
                        acc[currency] = { thu: 0, chi: 0 };
                    }
                    const remaining = debt.amount - (debt.totalPaid || 0);
                    if (debt.status !== 'paid') {
                        if (debt.type === 'thu') {
                            acc[currency].thu += remaining;
                        } else {
                            acc[currency].chi += remaining;
                        }
                    }
                    return acc;
                }, {});

                totalThuEl.innerHTML = Object.keys(totals).length > 0 ? Object.keys(totals).map(curr => `
                    <div class="currency-total">
                        <span class="currency-label">${curr}</span>
                        <span class="currency-value">${formatCurrency(totals[curr].thu, curr)}</span>
                    </div>
                `).join('') : '<div class="currency-total"><span class="currency-value">0</span></div>';

                totalChiEl.innerHTML = Object.keys(totals).length > 0 ? Object.keys(totals).map(curr => `
                    <div class="currency-total">
                        <span class="currency-label">${curr}</span>
                        <span class="currency-value">${formatCurrency(totals[curr].chi, curr)}</span>
                    </div>
                `).join('') : '<div class="currency-total"><span class="currency-value">0</span></div>';


                if (debtsToRender.length === 0) {
                    debtListEl.innerHTML = `<p style="text-align:center; color: var(--text-secondary); padding: 40px 0;">Chưa có khoản nợ nào. Hãy bắt đầu bằng cách nhấn nút +</p>`;
                } else {
                    debtsToRender.forEach(debt => {
                        const totalPaid = debt.totalPaid || 0;
                        const remaining = debt.amount - totalPaid;
                        const progress = debt.amount > 0 ? (totalPaid / debt.amount) * 100 : 100;

                        console.log(debt.totalPaid);
                        
                        const debtEl = document.createElement('div');
                        debtEl.className = 'debt-item glass-ui';
                        debtEl.innerHTML = `
                            <div class="debt-item-main">
                                <div class="debt-item-header">
                                    <div class="debt-item-icon ${debt.type}">
                                        <i class="fas ${debt.type === 'thu' ? 'fa-arrow-up' : 'fa-arrow-down'}"></i>
                                    </div>
                                    <div class="debt-item-info">
                                        <h4>${debt.name}</h4>
                                        <p style="color:var(--text-secondary)">${debt.reason || ''}</p>
                                    </div>
                                    <div class="debt-item-amount">
                                        <div class="remaining">${formatCurrency(remaining, debt.currency)}</div>
                                        <div class="total" style="color:var(--text-secondary)">${formatCurrency(debt.totalPaid, debt.currency)} / ${formatCurrency(debt.amount, debt.currency)}</div>
                                    </div>
                                </div>
                                <div class="progress-bar-container">
                                    <div class="progress-bar" style="width: ${progress}%"></div>
                                </div>
                            </div>
                            <button class="btn-subtle download-history-btn-list" data-id="${debt.id}" title="Tải lịch sử">
                                <i class="fas fa-download"></i>
                            </button>`;
                        debtEl.querySelector('.debt-item-main').addEventListener('click', () => openDetailModal(debt.id));
                        debtListEl.appendChild(debtEl);
                    });
                }
            };

            // --- MODAL FACTORY & TYPES ---
            const createModal = (id, content) => {
                const modalWrapper = document.createElement('div');
                modalWrapper.className = 'modal';
                modalWrapper.id = id;
                modalWrapper.innerHTML = content;
                modalContainer.appendChild(modalWrapper);
                modalWrapper.addEventListener('click', (e) => { if (e.target === modalWrapper) closeModal(); });
                return modalWrapper;
            };

            const handleSwitchMode = async () => {
                closeModal();
                const newMode = storageMode === 'firebase' ? 'local' : 'firebase';

                if (newMode === 'firebase') {
                    if (auth.currentUser) await auth.signOut();
                    showScreen(authScreen);
                } else {
                    if (!currentUser) return showNotification("Lỗi: Không có người dùng nào đăng nhập.", 'error');
                    if (!confirm("CẢNH BÁO: Chuyển sang lưu trữ Cục bộ?\n\nDữ liệu trên Cloud của bạn sẽ được TẢI VỀ và sau đó bị XÓA VĨNH VIỄN. Hành động này không thể hoàn tác.")) return;

                    showLoader();
                    try {
                        const snapshot = await debtsCollection.get();
                        const firebaseDebts = snapshot.docs.map(doc => ({ ...doc.data(), id: doc.id }));
                        const localDebts = firebaseDebts.map(({ id, ...rest }) => ({ ...rest, id: Date.now().toString() + Math.random().toString(36).substr(2, 9) }));
                        localStorage.setItem('debts', JSON.stringify(localDebts));

                        const batch = db.batch();
                        snapshot.docs.forEach(doc => batch.delete(doc.ref));
                        await batch.commit();

                        localStorage.setItem('storageMode', 'local');
                        await auth.signOut();

                        showNotification("Chuyển đổi thành công! Ứng dụng sẽ tải lại.");
                        setTimeout(() => window.location.reload(), 1500);
                    } catch (error) {
                        console.error("Lỗi chuyển đổi sang Cục bộ:", error);
                        showNotification("Lỗi chuyển đổi. Dữ liệu vẫn an toàn trên Cloud.", 'error');
                        hideLoader();
                    }
                }
            };

            const openSettingsModal = () => {
                const savedOpacity = localStorage.getItem('glassOpacity') || '60';
                const savedTheme = localStorage.getItem('theme') || 'system';

                const storageModeText = storageMode === 'firebase' ? `Cloud (${currentUser?.email || '...'})` : 'Cục bộ (trên máy này)';
                const switchButtonText = storageMode === 'firebase' ? 'Đăng xuất & Chuyển sang Cục bộ' : 'Đăng nhập & Chuyển sang Cloud';

                const modalHTML = `
                    <div class="modal-content glass-ui">
                        <div class="modal-header">
                            <h2>Cài Đặt</h2>
                            <button class="close-btn"><i class="fas fa-times"></i></button>
                        </div>
                        <div class="modal-body">
                            <div class="settings-section">
                                <h3>Giao diện</h3>
                                <div class="setting-item">
                                    <span>Chủ đề</span>
                                    <div class="theme-switcher">
                                        <button data-theme-value="light" title="Sáng" class="${savedTheme === 'light' ? 'active' : ''}"><i class="fas fa-sun"></i></button>
                                        <button data-theme-value="dark" title="Tối" class="${savedTheme === 'dark' ? 'active' : ''}"><i class="fas fa-moon"></i></button>
                                        <button data-theme-value="system" title="Hệ thống" class="${savedTheme === 'system' ? 'active' : ''}"><i class="fas fa-desktop"></i></button>
                                    </div>
                                </div>
                                <div class="setting-item">
                                    <span>Độ trong suốt</span>
                                    <input type="range" id="opacity-slider" min="20" max="95" value="${savedOpacity}">
                                </div>
                                <div class="setting-item">
                                    <span>Hiển thị JPY</span>
                                    <select id="jpy-display-select" class="btn-subtle">
                                        <option value="man" ${jpyDisplayMode === 'man' ? 'selected' : ''}>Theo Vạn (万)</option>
                                        <option value="yen" ${jpyDisplayMode === 'yen' ? 'selected' : ''}>Theo Yên (¥)</option>
                                    </select>
                                </div>
                                <div class="setting-item">
                                    <span>Màu nền 1</span>
                                    <input type="color" id="gradient-color-1" value="${gradientColor1}">
                                </div>
                                <div class="setting-item">
                                    <span>Màu nền 2</span>
                                    <input type="color" id="gradient-color-2" value="${gradientColor2}">
                                </div>
                            </div>
                            <div class="settings-section">
                                <h3>Dữ liệu</h3>
                                <div class="setting-item">
                                    <span>Chế độ hiện tại</span>
                                    <span style="font-weight: 600; color: var(--text-primary);">${storageModeText}</span>
                                </div>
                                <div class="setting-item">
                                    <span>Chuyển đổi chế độ</span>
                                    <button id="switch-mode-btn" class="btn btn-secondary">${switchButtonText}</button>
                                </div>
                                <div class="setting-item">
                                    <span>Sao lưu & Phục hồi</span>
                                    <div class="data-actions">
                                        <button id="import-data-btn" class="btn btn-subtle"><i class="fas fa-upload"></i> Nhập</button>
                                        <button id="export-data-btn" class="btn btn-subtle"><i class="fas fa-download"></i> Xuất</button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
                const modal = createModal('settings-modal', modalHTML);

                modal.querySelector('.close-btn').addEventListener('click', closeModal);
                modal.querySelectorAll('.theme-switcher button').forEach(button => {
                    button.addEventListener('click', (e) => {
                        e.stopPropagation();
                        const newTheme = button.dataset.themeValue;
                        localStorage.setItem('theme', newTheme);
                        applyTheme(newTheme);
                    });
                });

                const opacitySlider = modal.querySelector('#opacity-slider');
                opacitySlider.addEventListener('input', (e) => applyOpacity(e.target.value));
                opacitySlider.addEventListener('change', (e) => localStorage.setItem('glassOpacity', e.target.value));

                modal.querySelector('#jpy-display-select').addEventListener('change', (e) => {
                    jpyDisplayMode = e.target.value;
                    localStorage.setItem('jpyDisplayMode', jpyDisplayMode);
                    filterAndRender();
                });

                const colorPicker1 = modal.querySelector('#gradient-color-1');
                const colorPicker2 = modal.querySelector('#gradient-color-2');
                colorPicker1.addEventListener('input', (e) => {
                    gradientColor1 = e.target.value;
                    localStorage.setItem('gradientColor1', gradientColor1);
                    applyGradientColors(gradientColor1, gradientColor2);
                });
                colorPicker2.addEventListener('input', (e) => {
                    gradientColor2 = e.target.value;
                    localStorage.setItem('gradientColor2', gradientColor2);
                    applyGradientColors(gradientColor1, gradientColor2);
                });

                modal.querySelector('#export-data-btn').addEventListener('click', () => {
                    const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(debtsCache, null, 2));
                    downloadAsFile(dataStr, `sono_backup_${new Date().toISOString().split('T')[0]}.json`);
                });

                modal.querySelector('#import-data-btn').addEventListener('click', () => importFileInput.click());
                modal.querySelector('#switch-mode-btn').addEventListener('click', handleSwitchMode);
            };

            const handleImportFile = (event) => {
                const file = event.target.files[0];
                if (!file) return;
                const reader = new FileReader();
                reader.onload = async (e) => {
                    try {
                        const importedDebts = JSON.parse(e.target.result);
                        if (confirm("Bạn có chắc muốn nhập dữ liệu này? Dữ liệu hiện tại sẽ bị GHI ĐÈ.")) {
                            showLoader();
                            await storageService.importData(importedDebts);
                            showNotification("Nhập dữ liệu thành công!");
                            closeModal();
                        }
                    } catch (err) {
                        console.error("Lỗi đọc file JSON:", err);
                        showNotification("File không hợp lệ hoặc bị lỗi.", 'error');
                    } finally {
                        hideLoader();
                        importFileInput.value = '';
                    }
                };
                reader.readAsText(file);
            };

            const openAddEditModal = (debt = null) => {
                const modalId = 'add-edit-modal';
                const modalHTML = `
                    <div class="modal-content glass-ui">
                        <div class="modal-header">
                            <h2 id="modal-title">${debt ? 'Chỉnh Sửa' : 'Thêm'} Khoản Nợ</h2>
                            <button class="close-btn"><i class="fas fa-times"></i></button>
                        </div>
                        <form id="debt-form">
                            <div class="modal-body">
                                <div class="form-stepper">
                                    <div class="step-dot active" data-step="1"></div>
                                    <div class="step-dot" data-step="2"></div>
                                </div>
                                <input type="hidden" id="debt-id" value="${debt?.id || ''}">

                                <div class="form-step-content active" data-step="1">
                                    <div class="form-group"><label>Phân loại</label><select id="debt-type" required><option value="thu" ${debt?.type === 'thu' ? 'selected' : ''}>Cho Vay</option><option value="chi" ${debt?.type === 'chi' ? 'selected' : ''}>Nợ</option></select></div>
                                    <div class="form-group"><label>Tên người liên quan</label><input type="text" id="debt-name" value="${debt?.name || ''}" required></div>
                                    <div class="form-group">
                                        <label>Loại tiền tệ</label>
                                        <select id="debt-currency" required>
                                            <option value="VND" ${!debt || debt?.currency === 'VND' ? 'selected' : ''}>VND</option>
                                            <option value="USD" ${debt?.currency === 'USD' ? 'selected' : ''}>USD</option>
                                            <option value="JPY" ${debt?.currency === 'JPY' ? 'selected' : ''}>JPY</option>
                                        </select>
                                    </div>
                                    <div class="form-group"><label>Số tiền</label><input type="text" id="debt-amount-input" value="${debt ? (debt.amount || '') : ''}" required inputmode="numeric"></div>
                                </div>
                                <div class="form-step-content" data-step="2">
                                    <div class="form-group"><label>Nội dung</label><textarea id="debt-reason" rows="2">${debt?.reason || ''}</textarea></div>
                                    <div class="form-group">
                                        <div class="label-with-checkbox"><label for="debt-due-date">Ngày hẹn trả</label><div class="checkbox-wrapper"><input type="checkbox" id="no-due-date-checkbox" ${debt?.dueDate === null ? 'checked' : ''}><label for="no-due-date-checkbox">Không thời hạn</label></div></div>
                                        <input type="date" id="debt-due-date" value="${debt?.dueDate || ''}" required>
                                    </div>
                                    <div class="form-group"><label>Ngày giao dịch</label><input type="date" id="debt-date" value="${debt?.date || new Date().toISOString().split('T')[0]}" required></div>
                                </div>
                            </div>
                            <div class="modal-footer">
                                <button type="button" id="prev-step-btn" class="btn btn-secondary hidden"><i class="fas fa-arrow-left"></i> Quay lại</button>
                                <div style="display:flex; gap: 15px;">
                                    <button type="button" class="btn btn-secondary" id="cancel-btn">Hủy</button>
                                    <button type="button" id="next-step-btn" class="btn btn-primary">Tiếp theo <i class="fas fa-arrow-right"></i></button>
                                    <button type="submit" id="save-debt-btn" class="btn btn-primary hidden"><i class="fas fa-save"></i> Lưu</button>
                                </div>
                            </div>
                        </form>
                    </div>`;
                const modal = createModal(modalId, modalHTML);

                let currentStep = 1;
                const formSteps = modal.querySelectorAll('.form-step-content');
                const stepDots = modal.querySelectorAll('.step-dot');
                const prevBtn = modal.querySelector('#prev-step-btn');
                const nextBtn = modal.querySelector('#next-step-btn');
                const saveBtn = modal.querySelector('#save-debt-btn');
                const cancelBtn = modal.querySelector('#cancel-btn');

                const updateStepper = () => {
                    stepDots.forEach((dot, index) => dot.classList.toggle('active', index + 1 === currentStep));
                    formSteps.forEach(step => step.classList.toggle('active', parseInt(step.dataset.step) === currentStep));
                    prevBtn.classList.toggle('hidden', currentStep === 1);
                    nextBtn.classList.toggle('hidden', currentStep === formSteps.length);
                    saveBtn.classList.toggle('hidden', currentStep !== formSteps.length);
                    cancelBtn.classList.toggle('hidden', currentStep === formSteps.length);
                };

                const validateStep = (step) => {
                    const inputs = formSteps[step - 1].querySelectorAll('[required]');
                    for (const input of inputs) {
                        if (!input.disabled && !input.value.trim()) {
                            showNotification(`Vui lòng điền đầy đủ thông tin.`, 'error');
                            input.focus();
                            return false;
                        }
                    }
                    return true;
                };

                nextBtn.addEventListener('click', () => {
                    if (validateStep(currentStep) && currentStep < formSteps.length) {
                        currentStep++;
                        updateStepper();
                    }
                });
                prevBtn.addEventListener('click', () => {
                    if (currentStep > 1) {
                        currentStep--;
                        updateStepper();
                    }
                });

                modal.querySelector('.close-btn').addEventListener('click', closeModal);
                cancelBtn.addEventListener('click', closeModal);
                modal.querySelector('#debt-form').addEventListener('submit', handleSaveDebt);
                modal.querySelector('#debt-amount-input').addEventListener('input', (e) => {
                    let value = e.target.value.replace(/\D/g, '');
                    e.target.value = value;
                });

                const noDueDateCheckbox = modal.querySelector('#no-due-date-checkbox');
                const dueDateInput = modal.querySelector('#debt-due-date');
                const handleDueDate = () => {
                    dueDateInput.disabled = noDueDateCheckbox.checked;
                    dueDateInput.required = !noDueDateCheckbox.checked;
                    if (noDueDateCheckbox.checked) dueDateInput.value = '';
                };
                noDueDateCheckbox.addEventListener('change', handleDueDate);
                handleDueDate();
            };

            const handleSaveDebt = async (e) => {
                e.preventDefault();
                showLoader();
                const form = e.target;
                const id = form.querySelector('#debt-id').value;
                const debtData = {
                    type: form.querySelector('#debt-type').value,
                    name: form.querySelector('#debt-name').value,
                    amount: getRawAmount(form.querySelector('#debt-amount-input').value),
                    currency: form.querySelector('#debt-currency').value,
                    reason: form.querySelector('#debt-reason').value,
                    date: form.querySelector('#debt-date').value,
                    dueDate: form.querySelector('#no-due-date-checkbox').checked ? null : form.querySelector('#debt-due-date').value,
                };

                try {
                    if (id) {
                        const existingDebt = debtsCache.find(d => d.id === id);
                        await storageService.update(id, { ...existingDebt, ...debtData });
                    } else {
                        await storageService.add(debtData);
                    }
                    closeModal();
                } catch (err) {
                    console.error("Lỗi lưu:", err);
                    showNotification("Lưu thất bại.", 'error');
                } finally {
                    hideLoader();
                }
            };

            const openDetailModal = (debtId) => {
                const debt = debtsCache.find(d => d.id === debtId);
                if (!debt) return;

                const totalPaid = debt.totalPaid || 0;
                const remaining = debt.amount - totalPaid;

                let paymentsHTML = '<p style="text-align:center; color: var(--text-secondary);">Chưa có thanh toán nào.</p>';
                if (debt.payments && debt.payments.length > 0) {
                    paymentsHTML = debt.payments.slice().reverse().map((p, index) => {
                        const originalIndex = debt.payments.length - 1 - index;
                        return `
                        <div style="display:flex; justify-content:space-between; align-items:center; padding: 10px 0; border-bottom: 1px solid var(--glass-border);">
                            <div>
                                <div style="font-weight: 500;">${formatCurrency(p.amount, debt.currency)}</div>
                                <div style="color: var(--text-secondary); font-size: 0.9em;">${p.note || 'Thanh toán'} - ${formatDate(p.date)}</div>
                            </div>
                            <div class="payment-item-actions">
                                ${p.imageUrl ? `<a href="${p.imageUrl}" target="_blank" class="payment-item-actions" title="Xem ảnh"><i class="fas fa-image"></i></a>` : ''}
                                <button class="copy-payment-btn" data-index="${originalIndex}" title="Sao chép"><i class="fas fa-copy"></i></button>
                                <button class="download-payment-btn" data-index="${originalIndex}" title="Tải về"><i class="fas fa-download"></i></button>
                            </div>
                        </div>
                    `}).join('');
                }

                const modalHTML = `
                    <div class="modal-content glass-ui">
                        <div class="modal-header">
                            <h2>${debt.name}</h2>
                            <button class="close-btn"><i class="fas fa-times"></i></button>
                        </div>
                        <div class="modal-body">
                            <div class="card glass-ui" style="margin-bottom: 20px;">
                                <h3>Còn lại</h3>
                                <p class="amount" style="color: ${debt.type === 'thu' ? 'var(--success-color)' : 'var(--danger-color)'}">${formatCurrency(remaining, debt.currency)}</p>
                                <p style="color: var(--text-secondary)">Đã trả ${formatCurrency(totalPaid, debt.currency)} / ${formatCurrency(debt.amount, debt.currency)}</p>
                            </div>
                            <div class="payment-history-list">${paymentsHTML}</div>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-danger" id="delete-debt-btn-detail"><i class="fas fa-trash"></i> Xóa</button>
                            <button type="button" class="btn btn-secondary" id="edit-debt-btn-detail"><i class="fas fa-pencil-alt"></i> Sửa</button>
                            ${remaining > 0 ? `<button type="button" class="btn btn-primary" id="pay-debt-btn-detail"><i class="fas fa-hand-holding-usd"></i> Trả Nợ</button>` : ''}
                        </div>
                    </div>`;
                const modal = createModal('detail-modal', modalHTML);

                modal.querySelector('.close-btn').addEventListener('click', closeModal);
                modal.querySelector('#delete-debt-btn-detail').addEventListener('click', async () => {
                    if (confirm('Bạn có chắc chắn muốn xóa vĩnh viễn khoản nợ này? Hành động này không thể hoàn tác.')) {
                        showLoader();
                        await storageService.delete(debt.id);
                        hideLoader();
                        closeModal();
                    }
                });

                modal.querySelector('.payment-history-list').addEventListener('click', (e) => {
                    const copyBtn = e.target.closest('.copy-payment-btn');
                    const downloadBtn = e.target.closest('.download-payment-btn');

                    const getPaymentText = (payment) => {
                        return `Ngày: ${formatDate(payment.date)}\nSố tiền: ${formatCurrency(payment.amount, debt.currency)}\nGhi chú: ${payment.note || '(không có)'}`;
                    };

                    if (copyBtn) {
                        const index = parseInt(copyBtn.dataset.index);
                        const payment = debt.payments[index];
                        copyToClipboard(getPaymentText(payment));
                    }
                    if (downloadBtn) {
                        const index = parseInt(downloadBtn.dataset.index);
                        const payment = debt.payments[index];
                        downloadAsFile(getPaymentText(payment), `thanhtoan_${debt.name}_${payment.date}.txt`);
                    }
                });

                modal.querySelector('#edit-debt-btn-detail').addEventListener('click', () => { closeModal(); openAddEditModal(debt); });
                if (remaining > 0) {
                    modal.querySelector('#pay-debt-btn-detail').addEventListener('click', () => { closeModal(); openPaymentModal(debt); });
                }
            };

            const openPaymentModal = (debt) => {
                const remaining = debt.amount - (debt.totalPaid || 0);
                const modalHTML = `
                    <div class="modal-content glass-ui">
                        <div class="modal-header"><h2>Thêm Thanh Toán</h2><button class="close-btn"><i class="fas fa-times"></i></button></div>
                        <div class="modal-body">
                            <form id="payment-form">
                                <p style="text-align:center; color:var(--text-secondary); margin-bottom:20px;">Còn lại: ${formatCurrency(remaining, debt.currency)}</p>
                                <div class="form-group"><label>Số tiền trả</label><input type="text" id="payment-amount-input" required inputmode="numeric"></div>
                                <div class="form-group"><label>Ngày trả</label><input type="date" id="payment-date" value="${new Date().toISOString().split('T')[0]}" required></div>
                                <div class="form-group"><label>Ghi chú</label><input type="text" id="payment-note"></div>
                                <div class="form-group"><label>Ảnh minh chứng</label><input type="file" id="payment-image" accept="image/*" style="border:none; padding-left:0;"></div>
                            </form>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" id="cancel-payment-btn">Hủy</button>
                            <button type="submit" form="payment-form" class="btn btn-primary"><i class="fas fa-check"></i> Xác Nhận</button>
                        </div>
                    </div>`;

                const modal = createModal('payment-modal', modalHTML);
                modal.querySelector('.close-btn').addEventListener('click', closeModal);
                modal.querySelector('#cancel-payment-btn').addEventListener('click', closeModal);
                modal.querySelector('#payment-form').addEventListener('submit', async (e) => {
                    e.preventDefault();
                    const amount = getRawAmount(e.target.querySelector('#payment-amount-input').value);
                    if (!amount || amount <= 0) return showNotification("Vui lòng nhập số tiền hợp lệ.", 'error');
                    if (amount > remaining) return showNotification("Số tiền trả không thể lớn hơn số tiền còn lại.", 'error');

                    showLoader();
                    const imageFile = e.target.querySelector('#payment-image').files[0];
                    let imageUrl = null, imagePath = null;

                    try {
                        if (imageFile && storageMode === 'firebase') {
                            imagePath = `users/${currentUser.uid}/payments/${debt.id}/${Date.now()}-${imageFile.name}`;
                            const fileSnapshot = await storage.ref(imagePath).put(imageFile);
                            imageUrl = await fileSnapshot.ref.getDownloadURL();
                        } else if (imageFile) {
                            showNotification("Tải ảnh chỉ hỗ trợ ở chế độ Cloud.", 'error');
                        }

                        const payment = { amount, date: e.target.querySelector('#payment-date').value, note: e.target.querySelector('#payment-note').value, imageUrl, imagePath };
                        await storageService.addPayment(debt.id, payment);
                        closeModal();
                    } catch (err) {
                        console.error("Lỗi thêm thanh toán:", err);
                        showNotification("Thêm thanh toán thất bại.", 'error');
                    } finally {
                        hideLoader();
                    }
                });

                modal.querySelector('#payment-amount-input').addEventListener('input', (e) => {
                    let value = e.target.value.replace(/\D/g, '');
                    e.target.value = value;
                });
            };

            // --- KHỞI TẠO & XÁC THỰC ---
            const initialize_app = (user) => {
                storageService.init(storageMode, user);
                if (storageMode === 'firebase' && user) {
                    showScreen(appScreen);
                    storageService.listen((debts) => {
                        debtsCache = debts;
                        filterAndRender();
                    });
                } else {
                    showScreen(appScreen);
                    debtsCache = storageService.getAll();
                    filterAndRender();
                }
            };

            const handleDownloadHistory = (debtId) => {
                const debt = debtsCache.find(d => d.id === debtId);
                if (!debt) return;

                let fullHistoryText = `THÔNG TIN KHOẢN VAY\n`;
                fullHistoryText += `=====================================\n`;
                fullHistoryText += `Loại: ${debt.type === 'thu' ? 'Cho Vay' : 'Nợ'}\n`;
                fullHistoryText += `Người liên quan: ${debt.name}\n`;
                fullHistoryText += `Số tiền: ${formatCurrency(debt.amount, debt.currency)}\n`;
                fullHistoryText += `Ngày giao dịch: ${formatDate(debt.date)}\n`;
                fullHistoryText += `Ngày hẹn trả: ${formatDate(debt.dueDate)}\n`;
                fullHistoryText += `Nội dung: ${debt.reason || '(không có)'}\n\n`;

                if (debt.payments && debt.payments.length > 0) {
                    fullHistoryText += `LỊCH SỬ THANH TOÁN\n`;
                    fullHistoryText += `=====================================\n\n`;
                    debt.payments.forEach(p => {
                        fullHistoryText += `Ngày: ${formatDate(p.date)}\n`;
                        fullHistoryText += `Số tiền: ${formatCurrency(p.amount, debt.currency)}\n`;
                        fullHistoryText += `Ghi chú: ${p.note || '(không có)'}\n`;
                        fullHistoryText += `-------------------------------------\n`;
                    });
                } else {
                    fullHistoryText += "Chưa có lịch sử thanh toán.";
                }

                downloadAsFile(fullHistoryText, `lichsu_${debt.name}.txt`);
            };

            try {
                if (!firebase.apps.length) { firebase.initializeApp(firebaseConfig); }
                auth = firebase.auth();
                db = firebase.firestore();
                storage = firebase.storage();

                loadInitialSettings();

                addDebtBtn.addEventListener('click', () => openAddEditModal());
                settingsBtn.addEventListener('click', openSettingsModal);
                importFileInput.addEventListener('change', handleImportFile);
                searchInput.addEventListener('input', filterAndRender);

                debtListEl.addEventListener('click', (e) => {
                    const downloadBtn = e.target.closest('.download-history-btn-list');
                    if (downloadBtn) {
                        const debtId = downloadBtn.dataset.id;
                        handleDownloadHistory(debtId);
                    }
                });

                // Auth form toggles
                toggleToRegister.addEventListener('click', (e) => { e.preventDefault(); loginForm.classList.add('hidden'); forgotPasswordForm.classList.add('hidden'); registerForm.classList.remove('hidden'); authToggles.classList.add('hidden'); toggleToLogin.classList.remove('hidden'); });
                toggleToLogin.addEventListener('click', (e) => { e.preventDefault(); registerForm.classList.add('hidden'); forgotPasswordForm.classList.add('hidden'); loginForm.classList.remove('hidden'); toggleToLogin.classList.add('hidden'); authToggles.classList.remove('hidden'); });
                forgotPasswordLink.addEventListener('click', (e) => { e.preventDefault(); loginForm.classList.add('hidden'); registerForm.classList.add('hidden'); forgotPasswordForm.classList.remove('hidden'); authToggles.classList.add('hidden'); toggleToLogin.classList.remove('hidden'); });

                // Auth form submissions
                loginForm.addEventListener('submit', async (e) => { e.preventDefault(); showLoader(); loginError.textContent = ''; try { await auth.signInWithEmailAndPassword(e.target['login-email'].value, e.target['login-password'].value); } catch (err) { loginError.textContent = err.message; hideLoader(); } });
                registerForm.addEventListener('submit', async (e) => { e.preventDefault(); showLoader(); registerError.textContent = ''; try { await auth.createUserWithEmailAndPassword(e.target['register-email'].value, e.target['register-password'].value); } catch (err) { registerError.textContent = err.message; hideLoader(); } });
                forgotPasswordForm.addEventListener('submit', async (e) => {
                    e.preventDefault();
                    showLoader();
                    const email = e.target['forgot-email'].value;
                    try {
                        await auth.sendPasswordResetEmail(email);
                        hideLoader();
                        showNotification(`Đã gửi liên kết tới ${email}. Vui lòng kiểm tra hộp thư của bạn.`);
                        // Quay lại màn hình đăng nhập
                        forgotPasswordForm.classList.add('hidden');
                        loginForm.classList.remove('hidden');
                        toggleToLogin.classList.add('hidden');
                        authToggles.classList.remove('hidden');
                    } catch (err) {
                        hideLoader();
                        showNotification(err.message, 'error');
                    }
                });

                auth.onAuthStateChanged(async user => {
                    if (user) {
                        showLoader();
                        currentUser = user;
                        debtsCollection = db.collection('users').doc(user.uid).collection('debts');

                        const localDebtsRaw = localStorage.getItem('debts');
                        if (localDebtsRaw && JSON.parse(localDebtsRaw).length > 0) {
                            const localDebts = JSON.parse(localDebtsRaw);
                            hideLoader();
                            if (confirm(`Tìm thấy ${localDebts.length} khoản nợ trên máy này. Bạn có muốn chuyển chúng lên tài khoản ${user.email} không?\n\nCẢNH BÁO: Thao tác này sẽ XÓA SẠCH dữ liệu hiện có trên Cloud của tài khoản này.`)) {
                                showLoader();
                                try {
                                    const oldSnapshot = await debtsCollection.get();
                                    const batch = db.batch();
                                    if (!oldSnapshot.empty) {
                                        oldSnapshot.docs.forEach(doc => batch.delete(doc.ref));
                                    }
                                    localDebts.forEach(debt => {
                                        const { id, ...debtData } = debt;
                                        const newDocRef = debtsCollection.doc();
                                        batch.set(newDocRef, debtData);
                                    });
                                    await batch.commit();
                                    localStorage.removeItem('debts');
                                    showNotification("Chuyển dữ liệu lên Cloud thành công!");
                                } catch (error) {
                                    console.error("Lỗi di chuyển dữ liệu:", error);
                                    showNotification("Lỗi khi chuyển dữ liệu. Bạn sẽ được đăng xuất.", 'error');
                                    await auth.signOut();
                                    hideLoader();
                                    return;
                                }
                            } else {
                                showNotification("Đã hủy di chuyển. Bạn sẽ được đăng xuất.", 'error');
                                await auth.signOut();
                                hideLoader();
                                return;
                            }
                        }

                        storageMode = 'firebase';
                        localStorage.setItem('storageMode', 'firebase');
                        initialize_app(user);
                        hideLoader();

                    } else {
                        currentUser = null;
                        debtsCollection = null;
                        storageMode = localStorage.getItem('storageMode') || 'local';

                        if (storageMode === 'firebase') {
                            showScreen(authScreen);
                        } else {
                            initialize_app(null);
                        }
                        hideLoader();
                    }
                });

            } catch (e) { console.error("Lỗi nghiêm trọng:", e); showNotification("Ứng dụng gặp lỗi, vui lòng tải lại trang.", 'error'); }
        });
    </script>
</body>

</html>