<!DOCTYPE html>
<html lang="vi" class="h-full">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Be+Vietnam+Pro:wght@400;500;600;700&display=swap"
        rel="stylesheet">
    <link rel="icon" href="/Asset/logo/logo.png">

    <link rel="apple-touch-icon" href="/Asset/logo/logo.png" sizes="150x150">

    <title>Hunq PayGate</title>
    <meta name="title" content="Hunq PayGate" />
    <meta name="description" content="Cổng thanh toán của Đinh Mạnh Hùng" />

    <meta property="og:type" content="website" />
    <meta property="og:url" content="Hunq.online/Pay/" />
    <meta property="og:title" content="Hunq PayGate" />
    <meta property="og:description" content="Cổng thanh toán của Đinh Mạnh Hùng" />
    <meta property="og:image" content="/Pay/Grap/HunqPayGate.png" />

    <meta property="twitter:card" content="summary_large_image" />
    <meta property="twitter:url" content="Hunq.online/Pay/" />
    <meta property="twitter:title" content="Hunq PayGate" />
    <meta property="twitter:description" content="Cổng thanh toán của Đinh Mạnh Hùng" />
    <meta property="twitter:image" content="/Pay/Grap/HunqPayGate.png" />

    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcode-generator/1.4.4/qrcode.min.js"></script>

    <style>
        /* Custom styles and theme variables */
        :root {
            --bg-light: #f3f4f6;
            --card-bg-light: #ffffff;
            --text-primary-light: #111827;
            --text-secondary-light: #4b5563;
            --accent-light: #3b82f6;
            --border-light: #e5e7eb;

            --bg-dark: #0d1117;
            --card-bg-dark: #1f2937;
            --text-primary-dark: #e6edf3;
            --text-secondary-dark: #8b949e;
            --accent-dark: #facc15;
            /* Gold accent */
            --border-dark: #30363d;
        }

        body {
            font-family: 'Be Vietnam Pro', sans-serif;
            transition: background 0.5s, color 0.3s;
        }

        /* --- Normal Theme --- */
        .theme-normal {
            background-color: var(--bg-light);
            color: var(--text-primary-light);
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='24' height='24' viewBox='0 0 24 24'%3E%3Cg fill='%23d1d5db' fill-opacity='0.4'%3E%3Cpath d='M12 0h-1v24h1V0zm11 11v1H0v-1h24z'/%3E%3C/g%3E%3C/svg%3E");
        }

        .theme-normal .card {
            background-color: var(--card-bg-light);
            border-color: var(--border-light);
        }

        .theme-normal .text-primary {
            color: var(--text-primary-light);
        }

        .theme-normal .text-secondary {
            color: var(--text-secondary-light);
        }

        .theme-normal .accent-bg {
            background-color: var(--accent-light);
        }

        .theme-normal .accent-border {
            border-color: var(--accent-light);
        }

        .theme-normal .input-focus:focus {
            --tw-ring-color: var(--accent-light);
        }

        .theme-normal .accent-text {
            color: var(--accent-light);
        }

        .theme-normal .border-color {
            border-color: var(--border-light);
        }

        .theme-normal .payment-method.active {
            border-color: var(--accent-light);
            box-shadow: 0 0 0 2px var(--accent-light);
        }

        .theme-normal .copy-btn .tooltip {
            background-color: var(--text-primary-light);
            color: var(--bg-light);
        }

        .theme-normal .hunq-title {
            color: var(--accent-light);
        }


        /* --- VIP Theme --- */
        .theme-vip {
            background-color: var(--bg-dark);
            color: var(--text-primary-dark);
            background-image: url("data:image/svg+xml,%3Csvg width='60' height='60' viewBox='0 0 60 60' xmlns='http://www.w3.org/2000/svg'%3E%3Cg fill='none' fill-rule='evenodd'%3E%3Cg fill='%23facc15' fill-opacity='0.07'%3E%3Cpath d='M36 34v-4h-2v4h-4v2h4v4h2v-4h4v-2h-4zm0-30V0h-2v4h-4v2h4v4h2V6h4V4h-4zM6 34v-4H4v4H0v2h4v4h2v-4h4v-2H6zM6 4V0H4v4H0v2h4v4h2V6h4V4H6z'/%3E%3C/g%3E%3C/g%3E%3C/svg%3E");
        }

        .theme-vip .card {
            background: linear-gradient(145deg, #21262d, #161b22);
            border: 1px solid var(--border-dark);
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.4), 0 0 25px rgba(250, 204, 21, 0.08);
        }

        .theme-vip .text-primary {
            color: var(--text-primary-dark);
            text-shadow: 0 0 2px rgba(255, 255, 255, 0.1);
        }

        .theme-vip .text-secondary {
            color: var(--text-secondary-dark);
        }

        .theme-vip .accent-bg {
            background-color: var(--accent-dark);
            color: #111827;
            font-weight: 600;
            box-shadow: 0 0 12px rgba(250, 204, 21, 0.5), inset 0 1px 1px rgba(255, 255, 255, 0.3);
            border: 1px solid rgba(252, 211, 77, 0.8);
        }

        .theme-vip .accent-border {
            border-color: var(--accent-dark);
        }

        .theme-vip .input-focus:focus {
            --tw-ring-color: var(--accent-dark);
            border-color: var(--accent-dark);
        }

        .theme-vip .accent-text {
            color: var(--accent-dark);
            font-weight: 700;
            text-shadow: 0 0 8px rgba(250, 204, 21, 0.6);
        }

        .theme-vip .border-color {
            border-color: var(--border-dark);
        }

        .theme-vip .payment-method:hover {
            transform: translateY(-3px);
            box-shadow: 0 0 20px rgba(250, 204, 21, 0.2);
        }

        .theme-vip .payment-method.active {
            border-color: var(--accent-dark);
            transform: translateY(-2px);
            box-shadow: 0 0 0 2px var(--accent-dark), 0 0 25px rgba(250, 204, 21, 0.4);
            background: linear-gradient(145deg, #313842, #242930);
        }

        .theme-vip #qr-code {
            border: 2px solid var(--accent-dark);
            padding: 5px;
            background: #fff;
            box-shadow: 0 0 15px rgba(250, 204, 21, 0.7);
        }

        .theme-vip .copy-btn .tooltip {
            background-color: var(--accent-dark);
            color: #111827;
            font-weight: 500;
        }

        .theme-vip .hunq-title {
            color: var(--accent-dark);
            text-shadow: 0 0 8px rgba(250, 204, 21, 0.6);
        }


        /* --- Status Themes (inherit from normal) --- */
        .status-maintenance,
        .status-error {
            background-color: var(--bg-light);
            color: var(--text-primary-light);
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='24' height='24' viewBox='0 0 24 24'%3E%3Cg fill='%23d1d5db' fill-opacity='0.4'%3E%3Cpath d='M12 0h-1v24h1V0zm11 11v1H0v-1h24z'/%3E%3C/g%3E%3C/svg%3E");
        }

        .status-maintenance .card,
        .status-error .card {
            background-color: var(--card-bg-light);
            border-color: var(--border-light);
        }

        .status-maintenance #payment-flow,
        .status-error #payment-flow {
            opacity: 0.5;
            pointer-events: none;
        }

        /* General Styles */
        .payment-method {
            transition: all 0.3s cubic-bezier(0.25, 0.8, 0.25, 1);
        }

        .tooltip {
            position: absolute;
            bottom: 125%;
            left: 50%;
            transform: translateX(-50%);
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 0.8rem;
            white-space: nowrap;
            opacity: 0;
            transition: opacity 0.2s;
            pointer-events: none;
        }

        .copy-btn:hover .tooltip {
            opacity: 1;
        }

        /* *** THAY ĐỔI CSS CHO QR-CODE *** */
        #qr-code {
            background-color: #ffffff;
            /* Luôn có nền trắng cho QR */
        }

        #qr-code canvas {
            /* Đảm bảo canvas vừa vặn */
            margin: auto;
            display: block;
        }

        #qr-image {
            width: 100%;
            height: 100%;
            object-fit: contain;
        }

        /* End changes */


        /* Status Indicator Styles */
        .status-dot {
            transition: 0.3s;
        }

        .theme-normal .status-dot {
            background-color: #22c55e;
        }

        .theme-normal .status-text {
            color: #166534;
        }


        .theme-vip .status-dot {
            background-color: var(--accent-dark);
        }

        .theme-vip .status-text {
            color: var(--accent-dark);
        }

        .status-maintenance .status-dot {
            background-color: #f59e0b;
        }

        .status-maintenance .status-text {
            color: #b45309;
        }

        .status-error .status-dot {
            background-color: #ef4444;
        }

        .status-error .status-text {
            color: #b91c1c;
        }

        /* Title Styles */
        .paylab-title {
            color: inherit;
            font-weight: 100;
            font-size: 18px;
        }
    </style>
</head>

<body class="min-h-screen flex flex-col">

    <div class="container mx-auto p-4 sm:p-6 md:p-8 max-w-6xl flex flex-col flex-grow min-h-0">

        <header class="flex justify-between items-center mb-6 flex-shrink-0">
            <h1 class="text-2xl sm:text-3xl font-bold text-primary">
                <span class="hunq-title">Hunq </span><span class="paylab-title">PayGate</span>
            </h1>
            <div id="status-indicator" class="flex items-center space-x-2">
                <span class="status-text text-sm font-semibold"></span>
                <span class="status-dot w-3 h-3 rounded-full"></span>
            </div>
        </header>

        <main
            class="card border rounded-xl shadow-lg transition-all duration-300 flex-grow flex flex-col md:justify-center">
            <div class="lg:grid lg:grid-cols-10 w-full h-full">
                <div class="lg:col-span-4 p-6 sm:p-8 flex flex-col">
                    <div id="status-message-container">
                        <div id="maintenance-message"
                            class="hidden mb-6 p-4 bg-amber-100 border-l-4 border-amber-500 text-amber-700 rounded-r-lg">
                            <h3 class="font-bold">Hệ thống đang bảo trì</h3>
                            <p>Cổng thanh toán đang được bảo trì để nâng cấp. Vui lòng quay lại sau.</p>
                        </div>
                        <div id="error-message"
                            class="hidden mb-6 p-4 bg-red-100 border-l-4 border-red-500 text-red-700 rounded-r-lg">
                            <h3 class="font-bold">Cổng thanh toán tạm ngưng</h3>
                            <p>Đã xảy ra lỗi với hệ thống thanh toán. Vui lòng thử lại sau.</p>
                        </div>
                    </div>
                    <div id="payment-flow" class="flex-grow flex flex-col">
                        <section id="method-selection">
                            <h2 class="text-lg font-semibold text-primary mb-1">1. Chọn phương thức thanh toán</h2>
                            <p class="text-sm text-secondary mb-4">Vui lòng chọn một trong các phương thức dưới đây.</p>
                            <div id="payment-methods" class="grid grid-cols-1 gap-4"></div>
                        </section>
                    </div>
                </div>

                <div class="lg:col-span-6 lg:border-l border-color flex flex-col p-6 sm:p-8">
                    <div id="details-placeholder" class="flex flex-grow items-center justify-center text-center">
                        <div>
                            <svg class="mx-auto h-12 w-12 text-gray-400" fill="none" viewBox="0 0 24 24"
                                stroke="currentColor" aria-hidden="true">
                                <path vector-effect="non-scaling-stroke" stroke-linecap="round" stroke-linejoin="round"
                                    stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                            </svg>
                            <h3 class="mt-2 text-sm font-medium text-primary">Chưa chọn phương thức</h3>
                            <p class="mt-1 text-sm text-secondary">Vui lòng chọn một phương thức thanh toán ở bên trái.
                            </p>
                        </div>
                    </div>

                    <section id="password-entry-container" class="hidden flex-grow flex flex-col justify-center">
                        <h2 class="text-lg font-semibold text-primary mb-4">Yêu cầu xác thực</h2>
                        <p class="text-sm text-secondary mb-4">Phương thức này yêu cầu mật khẩu để tiếp tục.</p>
                        <form id="password-form" class="space-y-4">
                            <div>
                                <label for="password-input" class="block text-sm font-medium text-secondary">Mật
                                    khẩu</label>
                                <div class="mt-1">
                                    <input type="password" id="password-input"
                                        class="input-focus block w-full border-color rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm p-2 bg-transparent border-2">
                                </div>
                                <p id="password-error" class="mt-2 text-sm text-red-600"></p>
                            </div>
                            <button type="submit"
                                class="w-full accent-bg text-white font-semibold py-2 px-4 rounded-md hover:opacity-90 transition-opacity">Xác
                                nhận</button>
                        </form>
                    </section>

                    <section id="payment-details-container" class="hidden">
                        <h2 class="text-lg font-semibold text-primary mb-4">2. Thông tin thanh toán</h2>
                        <div class="flex flex-col md:flex-row gap-6 md:gap-8">
                            <div class="flex-shrink-0 text-center md:text-left">
                                <div
                                    class="flex-shrink-0 mx-auto md:mx-0 w-52 h-fit flex flex-col rounded-xl overflow-hidden border-2 accent-border shadow-[0_0_15px_rgba(250,204,21,0.5)] transition-all duration-300  bg-white">

                                    <div id="qr-code"
                                        class="w-full aspect-square bg-white p-3 flex items-center justify-center m-0 !border-0 !shadow-none !rounded-none">
                                    </div>

                                    <a id="download-qr-btn" href="#" download="Ma-QR-Thanh-Toan-HunqStore.png"
                                        class="w-full flex-1 flex items-center justify-center gap-2 accent-bg text-gray-900 text-sm font-bold py-3.5 px-4 m-0 !border-0 !rounded-none hover:brightness-110 transition-all duration-300">
                                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"
                                            xmlns="http://www.w3.org/2000/svg">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                                d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4">
                                            </path>
                                        </svg>
                                        Tải xuống QR
                                    </a>
                                </div>
                            </div>

                            <div class="flex-grow">
                                <div id="provider-logo-container" class="flex items-center mb-4 ">
                                    <img id="provider-logo" src="" alt="Provider Logo" class="h-8 mr-3 rounded-md">
                                    <span id="provider-name" class="text-xl font-bold text-primary"></span>
                                </div>

                                <div class="space-y-4">
                                    <div id="bank-info-line" class="info-line">
                                        <p class="text-sm text-secondary">Ngân hàng</p>
                                        <div class="flex items-center">
                                            <p id="bank-name" class="text-base font-semibold text-primary mr-2"></p>
                                            <button class="copy-btn" data-target="bank-name"></button>
                                        </div>
                                    </div>
                                    <div id="branch-info-line" class="info-line hidden">
                                        <p class="text-sm text-secondary">Chi nhánh</p>
                                        <div class="flex items-center">
                                            <p id="branch-name" class="text-base font-semibold text-primary mr-2"></p>
                                            <button class="copy-btn" data-target="branch-name"></button>
                                        </div>
                                    </div>
                                    <div id="account-number-line" class="info-line">
                                        <p class="text-sm text-secondary">Số tài khoản</p>
                                        <div class="flex items-center">
                                            <p id="account-number" class="text-base font-semibold text-primary mr-2">
                                            </p>
                                            <button class="copy-btn" data-target="account-number"></button>
                                        </div>
                                    </div>
                                    <div id="account-name-line" class="info-line">
                                        <p class="text-sm text-secondary">Chủ tài khoản</p>
                                        <div class="flex items-center">
                                            <p id="account-name" class="text-base font-semibold text-primary mr-2"></p>
                                            <button class="copy-btn" data-target="account-name"></button>
                                        </div>
                                    </div>
                                    <div id="transfer-content-line" class="info-line">
                                        <p class="text-sm text-secondary">Nội dung chuyển khoản</p>
                                        <div class="flex items-center">
                                            <p id="transfer-content" class="text-base font-bold accent-text mr-2"></p>
                                            <button class="copy-btn" data-target="transfer-content"></button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div
                            class="mt-6 p-4 bg-blue-50 rounded-xl border border-blue-200 flex items-start gap-3 shadow-sm">
                            <div class="flex-shrink-0 text-blue-500 mt-0.5">
                                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"
                                    class="w-5 h-5">
                                    <path fill-rule="evenodd"
                                        d="M2.25 12c0-5.385 4.365-9.75 9.75-9.75s9.75 4.365 9.75 9.75-4.365 9.75-9.75 9.75S2.25 17.385 2.25 12zm8.706-1.442c1.146-.573 2.437.463 2.126 1.706l-.709 2.836.042-.02a.75.75 0 01.67 1.34l-.04.022c-1.147.573-2.438-.463-2.127-1.706l.71-2.836-.042.02a.75.75 0 01-.671-1.34l.04-.022zM12 9a.75.75 0 100-1.5.75.75 0 000 1.5z"
                                        clip-rule="evenodd" />
                                </svg>
                            </div>
                            <div class="text-sm text-blue-900">
                                <p class="font-semibold mb-1">Lưu ý:</p>
                                <ul class="list-disc list-inside space-y-1 text-blue-800 opacity-90">
                                    <li>Nhập chính xác <strong>Nội dung chuyển khoản</strong> (khuyên dùng mã QR để
                                        tránh sai sót).</li>
                                    <li>Chụp lại <strong>biên lai (bill)</strong> sau khi chuyển để được hỗ trợ nhanh
                                        nhất nếu có lỗi.</li>
                                    <li><strong>Báo cáo cho tôi</strong> nếu có lỗi, số tài khoản hoặc tên tài khoản không phải tôi.</li>
                                </ul>
                            </div>
                        </div>
                    </section>
                </div>
            </div>
        </main>

        <footer class="text-center mt-6 flex-shrink-0">
            <p class="text-sm text-secondary">&copy; 2025 Hunq Store. All Rights Reserved.</p>
        </footer>
    </div>
    <script src="./qr.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', function () {
            // --- DATA ---
            const bankingInfo = {
                vietcombank: {
                    name: "Vietcombank",
                    bin: "970436", // *** THÊM BIN ***
                    accountNumber: "1015894887",
                    accountName: "DINH MANH HUNG",
                    branch: null,
                    region: "ALL",
                    logo: "./icon/Icon-Vietcombank.webp",
                    qrImagePath: "./QR/VCB-QR.png", // Giữ lại làm fallback
                    content: ""
                },
                vietcapittalbank: {
                    name: "BVBank",
                    bin: "970454", // *** THÊM BIN *** (Mã BIN của BVBank)
                    accountNumber: "99MM24030M09540726",
                    accountName: "MOMO_DINH MANH HUNG",
                    branch: null,
                    region: "ALL",
                    logo: "./icon/Icon-BVBank.png",
                    qrImagePath: "./QR/Momo-QR.png", // Giữ lại làm fallback
                    content: "",
                },
                momo: {
                    name: "Ví MoMo",
                    bin: null, // *** THÊM BIN (null vì không phải VietQR) ***
                    accountNumber: "Sử dụng BVBank",
                    accountName: null,
                    branch: null,
                    region: "ALL",
                    logo: "./icon/Icon-Momo.png",
                    qrImagePath: "./icon/Icon-Momo.png",
                    content: null
                },
                yucho: {
                    name: "Yucho",
                    bin: null, // *** THÊM BIN (null vì không phải VietQR) ***
                    accountNumber: "16218251",
                    accountName: "ディン マン フン",
                    branch: "12090",
                    region: "JP",
                    logo: "./icon/Icon-Yucho.png",
                    qrImagePath: "./icon/Icon-Yucho.png",
                    content: "",
                    password: null
                },
                gmo: {
                    name: "GMO",
                    bin: null, // *** THÊM BIN (null vì không phải VietQR) ***
                    accountNumber: "1084318",
                    accountName: "カ）キヤシユディン マンフン",
                    branch: "ムクドリ　580",
                    region: "JP",
                    logo: "./icon/Icon-GMO.png",
                    qrImagePath: "./icon/Icon-GMO.png",
                    content: "",
                    password: null
                },
            };

            // --- DOM ELEMENTS ---
            const body = document.body;
            const statusIndicator = document.getElementById('status-indicator');
            const statusText = statusIndicator.querySelector('.status-text');
            const maintenanceMessage = document.getElementById('maintenance-message');
            const errorMessage = document.getElementById('error-message');
            const paymentMethodsContainer = document.getElementById('payment-methods');

            // Right panel elements
            const detailsPlaceholder = document.getElementById('details-placeholder');
            const paymentDetailsContainer = document.getElementById('payment-details-container');
            const passwordEntryContainer = document.getElementById('password-entry-container');
            const passwordForm = document.getElementById('password-form');
            const passwordInput = document.getElementById('password-input');
            const passwordError = document.getElementById('password-error');

            // Payment details elements
            const providerLogo = document.getElementById('provider-logo');
            const providerName = document.getElementById('provider-name');
            const downloadQrBtn = document.getElementById('download-qr-btn');
            const bankNameEl = document.getElementById('bank-name');
            const accountNumberEl = document.getElementById('account-number');
            const accountNameEl = document.getElementById('account-name');
            const branchNameEl = document.getElementById('branch-name');
            const branchInfoLine = document.getElementById('branch-info-line');
            const transferContentEl = document.getElementById('transfer-content');

            let activeProviderButton = null;
            let urlParams = {
                theme: 'online',
                ref: null,
                regions: [],
                amount: null
            };

            // --- FUNCTIONS ---

            const f = (id, value) => {
                const l = (value || '').length.toString().padStart(2, '0');
                return `${id}${l}${value}`;
            };

            const crc16 = (data) => {
                let crc = 0xFFFF;
                for (let i = 0; i < data.length; i++) {
                    crc ^= data.charCodeAt(i) << 8;
                    for (let j = 0; j < 8; j++) {
                        crc = (crc & 0x8000) ? (crc << 1) ^ 0x1021 : crc << 1;
                    }
                }
                return (crc & 0xFFFF).toString(16).toUpperCase().padStart(4, '0');
            };

            const buildVietQR = (bin, accountNumber, amount, info) => {
                const bankInfo = f('00', 'A000000727') + f('01', f('00', bin) + f('01', accountNumber));
                const merchantAccountInfo = f('38', bankInfo);
                const transactionAmount = amount ? f('54', amount) : '';

                const defaultInfo = "Thanh toan";
                const transactionInfo = info ? info.replace(/\s/g, ' ') : defaultInfo;
                const purposeOfTransaction = f('08', transactionInfo);
                const additionalData = f('62', purposeOfTransaction);

                const payload = `000201010211${merchantAccountInfo}5303704${transactionAmount}5802VN${additionalData}6304`;
                return payload + crc16(payload);
            };

            // *** THAY ĐỔI LỚN TRONG HÀM NÀY ĐỂ THÊM LOGO ***
            function drawQrCode(data, containerEl, downloadBtn, logoPath = null) {
                try {
                    containerEl.innerHTML = '';
                    const canvas = document.createElement('canvas');
                    containerEl.appendChild(canvas);

                    const qr = qrcode(0, 'H');
                    qr.addData(data);
                    qr.make();

                    const containerSize = containerEl.clientWidth - 2;
                    const dpr = window.devicePixelRatio || 1;
                    const moduleCount = qr.getModuleCount();
                    const cellSize = Math.floor(containerSize / (moduleCount + 4));
                    const margin = cellSize * 2;
                    const logicalSize = moduleCount * cellSize + margin * 2;
                    const actualSize = logicalSize * dpr;

                    canvas.width = actualSize;
                    canvas.height = actualSize;
                    canvas.style.width = `${logicalSize}px`;
                    canvas.style.height = `${logicalSize}px`;

                    const ctx = canvas.getContext('2d');
                    ctx.scale(dpr, dpr);

                    ctx.fillStyle = 'white';
                    ctx.fillRect(0, 0, logicalSize, logicalSize);

                    for (let row = 0; row < moduleCount; row++) {
                        for (let col = 0; col < moduleCount; col++) {
                            if (qr.isDark(row, col)) {
                                ctx.fillStyle = 'black';
                                const x = margin + col * cellSize;
                                const y = margin + row * cellSize;
                                ctx.fillRect(x, y, cellSize, cellSize);
                            }
                        }
                    }

                    // --- LOGIC THÊM LOGO ---
                    const finalizeDrawing = () => {
                        if (downloadBtn) {
                            downloadBtn.href = canvas.toDataURL('image/png');
                        }
                    };

                    if (logoPath) {
                        const logoImage = new Image();
                        logoImage.crossOrigin = "Anonymous"; // Quan trọng nếu logo từ CDN khác domain
                        logoImage.onload = () => {
                            const logoSize = logicalSize * 0.25; // Kích thước logo, 25% kích thước QR
                            const logoX = (logicalSize - logoSize) / 2;
                            const logoY = (logicalSize - logoSize) / 2;

                            // Vẽ nền trắng dưới logo để che các chấm QR
                            ctx.fillStyle = 'white';
                            const backgroundPadding = 5; // Thêm khoảng trắng xung quanh logo
                            ctx.fillRect(logoX - backgroundPadding, logoY - backgroundPadding, logoSize + 2 * backgroundPadding, logoSize + 2 * backgroundPadding);

                            ctx.drawImage(logoImage, logoX, logoY, logoSize, logoSize);
                            finalizeDrawing();
                        };
                        logoImage.onerror = () => {
                            console.error("Không thể tải logo từ:", logoPath);
                            finalizeDrawing(); // Vẫn hoàn tất việc vẽ QR ngay cả khi không tải được logo
                        };
                        logoImage.src = logoPath;
                    } else {
                        finalizeDrawing();
                    }

                } catch (e) {
                    console.error("Lỗi tạo QR:", e);
                    containerEl.innerHTML = '<p class="text-xs text-red-600 p-2">Lỗi tạo mã QR.</p>';
                    if (downloadBtn) {
                        downloadBtn.href = '#';
                    }
                }
            }
            // *** KẾT THÚC THAY ĐỔI HÀM DRAWQRCODE ***


            function parseUrlParams() {
                const searchString = window.location.search.substring(1);
                const hashString = window.location.hash.substring(1);
                const fullParamsString = [searchString, hashString].filter(Boolean).join('&');

                if (!fullParamsString) return;

                const params = fullParamsString.split('&');
                const validRegions = ['VN', 'JP', 'US'];

                params.forEach(param => {
                    if (!param) return;
                    const [key, value] = param.split('=').map(s => s.trim());

                    if (key.toUpperCase() === 'VIP' && !value) {
                        urlParams.theme = 'vip';
                    } else if (key.toUpperCase() === 'REF') {
                        let refValue = value || '';
                        refValue = decodeURIComponent(refValue).replace(/^['"]|['"]$/g, '');
                        urlParams.ref = refValue;
                    } else if (key.toUpperCase() === 'AMOUT') {
                        urlParams.amount = value || null;
                    } else if (validRegions.includes(key.toUpperCase()) && !value) {
                        urlParams.regions.push(key.toUpperCase());
                    }
                });
            }

            function initializePage(status, params) {
                body.className = 'min-h-screen flex flex-col';
                maintenanceMessage.classList.add('hidden');
                errorMessage.classList.add('hidden');

                let themeClass = '';
                let statusLabel = '';

                switch (status) {
                    case 'vip':
                        themeClass = 'theme-vip';
                        statusLabel = 'VIP';
                        break;
                    case 'maintenance':
                        themeClass = 'status-maintenance';
                        statusLabel = 'Bảo trì';
                        maintenanceMessage.classList.remove('hidden');
                        break;
                    case 'error':
                        themeClass = 'status-error';
                        statusLabel = 'Lỗi';
                        errorMessage.classList.remove('hidden');
                        break;
                    case 'online':
                    default:
                        themeClass = 'theme-normal';
                        statusLabel = 'Đang hoạt động';
                        break;
                }

                body.classList.add(themeClass);
                statusText.textContent = statusLabel;

                initPaymentMethods(status, params);
            }

            function copyToClipboard(text, btn) {
                const originalTooltip = btn.querySelector('.tooltip-text').textContent;
                navigator.clipboard.writeText(text).then(() => {
                    btn.querySelector('.tooltip-text').textContent = 'Đã chép!';
                }).catch(err => {
                    btn.querySelector('.tooltip-text').textContent = 'Lỗi!';
                }).finally(() => {
                    setTimeout(() => {
                        btn.querySelector('.tooltip-text').textContent = originalTooltip;
                    }, 1500);
                });
            }

            function updateDisplay(providerKey) {
                const info = bankingInfo[providerKey];
                if (!info) return;

                providerLogo.src = info.logo;
                providerName.textContent = info.name;

                // Hàm tiện ích: Có data thì hiện dòng + gắn text, Không có data thì ẩn dòng đi
                const toggleInfoLine = (lineId, textId, value) => {
                    const lineEl = document.getElementById(lineId);
                    const textEl = document.getElementById(textId);
                    if (value && value.trim() !== "") {
                        lineEl.classList.remove('hidden');
                        textEl.textContent = value;
                    } else {
                        lineEl.classList.add('hidden');
                    }
                };

                // Kiểm tra và hiển thị từng dòng
                toggleInfoLine('bank-info-line', 'bank-name', info.name);
                toggleInfoLine('branch-info-line', 'branch-name', info.branch);
                toggleInfoLine('account-number-line', 'account-number', info.accountNumber);
                toggleInfoLine('account-name-line', 'account-name', info.accountName);

                const transferContent = urlParams.ref || info.content;
                toggleInfoLine('transfer-content-line', 'transfer-content', transferContent);

                const qrContainer = document.getElementById('qr-code');
                qrContainer.innerHTML = '';

                const myLogoPath = '/Asset/logo/logo.png';

                if (info.bin) {
                    const qrData = buildVietQR(
                        info.bin,
                        info.accountNumber,
                        urlParams.amount,
                        transferContent
                    );
                    drawQrCode(qrData, qrContainer, downloadQrBtn, myLogoPath);
                    downloadQrBtn.download = `QR-VietQR-${info.name.replace(/\s/g, '')}.png`;

                } else {
                    const qrUrl = info.qrImagePath;
                    const img = document.createElement('img');
                    img.id = 'qr-image';
                    img.className = 'rounded-md w-full h-full object-contain';
                    img.src = qrUrl;
                    img.alt = 'Mã QR thanh toán';
                    qrContainer.appendChild(img);

                    downloadQrBtn.href = qrUrl;
                    downloadQrBtn.download = `QR-${info.name.replace(/\s/g, '')}.png`;
                }
            }

            function initPaymentMethods(status, params) {
                paymentMethodsContainer.innerHTML = '';
                if (status === 'online' || status === 'vip') {
                    Object.keys(bankingInfo).forEach(key => {
                        const info = bankingInfo[key];

                        const allowedRegions = params.regions;

                        if (allowedRegions.length > 0) {
                            // Trường hợp 1: URL có tham số vùng (ví dụ ?JP, ?VN)
                            // Chỉ hiển thị các phương thức khớp với vùng được yêu cầu
                            if (!allowedRegions.includes(info.region)) {
                                return;
                            }
                        } else {
                            // Trường hợp 2: URL KHÔNG có tham số vùng (truy cập mặc định)
                            // Ẩn đi các phương thức thuộc vùng JP
                            if (info.region === 'JP') {
                                return;
                            }
                        }
                        const button = document.createElement('button');
                        button.className = 'payment-method border-2 border-color p-4 rounded-lg flex items-center space-x-4';
                        button.dataset.provider = key;
                        button.innerHTML = `<img src="${info.logo}" alt="${info.name}" class="h-8 w-auto object-contain rounded-md"><span class="font-semibold text-primary">${info.name}</span>`;

                        button.addEventListener('click', () => {
                            if (activeProviderButton) {
                                activeProviderButton.classList.remove('active');
                            }
                            button.classList.add('active');
                            activeProviderButton = button;

                            detailsPlaceholder.classList.add('hidden');
                            paymentDetailsContainer.classList.add('hidden');
                            passwordEntryContainer.classList.add('hidden');
                            passwordInput.value = '';
                            passwordError.textContent = '';

                            if (info.password) {
                                passwordEntryContainer.classList.remove('hidden');
                                passwordForm.dataset.provider = key;
                                passwordInput.focus();

                                // Tự động cuộn mượt mà xuống phần nhập mật khẩu
                                setTimeout(() => {
                                    passwordEntryContainer.scrollIntoView({ behavior: 'smooth', block: 'start' });
                                }, 100);
                            } else {
                                paymentDetailsContainer.classList.remove('hidden');
                                updateDisplay(key);

                                // Tự động cuộn mượt mà xuống phần thông tin thanh toán
                                setTimeout(() => {
                                    paymentDetailsContainer.scrollIntoView({ behavior: 'smooth', block: 'start' });
                                }, 100);
                            }
                        });
                        paymentMethodsContainer.appendChild(button);
                    });
                }
            }

            passwordForm.addEventListener('submit', (e) => {
                e.preventDefault();
                const providerKey = e.target.dataset.provider;
                if (!providerKey) return;

                const info = bankingInfo[providerKey];
                const enteredPassword = passwordInput.value;

                if (enteredPassword === info.password) {
                    passwordEntryContainer.classList.add('hidden');
                    paymentDetailsContainer.classList.remove('hidden');
                    updateDisplay(providerKey);
                    passwordInput.value = '';
                    passwordError.textContent = '';
                } else {
                    passwordError.textContent = 'Mật khẩu không chính xác. Vui lòng thử lại.';
                    passwordInput.value = '';
                    passwordInput.focus();
                }
            });

            function createCopyButtons() {
                document.querySelectorAll('.copy-btn').forEach(btn => {
                    btn.classList.add('relative', 'p-1', 'rounded-full', 'hover:bg-gray-200');
                    btn.innerHTML = `<svg class="w-4 h-4 text-secondary" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z"></path></svg><span class="tooltip"><span class="tooltip-text">Sao chép</span></span>`;
                    btn.addEventListener('click', (e) => {
                        const targetId = e.currentTarget.dataset.target;
                        const textToCopy = document.getElementById(targetId).textContent;
                        copyToClipboard(textToCopy, e.currentTarget);
                    });
                });
            }

            function runApplication() {
                urlParams = { theme: 'online', ref: null, regions: [], amount: null };
                activeProviderButton = null;

                parseUrlParams();

                initializePage(urlParams.theme, urlParams);
                createCopyButtons();

                detailsPlaceholder.classList.remove('hidden');
                paymentDetailsContainer.classList.add('hidden');
                passwordEntryContainer.classList.add('hidden');
            }

            runApplication();

            window.addEventListener('hashchange', runApplication);
        });
    </script>
</body>

</html>