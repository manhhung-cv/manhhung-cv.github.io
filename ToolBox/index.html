<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Toolbox Đa Năng</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f0f0f5; /* iOS-like light gray background */
        }
        /* Custom scrollbar for generated email list */
        .email-list::-webkit-scrollbar {
            width: 6px;
        }
        .email-list::-webkit-scrollbar-track {
            background: transparent;
        }
        .email-list::-webkit-scrollbar-thumb {
            background: #d1d5db;
            border-radius: 10px;
        }
        .email-list::-webkit-scrollbar-thumb:hover {
            background: #9ca3af;
        }
        /* Modal transitions */
        .modal-transition {
            transition: opacity 0.3s ease, transform 0.3s ease;
        }
        .modal-hidden {
            opacity: 0;
            transform: scale(0.95) translateY(10px);
            pointer-events: none;
        }
        .modal-visible {
            opacity: 1;
            transform: scale(1) translateY(0);
            pointer-events: auto;
        }
        /* Bottom Nav styling */
        .nav-btn {
            transition: all 0.2s ease-in-out;
        }
        .nav-btn.active-nav svg {
            color: #2563eb; /* blue-600 */
        }
        .nav-btn.active-nav .nav-label {
            color: #1f2937; /* gray-800 */
            font-weight: 500;
        }
        .card-item {
            transition: all 0.3s ease-in-out;
        }
        .ios-card {
            background-color: #ffffff;
            border-radius: 1.25rem; /* 20px */
            box-shadow: 0 4px 12px rgba(0,0,0,0.05);
        }
    </style>
</head>
<body class="text-slate-800">

    <!-- Main Container with padding for bottom nav -->
    <div class="container mx-auto p-4 md:p-8 pb-32">
        <header class="text-center mb-8">
            <h1 class="text-4xl font-bold text-slate-900">Toolbox</h1>
            <p class="text-slate-600 mt-2">Bộ sưu tập các công cụ hữu ích</p>
        </header>

        <!-- Tab Content Area -->
        <main>
            <!-- Tab 1: Gmail Dot Trick -->
            <div id="gmail-trick" class="tab-content">
                <div class="ios-card p-4 sm:p-6">
                    <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center">
                        <div>
                            <h2 class="text-2xl font-semibold text-slate-900">Gmail Dot Trick</h2>
                            <p class="text-slate-500 mt-1">Tạo các biến thể email bằng cách thêm dấu chấm (.).</p>
                        </div>
                        <button id="openModalBtn" class="bg-blue-600 text-white font-semibold px-5 py-2.5 rounded-xl hover:bg-blue-700 focus:outline-none focus:ring-4 focus:ring-blue-300 transition-all duration-200 mt-4 sm:mt-0 whitespace-nowrap">
                            + Tạo Mới
                        </button>
                    </div>
                </div>
                <div id="cards-container" class="mt-6 space-y-4">
                    <!-- Generated cards will be inserted here -->
                </div>
            </div>

            <!-- Tab 2: Placeholder -->
            <div id="tool2" class="tab-content hidden">
                <div class="ios-card p-6 text-center">
                    <h2 class="text-2xl font-semibold text-slate-900">Công cụ #2</h2>
                    <p class="text-slate-500 mt-2">Tính năng này đang được phát triển. Vui lòng quay lại sau!</p>
                </div>
            </div>

            <!-- Tab 3: Placeholder -->
            <div id="tool3" class="tab-content hidden">
                <div class="ios-card p-6 text-center">
                    <h2 class="text-2xl font-semibold text-slate-900">Công cụ #3</h2>
                    <p class="text-slate-500 mt-2">Tính năng này đang được phát triển. Vui lòng quay lại sau!</p>
                </div>
            </div>
        </main>
    </div>

    <!-- iOS-style Bottom Navigation -->
    <nav class="fixed bottom-0 left-0 right-0 h-24 bg-transparent flex justify-center">
        <div class="flex items-center justify-center gap-4 sm:gap-6 bg-white/80 backdrop-blur-xl rounded-2xl sm:rounded-3xl shadow-lg px-4 sm:px-6 h-20 self-end mb-4">
            <button class="nav-btn active-nav flex flex-col items-center justify-center w-16 h-16" data-tab="gmail-trick">
                <svg xmlns="http://www.w3.org/2000/svg" width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-gray-600"><path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"></path></svg>
                <span class="nav-label text-xs text-gray-500 mt-1">Gmail Trick</span>
            </button>
            <button class="nav-btn flex flex-col items-center justify-center w-16 h-16" data-tab="tool2">
                <svg xmlns="http://www.w3.org/2000/svg" width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-gray-600"><path d="M15.5 2.5a2.5 2.5 0 0 1 3 3L8.5 21.5a2.5 2.5 0 0 1-3-3L15.5 2.5z"></path><path d="m14 6 3 3"></path><path d="M2.5 15.5a2.5 2.5 0 0 0 3 3L18.5 6a2.5 2.5 0 0 0-3-3L2.5 15.5z"></path></svg>
                <span class="nav-label text-xs text-gray-500 mt-1">Công cụ #2</span>
            </button>
            <button class="nav-btn flex flex-col items-center justify-center w-16 h-16" data-tab="tool3">
                <svg xmlns="http://www.w3.org/2000/svg" width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-gray-600"><path d="M12.22 2h-.44a2 2 0 0 0-2 2v.18a2 2 0 0 1-1 1.73l-.43.25a2 2 0 0 1-2 0l-.15-.08a2 2 0 0 0-2.73.73l-.22.38a2 2 0 0 0 .73 2.73l.15.1a2 2 0 0 1 0 2l-.15.08a2 2 0 0 0-.73 2.73l.22.38a2 2 0 0 0 2.73.73l.15-.08a2 2 0 0 1 2 0l.43.25a2 2 0 0 1 1 1.73V20a2 2 0 0 0 2 2h.44a2 2 0 0 0 2-2v-.18a2 2 0 0 1 1-1.73l.43-.25a2 2 0 0 1 2 0l.15.08a2 2 0 0 0 2.73-.73l.22-.38a2 2 0 0 0-.73-2.73l-.15-.08a2 2 0 0 1 0-2l.15-.08a2 2 0 0 0 .73-2.73l-.22-.38a2 2 0 0 0-2.73-.73l-.15.08a2 2 0 0 1-2 0l-.43-.25a2 2 0 0 1-1-1.73V4a2 2 0 0 0-2-2z"></path><circle cx="12" cy="12" r="3"></circle></svg>
                <span class="nav-label text-xs text-gray-500 mt-1">Công cụ #3</span>
            </button>
        </div>
    </nav>

    <!-- Modal for Email Input -->
    <div id="emailModal" class="fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center p-4 modal-transition modal-hidden z-50">
        <div class="bg-white/90 backdrop-blur-xl rounded-3xl shadow-2xl w-full max-w-md p-6 md:p-8">
            <h3 class="text-2xl font-bold text-center text-slate-900">Nhập Gmail của bạn</h3>
            <p class="text-slate-500 text-center mt-2">Chúng tôi sẽ tạo các biến thể từ email này.</p>
            <div class="mt-6">
                <input type="text" id="emailInput" placeholder="vidu hoặc vidu@gmail.com" class="w-full px-4 py-3 bg-white/70 border border-slate-300/70 rounded-xl focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition">
                <p id="error-message" class="text-red-500 text-sm mt-2 h-5"></p>
            </div>
            <div class="mt-4 grid grid-cols-1 sm:grid-cols-2 gap-3">
                <button id="closeModalBtn" class="w-full bg-gray-200 text-gray-800 font-semibold py-3 rounded-xl hover:bg-gray-300 transition-colors">Hủy</button>
                <button id="generateBtn" class="w-full bg-blue-600 text-white font-semibold py-3 rounded-xl hover:bg-blue-700 transition-colors">Tạo</button>
            </div>
        </div>
    </div>
    
    <!-- Delete Confirmation Modal -->
    <div id="deleteConfirmModal" class="fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center p-4 modal-transition modal-hidden z-50">
        <div class="bg-white/90 backdrop-blur-xl rounded-3xl shadow-2xl w-full max-w-sm p-6">
            <h3 class="text-xl font-bold text-slate-900 text-center">Xác nhận xóa</h3>
            <p class="text-slate-600 mt-2 text-center">Bạn có chắc chắn muốn xóa thẻ này không? Thao tác này không thể hoàn tác.</p>
            <div class="mt-6 grid grid-cols-2 gap-3">
                <button id="cancelDeleteBtn" class="px-4 py-3 bg-gray-200 text-gray-800 font-semibold rounded-xl hover:bg-gray-300 transition-colors">Hủy</button>
                <button id="confirmDeleteBtn" class="px-4 py-3 bg-red-600 text-white font-semibold rounded-xl hover:bg-red-700 transition-colors">Xóa</button>
            </div>
        </div>
    </div>

    <!-- Toast Notification -->
    <div id="toast" class="fixed top-5 left-1/2 -translate-x-1/2 bg-black/70 backdrop-blur-md text-white px-5 py-3 rounded-full shadow-lg opacity-0 -translate-y-3 transition-all duration-300 z-50">
        Đã sao chép!
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function () {
            const STORAGE_KEY = 'gmailTrickCardsData'; // Changed key to reflect data storage

            // --- Tab Switching Logic for Bottom Nav ---
            const navButtons = document.querySelectorAll('.nav-btn');
            const tabContents = document.querySelectorAll('.tab-content');

            navButtons.forEach(button => {
                button.addEventListener('click', () => {
                    navButtons.forEach(btn => btn.classList.remove('active-nav'));
                    tabContents.forEach(c => c.classList.add('hidden'));
                    button.classList.add('active-nav');
                    const targetContent = document.getElementById(button.dataset.tab);
                    if (targetContent) {
                        targetContent.classList.remove('hidden');
                    }
                });
            });

            // --- Gmail Tool Specific Logic ---
            const emailModal = document.getElementById('emailModal');
            const openModalBtn = document.getElementById('openModalBtn');
            const closeModalBtn = document.getElementById('closeModalBtn');
            const generateBtn = document.getElementById('generateBtn');
            const emailInput = document.getElementById('emailInput');
            const errorMessage = document.getElementById('error-message');
            const deleteConfirmModal = document.getElementById('deleteConfirmModal');
            const cancelDeleteBtn = document.getElementById('cancelDeleteBtn');
            const confirmDeleteBtn = document.getElementById('confirmDeleteBtn');
            let cardToDelete = null;
            const cardsContainer = document.getElementById('cards-container');
            const toast = document.getElementById('toast');
            
            // --- NEW: Data-centric Functions ---
            
            /**
             * Retrieves card data from localStorage.
             * @returns {Array} An array of card data objects.
             */
            function getCardsFromStorage() {
                const data = localStorage.getItem(STORAGE_KEY);
                try {
                    return data ? JSON.parse(data) : [];
                } catch (e) {
                    console.error("Error parsing localStorage data:", e);
                    return [];
                }
            }

            /**
             * Saves the current card data to localStorage.
             * @param {Array} cardsData - The array of card data objects to save.
             */
            function saveCardsToStorage(cardsData) {
                localStorage.setItem(STORAGE_KEY, JSON.stringify(cardsData));
            }

            /**
             * Renders all cards from the data stored in localStorage.
             */
            function renderAllCards() {
                cardsContainer.innerHTML = ''; // Clear existing cards
                const cardsData = getCardsFromStorage();
                cardsData.forEach(cardData => {
                    // Re-generate variations and create the card element
                    const username = cardData.email.split('@')[0];
                    const reversedUsername = username.split('').reverse().join('');
                    const reversedVariations = generateAllDotTricks(reversedUsername);
                    const finalVariations = reversedVariations.map(v => v.split('').reverse().join(''));
                    const variationsForCard = finalVariations.filter(v => v !== username);
                    createResultCard(cardData.id, cardData.email, variationsForCard);
                });
            }

            // Initial load from storage
            renderAllCards();


            // --- Event Listeners and Handlers ---

            openModalBtn.addEventListener('click', () => {
                emailModal.classList.remove('modal-hidden');
                emailModal.classList.add('modal-visible');
                emailInput.focus();
                emailInput.value = '';
                errorMessage.textContent = '';
            });

            function closeModal(modal) {
                modal.classList.add('modal-hidden');
                modal.classList.remove('modal-visible');
            }

            closeModalBtn.addEventListener('click', () => closeModal(emailModal));
            generateBtn.addEventListener('click', handleGeneration);
            emailInput.addEventListener('keydown', (event) => {
                if (event.key === 'Enter') handleGeneration();
            });

            function handleGeneration() {
                let email = emailInput.value.trim().toLowerCase();
                if (email && !email.includes('@')) email += '@gmail.com';
                if (!email || !email.endsWith('@gmail.com')) {
                    errorMessage.textContent = 'Vui lòng nhập một địa chỉ Gmail hợp lệ.';
                    return;
                }
                const username = email.split('@')[0];
                if (username.length === 0) {
                    errorMessage.textContent = 'Tên người dùng không thể để trống.';
                    return;
                }
                if (username.length > 15) {
                    errorMessage.textContent = 'Tên người dùng quá dài để tránh treo trình duyệt.';
                    return;
                }
                errorMessage.textContent = '';

                // Add new card data to storage
                const cardsData = getCardsFromStorage();
                const newCard = { id: Date.now(), email: email };
                cardsData.unshift(newCard); // Add to the beginning of the array
                saveCardsToStorage(cardsData);

                // Re-render all cards to reflect the change
                renderAllCards();
                
                closeModal(emailModal);
            }

            function generateAllDotTricks(username) {
                const results = new Set();
                const n = username.length;
                if (n === 0) return [];
                const limit = 1 << (n - 1);
                for (let i = 0; i < limit; i++) {
                    let newUsername = username[0];
                    for (let j = 0; j < n - 1; j++) {
                        if ((i >> j) & 1) newUsername += '.';
                        newUsername += username[j + 1];
                    }
                    results.add(newUsername);
                }
                return Array.from(results);
            }

            function createResultCard(id, originalEmail, variations) {
                const card = document.createElement('div');
                card.className = 'card-item ios-card p-4 sm:p-5 transition-all duration-500 transform';
                card.dataset.id = id; // Set a data attribute for identification
                
                const listItems = variations.map(variation => `
                    <div class="flex justify-between items-center bg-slate-100 p-2.5 rounded-xl group">
                        <span class="text-slate-800 select-all break-all pr-2 text-sm sm:text-base">${variation}@gmail.com</span>
                        <button class="copy-btn text-slate-500 hover:text-blue-600 opacity-0 group-hover:opacity-100 transition-opacity" data-clipboard-text="${variation}@gmail.com">
                           <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="pointer-events-none"><rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path></svg>
                        </button>
                    </div>`).join('');

                const allEmailsText = variations.map(v => `${v}@gmail.com`).join('\n');
                card.innerHTML = `
                    <div class="flex justify-between items-start mb-4">
                        <div>
                            <p class="text-sm text-slate-500">Email gốc</p>
                            <h3 class="text-lg sm:text-xl font-semibold text-blue-600 break-all">${originalEmail}</h3>
                            <p class="text-sm font-medium text-slate-700 mt-1">Đã tạo <span class="text-green-600 font-bold">${variations.length}</span> biến thể.</p>
                        </div>
                        <button class="delete-btn text-gray-400 hover:text-red-500 transition-colors w-8 h-8 flex items-center justify-center rounded-full hover:bg-gray-100">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 pointer-events-none" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2.5"><path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" /></svg>
                        </button>
                    </div>
                    <div class="max-h-64 overflow-y-auto pr-2 email-list space-y-2">${listItems}</div>
                    <div class="mt-4 pt-4 border-t border-slate-200/80">
                        <button class="copy-btn w-full bg-green-500 text-white font-semibold py-3 rounded-xl hover:bg-green-600 focus:outline-none focus:ring-4 focus:ring-green-300 transition-all" data-clipboard-text="${allEmailsText}">
                            Sao chép tất cả (${variations.length})
                        </button>
                    </div>`;
                cardsContainer.appendChild(card); // Use appendChild instead of prepend
            }

            cardsContainer.addEventListener('click', function(e) {
                const copyBtn = e.target.closest('.copy-btn');
                if (copyBtn) {
                    copyToClipboard(copyBtn.dataset.clipboardText);
                    return;
                }
                const deleteBtn = e.target.closest('.delete-btn');
                if (deleteBtn) {
                    cardToDelete = deleteBtn.closest('.card-item');
                    deleteConfirmModal.classList.remove('modal-hidden');
                    deleteConfirmModal.classList.add('modal-visible');
                }
            });

            cancelDeleteBtn.addEventListener('click', () => closeModal(deleteConfirmModal));
            confirmDeleteBtn.addEventListener('click', () => {
                if (cardToDelete) {
                    const cardId = cardToDelete.dataset.id;
                    let cardsData = getCardsFromStorage();
                    // Filter out the card to be deleted
                    cardsData = cardsData.filter(card => card.id.toString() !== cardId);
                    saveCardsToStorage(cardsData);
                    // Remove from DOM
                    cardToDelete.remove();
                    cardToDelete = null;
                }
                closeModal(deleteConfirmModal);
            });

            function copyToClipboard(text) {
                const textarea = document.createElement('textarea');
                textarea.value = text;
                document.body.appendChild(textarea);
                textarea.select();
                try {
                    document.execCommand('copy');
                    showToast('Đã sao chép thành công!');
                } catch (err) {
                    showToast('Lỗi! Không thể sao chép.');
                }
                document.body.removeChild(textarea);
            }
            
            let toastTimer;
            function showToast(message) {
                toast.textContent = message;
                clearTimeout(toastTimer);
                toast.classList.remove('opacity-0', '-translate-y-3');
                toastTimer = setTimeout(() => {
                    toast.classList.add('opacity-0', '-translate-y-3');
                }, 2000);
            }
        });
    </script>
</body>
</html>
