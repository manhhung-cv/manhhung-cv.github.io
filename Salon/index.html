<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>H·ªá Th·ªëng ƒê·∫∑t L·ªãch H·∫πn - Ti·ªám T√≥c (v13 - Admin Tools)</title>

    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Be+Vietnam+Pro:wght@400;500;600;700;800&display=swap"
        rel="stylesheet">
    <script src="https://unpkg.com/feather-icons"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

    <style>
        body { font-family: 'Be Vietnam Pro', sans-serif; background-color: #f7f7f7; }
        .tab-active { border-color: #4f46e5; color: #4f46e5; background-color: #eef2ff; }
        .timeslot {
            border: 2px solid #e5e7eb; padding: 0.5rem; border-radius: 0.375rem;
            font-weight: 600; transition: all 0.2s ease-in-out; cursor: pointer;
        }
        .timeslot:hover:not(.disabled) { border-color: #a5b4fc; background-color: #eef2ff; }
        .timeslot.disabled { background-color: #f3f4f6; color: #9ca3af; cursor: not-allowed; border-color: #e5e7eb; }
        .timeslot-selected { background-color: #4f46e5; color: white; border-color: #4f46e5; }

        .status-badge { padding: 2px 8px; border-radius: 9999px; font-size: 0.75rem; font-weight: 600; text-transform: uppercase; }
        .status-pending { background-color: #fef9c3; color: #ca8a04; }
        .status-confirmed { background-color: #dcfce7; color: #16a34a; }
        .status-rejected { background-color: #fee2e2; color: #dc2626; }
        .status-cancelled { background-color: #e5e7eb; color: #4b5563; }
    </style>
</head>

<body class="antialiased text-slate-800">

    <div class="min-h-screen flex flex-col items-center p-4 bg-gray-50">
        <div class="w-full max-w-6xl mx-auto">
            <header class="text-center mb-8 relative">
                <h1 class="text-4xl md:text-5xl font-bold text-slate-900">Salon T√≥c Chuy√™n Nghi·ªáp</h1>
                <p class="mt-2 text-lg text-slate-600">H·ªá th·ªëng qu·∫£n l√Ω v√† ƒë·∫∑t l·ªãch h·∫πn th√¥ng minh</p>
                <div class="absolute top-0 right-0">
                    <button id="showLoginModalButton" class="bg-white text-indigo-600 font-semibold px-4 py-2 rounded-lg shadow hover:bg-indigo-50 transition-all">
                        <i data-feather="log-in" class="inline-block w-4 h-4 mr-2"></i>Admin
                    </button>
                </div>
            </header>

            <div id="adminPanel" class="hidden bg-indigo-50 border-2 border-dashed border-indigo-200 p-6 rounded-2xl mb-8">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-2xl font-bold text-indigo-800 flex items-center"><i data-feather="settings" class="mr-2"></i>B·∫£ng ƒêi·ªÅu Khi·ªÉn Admin</h2>
                    <button id="logoutButton" class="bg-red-500 text-white font-semibold px-4 py-2 rounded-lg shadow hover:bg-red-600 transition-all">
                        <i data-feather="log-out" class="inline-block w-4 h-4 mr-2"></i>ƒêƒÉng Xu·∫•t
                    </button>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                    <div class="bg-white p-4 rounded-lg shadow-sm">
                        <h3 class="font-semibold mb-2">C√†i ƒë·∫∑t Salon</h3>
                        <form id="adminSettingsForm" class="space-y-3">
                            <div>
                                <label for="openingTime" class="block text-sm font-medium">Gi·ªù m·ªü c·ª≠a</label>
                                <input type="time" id="openingTime" class="mt-1 w-full rounded-md border-gray-300 shadow-sm">
                            </div>
                            <div>
                                <label for="closingTime" class="block text-sm font-medium">Gi·ªù ƒë√≥ng c·ª≠a</label>
                                <input type="time" id="closingTime" class="mt-1 w-full rounded-md border-gray-300 shadow-sm">
                            </div>
                            <div>
                                <label for="maxCapacity" class="block text-sm font-medium">S·ª©c ch·ª©a / khung gi·ªù</label>
                                <input type="number" id="maxCapacity" min="1" class="mt-1 w-full rounded-md border-gray-300 shadow-sm">
                            </div>
                            <button type="submit" class="w-full bg-indigo-600 text-white px-4 py-2 rounded-md hover:bg-indigo-700 font-semibold">L∆∞u C√†i ƒê·∫∑t</button>
                        </form>
                    </div>
                    <div class="bg-white p-4 rounded-lg shadow-sm">
                        <h3 class="font-semibold mb-2">C√¥ng c·ª• D·ªØ li·ªáu</h3>
                        <div class="space-y-2">
                             <button id="exportCsvButton" class="w-full bg-green-600 text-white px-4 py-2 rounded-md hover:bg-green-700 font-semibold">Xu·∫•t CSV</button>
                             <button id="deleteAllButton" class="w-full bg-red-600 text-white px-4 py-2 rounded-md hover:bg-red-700 font-semibold">X√≥a To√†n B·ªô D·ªØ Li·ªáu</button>
                        </div>
                    </div>
                     <div class="bg-white p-4 rounded-lg shadow-sm">
                        <h3 class="font-semibold mb-2">Y√™u c·∫ßu t∆∞ v·∫•n</h3>
                        <div id="quickBookingsList" class="space-y-2 max-h-48 overflow-y-auto"></div>
                    </div>
                </div>
                 <div class="mt-6 bg-white p-4 rounded-lg shadow-sm">
                    <h3 class="font-semibold mb-2">Danh s√°ch ƒë√£ t∆∞ v·∫•n</h3>
                    <div id="consultedBookingsList" class="space-y-2 max-h-48 overflow-y-auto"></div>
                </div>
            </div>

            <main class="bg-white p-6 rounded-2xl shadow-lg">
                <div class="flex border-b mb-6">
                    <button id="tab-booking" class="tab-active py-2 px-4 font-semibold border-b-2">üìÖ ƒê·∫∑t L·ªãch M·ªõi</button>
                    <button id="tab-my-appointments" class="py-2 px-4 font-semibold text-gray-500 border-b-2 border-transparent">üìñ L·ªãch H·∫πn C·ªßa T√¥i</button>
                    <button id="tab-quick-booking" class="py-2 px-4 font-semibold text-gray-500 border-b-2 border-transparent">‚ö° ƒê·∫∑t Ch·ªó Nhanh</button>
                </div>

                <div id="view-booking">
                     <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                        <div>
                            <h2 class="text-xl font-bold mb-4">1. ƒêi·ªÅn th√¥ng tin c·ªßa b·∫°n</h2>
                            <form id="bookingForm" class="space-y-4">
                                <div>
                                    <label for="customerName" class="block text-sm font-medium text-slate-700">T√™n kh√°ch h√†ng</label>
                                    <input type="text" id="customerName" required class="mt-1 w-full rounded-md border-gray-300 shadow-sm">
                                </div>
                                <div>
                                    <label for="phoneNumber" class="block text-sm font-medium text-slate-700">S·ªë ƒëi·ªán tho·∫°i</label>
                                    <input type="tel" id="phoneNumber" required class="mt-1 w-full rounded-md border-gray-300 shadow-sm">
                                </div>
                                <div>
                                    <label for="service" class="block text-sm font-medium text-slate-700">D·ªãch v·ª•</label>
                                    <select id="service" class="mt-1 w-full rounded-md border-gray-300 shadow-sm">
                                        <option>C·∫Øt t√≥c nam</option>
                                        <option>C·∫Øt t√≥c n·ªØ</option>
                                        <option>G·ªôi ƒë·∫ßu & s·∫•y</option>
                                        <option>Nhu·ªôm t√≥c</option>
                                        <option>U·ªën/Du·ªói t√≥c</option>
                                    </select>
                                </div>
                                <input type="hidden" id="selectedTime" required>
                                <button type="submit" id="submitButton" class="w-full bg-indigo-600 text-white px-4 py-3 rounded-md hover:bg-indigo-700 font-bold text-base transition-all">Ho√†n T·∫•t ƒê·∫∑t L·ªãch</button>
                            </form>
                        </div>
                        <div>
                            <h2 class="text-xl font-bold mb-4">2. Ch·ªçn ng√†y v√† gi·ªù</h2>
                            <div>
                                <label for="bookingDate" class="block text-sm font-medium text-slate-700">Ch·ªçn ng√†y</label>
                                <input type="date" id="bookingDate" required class="mt-1 w-full rounded-md border-gray-300 shadow-sm">
                            </div>
                            <div class="mt-4">
                                <label class="block text-sm font-medium text-slate-700 mb-2">Ch·ªçn gi·ªù</label>
                                <div id="timeSlotsContainer" class="grid grid-cols-3 sm:grid-cols-4 md:grid-cols-5 gap-2"></div>
                            </div>
                        </div>
                    </div>
                </div>

                <div id="view-my-appointments" class="hidden">
                    <div class="max-w-2xl mx-auto">
                        <h2 class="text-2xl font-bold mb-4 text-center">L·ªãch H·∫πn C·ªßa T√¥i</h2>
                        <p class="text-slate-600 mb-6 text-center">Nh·∫≠p s·ªë ƒëi·ªán tho·∫°i ƒë·ªÉ xem v√† qu·∫£n l√Ω c√°c l·ªãch h·∫πn c·ªßa b·∫°n.</p>
                        <form id="myAppointmentsForm" class="flex gap-2 mb-8">
                            <input type="tel" id="myAppointmentsPhone" placeholder="Nh·∫≠p s·ªë ƒëi·ªán tho·∫°i c·ªßa b·∫°n" required class="flex-grow w-full rounded-md border-gray-300 shadow-sm text-lg p-3">
                            <button type="submit" class="bg-indigo-600 text-white px-6 py-3 rounded-md hover:bg-indigo-700 font-bold text-base transition-all">T√¨m Ki·∫øm</button>
                        </form>
                        <div id="myAppointmentsList" class="space-y-4"></div>
                    </div>
                </div>

                <div id="view-quick-booking" class="hidden">
                     <div class="max-w-md mx-auto text-center">
                        <h2 class="text-2xl font-bold mb-2">ƒê·∫∑t Ch·ªó Nhanh</h2>
                        <p class="text-slate-600 mb-6">Ch·ªâ c·∫ßn ƒë·ªÉ l·∫°i s·ªë ƒëi·ªán tho·∫°i, ch√∫ng t√¥i s·∫Ω g·ªçi l·∫°i t∆∞ v·∫•n v√† s·∫Øp x·∫øp l·ªãch h·∫πn cho b·∫°n ngay!</p>
                        <form id="quickBookingForm" class="flex gap-2">
                            <input type="tel" id="quickPhoneNumber" placeholder="Nh·∫≠p s·ªë ƒëi·ªán tho·∫°i c·ªßa b·∫°n" required class="flex-grow w-full rounded-md border-gray-300 shadow-sm text-lg p-3">
                            <button type="submit" class="bg-indigo-600 text-white px-6 py-3 rounded-md hover:bg-indigo-700 font-bold text-base transition-all">G·ª≠i Y√™u C·∫ßu</button>
                        </form>
                    </div>
                </div>
            </main>

            <div id="adminAppointmentsSection" class="hidden mt-10 w-full max-w-6xl mx-auto">
                <h2 class="text-2xl font-bold mb-4">Danh S√°ch L·ªãch H·∫πn (Admin View)</h2>
                <div id="appointmentsList" class="space-y-3 max-h-[60vh] overflow-y-auto pr-2"></div>
            </div>
        </div>
    </div>

    <div id="loginModal" class="modal fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 hidden z-50">
        <div class="bg-white rounded-lg shadow-xl p-8 w-full max-w-sm">
            <h2 class="text-2xl font-bold text-center mb-6">ƒêƒÉng Nh·∫≠p Admin</h2>
            <form id="loginForm" class="space-y-4">
                <div>
                    <label for="email" class="block text-sm font-medium text-gray-700">Email</label>
                    <input type="email" id="email" required class="mt-1 w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm">
                </div>
                <div>
                    <label for="password" class="block text-sm font-medium text-gray-700">M·∫≠t kh·∫©u</label>
                    <input type="password" id="password" required class="mt-1 w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm">
                </div>
                <p id="loginError" class="text-sm text-red-600 hidden"></p>
                <div class="flex items-center justify-between pt-4">
                    <button type="button" id="closeLoginModalButton" class="text-gray-600 hover:text-gray-900">H·ªßy</button>
                    <button type="submit" class="bg-indigo-600 text-white font-semibold px-6 py-2 rounded-md hover:bg-indigo-700">ƒêƒÉng Nh·∫≠p</button>
                </div>
            </form>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged, signInWithEmailAndPassword, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, query, where, onSnapshot, doc, deleteDoc, Timestamp, setDoc, getDoc, updateDoc, getDocs, writeBatch } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyDmoz4VMGwlLz5lsrYiT6GQZHJlmkN5igo",
            authDomain: "salon-booking-39f42.firebaseapp.com",
            projectId: "salon-booking-39f42",
            storageBucket: "salon-booking-39f42.firebasestorage.app",
            messagingSenderId: "499019851171",
            appId: "1:499019851171:web:9a4731d7d2c5faf1182616",
            measurementId: "G-ZRLC3JQMLZ"
        };
        const appId = 'default-salon-app-v2';

        let db, auth, isAdmin = false;
        let appointmentsColRef, quickBookingsColRef, configDocRef, consultedBookingsColRef;
        let salonConfig = {};
        let appointmentsListener = null, quickBookingsListener = null, consultedBookingsListener = null;
        const ADMIN_UID_FALLBACK = "E9hxk3SkfwgdJRCzapOue4unfRf2";

        const loginModal = document.getElementById('loginModal');
        const showLoginModalButton = document.getElementById('showLoginModalButton');
        const closeLoginModalButton = document.getElementById('closeLoginModalButton');
        const loginForm = document.getElementById('loginForm');
        const loginError = document.getElementById('loginError');
        const logoutButton = document.getElementById('logoutButton');
        const adminPanel = document.getElementById('adminPanel');
        const bookingForm = document.getElementById('bookingForm');
        const quickBookingForm = document.getElementById('quickBookingForm');
        const adminSettingsForm = document.getElementById('adminSettingsForm');
        const bookingDateInput = document.getElementById('bookingDate');
        const timeSlotsContainer = document.getElementById('timeSlotsContainer');
        const adminAppointmentsSection = document.getElementById('adminAppointmentsSection');
        const appointmentsList = document.getElementById('appointmentsList');
        const tabBooking = document.getElementById('tab-booking');
        const tabMyAppointments = document.getElementById('tab-my-appointments');
        const tabQuickBooking = document.getElementById('tab-quick-booking');
        const viewBooking = document.getElementById('view-booking');
        const viewMyAppointments = document.getElementById('view-my-appointments');
        const viewQuickBooking = document.getElementById('view-quick-booking');
        const myAppointmentsForm = document.getElementById('myAppointmentsForm');
        const myAppointmentsList = document.getElementById('myAppointmentsList');
        const exportCsvButton = document.getElementById('exportCsvButton');
        const deleteAllButton = document.getElementById('deleteAllButton');
        const consultedBookingsList = document.getElementById('consultedBookingsList');

        document.addEventListener('DOMContentLoaded', async () => {
            try {
                const app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);
                const basePath = `/artifacts/${appId}/public/data`;
                appointmentsColRef = collection(db, `${basePath}/appointments`);
                quickBookingsColRef = collection(db, `${basePath}/quickBookings`);
                consultedBookingsColRef = collection(db, `${basePath}/consultedBookings`);
                configDocRef = doc(db, `${basePath}/config/salonSettings`);
                const today = new Date();
                today.setMinutes(today.getMinutes() - today.getTimezoneOffset());
                bookingDateInput.value = today.toISOString().slice(0, 10);
                bookingDateInput.min = today.toISOString().slice(0, 10);
                onAuthStateChanged(auth, handleAuthStateChange);
                setupEventListeners();
                feather.replace();
            } catch (error) {
                console.error("Initialization failed:", error);
                Swal.fire('L·ªói Kh·ªüi T·∫°o', 'Kh√¥ng th·ªÉ t·∫£i ·ª©ng d·ª•ng. Vui l√≤ng th·ª≠ l·∫°i.', 'error');
            }
        });

        function setupEventListeners() {
            showLoginModalButton.addEventListener('click', () => { loginModal.classList.remove('hidden'); });
            closeLoginModalButton.addEventListener('click', () => { loginModal.classList.add('hidden'); });
            loginForm.addEventListener('submit', handleLogin);
            logoutButton.addEventListener('click', handleLogout);
            bookingForm.addEventListener('submit', handleBookingSubmit);
            quickBookingForm.addEventListener('submit', handleQuickBookingSubmit);
            adminSettingsForm.addEventListener('submit', handleAdminSettingsSave);
            bookingDateInput.addEventListener('change', () => {
                document.getElementById('selectedTime').value = '';
                fetchAppointmentsForDate(bookingDateInput.value);
            });
            tabBooking.addEventListener('click', () => switchTab('booking'));
            tabMyAppointments.addEventListener('click', () => switchTab('my-appointments'));
            tabQuickBooking.addEventListener('click', () => switchTab('quick-booking'));
            myAppointmentsForm.addEventListener('submit', handleMyAppointmentsLookup);
            exportCsvButton.addEventListener('click', exportDataToCSV);
            deleteAllButton.addEventListener('click', deleteAllData);
        }
        
        function maskInfo(value, type) {
            if (!value) return '';
            if (type === 'name') {
                const parts = value.trim().split(' ');
                if (parts.length > 1) { const lastName = parts[parts.length - 1]; return `${parts[0]}... ${lastName}`; }
                return `${value.charAt(0)}${'*'.repeat(Math.max(0, value.length - 1))}`;
            }
            if (type === 'phone' && value.length > 6) return `${value.substring(0, 3)}****${value.substring(value.length - 3)}`;
            return value;
        }

        function showModernSuccessNotification(apt) {
            Swal.fire({
                title: 'ƒê·∫∑t L·ªãch Th√†nh C√¥ng!',
                html: `
                    <div class="text-left p-4">
                        <p class="text-lg">C·∫£m ∆°n <strong>${apt.name}</strong>!</p>
                        <p>L·ªãch h·∫πn c·ªßa b·∫°n ƒë√£ ƒë∆∞·ª£c ghi nh·∫≠n v√† ƒëang ch·ªù x√°c nh·∫≠n.</p>
                        <div class="mt-4 text-left bg-indigo-50 p-3 rounded-lg">
                            <p><strong>M√£ ƒë·∫∑t l·ªãch:</strong> <span class="font-bold text-indigo-600">${apt.bookingId}</span></p>
                            <p><strong>Th·ªùi gian:</strong> ${apt.time} - ${apt.date}</p>
                        </div>
                        <p class="text-sm text-slate-500 mt-3">S·ª≠ d·ª•ng SƒêT c·ªßa b·∫°n ƒë·ªÉ tra c·ª©u trong m·ª•c "L·ªãch H·∫πn C·ªßa T√¥i".</p>
                    </div>`,
                icon: 'success',
                confirmButtonText: 'Tuy·ªát v·ªùi!',
                cancelButtonText: 'Sao ch√©p m√£',
                showCancelButton: true,
            }).then((result) => {
                if (result.dismiss === Swal.DismissReason.cancel) {
                    navigator.clipboard.writeText(apt.bookingId).then(() => {
                         Swal.fire({ toast: true, position: 'top-end', icon: 'success', title: 'ƒê√£ sao ch√©p!', showConfirmButton: false, timer: 1500 });
                    });
                }
            });
        }

        async function handleAuthStateChange(user) {
            try {
                const docSnap = await getDoc(configDocRef);
                if (docSnap.exists()) {
                    salonConfig = docSnap.data();
                } else {
                    salonConfig = { openingTime: "09:00", closingTime: "20:00", maxCapacity: 2, adminUID: ADMIN_UID_FALLBACK };
                    if (user && user.uid === ADMIN_UID_FALLBACK) await setDoc(configDocRef, salonConfig);
                }
                if (user && !user.isAnonymous) {
                    isAdmin = user.uid === salonConfig.adminUID || user.uid === ADMIN_UID_FALLBACK;
                    if (!isAdmin) await handleLogout();
                } else if (user && user.isAnonymous) {
                    isAdmin = false;
                } else {
                    isAdmin = false; await signInAnonymously(auth);
                }
            } catch (error) {
                console.error("Auth state change error:", error);
                isAdmin = false;
            } finally {
                setupUIBasedOnAuth();
            }
        }

        async function handleLogin(e) {
            e.preventDefault();
            loginError.classList.add('hidden');
            try {
                await signInWithEmailAndPassword(auth, loginForm.email.value, loginForm.password.value);
                loginModal.classList.add('hidden');
                loginForm.reset();
            } catch (error) {
                loginError.textContent = "Email ho·∫∑c m·∫≠t kh·∫©u kh√¥ng ƒë√∫ng.";
                loginError.classList.remove('hidden');
            }
        }

        async function handleLogout() {
            try { await signOut(auth); } catch (error) { console.error("Logout failed:", error); }
        }

        function setupUIBasedOnAuth() {
            if (isAdmin) {
                adminPanel.classList.remove('hidden');
                adminAppointmentsSection.classList.remove('hidden');
                showLoginModalButton.classList.add('hidden');
                if(salonConfig.openingTime) adminSettingsForm.openingTime.value = salonConfig.openingTime;
                if(salonConfig.closingTime) adminSettingsForm.closingTime.value = salonConfig.closingTime;
                if(salonConfig.maxCapacity) adminSettingsForm.maxCapacity.value = salonConfig.maxCapacity;
                listenForQuickBookings();
                listenForConsultedBookings();
            } else {
                adminPanel.classList.add('hidden');
                adminAppointmentsSection.classList.add('hidden');
                showLoginModalButton.classList.remove('hidden');
                if (quickBookingsListener) { quickBookingsListener(); quickBookingsListener = null; }
                if (consultedBookingsListener) { consultedBookingsListener(); consultedBookingsListener = null; }
            }
            fetchAppointmentsForDate(bookingDateInput.value);
            feather.replace();
        }
        
        function fetchAppointmentsForDate(date) {
            if (appointmentsListener) appointmentsListener();
            const q = query(appointmentsColRef, where("date", "==", date));
            appointmentsListener = onSnapshot(q, (snapshot) => {
                let appointmentsForDay = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                renderTimeSlotsForBooking(appointmentsForDay);
                if (isAdmin) {
                    renderAppointmentsList(appointmentsForDay);
                }
            });
        }
        
        function renderTimeSlotsForBooking(appointmentsForDay = []) {
            const html = getTimeSlotsHTML(appointmentsForDay);
            timeSlotsContainer.innerHTML = html || `<p class="col-span-full text-center text-gray-500 p-4">Vui l√≤ng ch·ªçn ng√†y ƒë·ªÉ xem khung gi·ªù.</p>`;
            timeSlotsContainer.querySelectorAll('.timeslot:not(.disabled)').forEach(slot => slot.addEventListener('click', handleTimeSlotClick));
        }

        function getTimeSlotsHTML(appointmentsForDay = []) {
            const { openingTime, closingTime, maxCapacity } = salonConfig;
            if (!openingTime || !closingTime || !maxCapacity) return `<p class="col-span-full text-red-500 p-4">Admin ch∆∞a c√†i ƒë·∫∑t gi·ªù ho·∫°t ƒë·ªông.</p>`;
            const selectedDateStr = bookingDateInput.value;
            const now = new Date();
            const todayStr = new Date(now.getTime() - now.getTimezoneOffset() * 60000).toISOString().slice(0, 10);
            let currentTime = new Date(`${selectedDateStr}T${openingTime}`);
            const closingDateTime = new Date(`${selectedDateStr}T${closingTime}`);
            let html = '';
            while (currentTime < closingDateTime) {
                const timeStr = currentTime.toTimeString().slice(0, 5);
                const bookingsAtTime = appointmentsForDay.filter(apt => apt.time === timeStr && (apt.status === 'pending' || apt.status === 'confirmed')).length;
                const isFull = bookingsAtTime >= maxCapacity;
                const isPast = selectedDateStr < todayStr || (selectedDateStr === todayStr && timeStr < now.toTimeString().slice(0, 5));
                const isDisabled = isFull || isPast;
                html += `<button type="button" data-time="${timeStr}" class="timeslot ${isDisabled ? 'disabled' : ''}" ${isDisabled ? 'disabled' : ''}>${isFull ? 'H·∫øt ch·ªó' : timeStr}</button>`;
                currentTime.setMinutes(currentTime.getMinutes() + 30);
            }
            return html;
        }

        function handleTimeSlotClick(e) {
            document.querySelectorAll('.timeslot-selected').forEach(el => el.classList.remove('timeslot-selected'));
            e.currentTarget.classList.add('timeslot-selected');
            document.getElementById('selectedTime').value = e.currentTarget.dataset.time;
        }

        async function handleBookingSubmit(e) {
            e.preventDefault();
            const phone = bookingForm.phoneNumber.value.trim();
            if (!document.getElementById('selectedTime').value) return Swal.fire('Thi·∫øu th√¥ng tin', 'Vui l√≤ng ch·ªçn m·ªôt khung gi·ªù c√≤n tr·ªëng.', 'warning');
            try {
                const q = query(appointmentsColRef, where("phone", "==", phone), where("status", "in", ["pending", "confirmed"]));
                if ((await getDocs(q)).size >= 2) return Swal.fire('ƒê√£ ƒë·∫°t gi·ªõi h·∫°n', 'B·∫°n ƒë√£ c√≥ 2 l·ªãch h·∫πn ƒëang ho·∫°t ƒë·ªông.', 'error');
            } catch (error) { return Swal.fire('L·ªói', 'Kh√¥ng th·ªÉ ki·ªÉm tra l·ªãch h·∫πn hi·ªán t·∫°i.', 'error'); }
            const newAppointment = {
                name: bookingForm.customerName.value.trim(), phone, service: bookingForm.service.value,
                date: bookingDateInput.value, time: document.getElementById('selectedTime').value,
                createdAt: Timestamp.now(), bookingId: `S${Date.now().toString().slice(-6)}`, status: 'pending'
            };
            try {
                await addDoc(appointmentsColRef, newAppointment);
                showModernSuccessNotification(newAppointment);
                bookingForm.reset();
                document.getElementById('selectedTime').value = '';
                document.querySelectorAll('.timeslot-selected').forEach(el => el.classList.remove('timeslot-selected'));
            } catch (error) { Swal.fire('Th·∫•t B·∫°i', 'ƒê√£ c√≥ l·ªói x·∫£y ra. Vui l√≤ng th·ª≠ l·∫°i.', 'error'); }
        }

        async function handleQuickBookingSubmit(e) {
            e.preventDefault();
            try {
                await addDoc(quickBookingsColRef, { phone: quickBookingForm.quickPhoneNumber.value.trim(), createdAt: Timestamp.now() });
                Swal.fire('ƒê√£ G·ª≠i Y√™u C·∫ßu', 'C·∫£m ∆°n b·∫°n! T∆∞ v·∫•n vi√™n s·∫Ω li√™n h·ªá v·ªõi b·∫°n s·ªõm nh·∫•t.', 'success');
                quickBookingForm.reset();
            } catch (error) { Swal.fire('Th·∫•t B·∫°i', 'Kh√¥ng th·ªÉ g·ª≠i y√™u c·∫ßu. Vui l√≤ng th·ª≠ l·∫°i.', 'error'); }
        }

        async function handleAdminSettingsSave(e) {
            e.preventDefault();
            const newConfig = {
                openingTime: adminSettingsForm.openingTime.value, closingTime: adminSettingsForm.closingTime.value,
                maxCapacity: parseInt(adminSettingsForm.maxCapacity.value, 10), adminUID: auth.currentUser.uid
            };
            try {
                await setDoc(configDocRef, newConfig);
                salonConfig = newConfig;
                fetchAppointmentsForDate(bookingDateInput.value);
                Swal.fire('ƒê√£ L∆∞u', 'C√†i ƒë·∫∑t salon ƒë√£ ƒë∆∞·ª£c c·∫≠p nh·∫≠t.', 'success');
            } catch (error) { Swal.fire('L·ªói', 'Kh√¥ng th·ªÉ l∆∞u c√†i ƒë·∫∑t.', 'error'); }
        }

        async function handleMyAppointmentsLookup(e) {
            e.preventDefault();
            const phone = document.getElementById('myAppointmentsPhone').value.trim();
            if (!phone) return;
            myAppointmentsList.innerHTML = `<p class="text-center text-gray-500">ƒêang t√¨m ki·∫øm...</p>`;
            try {
                const q = query(appointmentsColRef, where("phone", "==", phone), where("status", "in", ["pending", "confirmed", "rejected"]));
                const snapshot = await getDocs(q);
                const userAppointments = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                userAppointments.sort((a, b) => b.createdAt.toMillis() - a.createdAt.toMillis());
                renderMyAppointments(userAppointments);
            } catch (error) {
                 console.error("Lookup failed:", error);
                 myAppointmentsList.innerHTML = `<p class="text-center text-red-500">ƒê√£ c√≥ l·ªói x·∫£y ra khi tra c·ª©u.</p>`;
            }
        }

        function renderMyAppointments(appointments) {
            if (appointments.length === 0) {
                myAppointmentsList.innerHTML = `<p class="text-center text-gray-500 p-4">Kh√¥ng t√¨m th·∫•y l·ªãch h·∫πn n√†o v·ªõi s·ªë ƒëi·ªán tho·∫°i n√†y.</p>`;
                return;
            }
            const statusText = { pending: 'Ch·ªù x√°c nh·∫≠n', confirmed: 'ƒê√£ x√°c nh·∫≠n', rejected: 'ƒê√£ t·ª´ ch·ªëi' };
            myAppointmentsList.innerHTML = appointments.map(apt => {
                const canAct = apt.status === 'pending';
                return `
                <div class="border rounded-lg p-4 bg-white shadow-sm transition-all duration-300">
                    <div class="apt-view-mode">
                        <div class="flex justify-between items-start">
                            <p class="font-bold text-lg">${maskInfo(apt.name, 'name')}</p>
                            <span class="status-badge status-${apt.status}">${statusText[apt.status] || apt.status}</span>
                        </div>
                        <p class="text-slate-600 text-2xl font-bold">${apt.time} - ${apt.date}</p>
                        <p class="text-sm text-slate-500">${apt.service}</p>
                        <p class="text-xs text-slate-400 mt-2">SƒêT: ${maskInfo(apt.phone, 'phone')}</p>
                        <div class="mt-3 flex gap-2">
                           <button data-apt='${JSON.stringify(apt)}' class="edit-apt-btn w-1/2 text-center py-2 rounded-md font-semibold ${canAct ? 'bg-blue-100 text-blue-700 hover:bg-blue-200' : 'bg-gray-100 text-gray-400 cursor-not-allowed'}" ${!canAct ? 'disabled' : ''}>S·ª≠a l·ªãch</button>
                           <button data-id="${apt.id}" class="cancel-apt-btn w-1/2 text-center py-2 rounded-md font-semibold ${canAct ? 'bg-red-100 text-red-700 hover:bg-red-200' : 'bg-gray-100 text-gray-400 cursor-not-allowed'}" ${!canAct ? 'disabled' : ''}>H·ªßy l·ªãch</button>
                        </div>
                    </div>
                    <div class="apt-edit-mode hidden space-y-3"></div>
                </div>`;
            }).join('');

            myAppointmentsList.querySelectorAll('.edit-apt-btn:not(:disabled)').forEach(btn => btn.addEventListener('click', handleEditAppointmentClick));
            myAppointmentsList.querySelectorAll('.cancel-apt-btn:not(:disabled)').forEach(btn => btn.addEventListener('click', handleCancelAppointmentClick));
        }

        async function handleEditAppointmentClick(e) {
            const aptData = JSON.parse(e.currentTarget.dataset.apt);
            const card = e.target.closest('.border');
            const viewMode = card.querySelector('.apt-view-mode');
            const editMode = card.querySelector('.apt-edit-mode');
            const { value: phone } = await Swal.fire({
                title: 'X√°c nh·∫≠n ch·ªß nh√¢n l·ªãch h·∫πn', input: 'tel',
                inputLabel: 'Vui l√≤ng nh·∫≠p SƒêT ƒë·ªÉ ch·ªânh s·ª≠a.', showCancelButton: true,
                inputValidator: (value) => !value && 'B·∫°n c·∫ßn nh·∫≠p s·ªë ƒëi·ªán tho·∫°i!'
            });
            if (phone && phone === aptData.phone) {
                editMode.innerHTML = `
                    <div><label class="block text-sm font-medium">T√™n kh√°ch h√†ng</label><input type="text" value="${aptData.name}" class="edit-name-input mt-1 w-full rounded-md border-gray-300 shadow-sm"></div>
                    <div><label class="block text-sm font-medium">S·ªë ƒëi·ªán tho·∫°i</label><input type="tel" value="${aptData.phone}" class="edit-phone-input mt-1 w-full rounded-md border-gray-300 shadow-sm"></div>
                    <div class="flex gap-2 mt-3">
                        <button data-id="${aptData.id}" class="save-changes-btn w-1/2 bg-green-600 text-white font-semibold py-2 rounded-md hover:bg-green-700">L∆∞u thay ƒë·ªïi</button>
                        <button type="button" class="cancel-edit-btn w-1/2 bg-gray-200 py-2 rounded-md">H·ªßy</button>
                    </div>`;
                viewMode.classList.add('hidden');
                editMode.classList.remove('hidden');
                editMode.querySelector('.save-changes-btn').addEventListener('click', async () => {
                    const appointmentRef = doc(db, appointmentsColRef.path, aptData.id);
                    await updateDoc(appointmentRef, { name: editMode.querySelector('.edit-name-input').value, phone: editMode.querySelector('.edit-phone-input').value });
                    Swal.fire('Th√†nh c√¥ng!', 'ƒê√£ c·∫≠p nh·∫≠t l·ªãch h·∫πn.', 'success');
                    myAppointmentsForm.dispatchEvent(new Event('submit', { cancelable: true, bubbles: true }));
                });
                editMode.querySelector('.cancel-edit-btn').addEventListener('click', () => {
                    editMode.classList.add('hidden'); viewMode.classList.remove('hidden');
                });
            } else if (phone) {
                Swal.fire('L·ªói!', 'S·ªë ƒëi·ªán tho·∫°i kh√¥ng kh·ªõp.', 'error');
            }
        }

        async function handleCancelAppointmentClick(e) {
            const aptId = e.currentTarget.dataset.id;
            const { isConfirmed } = await Swal.fire({
                title: 'B·∫°n c√≥ ch·∫Øc ch·∫Øn?', text: "B·∫°n s·∫Ω kh√¥ng th·ªÉ ho√†n t√°c h√†nh ƒë·ªông n√†y!",
                icon: 'warning', showCancelButton: true, confirmButtonColor: '#d33',
                cancelButtonColor: '#3085d6', confirmButtonText: 'V√¢ng, h·ªßy l·ªãch!', cancelButtonText: 'Kh√¥ng'
            });
            if(isConfirmed) {
                try {
                    await updateDoc(doc(db, appointmentsColRef.path, aptId), { status: 'cancelled' });
                    Swal.fire('ƒê√£ H·ªßy!', 'L·ªãch h·∫πn c·ªßa b·∫°n ƒë√£ ƒë∆∞·ª£c h·ªßy.', 'success');
                    myAppointmentsForm.dispatchEvent(new Event('submit', { cancelable: true, bubbles: true }));
                } catch { Swal.fire('L·ªói!', 'Kh√¥ng th·ªÉ h·ªßy l·ªãch h·∫πn. Vui l√≤ng th·ª≠ l·∫°i.', 'error'); }
            }
        }
        
        function renderAppointmentsList(appointmentsForDay) {
            if (!isAdmin) return;
            const statusMap = { pending: 'Ch·ªù x√°c nh·∫≠n', confirmed: 'ƒê√£ x√°c nh·∫≠n', rejected: 'ƒê√£ t·ª´ ch·ªëi', cancelled: 'ƒê√£ h·ªßy' };
            const classMap = { pending: 'status-pending', confirmed: 'status-confirmed', rejected: 'status-rejected', cancelled: 'status-cancelled' };
            appointmentsList.innerHTML = appointmentsForDay.map(apt => `
                <div class="bg-slate-50 p-3 rounded-lg border">
                    <div class="flex items-center justify-between gap-4">
                        <div>
                            <p class="font-semibold">${apt.time} - ${apt.name}</p>
                            <p class="text-sm text-slate-600">${apt.service} | ${apt.phone}</p>
                            <p class="text-xs text-slate-500 mt-1">M√£: ${apt.bookingId}</p>
                        </div>
                        <span class="status-badge ${classMap[apt.status] || ''}">${statusMap[apt.status] || apt.status}</span>
                    </div>
                    ${apt.status === 'pending' ? `<div class="mt-2 pt-2 border-t flex gap-2">
                        <button class="admin-action-btn flex-1 bg-green-100 text-green-700 py-1 rounded hover:bg-green-200" data-action="confirm" data-id="${apt.id}">X√°c nh·∫≠n</button>
                        <button class="admin-action-btn flex-1 bg-red-100 text-red-700 py-1 rounded hover:bg-red-200" data-action="reject" data-id="${apt.id}">T·ª´ ch·ªëi</button>
                    </div>` : ''}
                     ${apt.status === 'rejected' && apt.rejectionReason ? `<p class="mt-2 text-xs text-red-600">L√Ω do: ${apt.rejectionReason}</p>` : ''}
                </div>`).join('') || `<p class="text-center text-gray-500 p-4">Kh√¥ng c√≥ l·ªãch h·∫πn n√†o.</p>`;
            appointmentsList.querySelectorAll('.admin-action-btn').forEach(btn => btn.addEventListener('click', handleAdminAction));
        }
        
        async function handleAdminAction(e) {
            const { action, id } = e.currentTarget.dataset;
            const appointmentRef = doc(db, appointmentsColRef.path, id);
            if (action === 'confirm') {
                if (confirm('X√°c nh·∫≠n l·ªãch h·∫πn n√†y?')) await updateDoc(appointmentRef, { status: 'confirmed' });
            } else if (action === 'reject') {
                const reason = prompt('L√Ω do t·ª´ ch·ªëi:');
                if (reason) await updateDoc(appointmentRef, { status: 'rejected', rejectionReason: reason });
            }
        }

        function listenForQuickBookings() {
            if (quickBookingsListener) quickBookingsListener();
            quickBookingsListener = onSnapshot(query(quickBookingsColRef), (snapshot) => {
                const requests = snapshot.docs.map(d => ({ id: d.id, ...d.data() })).sort((a, b) => b.createdAt.toMillis() - a.createdAt.toMillis());
                document.getElementById('quickBookingsList').innerHTML = requests.map(req => `
                    <div class="bg-slate-50 p-2 rounded-md flex justify-between items-center">
                        <p>${req.phone} - <span class="text-xs text-gray-500">${new Date(req.createdAt.toDate()).toLocaleString('vi-VN')}</span></p>
                        <button class="consulted-btn text-green-500 hover:text-green-700" data-id="${req.id}" title="ƒê√°nh d·∫•u ƒë√£ t∆∞ v·∫•n"><i data-feather="check-circle" class="w-5 h-5"></i></button>
                    </div>`).join('') || `<p class="text-center text-gray-500 p-2">Ch∆∞a c√≥ y√™u c·∫ßu n√†o.</p>`;
                
                document.querySelectorAll('.consulted-btn').forEach(btn => {
                    btn.addEventListener('click', async (e) => {
                        const docId = btn.dataset.id;
                        const docRef = doc(db, quickBookingsColRef.path, docId);
                        const docSnap = await getDoc(docRef);
                        if(docSnap.exists()){
                            const data = docSnap.data();
                            await setDoc(doc(consultedBookingsColRef), { ...data, consultedAt: Timestamp.now() });
                            await deleteDoc(docRef);
                        }
                    });
                });
                feather.replace();
            });
        }

        function listenForConsultedBookings() {
            if (consultedBookingsListener) consultedBookingsListener();
            consultedBookingsListener = onSnapshot(query(consultedBookingsColRef), (snapshot) => {
                const requests = snapshot.docs.map(d => ({ id: d.id, ...d.data() })).sort((a, b) => b.consultedAt.toMillis() - a.createdAt.toMillis());
                consultedBookingsList.innerHTML = requests.map(req => `
                    <div class="bg-slate-100 p-2 rounded-md flex justify-between items-center opacity-70">
                        <p>${req.phone} - <span class="text-xs text-gray-500">ƒê√£ t∆∞ v·∫•n l√∫c ${new Date(req.consultedAt.toDate()).toLocaleString('vi-VN')}</span></p>
                    </div>`).join('') || `<p class="text-center text-gray-500 p-2">Ch∆∞a c√≥ d·ªØ li·ªáu.</p>`;
            });
        }

        async function exportDataToCSV() {
            if (!confirm("B·∫°n c√≥ mu·ªën xu·∫•t to√†n b·ªô d·ªØ li·ªáu l·ªãch h·∫πn ra file CSV kh√¥ng?")) return;
            try {
                const snapshot = await getDocs(query(appointmentsColRef));
                if (snapshot.empty) return Swal.fire('Kh√¥ng c√≥ d·ªØ li·ªáu', 'Ch∆∞a c√≥ l·ªãch h·∫πn n√†o ƒë·ªÉ xu·∫•t.', 'info');
                let csvContent = "data:text/csv;charset=utf-8,\uFEFF";
                csvContent += "ID,Booking ID,T√™n,SƒêT,D·ªãch v·ª•,Ng√†y,Gi·ªù,Tr·∫°ng th√°i,L√Ω do t·ª´ ch·ªëi\r\n";
                snapshot.forEach(doc => {
                    const data = doc.data();
                    const row = [`"${doc.id}"`,`"${data.bookingId||''}"`,`"${data.name||''}"`,`"${data.phone||''}"`,`"${data.service||''}"`,`"${data.date||''}"`,`"${data.time||''}"`,`"${data.status||''}"`,`"${data.rejectionReason||''}"`].join(',');
                    csvContent += row + "\r\n";
                });
                const link = document.createElement("a");
                link.setAttribute("href", encodeURI(csvContent));
                link.setAttribute("download", `danh_sach_lich_hen_${new Date().toISOString().slice(0,10)}.csv`);
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            } catch (error) {
                console.error("Error exporting data: ", error);
                Swal.fire('L·ªói', 'Kh√¥ng th·ªÉ xu·∫•t d·ªØ li·ªáu.', 'error');
            }
        }

        async function deleteAllData() {
            const { isConfirmed } = await Swal.fire({
                title: 'B·∫†N C√ì CH·∫ÆC KH√îNG?', html: "H√†nh ƒë·ªông n√†y s·∫Ω **X√ìA TO√ÄN B·ªò** d·ªØ li·ªáu l·ªãch h·∫πn. <br>H√†nh ƒë·ªông n√†y <strong>KH√îNG TH·ªÇ</strong> ho√†n t√°c.",
                icon: 'warning', showCancelButton: true, confirmButtonColor: '#d33',
                confirmButtonText: 'V√¢ng, t√¥i hi·ªÉu v√† mu·ªën x√≥a!', cancelButtonText: 'H·ªßy'
            });
            if (!isConfirmed) return;
            const { value: confirmationText } = await Swal.fire({
                title: 'X√°c nh·∫≠n l·∫ßn cu·ªëi', input: 'text', inputLabel: 'Vui l√≤ng g√µ "DELETE" ƒë·ªÉ x√°c nh·∫≠n x√≥a.',
                showCancelButton: true,
                inputValidator: (value) => (value !== 'DELETE') && 'B·∫°n ph·∫£i g√µ ƒë√∫ng ch·ªØ "DELETE" ƒë·ªÉ x√°c nh·∫≠n!'
            });
            if (confirmationText === 'DELETE') {
                try {
                    const snapshot = await getDocs(query(appointmentsColRef));
                    const batch = writeBatch(db);
                    snapshot.docs.forEach(doc => { batch.delete(doc.ref); });
                    await batch.commit();
                    Swal.fire('ƒê√£ X√≥a!', 'To√†n b·ªô d·ªØ li·ªáu l·ªãch h·∫πn ƒë√£ ƒë∆∞·ª£c x√≥a.', 'success');
                } catch (error) {
                    console.error("Error deleting data: ", error);
                    Swal.fire('L·ªói', 'Kh√¥ng th·ªÉ x√≥a d·ªØ li·ªáu.', 'error');
                }
            }
        }
        
        function switchTab(tabName) {
            const tabs = { booking: tabBooking, 'my-appointments': tabMyAppointments, 'quick-booking': tabQuickBooking };
            const views = { booking: viewBooking, 'my-appointments': viewMyAppointments, 'quick-booking': viewQuickBooking };
            Object.values(tabs).forEach(t => t.classList.remove('tab-active'));
            Object.values(views).forEach(v => v.classList.add('hidden'));
            tabs[tabName].classList.add('tab-active');
            views[tabName].classList.remove('hidden');
        }
    </script>
</body>
</html>