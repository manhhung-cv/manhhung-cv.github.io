<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Drive Manager (Mobile-First)</title>
    <style>
        /* ======================================================= */
        /* BASE & MOBILE-FIRST LIQUIDGLASS THEME */
        /* ======================================================= */
        
        :root {
            --primary-blue: #007aff;
            --primary-red: #ff3b30;
            --primary-green: #34c759;
            --primary-orange: #ff9500; /* Apple Orange/Gold */
            --glass-bg: rgba(255, 255, 255, 0.1);
            --glass-border: rgba(255, 255, 255, 0.18);
        }
        
        body { 
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; 
            background: linear-gradient(135deg, #1f2f4e, #4a638c); 
            display: flex; 
            justify-content: center; 
            align-items: flex-start; 
            padding: 20px 0; 
            color: #E0E0E0;
            min-height: 100vh;
            margin: 0;
        }
        .container { 
            background: var(--glass-bg);
            backdrop-filter: blur(10px); 
            -webkit-backdrop-filter: blur(10px);
            padding: 1.5rem; 
            border-radius: 20px; 
            box-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.37); 
            border: 1px solid var(--glass-border);
            width: 95%; 
            max-width: 700px; 
        }
        h2, h3 { color: white; text-align: center; text-shadow: 0 1px 2px rgba(0,0,0,0.5); margin-top: 0; }
        
        /* Buttons - Optimized for touch */
        .btn { padding: 12px 15px; border: none; border-radius: 10px; cursor: pointer; font-weight: bold; margin-bottom: 10px; transition: 0.3s; color: white; width: 100%; }
        .btn-primary { background-color: var(--primary-blue); } 
        .btn-danger { background-color: var(--primary-red); } 
        .btn-action { background: var(--primary-green); margin-left: 0; padding: 10px; font-size: 0.85em; } 
        .btn-open-folder { background: var(--primary-orange) !important; }
        .btn-link { background: none; color: var(--primary-orange); padding: 5px 0; font-size: 0.9em; margin: 0; width: auto; } 

        .form-upload { display: flex; flex-direction: column; gap: 10px; padding: 15px; border: 1px solid var(--glass-border); border-radius: 10px; }
        input[type="file"] { padding: 10px; border: 1px solid var(--glass-border); border-radius: 8px; background: rgba(0, 0, 0, 0.1); color: white; }
        
        /* List Items */
        li { 
            background: rgba(255, 255, 255, 0.05); 
            border-bottom: 1px solid rgba(255, 255, 255, 0.1); 
            padding: 10px; 
            border-radius: 10px;
            margin-bottom: 10px;
            display: flex; 
            flex-wrap: wrap; 
            justify-content: space-between; 
            align-items: center; 
        }
        .file-info { flex-grow: 1; min-width: 60%; margin-right: 10px; }
        .file-actions { display: flex; flex-wrap: wrap; gap: 5px; margin-top: 10px; }
        .file-actions button { flex-grow: 1; padding: 8px; font-size: 0.8em; }
        
        .inline-image { max-width: 80px; max-height: 80px; border-radius: 8px; margin-right: 15px; object-fit: cover; border: 1px solid var(--glass-border); cursor: pointer; }
        
        /* Desktop/Tablet adjustment */
        @media (min-width: 600px) {
            .file-actions { margin-top: 0; flex-wrap: nowrap; }
            .file-actions button { width: auto; padding: 5px 10px; flex-grow: 0; }
            .btn { width: auto; }
            .btn-full { width: 100%; }
        }

        /* ======================================================= */
        /* LIGHTBOX/MODAL FOR ZOOM (Gi·ªØ nguy√™n) */
        /* ======================================================= */
        #lightbox {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0, 0, 0, 0.9); 
            align-items: center;
            justify-content: center;
        }

        #lightbox-content {
            display: block;
            max-width: 90%;
            max-height: 90%;
            border-radius: 10px;
            box-shadow: 0 0 20px rgba(0, 0, 0, 0.8);
        }

        #lightbox-close {
            position: absolute;
            top: 20px;
            right: 35px;
            color: #fff;
            font-size: 40px;
            font-weight: bold;
            transition: 0.3s;
            cursor: pointer;
            text-decoration: none;
        }
    </style>
</head>
<body>

<div id="lightbox" onclick="closeLightbox()">
    <span id="lightbox-close">&times;</span>
    <img id="lightbox-content" />
</div>

<div class="container">
    <h2> File Manager</h2>
    
    <div class="warning">
        ‚ö†Ô∏è **C·∫¢NH B√ÅO:** ·ª®ng d·ª•ng n√†y t·ª± ƒë·ªông chia s·∫ª t·ªáp c·ªßa b·∫°n c√¥ng khai ƒë·ªÉ k√≠ch ho·∫°t link t·∫£i/xem tr∆∞·ªõc.
    </div>

    <button id="authorize_button" class="btn btn-primary" onclick="handleAuthClick()">üîê ƒêƒÉng nh·∫≠p Google</button>
    <button id="signout_button" class="btn btn-danger" onclick="handleSignoutClick()" style="display: none;">üîì ƒêƒÉng xu·∫•t</button>

    <div id="content" style="display: none;">
        <h3>üì§ T·∫£i l√™n T·ªáp</h3>
        <div class="form-upload">
            <input type="file" id="file_to_upload">
            <button onclick="uploadFile()" class="btn btn-primary">‚¨ÜÔ∏è T·∫£i l√™n Drive</button>
        </div>

        <h3>üìÑ Danh s√°ch File c·ªßa t√¥i</h3>
        
        <div style="display: flex; gap: 10px; margin-bottom: 10px;">
            <button onclick="listFiles()" class="btn" style="background: rgba(255, 255, 255, 0.15); flex-grow: 1;">üîÑ L√†m m·ªõi danh s√°ch</button>
            <button onclick="openFolderInDrive()" class="btn btn-open-folder" style="flex-grow: 1;">üìÇ M·ªü Th∆∞ m·ª•c HunqCloud</button>
        </div>
        
        <ul id="file_list"></ul>
    </div>
</div>

<script>
    /* C·∫§U H√åNH - THAY TH·∫æ TH√îNG TIN C·ª¶A B·∫†N ·ªû ƒê√ÇY */
    const CLIENT_ID = 'YOUR_CLIENT_ID_HERE'; 
    const API_KEY = 'YOUR_API_KEY_HERE';     
    const DISCOVERY_DOC = 'https://www.googleapis.com/discovery/v1/apis/drive/v3/rest';
    
    const FILE_FIELDS = 'id, name, mimeType, webViewLink, webContentLink, thumbnailLink'; 
    const SCOPES = 'https://www.googleapis.com/auth/drive.file'; 

    let tokenClient;
    let gapiInited = false;
    let gisInited = false;
    
    let HUNQ_CLOUD_FOLDER_ID = null;
    const HUNQ_CLOUD_FOLDER_NAME = 'HunqCloud';

    document.getElementById('authorize_button').style.visibility = 'hidden';

    // --- C√ÅC H√ÄM KH·ªûI T·∫†O V√Ä X√ÅC TH·ª∞C ---

    function gapiLoaded() { gapi.load('client', initializeGapiClient); }
    async function initializeGapiClient() {
        await gapi.client.init({ apiKey: API_KEY, discoveryDocs: [DISCOVERY_DOC] });
        gapiInited = true; maybeEnableButtons();
    }
    function gisLoaded() {
        tokenClient = google.accounts.oauth2.initTokenClient({
            client_id: CLIENT_ID, scope: SCOPES, callback: '',
        });
        gisInited = true; maybeEnableButtons();
    }

    function updateSignInStatus(isSignedIn) {
        if (isSignedIn) {
            document.getElementById('signout_button').style.display = 'block';
            document.getElementById('authorize_button').style.display = 'none';
            document.getElementById('content').style.display = 'block';
        } else {
            document.getElementById('signout_button').style.display = 'none';
            document.getElementById('authorize_button').style.display = 'block';
            document.getElementById('content').style.display = 'none';
        }
    }

    // H√†m T√¨m ho·∫∑c T·∫°o Th∆∞ m·ª•c HunqCloud (Gi·ªØ nguy√™n)
    async function findOrCreateFolder() {
        if (HUNQ_CLOUD_FOLDER_ID) return; // N·∫øu ƒë√£ c√≥ ID th√¨ tho√°t

        console.log(`ƒêang t√¨m th∆∞ m·ª•c "${HUNQ_CLOUD_FOLDER_NAME}"...`);
        try {
            const searchResponse = await gapi.client.drive.files.list({
                q: `mimeType='application/vnd.google-apps.folder' and name='${HUNQ_CLOUD_FOLDER_NAME}' and trashed=false`,
                fields: 'files(id)',
            });

            const existingFiles = searchResponse.result.files;

            if (existingFiles && existingFiles.length > 0) {
                HUNQ_CLOUD_FOLDER_ID = existingFiles[0].id;
                console.log(`ƒê√£ t√¨m th·∫•y th∆∞ m·ª•c: ${HUNQ_CLOUD_FOLDER_ID}`);
                return;
            }

            console.log(`Kh√¥ng t√¨m th·∫•y, ƒëang t·∫°o th∆∞ m·ª•c m·ªõi...`);
            const metadata = {
                'name': HUNQ_CLOUD_FOLDER_NAME,
                'mimeType': 'application/vnd.google-apps.folder',
            };
            const createResponse = await gapi.client.drive.files.create({
                resource: metadata,
                fields: 'id',
            });

            HUNQ_CLOUD_FOLDER_ID = createResponse.result.id;
            console.log(`ƒê√£ t·∫°o th∆∞ m·ª•c m·ªõi: ${HUNQ_CLOUD_FOLDER_ID}`);

        } catch (error) {
            console.error("L·ªñI KHI T√åM/T·∫†O TH∆Ø M·ª§C:", error);
            alert("L·ªói nghi√™m tr·ªçng: Kh√¥ng th·ªÉ t√¨m ho·∫∑c t·∫°o th∆∞ m·ª•c HunqCloud.");
        }
    }


    async function checkInitialState() {
        tokenClient.requestAccessToken({ prompt: 'none', callback: async (resp) => {
            if (resp.error) {
                updateSignInStatus(false);
                return;
            }
            updateSignInStatus(true);
            await findOrCreateFolder(); 
            listFiles();
        }});
    }

    function maybeEnableButtons() {
        if (gapiInited && gisInited) {
            document.getElementById('authorize_button').style.visibility = 'visible';
            checkInitialState(); 
        }
    }

    function handleAuthClick() {
        tokenClient.callback = async (resp) => {
            if (resp.error) { console.error(resp); return; }
            updateSignInStatus(true);
            await findOrCreateFolder(); 
            await listFiles();
        };

        if (gapi.client.getToken() === null) {
            tokenClient.requestAccessToken({prompt: 'consent'}); 
        } else {
            tokenClient.requestAccessToken({prompt: ''});
        }
    }

    function handleSignoutClick() {
        const token = gapi.client.getToken();
        if (token !== null) {
            google.accounts.oauth2.revoke(token.access_token);
            gapi.client.setToken('');
            updateSignInStatus(false);
            HUNQ_CLOUD_FOLDER_ID = null; 
            document.getElementById('file_list').innerHTML = '';
        }
    }
    
    // --- H√ÄM H·ªñ TR·ª¢ ---
    async function shareFilePublicly(fileId) {
        try {
            await gapi.client.drive.permissions.create({
                fileId: fileId,
                resource: { role: 'reader', type: 'anyone' },
                fields: 'id',
            });
            console.log('Chia s·∫ª c√¥ng khai th√†nh c√¥ng.');
        } catch (error) {
            console.error('L·ªói khi chia s·∫ª t·ªáp:', error);
        }
    }

    // [M·ªöI] M·ªü th∆∞ m·ª•c HunqCloud trong tab m·ªõi
    function openFolderInDrive() {
        if (!HUNQ_CLOUD_FOLDER_ID) {
            alert("Th∆∞ m·ª•c HunqCloud ch∆∞a ƒë∆∞·ª£c t√¨m th·∫•y.");
            return;
        }
        const folderUrl = `https://drive.google.com/drive/folders/${HUNQ_CLOUD_FOLDER_ID}`;
        window.open(folderUrl, '_blank');
    }

    // [ƒê√É ƒê·ªîI T√äN] M·ªü T·ªáp trong tab m·ªõi
    function openInNewTab(webViewLink) {
        if (webViewLink) {
            window.open(webViewLink, '_blank');
        } else {
            alert("Kh√¥ng th·ªÉ t·∫°o link xem t·ªáp trong Drive.");
        }
    }

    // --- C√ÅC H√ÄM CH·ª®C NƒÇNG CH√çNH ---

    // 1. Li·ªát k√™ files (ƒê√£ c·∫≠p nh·∫≠t n√∫t)
    async function listFiles() {
        if (!HUNQ_CLOUD_FOLDER_ID) {
            alert("Kh√¥ng th·ªÉ t·∫£i danh s√°ch: Th∆∞ m·ª•c HunqCloud ch∆∞a ƒë∆∞·ª£c t√¨m th·∫•y.");
            return;
        }

        let response;
        try {
            response = await gapi.client.drive.files.list({
                'pageSize': 10,
                q: `'${HUNQ_CLOUD_FOLDER_ID}' in parents and trashed=false`,
                'fields': `nextPageToken, files(${FILE_FIELDS})`, 
            });
        } catch (err) {
            console.error("L·ªñI KHI T·∫¢I DANH S√ÅCH:", err);
            const errorMessage = (err && err.result && err.result.error && err.result.error.message) || (err && err.message) || "Kh√¥ng x√°c ƒë·ªãnh. Vui l√≤ng ki·ªÉm tra Console (F12).";
            alert('L·ªói khi t·∫£i danh s√°ch: ' + errorMessage);
            return;
        }
        
        const files = response.result.files;
        const ul = document.getElementById('file_list');
        ul.innerHTML = ''; 

        if (!files || files.length == 0) {
            ul.innerHTML = `<li>Kh√¥ng t√¨m th·∫•y file n√†o trong th∆∞ m·ª•c "${HUNQ_CLOUD_FOLDER_NAME}".</li>`;
            return;
        }

        files.forEach(file => {
            const isImage = file.mimeType.startsWith('image/');

            const imageDisplay = isImage && file.thumbnailLink 
                ? `<img src="${file.thumbnailLink}" class="inline-image" alt="${file.name}" onclick="openLightbox('${file.thumbnailLink}')">` 
                : '';
            
            // [M·ªöI] N√∫t M·ªü T·ªáp trong Drive (√Åp d·ª•ng cho m·ªçi lo·∫°i file)
            const openFileButton = `<button class="btn btn-action" onclick="openInNewTab('${file.webViewLink}')">‚ÜóÔ∏è M·ªü trong Drive</button>`;

            const li = document.createElement('li');
            li.innerHTML = `
                ${imageDisplay}
                <div class="file-info">
                    <span class="file-name">${file.name}</span>
                    <span class="file-id">Lo·∫°i: ${file.mimeType}</span>
                </div>
                <div class="file-actions">
                    <button class="btn btn-action" onclick="copyDownloadLink('${file.id}', '${file.name}')">üîó Link T·∫£i</button>
                    ${openFileButton}
                    <button class="btn btn-action" onclick="downloadFile('${file.id}', '${file.name}')">‚¨áÔ∏è T·∫£i xu·ªëng</button>
                    <button class="btn btn-link" onclick="deleteFile('${file.id}', '${file.name}')">üóëÔ∏è X√≥a</button>
                </div>
            `;
            ul.appendChild(li);
        });
    }

    // 2. T·∫£i l√™n file m·ªõi (Gi·ªØ nguy√™n)
    async function uploadFile() {
        const fileInput = document.getElementById('file_to_upload');
        const file = fileInput.files[0];

        if (!file) { alert("Vui l√≤ng ch·ªçn m·ªôt t·ªáp ƒë·ªÉ t·∫£i l√™n."); return; }
        if (!gapi.client.getToken()) { alert("Vui l√≤ng ƒëƒÉng nh·∫≠p tr∆∞·ªõc khi t·∫£i l√™n."); return; }
        if (!HUNQ_CLOUD_FOLDER_ID) { alert("L·ªói: Kh√¥ng t√¨m th·∫•y th∆∞ m·ª•c HunqCloud."); return; } 

        const metadata = { 
            'name': file.name, 
            'mimeType': file.type || 'application/octet-stream',
            'parents': [HUNQ_CLOUD_FOLDER_ID] 
        };
        const accessToken = gapi.client.getToken().access_token;
        const form = new FormData();
        form.append('metadata', new Blob([JSON.stringify(metadata)], { type: 'application/json' }));
        form.append('file', file); 

        try {
            const res = await fetch('https://www.googleapis.com/upload/drive/v3/files?uploadType=multipart', {
                method: 'POST',
                headers: new Headers({ 'Authorization': 'Bearer ' + accessToken }),
                body: form
            });
            const val = await res.json();
            
            if (res.ok) {
                const newFileId = val.id; 
                await shareFilePublicly(newFileId); 
                
                alert(`ƒê√£ t·∫£i l√™n v√† chia s·∫ª th√†nh c√¥ng v√†o th∆∞ m·ª•c HunqCloud: ${val.name}`);
                fileInput.value = ''; 
                listFiles(); 
            } else {
                alert("L·ªói t·∫£i l√™n: " + (val.error ? val.error.message : res.statusText));
            }
        } catch (error) {
            console.error("L·ªói upload:", error);
            alert("L·ªói m·∫°ng ho·∫∑c server.");
        }
    }

    // 3. X√≥a file (Gi·ªØ nguy√™n)
    async function deleteFile(fileId, fileName) {
        if (!confirm(`B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën x√≥a file "${fileName}" kh√¥ng?`)) return;
        try {
            await gapi.client.drive.files.delete({ 'fileId': fileId });
            alert(`ƒê√£ x√≥a file "${fileName}" th√†nh c√¥ng.`);
            listFiles(); 
        } catch (error) {
            console.error("L·ªói x√≥a file:", error);
            alert("L·ªói khi x√≥a file. B·∫°n ch·ªâ ƒë∆∞·ª£c x√≥a t·ªáp do ch√≠nh b·∫°n t·∫°o.");
        }
    }

    // 4. T·∫£i xu·ªëng file (Gi·ªØ nguy√™n)
    async function downloadFile(fileId, fileName) {
        if (!gapi.client.getToken()) { alert("Vui l√≤ng ƒëƒÉng nh·∫≠p."); return; }
        
        try {
            const response = await gapi.client.request({
                path: `https://www.googleapis.com/drive/v3/files/${fileId}`,
                params: { 'alt': 'media' }
            });

            const blob = new Blob([response.body], { type: response.headers['content-type'] });
            const url = window.URL.createObjectURL(blob);
            
            const a = document.createElement('a');
            a.style.display = 'none';
            a.href = url;
            a.download = fileName; 
            document.body.appendChild(a);
            a.click();
            window.URL.revokeObjectURL(url);
            document.body.removeChild(a);
            
            alert(`ƒêang t·∫£i xu·ªëng file "${fileName}"...`);
        } catch (error) {
            console.error("L·ªói t·∫£i xu·ªëng:", error);
            alert("L·ªói khi t·∫£i xu·ªëng. ƒê·∫£m b·∫£o t·ªáp ƒë√£ ƒë∆∞·ª£c t·∫°o th√†nh c√¥ng.");
        }
    }

    // 5. Sao ch√©p Link T·∫£i (Gi·ªØ nguy√™n)
    async function copyDownloadLink(fileId, fileName) {
        if (!gapi.client.getToken()) { alert("Vui l√≤ng ƒëƒÉng nh·∫≠p."); return; }
        
        try {
            const response = await gapi.client.drive.files.get({
                fileId: fileId,
                fields: 'webContentLink'
            });

            const downloadLink = response.result.webContentLink;

            if (downloadLink) {
                await navigator.clipboard.writeText(downloadLink);
                alert(`ƒê√£ sao ch√©p link t·∫£i xu·ªëng c·ªßa "${fileName}" v√†o clipboard.`);
            } else {
                alert("Kh√¥ng t√¨m th·∫•y link t·∫£i xu·ªëng. ƒê·∫£m b·∫£o t·ªáp ƒë√£ ƒë∆∞·ª£c chia s·∫ª c√¥ng khai.");
            }
        } catch (error) {
            console.error("L·ªói khi l·∫•y link t·∫£i:", error);
            alert("L·ªói khi l·∫•y link t·∫£i. Vui l√≤ng ki·ªÉm tra l·∫°i quy·ªÅn.");
        }
    }
    
    // 6. LIGHTBOX FUNCTIONS (Gi·ªØ nguy√™n)

    function openLightbox(thumbnailLink) {
        const lightbox = document.getElementById('lightbox');
        const img = document.getElementById('lightbox-content');
        
        if (thumbnailLink) {
            const fullResLink = thumbnailLink.replace(/=s\d+/g, '=s0'); 
            img.src = fullResLink;
            lightbox.style.display = 'flex';
        }
    }

    function closeLightbox() {
        document.getElementById('lightbox').style.display = 'none';
        document.getElementById('lightbox-content').src = '';
    }
</script>

<script async defer src="https://apis.google.com/js/api.js" onload="gapiLoaded()"></script>
<script async defer src="https://accounts.google.com/gsi/client" onload="gisLoaded()"></script>

</body>
</html>