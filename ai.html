<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Gemini Watch App</title>
    <style>
        /* --- CSS Variables for dynamic heights and font sizing --- */
        :root {
            /* These will be set by JavaScript dynamically */
            --fixed-header-height: 0px;
            --fixed-footer-height: 0px;

            --message-font-size: 10.5px; /* Kích thước font mặc định cho tin nhắn */
            --input-font-size: 11px;    /* Kích thước font mặc định cho ô nhập liệu */
            --button-font-size: 12px;   /* Kích thước font mặc định cho nút */
            --preview-font-size: 16px;  /* Kích thước font mặc định cho phần xem trước */
        }

        /* --- General Reset & Base Styles --- */
        html, body {
            margin: 0;
            padding: 0;
            height: 100%; /* html và body chiếm toàn bộ chiều cao viewport */
            width: 100%;
            overflow: hidden; /* Ngăn html/body có thanh cuộn mặc định ban đầu */
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Oxygen, Ubuntu, Cantarell, "Open Sans", "Helvetica Neue", sans-serif;
            background-color: #000;
            color: #fff;
            font-size: 13px; /* Kích thước font cơ sở cho các phần tử không động */
        }

        body {
            /* Main scroll container */
            overflow-y: auto; /* Cho phép body cuộn nội dung */
            -webkit-overflow-scrolling: touch; /* Cuộn mượt trên iOS/WatchOS */
            box-sizing: border-box; /* Padding được tính vào kích thước */
            
            /* Padding để chừa chỗ cho fixed header/footer */
            padding-top: var(--fixed-header-height, 0px);
            padding-bottom: var(--fixed-footer-height, 0px);
        }

        /* Ẩn thanh cuộn của body cho WebKit browsers (Safari/Chrome/WatchOS) */
        body::-webkit-scrollbar {
            display: none;
        }
        /* For Firefox */
        body {
            scrollbar-width: none;
        }

        /* --- Fixed Header --- */
        .fixed-header {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            z-index: 100; /* Đảm bảo nó luôn nằm trên cùng */
            background-color: #000; /* Nền đen để che nội dung bên dưới */
            box-sizing: border-box;
            padding: 5px;
            text-align: center;
        }
        .fixed-header h1 {
            font-size: 16px;
            margin: 0;
        }

        /* --- Fixed Bottom Area (Input + Buttons) --- */
        .fixed-bottom-area {
            position: fixed;
            bottom: 0;
            left: 0;
            width: 100%;
            z-index: 100; /* Đảm bảo nó luôn nằm trên cùng */
            background-color: #000; /* Nền đen để che nội dung bên dưới */
            box-sizing: border-box;
            padding: 5px; /* Padding cho toàn bộ khu vực dưới */
        }

        .input-group {
            display: flex;
            flex-direction: column;
            width: 100%;
        }

        #promptInput {
            background-color: #333;
            border: 1px solid #555;
            color: #fff;
            padding: 6px;
            border-radius: 5px;
            margin-bottom: 5px;
            width: 100%; /* Chiếm toàn bộ chiều rộng có sẵn */
            box-sizing: border-box;
            font-size: var(--input-font-size); /* Sử dụng biến CSS */
        }

        button {
            background-color: #007aff;
            color: #fff;
            border: none;
            padding: 7px 10px;
            border-radius: 5px;
            font-size: var(--button-font-size); /* Sử dụng biến CSS */
            cursor: pointer;
            width: 100%;
            box-sizing: border-box;
            transition: background-color 0.2s ease;
        }

        button:active {
            background-color: #005bb5;
        }

        .loading, .error-message {
            text-align: center;
            font-size: 11px;
            color: #aaa;
            margin-top: 3px;
            margin-bottom: 3px;
            padding: 0 5px;
        }
        .error-message {
            color: #ff3b30;
        }

        /* --- Page Wrapper for Swipe Functionality (Content Area) --- */
        #pageWrapper {
            display: flex;
            width: 200vw; /* 200% chiều rộng của viewport để chứa 2 trang */
            /* Height will be determined by content, allowing body to scroll */
            transition: transform 0.3s ease-out; /* Hiệu ứng chuyển động khi vuốt */
            box-sizing: border-box;
        }

        /* --- Individual Page/Tab Styles --- */
        .page {
            width: 100vw; /* Mỗi trang chiếm 100% chiều rộng của viewport */
            flex-shrink: 0; /* Ngăn các trang co lại khi pageWrapper flex */
            display: flex; /* Mỗi trang là một flex container để bố cục nội dung dọc */
            flex-direction: column;
            box-sizing: border-box;
            padding: 0 5px; /* Padding ngang cho nội dung trong mỗi trang */
        }

        /* --- CHAT PAGE Specific Styles (content flows naturally) --- */
        #chatPageContent { /* Inner wrapper for chat messages */
            flex-grow: 1; /* Cho phép nội dung chat mở rộng để cuộn */
            display: flex;
            flex-direction: column;
            gap: 4px; /* Khoảng cách giữa các bong bóng chat */
            padding-top: 5px; /* Padding trên cho bong bóng chat */
            padding-bottom: 5px; /* Padding dưới cho bong bóng chat */
            background-color: #111; /* Nền cho khu vực chat */
            border-radius: 8px; /* Bo góc cho khu vực chat */
            margin-top: 5px; /* Khoảng cách với header */
            margin-bottom: 5px; /* Khoảng cách với footer */
        }

        .message {
            max-width: 88%;
            padding: 5px 8px;
            border-radius: 10px;
            font-size: var(--message-font-size); /* Sử dụng biến CSS */
            line-height: 1.2;
            word-wrap: break-word;
        }

        .user-message {
            align-self: flex-end; /* Căn phải */
            background-color: #007aff;
            color: #fff;
        }

        .ai-message {
            align-self: flex-start; /* Căn trái */
            background-color: #333;
            color: #fff;
        }

        /* --- SETTINGS PAGE Specific Styles --- */
        #settingsPage {
            justify-content: flex-start; /* Căn nội dung từ trên xuống */
            align-items: center; /* Căn giữa theo chiều ngang */
            padding-top: 10px; /* Padding trên cho trang cài đặt */
            padding-bottom: 10px; /* Padding dưới cho trang cài đặt */
        }

        .settings-section {
            width: 100%;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 5px;
            margin-bottom: 10px;
        }

        .settings-label {
            font-size: 12px;
            color: #ccc;
            margin-bottom: 5px;
        }

        .font-size-preview {
            font-size: var(--preview-font-size); /* Sử dụng biến CSS */
            color: #fff;
            margin-bottom: 10px;
            padding: 5px;
            border: 1px dashed #555;
            border-radius: 5px;
            width: fit-content;
            text-align: center;
        }

        .font-size-controls {
            display: flex;
            gap: 10px;
        }

        .settings-button {
            background-color: #555;
            color: #fff;
            border: none;
            padding: 8px 15px;
            border-radius: 8px;
            font-size: 14px;
            cursor: pointer;
            transition: background-color 0.2s ease;
        }

        .settings-button:active {
            background-color: #777;
        }
    </style>
</head>
<body>
    <!-- Fixed Header -->
    <div id="fixedHeader" class="fixed-header">
        <h1>Gemini Watch App</h1>
    </div>

    <!-- Page Wrapper for Swiping Content -->
    <!-- This div will contain all page content and its padding will be adjusted by JS -->
    <div id="pageWrapper">
        <!-- CHAT PAGE -->
        <div id="chatPage" class="page">
            <div id="chatPageContent">
                <div class="message ai-message">Chào bạn! Tôi có thể giúp gì cho bạn?</div>
                <!-- More chat messages will be added here -->
            </div>
        </div>

        <!-- SETTINGS PAGE -->
        <div id="settingsPage" class="page">
            <div class="settings-section">
                <div class="settings-label">Kích thước chữ:</div>
                <div id="fontSizePreview" class="font-size-preview">Aa Bb Cc</div>
                <div class="font-size-controls">
                    <button id="decreaseFont" class="settings-button">-</button>
                    <button id="increaseFont" class="settings-button">+</button>
                </div>
            </div>

            <div class="settings-section">
                <div class="settings-label">Vuốt sang trái/phải để chuyển tab</div>
            </div>
        </div>
    </div>

    <!-- Fixed Bottom Area (Input + Buttons) -->
    <div id="fixedFooter" class="fixed-bottom-area">
        <div id="loadingIndicator" class="loading" style="display: none;">Đang tải...</div>
        <div id="errorMessage" class="error-message" style="display: none;"></div>
        <div class="input-group">
            <input type="text" id="promptInput" placeholder="Nhập câu hỏi của bạn...">
            <button id="sendButton">Gửi</button>
        </div>
    </div>

    <script>
        const API_KEY = "AIzaSyBtktalr9ziLgKxKOgHTBuwqXUT2L_WWJI"; // Khóa API của bạn
        // LƯU Ý QUAN TRỌNG: Khóa API bạn cung cấp ở trên là ví dụ. Vui lòng thay thế bằng khóa API hợp lệ của bạn từ Google Cloud Console.
        const API_URL = "https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent";

        // --- DOM Elements ---
        const pageWrapper = document.getElementById('pageWrapper');
        const chatPage = document.getElementById('chatPage');
        const chatPageContent = document.getElementById('chatPageContent'); // The new div for chat content
        const promptInput = document.getElementById('promptInput');
        const sendButton = document.getElementById('sendButton');
        const loadingIndicator = document.getElementById('loadingIndicator');
        const errorMessageDiv = document.getElementById('errorMessage');

        const fixedHeader = document.getElementById('fixedHeader');
        const fixedFooter = document.getElementById('fixedFooter');

        const fontSizePreview = document.getElementById('fontSizePreview');
        const decreaseFontButton = document.getElementById('decreaseFont');
        const increaseFontButton = document.getElementById('increaseFont');

        // --- State Variables ---
        let currentPageIndex = 0; // 0 for Chat, 1 for Settings
        let startX = 0;
        let currentTranslateX = 0;
        let lastTranslateX = 0;
        const swipeThreshold = 50; // Pixels to confirm a swipe

        // --- Font Size Management ---
        const MIN_FONT_SIZE = 9.5; // Kích thước font nhỏ nhất cho tin nhắn
        const MAX_FONT_SIZE = 24.5; // Kích thước font lớn nhất cho tin nhắn (tăng thêm)
        const FONT_SIZE_STEP = 2; // Bước tăng/giảm font lớn hơn để có sự thay đổi rõ rệt

        // Biến này lưu trữ hệ số tỷ lệ, thay vì kích thước font trực tiếp.
        // Nó giúp dễ dàng điều chỉnh nhiều font size cùng lúc.
        let currentScaleFactor = parseFloat(localStorage.getItem('fontSizeScaleFactor') || '0');

        function applyFontSize() {
            // Các kích thước font cơ sở (initial values from CSS variables)
            const baseMessageFontSize = 10.5;
            const baseInputFontSize = 11;
            const baseButtonFontSize = 12;
            const basePreviewFontSize = 16;

            // Tính toán kích thước font đã thay đổi dựa trên scaleFactor
            let scaledMessageFontSize = baseMessageFontSize + (currentScaleFactor * FONT_SIZE_STEP);
            let scaledInputFontSize = baseInputFontSize + (currentScaleFactor * FONT_SIZE_STEP);
            let scaledButtonFontSize = baseButtonFontSize + (currentScaleFactor * FONT_SIZE_STEP);
            // Preview scales a bit more aggressively for better visual feedback
            let scaledPreviewFontSize = basePreviewFontSize + (currentScaleFactor * FONT_SIZE_STEP * 1.5); 

            // Đảm bảo kích thước font nằm trong khoảng min/max
            scaledMessageFontSize = Math.max(MIN_FONT_SIZE, Math.min(MAX_FONT_SIZE, scaledMessageFontSize));
            // Các font khác cũng được clamp để không quá nhỏ/lớn so với ý muốn
            scaledInputFontSize = Math.max(baseInputFontSize - FONT_SIZE_STEP * 2, Math.min(MAX_FONT_SIZE + 2, scaledInputFontSize));
            scaledButtonFontSize = Math.max(baseButtonFontSize - FONT_SIZE_STEP * 2, Math.min(MAX_FONT_SIZE + 2, scaledButtonFontSize));
            scaledPreviewFontSize = Math.max(basePreviewFontSize - FONT_SIZE_STEP * 2, Math.min(MAX_FONT_SIZE + 6, scaledPreviewFontSize));


            // Cập nhật các biến CSS trên phần tử gốc (<html>)
            document.documentElement.style.setProperty('--message-font-size', `${scaledMessageFontSize}px`);
            document.documentElement.style.setProperty('--input-font-size', `${scaledInputFontSize}px`);
            document.documentElement.style.setProperty('--button-font-size', `${scaledButtonFontSize}px`);
            document.documentElement.style.setProperty('--preview-font-size', `${scaledPreviewFontSize}px`);

            // Áp dụng font size cho các tin nhắn hiện có (nếu chúng được thêm vào trước khi thay đổi size)
            document.querySelectorAll('.message').forEach(msg => {
                msg.style.fontSize = `${scaledMessageFontSize}px`;
            });
            
            // Lưu hệ số tỷ lệ vào localStorage
            localStorage.setItem('fontSizeScaleFactor', currentScaleFactor);
        }

        function changeFontSize(direction) {
            currentScaleFactor += direction;
            // Đảm bảo currentScaleFactor không vượt quá giới hạn dựa trên MIN/MAX_FONT_SIZE
            const baseMessageFontSize = 10.5;
            if (baseMessageFontSize + (currentScaleFactor * FONT_SIZE_STEP) < MIN_FONT_SIZE) {
                currentScaleFactor = Math.ceil((MIN_FONT_SIZE - baseMessageFontSize) / FONT_SIZE_STEP);
            }
            if (baseMessageFontSize + (currentScaleFactor * FONT_SIZE_STEP) > MAX_FONT_SIZE) {
                currentScaleFactor = Math.floor((MAX_FONT_SIZE - baseMessageFontSize) / FONT_SIZE_STEP);
            }
            
            applyFontSize();
            // Quan trọng: Sau khi thay đổi font, cần điều chỉnh padding của body vì chiều cao fixed-footer có thể thay đổi
            adjustBodyPadding();
        }

        // --- Layout Adjustments (for fixed header/footer) ---
        function adjustBodyPadding() {
            const headerHeight = fixedHeader.offsetHeight;
            const footerHeight = fixedFooter.offsetHeight;

            // Cập nhật biến CSS để body tự điều chỉnh padding
            document.documentElement.style.setProperty('--fixed-header-height', `${headerHeight}px`);
            document.documentElement.style.setProperty('--fixed-footer-height', `${footerHeight}px`);
        }

        // --- Chat Functionality ---
        function displayError(message) {
            errorMessageDiv.textContent = message;
            errorMessageDiv.style.display = 'block';
            // Cuộn body để hiển thị lỗi, không phải chatBoxContainer
            document.body.scrollTop = document.body.scrollHeight; 
            document.documentElement.scrollTop = document.documentElement.scrollHeight; // For cross-browser compatibility
        }

        function clearError() {
            errorMessageDiv.textContent = '';
            errorMessageDiv.style.display = 'none';
        }

        function addMessage(text, sender) {
            const messageDiv = document.createElement('div');
            messageDiv.classList.add('message');
            messageDiv.classList.add(sender === 'user' ? 'user-message' : 'ai-message');
            messageDiv.textContent = text;
            // Font size for new messages will be automatically set by CSS variable
            chatPageContent.appendChild(messageDiv); // Thêm vào chatPageContent mới
            // Cuộn body để hiển thị tin nhắn mới, không phải chatBoxContainer
            document.body.scrollTop = document.body.scrollHeight;
            document.documentElement.scrollTop = document.documentElement.scrollHeight;
        }

        async function sendMessage() {
            const prompt = promptInput.value.trim();
            if (!prompt) {
                displayError("Vui lòng nhập câu hỏi của bạn.");
                return;
            }

            clearError();
            addMessage(prompt, 'user');
            promptInput.value = ''; // Xóa input ngay lập tức
            
            loadingIndicator.style.display = 'block';
            sendButton.disabled = true;

            try {
                const response = await fetch(`${API_URL}?key=${API_KEY}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        contents: [
                            {
                                parts: [
                                    {
                                        text: prompt
                                    }
                                ]
                            }
                        ]
                    })
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    console.error("API Error:", errorData);
                    throw new Error(`Lỗi API: ${errorData.error && errorData.error.message ? errorData.error.message : response.statusText}`);
                }

                const data = await response.json();
                if (data.candidates && data.candidates[0] && data.candidates[0].content && data.candidates[0].content.parts && data.candidates[0].content.parts[0]) {
                    addMessage(data.candidates[0].content.parts[0].text, 'ai');
                } else {
                    addMessage("Không tìm thấy phản hồi hợp lệ từ AI.", 'ai');
                    console.warn("Unexpected API response structure:", data);
                }

            } catch (error) {
                console.error("Lỗi khi gọi API Gemini:", error);
                displayError(`Xin lỗi, đã có lỗi xảy ra: ${error.message}. Vui lòng thử lại.`);
            } finally {
                loadingIndicator.style.display = 'none';
                sendButton.disabled = false;
            }
        }

        // --- Swipe Functionality ---
        function goToPage(index) {
            currentPageIndex = index;
            lastTranslateX = -currentPageIndex * window.innerWidth;
            pageWrapper.style.transform = `translateX(${lastTranslateX}px)`;
        }

        function handleTouchStart(e) {
            // If currently on Chat page (index 0) and body content is scrollable vertically
            if (currentPageIndex === 0 && (document.body.scrollHeight > window.innerHeight || document.documentElement.scrollHeight > window.innerHeight)) {
                const touchY = e.touches[0].clientY;
                // Get the main content area (pageWrapper) boundaries
                const pageWrapperRect = pageWrapper.getBoundingClientRect();
                
                // Check if touch started within the main content area (excluding fixed header/footer)
                if (touchY >= pageWrapperRect.top && touchY <= pageWrapperRect.bottom) {
                    // Touch started inside scrollable content, allow native vertical scroll
                    // Prevent default to disable horizontal swipe only if vertical scroll isn't happening
                    // This is complex for mixed gestures, often best handled by native WebView if it supports it.
                    // For now, let's allow vertical scroll, and if horizontal swipe is strong enough, it will transition.
                    // e.preventDefault(); // CAUTION: This would disable vertical scroll if horizontal swipe logic dominates
                }
            }
            startX = e.touches[0].clientX;
            pageWrapper.style.transition = 'none'; // Tắt transition khi bắt đầu vuốt
        }

        function handleTouchMove(e) {
            const currentX = e.touches[0].clientX;
            currentTranslateX = lastTranslateX + (currentX - startX);
            pageWrapper.style.transform = `translateX(${currentTranslateX}px)`;
        }

        function handleTouchEnd(e) {
            pageWrapper.style.transition = 'transform 0.3s ease-out'; // Bật lại transition
            
            const endX = e.changedTouches[0].clientX;
            const diffX = endX - startX;

            if (diffX < -swipeThreshold && currentPageIndex < 1) { // Vuốt sang trái (next page)
                goToPage(currentPageIndex + 1);
            } else if (diffX > swipeThreshold && currentPageIndex > 0) { // Vuốt sang phải (previous page)
                goToPage(currentPageIndex - 1);
            } else { // Không đủ ngưỡng, quay về trang cũ
                goToPage(currentPageIndex);
            }
        }

        // --- Event Listeners ---
        sendButton.addEventListener('click', sendMessage);
        promptInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                sendMessage();
            }
        });

        decreaseFontButton.addEventListener('click', () => changeFontSize(-1));
        increaseFontButton.addEventListener('click', () => changeFontSize(1));

        // Lắng nghe sự kiện vuốt trên toàn bộ pageWrapper
        pageWrapper.addEventListener('touchstart', handleTouchStart);
        pageWrapper.addEventListener('touchmove', handleTouchMove);
        pageWrapper.addEventListener('touchend', handleTouchEnd);

        // --- Initial Setup on Load ---
        window.addEventListener('load', () => {
            adjustBodyPadding(); // Điều chỉnh padding body sau khi các fixed elements đã có chiều cao
            applyFontSize(); // Áp dụng kích thước font ban đầu
            // Có thể thêm một vài tin nhắn giả để kiểm tra cuộn
            // addMessage("Đây là tin nhắn demo 1 để kiểm tra cuộn.", 'ai');
            // addMessage("Đây là tin nhắn demo 2. Thử xoay núm Digital Crown hoặc vuốt dọc để cuộn nhé!", 'ai');
            // addMessage("Demo 3, Demo 4, Demo 5, Demo 6, Demo 7, Demo 8, Demo 9, Demo 10. Đây là một tin nhắn rất dài để xem nó xuống dòng như thế nào trên màn hình nhỏ. Hãy cuộn xuống để xem thêm!", 'ai');
        });

        // ResizeObserver để điều chỉnh padding nếu fixed header/footer thay đổi kích thước (ví dụ: bàn phím ảo WatchOS)
        const headerObserver = new ResizeObserver(adjustBodyPadding);
        headerObserver.observe(fixedHeader);
        const footerObserver = new ResizeObserver(adjustBodyPadding);
        footerObserver.observe(fixedFooter);
    </script>
</body>
</html>
