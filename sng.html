<!doctype html>
<html lang="vi">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
<title>Share&Go</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin="anonymous">
<link href="https://unpkg.com/@phosphor-icons/web@2.1.1/src/regular/style.css" rel="stylesheet">
<style>
  :root{
    /* iOS 26 palette */
    --bg: #0a0a0a;
    --fg: #f6f6f7;
    --muted: #a6a7ad;
    --primary: #0a84ff;
    --glass: rgba(255,255,255,0.06);
    --glass-2: rgba(255,255,255,0.12);
    --surface: rgba(20,20,20,0.6);
    --ok: #32d74b;
    --warn: #ff9f0a;
    --danger: #ff453a;

    --card-blur: 18px;
    --radius-xl: 18px;
    --radius-lg: 14px;

    --shadow-1: 0 10px 40px rgba(0,0,0,.35);
    --shadow-2: 0 4px 18px rgba(0,0,0,.45);
    --font: ui-rounded, "SF Pro Rounded", "SF Pro Text", system-ui, -apple-system, Segoe UI, Roboto, sans-serif;
  }
  [data-theme="light"]{
    --bg: #f2f3f7;
    --fg: #0b0c0f;
    --muted: #4a4b55;
    --primary: #007aff;
    --glass: rgba(255,255,255,0.6);
    --glass-2: rgba(255,255,255,0.8);
    --surface: rgba(255,255,255,0.8);
    --shadow-1: 0 10px 40px rgba(0,0,0,.08);
    --shadow-2: 0 4px 18px rgba(0,0,0,.12);
  }
  [data-theme="system"]{ /* will adapt via prefers-color-scheme in JS */ }

  html,body{
    height:100%; margin:0; background:var(--bg); color:var(--fg);
    font-family: var(--font);
  }

  .app{
    min-height:100%;
    display:flex; flex-direction:column; gap:16px;
    padding:16px; box-sizing:border-box;
  }

  .nav{
    display:flex; gap:8px; flex-wrap:wrap;
  }
  .chip{
    backdrop-filter: blur(var(--card-blur));
    -webkit-backdrop-filter: blur(var(--card-blur));
    background: var(--glass);
    border:1px solid rgba(255,255,255,.08);
    color: var(--fg);
    padding:10px 14px; border-radius:999px; cursor:pointer; user-select:none;
    transition:.2s transform ease, .2s background ease, .2s box-shadow ease;
    box-shadow: var(--shadow-2);
    display:flex; align-items:center; gap:8px;
  }
  .chip.active{ background:linear-gradient(180deg, var(--glass-2), transparent); box-shadow: var(--shadow-1); transform: translateY(-1px); }
  .chip i{ font-size:18px; }

  .row{
    display:grid; grid-template-columns: 1fr; gap:16px;
  }
  @media(min-width: 1024px){
    .row{ grid-template-columns: 1fr 1fr; }
  }

  .card{
    backdrop-filter: blur(var(--card-blur));
    -webkit-backdrop-filter: blur(var(--card-blur));
    background: var(--surface);
    border:1px solid rgba(255,255,255,.08);
    border-radius: var(--radius-xl);
    padding:16px;
    box-shadow: var(--shadow-1);
  }
  .title{ font-size:20px; font-weight:700; margin:0 0 12px; display:flex; align-items:center; gap:8px; }
  .subtitle{ font-size:13px; color:var(--muted); margin-top:-6px; }

  .controls{ display:flex; gap:8px; flex-wrap:wrap; align-items:center; }
  .controls .btn, .btn{
    display:inline-flex; align-items:center; gap:8px;
    border-radius: 12px; padding:10px 14px; border:1px solid rgba(255,255,255,.12);
    background: var(--glass); color:var(--fg); cursor:pointer; transition:.2s transform ease, .2s background ease;
  }
  .btn:hover{ transform: translateY(-1px); }
  .btn.primary{ background: linear-gradient(180deg, rgba(10,132,255,.25), rgba(10,132,255,.12)); border-color: rgba(10,132,255,.4); }
  .btn.ok{ background: linear-gradient(180deg, rgba(50,215,75,.25), rgba(50,215,75,.12)); border-color: rgba(50,215,75,.4); }
  .btn.warn{ background: linear-gradient(180deg, rgba(255,159,10,.25), rgba(255,159,10,.12)); border-color: rgba(255,159,10,.4); }
  .btn.danger{ background: linear-gradient(180deg, rgba(255,69,58,.25), rgba(255,69,58,.12)); border-color: rgba(255,69,58,.4); }

  .input, select, textarea{
    width:100%; box-sizing:border-box; border-radius:12px; border:1px solid rgba(255,255,255,.12);
    padding:12px 14px; background: rgba(255,255,255,.06); color:var(--fg);
    outline:none; transition:.2s border ease, .2s background ease;
  }
  textarea{ min-height:90px; resize:vertical; }
  .field{ display:grid; gap:6px; }
  label{ font-size:13px; color:var(--muted); }

  .grid{
    display:grid; grid-template-columns: repeat(2, 1fr); gap:10px;
  }
  .grid-3{ grid-template-columns: repeat(3, 1fr); }
  .grid-4{ grid-template-columns: repeat(4, 1fr); }

  .list{ display:flex; flex-direction:column; gap:10px; }
  .item{
    display:flex; justify-content:space-between; align-items:center; gap:10px;
    padding:10px; border-radius:12px; background: rgba(255,255,255,.05); border:1px solid rgba(255,255,255,.08);
  }
  .item .left{ display:flex; flex-direction:column; gap:2px; }
  .item .right{ display:flex; align-items:center; gap:6px; }
  .mono{ font-variant-numeric: tabular-nums; font-family: ui-monospace, SFMono-Regular, Menlo, monospace; }

  .hidden{ display:none !important; }

  /* Auth modal */
  .center{
    max-width: 1100px; width:100%; margin:0 auto;
  }
  .auth{
    min-height:100dvh; display:flex; align-items:center; justify-content:center;
    padding:24px;
    background:
      radial-gradient(80vmax 80vmax at 10% -10%, rgba(10,132,255,.18), transparent 60%),
      radial-gradient(70vmax 70vmax at 110% 0%, rgba(255,69,58,.16), transparent 60%),
      radial-gradient(80vmax 60vmax at 50% 110%, rgba(50,215,75,.12), transparent 60%),
      var(--bg);
  }
  .logo{ font-weight:900; font-size:28px; letter-spacing:.5px; }
  .logo b{ color: var(--primary); }
  .note{ font-size:12px; color:var(--muted); }

  /* Leaflet height */
  #map{ height: 360px; border-radius: 14px; overflow: hidden; }
  .pill{ border-radius:999px; padding:6px 10px; background: rgba(255,255,255,.08); border: 1px solid rgba(255,255,255,.12); }
  .star{ font-size:18px; cursor:pointer; opacity:.65; }
  .star.active{ opacity:1; filter: drop-shadow(0 1px 6px rgba(255, 214, 10, .35)); }
  .badge{ font-size:12px; padding:4px 8px; border-radius:999px; border:1px solid rgba(255,255,255,.14); background: rgba(255,255,255,.08);}
  .divider{ height:1px; background: rgba(255,255,255,.08); margin:8px 0; }
  .muted{ color:var(--muted); }

  a.link{ color: var(--primary); text-decoration: none; }
  .right-actions{ display:flex; gap:8px; flex-wrap:wrap; }
</style>
</head>
<body data-theme="system">
<div id="authView" class="auth">
  <div class="center" style="max-width:840px;">
    <div class="card">
      <div class="title"><i class="ph ph-navigation-arrow"></i><span class="logo">Share<b>&</b>Go</span></div>
      <p class="subtitle">ƒêƒÉng nh·∫≠p ƒë·ªÉ b·∫Øt ƒë·∫ßu chuy·∫øn ƒëi c·ªßa b·∫°n.</p>
      <div class="grid">
        <div class="field">
          <label>Email</label>
          <input id="email" class="input" placeholder="you@icloud.com / @gmail.com / @mhung.site" />
        </div>
        <div class="field">
          <label>M·∫≠t kh·∫©u</label>
          <input id="password" type="password" class="input" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" />
        </div>
      </div>
      <div class="controls" style="margin-top:10px;">
        <button id="btnLogin" class="btn primary"><i class="ph ph-sign-in"></i>ƒêƒÉng nh·∫≠p</button>
        <button id="btnRegister" class="btn"><i class="ph ph-user-plus"></i>ƒêƒÉng k√Ω</button>
        <button id="btnForgot" class="btn"><i class="ph ph-key"></i>Qu√™n m·∫≠t kh·∫©u</button>
      </div>
      <p class="note" style="margin-top:10px;">Ch·ªâ ch·∫•p nh·∫≠n email ƒëu√¥i <b>@icloud.com</b>, <b>@gmail.com</b>, <b>@mhung.site</b>.</p>
    </div>
  </div>
</div>

<div id="appView" class="app hidden">
  <div class="center">
    <div class="nav">
      <div class="chip active" data-tab="home"><i class="ph ph-navigation-arrow"></i>Share&Go</div>
      <div class="chip" data-tab="luggage"><i class="ph ph-suitcase-simple"></i>H√†nh l√Ω</div>
      <div class="chip" data-tab="cloud"><i class="ph ph-cloud"></i>ƒê√°m m√¢y</div>
      <div class="chip" data-tab="games"><i class="ph ph-game-controller"></i>Tr√≤ ch∆°i</div>
      <div class="chip" data-tab="settings"><i class="ph ph-gear"></i>C√†i ƒë·∫∑t</div>
      <div style="flex:1"></div>
      <div class="chip" id="currentUserChip"><i class="ph ph-user"></i><span id="currentUserName">‚Ä¶</span></div>
      <div class="chip" id="btnLogout"><i class="ph ph-sign-out"></i>ƒêƒÉng xu·∫•t</div>
    </div>
  </div>

  <!-- Share&Go Main -->
  <div id="home" class="center">
    <div class="row">
      <div class="card">
        <div class="title"><i class="ph ph-airplane-takeoff"></i>T·∫°o/Tham gia chuy·∫øn ƒëi</div>
        <div class="grid">
          <div class="field">
            <label>T√™n chuy·∫øn ƒëi</label>
            <input id="tripName" class="input" placeholder="V√≠ d·ª•: ƒê√† L·∫°t th√°ng 12" />
          </div>
          <div class="field">
            <label>M√¥ t·∫£</label>
            <input id="tripDesc" class="input" placeholder="M·ª•c ti√™u, l·ªãch tr√¨nh, v.v." />
          </div>
          <div class="field">
            <label>S·ªë ng∆∞·ªùi tham gia</label>
            <input id="tripPeople" class="input" type="number" min="1" value="2" />
          </div>
        </div>
        <div class="controls" style="margin-top:10px;">
          <button id="btnCreateTrip" class="btn primary"><i class="ph ph-plus-circle"></i>T·∫°o chuy·∫øn ƒëi</button>
          <span class="muted">ho·∫∑c</span>
          <input id="joinCode" class="input" style="max-width:220px" placeholder="Nh·∫≠p m√£ tham gia" />
          <button id="btnJoinTrip" class="btn"><i class="ph ph-user-plus"></i>Tham gia</button>
        </div>
        <div class="subtitle" style="margin-top:6px;">C√≥ th·ªÉ d√°n link m·ªùi: khi m·ªü s·∫Ω h·ªèi tham gia chuy·∫øn ƒëi.</div>
      </div>

      <div class="card">
        <div class="title"><i class="ph ph-list-bullets"></i>Chuy·∫øn ƒëi c·ªßa t√¥i</div>
        <div id="tripList" class="list"></div>
      </div>
    </div>

    <div id="tripDetail" class="card hidden" style="margin-top:16px;">
      <div class="title"><i class="ph ph-map-trifold"></i><span id="tripDetailTitle">Chi ti·∫øt</span>
        <span class="badge" id="tripCodeBadge"></span>
        <span class="badge" id="tripRoleBadge"></span>
        <span style="flex:1"></span>
        <div class="right-actions">
          <button id="btnCopyInvite" class="btn"><i class="ph ph-link"></i>Sao ch√©p link/m√£</button>
          <button id="btnEditTrip" class="btn"><i class="ph ph-pencil-line"></i>Ch·ªânh s·ª≠a</button>
          <button id="btnDeleteTrip" class="btn danger"><i class="ph ph-trash"></i>Xo√°</button>
        </div>
      </div>
      <div class="controls" style="margin-bottom:12px;">
        <span class="pill subtab active" data-sub="input"><i class="ph ph-note-pencil"></i>Nh·∫≠p li·ªáu</span>
        <span class="pill subtab" data-sub="history"><i class="ph ph-clock"></i>L·ªãch s·ª≠</span>
        <span class="pill subtab" data-sub="chat"><i class="ph ph-chat"></i>Tin nh·∫Øn</span>
        <span class="pill subtab" data-sub="stats"><i class="ph ph-chart-bar"></i>Th·ªëng k√™</span>
      </div>

      <!-- Subtab: INPUT -->
      <div id="sub-input">
        <div class="grid">
          <div class="field">
            <label>T√™n ƒë·ªãa ƒëi·ªÉm</label>
            <input id="placeName" class="input" placeholder="V√≠ d·ª•: Thung l≈©ng T√¨nh Y√™u" />
          </div>
          <div class="field">
            <label>V·ªã tr√≠ ƒë·ªãa ƒëi·ªÉm</label>
            <div class="controls">
              <input id="placeQuery" class="input" placeholder="G√µ ƒë·ªÉ g·ª£i √Ω / ho·∫∑c nh·∫•n tr√™n b·∫£n ƒë·ªì" />
              <button id="btnLocate" class="btn"><i class="ph ph-crosshair"></i>ƒê·ªãnh v·ªã</button>
            </div>
            <div id="map" style="margin-top:10px;"></div>
            <div class="grid">
              <div class="field"><label>Lat</label><input id="lat" class="input mono" placeholder="‚Ä¶" /></div>
              <div class="field"><label>Lng</label><input id="lng" class="input mono" placeholder="‚Ä¶" /></div>
            </div>
            <div class="subtitle" style="margin-top:6px;">Ch·∫ø ƒë·ªô b·∫£n ƒë·ªì: M·∫∑c ƒë·ªãnh, V·ªá tinh, Terrain, T·ªëi (g√≥c tr√™n ph·∫£i).</div>
          </div>
        </div>

        <div class="grid-3" style="display:grid; gap:10px; margin-top:10px;">
          <div class="field">
            <label>S·ªë ng∆∞·ªùi</label>
            <div class="controls">
              <button class="btn" id="btnMinus">‚àí</button>
              <input id="peopleCount" class="input mono" type="number" value="1" min="1" />
              <button class="btn" id="btnPlus">+</button>
              <button class="btn" id="btnMax">T·ªëi ƒëa</button>
            </div>
          </div>
          <div class="field">
            <label>T·ªïng ti·ªÅn</label>
            <input id="totalCost" class="input mono" placeholder="VD: 120000 ‚Üí 120.000" />
          </div>
          <div class="field">
            <label>Gi·ªù</label>
            <div class="controls">
              <input id="timeInput" class="input mono" placeholder="VD: 1930 ‚Üí 19:30" />
              <button class="btn" id="btnNowTime">Hi·ªán t·∫°i</button>
            </div>
          </div>
          <div class="field">
            <label>Ng√†y</label>
            <div class="controls">
              <input id="dateInput" class="input mono" placeholder="VD: 2512 ‚Üí 25/12" />
              <button class="btn" id="btnNowDate">H√¥m nay</button>
            </div>
          </div>
          <div class="field">
            <label>ƒê√°nh gi√°</label>
            <div class="controls" id="ratingStars" style="gap:6px;">
              <span class="star" data-v="1">‚≠ê</span>
              <span class="star" data-v="2">‚≠ê</span>
              <span class="star" data-v="3">‚≠ê</span>
              <span class="star" data-v="4">‚≠ê</span>
              <span class="star" data-v="5">‚≠ê</span>
            </div>
          </div>
          <div class="field">
            <label>Ghi ch√∫</label>
            <input id="note" class="input" placeholder="Tu·ª≥ ch·ªçn‚Ä¶" />
          </div>
        </div>

        <div class="controls" style="margin-top:10px;">
          <button id="btnAddEntry" class="btn ok"><i class="ph ph-check-circle"></i>Th√™m v√†o l·ªãch s·ª≠</button>
        </div>
      </div>

      <!-- Subtab: HISTORY -->
      <div id="sub-history" class="hidden">
        <div class="controls" style="margin-bottom:8px;">
          <input id="searchHistory" class="input" style="max-width:260px" placeholder="T√¨m ƒë·ªãa ƒëi·ªÉm‚Ä¶" />
          <select id="sortHistory" class="input" style="max-width:220px">
            <option value="time_desc">S·∫Øp x·∫øp: Th·ªùi gian m·ªõi ‚Üí c≈©</option>
            <option value="time_asc">Th·ªùi gian c≈© ‚Üí m·ªõi</option>
            <option value="name_asc">T√™n A‚ÜíZ</option>
            <option value="name_desc">T√™n Z‚ÜíA</option>
            <option value="cost_desc">T·ªïng ti·ªÅn cao ‚Üí th·∫•p</option>
            <option value="cost_asc">T·ªïng ti·ªÅn th·∫•p ‚Üí cao</option>
          </select>
          <button id="btnExportTxt" class="btn"><i class="ph ph-text-aa"></i>Xu·∫•t TXT</button>
          <button id="btnExportJson" class="btn"><i class="ph ph-brackets-curly"></i>Xu·∫•t JSON</button>
          <button id="btnExportXlsx" class="btn"><i class="ph ph-table"></i>Xu·∫•t Excel</button>
          <button id="btnCopyPlain" class="btn"><i class="ph ph-copy"></i>Copy vƒÉn b·∫£n</button>
        </div>
        <div id="historyList" class="list"></div>
      </div>

      <!-- Subtab: CHAT -->
      <div id="sub-chat" class="hidden">
        <div id="chatList" class="list" style="max-height:360px; overflow:auto; padding-right:4px;"></div>
        <div class="controls" style="margin-top:8px;">
          <input id="chatInput" class="input" placeholder="Nh·∫Øn g√¨ ƒë√≥‚Ä¶ (tin c√≥ @ s·∫Ω c√≥ n√∫t sao ch√©p b·ªè @)" />
          <button id="btnSendChat" class="btn primary"><i class="ph ph-paper-plane-tilt"></i>G·ª≠i</button>
        </div>
      </div>

      <!-- Subtab: STATS -->
      <div id="sub-stats" class="hidden">
        <div id="statsBox" class="grid">
          <div class="card">
            <div class="title"><i class="ph ph-map-pin"></i>ƒê·ªãa ƒëi·ªÉm ƒë√£ ƒëi</div>
            <div id="statPlaces" class="mono" style="font-size:28px;">0</div>
          </div>
          <div class="card">
            <div class="title"><i class="ph ph-currency-dollar"></i>T·ªïng chi</div>
            <div id="statTotal" class="mono" style="font-size:28px;">0</div>
          </div>
          <div class="card">
            <div class="title"><i class="ph ph-users-three"></i>S·ªë ti·ªÅn m·ªói ng∆∞·ªùi</div>
            <div id="statPerPerson" class="mono" style="font-size:28px;">0</div>
          </div>
          <div class="card">
            <div class="title"><i class="ph ph-star"></i>ƒêi·ªÉm trung b√¨nh</div>
            <div id="statRating" class="mono" style="font-size:28px;">0</div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- LUGGAGE -->
  <div id="luggage" class="center hidden">
    <div class="row">
      <div class="card">
        <div class="title"><i class="ph ph-suitcase"></i>H√†nh l√Ω</div>
        <div class="controls">
          <input id="lugName" class="input" placeholder="T√™n m√≥n ƒë·ªì" style="max-width:200px;">
          <input id="lugQty" type="number" class="input" placeholder="SL" style="max-width:100px;" value="1" min="1">
          <input id="lugNote" class="input" placeholder="Ghi ch√∫" style="max-width:240px;">
          <button id="btnAddLug" class="btn ok"><i class="ph ph-plus"></i>Th√™m</button>
        </div>
        <div id="luggageList" class="list" style="margin-top:10px;"></div>
        <div class="controls" style="margin-top:10px;">
          <button id="btnCopyLug" class="btn"><i class="ph ph-copy"></i>Sao ch√©p vƒÉn b·∫£n</button>
        </div>
      </div>
      <div class="card">
        <div class="title"><i class="ph ph-lightbulb"></i>M·∫´u g·ª£i √Ω</div>
        <div class="controls">
          <select id="templateSelect" class="input" style="max-width:260px;"></select>
          <button id="btnApplyTpl" class="btn"><i class="ph ph-download-simple"></i>√Åp d·ª•ng</button>
        </div>
        <div class="divider"></div>
        <div class="controls">
          <input id="tplName" class="input" placeholder="T√™n m·∫´u m·ªõi" style="max-width:260px;">
          <button id="btnSaveTpl" class="btn"><i class="ph ph-floppy-disk"></i>L∆∞u m·∫´u</button>
          <button id="btnDeleteTpl" class="btn danger"><i class="ph ph-trash"></i>Xo√° m·∫´u</button>
        </div>
      </div>
    </div>
  </div>

  <!-- CLOUD -->
  <div id="cloud" class="center hidden">
    <div class="card">
      <div class="title"><i class="ph ph-cloud"></i>ƒê√°m m√¢y</div>
      <p class="subtitle">S·∫Ω b·ªï sung sau.</p>
    </div>
  </div>

  <!-- GAMES -->
  <div id="games" class="center hidden">
    <div class="card">
      <div class="title"><i class="ph ph-game-controller"></i>Tr√≤ ch∆°i</div>
      <p class="subtitle">S·∫Ω b·ªï sung sau.</p>
    </div>
  </div>

  <!-- SETTINGS -->
  <div id="settings" class="center hidden">
    <div class="row">
      <div class="card">
        <div class="title"><i class="ph ph-gear"></i>C√†i ƒë·∫∑t</div>
        <div class="field">
          <label>Giao di·ªán</label>
          <select id="themeMode" class="input" style="max-width:220px;">
            <option value="light">S√°ng</option>
            <option value="dark">T·ªëi</option>
            <option value="system" selected>Thi·∫øt b·ªã</option>
          </select>
        </div>
        <div class="divider"></div>
        <div class="title" style="margin-top:6px;"><i class="ph ph-user-circle"></i>H·ªì s∆°</div>
        <div class="grid">
          <div class="field">
            <label>T√™n hi·ªÉn th·ªã</label>
            <input id="profileName" class="input" placeholder="T√™n c·ªßa b·∫°n">
          </div>
          <div class="field">
            <label>·∫¢nh ƒë·∫°i di·ªán (Emoji ho·∫∑c UID Facebook)</label>
            <input id="profileAvatar" class="input" placeholder="üôÇ ho·∫∑c 1000xxxxxxxxx (UID)">
          </div>
        </div>
        <div class="controls" style="margin-top:10px;">
          <button id="btnSaveProfile" class="btn ok"><i class="ph ph-check-circle"></i>L∆∞u</button>
          <button id="btnChangePassword" class="btn warn"><i class="ph ph-key"></i>ƒê·ªïi m·∫≠t kh·∫©u (email)</button>
        </div>
        <p class="subtitle">N·∫øu nh·∫≠p UID Facebook (s·ªë), h·ªá th·ªëng s·∫Ω d√πng ·∫£nh ƒë·∫°i di·ªán t·ª´ Graph.</p>
      </div>
    </div>
  </div>
</div>

<!-- Firebase + Leaflet + SheetJS -->
<script type="module">
  // ---- Firebase
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.13.2/firebase-app.js";
  import { getAuth, onAuthStateChanged, signInWithEmailAndPassword, createUserWithEmailAndPassword, sendPasswordResetEmail, signOut, updatePassword } from "https://www.gstatic.com/firebasejs/10.13.2/firebase-auth.js";
  import { getFirestore, doc, setDoc, getDoc, addDoc, collection, onSnapshot, query, where, orderBy, updateDoc, deleteDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.13.2/firebase-firestore.js";
  import { getAnalytics } from "https://www.gstatic.com/firebasejs/10.13.2/firebase-analytics.js";

  // ---- Leaflet
  import "https://unpkg.com/leaflet@1.9.4/dist/leaflet.js";

  // ---- SheetJS (Excel export)
  import * as XLSX from "https://cdn.jsdelivr.net/npm/xlsx@0.18.5/+esm";

  // Firebase Config (do b·∫°n cung c·∫•p)
  const firebaseConfig = {
    apiKey: "AIzaSyBQOcwUdtv1quQ1UWV8oaGY6kIUwITlSos",
    authDomain: "sharengo-hunq.firebaseapp.com",
    projectId: "sharengo-hunq",
    storageBucket: "sharengo-hunq.firebasestorage.app",
    messagingSenderId: "20454542571",
    appId: "1:20454542571:web:8021a519b26f9be30882ae",
    measurementId: "G-T0XNLVWXYV"
  };

  const app = initializeApp(firebaseConfig);
  let analytics;
  try { analytics = getAnalytics(app); } catch(e){ /* optional */ }
  const auth = getAuth(app);
  const db = getFirestore(app);

  // ----- Helpers
  const $ = (s) => document.querySelector(s);
  const $$ = (s) => Array.from(document.querySelectorAll(s));
  const toast = (msg) => alert(msg); // ƒë∆°n gi·∫£n

  // theme
  const applyTheme = (mode) => {
    if(mode === 'system'){
      const dark = window.matchMedia('(prefers-color-scheme: dark)').matches;
      document.body.setAttribute('data-theme', dark ? 'dark' : 'light');
    } else {
      document.body.setAttribute('data-theme', mode);
    }
    localStorage.setItem('themeMode', mode);
    $('#themeMode').value = mode;
  }
  const savedTheme = localStorage.getItem('themeMode') || 'system';
  applyTheme(savedTheme);
  window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', ()=> {
    if((localStorage.getItem('themeMode') || 'system') === 'system') applyTheme('system');
  });
  $('#themeMode')?.addEventListener('change', e=> applyTheme(e.target.value));

  // allowed email domains
  const allowedDomains = ['icloud.com','gmail.com','mhung.site'];

  function checkEmailDomain(email){
    const at = email.lastIndexOf('@');
    if(at < 0) return false;
    const domain = email.slice(at+1).toLowerCase().trim();
    return allowedDomains.includes(domain);
  }

  // currency format (dot every 3 digits)
  function formatMoneyInput(el){
    el.value = el.value.replace(/[^\d]/g,'');
    if(el.value === '') return;
    el.value = el.value.replace(/\B(?=(\d{3})+(?!\d))/g, '.');
  }
  function parseMoney(str){
    const n = Number((str||'').toString().replace(/\./g,'').replace(/[^\d]/g,''));
    return isNaN(n) ? 0 : n;
  }

  // time parsing: "1930"->"19:30", "25"->"00:25"
  function normalizeTime(s){
    s = (s||'').replace(/[^\d]/g,'');
    if(s.length===4) return s.slice(0,2)+':'+s.slice(2);
    if(s.length===3) return '0'+s[0]+':'+s.slice(1);
    if(s.length===2) return '00:'+s;
    if(s.length===1) return '00:0'+s;
    return s.includes(':')?s:'';
  }
  // date parsing: "2512"->"25/12", "251225"->"25/12/2025"
  function normalizeDate(s){
    s = (s||'').replace(/[^\d]/g,'');
    const now = new Date();
    const curM = (now.getMonth()+1).toString().padStart(2,'0');
    const curY = now.getFullYear().toString();
    if(s.length===6){ // ddMMyy -> dd/MM/20yy heuristic
      const dd=s.slice(0,2), mm=s.slice(2,4), yy=s.slice(4);
      const yyyy = (yy.length===2 ? (Number(yy) > 50 ? '19'+yy : '20'+yy) : yy);
      return `${dd}/${mm}/${yyyy}`;
    }
    if(s.length===8){ // ddMMyyyy
      const dd=s.slice(0,2), mm=s.slice(2,4), yyyy=s.slice(4);
      return `${dd}/${mm}/${yyyy}`;
    }
    if(s.length===4){ // ddMM -> dd/MM/(current year)
      const dd=s.slice(0,2), mm=s.slice(2);
      return `${dd}/${mm}/${curY}`;
    }
    if(s.length===2){ // dd -> dd/(current month)/(current year)
      const dd=s;
      return `${dd}/${curM}/${curY}`;
    }
    if(s.includes('/')){
      const parts = s.split('/');
      if(parts.length===2) return `${parts[0]}/${parts[1]}/${curY}`;
      return s;
    }
    return s;
  }
  function toDate(dateStr, timeStr){
    // expects dd/MM/yyyy and HH:mm
    try{
      const [d,m,y] = dateStr.split('/').map(Number);
      const [H,Mi] = timeStr.split(':').map(Number);
      const dt = new Date(y, m-1, d, H||0, Mi||0, 0, 0);
      return dt;
    }catch(e){ return new Date(); }
  }
  function humanDate(dt){
    const d = dt instanceof Date ? dt : new Date(dt);
    return d.toLocaleString('vi-VN', { hour: '2-digit', minute:'2-digit', day:'2-digit', month:'2-digit', year:'numeric' });
  }

  const uid = () => Math.random().toString(36).slice(2,10).toUpperCase();
  function copy(text){
    navigator.clipboard.writeText(text).then(()=>toast('ƒê√£ sao ch√©p'));
  }

  // ----- UI state
  const authView = $('#authView');
  const appView = $('#appView');

  // Tabs
  $$('.chip[data-tab]').forEach(c=>{
    c.addEventListener('click', ()=>{
      $$('.chip[data-tab]').forEach(x=>x.classList.remove('active'));
      c.classList.add('active');
      const t = c.getAttribute('data-tab');
      ['home','luggage','cloud','games','settings'].forEach(id=>{
        $('#'+id).classList.toggle('hidden', id!==t);
      });
    });
  });

  // Current user state
  let currentUser = null;
  let userProfile = null; // {name, avatar}
  let currentTrip = null;
  let currentTripRole = 'member'; // or 'owner'

  // ---- Auth Handlers
  $('#btnLogin').addEventListener('click', async ()=>{
    const email = $('#email').value.trim();
    const password = $('#password').value;
    if(!checkEmailDomain(email)) return toast('Email kh√¥ng thu·ªôc mi·ªÅn ƒë∆∞·ª£c ph√©p.');
    try{
      await signInWithEmailAndPassword(auth, email, password);
    }catch(e){ toast('ƒêƒÉng nh·∫≠p l·ªói: '+e.message); }
  });

  $('#btnRegister').addEventListener('click', async ()=>{
    const email = $('#email').value.trim();
    const password = $('#password').value;
    if(!checkEmailDomain(email)) return toast('Email kh√¥ng thu·ªôc mi·ªÅn ƒë∆∞·ª£c ph√©p.');
    if(password.length < 6) return toast('M·∫≠t kh·∫©u t·ªëi thi·ªÉu 6 k√Ω t·ª±.');
    try{
      const res = await createUserWithEmailAndPassword(auth, email, password);
      // t·∫°o profile tr·ªëng -> bu·ªôc nh·∫≠p t√™n & avatar sau ƒëƒÉng k√Ω
      await setDoc(doc(db, 'users', res.user.uid), {
        name: '',
        avatar: 'üôÇ',
        createdAt: serverTimestamp(),
        updatedAt: serverTimestamp(),
        email
      });
      toast('ƒêƒÉng k√Ω th√†nh c√¥ng, vui l√≤ng c·∫≠p nh·∫≠t T√™n & ·∫¢nh ƒë·∫°i di·ªán trong C√†i ƒë·∫∑t.');
    }catch(e){ toast('ƒêƒÉng k√Ω l·ªói: '+e.message); }
  });

  $('#btnForgot').addEventListener('click', async ()=>{
    const email = $('#email').value.trim();
    if(!email) return toast('Nh·∫≠p email ƒë·ªÉ g·ª≠i li√™n k·∫øt ƒë·∫∑t l·∫°i m·∫≠t kh·∫©u.');
    try{
      await sendPasswordResetEmail(auth, email);
      toast('ƒê√£ g·ª≠i email ƒë·∫∑t l·∫°i m·∫≠t kh·∫©u.');
    }catch(e){ toast('L·ªói: '+e.message); }
  });

  $('#btnLogout').addEventListener('click', ()=> signOut(auth));

  onAuthStateChanged(auth, async (user)=>{
    if(user){
      currentUser = user;
      // load profile
      const uref = doc(db, 'users', user.uid);
      const udoc = await getDoc(uref);
      if(!udoc.exists()){
        await setDoc(uref, { name:'', avatar:'üôÇ', email:user.email, createdAt: serverTimestamp(), updatedAt: serverTimestamp() });
        userProfile = { name:'', avatar:'üôÇ' };
      }else{
        userProfile = udoc.data();
      }
      $('#currentUserName').textContent = userProfile?.name || user.email;
      authView.classList.add('hidden');
      appView.classList.remove('hidden');
      loadTrips();
      loadTemplates();
      loadLuggage();
      // deep link join by ?join=CODE
      const url = new URL(location.href);
      const join = url.searchParams.get('join');
      if(join){ tryJoinTrip(join); }
    }else{
      appView.classList.add('hidden');
      authView.classList.remove('hidden');
      currentUser = null;
    }
  });

  // ----- Trips
  async function loadTrips(){
    if(!currentUser) return;
    const q1 = query(collection(db,'trips'), where('ownerId','==', currentUser.uid));
    const q2 = query(collection(db,'trips'), where('memberIds','array-contains', currentUser.uid));
    const unsub1 = onSnapshot(q1, renderTrips);
    const unsub2 = onSnapshot(q2, renderTrips);
    // store to clean if need (not necessary now)
  }
  const tripsCache = new Map();
  function renderTrips(snap){
    snap.docChanges().forEach(ch=>{
      if(ch.type==='removed'){ tripsCache.delete(ch.doc.id); }
      else tripsCache.set(ch.doc.id, {id: ch.doc.id, ...ch.doc.data()});
    });
    const arr = Array.from(tripsCache.values()).sort((a,b)=> (b.createdAt?.seconds||0)-(a.createdAt?.seconds||0));
    const box = $('#tripList'); box.innerHTML = '';
    if(arr.length===0){
      box.innerHTML = `<div class="item"><div class="left"><b>Ch∆∞a c√≥ chuy·∫øn ƒëi</b><span class="muted">H√£y t·∫°o ho·∫∑c tham gia b·∫±ng m√£.</span></div></div>`;
      return;
    }
    for(const t of arr){
      const owned = t.ownerId === currentUser.uid;
      const el = document.createElement('div');
      el.className='item';
      el.innerHTML = `
        <div class="left">
          <b>${t.name} ${owned?'<span class="badge">Tr∆∞·ªüng nh√≥m</span>':''}</b>
          <span class="muted">${t.desc||''}</span>
          <span class="muted">M√£: <span class="mono">${t.code}</span> ‚Ä¢ Th√†nh vi√™n: ${t.memberIds?.length||1}</span>
        </div>
        <div class="right">
          <button class="btn" data-open="${t.id}"><i class="ph ph-arrow-right"></i>M·ªü</button>
        </div>`;
      box.appendChild(el);
      el.querySelector('[data-open]').addEventListener('click', ()=> openTrip(t.id));
    }
  }

  function genTripCode(){ return uid(); }

  $('#btnCreateTrip').addEventListener('click', async ()=>{
    const name = $('#tripName').value.trim();
    const desc = $('#tripDesc').value.trim();
    const people = Math.max(1, Number($('#tripPeople').value||1));
    if(!name) return toast('Nh·∫≠p t√™n chuy·∫øn ƒëi.');
    const code = genTripCode();
    const tripRef = await addDoc(collection(db,'trips'), {
      name, desc, people, code,
      ownerId: currentUser.uid,
      memberIds: [currentUser.uid],
      createdAt: serverTimestamp(),
      updatedAt: serverTimestamp()
    });
    toast('ƒê√£ t·∫°o chuy·∫øn ƒëi.');
    openTrip(tripRef.id);
  });

  $('#btnJoinTrip').addEventListener('click', ()=> {
    const code = $('#joinCode').value.trim().toUpperCase();
    if(!code) return toast('Nh·∫≠p m√£ ƒë·ªÉ tham gia.');
    tryJoinTrip(code);
  });

  async function tryJoinTrip(code){
    // naive search by code (client): stream all trips with code == X (ideally use composite index or Cloud Function)
    const qCode = query(collection(db,'trips'), where('code','==', code));
    const unsub = onSnapshot(qCode, async (snap)=>{
      let found = null;
      snap.forEach(d=> found = {id:d.id, ...d.data()});
      if(!found){ toast('Kh√¥ng t√¨m th·∫•y chuy·∫øn ƒëi v·ªõi m√£ n√†y.'); return; }
      if(!(found.memberIds||[]).includes(currentUser.uid)){
        await updateDoc(doc(db,'trips', found.id), { memberIds: [...(found.memberIds||[]), currentUser.uid], updatedAt: serverTimestamp() });
        toast('ƒê√£ tham gia chuy·∫øn ƒëi!');
      }
      openTrip(found.id);
      unsub(); // one-off
    });
  }

  async function openTrip(tripId){
    const d = await getDoc(doc(db,'trips', tripId));
    if(!d.exists()){ toast('Chuy·∫øn ƒëi kh√¥ng t·ªìn t·∫°i.'); return; }
    currentTrip = { id: d.id, ...d.data() };
    currentTripRole = currentTrip.ownerId === currentUser.uid ? 'owner' : 'member';
    // update header
    $('#tripDetail').classList.remove('hidden');
    $('#tripDetailTitle').textContent = currentTrip.name;
    $('#tripCodeBadge').textContent = 'M√£: '+ currentTrip.code;
    $('#tripRoleBadge').textContent = currentTripRole==='owner' ? 'Tr∆∞·ªüng nh√≥m' : 'Th√†nh vi√™n';

    // permissions:
    $('#btnEditTrip').disabled = currentTripRole!=='owner';
    $('#btnDeleteTrip').disabled = currentTripRole!=='owner';

    // listeners: entries, chat -> live
    watchEntries();
    watchChat();
    updateStats();
    initMapLayer();
    // default subtab
    switchSubtab('input');
  }

  // Edit / Delete / Share
  $('#btnEditTrip').addEventListener('click', async ()=>{
    if(currentTripRole!=='owner') return toast('Ch·ªâ tr∆∞·ªüng nh√≥m ƒë∆∞·ª£c s·ª≠a.');
    const name = prompt('T√™n m·ªõi', currentTrip.name);
    if(!name) return;
    const desc = prompt('M√¥ t·∫£', currentTrip.desc||'') ?? '';
    const people = Number(prompt('S·ªë ng∆∞·ªùi', currentTrip.people||1))||currentTrip.people||1;
    await updateDoc(doc(db,'trips', currentTrip.id), { name, desc, people, updatedAt: serverTimestamp() });
    openTrip(currentTrip.id);
    toast('ƒê√£ c·∫≠p nh·∫≠t.');
  });
  $('#btnDeleteTrip').addEventListener('click', async ()=>{
    if(currentTripRole!=='owner') return toast('Ch·ªâ tr∆∞·ªüng nh√≥m ƒë∆∞·ª£c xo√°.');
    if(!confirm('Xo√° chuy·∫øn ƒëi n√†y? M·ªçi d·ªØ li·ªáu (l·ªãch s·ª≠, chat) s·∫Ω b·ªã xo√°.')) return;
    await deleteDoc(doc(db,'trips', currentTrip.id));
    $('#tripDetail').classList.add('hidden');
    currentTrip = null;
    toast('ƒê√£ xo√° chuy·∫øn ƒëi.');
  });
  $('#btnCopyInvite').addEventListener('click', ()=>{
    const link = `${location.origin}${location.pathname}?join=${currentTrip.code}`;
    copy(`M√£: ${currentTrip.code}\nLink: ${link}`);
  });

  // ---- Subtabs
  function switchSubtab(name){
    $$('.pill.subtab').forEach(p=>p.classList.toggle('active', p.getAttribute('data-sub')===name));
    $('#sub-input').classList.toggle('hidden', name!=='input');
    $('#sub-history').classList.toggle('hidden', name!=='history');
    $('#sub-chat').classList.toggle('hidden', name!=='chat');
    $('#sub-stats').classList.toggle('hidden', name!=='stats');
  }
  $$('.pill.subtab').forEach(p=> p.addEventListener('click', ()=> switchSubtab(p.getAttribute('data-sub')) ));

  // ---- Map (Leaflet + OSM)
  let map, marker, layersControl;
  function initMapLayer(){
    if(map){ map.invalidateSize(); return; }
    map = L.map('map', { center: [21.0278, 105.8342], zoom: 13 }); // H√† N·ªôi
    const baseOSM = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      maxZoom: 19, attribution: '&copy; OpenStreetMap'
    }).addTo(map);
    const satellite = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {
      maxZoom: 19, attribution: 'Tiles &copy; Esri'
    });
    const terrain = L.tileLayer('https://{s}.tile.opentopomap.org/{z}/{x}/{y}.png', {
      maxZoom: 17, attribution: '&copy; OpenTopoMap'
    });
    const dark = L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', {
      maxZoom: 19, attribution: '&copy; CARTO'
    });
    layersControl = L.control.layers({
      'M·∫∑c ƒë·ªãnh': baseOSM,
      'V·ªá tinh': satellite,
      'Terrain': terrain,
      'T·ªëi': dark
    }).addTo(map);

    map.on('click', (e)=>{
      setLatLng(e.latlng.lat, e.latlng.lng, true);
    });
  }
  function setLatLng(lat, lng, move=false){
    $('#lat').value = lat.toFixed(6);
    $('#lng').value = lng.toFixed(6);
    if(!map) return;
    if(!marker){
      marker = L.marker([lat,lng]).addTo(map);
    }else{
      marker.setLatLng([lat,lng]);
    }
    if(move) map.setView([lat,lng], 15);
  }
  $('#btnLocate').addEventListener('click', ()=>{
    if(!navigator.geolocation) return toast('Thi·∫øt b·ªã kh√¥ng h·ªó tr·ª£ ƒë·ªãnh v·ªã.');
    navigator.geolocation.getCurrentPosition(pos=>{
      setLatLng(pos.coords.latitude, pos.coords.longitude, true);
    }, ()=> toast('Kh√¥ng l·∫•y ƒë∆∞·ª£c v·ªã tr√≠.'));
  });

  // simple place suggestion via Nominatim is not allowed offline; keep manual or map click
  // However we keep an input field for user's own reference.
  $('#placeQuery').addEventListener('change', ()=>{
    // user-provided note into placeName if empty
    if(!$('#placeName').value) $('#placeName').value = $('#placeQuery').value;
  });

  // People buttons
  $('#btnMinus').addEventListener('click', ()=> $('#peopleCount').value = Math.max(1, Number($('#peopleCount').value)-1));
  $('#btnPlus').addEventListener('click', ()=> $('#peopleCount').value = Math.max(1, Number($('#peopleCount').value)+1));
  $('#btnMax').addEventListener('click', ()=> $('#peopleCount').value = currentTrip?.people || Number($('#tripPeople').value)||1);

  $('#totalCost').addEventListener('input', ()=> formatMoneyInput($('#totalCost')));
  $('#timeInput').addEventListener('input', ()=> { $('#timeInput').value = normalizeTime($('#timeInput').value); });
  $('#dateInput').addEventListener('input', ()=> { $('#dateInput').value = normalizeDate($('#dateInput').value); });
  $('#btnNowTime').addEventListener('click', ()=>{
    const d = new Date(); $('#timeInput').value = d.toTimeString().slice(0,5);
  });
  $('#btnNowDate').addEventListener('click', ()=>{
    const d = new Date(); const s = d.toLocaleDateString('vi-VN', { day:'2-digit', month:'2-digit', year:'numeric' });
    $('#dateInput').value = s.replaceAll('.','/'); // locale fix
  });

  // rating
  let rating = 5;
  $$('#ratingStars .star').forEach(st=>{
    st.addEventListener('click', ()=>{
      rating = Number(st.dataset.v);
      $$('#ratingStars .star').forEach(x=> x.classList.toggle('active', Number(x.dataset.v)<=rating));
    });
  });
  // default star on load
  $$('#ratingStars .star').forEach(x=> x.classList.toggle('active', Number(x.dataset.v)<=rating));

  // Add entry
  $('#btnAddEntry').addEventListener('click', async ()=>{
    if(!currentTrip) return toast('Ch∆∞a ch·ªçn chuy·∫øn ƒëi.');
    const name = $('#placeName').value.trim();
    if(!name) return toast('Nh·∫≠p t√™n ƒë·ªãa ƒëi·ªÉm.');
    const lat = Number($('#lat').value||0);
    const lng = Number($('#lng').value||0);
    const people = Math.max(1, Number($('#peopleCount').value||1));
    const amount = parseMoney($('#totalCost').value);
    const timeStr = normalizeTime($('#timeInput').value) || new Date().toTimeString().slice(0,5);
    const dateStr = normalizeDate($('#dateInput').value) || new Date().toLocaleDateString('vi-VN', { day:'2-digit', month:'2-digit', year:'numeric' }).replaceAll('.','/');
    const when = toDate(dateStr, timeStr).toISOString();
    const note = $('#note').value.trim();
    const placeQuery = $('#placeQuery').value.trim();

    const data = {
      name, lat, lng, people, amount, rating, note, placeQuery,
      when, dateStr, timeStr,
      userId: currentUser.uid,
      userName: userProfile?.name || currentUser.email,
      createdAt: serverTimestamp(), updatedAt: serverTimestamp()
    };
    await addDoc(collection(db,'trips', currentTrip.id, 'entries'), data);
    toast('ƒê√£ th√™m v√†o l·ªãch s·ª≠.');
    // clear quick fields
    $('#placeName').value=''; $('#placeQuery').value=''; $('#note').value=''; $('#totalCost').value='';
  });

  // Watch entries (history)
  let entries = [];
  function watchEntries(){
    if(!currentTrip) return;
    const qEntries = query(collection(db,'trips', currentTrip.id, 'entries'), orderBy('createdAt','desc'));
    onSnapshot(qEntries, snap=>{
      entries = [];
      snap.forEach(d=> entries.push({ id:d.id, ...d.data() }));
      renderHistory();
      updateStats();
    });
  }
  function renderHistory(){
    // filter & sort
    const q = $('#searchHistory').value?.toLowerCase().trim() || '';
    let arr = entries.filter(e => (e.name||'').toLowerCase().includes(q) || (e.placeQuery||'').toLowerCase().includes(q));
    const sort = $('#sortHistory').value;
    arr.sort((a,b)=>{
      if(sort==='time_desc') return new Date(b.when)-new Date(a.when);
      if(sort==='time_asc') return new Date(a.when)-new Date(b.when);
      if(sort==='name_asc') return (a.name||'').localeCompare(b.name||'');
      if(sort==='name_desc') return (b.name||'').localeCompare(a.name||'');
      if(sort==='cost_desc') return (b.amount||0)-(a.amount||0);
      if(sort==='cost_asc') return (a.amount||0)-(b.amount||0);
      return 0;
    });
    const box = $('#historyList'); box.innerHTML='';
    if(arr.length===0){ box.innerHTML = `<div class="item"><div class="left"><b>Ch∆∞a c√≥ d·ªØ li·ªáu</b></div></div>`; return; }
    for(const e of arr){
      const el = document.createElement('div');
      el.className='item';
      const money = (e.amount||0).toString().replace(/\B(?=(\d{3})+(?!\d))/g,'.');
      const dt = humanDate(e.when);
      const stars = '‚≠ê'.repeat(Math.max(0, Math.min(5, Number(e.rating||0))));
      el.innerHTML = `
        <div class="left">
          <b>${e.name}</b>
          <span class="muted">${dt} ‚Ä¢ ${e.people||1} ng∆∞·ªùi ‚Ä¢ ${money || 0} ƒë ‚Ä¢ ${stars}</span>
          <span class="muted">Ng∆∞·ªùi th√™m: ${e.userName || e.userId}</span>
          ${e.note?`<span class="muted">Ghi ch√∫: ${e.note}</span>`:''}
        </div>
        <div class="right">
          <button class="btn" data-copy="${e.id}"><i class="ph ph-copy"></i></button>
          <button class="btn" data-edit="${e.id}"><i class="ph ph-pencil"></i></button>
          <button class="btn danger" data-del="${e.id}"><i class="ph ph-trash"></i></button>
        </div>`;
      box.appendChild(el);
      el.querySelector('[data-copy]')?.addEventListener('click', ()=> {
        copy(`${e.name} | ${dt} | ${e.people||1} ng∆∞·ªùi | ${money} ƒë | ${e.rating||0}‚≠ê | ${e.note||''}`);
      });
      el.querySelector('[data-edit]')?.addEventListener('click', async ()=>{
        const name = prompt('T√™n ƒë·ªãa ƒëi·ªÉm', e.name) ?? e.name;
        const amount = Number(prompt('T·ªïng ti·ªÅn (s·ªë)', e.amount||0))||e.amount||0;
        const note = prompt('Ghi ch√∫', e.note||'') ?? e.note||'';
        await updateDoc(doc(db,'trips', currentTrip.id, 'entries', e.id), { name, amount, note, updatedAt: serverTimestamp() });
      });
      el.querySelector('[data-del]')?.addEventListener('click', async ()=>{
        if(!confirm('Xo√° m·ª•c n√†y?')) return;
        await deleteDoc(doc(db,'trips', currentTrip.id, 'entries', e.id));
      });
    }
  }
  $('#searchHistory').addEventListener('input', renderHistory);
  $('#sortHistory').addEventListener('change', renderHistory);

  // Exports
  function buildPlainText(){
    return entries.map(e=>{
      const money = (e.amount||0).toString().replace(/\B(?=(\d{3})+(?!\d))/g,'.');
      return `${e.name} | ${humanDate(e.when)} | ${e.people||1} ng∆∞·ªùi | ${money} ƒë | ${e.rating||0}‚≠ê | ${e.note||''} | ${e.userName||e.userId}`;
    }).join('\n');
  }
  $('#btnCopyPlain').addEventListener('click', ()=> copy(buildPlainText()));
  $('#btnExportTxt').addEventListener('click', ()=>{
    const blob = new Blob([buildPlainText()], {type:'text/plain;charset=utf-8'});
    const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = 'lich_su.txt'; a.click();
  });
  $('#btnExportJson').addEventListener('click', ()=>{
    const blob = new Blob([JSON.stringify(entries, null, 2)], {type:'application/json'});
    const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = 'lich_su.json'; a.click();
  });
  $('#btnExportXlsx').addEventListener('click', ()=>{
    const data = entries.map(e=> ({
      Ten: e.name,
      Thoi_gian: humanDate(e.when),
      So_nguoi: e.people||1,
      Tong_tien: e.amount||0,
      Danh_gia: e.rating||0,
      Ghi_chu: e.note||'',
      Nguoi_them: e.userName||e.userId,
      Lat: e.lat||'',
      Lng: e.lng||'',
    }));
    const ws = XLSX.utils.json_to_sheet(data);
    const wb = XLSX.utils.book_new();
    XLSX.utils.book_append_sheet(wb, ws, "Lich su");
    XLSX.writeFile(wb, "lich_su.xlsx");
  });

  // ---- Chat
  $('#btnSendChat').addEventListener('click', async ()=>{
    const text = $('#chatInput').value.trim();
    if(!text) return;
    await addDoc(collection(db,'trips', currentTrip.id, 'messages'), {
      text,
      userId: currentUser.uid,
      userName: userProfile?.name || currentUser.email,
      createdAt: serverTimestamp()
    });
    $('#chatInput').value='';
  });
  function watchChat(){
    const qChat = query(collection(db,'trips', currentTrip.id, 'messages'), orderBy('createdAt','desc'));
    onSnapshot(qChat, snap=>{
      const arr = [];
      snap.forEach(d=> arr.push({id:d.id, ...d.data()}));
      renderChat(arr.reverse());
    });
  }
  function renderChat(arr){
    const box = $('#chatList'); box.innerHTML = '';
    for(const m of arr){
      const hasAt = (m.text||'').includes('@');
      const el = document.createElement('div');
      el.className='item';
      const time = m.createdAt?.toDate ? humanDate(m.createdAt.toDate()) : '';
      el.innerHTML = `
        <div class="left">
          <b>${m.userName||m.userId}</b>
          <span>${m.text}</span>
          <span class="muted">${time}</span>
        </div>
        <div class="right">
          ${hasAt ? '<button class="btn" data-copy="@"><i class="ph ph-copy"></i>Sao ch√©p</button>':''}
        </div>`;
      box.appendChild(el);
      if(hasAt){
        el.querySelector('[data-copy]')?.addEventListener('click', ()=>{
          // l·∫•y ph·∫ßn sau k√Ω t·ª± @ ƒë·∫ßu ti√™n: "@abc xyz" => "abc xyz" hay ch·ªâ "abc"? Y√™u c·∫ßu v√≠ d·ª• @abc -> abc
          const idx = m.text.indexOf('@');
          const sliced = m.text.slice(idx+1).trim();
          copy(sliced);
        });
      }
    }
    box.scrollTop = box.scrollHeight;
  }

  // ---- Stats
  function updateStats(){
    const totalPlaces = entries.length;
    const totalMoney = entries.reduce((s,e)=> s + (e.amount||0), 0);
    const people = currentTrip?.people || 1;
    const per = Math.round(totalMoney / Math.max(1, people));
    const avgRating = entries.length ? (entries.reduce((s,e)=> s+(Number(e.rating||0)),0) / entries.length) : 0;

    $('#statPlaces').textContent = totalPlaces;
    $('#statTotal').textContent = (totalMoney||0).toString().replace(/\B(?=(\d{3})+(?!\d))/g,'.');
    $('#statPerPerson').textContent = (per||0).toString().replace(/\B(?=(\d{3})+(?!\d))/g,'.');
    $('#statRating').textContent = avgRating.toFixed(2);
  }

  // ---- Luggage (todo)
  let luggage = []; // local per-user; c√≥ th·ªÉ l∆∞u theo user trong Firestore
  async function loadLuggage(){
    // th·ª≠ l·∫•y t·ª´ localStorage (MVP). C√≥ th·ªÉ m·ªü r·ªông Firestore: collection users/<uid>/luggage
    try{
      luggage = JSON.parse(localStorage.getItem('lug:'+currentUser.uid) || '[]');
    }catch(e){ luggage=[]; }
    renderLuggage();
  }
  function saveLuggage(){ localStorage.setItem('lug:'+currentUser.uid, JSON.stringify(luggage)); }
  function renderLuggage(){
    const box = $('#luggageList'); box.innerHTML='';
    if(luggage.length===0){ box.innerHTML = `<div class="item"><div class="left"><b>Tr·ªëng</b><span class="muted">Th√™m v√†i m√≥n ƒë·ªì nh√©.</span></div></div>`; return; }
    luggage.forEach((it, idx)=>{
      const el = document.createElement('div'); el.className='item';
      el.innerHTML = `
        <div class="left"><b>${it.name}</b><span class="muted">SL: ${it.qty} ‚Ä¢ ${it.note||''}</span></div>
        <div class="right">
          <button class="btn" data-edit="${idx}"><i class="ph ph-pencil"></i></button>
          <button class="btn danger" data-del="${idx}"><i class="ph ph-trash"></i></button>
        </div>`;
      box.appendChild(el);
      el.querySelector('[data-edit]').addEventListener('click', ()=>{
        const name = prompt('T√™n', it.name) ?? it.name;
        const qty = Number(prompt('SL', it.qty)||it.qty)||it.qty;
        const note = prompt('Ghi ch√∫', it.note||'') ?? it.note||'';
        luggage[idx] = { name, qty, note };
        saveLuggage(); renderLuggage();
      });
      el.querySelector('[data-del]').addEventListener('click', ()=>{
        luggage.splice(idx,1); saveLuggage(); renderLuggage();
      });
    });
  }
  $('#btnAddLug').addEventListener('click', ()=>{
    const name = $('#lugName').value.trim(); if(!name) return;
    const qty = Math.max(1, Number($('#lugQty').value||1));
    const note = $('#lugNote').value.trim();
    luggage.push({ name, qty, note });
    $('#lugName').value=''; $('#lugQty').value='1'; $('#lugNote').value='';
    saveLuggage(); renderLuggage();
  });
  $('#btnCopyLug').addEventListener('click', ()=>{
    const t = luggage.map(x=> `‚Ä¢ ${x.name} x${x.qty}${x.note?` (${x.note})`:''}`).join('\n');
    copy(t || 'Danh s√°ch tr·ªëng');
  });

  // ---- Templates (Firestore per user)
  async function loadTemplates(){
    const tplSel = $('#templateSelect');
    tplSel.innerHTML = '';
    // default suggestions
    const defaults = [
      {id:'tpl-default-1', name:'C∆° b·∫£n 3N2ƒê', items:[
        {name:'√Åo',qty:3},{name:'Qu·∫ßn',qty:2},{name:'ƒê·ªì l√≥t',qty:3},{name:'B√†n ch·∫£i',qty:1},
        {name:'Kem ƒë√°nh rƒÉng',qty:1},{name:'S·∫°c ƒëi·ªán tho·∫°i',qty:1},{name:'S·∫°c d·ª± ph√≤ng',qty:1}
      ]},
      {id:'tpl-beach', name:'Bi·ªÉn', items:[
        {name:'Kem ch·ªëng n·∫Øng',qty:1},{name:'K√≠nh r√¢m',qty:1},{name:'ƒê·ªì b∆°i',qty:1},{name:'KhƒÉn t·∫Øm',qty:1}
      ]},
    ];
    defaults.forEach(d=>{
      const opt = document.createElement('option'); opt.value = JSON.stringify(d.items); opt.textContent = `üåü ${d.name}`;
      tplSel.appendChild(opt);
    });

    // load from Firestore
    if(!currentUser) return;
    const qTpl = query(collection(db,'users', currentUser.uid, 'templates'));
    onSnapshot(qTpl, snap=>{
      // remove previous user templates
      $$('#templateSelect option.user-tpl').forEach(o=>o.remove());
      snap.forEach(d=>{
        const opt = document.createElement('option'); opt.className='user-tpl';
        opt.value = JSON.stringify(d.data().items||[]); opt.textContent = `üóÇ ${d.data().name}`;
        opt.setAttribute('data-id', d.id);
        $('#templateSelect').appendChild(opt);
      });
    });
  }

  $('#btnApplyTpl').addEventListener('click', ()=>{
    try{
      const items = JSON.parse($('#templateSelect').value || '[]');
      items.forEach(x=> luggage.push({ name:x.name, qty:x.qty||1, note:x.note||'' }));
      saveLuggage(); renderLuggage();
      toast('ƒê√£ √°p d·ª•ng m·∫´u.');
    }catch(e){ toast('Kh√¥ng th·ªÉ √°p d·ª•ng m·∫´u.'); }
  });
  $('#btnSaveTpl').addEventListener('click', async ()=>{
    const name = $('#tplName').value.trim(); if(!name) return toast('Nh·∫≠p t√™n m·∫´u.');
    await addDoc(collection(db,'users', currentUser.uid, 'templates'), { name, items: luggage, createdAt: serverTimestamp() });
    $('#tplName').value=''; toast('ƒê√£ l∆∞u m·∫´u.');
  });
  $('#btnDeleteTpl').addEventListener('click', async ()=>{
    const sel = $('#templateSelect').selectedOptions[0];
    const id = sel?.getAttribute('data-id');
    if(!id) return toast('Ch·ªçn m·∫´u ng∆∞·ªùi d√πng ƒë·ªÉ xo√°.');
    if(!confirm('Xo√° m·∫´u n√†y?')) return;
    await deleteDoc(doc(db,'users', currentUser.uid, 'templates', id));
    toast('ƒê√£ xo√° m·∫´u.');
  });

  // ---- Settings: profile + change password
  $('#btnSaveProfile').addEventListener('click', async ()=>{
    const name = $('#profileName').value.trim();
    let avatar = $('#profileAvatar').value.trim() || 'üôÇ';
    // If avatar is numeric UID, store a graph URL reference (will render externally in future)
    if(/^\d{8,}$/.test(avatar)) avatar = `fbuid:${avatar}`;
    await setDoc(doc(db,'users', currentUser.uid), { ...userProfile, name, avatar, updatedAt: serverTimestamp() }, { merge:true });
    userProfile = { ...userProfile, name, avatar };
    $('#currentUserName').textContent = userProfile?.name || currentUser.email;
    toast('ƒê√£ l∆∞u h·ªì s∆°.');
  });

  $('#btnChangePassword').addEventListener('click', async ()=>{
    try{
      await sendPasswordResetEmail(auth, currentUser.email);
      toast('ƒê√£ g·ª≠i email ƒë·ªïi m·∫≠t kh·∫©u.');
    }catch(e){ toast('L·ªói: '+e.message); }
  });

  // ---- Deep UI polish: prefill profile fields
  async function hydrateSettings(){
    $('#profileName').value = userProfile?.name || '';
    $('#profileAvatar').value = (userProfile?.avatar||'üôÇ').replace(/^fbuid:/,'');
    $('#themeMode').value = localStorage.getItem('themeMode') || 'system';
  }
  // show settings when tab opens
  document.querySelector('[data-tab="settings"]').addEventListener('click', hydrateSettings);

  // ---- Trip detail buttons require currentTrip
  $('#searchHistory').value = '';
  $('#sortHistory').value = 'time_desc';

</script>
</body>
</html>
