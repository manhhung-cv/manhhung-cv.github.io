<!DOCTYPE html>
<html lang="vi">
<head>
      <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">

    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="mobile-web-app-capable" content="yes">
    <link rel="icon" href="/Asset/logo/logo.png" />
    <link rel="apple-touch-icon" href="/Asset/logo/iconApps.png" sizes="150x150" />

    <meta property="og:image" content="/Asset/Banner/Banner.png" />
    <meta property="og:title" content="Hunq" />
    <meta property="og:description" content="Thi·∫øt k·∫ø v√† l·∫≠p tr√¨nh ƒêinh M·∫°nh H√πng" />
    <title>R√∫t L√¨ X√¨ T·∫øt B√≠nh Ng·ªç 2026 - Phi√™n b·∫£n Pro</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <link href="https://fonts.googleapis.com/css2?family=Dancing+Script:wght@700&family=Playfair+Display:wght@700&family=Roboto:wght@400;500&display=swap" rel="stylesheet">

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'tet-red': '#D00000',
                        'tet-dark-red': '#8B0000',
                        'tet-gold': '#FFD700',
                        'tet-bg': '#FFF5E6',
                    },
                    fontFamily: {
                        'hand': ['"Dancing Script"', 'cursive'],
                        'title': ['"Playfair Display"', 'serif'],
                        'body': ['"Roboto"', 'sans-serif'],
                    },
                    animation: {
                        'float': 'float 3s ease-in-out infinite',
                        'fade-in': 'fadeIn 0.5s ease-out',
                    },
                    keyframes: {
                        float: {
                            '0%, 100%': { transform: 'translateY(0)' },
                            '50%': { transform: 'translateY(-10px)' },
                        },
                        fadeIn: {
                            '0%': { opacity: '0' },
                            '100%': { opacity: '1' }
                        }
                    }
                }
            }
        }
    </script>

    <style>
        body {
            background-color: #8B0000;
            background-image: radial-gradient(#9c0404 15%, transparent 16%), radial-gradient(#9c0404 15%, transparent 16%);
            background-size: 60px 60px;
            background-position: 0 0, 30px 30px;
            overflow-x: hidden;
            -webkit-tap-highlight-color: transparent;
        }
        
        /* --- REALISTIC ENVELOPE STYLES --- */
        .red-envelope {
            position: relative;
            width: 100%;
            height: 160px;
            background: #D00000;
            border-radius: 0 0 10px 10px;
            box-shadow: 0 10px 20px rgba(0,0,0,0.3);
            cursor: pointer;
            overflow: visible;
            transition: transform 0.3s;
            perspective: 1000px;
        }

        .red-envelope:hover {
            transform: translateY(-5px);
        }

        .envelope-flap {
            position: absolute;
            top: 0; left: 0; width: 100%; height: 50px;
            background: #B00000;
            border-radius: 0 0 50% 50%;
            transform-origin: top;
            transition: transform 0.6s cubic-bezier(0.4, 0, 0.2, 1), z-index 0.6s step-end;
            z-index: 20;
            border-top: 2px solid #FFD700;
        }

        .envelope-pocket {
            position: absolute; bottom: 0; left: 0; width: 100%; height: 100%;
            border-radius: 0 0 10px 10px;
            z-index: 10;
            display: flex; align-items: center; justify-content: center; flex-direction: column;
            border: 2px solid #FFD700; border-top: none;
            overflow: hidden;
        }

        /* Decorations */
        .deco-circle {
            width: 70px; height: 70px; border: 2px solid #FFD700; border-radius: 50%;
            display: flex; align-items: center; justify-content: center;
            background: #8B0000; box-shadow: 0 4px 15px rgba(0,0,0,0.3);
            position: relative; z-index: 2;
        }
        .deco-square {
            width: 60px; height: 60px; border: 2px solid #FFD700; transform: rotate(45deg);
            display: flex; align-items: center; justify-content: center;
            background: #900000; box-shadow: 0 4px 15px rgba(0,0,0,0.3);
            position: relative; z-index: 2;
        }
        .deco-square-inner { transform: rotate(-45deg); }
        .deco-icon-lg {
            font-size: 3.5rem; color: rgba(255, 215, 0, 0.2);
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
            z-index: 1;
        }

        /* Money Card */
        .money-card {
            position: absolute; left: 5%; width: 90%; height: 90%;
            background: linear-gradient(135deg, #e0f7fa 0%, #80deea 100%); 
            border: 1px solid #4dd0e1; border-radius: 4px; bottom: 0;
            z-index: 5;
            transition: transform 0.8s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            transform: translateY(0);
            display: flex; flex-direction: column; align-items: center; justify-content: flex-start;
            padding-top: 15px;
            font-family: 'Playfair Display', serif; color: #006064; font-weight: bold;
            box-shadow: 0 -2px 5px rgba(0,0,0,0.1);
        }
        .money-border {
            position: absolute; top: 4px; left: 4px; right: 4px; bottom: 4px;
            border: 1px dashed #0097a7; border-radius: 2px; pointer-events: none;
        }
        .money-value {
            font-size: 1.5rem; font-weight: 900; background: #fff;
            padding: 2px 8px; border-radius: 10px; box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            color: #d32f2f;
        }
        .money-label { font-size: 0.6rem; text-transform: uppercase; margin-top: 4px; letter-spacing: 1px; }
        .money-center-img { margin-top: auto; margin-bottom: 10px; opacity: 0.2; font-size: 2rem; }

        /* Animation States */
        .red-envelope.open .envelope-flap { transform: rotateX(180deg); z-index: 1; background: #800000; }
        .red-envelope.open .money-card { transform: translateY(-80%); transition-delay: 0.2s; }

        /* Utilities */
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #550000; }
        ::-webkit-scrollbar-thumb { background: #FFD700; border-radius: 4px; }
        .glass-panel {
            background: rgba(255, 255, 255, 0.1); backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px); border: 1px solid rgba(255, 215, 0, 0.3);
        }
        .bg-pattern {
            background-image: url("data:image/svg+xml,%3Csvg width='20' height='20' viewBox='0 0 20 20' xmlns='http://www.w3.org/2000/svg'%3E%3Cpath d='M1 1h2v2H1V1zm4 4h2v2H5V5zm4 4h2v2H9V9zm4 4h2v2h-2v-2zm4 4h2v2h-2v-2z' fill='%23FFD700' fill-opacity='0.1' fill-rule='evenodd'/%3E%3C/svg%3E");
        }
        
        /* Avatar Selection */
        .avatar-select { transition: all 0.3s; }
        .avatar-select:hover { transform: scale(1.05); border-color: #FFD700; }
        .avatar-select.selected { border-color: #FFD700; box-shadow: 0 0 15px #FFD700; transform: scale(1.05); }
    </style>
</head>
<body class="font-body text-white min-h-screen flex flex-col">

    <header class="p-4 text-center relative z-10">
        <h1 class="font-title text-4xl md:text-6xl text-tet-gold drop-shadow-md animate-float">
            T·∫øt B√≠nh Ng·ªç 2026
        </h1>
        <p class="font-hand text-xl md:text-2xl mt-2 text-white/90">V·∫°n S·ª± Nh∆∞ √ù - T·∫•n T√†i T·∫•n L·ªôc</p>
        <button id="adminBtn" class="absolute top-4 right-4 text-white/50 hover:text-tet-gold transition">
            <i class="fa-solid fa-gear"></i>
        </button>
    </header>

    <main class="flex-grow container mx-auto px-4 py-6 relative z-10 pt-32">
        
        <div id="view-groups" class="flex flex-col items-center justify-center h-[60vh] animate-fade-in hidden">
            <div class="w-full max-w-4xl glass-panel p-8 rounded-2xl shadow-2xl text-center border-2 border-tet-gold/50 bg-pattern">
                <h2 class="text-2xl font-bold mb-8 text-tet-gold uppercase">B·∫°n thu·ªôc nh√≥m n√†o?</h2>
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4" id="groupList">
                    </div>
            </div>
        </div>

        <div id="view-users" class="flex flex-col items-center justify-center min-h-[60vh] animate-fade-in hidden">
            <div class="w-full max-w-4xl glass-panel p-6 rounded-2xl shadow-2xl border-2 border-tet-gold/50 bg-pattern">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-xl font-bold text-tet-gold">Ai ƒëang r√∫t l√¨ x√¨?</h2>
                    <button onclick="app.switchView('view-groups')" class="text-sm bg-white/10 px-3 py-1 rounded hover:bg-white/20">
                        <i class="fa-solid fa-arrow-left"></i> Ch·ªçn l·∫°i nh√≥m
                    </button>
                </div>
                
                <div class="grid grid-cols-2 md:grid-cols-4 lg:grid-cols-5 gap-4 max-h-[60vh] overflow-y-auto p-2" id="userGrid">
                    </div>
            </div>
        </div>

        <div id="view-game" class="hidden">
            <div class="flex justify-between items-center mb-6 bg-black/20 p-3 rounded-lg backdrop-blur-sm">
                <div class="flex items-center gap-3">
                    <img id="currentPlayerAvatar" src="" class="w-10 h-10 rounded-full border-2 border-tet-gold object-cover">
                    <div class="text-lg">
                        Ch√†o, <span id="displayUserName" class="font-bold text-tet-gold font-hand text-2xl">User</span>!
                    </div>
                </div>
                <div class="text-sm text-white/80">
                    <i class="fa-solid fa-house-chimney-user text-tet-gold mr-1"></i> Nh√≥m: <span id="displayGroupName" class="font-bold">Gia ƒë√¨nh</span>
                </div>
            </div>

            <div id="alreadyPlayedMsg" class="hidden flex flex-col items-center justify-center h-64 text-center animate-fade-in">
                <div class="text-6xl text-gray-400 mb-4"><i class="fa-solid fa-check-circle"></i></div>
                <h3 class="text-2xl font-bold text-tet-gold">B·∫°n ƒë√£ nh·∫≠n l√¨ x√¨ r·ªìi!</h3>
                <p class="mt-2 text-white/80">S·ªë ti·ªÅn b·∫°n nh·∫≠n ƒë∆∞·ª£c l√†: <span id="pastPrizeAmount" class="font-bold text-xl text-green-400">0ƒë</span></p>
                <button onclick="app.logout()" class="mt-6 bg-red-800 hover:bg-red-700 px-6 py-2 rounded-full border border-red-500">
                    Tho√°t
                </button>
            </div>

            <div id="envelopeGrid" class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-10 gap-y-24 pb-24 pt-10">
                </div>
        </div>

        <div id="view-admin" class="hidden">
            <div class="glass-panel p-6 rounded-xl max-w-6xl mx-auto">
                <div class="flex justify-between items-center mb-6 border-b border-white/20 pb-4">
                    <h2 class="text-2xl font-bold text-tet-gold">Admin Dashboard</h2>
                    <button onclick="app.init()" class="text-sm bg-white/10 hover:bg-white/20 px-3 py-1 rounded">
                        <i class="fa-solid fa-arrow-left"></i> Quay l·∫°i game
                    </button>
                </div>

                <div class="flex flex-wrap gap-2 md:gap-4 mb-6 border-b border-white/10">
                    <button onclick="admin.switchTab('groups')" id="tab-groups" class="px-4 py-2 text-white/60 hover:text-white">Qu·∫£n l√Ω Nh√≥m</button>
                    <button onclick="admin.switchTab('users')" id="tab-users" class="px-4 py-2 text-tet-gold border-b-2 border-tet-gold font-bold">Th√†nh vi√™n</button>
                    <button onclick="admin.switchTab('prizes')" id="tab-prizes" class="px-4 py-2 text-white/60 hover:text-white">Gi·∫£i th∆∞·ªüng</button>
                    <button onclick="admin.switchTab('stats')" id="tab-stats" class="px-4 py-2 text-white/60 hover:text-white">Th·ªëng k√™</button>
                </div>

                <div id="admin-groups" class="hidden grid md:grid-cols-3 gap-6">
                    <div class="md:col-span-1 bg-black/20 p-4 rounded-lg h-fit">
                        <h3 class="font-bold mb-4 text-tet-gold" id="groupFormTitle">Th√™m Nh√≥m M·ªõi</h3>
                        <div class="space-y-3">
                            <input type="hidden" id="groupId"> <input type="text" id="newGroupName" placeholder="T√™n nh√≥m (Vd: B·∫°n b√®)" class="w-full p-2 rounded text-black text-sm">
                            <input type="text" id="newGroupIcon" placeholder="Icon Class (vd: fa-solid fa-users)" class="w-full p-2 rounded text-black text-sm" value="fa-solid fa-house-chimney-user">
                            
                            <div class="flex gap-2">
                                <button onclick="admin.saveGroup()" id="btnSaveGroup" class="flex-1 bg-green-600 hover:bg-green-500 py-2 rounded font-bold text-sm">L∆∞u</button>
                                <button onclick="admin.resetGroupForm()" id="btnCancelGroup" class="hidden flex-1 bg-gray-500 hover:bg-gray-400 py-2 rounded font-bold text-sm">H·ªßy</button>
                            </div>
                        </div>
                        <p class="text-xs text-white/50 mt-2 italic">D√πng font-awesome cho icon class.</p>
                    </div>
                    <div class="md:col-span-2 bg-white/90 rounded-lg overflow-hidden text-gray-800 max-h-[60vh] overflow-y-auto">
                        <table class="w-full text-sm">
                            <thead class="bg-gray-200 sticky top-0">
                                <tr>
                                    <th class="p-2 text-center w-12">Icon</th>
                                    <th class="p-2 text-left">T√™n Nh√≥m</th>
                                    <th class="p-2 text-center w-24">Thao t√°c</th>
                                </tr>
                            </thead>
                            <tbody id="adminGroupList"></tbody>
                        </table>
                    </div>
                </div>

                <div id="admin-users" class="grid md:grid-cols-3 gap-6">
                    <div class="md:col-span-1 bg-black/20 p-4 rounded-lg h-fit">
                        <h3 class="font-bold mb-4 text-tet-gold" id="userFormTitle">Th√™m Th√†nh Vi√™n</h3>
                        <div class="space-y-3">
                            <input type="hidden" id="userId"> <input type="text" id="newUserName" placeholder="T√™n hi·ªÉn th·ªã" class="w-full p-2 rounded text-black text-sm">
                            <input type="text" id="newUserAvatar" placeholder="Link Avatar (ho·∫∑c ƒë·ªÉ tr·ªëng)" class="w-full p-2 rounded text-black text-sm">
                            <select id="newUserGroup" class="w-full p-2 rounded text-black text-sm">
                                </select>
                            
                            <div class="flex gap-2">
                                <button onclick="admin.saveUser()" id="btnSaveUser" class="flex-1 bg-green-600 hover:bg-green-500 py-2 rounded font-bold text-sm">Th√™m Ng∆∞·ªùi</button>
                                <button onclick="admin.resetUserForm()" id="btnCancelUser" class="hidden flex-1 bg-gray-500 hover:bg-gray-400 py-2 rounded font-bold text-sm">H·ªßy</button>
                            </div>
                        </div>
                    </div>
                    <div class="md:col-span-2 bg-white/90 rounded-lg overflow-hidden text-gray-800 max-h-[60vh] overflow-y-auto">
                        <table class="w-full text-sm">
                            <thead class="bg-gray-200 sticky top-0">
                                <tr>
                                    <th class="p-2 text-left">Avatar</th>
                                    <th class="p-2 text-left">T√™n</th>
                                    <th class="p-2 text-center">Nh√≥m</th>
                                    <th class="p-2 text-center">Tr·∫°ng th√°i</th>
                                    <th class="p-2 text-center w-24">Thao t√°c</th>
                                </tr>
                            </thead>
                            <tbody id="adminUserList"></tbody>
                        </table>
                    </div>
                </div>

                <div id="admin-prizes" class="hidden grid md:grid-cols-3 gap-6">
                    <div class="md:col-span-1 bg-black/20 p-4 rounded-lg h-fit">
                        <h3 class="font-bold mb-4 text-tet-gold">Th√™m Gi·∫£i Th∆∞·ªüng</h3>
                        <div class="space-y-3">
                            <select id="newPrizeGroup" class="w-full p-2 rounded text-black text-sm font-bold">
                                <option value="all">-- Ch·ªçn Nh√≥m --</option>
                                </select>
                            <input type="number" id="newPrizeAmount" placeholder="S·ªë ti·ªÅn (VNƒê)" class="w-full p-2 rounded text-black text-sm">
                            <input type="number" id="newPrizeQuantity" placeholder="S·ªë l∆∞·ª£ng" class="w-full p-2 rounded text-black text-sm">
                            <button onclick="admin.addPrize()" class="w-full bg-blue-600 hover:bg-blue-500 py-2 rounded font-bold">Th√™m Gi·∫£i</button>
                        </div>
                        <p class="text-xs text-white/60 mt-2 italic">* Gi·∫£i th∆∞·ªüng ch·ªâ √°p d·ª•ng cho nh√≥m ƒë√£ ch·ªçn.</p>
                    </div>
                    <div class="md:col-span-2 bg-white/90 rounded-lg overflow-hidden text-gray-800 max-h-[60vh] overflow-y-auto">
                        <table class="w-full text-sm">
                            <thead class="bg-gray-200 sticky top-0">
                                <tr>
                                    <th class="p-2 text-left">Nh√≥m</th>
                                    <th class="p-2 text-right">M·ªánh gi√°</th>
                                    <th class="p-2 text-center">SL</th>
                                    <th class="p-2 text-center">X√≥a</th>
                                </tr>
                            </thead>
                            <tbody id="adminPrizeList"></tbody>
                        </table>
                    </div>
                </div>

                <div id="admin-stats" class="hidden">
                    <div class="bg-black/20 p-4 rounded-lg mb-6 flex justify-between">
                         <button onclick="admin.resetAllData()" class="bg-red-600 hover:bg-red-700 px-4 py-2 rounded font-bold border border-red-400 shadow-lg text-xs">
                            <i class="fa-solid fa-bomb"></i> Reset To√†n B·ªô D·ªØ Li·ªáu
                        </button>
                        <button onclick="admin.resetPlayStatus()" class="bg-yellow-600 hover:bg-yellow-700 px-4 py-2 rounded font-bold border border-yellow-400 shadow-lg text-xs">
                            <i class="fa-solid fa-refresh"></i> Reset L∆∞·ª£t Ch∆°i (Gi·ªØ Users)
                        </button>
                    </div>
                    <h3 class="font-bold mb-4">L·ªãch s·ª≠ tr√∫ng gi·∫£i g·∫ßn nh·∫•t</h3>
                    <div class="bg-white/90 text-gray-800 h-96 overflow-y-auto rounded-lg p-2 text-sm" id="adminHistoryLog"></div>
                </div>
            </div>
        </div>

    </main>

    <div id="customModal" class="fixed inset-0 z-[100] flex items-center justify-center bg-black/80 backdrop-blur-sm hidden opacity-0 transition-opacity duration-300">
        <div class="bg-tet-bg text-tet-red p-1 rounded-2xl max-w-sm w-full mx-4 transform scale-90 transition-transform duration-300" id="customModalCard">
            <div class="border-4 border-tet-gold rounded-xl p-6 text-center relative overflow-hidden bg-pattern">
                <div id="customModalIcon" class="mb-2 text-4xl text-tet-gold animate-bounce hidden">
                    <i class="fa-solid fa-bell"></i>
                </div>

                <h3 id="customModalTitle" class="font-hand text-3xl font-bold mb-3 text-tet-gold">Th√¥ng b√°o</h3>
                <p id="customModalMessage" class="text-gray-800 font-medium mb-6">N·ªôi dung th√¥ng b√°o...</p>
                
                <div id="customModalInputContainer" class="hidden mb-4">
                    <input type="password" id="customModalInput" class="w-full p-3 border-2 border-tet-gold/50 rounded-lg text-center bg-white text-lg outline-none focus:border-tet-gold transition-colors" placeholder="Nh·∫≠p m·∫≠t kh·∫©u...">
                </div>

                <div class="flex gap-3 justify-center" id="customModalButtons">
                    </div>
            </div>
        </div>
    </div>

    <div id="resultModal" class="fixed inset-0 z-50 flex items-center justify-center bg-black/80 backdrop-blur-sm hidden opacity-0 transition-opacity duration-300">
        <div class="bg-tet-bg text-tet-red p-1 rounded-2xl max-w-sm w-full mx-4 transform scale-90 transition-transform duration-300" id="resultCard">
            <div class="border-4 border-tet-gold rounded-xl p-6 text-center relative overflow-hidden bg-pattern">
                <div class="mb-4 animate-bounce text-6xl text-tet-gold">
                    <i class="fa-solid fa-sack-dollar"></i>
                </div>
                
                <h3 class="font-hand text-3xl font-bold mb-2">Ch√∫c M·ª´ng!</h3>
                <p class="text-gray-600 text-sm mb-4">B·∫°n <span id="resultName" class="font-bold">Name</span> ƒë√£ nh·∫≠n ƒë∆∞·ª£c:</p>
                
                <div class="text-4xl font-black text-tet-dark-red mb-6 drop-shadow-sm font-title">
                    <span id="resultAmount">50.000</span> <span class="text-2xl">VNƒê</span>
                </div>
                
                <button onclick="app.closeModal()" class="w-full bg-tet-red text-white py-3 rounded-lg font-bold hover:bg-red-700 transition shadow-lg">
                    Xin c·∫£m ∆°n!
                </button>
            </div>
        </div>
    </div>

    <script>
        const SUPABASE_CONFIG = {
            url: "https://xxorgubgivfpzekcdnet.supabase.co", 
            key: "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Inh4b3JndWJnaXZmcHpla2NkbmV0Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzExNTM2ODEsImV4cCI6MjA4NjcyOTY4MX0.ySkaovtoCF6-AjJ846DDKJgWieuc3Qr6A7ftfEcWFbQ"
        };

        const DEFAULT_GROUPS_DATA = [
            { id: 1, name: "Gia ƒë√¨nh", icon: "fa-solid fa-house-chimney-user" },
            { id: 2, name: "H·ªç h√†ng", icon: "fa-solid fa-users-line" },
            { id: 3, name: "B·∫°n b√®", icon: "fa-solid fa-user-group" },
            { id: 4, name: "C√¥ng ty", icon: "fa-solid fa-briefcase" }
        ];

        const DEFAULT_USERS = [
            { id: 1, name: "B·ªë", group: "Gia ƒë√¨nh", avatar: "https://api.dicebear.com/7.x/avataaars/svg?seed=Dad", has_played: false, prize: null },
            { id: 2, name: "M·∫π", group: "Gia ƒë√¨nh", avatar: "https://api.dicebear.com/7.x/avataaars/svg?seed=Mom", has_played: false, prize: null }
        ];
        
        const DEFAULT_PRIZES = [
            { id: 1, group: "Gia ƒë√¨nh", amount: 500000, quantity: 2 },
            { id: 2, group: "Gia ƒë√¨nh", amount: 200000, quantity: 5 }
        ];

        class DataManager {
            constructor() {
                this.useSupabase = SUPABASE_CONFIG.url && SUPABASE_CONFIG.key;
                if (this.useSupabase) {
                    this.supabase = window.supabase.createClient(SUPABASE_CONFIG.url, SUPABASE_CONFIG.key);
                }
                
                // Initialize LocalStorage if empty
                if (!localStorage.getItem('lixi_groups')) localStorage.setItem('lixi_groups', JSON.stringify(DEFAULT_GROUPS_DATA));
                if (!localStorage.getItem('lixi_users')) localStorage.setItem('lixi_users', JSON.stringify(DEFAULT_USERS));
                if (!localStorage.getItem('lixi_prizes_v2')) localStorage.setItem('lixi_prizes_v2', JSON.stringify(DEFAULT_PRIZES));
                if (!localStorage.getItem('lixi_history')) localStorage.setItem('lixi_history', JSON.stringify([]));
            }

            async checkAdminPassword(inputPass) {
                if (this.useSupabase) {
                    const { data, error } = await this.supabase.from('lixi_config').select('value').eq('key', 'admin_password').single();
                    if (error || !data) return false;
                    return data.value === inputPass;
                }
                return false; // Local implementation omitted for security simulation
            }

            // --- GROUPS CRUD ---
            async getGroups() {
                if (this.useSupabase) {
                    const { data, error } = await this.supabase.from('lixi_groups').select('*').order('id', { ascending: true });
                    return error ? [] : data;
                }
                return JSON.parse(localStorage.getItem('lixi_groups'));
            }

            async saveGroup(id, name, icon) {
                if (this.useSupabase) {
                    if (id) {
                         await this.supabase.from('lixi_groups').update({ name, icon }).eq('id', id);
                    } else {
                         await this.supabase.from('lixi_groups').insert([{ name, icon }]);
                    }
                } else {
                    let groups = JSON.parse(localStorage.getItem('lixi_groups'));
                    if (id) {
                        const idx = groups.findIndex(g => g.id == id);
                        if (idx !== -1) {
                            groups[idx].name = name;
                            groups[idx].icon = icon;
                        }
                    } else {
                        groups.push({ id: Date.now(), name, icon });
                    }
                    localStorage.setItem('lixi_groups', JSON.stringify(groups));
                }
            }

            async deleteGroup(id) {
                if (this.useSupabase) {
                    await this.supabase.from('lixi_groups').delete().eq('id', id);
                } else {
                    let groups = JSON.parse(localStorage.getItem('lixi_groups')).filter(g => g.id != id);
                    localStorage.setItem('lixi_groups', JSON.stringify(groups));
                }
            }

            // --- USERS CRUD ---
            async getUsers() {
                if (this.useSupabase) {
                    const { data, error } = await this.supabase.from('lixi_users').select('*').order('created_at', { ascending: true });
                    return error ? [] : data;
                }
                return JSON.parse(localStorage.getItem('lixi_users'));
            }

            async getUsersByGroup(groupName) {
                const users = await this.getUsers();
                return users.filter(u => u.group === groupName);
            }

            async saveUser(id, name, avatar, group) {
                const finalAvatar = avatar || `https://api.dicebear.com/7.x/avataaars/svg?seed=${name}`;
                
                if (this.useSupabase) {
                    if (id) {
                        // Update
                        await this.supabase.from('lixi_users').update({ name, avatar: finalAvatar, group }).eq('id', id);
                    } else {
                        // Create
                        await this.supabase.from('lixi_users').insert([{ name, group, avatar: finalAvatar, has_played: false }]);
                    }
                } else {
                    let users = JSON.parse(localStorage.getItem('lixi_users'));
                    if (id) {
                        // Update
                        const idx = users.findIndex(u => u.id == id);
                        if (idx !== -1) {
                            users[idx].name = name;
                            users[idx].avatar = finalAvatar;
                            users[idx].group = group;
                        }
                    } else {
                        // Create
                        users.push({ id: Date.now(), name, group, avatar: finalAvatar, has_played: false, prize: null });
                    }
                    localStorage.setItem('lixi_users', JSON.stringify(users));
                }
            }

            async deleteUser(id) {
                if (this.useSupabase) {
                    await this.supabase.from('lixi_users').delete().eq('id', id);
                } else {
                    let users = JSON.parse(localStorage.getItem('lixi_users')).filter(u => u.id != id);
                    localStorage.setItem('lixi_users', JSON.stringify(users));
                }
            }

            // --- PRIZES & GAMEPLAY ---
            async getPrizes() {
                if (this.useSupabase) {
                    const { data, error } = await this.supabase.from('lixi_prizes').select('*').order('amount', { ascending: false });
                    return error ? [] : data;
                }
                return JSON.parse(localStorage.getItem('lixi_prizes_v2'));
            }

            async getPrizesByGroup(groupName) {
                const prizes = await this.getPrizes();
                return prizes.filter(p => p.group === groupName && p.quantity > 0);
            }

            async addPrize(group, amount, quantity) {
                if (this.useSupabase) {
                    await this.supabase.from('lixi_prizes').insert([{ group, amount: parseInt(amount), quantity: parseInt(quantity) }]);
                } else {
                    const prizes = JSON.parse(localStorage.getItem('lixi_prizes_v2'));
                    prizes.push({ id: Date.now(), group, amount: parseInt(amount), quantity: parseInt(quantity) });
                    localStorage.setItem('lixi_prizes_v2', JSON.stringify(prizes));
                }
            }

            async deletePrize(id) {
                if (this.useSupabase) {
                    await this.supabase.from('lixi_prizes').delete().eq('id', id);
                } else {
                    let prizes = JSON.parse(localStorage.getItem('lixi_prizes_v2')).filter(p => p.id != id);
                    localStorage.setItem('lixi_prizes_v2', JSON.stringify(prizes));
                }
            }

            async recordWin(userId, prizeId, amount, userName, userGroup) {
                if (this.useSupabase) {
                    const { data: prize } = await this.supabase.from('lixi_prizes').select('quantity').eq('id', prizeId).single();
                    if (!prize || prize.quantity <= 0) return false;

                    const { error: pError } = await this.supabase.from('lixi_prizes').update({ quantity: prize.quantity - 1 }).eq('id', prizeId);
                    if (pError) return false;

                    await this.supabase.from('lixi_users').update({ has_played: true, prize: amount }).eq('id', userId);
                    await this.supabase.from('lixi_history').insert([{ user: userName, group: userGroup, amount, time: new Date().toLocaleString() }]);
                    return true;
                } else {
                    let users = JSON.parse(localStorage.getItem('lixi_users'));
                    let prizes = JSON.parse(localStorage.getItem('lixi_prizes_v2'));
                    let history = JSON.parse(localStorage.getItem('lixi_history'));

                    const uIdx = users.findIndex(u => u.id == userId);
                    const pIdx = prizes.findIndex(p => p.id == prizeId);

                    if (uIdx !== -1 && pIdx !== -1 && prizes[pIdx].quantity > 0 && !users[uIdx].has_played) {
                        users[uIdx].has_played = true;
                        users[uIdx].prize = amount;
                        prizes[pIdx].quantity -= 1;
                        history.unshift({ user: userName, group: userGroup, amount, time: new Date().toLocaleString() });

                        localStorage.setItem('lixi_users', JSON.stringify(users));
                        localStorage.setItem('lixi_prizes_v2', JSON.stringify(prizes));
                        localStorage.setItem('lixi_history', JSON.stringify(history));
                        return true;
                    }
                    return false;
                }
            }

            async getHistory() {
                if (this.useSupabase) {
                    const { data, error } = await this.supabase.from('lixi_history').select('*').order('created_at', { ascending: false }).limit(50);
                    return error ? [] : data;
                }
                return JSON.parse(localStorage.getItem('lixi_history'));
            }

            async resetAll() {
                if (this.useSupabase) {
                     return alert("Vui l√≤ng v√†o SQL Editor tr√™n Supabase v√† ch·∫°y TRUNCATE.");
                }
                localStorage.setItem('lixi_groups', JSON.stringify(DEFAULT_GROUPS_DATA));
                localStorage.setItem('lixi_users', JSON.stringify(DEFAULT_USERS));
                localStorage.setItem('lixi_prizes_v2', JSON.stringify(DEFAULT_PRIZES));
                localStorage.setItem('lixi_history', JSON.stringify([]));
            }

            async resetPlayStatus() {
                 if (this.useSupabase) {
                    await this.supabase.from('lixi_users').update({ has_played: false, prize: null }).neq('id', 0);
                 } else {
                    let users = JSON.parse(localStorage.getItem('lixi_users'));
                    users = users.map(u => ({ ...u, has_played: false, prize: null }));
                    localStorage.setItem('lixi_users', JSON.stringify(users));
                 }
            }
        }

        const db = new DataManager();

        const app = {
            currentUser: null,
            modalCallback: null,
            
            init: () => {
                document.getElementById('adminBtn').addEventListener('click', app.checkAdmin);
                app.loadGroups();
                app.switchView('view-groups');
            },

            // --- UTILS ---
            showMessage: (title, message, type = 'info', callback = null) => {
                const modal = document.getElementById('customModal');
                const card = document.getElementById('customModalCard');
                const titleEl = document.getElementById('customModalTitle');
                const msgEl = document.getElementById('customModalMessage');
                const btnContainer = document.getElementById('customModalButtons');
                const inputContainer = document.getElementById('customModalInputContainer');
                const input = document.getElementById('customModalInput');
                const icon = document.getElementById('customModalIcon');

                titleEl.textContent = title;
                msgEl.textContent = message;
                app.modalCallback = callback;
                
                btnContainer.innerHTML = '';
                inputContainer.classList.add('hidden');
                icon.classList.remove('hidden');

                if (type === 'prompt') {
                    inputContainer.classList.remove('hidden');
                    input.value = '';
                    icon.innerHTML = '<i class="fa-solid fa-lock"></i>';
                    
                    const btnOk = document.createElement('button');
                    btnOk.className = "bg-tet-red hover:bg-red-700 text-white font-bold py-2 px-6 rounded-lg shadow transition";
                    btnOk.textContent = "X√°c nh·∫≠n";
                    btnOk.onclick = () => {
                        const val = input.value;
                        app.hideMessage();
                        if (callback) callback(val);
                    };
                    btnContainer.appendChild(btnOk);

                    const btnCancel = document.createElement('button');
                    btnCancel.className = "bg-gray-300 hover:bg-gray-400 text-gray-800 font-bold py-2 px-4 rounded-lg shadow transition";
                    btnCancel.textContent = "H·ªßy";
                    btnCancel.onclick = () => app.hideMessage();
                    btnContainer.appendChild(btnCancel);
                    setTimeout(() => input.focus(), 100);

                } else if (type === 'confirm') {
                    icon.innerHTML = '<i class="fa-solid fa-circle-question"></i>';
                    const btnYes = document.createElement('button');
                    btnYes.className = "bg-tet-red hover:bg-red-700 text-white font-bold py-2 px-6 rounded-lg shadow transition";
                    btnYes.textContent = "ƒê·ªìng √Ω";
                    btnYes.onclick = () => {
                        app.hideMessage();
                        if (callback) callback();
                    };
                    btnContainer.appendChild(btnYes);

                    const btnNo = document.createElement('button');
                    btnNo.className = "bg-gray-300 hover:bg-gray-400 text-gray-800 font-bold py-2 px-4 rounded-lg shadow transition";
                    btnNo.textContent = "Kh√¥ng";
                    btnNo.onclick = () => app.hideMessage();
                    btnContainer.appendChild(btnNo);

                } else {
                    icon.innerHTML = '<i class="fa-solid fa-bell"></i>';
                    const btnOk = document.createElement('button');
                    btnOk.className = "bg-tet-red hover:bg-red-700 text-white font-bold py-2 px-8 rounded-lg shadow transition";
                    btnOk.textContent = "OK";
                    btnOk.onclick = () => {
                        app.hideMessage();
                        if (callback) callback();
                    };
                    btnContainer.appendChild(btnOk);
                }

                modal.classList.remove('hidden');
                void modal.offsetWidth;
                modal.classList.remove('opacity-0');
                card.classList.remove('scale-100');
                card.classList.add('scale-100');
            },

            hideMessage: () => {
                const modal = document.getElementById('customModal');
                const card = document.getElementById('customModalCard');
                modal.classList.add('opacity-0');
                card.classList.remove('scale-100');
                card.classList.add('scale-90');
                setTimeout(() => {
                    modal.classList.add('hidden');
                }, 300);
            },

            switchView: (viewId) => {
                ['view-groups', 'view-users', 'view-game', 'view-admin'].forEach(id => {
                    document.getElementById(id).classList.add('hidden');
                });
                document.getElementById(viewId).classList.remove('hidden');
            },

            // --- VIEW LOGIC ---
            loadGroups: async () => {
                const container = document.getElementById('groupList');
                container.innerHTML = '<div class="col-span-full text-center text-white"><i class="fa-solid fa-spinner fa-spin"></i> ƒêang t·∫£i...</div>';
                
                const groups = await db.getGroups();
                container.innerHTML = '';
                
                if(groups.length === 0) {
                     container.innerHTML = '<div class="col-span-full text-center text-white">Ch∆∞a c√≥ nh√≥m n√†o. Vui l√≤ng v√†o Admin ƒë·ªÉ t·∫°o.</div>';
                     return;
                }

                groups.forEach(group => {
                    const btn = document.createElement('button');
                    btn.className = "bg-red-800/80 hover:bg-red-700 border-2 border-tet-gold/30 hover:border-tet-gold text-white p-6 rounded-xl transition-all transform hover:scale-105 shadow-lg group";
                    btn.innerHTML = `
                        <div class="text-3xl mb-2 group-hover:animate-bounce text-tet-gold"><i class="${group.icon || 'fa-solid fa-users'}"></i></div>
                        <div class="font-bold text-xl uppercase">${group.name}</div>
                    `;
                    btn.onclick = () => app.loadUsers(group.name);
                    container.appendChild(btn);
                });
            },

            loadUsers: async (groupName) => {
                const container = document.getElementById('userGrid');
                container.innerHTML = '<div class="col-span-full text-center text-white"><i class="fa-solid fa-spinner fa-spin"></i> ƒêang t·∫£i danh s√°ch...</div>';
                app.switchView('view-users');

                const users = await db.getUsersByGroup(groupName);
                container.innerHTML = '';

                if (users.length === 0) {
                    container.innerHTML = `<div class="col-span-full text-center py-8 text-white/50">Ch∆∞a c√≥ th√†nh vi√™n n√†o trong nh√≥m n√†y.<br>Vui l√≤ng nh·ªù Admin th√™m t√™n b·∫°n.</div>`;
                    return;
                }

                users.forEach(u => {
                    const div = document.createElement('div');
                    div.className = "bg-white/10 p-4 rounded-xl border border-white/20 hover:bg-white/20 cursor-pointer flex flex-col items-center gap-2 transition-all avatar-select relative";
                    const playedBadge = u.has_played ? `<div class="absolute top-2 right-2 text-green-400 bg-black/50 rounded-full px-2 text-xs"><i class="fa-solid fa-check"></i> ƒê√£ nh·∫≠n</div>` : '';
                    div.innerHTML = `
                        ${playedBadge}
                        <img src="${u.avatar}" class="w-16 h-16 rounded-full bg-white object-cover border-2 border-gray-300">
                        <div class="font-bold text-sm text-center truncate w-full">${u.name}</div>
                    `;
                    div.onclick = () => app.selectUser(u);
                    container.appendChild(div);
                });
            },

            selectUser: (user) => {
                app.showMessage('X√°c minh danh t√≠nh', `B·∫°n c√≥ ch·∫Øc ch·∫Øn m√¨nh l√† "${user.name}" kh√¥ng?`, 'confirm', () => {
                    app.currentUser = user;
                    app.enterGame();
                });
            },

            enterGame: async () => {
                document.getElementById('displayUserName').innerText = app.currentUser.name;
                document.getElementById('displayGroupName').innerText = app.currentUser.group;
                document.getElementById('currentPlayerAvatar').src = app.currentUser.avatar;

                const allUsers = await db.getUsers(); 
                const freshUser = allUsers.find(u => u.id === app.currentUser.id);
                
                if (freshUser && freshUser.has_played) {
                    document.getElementById('alreadyPlayedMsg').classList.remove('hidden');
                    document.getElementById('envelopeGrid').classList.add('hidden');
                    document.getElementById('pastPrizeAmount').innerText = new Intl.NumberFormat('vi-VN').format(freshUser.prize) + ' VNƒê';
                } else {
                    document.getElementById('alreadyPlayedMsg').classList.add('hidden');
                    document.getElementById('envelopeGrid').classList.remove('hidden');
                    app.renderGrid();
                }

                app.switchView('view-game');
            },

            logout: () => {
                app.currentUser = null;
                app.init();
            },

            renderGrid: async () => {
                const grid = document.getElementById('envelopeGrid');
                grid.innerHTML = '<div class="col-span-full text-center text-white"><i class="fa-solid fa-spinner fa-spin"></i> ƒêang t·∫£i bao l√¨ x√¨...</div>';
                
                const availablePrizes = await db.getPrizesByGroup(app.currentUser.group);
                grid.innerHTML = '';

                const totalAvailable = availablePrizes.reduce((sum, item) => sum + item.quantity, 0);

                if (totalAvailable === 0) {
                    grid.innerHTML = `<div class="col-span-full text-center text-xl mt-10">Nh√≥m n√†y ƒë√£ h·∫øt bao l√¨ x√¨ r·ªìi! üò≠</div>`;
                    return;
                }
                
                const displayCount = Math.min(totalAvailable, 12) < 4 ? 4 : 12;

                for (let i = 0; i < displayCount; i++) {
                    const design = app.getRandomDesign();
                    const envelope = document.createElement('div');
                    envelope.className = 'red-envelope';
                    envelope.onclick = (e) => app.openEnvelope(envelope);
                    
                    envelope.innerHTML = `
                        <div class="envelope-flap"></div>
                        <div class="money-card shadow-md">
                            <div class="money-border"></div>
                            <span class="money-value money-text">???</span>
                            <span class="money-label">L√¨ X√¨ ${app.currentUser.group}</span>
                            <div class="money-center-img"><i class="fa-solid fa-money-bill-wave"></i></div>
                        </div>
                        <div class="envelope-pocket" style="background: ${design.bg};">
                            ${design.html}
                        </div>
                    `;
                    grid.appendChild(envelope);
                }
            },

            getRandomDesign: () => {
                const styles = [
                    { html: `<div class="deco-circle"><span class="text-3xl text-tet-gold font-hand">L·ªôc</span></div><div class="text-xs text-tet-gold mt-2 opacity-80">2026</div>`, bg: 'linear-gradient(135deg, #D00000 0%, #990000 100%)' },
                    { html: `<div class="deco-square"><div class="deco-square-inner"><span class="text-2xl text-tet-gold font-title font-bold">T·∫øt</span></div></div>`, bg: 'linear-gradient(135deg, #b71c1c 0%, #880e4f 100%)' },
                    { html: `<div class="deco-icon-lg"><i class="fa-solid fa-horse-head"></i></div><div class="z-10 text-center"><span class="text-4xl text-tet-gold font-hand drop-shadow-md">Xu√¢n</span></div>`, bg: 'linear-gradient(135deg, #c62828 0%, #b71c1c 100%)' },
                ];
                return styles[Math.floor(Math.random() * styles.length)];
            },

            openEnvelope: async (element) => {
                if (element.classList.contains('open')) return;
                
                const allUsers = await db.getUsers();
                const freshUser = allUsers.find(u => u.id === app.currentUser.id);

                if (freshUser.has_played) {
                    app.showMessage('Th√¥ng b√°o', "B·∫°n ƒë√£ nh·∫≠n l√¨ x√¨ r·ªìi! Kh√¥ng th·ªÉ nh·∫≠n th√™m.", 'info');
                    return;
                }

                const groupPrizes = await db.getPrizesByGroup(app.currentUser.group);
                
                if (groupPrizes.length === 0) {
                    app.showMessage('R·∫•t ti·∫øc', "H·∫øt l√¨ x√¨ cho nh√≥m n√†y r·ªìi!", 'info');
                    return;
                }

                // Lottery Logic
                let expandedPool = [];
                groupPrizes.forEach(p => {
                    for(let i=0; i<p.quantity; i++) expandedPool.push(p.id);
                });

                const randomIndex = Math.floor(Math.random() * expandedPool.length);
                const selectedId = expandedPool[randomIndex];
                const selectedPrize = groupPrizes.find(p => p.id === selectedId);

                // UI
                element.classList.add('open');
                
                // Backend Record
                const success = await db.recordWin(app.currentUser.id, selectedPrize.id, selectedPrize.amount, app.currentUser.name, app.currentUser.group);
                
                if (success) {
                    setTimeout(() => {
                        const moneyText = element.querySelector('.money-text');
                        moneyText.innerText = `${(selectedPrize.amount/1000)}k`;
                        app.fireConfetti();
                    }, 400); 
                    
                    setTimeout(() => {
                        app.showResult(selectedPrize.amount);
                    }, 1500);
                } else {
                    app.showMessage('L·ªói', "C√≥ l·ªói khi k·∫øt n·ªëi ho·∫∑c bao n√†y v·ª´a b·ªã ng∆∞·ªùi kh√°c nh·∫≠n m·∫•t. Th·ª≠ l·∫°i nh√©!", 'info');
                    element.classList.remove('open');
                }
            },

            showResult: (amount) => {
                document.getElementById('resultName').textContent = app.currentUser.name;
                document.getElementById('resultAmount').textContent = new Intl.NumberFormat('vi-VN').format(amount);
                const modal = document.getElementById('resultModal');
                modal.classList.remove('hidden');
                void modal.offsetWidth;
                modal.classList.remove('opacity-0');
            },

            closeModal: () => {
                const modal = document.getElementById('resultModal');
                modal.classList.add('opacity-0');
                setTimeout(() => {
                    modal.classList.add('hidden');
                    app.enterGame(); 
                }, 300);
            },
            
            fireConfetti: () => {
                confetti({ particleCount: 100, spread: 70, origin: { y: 0.6 } });
            },

            checkAdmin: () => {
                app.showMessage(
                    'ƒêƒÉng nh·∫≠p Admin', 
                    'Vui l√≤ng nh·∫≠p m·∫≠t kh·∫©u qu·∫£n tr·ªã', 
                    'prompt', 
                    async (pass) => {
                        if (!pass) return;
                        
                        const isValid = await db.checkAdminPassword(pass);
                        if (isValid) {
                            admin.init();
                        } else {
                            app.showMessage('L·ªói', 'Sai m·∫≠t kh·∫©u!', 'info');
                        }
                    }
                );
            }
        };

        const admin = {
            currentTab: 'users',
            
            init: async () => {
                app.switchView('view-admin');
                await admin.updateGroupDropdowns();
                admin.switchTab('users');
            },

            // Populate all group dropdowns in Admin
            updateGroupDropdowns: async () => {
                const groups = await db.getGroups();
                
                // User Form Dropdown
                const userSelect = document.getElementById('newUserGroup');
                userSelect.innerHTML = groups.map(g => `<option value="${g.name}">${g.name}</option>`).join('');

                // Prize Form Dropdown
                const prizeSelect = document.getElementById('newPrizeGroup');
                prizeSelect.innerHTML = `<option value="all">-- Ch·ªçn Nh√≥m --</option>` + groups.map(g => `<option value="${g.name}">${g.name}</option>`).join('');
            },

            switchTab: (tab) => {
                admin.currentTab = tab;
                ['users', 'prizes', 'stats', 'groups'].forEach(t => {
                    document.getElementById(`admin-${t}`).classList.add('hidden');
                    document.getElementById(`tab-${t}`).classList.replace('border-b-2', 'border-b-0');
                    document.getElementById(`tab-${t}`).classList.replace('text-tet-gold', 'text-white/60');
                });
                
                document.getElementById(`admin-${tab}`).classList.remove('hidden');
                const activeBtn = document.getElementById(`tab-${tab}`);
                activeBtn.classList.replace('border-b-0', 'border-b-2');
                activeBtn.classList.replace('text-white/60', 'text-tet-gold');

                if (tab === 'users') admin.renderUsers();
                if (tab === 'prizes') admin.renderPrizes();
                if (tab === 'stats') admin.renderStats();
                if (tab === 'groups') admin.renderGroups();
            },

            // --- TAB: GROUPS ---
            renderGroups: async () => {
                const tbody = document.getElementById('adminGroupList');
                tbody.innerHTML = '<tr><td colspan="3" class="p-4 text-center">ƒêang t·∫£i...</td></tr>';
                const groups = await db.getGroups();
                tbody.innerHTML = groups.map(g => `
                    <tr class="border-b border-gray-300 hover:bg-gray-100">
                        <td class="p-2 text-center text-xl text-gray-600"><i class="${g.icon}"></i></td>
                        <td class="p-2 font-bold">${g.name}</td>
                        <td class="p-2 text-center flex gap-2 justify-center">
                            <button onclick="admin.editGroup(${g.id}, '${g.name}', '${g.icon}')" class="text-blue-600 hover:text-blue-800"><i class="fa-solid fa-pen-to-square"></i></button>
                            <button onclick="admin.deleteGroup(${g.id})" class="text-red-500 hover:text-red-700"><i class="fa-solid fa-trash"></i></button>
                        </td>
                    </tr>
                `).join('');
            },

            saveGroup: async () => {
                const id = document.getElementById('groupId').value;
                const name = document.getElementById('newGroupName').value;
                const icon = document.getElementById('newGroupIcon').value;

                if (!name) return app.showMessage('Thi·∫øu th√¥ng tin', "C·∫ßn nh·∫≠p t√™n nh√≥m", 'info');
                
                await db.saveGroup(id, name, icon);
                admin.resetGroupForm();
                admin.renderGroups();
                await admin.updateGroupDropdowns(); // Update dropdowns in other tabs
            },

            editGroup: (id, name, icon) => {
                document.getElementById('groupFormTitle').textContent = "C·∫≠p Nh·∫≠t Nh√≥m";
                document.getElementById('groupId').value = id;
                document.getElementById('newGroupName').value = name;
                document.getElementById('newGroupIcon').value = icon;
                document.getElementById('btnSaveGroup').textContent = "C·∫≠p Nh·∫≠t";
                document.getElementById('btnCancelGroup').classList.remove('hidden');
            },

            deleteGroup: (id) => {
                app.showMessage('C·∫£nh b√°o', "X√≥a nh√≥m n√†y? L∆∞u √Ω: Ng∆∞·ªùi d√πng trong nh√≥m n√†y s·∫Ω kh√¥ng th·ªÉ t√¨m th·∫•y nh√≥m c·ªßa h·ªç n·ªØa.", 'confirm', async () => {
                    await db.deleteGroup(id);
                    admin.renderGroups();
                    await admin.updateGroupDropdowns();
                });
            },

            resetGroupForm: () => {
                document.getElementById('groupFormTitle').textContent = "Th√™m Nh√≥m M·ªõi";
                document.getElementById('groupId').value = '';
                document.getElementById('newGroupName').value = '';
                document.getElementById('newGroupIcon').value = 'fa-solid fa-users';
                document.getElementById('btnSaveGroup').textContent = "L∆∞u";
                document.getElementById('btnCancelGroup').classList.add('hidden');
            },

            // --- TAB: USERS ---
            renderUsers: async () => {
                const tbody = document.getElementById('adminUserList');
                tbody.innerHTML = '<tr><td colspan="5" class="p-4 text-center">ƒêang t·∫£i...</td></tr>';
                const users = await db.getUsers();
                tbody.innerHTML = users.map(u => `
                    <tr class="border-b border-gray-300 hover:bg-gray-100">
                        <td class="p-2"><img src="${u.avatar}" class="w-8 h-8 rounded-full border"></td>
                        <td class="p-2 font-bold">${u.name}</td>
                        <td class="p-2 text-center text-xs"><span class="bg-blue-100 text-blue-800 px-2 py-1 rounded">${u.group}</span></td>
                        <td class="p-2 text-center text-xs">${u.has_played ? '<span class="text-green-600 font-bold">ƒê√£ nh·∫≠n</span>' : '<span class="text-gray-400">Ch∆∞a</span>'}</td>
                        <td class="p-2 text-center flex gap-2 justify-center">
                            <button onclick="admin.editUser(${u.id}, '${u.name}', '${u.avatar}', '${u.group}')" class="text-blue-600 hover:text-blue-800"><i class="fa-solid fa-pen-to-square"></i></button>
                            <button onclick="admin.deleteUser(${u.id})" class="text-red-500 hover:text-red-700"><i class="fa-solid fa-trash"></i></button>
                        </td>
                    </tr>
                `).join('');
            },

            saveUser: async () => {
                const id = document.getElementById('userId').value;
                const name = document.getElementById('newUserName').value;
                const avatar = document.getElementById('newUserAvatar').value;
                const group = document.getElementById('newUserGroup').value;
                
                if (!name) return app.showMessage('Thi·∫øu th√¥ng tin', "C·∫ßn nh·∫≠p t√™n th√†nh vi√™n", 'info');
                
                await db.saveUser(id, name, avatar, group);
                admin.resetUserForm();
                admin.renderUsers();
            },

            editUser: (id, name, avatar, group) => {
                document.getElementById('userFormTitle').textContent = "C·∫≠p Nh·∫≠t Th√†nh Vi√™n";
                document.getElementById('userId').value = id;
                document.getElementById('newUserName').value = name;
                document.getElementById('newUserAvatar').value = avatar;
                document.getElementById('newUserGroup').value = group;
                
                document.getElementById('btnSaveUser').textContent = "C·∫≠p Nh·∫≠t";
                document.getElementById('btnCancelUser').classList.remove('hidden');
                document.getElementById('btnCancelUser').onclick = admin.resetUserForm;
            },
            
            resetUserForm: () => {
                document.getElementById('userFormTitle').textContent = "Th√™m Th√†nh Vi√™n";
                document.getElementById('userId').value = '';
                document.getElementById('newUserName').value = '';
                document.getElementById('newUserAvatar').value = '';
                // reset group to first option if needed, or keep as is
                document.getElementById('btnSaveUser').textContent = "Th√™m Ng∆∞·ªùi";
                document.getElementById('btnCancelUser').classList.add('hidden');
            },
            
            deleteUser: (id) => { 
                app.showMessage('X√°c nh·∫≠n', "B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën x√≥a ng∆∞·ªùi n√†y?", 'confirm', async () => {
                    await db.deleteUser(id); 
                    admin.renderUsers(); 
                });
            },

            // --- TAB: PRIZES ---
            renderPrizes: async () => {
                const tbody = document.getElementById('adminPrizeList');
                tbody.innerHTML = '<tr><td colspan="4" class="p-4 text-center">ƒêang t·∫£i...</td></tr>';
                const prizes = await db.getPrizes();
                tbody.innerHTML = prizes.map(p => `
                    <tr class="border-b border-gray-300 hover:bg-gray-100">
                        <td class="p-2 text-xs font-bold text-blue-800">${p.group}</td>
                        <td class="p-2 text-right text-red-700 font-bold">${new Intl.NumberFormat('vi-VN').format(p.amount)}ƒë</td>
                        <td class="p-2 text-center">${p.quantity}</td>
                        <td class="p-2 text-center"><button onclick="admin.deletePrize(${p.id})" class="text-red-500"><i class="fa-solid fa-trash"></i></button></td>
                    </tr>
                `).join('');
            },

            addPrize: async () => {
                const group = document.getElementById('newPrizeGroup').value;
                const amount = document.getElementById('newPrizeAmount').value;
                const qty = document.getElementById('newPrizeQuantity').value;
                if (group === 'all' || !amount || !qty) return app.showMessage('Thi·∫øu th√¥ng tin', "Vui l√≤ng nh·∫≠p ƒë·ªß th√¥ng tin gi·∫£i th∆∞·ªüng", 'info');
                
                await db.addPrize(group, amount, qty);
                admin.renderPrizes();
            },
            
            deletePrize: (id) => { 
                app.showMessage('X√°c nh·∫≠n', "X√≥a gi·∫£i th∆∞·ªüng n√†y?", 'confirm', async () => {
                    await db.deletePrize(id); 
                    admin.renderPrizes(); 
                });
            },

            // --- TAB: STATS ---
            renderStats: async () => {
                const container = document.getElementById('adminHistoryLog');
                container.innerHTML = '<div class="p-4 text-center">ƒêang t·∫£i...</div>';
                const history = await db.getHistory();
                container.innerHTML = history.map(h => `
                    <div class="border-b border-gray-200 py-2 flex justify-between items-center">
                        <div>
                            <span class="font-bold block">${h.user}</span>
                            <span class="text-xs text-gray-500 bg-gray-100 px-1 rounded">${h.group}</span>
                        </div>
                        <div class="text-right">
                            <span class="font-bold text-red-600 block">${new Intl.NumberFormat('vi-VN').format(h.amount)}ƒë</span>
                            <span class="text-xs text-gray-400">${h.time}</span>
                        </div>
                    </div>
                `).join('');
            },

            resetAllData: () => { 
                if (db.useSupabase) {
                     app.showMessage('L∆∞u √Ω', "ƒê·ªÉ x√≥a to√†n b·ªô d·ªØ li·ªáu tr√™n Supabase, vui l√≤ng ch·∫°y l·ªánh TRUNCATE trong SQL Editor (ƒë·ªÉ an to√†n).", 'info');
                } else {
                    app.showMessage('C·∫¢NH B√ÅO', "H√†nh ƒë·ªông n√†y s·∫Ω x√≥a TO√ÄN B·ªò d·ªØ li·ªáu ng∆∞·ªùi ch∆°i, gi·∫£i th∆∞·ªüng v√† l·ªãch s·ª≠. B·∫°n c√≥ ch·∫Øc ch·∫Øn kh√¥ng?", 'confirm', async () => {
                        await db.resetAll(); 
                        admin.init(); 
                    });
                }
            },
            
            resetPlayStatus: () => { 
                app.showMessage('Reset L∆∞·ª£t Ch∆°i', "Reset l∆∞·ª£t ch∆°i s·∫Ω cho ph√©p t·∫•t c·∫£ m·ªçi ng∆∞·ªùi r√∫t l·∫°i t·ª´ ƒë·∫ßu (Danh s√°ch ng∆∞·ªùi d√πng ƒë∆∞·ª£c gi·ªØ nguy√™n). Ti·∫øp t·ª•c?", 'confirm', async () => {
                    await db.resetPlayStatus(); 
                    admin.init(); 
                });
            }
        };

        window.onload = app.init;
    </script>
</body>
</html>