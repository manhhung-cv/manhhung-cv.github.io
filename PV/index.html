<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Luyện phỏng vấn tiếng Nhật - Standalone</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <!-- SortableJS for Drag and Drop -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Sortable/1.15.0/Sortable.min.js"></script>
    <style>
        :root {
            --bg-primary: #ffffff; --bg-secondary: #f0f4f8; --bg-tertiary: #e5e7eb;
            --text-primary: #111827; --text-secondary: #6b7280; --border-primary: #e5e7eb;
            --card-q-bg: #e0f2fe; --card-q-border: #bae6fd; --card-q-text: #0c4a6e;
            --card-a-bg: #f0fdf4; --card-a-border: #bbf7d0; --card-a-text: #166534;
            --modal-bg: #ffffff; --active-folder-bg: #dbeafe; --active-folder-text: #1e40af;
        }

        html.dark {
            --bg-primary: #1f2937; --bg-secondary: #111827; --bg-tertiary: #374151;
            --text-primary: #f9fafb; --text-secondary: #9ca3af; --border-primary: #374151;
            --card-q-bg: #0c4a6e; --card-q-border: #0369a1; --card-q-text: #e0f2fe;
            --card-a-bg: #14532d; --card-a-border: #166534; --card-a-text: #dcfce7;
            --modal-bg: #374151; --active-folder-bg: #1e3a8a; --active-folder-text: #eff6ff;
        }

        body { font-family: 'Inter', sans-serif; background-color: var(--bg-secondary); color: var(--text-primary); }
        .folder-item.active { background-color: var(--active-folder-bg); color: var(--active-folder-text); }
        .folder-item:hover { background-color: var(--bg-tertiary); }
        .modal-backdrop { background-color: rgba(0, 0, 0, 0.5); }
        .icon-btn { color: var(--text-secondary); transition: color 0.2s; }
        .icon-btn:hover { color: #3b82f6; }
        .drag-handle { cursor: grab; } .drag-handle:active { cursor: grabbing; }
        .sortable-ghost { background: #dbeafe; opacity: 0.5; border: 2px dashed #60a5fa; }
        .qa-controls:hover { background-color: rgba(128,128,128,0.1); }
        .icon-btn svg { stroke: currentColor; }
    </style>
</head>
<body class="antialiased">

    <div class="relative min-h-screen md:flex">
        <!-- Mobile menu button -->
        <div class="md:hidden flex justify-between items-center p-4 bg-[var(--bg-primary)] border-b border-[var(--border-primary)]">
            <h1 class="text-xl font-bold">Luyện Phỏng Vấn</h1>
            <button id="mobile-menu-button" class="p-2 rounded-md focus:outline-none focus:bg-[var(--bg-tertiary)]"></button>
        </div>

        <!-- Sidebar -->
        <aside id="sidebar" class="bg-[var(--bg-primary)] w-4/5 max-w-xs absolute inset-y-0 left-0 transform -translate-x-full md:relative md:translate-x-0 transition-transform duration-300 ease-in-out z-40 border-r border-[var(--border-primary)] flex flex-col">
            <div class="p-4 border-b border-[var(--border-primary)]">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-xl font-bold">Categories</h2>
                    <div>
                        <button onclick="showSettingsModal()" class="icon-btn p-2 rounded-full hover:bg-[var(--bg-tertiary)]" title="Cài đặt"></button>
                        <button onclick="showFolderModal()" class="icon-btn p-2 rounded-full hover:bg-[var(--bg-tertiary)]" title="Thêm thư mục mới"></button>
                    </div>
                </div>
            </div>
            <div id="folder-list" class="flex-grow overflow-y-auto p-4"></div>
        </aside>

        <!-- Main Content -->
        <main class="flex-1 p-4 sm:p-6 bg-[var(--bg-secondary)]"><div id="main-content"></div></main>
    </div>
    
    <div id="sidebar-backdrop" class="fixed inset-0 bg-black bg-opacity-50 z-30 hidden md:hidden"></div>

    <!-- Modals -->
    <div id="settings-modal" class="fixed inset-0 z-50 hidden items-center justify-center modal-backdrop p-4">
        <div class="bg-[var(--modal-bg)] rounded-lg shadow-xl p-6 w-full max-w-lg max-h-[90vh] flex flex-col">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-2xl font-bold">Cài đặt</h3>
                <button onclick="hideSettingsModal()" class="icon-btn p-1 rounded-full hover:bg-[var(--bg-tertiary)]"></button>
            </div>
            <div class="overflow-y-auto space-y-6 pr-2">
                <!-- Appearance -->
                <div class="p-4 rounded-lg border border-[var(--border-primary)]">
                    <h4 class="font-semibold mb-3">Giao diện</h4>
                    <div class="flex items-center justify-between">
                        <span>Chế độ Tối</span>
                        <button id="theme-toggle" class="icon-btn p-2 rounded-full hover:bg-[var(--bg-tertiary)]"></button>
                    </div>
                </div>
                <!-- Data -->
                <div class="p-4 rounded-lg border border-[var(--border-primary)]">
                    <h4 class="font-semibold mb-3">Dữ liệu</h4>
                    <div class="flex items-center justify-center gap-4">
                        <button onclick="exportData()" class="flex items-center gap-2 px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700 transition w-full justify-center"></button>
                        <label for="import-file-input" class="flex items-center gap-2 px-4 py-2 bg-green-600 text-white rounded-md hover:bg-green-700 transition w-full justify-center cursor-pointer"></label>
                        <input type="file" id="import-file-input" class="hidden" accept=".json">
                    </div>
                </div>
                <!-- Voice Settings -->
                <div class="p-4 rounded-lg border border-[var(--border-primary)]">
                    <h4 class="font-semibold mb-3">Giọng đọc</h4>
                    <div class="space-y-4">
                        <div>
                            <label for="voice-select-ja" class="block text-sm font-medium mb-1">Giọng Tiếng Nhật</label>
                            <div class="flex items-center gap-2">
                                <select id="voice-select-ja" class="w-full p-2 border border-[var(--border-primary)] rounded-md shadow-sm bg-[var(--bg-primary)]"></select>
                                <button onclick="previewVoice('ja')" class="icon-btn p-2 rounded-full hover:bg-[var(--bg-tertiary)]" title="Nghe thử"></button>
                            </div>
                        </div>
                        <div>
                            <label for="voice-select-en" class="block text-sm font-medium mb-1">Giọng Tiếng Anh</label>
                             <div class="flex items-center gap-2">
                                <select id="voice-select-en" class="w-full p-2 border border-[var(--border-primary)] rounded-md shadow-sm bg-[var(--bg-primary)]"></select>
                                <button onclick="previewVoice('en')" class="icon-btn p-2 rounded-full hover:bg-[var(--bg-tertiary)]" title="Nghe thử"></button>
                            </div>
                        </div>
                        <div>
                            <label for="voice-select-vi" class="block text-sm font-medium mb-1">Giọng Tiếng Việt</label>
                             <div class="flex items-center gap-2">
                                <select id="voice-select-vi" class="w-full p-2 border border-[var(--border-primary)] rounded-md shadow-sm bg-[var(--bg-primary)]"></select>
                                <button onclick="previewVoice('vi')" class="icon-btn p-2 rounded-full hover:bg-[var(--bg-tertiary)]" title="Nghe thử"></button>
                            </div>
                        </div>
                        <div>
                            <label for="voice-rate" class="block text-sm font-medium mb-1">Tốc độ đọc: <span id="rate-value">1</span></label>
                            <input type="range" id="voice-rate" min="0.5" max="2" step="0.1" class="w-full">
                        </div>
                        <div>
                            <label for="voice-pitch" class="block text-sm font-medium mb-1">Cao độ: <span id="pitch-value">1</span></label>
                            <input type="range" id="voice-pitch" min="0" max="2" step="0.1" class="w-full">
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div id="qa-modal" class="fixed inset-0 z-50 hidden items-center justify-center modal-backdrop p-4"><div class="bg-[var(--modal-bg)] rounded-lg shadow-xl p-6 w-full max-w-2xl"><h3 id="qa-modal-title" class="text-2xl font-bold mb-4"></h3><form id="qa-form"><input type="hidden" id="qa-id"><div class="mb-4"><label for="question-text" class="block text-sm font-medium mb-1">Câu hỏi (Tiếng Nhật)</label><textarea id="question-text" rows="3" class="w-full p-2 border border-[var(--border-primary)] rounded-md shadow-sm bg-[var(--bg-primary)]"></textarea></div><div class="mb-4"><label for="answer-text" class="block text-sm font-medium mb-1">Câu trả lời (Tiếng Nhật)</label><textarea id="answer-text" rows="5" class="w-full p-2 border border-[var(--border-primary)] rounded-md shadow-sm bg-[var(--bg-primary)]"></textarea></div><div class="flex justify-end gap-4"><button type="button" onclick="hideQaModal()" class="px-4 py-2 bg-[var(--bg-tertiary)] rounded-md hover:opacity-80">Hủy</button><button type="submit" class="px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700">Lưu</button></div></form></div></div>
    <div id="move-qa-modal" class="fixed inset-0 z-50 hidden items-center justify-center modal-backdrop p-4"><div class="bg-[var(--modal-bg)] rounded-lg shadow-xl p-6 w-full max-w-md"><h3 class="text-2xl font-bold mb-4">Di chuyển đến thư mục</h3><form id="move-qa-form"><input type="hidden" id="move-qa-id"><div class="mb-4"><label for="folder-destination" class="block text-sm font-medium mb-1">Chọn thư mục đích</label><select id="folder-destination" class="w-full p-2 border border-[var(--border-primary)] rounded-md shadow-sm bg-[var(--bg-primary)]"></select></div><div class="flex justify-end gap-4"><button type="button" onclick="hideMoveQaModal()" class="px-4 py-2 bg-[var(--bg-tertiary)] rounded-md hover:opacity-80">Hủy</button><button type="submit" class="px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700">Di chuyển</button></div></form></div></div>
    <div id="folder-modal" class="fixed inset-0 z-50 hidden items-center justify-center modal-backdrop p-4"><div class="bg-[var(--modal-bg)] rounded-lg shadow-xl p-6 w-full max-w-md"><h3 id="folder-modal-title" class="text-2xl font-bold mb-4"></h3><form id="folder-form"><input type="hidden" id="folder-id"><input type="hidden" id="parent-folder-id"><div class="mb-4"><label for="folder-name" class="block text-sm font-medium mb-1">Tên thư mục</label><input type="text" id="folder-name" class="w-full p-2 border border-[var(--border-primary)] rounded-md shadow-sm bg-[var(--bg-primary)]"></div><div class="flex justify-end gap-4"><button type="button" onclick="hideFolderModal()" class="px-4 py-2 bg-[var(--bg-tertiary)] rounded-md hover:opacity-80">Hủy</button><button type="submit" class="px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700">Lưu</button></div></form></div></div>

    <script>
        // --- STATE & INITIAL DATA ---
        const initialData = [ { id: 'folder-1', name: 'HunqFolder', children: [] } ];
        let appData = [];
        let activeFolderId = null;
        let voices = [];

        // --- ICONS ---
        const ICONS = {
            grip: '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="drag-handle h-8 w-8 text-[var(--text-secondary)] mr-2 mt-3"><circle cx="12" cy="5" r="1" /><circle cx="12" cy="12" r="1" /><circle cx="12" cy="19" r="1" /></svg>',
            folderMove: '<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 10v4"/><path d="m10 12 2-2 2 2"/><path d="M2 12V6a2 2 0 0 1 2-2h3.93a2 2 0 0 1 1.66.9l.82 1.2a2 2 0 0 0 1.66.9H20a2 2 0 0 1 2 2v1"/><path d="M2 12v6a2 2 0 0 0 2 2h16a2 2 0 0 0 2-2v-2.5"/></svg>',
            edit: '<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M17 3a2.85 2.83 0 1 1 4 4L7.5 20.5 2 22l1.5-5.5Z"/><path d="m15 5 4 4"/></svg>',
            copy: '<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect width="14" height="14" x="8" y="8" rx="2" ry="2"/><path d="M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2"/></svg>',
            trash: '<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-red-500 hover:text-red-700"><path d="M3 6h18"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/><line x1="10" x2="10" y1="11" y2="17"/><line x1="14" x2="14" y1="11" y2="17"/></svg>',
            volume: '<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polygon points="11 5 6 9 2 9 2 15 6 15 11 19 11 5"/><path d="M15.54 8.46a5 5 0 0 1 0 7.07"/></svg>',
            folderGrip: '<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="drag-handle h-5 w-5 text-gray-400 mr-1"><circle cx="12" cy="5" r="1" /><circle cx="12" cy="12" r="1" /><circle cx="12" cy="19" r="1" /></svg>',
            folderPlus: '<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M4 20h16a2 2 0 0 0 2-2V8a2 2 0 0 0-2-2h-7.93a2 2 0 0 1-1.66-.9l-.82-1.2A2 2 0 0 0 7.93 3H4a2 2 0 0 0-2 2v13c0 1.1.9 2 2 2Z"/><line x1="12" x2="12" y1="10" y2="16"/><line x1="9" x2="15" y1="13" y2="13"/></svg>',
            plusCircle: '<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"/><line x1="12" x2="12" y1="8" y2="16"/><line x1="8" x2="16" y1="12" y2="12"/></svg>',
            sun: '<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="4"/><path d="M12 2v2"/><path d="M12 20v2"/><path d="m4.93 4.93 1.41 1.41"/><path d="m17.66 17.66 1.41 1.41"/><path d="M2 12h2"/><path d="M20 12h2"/><path d="m6.34 17.66-1.41 1.41"/><path d="m19.07 4.93-1.41 1.41"/></svg>',
            moon: '<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 3a6 6 0 0 0 9 9 9 9 0 1 1-9-9Z"/></svg>',
            export: '<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" x2="12" y1="15" y2="3"/></svg>',
            import: '<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="17 8 12 3 7 8"/><line x1="12" x2="12" y1="3" y2="15"/></svg>',
            settings: '<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="3"/><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"/></svg>',
            x: '<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="18" x2="6" y1="6" y2="18"/><line x1="6" x2="18" y1="6" y2="18"/></svg>',
            menu: '<svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16" /></svg>'
        };

        // --- DOM ELEMENTS ---
        const sidebar = document.getElementById('sidebar');
        const mobileMenuButton = document.getElementById('mobile-menu-button');
        const sidebarBackdrop = document.getElementById('sidebar-backdrop');
        const themeToggleButton = document.getElementById('theme-toggle');
        const importFileInput = document.getElementById('import-file-input');
        const voiceRateSlider = document.getElementById('voice-rate');
        const voicePitchSlider = document.getElementById('voice-pitch');

        // --- LIFECYCLE & SETUP ---
        window.addEventListener('DOMContentLoaded', () => {
            setupStaticIcons();
            setupTheme();
            loadData();
            setupVoiceSettings();
            renderAll();
            initializeActiveFolder();
            setupEventListeners();
        });
        
        function setupStaticIcons() {
            mobileMenuButton.innerHTML = ICONS.menu;
            document.querySelector('button[onclick="showSettingsModal()"]').innerHTML = ICONS.settings;
            document.querySelector('button[onclick="showFolderModal()"]').innerHTML = ICONS.folderPlus;
            document.querySelector('button[onclick="hideSettingsModal()"]').innerHTML = ICONS.x;
            document.querySelector('button[onclick="exportData()"]').innerHTML = ICONS.export + 'Xuất file';
            document.querySelector('label[for="import-file-input"]').innerHTML = ICONS.import + 'Nhập file';
            document.querySelectorAll('button[title="Nghe thử"]').forEach(btn => btn.innerHTML = ICONS.volume);
        }

        function setupTheme() {
            applyTheme(localStorage.getItem('theme') || 'light');
            themeToggleButton.addEventListener('click', () => {
                const newTheme = document.documentElement.classList.contains('dark') ? 'light' : 'dark';
                localStorage.setItem('theme', newTheme);
                applyTheme(newTheme);
            });
        }
        
        function setupVoiceSettings() {
            populateVoiceList();
            if (speechSynthesis.onvoiceschanged !== undefined) {
                speechSynthesis.onvoiceschanged = populateVoiceList;
            }
            const savedRate = localStorage.getItem('voiceRate') || 1;
            const savedPitch = localStorage.getItem('voicePitch') || 1;
            voiceRateSlider.value = savedRate;
            voicePitchSlider.value = savedPitch;
            document.getElementById('rate-value').textContent = savedRate;
            document.getElementById('pitch-value').textContent = savedPitch;
        }

        function setupEventListeners() {
            mobileMenuButton.addEventListener('click', toggleMobileMenu);
            sidebarBackdrop.addEventListener('click', toggleMobileMenu);
            importFileInput.addEventListener('change', importData);
            voiceRateSlider.addEventListener('input', (e) => {
                const rate = e.target.value;
                document.getElementById('rate-value').textContent = rate;
                localStorage.setItem('voiceRate', rate);
            });
            voicePitchSlider.addEventListener('input', (e) => {
                const pitch = e.target.value;
                document.getElementById('pitch-value').textContent = pitch;
                localStorage.setItem('voicePitch', pitch);
            });
            document.getElementById('voice-select-ja').addEventListener('change', (e) => localStorage.setItem('voiceURI_ja', e.target.value));
            document.getElementById('voice-select-en').addEventListener('change', (e) => localStorage.setItem('voiceURI_en', e.target.value));
            document.getElementById('voice-select-vi').addEventListener('change', (e) => localStorage.setItem('voiceURI_vi', e.target.value));
        }

        function initializeActiveFolder() {
            const folderExists = activeFolderId ? findFolder(activeFolderId, appData) : false;
            if (folderExists) { setActiveFolder(activeFolderId); } 
            else if (appData.length > 0) { setActiveFolder(appData[0].id); } 
            else { setActiveFolder(null); }
        }

        // --- DATA & THEME ---
        function applyTheme(theme) { if (theme === 'dark') { document.documentElement.classList.add('dark'); themeToggleButton.innerHTML = ICONS.sun; } else { document.documentElement.classList.remove('dark'); themeToggleButton.innerHTML = ICONS.moon; } }
        function loadData() { const savedData = localStorage.getItem('interviewApp_data_v9'); const savedActiveFolder = localStorage.getItem('interviewApp_activeFolder_v9'); if (savedData) { appData = JSON.parse(savedData); activeFolderId = savedActiveFolder; } else { appData = initialData; } }
        function saveData() { localStorage.setItem('interviewApp_data_v9', JSON.stringify(appData)); localStorage.setItem('interviewApp_activeFolder_v9', activeFolderId); }
        function exportData() { const dataStr = JSON.stringify(appData, null, 2); const dataBlob = new Blob([dataStr], {type: "application/json"}); const url = URL.createObjectURL(dataBlob); const link = document.createElement('a'); link.href = url; link.download = `interview-data-${new Date().toISOString().slice(0,10)}.json`; document.body.appendChild(link); link.click(); document.body.removeChild(link); URL.revokeObjectURL(url); }
        function importData(event) { const file = event.target.files[0]; if (!file) return; const reader = new FileReader(); reader.onload = function(e) { try { const importedData = JSON.parse(e.target.result); if (Array.isArray(importedData)) { if (confirm('Bạn có chắc muốn ghi đè dữ liệu hiện tại?')) { appData = importedData; activeFolderId = appData.length > 0 ? appData[0].id : null; saveData(); renderAll(); setActiveFolder(activeFolderId); } } else { alert('File không hợp lệ.'); } } catch (error) { alert('Lỗi khi đọc file.'); } finally { event.target.value = ''; } }; reader.readAsText(file); }
        
        // --- VOICE SYNTHESIS ---
        function populateVoiceList() {
            voices = speechSynthesis.getVoices();
            const jaSelect = document.getElementById('voice-select-ja');
            const enSelect = document.getElementById('voice-select-en');
            const viSelect = document.getElementById('voice-select-vi');
            jaSelect.innerHTML = '<option value="">Mặc định</option>';
            enSelect.innerHTML = '<option value="">Mặc định</option>';
            viSelect.innerHTML = '<option value="">Mặc định</option>';
            const savedJA = localStorage.getItem('voiceURI_ja');
            const savedEN = localStorage.getItem('voiceURI_en');
            const savedVI = localStorage.getItem('voiceURI_vi');
            voices.forEach(voice => {
                const option = document.createElement('option');
                option.textContent = `${voice.name} (${voice.lang})`;
                option.value = voice.voiceURI;
                if (voice.lang.startsWith('ja')) { jaSelect.appendChild(option); if (voice.voiceURI === savedJA) option.selected = true; } 
                else if (voice.lang.startsWith('en')) { enSelect.appendChild(option); if (voice.voiceURI === savedEN) option.selected = true; } 
                else if (voice.lang.startsWith('vi')) { viSelect.appendChild(option); if (voice.voiceURI === savedVI) option.selected = true; }
            });
        }

        function speakText(text, lang) {
            if ('speechSynthesis' in window) {
                window.speechSynthesis.cancel();
                const utterance = new SpeechSynthesisUtterance(text);
                const langPrefix = lang.split('-')[0];
                const savedVoiceURI = localStorage.getItem(`voiceURI_${langPrefix}`);
                const selectedVoice = voices.find(voice => voice.voiceURI === savedVoiceURI);
                if (selectedVoice) { utterance.voice = selectedVoice; } else { utterance.lang = lang; }
                utterance.rate = localStorage.getItem('voiceRate') || 1;
                utterance.pitch = localStorage.getItem('voicePitch') || 1;
                window.speechSynthesis.speak(utterance);
            } else { alert("Trình duyệt không hỗ trợ tính năng này."); }
        }

        function previewVoice(langPrefix) {
            const select = document.getElementById(`voice-select-${langPrefix}`);
            const voiceURI = select.value;
            if (!voiceURI) { alert("Vui lòng chọn một giọng đọc cụ thể để nghe thử."); return; }
            let sampleText = '', langCode = '';
            switch (langPrefix) {
                case 'ja': sampleText = 'こんにちは'; langCode = 'ja-JP'; break;
                case 'en': sampleText = 'Hello, this is a test.'; langCode = 'en-US'; break;
                case 'vi': sampleText = 'Xin chào, đây là giọng đọc thử.'; langCode = 'vi-VN'; break;
                default: return;
            }
            speakText(sampleText, langCode);
        }
        
        // --- RENDER FUNCTIONS ---
        function renderAll() { renderFolders(); renderQAs(); }
        function renderFolders() { const folderListEl = document.getElementById('folder-list'); folderListEl.innerHTML = ''; folderListEl.dataset.parentId = 'root'; createFolderTree(appData, folderListEl); initSortableForFolders(folderListEl); }
        function createFolderTree(folders, parentEl) { folders.forEach(folder => { const folderWrapper = document.createElement('div'); folderWrapper.className = 'folder-wrapper'; folderWrapper.dataset.id = folder.id; const folderEl = document.createElement('div'); folderEl.className = 'folder-item flex items-center p-2 rounded-md cursor-pointer mb-1'; if (folder.id === activeFolderId) folderEl.classList.add('active'); folderEl.innerHTML += ICONS.folderGrip; const folderNameSpan = document.createElement('span'); folderNameSpan.textContent = folder.name; folderNameSpan.className = 'flex-grow'; folderNameSpan.onclick = () => setActiveFolder(folder.id, true); folderEl.appendChild(folderNameSpan); const controls = createFolderControls(folder); folderEl.appendChild(controls); folderWrapper.appendChild(folderEl); if (folder.children) { const childrenContainer = document.createElement('div'); childrenContainer.className = 'folder-children pl-4'; childrenContainer.dataset.parentId = folder.id; createFolderTree(folder.children, childrenContainer); folderWrapper.appendChild(childrenContainer); initSortableForFolders(childrenContainer); } parentEl.appendChild(folderWrapper); }); }
        function renderQAs() { const mainContentEl = document.getElementById('main-content'); if (!activeFolderId) { mainContentEl.innerHTML = `<div class="text-center text-[var(--text-secondary)] mt-10"><p>Chọn một thư mục để bắt đầu.</p></div>`; return; } const folder = findFolder(activeFolderId, appData); if (!folder) { mainContentEl.innerHTML = `<div class="text-center text-[var(--text-secondary)] mt-10"><p>Thư mục không tồn tại.</p></div>`; return; } mainContentEl.innerHTML = ''; const header = document.createElement('div'); header.className = 'hidden md:flex justify-between items-center mb-6'; header.innerHTML = `<h1 class="text-2xl lg:text-3xl font-bold">${folder.name}</h1><button onclick="showQaModal()" class="flex items-center gap-2 px-4 py-2 bg-blue-600 text-white rounded-lg shadow hover:bg-blue-700 transition">${ICONS.plusCircle}Thêm Q&A</button>`; const qaContainer = document.createElement('div'); qaContainer.className = 'space-y-6'; qaContainer.id = 'qa-container'; if (folder.qa.length === 0) { qaContainer.innerHTML = `<div class="text-center text-[var(--text-secondary)] p-8 border-2 border-dashed border-[var(--border-primary)] rounded-lg"><p>Thư mục này trống.</p></div>`; } else { folder.qa.forEach(item => { qaContainer.appendChild(createQaCard(item)); }); } mainContentEl.appendChild(header); mainContentEl.appendChild(qaContainer); initSortableQAs(); }
        function createQaCard(item) { const cardWrapper = document.createElement('div'); cardWrapper.className = 'bg-[var(--bg-primary)] p-3 sm:p-5 rounded-xl shadow-md'; cardWrapper.dataset.id = item.id; const questionText = item.q.replace(/'/g, "\\'").replace(/"/g, '&quot;'); const answerText = item.a.replace(/'/g, "\\'").replace(/"/g, '&quot;'); cardWrapper.innerHTML = `<div class="flex items-start">${ICONS.grip}<div class="flex-grow"><div style="background-color: var(--card-q-bg); border-color: var(--card-q-border);" class="border p-3 sm:p-4 rounded-lg mb-4"><div class="flex justify-between items-start"><p style="color: var(--card-q-text);" class="text-base sm:text-lg font-medium flex-grow pr-2">${item.q}</p><div class="qa-controls flex items-center gap-1 sm:gap-2 ml-2 flex-shrink-0"><button class="icon-btn" onclick="showMoveQaModal('${item.id}')" title="Di chuyển">${ICONS.folderMove}</button><button class="icon-btn" onclick="showQaModal('${item.id}')" title="Chỉnh sửa">${ICONS.edit}</button><button class="icon-btn" onclick="copyQa('${item.id}')" title="Sao chép">${ICONS.copy}</button><button class="icon-btn" onclick="deleteQa('${item.id}')" title="Xóa">${ICONS.trash}</button></div></div></div><div style="background-color: var(--card-a-bg); border-color: var(--card-a-border);" class="border p-3 sm:p-4 rounded-lg"><p style="color: var(--card-a-text);" class="text-sm sm:text-md">${item.a}</p></div><div class="flex flex-wrap justify-end mt-4 gap-3"><button onclick="speakText('${questionText}', 'ja-JP')" class="flex items-center gap-2 px-3 py-2 bg-sky-500 text-white rounded-md shadow-sm hover:bg-sky-600 transition text-sm">${ICONS.volume} Nghe câu hỏi</button><button onclick="speakText('${answerText}', 'ja-JP')" class="flex items-center gap-2 px-3 py-2 bg-teal-500 text-white rounded-md shadow-sm hover:bg-teal-600 transition text-sm">${ICONS.volume} Nghe câu trả lời</button></div></div></div>`; return cardWrapper; }

        // --- CORE LOGIC (SORTABLE, CRUD, MODALS) ---
        function toggleMobileMenu() { sidebar.classList.toggle('-translate-x-full'); sidebarBackdrop.classList.toggle('hidden'); }
        function initSortableQAs() { const qaContainer = document.getElementById('qa-container'); if (qaContainer) { new Sortable(qaContainer, { group: 'qa-items', animation: 150, handle: '.drag-handle', ghostClass: 'sortable-ghost', onEnd: (evt) => { const folder = findFolder(activeFolderId, appData); if (folder && evt.from === evt.to) { const [movedItem] = folder.qa.splice(evt.oldIndex, 1); folder.qa.splice(evt.newIndex, 0, movedItem); saveData(); } } }); } }
        function initSortableForFolders(containerEl) { new Sortable(containerEl, { group: 'nested', animation: 150, handle: '.drag-handle', ghostClass: 'sortable-ghost', fallbackOnBody: true, swapThreshold: 0.65, onEnd: (evt) => { const itemId = evt.item.dataset.id; const newParentId = evt.to.dataset.parentId; const newIndex = evt.newIndex; const {item} = findAndRemoveItem(itemId, appData); if (item) { let newParentList; if (newParentId === 'root') { newParentList = appData; } else { const newParent = findFolder(newParentId, appData); if (!newParent.children) newParent.children = []; newParentList = newParent.children; } newParentList.splice(newIndex, 0, item); saveData(); renderAll(); } } }); }
        function findAndRemoveItem(id, list) { for (let i = 0; i < list.length; i++) { if (list[i].id === id) { const item = list.splice(i, 1)[0]; return { item }; } if (list[i].children) { const result = findAndRemoveItem(id, list[i].children); if (result.item) return result; } } return { item: null }; }
        function setActiveFolder(folderId, fromMobileMenu = false) { activeFolderId = folderId; saveData(); renderAll(); if (fromMobileMenu && window.innerWidth < 768) { toggleMobileMenu(); } }
        function createFolderControls(folder) { const controls = document.createElement('div'); controls.className = 'flex items-center gap-1'; controls.innerHTML = `<button class="icon-btn p-1" title="Thêm thư mục con" onclick="event.stopPropagation(); showFolderModal(null, '${folder.id}');">${ICONS.folderPlus}</button><button class="icon-btn p-1" title="Chỉnh sửa" onclick="event.stopPropagation(); showFolderModal('${folder.id}');">${ICONS.edit}</button><button class="icon-btn p-1" title="Xóa" onclick="event.stopPropagation(); deleteFolder('${folder.id}');">${ICONS.trash}</button>`; return controls; }
        function findFolder(id, folders) { for (const folder of folders) { if (folder.id === id) return folder; if (folder.children) { const found = findFolder(id, folder.children); if (found) return found; } } return null; }
        function showSettingsModal() { document.getElementById('settings-modal').classList.remove('hidden'); document.getElementById('settings-modal').classList.add('flex'); }
        function hideSettingsModal() { document.getElementById('settings-modal').classList.add('hidden'); document.getElementById('settings-modal').classList.remove('flex'); }
        function showFolderModal(id=null, parentId=null) { const form=document.getElementById('folder-form'); form.reset(); document.getElementById('folder-modal-title').textContent = id ? 'Chỉnh sửa thư mục' : 'Thêm thư mục mới'; document.getElementById('folder-id').value = id || ''; document.getElementById('parent-folder-id').value = parentId || ''; if(id){const folder=findFolder(id,appData);document.getElementById('folder-name').value=folder.name;} document.getElementById('folder-modal').classList.remove('hidden'); document.getElementById('folder-modal').classList.add('flex'); }
        function hideFolderModal(){document.getElementById('folder-modal').classList.add('hidden');document.getElementById('folder-modal').classList.remove('flex');}
        document.getElementById('folder-form').addEventListener('submit', (e) => { e.preventDefault(); const id=document.getElementById('folder-id').value; const parentId=document.getElementById('parent-folder-id').value; const name=document.getElementById('folder-name').value.trim(); if(!name)return; if(id){const folder=findFolder(id,appData);if(folder)folder.name=name;} else{const newFolder={id:`folder-${Date.now()}`,name:name,children:[],qa:[]}; if(parentId){const parentFolder=findFolder(parentId,appData);if(parentFolder.children){parentFolder.children.push(newFolder);}else{parentFolder.children=[newFolder];}} else{appData.push(newFolder);}} saveData();renderAll();hideFolderModal(); });
        function deleteFolder(id) { if(!confirm('Bạn có chắc muốn xóa thư mục này và toàn bộ nội dung?')) return; findAndRemoveItem(id, appData); if(activeFolderId===id){ activeFolderId = appData.length > 0 ? appData[0].id : null; setActiveFolder(activeFolderId); } else { saveData(); renderAll(); } }
        function showQaModal(id=null){if(!activeFolderId){alert("Vui lòng chọn một thư mục trước!");return;} const form=document.getElementById('qa-form');form.reset(); document.getElementById('qa-modal-title').textContent = id ? 'Chỉnh sửa Q&A' : 'Thêm Q&A mới'; document.getElementById('qa-id').value = id || ''; if(id){const folder=findFolder(activeFolderId,appData);const qaItem=folder.qa.find(item=>item.id===id);document.getElementById('question-text').value=qaItem.q;document.getElementById('answer-text').value=qaItem.a;} document.getElementById('qa-modal').classList.remove('hidden');document.getElementById('qa-modal').classList.add('flex');}
        function hideQaModal(){document.getElementById('qa-modal').classList.add('hidden');document.getElementById('qa-modal').classList.remove('flex');}
        document.getElementById('qa-form').addEventListener('submit',(e)=>{e.preventDefault(); const id=document.getElementById('qa-id').value;const question=document.getElementById('question-text').value;const answer=document.getElementById('answer-text').value; const folder=findFolder(activeFolderId,appData);if(!folder)return; if(id){const qaItem=folder.qa.find(item=>item.id===id);qaItem.q=question;qaItem.a=answer;} else{folder.qa.push({id:`qa-${Date.now()}`,q:question,a:answer});} saveData();renderQAs();hideQaModal();});
        function copyQa(id){const folder=findFolder(activeFolderId,appData);const qaItem=folder.qa.find(item=>item.id===id);const newQa={...qaItem,id:`qa-${Date.now()}`};newQa.q=`${newQa.q} (Bản sao)`;folder.qa.push(newQa);saveData();renderQAs();}
        function deleteQa(id){if(!confirm('Bạn có chắc muốn xóa Q&A này?'))return;const folder=findFolder(activeFolderId,appData);folder.qa=folder.qa.filter(item=>item.id!==id);saveData();renderQAs();}
        function showMoveQaModal(qaId) { const selectEl = document.getElementById('folder-destination'); selectEl.innerHTML = ''; populateFolderSelect(selectEl, appData, 0, activeFolderId); document.getElementById('move-qa-id').value = qaId; document.getElementById('move-qa-modal').classList.remove('hidden'); document.getElementById('move-qa-modal').classList.add('flex'); }
        function hideMoveQaModal() { document.getElementById('move-qa-modal').classList.add('hidden'); document.getElementById('move-qa-modal').classList.remove('flex'); }
        document.getElementById('move-qa-form').addEventListener('submit', (e) => { e.preventDefault(); const qaId = document.getElementById('move-qa-id').value; const destFolderId = document.getElementById('folder-destination').value; if (!qaId || !destFolderId || destFolderId === activeFolderId) { hideMoveQaModal(); return; } const sourceFolder = findFolder(activeFolderId, appData); const destFolder = findFolder(destFolderId, appData); const qaIndex = sourceFolder.qa.findIndex(item => item.id === qaId); if (sourceFolder && destFolder && qaIndex > -1) { const [qaItem] = sourceFolder.qa.splice(qaIndex, 1); destFolder.qa.push(qaItem); saveData(); renderQAs(); } hideMoveQaModal(); });
        function populateFolderSelect(selectElement, folders, level, currentFolderId) { folders.forEach(folder => { const option = document.createElement('option'); option.value = folder.id; option.textContent = `${'—'.repeat(level)} ${folder.name}`; option.disabled = folder.id === currentFolderId; selectElement.appendChild(option); if (folder.children && folder.children.length > 0) { populateFolderSelect(selectElement, folder.children, level + 1, currentFolderId); } }); }

    </script>
</body>
</html>
