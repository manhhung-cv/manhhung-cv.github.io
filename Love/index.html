<!DOCTYPE html>
<html lang="vi">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
    <title>Love Story - Kỷ niệm tình yêu</title>

    <!-- PWA & iOS Full-Screen Meta Tags -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Love Story">
    <meta name="theme-color" content="#fde4e4">
    <link rel="apple-touch-icon" href="https://i.ibb.co/b3cK7s6/apple-touch-icon.png">

    <!-- Fonts and Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Quicksand:wght@300..700&display=swap" rel="stylesheet">
    
    <style>
        /* Love Story - CSS Responsive Design */
        /* Tối ưu hóa với Mobile-first approach */

        /* ===== RESET & BASE STYLES ===== */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --primary-color: #FF6B6B;
            --primary-dark: #E63946;
            --secondary-color: #4ECDC4;
            --accent-color: #F9C74F;
            --success-color: #34C759;
            --danger-color: #FF3B30;
            --blue-color: #007AFF;

            --background-primary: #FEF9F9;
            --background-secondary: #FFFFFF;
            --background-tertiary: #F8F9FA;
            --surface-elevated: rgba(255, 255, 255, 0.9);

            --text-primary: #333333;
            --text-secondary: #555555;
            --text-tertiary: #8E8E93;
            --text-quaternary: #C7C7CC;

            --border-color: #EAEAEA;
            --divider-color: #F0F0F0;

            --shadow-light: 0 2px 8px rgba(0, 0, 0, 0.07);
            --shadow-medium: 0 6px 15px rgba(0, 0, 0, 0.1);
            --shadow-heavy: 0 10px 30px rgba(0, 0, 0, 0.12);

            --radius-small: 8px;
            --radius-medium: 12px;
            --radius-large: 16px;
            --radius-xl: 20px;

            --spacing-xs: 4px;
            --spacing-sm: 8px;
            --spacing-md: 16px;
            --spacing-lg: 24px;
            --spacing-xl: 32px;

            --font-family: 'Quicksand', -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', 'Helvetica Neue', Arial, sans-serif;
            --font-size-base: 16px;

            --transition-fast: 0.15s ease-out;
            --transition-normal: 0.25s ease-out;
            --transition-slow: 0.35s ease-out;
        }

        html, body {
            height: 100%;
            width: 100%;
            overflow-x: hidden;
        }

        body {
            font-family: var(--font-family);
            font-size: var(--font-size-base);
            line-height: 1.6;
            color: var(--text-primary);
            background-color: var(--background-primary);
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }

        /* ===== UTILITY CLASSES ===== */
        .hidden { display: none !important; }
        .text-center { text-align: center; }
        .text-right { text-align: right; }
        .justify-center { justify-content: center; }
        .z-index-high { z-index: 9999; }

        /* ===== LOADING OVERLAY ===== */
        .loading-overlay {
            position: fixed; inset: 0;
            background: rgba(255, 255, 255, 0.7);
            backdrop-filter: blur(10px);
            display: flex; align-items: center; justify-content: center;
            z-index: 10000;
            transition: opacity var(--transition-normal);
        }
        .loading-content {
            background: var(--surface-elevated); padding: var(--spacing-xl);
            border-radius: var(--radius-large); text-align: center;
            box-shadow: var(--shadow-heavy);
        }
        .heart-icon { font-size: 32px; color: var(--primary-color); margin-bottom: var(--spacing-md); }
        .heart-beat { animation: heartbeat 1.5s ease-in-out infinite; }
        @keyframes heartbeat {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.1); }
        }
        .loading-text { color: var(--text-secondary); font-size: 14px; }

        /* ===== SCREEN LAYOUTS ===== */
        .screen {
            min-height: 100vh; display: flex;
            align-items: center; justify-content: center;
            padding: var(--spacing-lg);
        }

        /* ===== CARDS ===== */
        .card {
            background: var(--background-secondary); border-radius: var(--radius-large);
            padding: var(--spacing-lg); box-shadow: var(--shadow-medium);
            border: 1px solid var(--divider-color);
            transition: transform var(--transition-normal), box-shadow var(--transition-normal);
            width: 100%;
        }
        .auth-card { max-width: 400px; }
        .card-title {
            font-size: 24px; font-weight: 700; color: var(--text-primary);
            margin-bottom: var(--spacing-lg); text-align: center;
        }
        .card-subtitle {
            font-size: 14px; color: var(--text-secondary);
            margin-bottom: var(--spacing-lg); text-align: center;
        }

        /* ===== FORM ELEMENTS ===== */
        .input-field, .textarea-field, .select-field {
            width: 100%; padding: 14px var(--spacing-md);
            border: 1px solid var(--border-color); border-radius: var(--radius-medium);
            font-size: var(--font-size-base); background: var(--background-secondary);
            color: var(--text-primary); transition: all var(--transition-fast);
            -webkit-appearance: none; margin-bottom: var(--spacing-md);
        }
        .input-field:focus, .textarea-field:focus, .select-field:focus {
            outline: none; border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(255, 107, 107, 0.2);
        }
        .input-field::placeholder { color: var(--text-tertiary); }
        .textarea-field { resize: vertical; min-height: 120px; }
        .input-field:last-child, .textarea-field:last-child, .select-field:last-child { margin-bottom: 0; }
        
        /* ===== BUTTONS ===== */
        .btn {
            display: inline-flex; align-items: center; justify-content: center;
            gap: var(--spacing-sm); padding: 14px var(--spacing-lg);
            border: none; border-radius: var(--radius-medium);
            font-size: var(--font-size-base); font-weight: 600;
            cursor: pointer; transition: all var(--transition-fast);
            user-select: none; -webkit-tap-highlight-color: transparent;
        }
        .btn:active { transform: translateY(1px) scale(0.98); }
        .btn-primary { background: var(--primary-color); color: white; }
        .btn-secondary { background: var(--background-tertiary); color: var(--text-primary); border: 1px solid var(--border-color); }
        .btn-blue { background: var(--blue-color); color: white; }
        .btn-cancel { background: var(--background-tertiary); color: var(--text-secondary); }
        .btn-danger { background: var(--danger-color); color: white; }
        .btn-full-width { width: 100%; }
        .icon { font-size: 14px; }
        .close-btn { background: none; border: none; font-size: 20px; color: var(--text-tertiary); cursor: pointer; }

        /* ===== AUTHENTICATION ===== */
        #auth-container > div { display: flex; flex-direction: column; gap: var(--spacing-md); }
        .error-message {
            color: var(--danger-color); font-size: 14px; padding: var(--spacing-sm);
            background: rgba(255, 59, 48, 0.1); border-radius: var(--radius-small);
            border-left: 3px solid var(--danger-color); text-align: center;
        }
        .auth-switch { text-align: center; margin-top: var(--spacing-lg); color: var(--text-secondary); font-size: 14px; }
        .link { color: var(--primary-color); text-decoration: none; font-weight: 600; }

        /* ===== MAIN APP LAYOUT ===== */
        #main-app { padding-bottom: 100px; }

        /* ===== NAVIGATION ===== */
        .main-nav {
            position: fixed; bottom: 0; left: 0; right: 0;
            z-index: 1000; padding: var(--spacing-sm);
            padding-bottom: calc(var(--spacing-sm) + env(safe-area-inset-bottom));
            background: rgba(255, 255, 255, 0.85);
            backdrop-filter: blur(15px); -webkit-backdrop-filter: blur(15px);
            border-top: 1px solid var(--divider-color);
        }
        .nav-wrapper { display: flex; justify-content: space-around; max-width: 500px; margin: 0 auto; }
        .nav-link {
            cursor: pointer; display: flex; flex-direction: column;
            align-items: center; justify-content: center; gap: var(--spacing-xs);
            padding: var(--spacing-sm); border-radius: var(--radius-medium);
            text-decoration: none; color: var(--text-tertiary);
            font-weight: 500; transition: all var(--transition-fast);
            flex-grow: 1; text-align: center; font-size: 11px;
        }
        .nav-link i { font-size: 20px; }
        .nav-link.active { color: var(--primary-color); }
        .nav-link .nav-text { transform: scale(0.9); opacity: 0.8; transition: all var(--transition-fast); }
        .nav-link.active .nav-text { transform: scale(1); opacity: 1; font-weight: 700; }

        /* ===== TAB CONTENT ===== */
        .tab-content { display: none; animation: fadeIn var(--transition-slow); }
        .tab-content.padding { padding: var(--spacing-md); }
        .tab-content.active { display: block; }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        /* ===== MAIN PAGE - COUNTER ===== */
        .counter-card { background: linear-gradient(135deg, #FF6B6B, #FF8E53); color: white; border: none; padding: var(--spacing-lg); border-radius: var(--radius-xl); }
        .counter-title { font-size: 18px; font-weight: 600; margin: 0; }
        .day-counter { font-size: 4rem; font-weight: 700; text-shadow: 0 2px 4px rgba(0, 0, 0, 0.15); }
        .ymd-counter { font-size: 16px; opacity: 0.9; }

        /* ===== GAME SCENE ===== */
        .game-scene-background {
            background-size: cover; background-position: center; min-height: 100vh;
            width: 100%; position: relative; display: flex;
            flex-direction: column; justify-content: space-between;
            padding: var(--spacing-lg) var(--spacing-lg) 120px; overflow: hidden;
        }
        .game-scene-background::before { content: ''; position: absolute; inset: 0; background: linear-gradient(to top, rgba(0, 0, 0, 0.2), transparent); }
        .game-scene-background .box { display: flex; justify-content: space-around; width: 100%; position: relative; }
        .character-container { position: relative; text-align: center; }
        .character {
            width: 100px; height: 100px; border-radius: 50%;
            background-size: cover; background-position: center;
            border: 4px solid white; box-shadow: var(--shadow-medium);
            margin: 0 auto var(--spacing-sm);
        }
        .char-name { text-align: center; color: white; font-weight: 600; text-shadow: 0 1px 3px rgba(0, 0, 0, 0.4); font-size: 18px; }
        .speech-bubble {
            position: absolute; bottom: 120px; left: 50%;
            transform: translateX(-50%); background: white; padding: var(--spacing-sm) var(--spacing-md);
            border-radius: var(--radius-medium); box-shadow: var(--shadow-medium); max-width: 180px;
            font-size: 14px; color: var(--text-primary); z-index: 10;
        }
        .speech-bubble::after { content: ''; position: absolute; top: 100%; left: 50%; transform: translateX(-50%); border: 8px solid transparent; border-top-color: white; }
        .edit-feeling-btn {
            background: var(--primary-color); color: white; border: none;
            border-radius: 50%; width: 24px; height: 24px;
            display: flex; align-items: center; justify-content: center;
            font-size: 10px; cursor: pointer; position: absolute; top: -8px; right: -8px;
        }
        .feeling-countdown { font-size: 10px; color: var(--text-tertiary); margin-top: var(--spacing-xs); }
        
        /* ===== STREAK LOVE & GENERAL SECTIONS ===== */
        .content-section { margin-bottom: var(--spacing-lg); }
        .section-title { font-size: 24px; font-weight: 700; margin-bottom: var(--spacing-lg); text-align: center; }
        .orange-title { color: var(--accent-color); }
        .section-title.with-border { border-bottom: 1px solid var(--divider-color); padding-bottom: var(--spacing-md); }
        .streak-heart { font-size: 4rem; color: var(--primary-color); margin-bottom: var(--spacing-lg); }
        .streak-count { font-size: 3rem; font-weight: 800; color: var(--primary-color); margin: 0; }
        .streak-unit { font-size: 18px; color: var(--text-secondary); margin-bottom: var(--spacing-lg); }
        .check-in-btn { margin-bottom: var(--spacing-xl); padding: 18px var(--spacing-xl); font-size: 18px; }
        .check-in-btn:disabled { background: var(--background-tertiary); color: var(--text-tertiary); cursor: not-allowed; }
        .check-in-status { display: flex; justify-content: space-around; gap: var(--spacing-lg); }
        .partner-status { text-align: center; }
        .partner-name { font-weight: 600; margin-bottom: var(--spacing-sm); color: var(--text-primary); }
        .status-icon-success { color: var(--success-color); font-size: 20px; }
        .status-icon-fail { color: var(--text-quaternary); font-size: 20px; }

        /* ===== STORY & EVENTS SECTION ===== */
        .fab-container { position: fixed; bottom: calc(90px + env(safe-area-inset-bottom)); right: var(--spacing-md); z-index: 99; display: flex; flex-direction: column; gap: var(--spacing-md);}
        .fab {
            width: 56px; height: 56px; border-radius: var(--radius-large);
            color: white; border: none; display: flex; align-items: center; justify-content: center;
            box-shadow: var(--shadow-medium); font-size: 22px; cursor: pointer;
        }
        #add-story-fab { background-color: var(--accent-color); }
        #add-event-fab { background-color: var(--blue-color); }

        .story-feed, .event-list { display: flex; flex-direction: column; gap: var(--spacing-lg); }
        .story-card, .event-card {
            background: var(--background-secondary); border-radius: var(--radius-large);
            overflow: hidden; box-shadow: var(--shadow-light);
            border: 1px solid var(--divider-color); position: relative;
        }
        .story-body { padding: var(--spacing-lg); }
        .story-author-info { display: flex; align-items: center; gap: var(--spacing-md); margin-bottom: var(--spacing-lg); }
        .author-avatar { width: 40px; height: 40px; border-radius: 50%; object-fit: cover; }
        .author-name { font-weight: 600; color: var(--text-primary); margin: 0; }
        .story-timestamp { font-size: 12px; color: var(--text-tertiary); margin: 0; }
        .story-title { font-size: 18px; font-weight: 700; margin-bottom: var(--spacing-sm); color: var(--text-primary); }
        .story-content { color: var(--text-secondary); line-height: 1.6; white-space: pre-wrap; }
        .story-actions-footer { padding: var(--spacing-sm) var(--spacing-lg); background: var(--background-tertiary); border-top: 1px solid var(--divider-color); display: flex; align-items: center; gap: var(--spacing-md); }
        .like-btn, .message-story-btn { background: none; border: none; color: var(--text-tertiary); cursor: pointer; padding: var(--spacing-sm); font-size: 18px; transition: color var(--transition-fast); display: flex; align-items: center; gap: var(--spacing-sm); }
        .like-btn.liked { color: var(--primary-color); }
        .delete-btn { position: absolute; top: var(--spacing-md); right: var(--spacing-md); background: rgba(255, 59, 48, 0.1); color: var(--danger-color); border: none; border-radius: 50%; width: 32px; height: 32px; display: flex; align-items: center; justify-content: center; cursor: pointer; font-size: 14px; }
        
        .event-card { display: flex; align-items: center; gap: var(--spacing-md); padding: var(--spacing-md); }
        .event-image { width: 60px; height: 60px; border-radius: var(--radius-medium); object-fit: cover; flex-shrink: 0; }
        .event-title { font-size: 16px; font-weight: 700; margin-bottom: var(--spacing-xs); }
        .event-details { font-size: 14px; color: var(--text-secondary); margin: 0; }
        .event-countdown { text-align: right; margin-left: auto; }
        .event-days-count { font-size: 22px; font-weight: 700; color: var(--primary-color); }
        .event-days-label { font-size: 12px; color: var(--text-tertiary); }
        
        /* ===== SETTINGS ===== */
        .setting-group { margin-bottom: var(--spacing-lg); }
        .setting-label { display: block; font-weight: 600; margin-bottom: var(--spacing-sm); color: var(--text-secondary); }
        .setting-note { font-size: 14px; color: var(--text-tertiary); margin-top: var(--spacing-sm); padding: var(--spacing-sm); background: var(--background-tertiary); border-radius: var(--radius-small); border-left: 3px solid var(--accent-color); }
        .input-group { display: flex; align-items: center; }
        .input-group .input-field { margin-bottom: 0; border-top-right-radius: 0; border-bottom-right-radius: 0; }
        .input-group .btn { border-top-left-radius: 0; border-bottom-left-radius: 0; }
        .partner-setting-group { margin-top: var(--spacing-xl); padding-top: var(--spacing-xl); border-top: 1px solid var(--divider-color); }

        /* ===== CHAT POPUP ===== */
        .chat-fab {
            position: fixed; bottom: calc(90px + env(safe-area-inset-bottom)); right: var(--spacing-md);
            width: 56px; height: 56px; background: var(--primary-color); color: white;
            border-radius: var(--radius-large); font-size: 24px; cursor: pointer;
            box-shadow: var(--shadow-medium); transition: all var(--transition-normal);
            display: flex; align-items: center; justify-content: center; z-index: 1001;
        }
        .chat-popup {
            position: fixed; inset: 0; background: var(--background-primary);
            display: flex; flex-direction: column; transform: translateY(100%);
            transition: transform var(--transition-slow); z-index: 1002;
        }
        .chat-popup.active { transform: translateY(0); }
        .chat-header {
            padding: var(--spacing-md); padding-top: calc(var(--spacing-md) + env(safe-area-inset-top));
            border-bottom: 1px solid var(--divider-color); display: flex;
            align-items: center; justify-content: space-between;
            background: var(--background-secondary); flex-shrink: 0;
        }
        .chat-header.secret-mode { background: #1c1c1e; color: white; }
        .chat-header.secret-mode .close-btn { color: white; }
        .chat-messages {
            flex: 1; padding: var(--spacing-md); overflow-y: auto;
            display: flex; flex-direction: column-reverse; gap: var(--spacing-md);
        }
        .message-container { display: flex; align-items: flex-start; gap: var(--spacing-sm); max-width: 85%; }
        .message-container.is-me { align-self: flex-end; flex-direction: row-reverse; }
        .message-container.is-other { align-self: flex-start; }
        .message-bubble { padding: 10px var(--spacing-md); border-radius: var(--radius-xl); font-size: 15px; word-wrap: break-word; }
        .message-bubble.is-me { background: var(--primary-color); color: white; border-bottom-right-radius: var(--radius-small); }
        .message-bubble.is-other { background: var(--background-secondary); color: var(--text-primary); border: 1px solid var(--divider-color); border-bottom-left-radius: var(--radius-small); }
        .chat-input-area {
            padding: var(--spacing-sm) var(--spacing-md); padding-bottom: calc(var(--spacing-sm) + env(safe-area-inset-bottom));
            border-top: 1px solid var(--divider-color); background: var(--background-secondary); flex-shrink: 0; position: relative;
        }
        .chat-input-wrapper { display: flex; align-items: center; gap: var(--spacing-sm); }
        .chat-input { flex: 1; border: none; background: var(--background-tertiary); border-radius: var(--radius-xl); padding: 12px var(--spacing-md); font-size: 15px; outline: none; }
        .chat-send-btn { background: var(--primary-color); color: white; border: none; width: 44px; height: 44px; border-radius: 50%; display: flex; align-items: center; justify-content: center; cursor: pointer; flex-shrink: 0; }
        .command-popup {
            position: absolute; bottom: 100%; left: var(--spacing-md); right: var(--spacing-md);
            background: var(--surface-elevated); border-radius: var(--radius-medium); box-shadow: var(--shadow-medium);
            border: 1px solid var(--divider-color); margin-bottom: var(--spacing-sm); overflow: hidden;
        }
        .command-btn { width: 100%; background: none; border: none; padding: var(--spacing-sm) var(--spacing-md); text-align: left; cursor: pointer; font-size: 14px; color: var(--text-secondary); }
        .command-btn:hover { background: var(--background-tertiary); }
        .chat-mode-btn { font-size: 12px; padding: var(--spacing-xs) var(--spacing-sm); }

        /* ===== MODALS ===== */
        .modal-backdrop {
            position: fixed; inset: 0; background: rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(10px); display: flex; align-items: center; justify-content: center;
            z-index: 2000; padding: var(--spacing-lg);
        }
        .modal-content {
            background: var(--surface-elevated); border-radius: var(--radius-large);
            padding: var(--spacing-lg); width: 100%; max-width: 500px;
            box-shadow: var(--shadow-heavy); animation: modalSlideIn var(--transition-normal);
        }
        @keyframes modalSlideIn {
            from { opacity: 0; transform: translateY(-20px) scale(0.95); }
            to { opacity: 1; transform: translateY(0) scale(1); }
        }
        .modal-title { font-size: 20px; font-weight: 700; margin-bottom: var(--spacing-lg); color: var(--text-primary); text-align: center; }
        .modal-actions { display: flex; gap: var(--spacing-md); margin-top: var(--spacing-xl); }
        .modal-actions .btn { flex-grow: 1; }
        .confirm-message { font-size: var(--font-size-base); color: var(--text-secondary); margin-bottom: var(--spacing-lg); text-align: center; }
    </style>
</head>

<body>
    <!-- Overlay tải trang -->
    <div id="loading-overlay" class="loading-overlay hidden">
        <div class="loading-content">
            <i class="fas fa-heart heart-icon heart-beat"></i>
            <p id="loading-text" class="loading-text">Đang xử lý...</p>
        </div>
    </div>

    <!-- Màn hình xác thực -->
    <div id="auth-screen" class="screen">
        <div class="card auth-card">
            <div id="auth-container">
                <div id="login-form">
                    <h2 class="card-title">Đăng Nhập</h2>
                    <div id="login-error" class="error-message" style="display: none;"></div>
                    <input id="login-email" type="email" placeholder="Email" class="input-field" autocomplete="email">
                    <input id="login-password" type="password" placeholder="Mật khẩu" class="input-field" autocomplete="current-password">
                    <button id="login-btn" class="btn btn-primary btn-full-width">Đăng Nhập</button>
                    <p class="auth-switch">Chưa có tài khoản? <a href="#" id="show-register" class="link">Đăng ký ngay</a></p>
                </div>
                <div id="register-form" class="hidden">
                    <h2 class="card-title">Đăng Ký</h2>
                    <div id="register-error" class="error-message" style="display: none;"></div>
                    <input id="register-email" type="email" placeholder="Email" class="input-field" autocomplete="email">
                    <input id="register-password" type="password" placeholder="Mật khẩu" class="input-field" autocomplete="new-password">
                    <input id="register-invite-code" type="text" placeholder="Mã mời" class="input-field">
                    <button id="register-btn" class="btn btn-primary btn-full-width">Đăng Ký</button>
                    <p class="auth-switch">Đã có tài khoản? <a href="#" id="show-login" class="link">Đăng nhập</a></p>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Màn hình mã cặp đôi -->
    <div id="couple-code-screen" class="screen hidden">
        <div class="card text-center">
            <h2 class="card-title">Mã Cặp Đôi</h2>
            <p class="card-subtitle">Nhập mã để tham gia, hoặc nhập mã riêng của bạn để tạo mới.</p>
            <div id="couple-code-error" class="error-message" style="display: none;"></div>
            <input id="couple-code-input" type="text" placeholder="Nhập mã cặp đôi..." class="input-field text-center">
            <button id="join-couple-btn" class="btn btn-primary btn-full-width" style="margin-top: 16px;">Tham Gia</button>
            <button id="create-custom-couple-btn" class="btn btn-secondary btn-full-width" style="margin-top: 8px;">Tạo Cặp Đôi với Mã Này</button>
        </div>
    </div>

    <!-- Màn hình thiết lập Profile -->
    <div id="profile-setup-screen" class="screen hidden">
        <div class="card">
            <h2 class="card-title">Thiết Lập Thông Tin</h2>
            <div id="profile-setup-error" class="error-message" style="display: none;"></div>
            <input id="profile-name" type="text" placeholder="Tên của bạn" class="input-field">
            <input id="profile-dob" type="text" onfocus="(this.type='date')" onblur="(this.type='text')" placeholder="Ngày sinh" class="input-field">
            <select id="profile-gender" class="input-field select-field">
                <option value="" disabled selected>Chọn giới tính</option>
                <option value="male">Nam</option>
                <option value="female">Nữ</option>
            </select>
            <button id="save-profile-btn" class="btn btn-primary btn-full-width">Lưu Thông Tin</button>
        </div>
    </div>
    
    <!-- Ứng dụng chính -->
    <div id="main-app" class="hidden">
        <main>
            <!-- Nội dung các tab -->
            <div id="main-content" class="tab-content active">
                <div id="game-scene" class="game-scene-background">
                    <div class="card text-center counter-card">
                        <h2 class="counter-title">Chúng ta đã bên nhau</h2>
                        <div id="day-counter" class="day-counter">...</div>
                        <div id="ymd-counter" class="ymd-counter">... năm ... tháng ... ngày</div>
                    </div>
                    <div class="box">
                        <div id="partner-1-char-container" class="character-container"></div>
                        <div id="partner-2-char-container" class="character-container"></div>
                    </div>
                </div>
            </div>

            <div id="streak-content" class="tab-content padding">
                <div class="card text-center content-section">
                    <h2 class="section-title orange-title">Streak Love</h2>
                    <div id="streak-heart-container" class="streak-heart"><i class="fas fa-heart"></i></div>
                    <p id="streak-count" class="streak-count">0</p>
                    <p class="streak-unit">ngày</p>
                    <button id="check-in-btn" class="btn btn-primary check-in-btn"><i class="fas fa-calendar-check icon"></i> Điểm danh hôm nay</button>
                    <div class="check-in-status">
                        <div id="partner1-checkin-status" class="partner-status">
                            <p class="partner-name">Bạn</p><i class="fas fa-times-circle status-icon-fail"></i>
                        </div>
                        <div id="partner2-checkin-status" class="partner-status">
                            <p class="partner-name">Nửa kia</p><i class="fas fa-times-circle status-icon-fail"></i>
                        </div>
                    </div>
                </div>
            </div>

            <div id="story-content" class="tab-content padding">
                <div class="card" style="padding: var(--spacing-sm) var(--spacing-md); margin-bottom: var(--spacing-lg);">
                    <button id="toggle-filters-btn" class="btn" style="width: 100%; justify-content: space-between; background: none;">
                        <span><i class="fas fa-filter icon"></i> Bộ lọc</span>
                        <i class="fas fa-chevron-down filter-chevron"></i>
                    </button>
                    <div id="filter-controls" style="max-height: 0; overflow: hidden; transition: max-height 0.3s ease-out;">
                         <div style="padding-top: var(--spacing-md);">
                             <select id="filter-author" class="input-field"><option value="all">Tất cả người đăng</option></select>
                             <input type="date" id="filter-date" class="input-field">
                             <select id="sort-stories" class="input-field">
                                 <option value="desc">Mới nhất</option>
                                 <option value="asc">Cũ nhất</option>
                             </select>
                             <button id="reset-filters-btn" class="btn btn-secondary btn-full-width">Xóa bộ lọc</button>
                         </div>
                    </div>
                </div>
                <div id="story-feed" class="story-feed"></div>
            </div>
            
            <div id="events-content" class="tab-content padding">
                 <div id="event-list" class="event-list"></div>
            </div>

            <div id="settings-content" class="tab-content padding">
                 <div class="card content-section">
                    <h2 class="section-title with-border">Cài Đặt</h2>
                    
                    <div class="setting-group">
                        <label class="setting-label">Mã Cặp Đôi của bạn:</label>
                        <div class="input-group">
                            <input id="setting-couple-code" type="text" readonly class="input-field">
                            <button id="copy-code-btn" class="btn btn-secondary"><i class="fas fa-copy"></i></button>
                        </div>
                    </div>
                     <div class="setting-group">
                        <label class="setting-label">Ngày bắt đầu yêu</label>
                        <input id="setting-start-date" type="date" class="input-field">
                    </div>
                    <div class="setting-group">
                        <label class="setting-label">URL Nền Trang Chính</label>
                        <input id="setting-game-background" type="text" placeholder="Dán URL hình ảnh nền..." class="input-field">
                    </div>

                    <h3 class="section-title with-border" style="font-size: 20px; text-align: left; margin-top: var(--spacing-xl);">Đổi Mã Cặp Đôi</h3>
                    <div class="setting-group">
                        <p class="setting-note">Lưu ý: Hành động này sẽ thay đổi mã cho cả hai bạn. Mã cũ sẽ không còn hiệu lực.</p>
                        <div class="input-group">
                            <input id="setting-new-couple-code" type="text" placeholder="Nhập mã mới" class="input-field">
                            <button id="change-code-btn" class="btn btn-blue">Đổi</button>
                        </div>
                        <div id="change-code-error" class="error-message" style="display: none;"></div>
                    </div>

                    <h3 class="section-title with-border" style="font-size: 20px; text-align: left; margin-top: var(--spacing-xl);">Thông Tin Cá Nhân</h3>
                    <div id="settings-partner-1"></div>
                    <div id="settings-partner-2" class="partner-setting-group"></div>

                    <button id="save-settings-btn" class="btn btn-primary btn-full-width" style="margin-top: 16px;">Lưu Thay Đổi</button>
                    <button id="logout-btn" class="btn btn-danger btn-full-width" style="margin-top: 8px;">Đăng Xuất</button>
                </div>
            </div>

        </main>
        
        <div class="fab-container">
            <button id="add-event-fab" class="fab hidden"><i class="fas fa-calendar-plus"></i></button>
            <button id="add-story-fab" class="fab hidden"><i class="fas fa-plus"></i></button>
            <button id="chat-fab" class="fab hidden"><i class="fas fa-comments"></i></button>
        </div>
        
        <nav class="main-nav">
            <div class="nav-wrapper">
                <a class="nav-link active" data-tab="main"><i class="fas fa-heart"></i><span class="nav-text">Chính</span></a>
                <a class="nav-link" data-tab="streak"><i class="fas fa-fire-alt"></i><span class="nav-text">Streak</span></a>
                <a class="nav-link" data-tab="story"><i class="fas fa-book-open"></i><span class="nav-text">Story</span></a>
                <a class="nav-link" data-tab="events"><i class="fas fa-calendar-alt"></i><span class="nav-text">Sự kiện</span></a>
                <a class="nav-link" data-tab="settings"><i class="fas fa-cog"></i><span class="nav-text">Cài đặt</span></a>
            </div>
        </nav>
    </div>

    <!-- Chat Popup -->
    <div id="chat-popup" class="chat-popup">
        <div id="chat-header" class="chat-header">
            <div>
                 <h3 style="margin: 0; font-size: 18px;">Trò chuyện</h3>
                 <button id="toggle-chat-mode-btn" class="btn btn-secondary chat-mode-btn"></button>
            </div>
            <button id="close-chat-btn" class="close-btn"><i class="fas fa-times"></i></button>
        </div>
        <div id="chat-messages" class="chat-messages"></div>
        <div class="chat-input-area">
            <div id="command-popup" class="command-popup hidden">
                <button class="command-btn" data-command="@del-me">@del-me: Xóa tin nhắn của bạn</button>
                <button class="command-btn" data-command="@del-all">@del-all: Xóa toàn bộ cuộc trò chuyện</button>
                <button class="command-btn" data-command="@feel">@feel: Đặt cảm nhận mới</button>
            </div>
            <div class="chat-input-wrapper">
                <button id="command-toggle-btn" class="btn btn-secondary" style="padding: 10px; border-radius: 50%; width: 44px; height: 44px;">
                    <i class="fas fa-at"></i>
                </button>
                <input id="chat-input" type="text" placeholder="Nhập tin nhắn..." class="chat-input">
                <button id="chat-send-btn" class="chat-send-btn"><i class="fas fa-paper-plane"></i></button>
            </div>
        </div>
    </div>
    
    <!-- Modals -->
    <div id="story-modal" class="modal-backdrop hidden">
        <div class="modal-content">
            <h2 class="modal-title">Viết Story Mới</h2>
            <input id="story-title" type="text" placeholder="Tiêu đề" class="input-field">
            <textarea id="story-textarea" rows="6" placeholder="Bạn đang nghĩ gì..." class="textarea-field"></textarea>
            <input id="story-location" type="text" placeholder="Vị trí (ví dụ: Cafe The Lofi)" class="input-field">
            <input id="story-tags" type="text" placeholder="Gắn thẻ (ví dụ: #kiniem, #henho)" class="input-field">
            <div class="modal-actions">
                <button id="cancel-story-btn" class="btn btn-secondary">Hủy</button>
                <button id="post-story-btn" class="btn btn-primary">Đăng</button>
            </div>
        </div>
    </div>
    
    <div id="feeling-modal" class="modal-backdrop hidden">
        <div class="modal-content">
            <h2 class="modal-title">Cảm nhận của bạn</h2>
            <input id="feeling-input" type="text" placeholder="Hôm nay bạn thấy thế nào?" class="input-field">
            <div class="setting-group">
                <label class="setting-label">Xóa sau:</label>
                <select id="feeling-duration" class="select-field">
                    <option value="infinite">Không bao giờ</option>
                    <option value="15">15 giây</option>
                    <option value="1800">30 phút</option>
                    <option value="3600">1 giờ</option>
                    <option value="86400">24 giờ</option>
                </select>
            </div>
            <div class="modal-actions">
                <button id="cancel-feeling-btn" class="btn btn-secondary">Hủy</button>
                <button id="save-feeling-btn" class="btn btn-primary">Lưu</button>
            </div>
        </div>
    </div>

    <div id="event-modal" class="modal-backdrop hidden">
        <div class="modal-content">
            <h2 class="modal-title" style="color: var(--blue-color);">Thêm Sự Kiện Mới</h2>
            <input id="event-name" type="text" placeholder="Tên sự kiện" class="input-field">
            <input id="event-date" type="date" class="input-field">
            <input id="event-image-url" type="text" placeholder="URL hình ảnh (tùy chọn)" class="input-field">
            <select id="event-repeat" class="select-field">
                <option value="none">Không lặp lại</option>
                <option value="yearly">Mỗi năm</option>
            </select>
            <div class="modal-actions">
                <button id="cancel-event-btn" class="btn btn-secondary">Hủy</button>
                <button id="save-event-btn" class="btn btn-blue">Lưu</button>
            </div>
        </div>
    </div>

    <div id="confirm-modal" class="modal-backdrop hidden z-index-high">
        <div class="modal-content text-center">
            <p id="confirm-message" class="confirm-message"></p>
            <div class="modal-actions justify-center">
                <button id="confirm-cancel-btn" class="btn btn-secondary">Hủy</button>
                <button id="confirm-ok-btn" class="btn btn-danger">OK</button>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, setDoc, updateDoc, collection, addDoc, query, where, onSnapshot, orderBy, Timestamp, writeBatch, deleteDoc, arrayUnion, arrayRemove, increment, getDocs } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyAr9tTx-Q0OWrJ4Iaslb33-o1PJLe1S3GQ",
            authDomain: "lovstory-b6e07.firebaseapp.com",
            projectId: "lovstory-b6e07",
            storageBucket: "lovstory-b6e07.appspot.com",
            messagingSenderId: "810969018898",
            appId: "1:810969018898:web:c8e525581a77ed7d515ecb",
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // Global State
        let currentUser = null, userId = null, coupleCode = null, coupleData = null;
        let allStories = [];
        let feelingCountdownInterval = null;
        let currentChatMode = 'normal';
        let wasInSecretChat = false;

        // Unsubscribe functions
        let unsubscribers = [];

        // DOM Elements
        const $ = (selector) => document.querySelector(selector);
        const $$ = (selector) => document.querySelectorAll(selector);

        // --- UTILITY FUNCTIONS ---
        const showView = (viewId) => {
            $$('.screen, #main-app').forEach(el => el.classList.add('hidden'));
            $(`#${viewId}`).classList.remove('hidden');
            $('#loading-overlay').classList.add('hidden');
        };

        const showError = (divId, message) => {
            const errorDiv = $(`#${divId}`);
            errorDiv.textContent = message;
            errorDiv.style.display = message ? 'block' : 'none';
        };

        const showConfirm = (message, onOk, onCancel = () => {}) => {
            $('#confirm-message').textContent = message;
            $('#confirm-cancel-btn').classList.remove('hidden');
            $('#confirm-modal').classList.remove('hidden');

            const okBtn = $('#confirm-ok-btn');
            const cancelBtn = $('#confirm-cancel-btn');

            const cleanup = () => {
                $('#confirm-modal').classList.add('hidden');
                okBtn.replaceWith(okBtn.cloneNode(true));
                cancelBtn.replaceWith(cancelBtn.cloneNode(true));
            };

            okBtn.addEventListener('click', () => { onOk(); cleanup(); }, { once: true });
            cancelBtn.addEventListener('click', () => { onCancel(); cleanup(); }, { once: true });
        };

        const showAlert = (message) => {
            showConfirm(message, () => {});
            $('#confirm-cancel-btn').classList.add('hidden');
        };
        
        const cleanupListeners = () => {
            unsubscribers.forEach(unsub => unsub());
            unsubscribers = [];
            if (feelingCountdownInterval) clearInterval(feelingCountdownInterval);
        };

        // --- AUTHENTICATION ---
        onAuthStateChanged(auth, async (user) => {
            cleanupListeners();
            if (user) {
                currentUser = user;
                userId = user.uid;
                const userDoc = await getDoc(doc(db, "users", userId));

                if (userDoc.exists() && userDoc.data().coupleCode) {
                    coupleCode = userDoc.data().coupleCode;
                    setupRealtimeListeners();
                    showView('main-app');
                    $$('.fab, #chat-fab').forEach(el => el.classList.remove('hidden'));
                    feelingCountdownInterval = setInterval(updateFeelingCountdowns, 1000);
                } else {
                    showView('couple-code-screen');
                }
            } else {
                currentUser = null;
                showView('auth-screen');
                 $$('.fab, #chat-fab').forEach(el => el.classList.add('hidden'));
                $('#chat-popup').classList.remove('active');
            }
        });

        $('#show-register').addEventListener('click', (e) => { e.preventDefault(); $('#login-form').classList.add('hidden'); $('#register-form').classList.remove('hidden'); });
        $('#show-login').addEventListener('click', (e) => { e.preventDefault(); $('#register-form').classList.add('hidden'); $('#login-form').classList.remove('hidden'); });
        
        $('#register-btn').addEventListener('click', async () => {
            const [email, password, inviteCode] = ['#register-email', '#register-password', '#register-invite-code'].map(s => $(s).value);
            if (!email || !password || !inviteCode) return showError('register-error', 'Vui lòng nhập đủ thông tin.');
            showError('register-error', '');
            try {
                // Not checking invite code for now for easier testing.
                await createUserWithEmailAndPassword(auth, email, password);
            } catch (error) { showError('register-error', `Lỗi: ${error.message}`); }
        });

        $('#login-btn').addEventListener('click', async () => {
            const [email, password] = ['#login-email', '#login-password'].map(s => $(s).value);
            if (!email || !password) return showError('login-error', 'Vui lòng nhập đủ thông tin.');
            showError('login-error', '');
            try {
                await signInWithEmailAndPassword(auth, email, password);
            } catch (error) { showError('login-error', 'Email hoặc mật khẩu không đúng.'); }
        });

        $('#logout-btn').addEventListener('click', () => {
            if(wasInSecretChat){
                showConfirm("Bạn có muốn xóa cuộc trò chuyện bí mật trước khi đăng xuất?", 
                    async () => { await clearSecretChat(); await signOut(auth); }, 
                    async () => { await signOut(auth); }
                );
            } else {
                signOut(auth);
            }
        });


        // --- COUPLE & PROFILE SETUP ---
        const handleCoupleCode = async (isCreating) => {
            const code = $('#couple-code-input').value.trim();
            if (!code) return showError('couple-code-error', 'Vui lòng nhập mã.');
            showError('couple-code-error', '');

            const coupleDocRef = doc(db, "couples", code);
            const coupleDocSnap = await getDoc(coupleDocRef);

            if (isCreating) {
                if (coupleDocSnap.exists()) return showError('couple-code-error', 'Mã này đã tồn tại.');
                coupleCode = code;
                await setDoc(coupleDocRef, {
                    createdAt: Timestamp.now(), startDate: null, partner1: null, partner2: null,
                    gameBackgroundURL: 'https://i.ibb.co/L1pS1XF/pixel-art-sakura-tree-and-mountain-landscape-for-8bit-game-free-vector.jpg',
                    streak: { count: 0, lastDate: null, p1_checked: false, p2_checked: false }
                });
            } else {
                if (!coupleDocSnap.exists()) return showError('couple-code-error', 'Mã không tồn tại.');
                const data = coupleDocSnap.data();
                if (data.partner1 && data.partner2) return showError('couple-code-error', 'Cặp đôi này đã đủ người.');
                coupleCode = code;
            }
            showView('profile-setup-screen');
        };
        $('#join-couple-btn').addEventListener('click', () => handleCoupleCode(false));
        $('#create-custom-couple-btn').addEventListener('click', () => handleCoupleCode(true));

        $('#save-profile-btn').addEventListener('click', async () => {
            const [name, dob, gender] = ['#profile-name', '#profile-dob', '#profile-gender'].map(s => $(s).value);
            if (!name || !dob || !gender) return showError('profile-setup-error', 'Vui lòng nhập đủ thông tin.');
            
            const coupleDocRef = doc(db, "couples", coupleCode);
            const data = (await getDoc(coupleDocRef)).data();
            const newPartnerInfo = { userId, name, dob, gender,
                photoURL: gender === 'male' ? 'https://i.ibb.co/1M832Ww/image.png' : 'https://i.ibb.co/3kCcvS0/image.png',
                feeling: "", feelingExpiresAt: null,
            };
            try {
                await updateDoc(coupleDocRef, { [!data.partner1 ? 'partner1' : 'partner2']: newPartnerInfo });
                await setDoc(doc(db, "users", userId), { coupleCode: coupleCode });
            } catch (error) { showError('profile-setup-error', "Đã có lỗi xảy ra."); }
        });


        // --- REALTIME LISTENERS ---
        function setupRealtimeListeners() {
            const listen = (ref, callback) => {
                const unsub = onSnapshot(ref, callback);
                unsubscribers.push(unsub);
            };
            
            listen(doc(db, "couples", coupleCode), (docSnap) => {
                if (docSnap.exists()) {
                    coupleData = docSnap.data();
                    renderAll();
                    if(coupleData.chatMode && coupleData.chatMode !== currentChatMode) {
                        setChatMode(coupleData.chatMode === 'secret', false);
                    }
                } else { signOut(auth); }
            });

            listen(query(collection(db, "couples", coupleCode, "stories"), orderBy("timestamp", "desc")), (snapshot) => {
                allStories = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                renderStories(allStories);
            });
            
            listen(collection(db, "couples", coupleCode, "events"), (snapshot) => {
                const events = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                renderEvents(events);
            });
            
            setupChatListeners();
        }
        
        function setupChatListeners(){
            unsubscribers = unsubscribers.filter(unsub => !unsub.toString().includes('chat')); // Clear old chat listeners
            const listen = (ref, callback) => {
                const unsub = onSnapshot(ref, callback);
                unsubscribers.push(unsub);
            };
            listen(query(collection(db, "couples", coupleCode, "chat_normal"), orderBy("timestamp", "desc")), (snapshot) => {
                if (currentChatMode === 'normal') renderChatMessages(snapshot.docs.map(d => ({ id: d.id, ...d.data() })));
            });
            listen(query(collection(db, "couples", coupleCode, "chat_secret"), orderBy("timestamp", "desc")), (snapshot) => {
                if (currentChatMode === 'secret') renderChatMessages(snapshot.docs.map(d => ({ id: d.id, ...d.data() })));
            });
        }
        
        // --- RENDER FUNCTIONS ---
        const renderAll = () => {
            renderMainPage();
            renderStreakLove();
            renderSettings();
            checkDailyReset();
        };

        function renderMainPage() {
            if (!coupleData) return;
            if (coupleData.startDate) {
                const start = coupleData.startDate.toDate();
                const now = new Date();
                const diffDays = Math.ceil(Math.abs(now - start) / (1000 * 60 * 60 * 24));
                let years = now.getFullYear() - start.getFullYear(), months = now.getMonth() - start.getMonth(), days = now.getDate() - start.getDate();
                if (days < 0) { months--; days += new Date(now.getFullYear(), now.getMonth(), 0).getDate(); }
                if (months < 0) { years--; months += 12; }
                $('#day-counter').textContent = diffDays;
                $('#ymd-counter').textContent = `${years} năm ${months} tháng ${days} ngày`;
            } else {
                $('#day-counter').textContent = '♡';
                $('#ymd-counter').textContent = 'Hãy vào Cài đặt để chọn ngày bắt đầu nhé!';
            }
            $('#game-scene').style.backgroundImage = `url('${coupleData.gameBackgroundURL}')`;
            renderPartnerCharacter('#partner-1-char-container', coupleData.partner1);
            renderPartnerCharacter('#partner-2-char-container', coupleData.partner2);
        }

        function renderPartnerCharacter(containerId, partner) {
            const container = $(containerId);
            if (!partner) return container.innerHTML = '';
            const expiresAt = partner.feelingExpiresAt?.toDate();
            const hasFeeling = partner.feeling && (!expiresAt || expiresAt > new Date());

            container.innerHTML = `
                ${hasFeeling ? `
                    <div class="speech-bubble">
                        "${partner.feeling}"
                        ${expiresAt ? `<div class="feeling-countdown" data-expires-at="${expiresAt.getTime()}"></div>` : ''}
                        ${partner.userId === userId ? `<button data-partner-id="${partner.userId}" class="edit-feeling-btn"><i class="fas fa-pencil-alt"></i></button>` : ''}
                    </div>
                ` : ''}
                <div class="character" style="background-image: url('${partner.photoURL}')"></div>
                <div class="char-name">${partner.name}</div>
            `;
        }
        
        function updateFeelingCountdowns() {
            $$('.feeling-countdown').forEach(el => {
                const remaining = parseInt(el.dataset.expiresAt, 10) - Date.now();
                if (remaining <= 0) {
                    el.closest('.speech-bubble').style.display = 'none';
                } else {
                    const h = Math.floor(remaining / 3600000);
                    const m = Math.floor((remaining % 3600000) / 60000);
                    const s = Math.floor((remaining % 60000) / 1000);
                    el.innerHTML = `<i class="fas fa-clock fa-xs"></i> còn ${h.toString().padStart(2,'0')}:${m.toString().padStart(2,'0')}:${s.toString().padStart(2,'0')}`;
                }
            });
        }
        
        function renderStories(stories) {
            const feed = $('#story-feed');
            if (!feed) return;
            if (stories.length === 0) return feed.innerHTML = `<div class="card text-center">Chưa có story nào. Hãy là người đầu tiên!</div>`;
            
            feed.innerHTML = stories.map(story => {
                const date = story.timestamp?.toDate();
                const isLiked = story.likes?.includes(userId);
                const canDelete = story.authorId === userId;
                return `
                    <div class="story-card">
                        ${canDelete ? `<button class="delete-btn" data-story-id="${story.id}"><i class="fas fa-trash-alt"></i></button>` : ''}
                        <div class="story-body">
                            <p class="author-name" style="font-weight:700">${story.authorName}</p>
                            <p class="story-timestamp">${date ? date.toLocaleString('vi-VN') : ''}</p>
                            <h3 class="story-title">${story.title || ''}</h3>
                            <p class="story-content">${story.content}</p>
                        </div>
                        <div class="story-actions-footer">
                             <button class="like-btn ${isLiked ? 'liked' : ''}" data-story-id="${story.id}">
                                <i class="fas fa-heart"></i><span>${story.likes?.length || 0}</span>
                            </button>
                        </div>
                    </div>
                `;
            }).join('');
            
            // Re-attach listeners for dynamic content
            $$('.delete-btn[data-story-id]').forEach(btn => btn.onclick = () => showConfirm("Bạn chắc chắn muốn xóa story này?", () => deleteDoc(doc(db, "couples", coupleCode, "stories", btn.dataset.storyId))));
            $$('.like-btn').forEach(btn => btn.onclick = () => toggleLike(btn.dataset.storyId));
        }

        async function toggleLike(storyId) {
            const storyRef = doc(db, "couples", coupleCode, "stories", storyId);
            const storyDoc = await getDoc(storyRef);
            if (!storyDoc.exists()) return;
            const likes = storyDoc.data().likes || [];
            await updateDoc(storyRef, { likes: likes.includes(userId) ? arrayRemove(userId) : arrayUnion(userId) });
        }
        
        function renderEvents(events) {
            const list = $('#event-list');
            list.innerHTML = '';
            if (events.length === 0) return list.innerHTML = `<div class="card text-center">Chưa có sự kiện nào.</div>`;

            const now = new Date();
            events.sort((a,b) => calculateNextOccurrence(a, now) - calculateNextOccurrence(b, now));

            list.innerHTML = events.map(event => {
                const nextDate = calculateNextOccurrence(event, now);
                const diffDays = Math.ceil((nextDate - now) / (1000 * 60 * 60 * 24));
                return `
                    <div class="event-card">
                        <img src="${event.imageUrl || 'https://placehold.co/100x100/a5b4fc/4338ca?text=Event'}" class="event-image">
                        <div style="flex-grow: 1;">
                            <h4 class="event-title">${event.name}</h4>
                            <p class="event-details">${nextDate.toLocaleDateString('vi-VN')}</p>
                        </div>
                        <div class="event-countdown">
                            <div class="event-days-count">${diffDays > 0 ? diffDays : '🎉'}</div>
                            <div class="event-days-label">${diffDays > 0 ? 'ngày nữa' : 'Hôm nay'}</div>
                        </div>
                        <button class="delete-btn" data-event-id="${event.id}"><i class="fas fa-trash-alt"></i></button>
                    </div>
                `;
            }).join('');
            $$('.delete-btn[data-event-id]').forEach(btn => btn.onclick = () => showConfirm("Bạn chắc chắn muốn xóa sự kiện này?", () => deleteDoc(doc(db, "couples", coupleCode, "events", btn.dataset.eventId))));
        }

        function calculateNextOccurrence(event, now) {
            let nextDate = event.date.toDate();
            if (event.repeat === 'yearly') {
                while (nextDate < now) nextDate.setFullYear(nextDate.getFullYear() + 1);
            }
            return nextDate;
        }
        
        // --- STREAK ---
        async function checkDailyReset() {
            if (!coupleData?.streak) return;
            const today = new Date().toISOString().split('T')[0];
            if (coupleData.streak.lastDate !== today) {
                const updates = { 'streak.p1_checked': false, 'streak.p2_checked': false };
                if (coupleData.streak.lastDate && new Date(today) - new Date(coupleData.streak.lastDate) > 86400000) {
                    updates['streak.count'] = 0;
                }
                await updateDoc(doc(db, "couples", coupleCode), updates);
            }
        }

        function renderStreakLove() {
            if (!coupleData?.streak) return;
            const { count, p1_checked, p2_checked } = coupleData.streak;
            $('#streak-count').textContent = count || 0;

            const updateStatus = (partner, isChecked, elementId) => {
                const el = $(elementId);
                if (!partner || !el) return;
                el.querySelector('.partner-name').textContent = partner.name;
                el.querySelector('i').className = isChecked ? 'fas fa-check-circle status-icon-success' : 'fas fa-times-circle status-icon-fail';
            };
            updateStatus(coupleData.partner1, p1_checked, '#partner1-checkin-status');
            updateStatus(coupleData.partner2, p2_checked, '#partner2-checkin-status');

            const hasCheckedIn = (userId === coupleData.partner1?.userId) ? p1_checked : p2_checked;
            $('#check-in-btn').disabled = hasCheckedIn;
            $('#check-in-btn').innerHTML = hasCheckedIn ? `<i class="fas fa-calendar-check icon"></i> Đã điểm danh` : `<i class="fas fa-calendar-check icon"></i> Điểm danh`;
        }

        $('#check-in-btn').addEventListener('click', async () => {
            if (!coupleData?.streak) return;
            const isP1 = userId === coupleData.partner1.userId;
            const today = new Date().toISOString().split('T')[0];
            const updates = { [`streak.${isP1 ? 'p1' : 'p2'}_checked`]: true };
            if ((isP1 && coupleData.streak.p2_checked) || (!isP1 && coupleData.streak.p1_checked)) {
                updates['streak.count'] = increment(1);
                updates['streak.lastDate'] = today;
            }
            await updateDoc(doc(db, "couples", coupleCode), updates);
        });

        // --- CHAT ---
        $('#chat-fab').addEventListener('click', () => $('#chat-popup').classList.add('active'));
        $('#close-chat-btn').addEventListener('click', () => {
            $('#chat-popup').classList.remove('active');
            if (wasInSecretChat) {
                showConfirm("Bạn có muốn xóa cuộc trò chuyện bí mật không?", async () => { await clearSecretChat(); });
            }
        });

        function renderChatMessages(messages) {
            $('#chat-messages').innerHTML = messages.map(msg => `
                <div class="message-container ${msg.authorId === userId ? 'is-me' : 'is-other'}">
                    <div class="message-bubble ${msg.authorId === userId ? 'is-me' : 'is-other'}">${msg.content}</div>
                </div>
            `).join('');
            $('#chat-messages').scrollTop = 0; // scroll to bottom (flex-direction-reverse)
        }

        const sendMessage = async () => {
            const content = $('#chat-input').value.trim();
            if (!content) return;
            if (currentChatMode === 'normal' && await handleChatCommand(content)) return $('#chat-input').value = '';
            
            try {
                await addDoc(collection(db, "couples", coupleCode, `chat_${currentChatMode}`), { content, authorId: userId, timestamp: Timestamp.now() });
                $('#chat-input').value = '';
            } catch (error) { showAlert("Không thể gửi tin nhắn."); }
        };
        $('#chat-send-btn').addEventListener('click', sendMessage);
        $('#chat-input').addEventListener('keypress', (e) => { if (e.key === 'Enter') sendMessage(); });
        
        async function setChatMode(isSecret, shouldUpdateFirestore = true) {
            currentChatMode = isSecret ? 'secret' : 'normal';
            wasInSecretChat = isSecret;
            $('#chat-header').classList.toggle('secret-mode', isSecret);
            $('#toggle-chat-mode-btn').innerHTML = isSecret ? '<i class="fas fa-user-secret"></i> Bí mật' : '<i class="fas fa-comments"></i> Thường';
            
            if (!coupleCode) return; // Guard clause
            
            const chatCol = collection(db, "couples", coupleCode, `chat_${currentChatMode}`);
            const snapshot = await getDocs(query(chatCol, orderBy("timestamp", "desc")));
            renderChatMessages(snapshot.docs.map(d => d.data()));
            
            if (shouldUpdateFirestore) await updateDoc(doc(db, "couples", coupleCode), { chatMode: currentChatMode });
        }
        
        $('#toggle-chat-mode-btn').addEventListener('click', () => {
             const isSecret = currentChatMode === 'secret';
             if (isSecret) {
                 showConfirm("Bạn muốn xóa cuộc trò chuyện bí mật này?", 
                    async () => { await clearSecretChat(); setChatMode(false); }, 
                    () => { setChatMode(false); }
                 );
             } else {
                 setChatMode(true);
             }
        });

        async function handleChatCommand(command) {
            if (command === '@feel') { $('#feeling-modal').classList.remove('hidden'); return true; }
            const del = async (ref) => {
                const snapshot = await getDocs(query(ref));
                const batch = writeBatch(db);
                snapshot.forEach(d => batch.delete(d.ref));
                await batch.commit();
            };
            if (command === '@del-me') {
                showConfirm("Xóa tất cả tin nhắn của bạn?", async () => { await del(query(collection(db, "couples", coupleCode, "chat_normal"), where("authorId", "==", userId))); showAlert("Đã xóa tin nhắn của bạn."); });
                return true;
            }
            if (command === '@del-all') {
                showConfirm("XÓA TOÀN BỘ cuộc trò chuyện?", async () => { await del(collection(db, "couples", coupleCode, "chat_normal")); showAlert("Đã xóa cuộc trò chuyện."); });
                return true;
            }
            return false;
        }

        async function clearSecretChat() {
            const secretChatRef = collection(db, "couples", coupleCode, "chat_secret");
            const snapshot = await getDocs(query(secretChatRef));
            if (snapshot.empty) return;
            const batch = writeBatch(db);
            snapshot.forEach(d => batch.delete(d.ref));
            await batch.commit();
            wasInSecretChat = false;
        }
        
        $('#command-toggle-btn').addEventListener('click', () => $('#command-popup').classList.toggle('hidden'));
        $$('.command-btn').forEach(btn => btn.addEventListener('click', () => {
            $('#chat-input').value = btn.dataset.command;
            $('#command-popup').classList.add('hidden');
            $('#chat-input').focus();
        }));
        

        // --- TABS & FABs ---
        const navLinks = $$('.nav-link');
        const tabContents = $$('.tab-content');
        navLinks.forEach(link => {
            link.addEventListener('click', () => {
                navLinks.forEach(l => l.classList.remove('active'));
                link.classList.add('active');
                const tab = link.dataset.tab;
                tabContents.forEach(content => content.classList.toggle('active', content.id === `${tab}-content`));
                $('#add-story-fab').classList.toggle('hidden', tab !== 'story');
                $('#add-event-fab').classList.toggle('hidden', tab !== 'events');
            });
        });
        
        // --- MODALS ---
        // Story Modal
        $('#add-story-fab').addEventListener('click', () => $('#story-modal').classList.remove('hidden'));
        $('#cancel-story-btn').addEventListener('click', () => $('#story-modal').classList.add('hidden'));
        $('#post-story-btn').addEventListener('click', async () => {
            const [title, content, location, tags] = ['#story-title', '#story-textarea', '#story-location', '#story-tags'].map(s => $(s).value.trim());
            if (!content) return showAlert('Vui lòng nhập nội dung.');
            const partner = coupleData.partner1.userId === userId ? coupleData.partner1 : coupleData.partner2;
            try {
                await addDoc(collection(db, "couples", coupleCode, "stories"), { title, content, location, tags, authorId: userId, authorName: partner.name, timestamp: Timestamp.now(), likes: [] });
                ['#story-title', '#story-textarea', '#story-location', '#story-tags'].forEach(s => $(s).value = '');
                $('#story-modal').classList.add('hidden');
            } catch (error) { showAlert("Không thể đăng story."); }
        });
        // Feeling Modal
        $('body').addEventListener('click', (e) => {
            const btn = e.target.closest('.edit-feeling-btn');
            if (btn) $('#feeling-modal').classList.remove('hidden');
        });
        $('#cancel-feeling-btn').addEventListener('click', () => $('#feeling-modal').classList.add('hidden'));
        $('#save-feeling-btn').addEventListener('click', async () => {
            const feeling = $('#feeling-input').value.trim();
            const duration = $('#feeling-duration').value;
            const expiresAt = duration === 'infinite' ? null : Timestamp.fromMillis(Date.now() + parseInt(duration) * 1000);
            const partnerKey = coupleData.partner1.userId === userId ? 'partner1' : 'partner2';
            await updateDoc(doc(db, "couples", coupleCode), { [`${partnerKey}.feeling`]: feeling, [`${partnerKey}.feelingExpiresAt`]: expiresAt });
            $('#feeling-modal').classList.add('hidden');
        });
        // Event Modal
        $('#add-event-fab').addEventListener('click', () => $('#event-modal').classList.remove('hidden'));
        $('#cancel-event-btn').addEventListener('click', () => $('#event-modal').classList.add('hidden'));
        $('#save-event-btn').addEventListener('click', async () => {
            const [name, date, imageUrl, repeat] = ['#event-name', '#event-date', '#event-image-url', '#event-repeat'].map(s => $(s).value);
            if (!name || !date) return showAlert('Vui lòng nhập tên và ngày sự kiện.');
            try {
                await addDoc(collection(db, "couples", coupleCode, "events"), { name, date: Timestamp.fromDate(new Date(date)), imageUrl, repeat, createdAt: Timestamp.now() });
                $('#event-modal').classList.add('hidden');
            } catch (e) { showAlert('Lỗi lưu sự kiện.'); }
        });

        // --- SETTINGS ---
        function renderSettings() {
             if (!coupleData) return;
            $('#setting-couple-code').value = coupleCode;
            $('#setting-start-date').value = coupleData.startDate ? coupleData.startDate.toDate().toISOString().split('T')[0] : '';
            $('#setting-game-background').value = coupleData.gameBackgroundURL || '';
            
            const renderPartner = (containerId, partner) => {
                const container = $(containerId);
                if (!partner) return container.innerHTML = `<p class="setting-note">Chờ nửa kia tham gia...</p>`;
                container.innerHTML = `
                    <h4>${partner.name}</h4>
                    <label class="setting-label">Tên</label> <input type="text" data-partner-id="${partner.userId}" data-field="name" value="${partner.name}" class="input-field">
                    <label class="setting-label">Ngày sinh</label> <input type="date" data-partner-id="${partner.userId}" data-field="dob" value="${partner.dob}" class="input-field">
                    <label class="setting-label">URL Ảnh đại diện</label> <input type="text" data-partner-id="${partner.userId}" data-field="photoURL" value="${partner.photoURL}" class="input-field">
                `;
            };
            renderPartner('#settings-partner-1', coupleData.partner1);
            renderPartner('#settings-partner-2', coupleData.partner2);
        }

        $('#save-settings-btn').addEventListener('click', async () => {
            $('#loading-overlay').classList.remove('hidden');
            try {
                let updateData = {
                    startDate: Timestamp.fromDate(new Date($('#setting-start-date').value)),
                    gameBackgroundURL: $('#setting-game-background').value.trim()
                };
                
                $$('#settings-content input[data-partner-id]').forEach(input => {
                    const { partnerId, field } = input.dataset;
                    const partnerKey = coupleData.partner1?.userId === partnerId ? 'partner1' : 'partner2';
                    if (partnerKey) updateData[`${partnerKey}.${field}`] = input.value;
                });
                
                await updateDoc(doc(db, "couples", coupleCode), updateData);
                showAlert('Đã lưu cài đặt!');
            } catch (e) { showAlert('Lỗi khi lưu.'); } finally { $('#loading-overlay').classList.add('hidden'); }
        });
        
        $('#copy-code-btn').addEventListener('click', () => {
            navigator.clipboard.writeText(coupleCode).then(() => showAlert('Đã sao chép mã!'));
        });

        $('#change-code-btn').addEventListener('click', async () => {
            const newCode = $('#setting-new-couple-code').value.trim();
            if (!newCode || newCode === coupleCode) return showError('change-code-error', 'Vui lòng nhập mã mới và khác mã cũ.');
            
            const newCodeRef = doc(db, "couples", newCode);
            if ((await getDoc(newCodeRef)).exists()) return showError('change-code-error', 'Mã này đã tồn tại.');
            
            showConfirm(`Bạn chắc chắn muốn đổi mã thành "${newCode}" không? Hành động này không thể hoàn tác.`, async () => {
                $('#loading-overlay').classList.remove('hidden');
                try {
                    await migrateCoupleData(coupleCode, newCode);
                    showAlert('Đổi mã thành công! Ứng dụng sẽ tải lại.');
                    setTimeout(() => window.location.reload(), 2000);
                } catch (e) { showAlert(`Lỗi nghiêm trọng khi đổi mã: ${e.message}`); } finally { $('#loading-overlay').classList.add('hidden'); }
            });
        });
        
        async function migrateCoupleData(oldCode, newCode) {
            const oldCoupleRef = doc(db, "couples", oldCode);
            const oldData = (await getDoc(oldCoupleRef)).data();
            if(!oldData) throw new Error("Không tìm thấy dữ liệu cũ");

            await setDoc(doc(db, "couples", newCode), oldData);
            
            for (const scName of ['stories', 'events', 'chat_normal', 'chat_secret']) {
                 const oldDocs = await getDocs(collection(db, "couples", oldCode, scName));
                 if(!oldDocs.empty){
                     const batch = writeBatch(db);
                     oldDocs.forEach(d => {
                        batch.set(doc(db, "couples", newCode, scName, d.id), d.data());
                        batch.delete(d.ref);
                     });
                     await batch.commit();
                 }
            }
            
            if (oldData.partner1) await updateDoc(doc(db, "users", oldData.partner1.userId), { coupleCode: newCode });
            if (oldData.partner2) await updateDoc(doc(db, "users", oldData.partner2.userId), { coupleCode: newCode });

            await deleteDoc(oldCoupleRef);
        }
        
        // --- STORY FILTER ---
        $('#toggle-filters-btn').addEventListener('click', (e) => {
            const controls = $('#filter-controls');
            const chevron = e.currentTarget.querySelector('.filter-chevron');
            if (controls.style.maxHeight && controls.style.maxHeight !== '0px') {
                controls.style.maxHeight = '0px';
                chevron.style.transform = 'rotate(0deg)';
            } else {
                controls.style.maxHeight = `${controls.scrollHeight}px`;
                chevron.style.transform = 'rotate(180deg)';
            }
        });
        
        const updateStoryFilter = () => {
            if (!coupleData) return;
            const filterAuthorSelect = $('#filter-author');
            if (filterAuthorSelect.options.length <= 1) {
                if(coupleData.partner1) filterAuthorSelect.innerHTML += `<option value="${coupleData.partner1.userId}">${coupleData.partner1.name}</option>`;
                if(coupleData.partner2) filterAuthorSelect.innerHTML += `<option value="${coupleData.partner2.userId}">${coupleData.partner2.name}</option>`;
            }
            
            let storiesToDisplay = [...allStories];
            const authorId = $('#filter-author').value;
            if (authorId !== 'all') storiesToDisplay = storiesToDisplay.filter(s => s.authorId === authorId);
            
            const dateStr = $('#filter-date').value;
            if (dateStr) {
                const startOfDay = new Date(dateStr).setHours(0,0,0,0);
                const endOfDay = new Date(dateStr).setHours(23,59,59,999);
                storiesToDisplay = storiesToDisplay.filter(s => s.timestamp?.toDate().getTime() >= startOfDay && s.timestamp?.toDate().getTime() <= endOfDay);
            }
            
            storiesToDisplay.sort((a,b) => ($('#sort-stories').value === 'desc') ? b.timestamp - a.timestamp : a.timestamp - b.timestamp);
            
            renderStories(storiesToDisplay);
        };
        
        $$('#filter-author, #filter-date, #sort-stories').forEach(el => el.addEventListener('change', updateStoryFilter));
        $('#reset-filters-btn').addEventListener('click', () => {
            $$('#filter-author, #sort-stories').forEach(el => el.selectedIndex = 0);
            $('#filter-date').value = '';
            updateStoryFilter();
        });

    </script>
</body>

</html>

