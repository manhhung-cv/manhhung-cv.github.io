<!DOCTYPE html>
<html lang="vi">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover, user-scalable=no">
    <title>Love Story - Kỷ niệm tình yêu</title>

    <!-- PWA & iOS Meta Tags -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#FF8A8A">
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Quicksand', 'ui-sans-serif', 'system-ui'],
                    },
                    colors: {
                        primary: 'var(--primary-color)',
                        bg: 'var(--background-primary)',
                        surface: 'var(--background-secondary)',
                    },
                    animation: {
                        'fade-in': 'fadeIn 0.5s ease-out',
                        'slide-up': 'slideUp 0.5s ease-out',
                        'heartbeat': 'heartbeat 1.5s infinite',
                        'float': 'float 3s ease-in-out infinite',
                    },
                    keyframes: {
                        fadeIn: { '0%': { opacity: '0' }, '100%': { opacity: '1' } },
                        slideUp: { '0%': { transform: 'translateY(20px)', opacity: '0' }, '100%': { transform: 'translateY(0)', opacity: '1' } },
                        heartbeat: { '0%, 100%': { transform: 'scale(1)' }, '50%': { transform: 'scale(1.1)' } },
                        float: { '0%, 100%': { transform: 'translateY(0)' }, '50%': { transform: 'translateY(-10px)' } },
                    }
                }
            }
        }
    </script>

    <!-- Fonts and Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Quicksand:wght@400;500;600;700&display=swap" rel="stylesheet">

    <style>
        :root {
            /* Dynamic Theme Variables controlled by JS */
            --primary-color: #FF8A8A;
            --background-primary: #FDF8F8;
            --background-secondary: #FFFFFF;
            --text-primary: #2C2C2C;
            --my-message-color: #FF8A8A;
            --their-message-color: #FFFFFF;
        }

        body {
            font-family: 'Quicksand', sans-serif;
            background-color: var(--background-primary);
            color: var(--text-primary);
            overscroll-behavior-y: none; /* Prevent pull-to-refresh on mobile */
        }

        /* Hide Scrollbar but keep functionality */
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }

        /* Custom Shapes */
        .shape-heart { clip-path: path('M12 21.35l-1.45-1.32C5.4 15.36 2 12.28 2 8.5 2 5.42 4.42 3 7.5 3c1.74 0 3.41.81 4.5 2.09C13.09 3.81 14.76 3 16.5 3 19.58 3 22 5.42 22 8.5c0 3.78-3.4 6.86-8.55 11.54L12 21.35z'); }

        /* Utilities */
        .safe-pb { padding-bottom: env(safe-area-inset-bottom); }
        .safe-pt { padding-top: env(safe-area-inset-top); }
    </style>
</head>

<body class="h-[100dvh] w-full overflow-hidden text-gray-800">

    <!-- Loading Overlay -->
    <div id="loading-overlay" class="fixed inset-0 z-50 flex items-center justify-center bg-white/90 backdrop-blur-sm transition-opacity duration-300">
        <div class="text-center animate-heartbeat">
            <i class="fas fa-heart text-5xl text-primary drop-shadow-lg"></i>
            <p class="mt-4 font-semibold text-gray-500">Đang tải...</p>
        </div>
    </div>

    <!-- Auth Screens -->
    <div id="auth-screen" class="hidden h-full w-full flex flex-col items-center justify-center p-6 bg-gradient-to-br from-pink-50 to-white animate-fade-in">
        <div class="w-full max-w-sm bg-white p-8 rounded-3xl shadow-xl border border-pink-100">
            <div id="login-form">
                <h2 class="text-3xl font-bold text-center mb-8 text-primary">Đăng Nhập</h2>
                <div id="login-error" class="hidden mb-4 p-3 bg-red-50 text-red-500 text-sm rounded-xl text-center"></div>
                <form class="space-y-4">
                    <input id="login-email" type="email" placeholder="Email" class="w-full px-5 py-4 rounded-xl bg-gray-50 border border-gray-100 focus:outline-none focus:ring-2 focus:ring-primary/50 transition-all" autocomplete="email">
                    <input id="login-password" type="password" placeholder="Mật khẩu" class="w-full px-5 py-4 rounded-xl bg-gray-50 border border-gray-100 focus:outline-none focus:ring-2 focus:ring-primary/50 transition-all" autocomplete="current-password">
                    <button id="login-btn" type="button" class="w-full py-4 bg-primary text-white rounded-xl font-bold shadow-lg shadow-primary/30 active:scale-95 transition-transform">Đăng Nhập</button>
                </form>
                <p class="mt-6 text-center text-sm text-gray-500">Chưa có tài khoản? <a href="#" id="show-register" class="text-primary font-bold hover:underline">Đăng ký</a></p>
            </div>

            <div id="register-form" class="hidden">
                <h2 class="text-3xl font-bold text-center mb-8 text-primary">Đăng Ký</h2>
                <div id="register-error" class="hidden mb-4 p-3 bg-red-50 text-red-500 text-sm rounded-xl text-center"></div>
                <form class="space-y-4">
                    <input id="register-email" type="email" placeholder="Email" class="w-full px-5 py-4 rounded-xl bg-gray-50 border border-gray-100 focus:outline-none focus:ring-2 focus:ring-primary/50 transition-all">
                    <input id="register-password" type="password" placeholder="Mật khẩu" class="w-full px-5 py-4 rounded-xl bg-gray-50 border border-gray-100 focus:outline-none focus:ring-2 focus:ring-primary/50 transition-all">
                    <button id="register-btn" type="button" class="w-full py-4 bg-primary text-white rounded-xl font-bold shadow-lg shadow-primary/30 active:scale-95 transition-transform">Đăng Ký</button>
                </form>
                <p class="mt-6 text-center text-sm text-gray-500">Đã có tài khoản? <a href="#" id="show-login" class="text-primary font-bold hover:underline">Đăng nhập</a></p>
            </div>
        </div>
    </div>

    <!-- Couple Code Screen -->
    <div id="couple-code-screen" class="hidden h-full w-full flex flex-col items-center justify-center p-6 bg-gradient-to-br from-purple-50 to-white animate-fade-in">
        <div class="w-full max-w-sm bg-white p-8 rounded-3xl shadow-xl border border-purple-100 text-center">
            <h2 class="text-2xl font-bold mb-2 text-gray-800">Mã Cặp Đôi</h2>
            <p class="text-gray-500 mb-6 text-sm">Nhập mã để tham gia cùng người ấy, hoặc tạo mã mới.</p>
            <div id="couple-code-error" class="hidden mb-4 p-3 bg-red-50 text-red-500 text-sm rounded-xl"></div>
            <form class="space-y-3">
                <input id="couple-code-input" type="text" placeholder="Nhập mã..." class="w-full px-5 py-4 rounded-xl bg-gray-50 border border-gray-100 focus:outline-none focus:ring-2 focus:ring-primary/50 transition-all text-center tracking-widest text-lg font-semibold uppercase">
                <button id="join-couple-btn" type="button" class="w-full py-3 bg-primary text-white rounded-xl font-bold shadow-lg shadow-primary/30 active:scale-95 transition-transform">Tham Gia</button>
                <div class="relative py-2">
                    <div class="absolute inset-0 flex items-center"><div class="w-full border-t border-gray-200"></div></div>
                    <div class="relative flex justify-center text-sm"><span class="px-2 bg-white text-gray-400">Hoặc</span></div>
                </div>
                <button id="create-couple-btn" type="button" class="w-full py-3 bg-white border-2 border-primary text-primary rounded-xl font-bold active:scale-95 transition-transform">Tạo Cặp Đôi Mới</button>
            </form>
        </div>
    </div>

    <!-- Main Application -->
    <div id="main-app" class="hidden h-[100dvh] flex flex-col bg-bg transition-colors duration-500">
        
        <!-- Tab Content Container -->
        <main class="flex-grow overflow-hidden relative">
            
            <!-- 1. Home / Main Tab -->
            <div id="main-content" class="tab-content absolute inset-0 hidden opacity-0 transition-opacity duration-300">
                <div id="game-scene" class="w-full h-full bg-cover bg-center relative flex flex-col justify-between overflow-hidden transition-all duration-700">
                    <!-- Overlay gradient -->
                    <div class="absolute inset-0 bg-gradient-to-t from-black/40 via-transparent to-black/20 z-0 pointer-events-none"></div>
                    
                    <canvas id="decoration-canvas" class="absolute inset-0 z-0 pointer-events-none"></canvas>
                    
                    <div class="relative z-10 w-full h-full flex flex-col justify-between safe-pt pb-28 px-6">
                        <!-- Counter -->
                        <div class="counter-card mt-8 mx-auto bg-white/20 backdrop-blur-md border border-white/30 text-white p-6 rounded-3xl text-center shadow-lg animate-slide-up">
                            <div id="day-counter" class="text-6xl font-black drop-shadow-md">...</div>
                            <div id="ymd-counter" class="text-sm font-medium opacity-90 mt-1 tracking-wide">Đang tính toán...</div>
                        </div>

                        <!-- Characters -->
                        <div class="character-row flex justify-around items-end w-full max-w-md mx-auto mb-4">
                            <div id="partner-1-char" class="character-container relative text-center group"></div>
                            <div id="partner-2-char" class="character-container relative text-center group"></div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 2. Streak Tab -->
            <div id="streak-content" class="tab-content absolute inset-0 hidden opacity-0 transition-opacity duration-300 overflow-y-auto no-scrollbar bg-bg">
                <div class="min-h-full flex flex-col items-center justify-center p-6 safe-pb pb-24">
                    <h1 class="text-3xl font-bold text-gray-800 mb-8 mt-safe-top">Streak Love</h1>
                    
                    <div class="w-full max-w-sm bg-surface p-8 rounded-3xl shadow-xl border border-gray-100 text-center animate-slide-up">
                        <div class="streak-heart text-6xl text-primary mb-4 animate-heartbeat"><i class="fas fa-heart"></i></div>
                        <p id="streak-count" class="text-5xl font-bold text-primary mb-2">0</p>
                        <p class="text-gray-400 mb-8 font-medium uppercase tracking-wide text-sm">Ngày liên tiếp</p>
                        
                        <button id="check-in-btn" class="w-full py-4 bg-primary text-white rounded-2xl font-bold text-lg shadow-lg shadow-primary/30 active:scale-95 transition-all disabled:opacity-50 disabled:cursor-not-allowed">
                            Điểm danh ngay
                        </button>
                        
                        <div class="mt-8 pt-6 border-t border-gray-100 flex justify-around w-full">
                            <div id="partner1-checkin-status" class="flex flex-col items-center gap-2"></div>
                            <div class="w-px bg-gray-100 h-12"></div>
                            <div id="partner2-checkin-status" class="flex flex-col items-center gap-2"></div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 3. Story Tab -->
            <div id="story-content" class="tab-content absolute inset-0 hidden opacity-0 transition-opacity duration-300 flex flex-col bg-bg">
                <div class="flex-none px-6 py-4 safe-pt bg-surface/80 backdrop-blur-md sticky top-0 z-20 flex justify-between items-center border-b border-gray-100">
                    <h1 class="text-2xl font-bold text-gray-800">Kỷ Niệm</h1>
                    <button id="add-story-btn" class="w-10 h-10 rounded-full bg-primary text-white shadow-lg shadow-primary/30 flex items-center justify-center active:scale-90 transition-transform">
                        <i class="fas fa-plus"></i>
                    </button>
                </div>
                <div id="story-feed" class="flex-grow overflow-y-auto no-scrollbar p-4 space-y-4 pb-28">
                    <!-- Stories injected here -->
                </div>
            </div>

            <!-- 4. Chat Tab -->
            <div id="chat-content" class="tab-content absolute inset-0 hidden opacity-0 transition-opacity duration-300 flex flex-col bg-bg">
                <!-- Header -->
                <div class="chat-header flex-none px-4 py-3 safe-pt bg-surface border-b border-gray-100 flex justify-between items-center shadow-sm z-20 transition-colors duration-300">
                    <button id="chat-mode-toggle" class="w-10 h-10 rounded-full flex items-center justify-center text-gray-500 hover:bg-gray-100 transition-colors">
                        <i class="fas fa-lock text-lg"></i>
                    </button>
                    <h3 class="chat-title font-bold text-lg text-gray-800">Trò chuyện</h3>
                    <div class="w-10"></div> <!-- Spacer -->
                </div>

                <!-- Messages -->
                <div id="chat-messages" class="flex-grow overflow-y-auto p-4 flex flex-col-reverse gap-1 pb-4"></div>

                <!-- Input -->
                <div class="chat-input-area flex-none p-3 bg-surface border-t border-gray-100 safe-pb z-20">
                    <div id="command-popup" class="hidden absolute bottom-full left-4 right-4 mb-2 bg-white rounded-xl shadow-xl border border-gray-100 overflow-hidden animate-slide-up">
                        <button class="command-btn w-full p-3 text-left hover:bg-gray-50 border-b border-gray-50 text-sm font-medium text-gray-700" data-command="@feel">@feel: <span class="text-gray-400 font-normal">Đặt cảm xúc</span></button>
                        <button class="command-btn w-full p-3 text-left hover:bg-gray-50 border-b border-gray-50 text-sm font-medium text-gray-700" data-command="@del-me">@del-me: <span class="text-gray-400 font-normal">Xoá tin của tôi</span></button>
                        <button class="command-btn w-full p-3 text-left hover:bg-gray-50 text-sm font-medium text-red-500" data-command="@del-all">@del-all: <span class="text-red-300 font-normal">Xoá toàn bộ</span></button>
                    </div>
                    
                    <div class="flex items-center gap-2">
                        <button id="command-toggle-btn" class="w-10 h-10 flex items-center justify-center text-gray-400 hover:text-primary transition-colors">
                            <i class="fas fa-at text-xl"></i>
                        </button>
                        <div class="flex-grow relative">
                            <input id="chat-input" type="text" placeholder="Nhắn gì đó..." class="w-full pl-4 pr-4 py-3 bg-gray-100 rounded-full text-gray-800 focus:outline-none focus:ring-2 focus:ring-primary/50 focus:bg-white transition-all">
                        </div>
                        <button id="chat-send-btn" class="w-12 h-12 rounded-full bg-primary text-white flex items-center justify-center shadow-md active:scale-90 transition-transform">
                            <i class="fas fa-paper-plane"></i>
                        </button>
                    </div>
                </div>
            </div>

            <!-- 5. Events Tab -->
            <div id="events-content" class="tab-content absolute inset-0 hidden opacity-0 transition-opacity duration-300 flex flex-col bg-bg">
                <div class="flex-none px-6 py-4 safe-pt bg-surface/80 backdrop-blur-md sticky top-0 z-20 flex justify-between items-center border-b border-gray-100">
                    <h1 class="text-2xl font-bold text-gray-800">Sự Kiện</h1>
                    <button id="add-event-btn" class="w-10 h-10 rounded-full bg-primary text-white shadow-lg shadow-primary/30 flex items-center justify-center active:scale-90 transition-transform">
                        <i class="fas fa-calendar-plus"></i>
                    </button>
                </div>
                <div id="event-list" class="flex-grow overflow-y-auto no-scrollbar p-5 space-y-6 pb-28">
                    <!-- Events injected here -->
                </div>
            </div>

            <!-- 6. Settings Tab -->
            <div id="settings-content" class="tab-content absolute inset-0 hidden opacity-0 transition-opacity duration-300 bg-bg overflow-y-auto no-scrollbar">
                <div class="px-6 pt-safe-top pb-28">
                    <h1 class="text-3xl font-bold text-gray-800 mb-6 mt-6">Cài Đặt</h1>
                    
                    <div class="bg-surface rounded-3xl shadow-sm border border-gray-100 overflow-hidden">
                        <!-- Theme -->
                        <div class="accordion-item border-b border-gray-100">
                            <button class="accordion-header w-full px-6 py-5 flex justify-between items-center font-bold text-gray-700 hover:bg-gray-50 transition-colors">
                                <div class="flex items-center gap-3"><i class="fas fa-palette text-primary"></i> <span>Giao Diện</span></div>
                                <i class="fas fa-chevron-down transition-transform duration-300 text-gray-400"></i>
                            </button>
                            <div class="accordion-content max-h-0 overflow-hidden transition-all duration-300">
                                <div class="p-6 space-y-4 bg-gray-50/50">
                                    <div class="flex items-center justify-between"><label class="text-sm font-medium text-gray-600">Màu chủ đạo</label><input type="color" id="theme-primary-color" class="w-10 h-10 rounded-full cursor-pointer border-0 bg-transparent"></div>
                                    <div class="flex items-center justify-between"><label class="text-sm font-medium text-gray-600">Màu nền chính</label><input type="color" id="theme-bg-color" class="w-10 h-10 rounded-full cursor-pointer border-0 bg-transparent"></div>
                                    <div class="flex items-center justify-between"><label class="text-sm font-medium text-gray-600">Màu chữ</label><input type="color" id="theme-text-color" class="w-10 h-10 rounded-full cursor-pointer border-0 bg-transparent"></div>
                                    <div class="flex gap-3 mt-4">
                                        <button id="save-theme-btn" class="flex-1 py-2 bg-primary text-white rounded-xl font-semibold shadow-sm text-sm">Lưu</button>
                                        <button id="reset-theme-btn" class="flex-1 py-2 bg-white border border-gray-200 text-gray-600 rounded-xl font-semibold text-sm">Mặc định</button>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- General Info -->
                        <div class="accordion-item border-b border-gray-100">
                            <button class="accordion-header w-full px-6 py-5 flex justify-between items-center font-bold text-gray-700 hover:bg-gray-50 transition-colors">
                                <div class="flex items-center gap-3"><i class="fas fa-info-circle text-blue-400"></i> <span>Thông Tin Chung</span></div>
                                <i class="fas fa-chevron-down transition-transform duration-300 text-gray-400"></i>
                            </button>
                            <div class="accordion-content max-h-0 overflow-hidden transition-all duration-300">
                                <div class="p-6 space-y-5 bg-gray-50/50">
                                    <div id="partner-info-settings" class="space-y-4"></div>
                                    <div>
                                        <label class="block text-xs font-bold text-gray-400 uppercase tracking-wider mb-2">Ngày bắt đầu yêu</label>
                                        <input id="setting-start-date" type="date" class="w-full px-4 py-3 rounded-xl border border-gray-200 focus:outline-none focus:border-primary">
                                    </div>
                                    
                                    <div>
                                        <label class="block text-xs font-bold text-gray-400 uppercase tracking-wider mb-2">Hình nền trang chủ</label>
                                        <div class="flex bg-white rounded-xl border border-gray-200 p-1 mb-2">
                                            <input type="radio" id="bg-type-image" name="bg-type" value="image" class="hidden peer/img" checked>
                                            <label for="bg-type-image" class="flex-1 py-2 text-center rounded-lg text-sm font-semibold text-gray-500 cursor-pointer peer-checked/img:bg-primary peer-checked/img:text-white transition-all">Ảnh URL</label>
                                            
                                            <input type="radio" id="bg-type-gradient" name="bg-type" value="gradient" class="hidden peer/grad">
                                            <label for="bg-type-gradient" class="flex-1 py-2 text-center rounded-lg text-sm font-semibold text-gray-500 cursor-pointer peer-checked/grad:bg-primary peer-checked/grad:text-white transition-all">Màu Gradient</label>
                                        </div>
                                        
                                        <div id="background-image-settings">
                                            <input id="setting-game-background" type="text" placeholder="Dán URL hình ảnh..." class="w-full px-4 py-3 rounded-xl border border-gray-200 text-sm">
                                        </div>
                                        <div id="background-gradient-settings" class="hidden flex gap-2">
                                            <input type="color" id="setting-gradient-1" class="h-10 w-full flex-1 rounded-lg cursor-pointer">
                                            <input type="color" id="setting-gradient-2" class="h-10 w-full flex-1 rounded-lg cursor-pointer">
                                        </div>
                                    </div>

                                    <div class="grid grid-cols-2 gap-4">
                                        <div>
                                            <label class="block text-xs font-bold text-gray-400 uppercase mb-2">Bảng đếm ngày</label>
                                            <select id="setting-counter-shape" class="w-full px-3 py-2 rounded-xl border border-gray-200 text-sm">
                                                <option value="rectangle">Chữ nhật</option>
                                                <option value="circle">Tròn</option>
                                                <option value="heart">Trái tim</option>
                                            </select>
                                        </div>
                                        <div>
                                            <label class="block text-xs font-bold text-gray-400 uppercase mb-2">Hiệu ứng</label>
                                            <select id="setting-decoration" class="w-full px-3 py-2 rounded-xl border border-gray-200 text-sm">
                                                <option value="none">Tắt</option>
                                                <option value="sakura">Hoa anh đào</option>
                                                <option value="snow">Tuyết rơi</option>
                                                <option value="stars">Sao băng</option>
                                            </select>
                                        </div>
                                    </div>
                                    <div id="avatar-border-colors"></div>

                                    <button id="save-info-btn" class="w-full py-3 bg-primary text-white rounded-xl font-bold shadow-md active:scale-95 transition-transform">Lưu Thay Đổi</button>
                                </div>
                            </div>
                        </div>

                        <!-- Account -->
                        <div class="accordion-item">
                            <button class="accordion-header w-full px-6 py-5 flex justify-between items-center font-bold text-gray-700 hover:bg-gray-50 transition-colors">
                                <div class="flex items-center gap-3"><i class="fas fa-user-shield text-purple-400"></i> <span>Tài Khoản</span></div>
                                <i class="fas fa-chevron-down transition-transform duration-300 text-gray-400"></i>
                            </button>
                            <div class="accordion-content max-h-0 overflow-hidden transition-all duration-300">
                                <div class="p-6 space-y-4 bg-gray-50/50">
                                    <div>
                                        <label class="block text-xs font-bold text-gray-400 uppercase tracking-wider mb-2">Mã Cặp Đôi</label>
                                        <div class="flex gap-2">
                                            <input id="setting-couple-code" type="text" readonly class="flex-1 px-4 py-2 bg-gray-100 rounded-xl text-center font-mono font-bold text-gray-600">
                                            <button id="copy-code-btn" class="w-12 bg-white border border-gray-200 rounded-xl text-gray-500 hover:text-primary"><i class="fas fa-copy"></i></button>
                                        </div>
                                    </div>
                                    <button id="logout-btn" class="w-full py-3 bg-red-50 text-red-500 hover:bg-red-100 rounded-xl font-bold transition-colors">Đăng Xuất</button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

        </main>

        <!-- Bottom Navigation (Glassmorphism) -->
        <nav class="main-nav fixed bottom-0 left-0 right-0 bg-white/80 backdrop-blur-xl border-t border-gray-100 safe-pb z-40 transition-transform duration-300">
            <div class="flex justify-around items-center h-[60px]">
                <a class="nav-link active flex-1 flex flex-col items-center justify-center gap-1 text-gray-400 hover:text-primary transition-all cursor-pointer group" data-tab="main">
                    <i class="fas fa-heart text-xl group-[.active]:text-primary group-[.active]:scale-110 transition-transform"></i>
                    <span class="text-[10px] font-medium group-[.active]:text-primary">Chính</span>
                </a>
                <a class="nav-link flex-1 flex flex-col items-center justify-center gap-1 text-gray-400 hover:text-primary transition-all cursor-pointer group" data-tab="streak">
                    <i class="fas fa-fire-alt text-xl group-[.active]:text-primary group-[.active]:scale-110 transition-transform"></i>
                    <span class="text-[10px] font-medium group-[.active]:text-primary">Streak</span>
                </a>
                <a class="nav-link flex-1 flex flex-col items-center justify-center gap-1 text-gray-400 hover:text-primary transition-all cursor-pointer group" data-tab="story">
                    <i class="fas fa-book-open text-xl group-[.active]:text-primary group-[.active]:scale-110 transition-transform"></i>
                    <span class="text-[10px] font-medium group-[.active]:text-primary">Kỷ niệm</span>
                </a>
                <a class="nav-link flex-1 flex flex-col items-center justify-center gap-1 text-gray-400 hover:text-primary transition-all cursor-pointer group" data-tab="chat">
                    <i class="fas fa-comments text-xl group-[.active]:text-primary group-[.active]:scale-110 transition-transform"></i>
                    <span class="text-[10px] font-medium group-[.active]:text-primary">Chat</span>
                </a>
                <a class="nav-link flex-1 flex flex-col items-center justify-center gap-1 text-gray-400 hover:text-primary transition-all cursor-pointer group" data-tab="events">
                    <i class="fas fa-calendar-alt text-xl group-[.active]:text-primary group-[.active]:scale-110 transition-transform"></i>
                    <span class="text-[10px] font-medium group-[.active]:text-primary">Sự kiện</span>
                </a>
                <a class="nav-link flex-1 flex flex-col items-center justify-center gap-1 text-gray-400 hover:text-primary transition-all cursor-pointer group" data-tab="settings">
                    <i class="fas fa-cog text-xl group-[.active]:text-primary group-[.active]:scale-110 transition-transform"></i>
                    <span class="text-[10px] font-medium group-[.active]:text-primary">Cài đặt</span>
                </a>
            </div>
        </nav>
    </div>

    <!-- Modals Container -->
    <div id="modals-container" class="relative z-50"></div>

    <!-- Firebase & Logic -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, setDoc, updateDoc, collection, addDoc, query, onSnapshot, orderBy, Timestamp, deleteDoc, arrayUnion, arrayRemove, increment, writeBatch, getDocs, where } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // CONFIG - Replace with your actual config if needed, but this matches your provided file
        const firebaseConfig = {
            apiKey: "AIzaSyAr9tTx-Q0OWrJ4Iaslb33-o1PJLe1S3GQ",
            authDomain: "lovstory-b6e07.firebaseapp.com",
            projectId: "lovstory-b6e07",
            storageBucket: "lovstory-b6e0t.appspot.com",
            messagingSenderId: "810969018898",
            appId: "1:810969018898:web:c8e525581a77ed7d515ecb",
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // --- GLOBAL STATE & HELPERS ---
        let currentUser, userId, coupleCode, coupleData;
        let unsubscribers = [];
        let currentChatMode = 'normal';
        let feelingCountdownInterval, eventCountdownInterval, decorationAnimationId;
        let pressTimer = null;
        
        const $ = (s) => document.querySelector(s);
        const $$ = (s) => document.querySelectorAll(s);

        const showView = (viewId) => {
            // Screen transition logic
            const screens = ['auth-screen', 'couple-code-screen', 'main-app'];
            screens.forEach(id => $(`#${id}`).classList.add('hidden'));
            
            const target = $(`#${viewId}`);
            target.classList.remove('hidden');
            
            // Fade effect for smoother transition
            target.classList.remove('opacity-0'); 
            
            $('#loading-overlay').classList.add('opacity-0', 'pointer-events-none');
            setTimeout(() => $('#loading-overlay').classList.add('hidden'), 300);
        };

        const showError = (id, msg) => {
            const el = $(`#${id}`);
            el.textContent = msg;
            el.classList.toggle('hidden', !msg);
            el.classList.add('animate-pulse');
        };

        const cleanupListeners = () => {
            unsubscribers.forEach(unsub => unsub());
            unsubscribers = [];
            if (feelingCountdownInterval) clearInterval(feelingCountdownInterval);
            if (eventCountdownInterval) clearInterval(eventCountdownInterval);
            if (decorationAnimationId) cancelAnimationFrame(decorationAnimationId);
        };

        // --- AUTH ---
        onAuthStateChanged(auth, async (user) => {
            cleanupListeners();
            $('#loading-overlay').classList.remove('hidden', 'opacity-0', 'pointer-events-none');
            
            if (user) {
                currentUser = user; userId = user.uid;
                const userDoc = await getDoc(doc(db, "users", userId));
                if (userDoc.exists() && userDoc.data().coupleCode) {
                    coupleCode = userDoc.data().coupleCode;
                    setupRealtimeListeners();
                    showView('main-app');
                } else {
                    showView('couple-code-screen');
                }
            } else {
                showView('auth-screen');
            }
        });

        $('#show-register').addEventListener('click', (e) => { e.preventDefault(); $('#login-form').classList.add('hidden'); $('#register-form').classList.remove('hidden'); });
        $('#show-login').addEventListener('click', (e) => { e.preventDefault(); $('#register-form').classList.add('hidden'); $('#login-form').classList.remove('hidden'); });

        $('#register-btn').addEventListener('click', async () => {
            const [email, pass] = ['#register-email', '#register-password'].map(s => $(s).value);
            if (!email || !pass) return showError('register-error', 'Vui lòng nhập đủ thông tin.');
            try { await createUserWithEmailAndPassword(auth, email, pass); } catch (e) { showError('register-error', `Lỗi: ${e.message}`); }
        });

        $('#login-btn').addEventListener('click', async () => {
            const [email, pass] = ['#login-email', '#login-password'].map(s => $(s).value);
            if (!email || !pass) return showError('login-error', 'Vui lòng nhập đủ thông tin.');
            try { await signInWithEmailAndPassword(auth, email, pass); } catch (e) { showError('login-error', 'Email hoặc mật khẩu không đúng.'); }
        });

        // --- COUPLE SETUP ---
        const handleCoupleCode = async (isCreating) => {
            const code = $('#couple-code-input').value.trim();
            if (!code) return showError('couple-code-error', 'Vui lòng nhập mã.');
            const coupleDocRef = doc(db, "couples", code);
            const coupleDocSnap = await getDoc(coupleDocRef);
            if (isCreating) {
                if (coupleDocSnap.exists()) return showError('couple-code-error', 'Mã này đã tồn tại.');
                await setDoc(coupleDocRef, {
                    createdAt: Timestamp.now(),
                    background: { type: 'image', value: 'https://i.ibb.co/L1pS1XF/pixel-art-sakura-tree-and-mountain-landscape-for-8bit-game-free-vector.jpg' },
                    streak: { count: 0, lastCheckIn: null, p1_checkedToday: false, p2_checkedToday: false },
                    chatMode: 'normal',
                    decoration: 'none',
                    customization: { partner1Border: '#FFFFFF', partner2Border: '#FFFFFF', counterShape: 'rectangle' }
                });
            } else {
                if (!coupleDocSnap.exists()) return showError('couple-code-error', 'Mã không tồn tại.');
                if (coupleDocSnap.data().partner1 && coupleDocSnap.data().partner2) return showError('couple-code-error', 'Cặp đôi này đã đủ người.');
            }
            coupleCode = code;
            await setDoc(doc(db, "users", userId), { coupleCode }, { merge: true });
        };
        $('#join-couple-btn').addEventListener('click', () => handleCoupleCode(false));
        $('#create-couple-btn').addEventListener('click', () => handleCoupleCode(true));

        // --- REALTIME LISTENERS ---
        function setupRealtimeListeners() {
            const listen = (ref, cb) => unsubscribers.push(onSnapshot(ref, cb));
            listen(doc(db, "couples", coupleCode), (snap) => {
                if (!snap.exists()) return signOut(auth);
                coupleData = snap.data();
                currentChatMode = coupleData.chatMode || 'normal';
                renderAll();
            });
            listen(query(collection(db, "couples", coupleCode, "stories"), orderBy("timestamp", "desc")), (snap) => renderStories(snap.docs.map(d => ({ id: d.id, ...d.data() }))));
            listen(query(collection(db, "couples", coupleCode, "events"), orderBy("date")), (snap) => renderEvents(snap.docs.map(d => ({ id: d.id, ...d.data() }))));
            listen(query(collection(db, "couples", coupleCode, "chat_normal"), orderBy("timestamp", "asc")), (snap) => { if (currentChatMode === 'normal') renderChat(snap.docs.map(d => d.data())); });
            listen(query(collection(db, "couples", coupleCode, "chat_secret"), orderBy("timestamp", "asc")), (snap) => { if (currentChatMode === 'secret') renderChat(snap.docs.map(d => d.data())); });
            
            feelingCountdownInterval = setInterval(updateFeelingCountdowns, 1000);
            eventCountdownInterval = setInterval(updateEventCountdowns, 1000);
        }

        function renderAll() {
            applyTheme(coupleData.theme);
            if (!coupleData.partner1 || !coupleData.partner2) {
                const partnerKey = (coupleData.partner1 && coupleData.partner1.userId === userId) ? 1 : 2;
                renderProfileSetupModal(partnerKey);
            }
            renderMainPage();
            renderStreak();
            renderSettings();
            updateChatUI();
        }

        // --- RENDER LOGIC WITH TAILWIND ---
        const defaultTheme = { '--primary-color': '#FF8A8A', '--background-primary': '#FDF8F8', '--text-primary': '#2C2C2C', '--my-message-color': '#FF8A8A', '--their-message-color': '#FFFFFF' };
        function applyTheme(theme = {}) {
            const finalTheme = { ...defaultTheme, ...theme };
            for (const [key, value] of Object.entries(finalTheme)) document.documentElement.style.setProperty(key, value);
        }

        function renderMainPage() {
            // Date logic
            if (coupleData.startDate) {
                const start = coupleData.startDate.toDate();
                const now = new Date();
                const diffDays = Math.ceil(Math.abs(now - start) / 864e5);
                let years = now.getFullYear() - start.getFullYear(), months = now.getMonth() - start.getMonth(), days = now.getDate() - start.getDate();
                if (days < 0) { months--; days += new Date(now.getFullYear(), now.getMonth(), 0).getDate(); }
                if (months < 0) { years--; months += 12; }
                $('#day-counter').textContent = diffDays;
                $('#ymd-counter').textContent = `${years} năm ${months} tháng ${days} ngày`;
            } else {
                $('#day-counter').textContent = '♡';
                $('#ymd-counter').textContent = 'Chưa chọn ngày';
            }

            // Background
            const bg = coupleData.background || { type: 'image', value: '' };
            const scene = $('#game-scene');
            if (bg.type === 'image') scene.style.backgroundImage = `url('${bg.value}')`;
            else scene.style.background = `linear-gradient(135deg, ${bg.value[0]}, ${bg.value[1]})`;

            // Counter Shape customization
            const shape = coupleData.customization?.counterShape || 'rectangle';
            const card = $('.counter-card');
            card.className = `counter-card mt-12 mx-auto bg-white/20 backdrop-blur-md border border-white/30 text-white shadow-lg animate-slide-up transition-all duration-300 `;
            
            if (shape === 'circle') {
                card.classList.add('rounded-full', 'w-64', 'h-64', 'flex', 'flex-col', 'justify-center', 'items-center');
                $('#day-counter').className = "text-5xl font-black drop-shadow-md";
            } else if (shape === 'heart') {
                card.classList.add('shape-heart', 'w-72', 'h-72', 'flex', 'flex-col', 'justify-center', 'items-center', 'pt-8');
                $('#day-counter').className = "text-5xl font-black drop-shadow-md";
            } else {
                // Rectangle default
                card.classList.add('p-6', 'rounded-3xl', 'text-center', 'w-full', 'max-w-xs');
                $('#day-counter').className = "text-6xl font-black drop-shadow-md";
            }

            renderPartner('#partner-1-char', coupleData.partner1, coupleData.customization?.partner1Border);
            renderPartner('#partner-2-char', coupleData.partner2, coupleData.customization?.partner2Border);
            startDecorationAnimation(coupleData.decoration);
        }

        function renderPartner(containerId, partner, borderColor = '#FFF') {
            const container = $(containerId);
            if (!partner) {
                container.innerHTML = `<div class="w-24 h-24 rounded-full bg-gray-200 border-4 border-white flex items-center justify-center text-gray-400 font-bold mx-auto shadow-lg">?</div><div class="mt-2 text-white font-bold drop-shadow-md text-sm bg-black/20 px-2 py-0.5 rounded-full inline-block backdrop-blur-sm">Chờ...</div>`;
                return;
            }
            container.setAttribute('data-user-id', partner.userId);
            const expiresAt = partner.feelingExpiresAt?.toDate();
            const hasFeeling = partner.feeling && (!expiresAt || expiresAt > new Date());

            container.innerHTML = `
                ${hasFeeling ? `
                    <div class="speech-bubble absolute bottom-[110%] left-1/2 -translate-x-1/2 bg-white px-4 py-3 rounded-2xl shadow-lg w-40 text-sm text-gray-800 animate-fade-in z-20 after:content-[''] after:absolute after:top-full after:left-1/2 after:-translate-x-1/2 after:border-8 after:border-transparent after:border-t-white">
                        <span class="block mb-1 break-words leading-tight">${partner.feeling}</span>
                        ${partner.userId === userId ? `<button class="edit-feeling-btn absolute -top-2 -right-2 w-6 h-6 bg-primary text-white rounded-full flex items-center justify-center text-xs shadow-sm hover:scale-110 transition-transform"><i class="fas fa-pencil-alt"></i></button>` : ''}
                        ${expiresAt ? `<div class="feeling-countdown text-[10px] text-gray-400 mt-1 font-medium bg-gray-50 rounded px-1" data-expires-at="${expiresAt.getTime()}"></div>` : ''}
                    </div>` : ''
                }
                <div class="relative transition-transform duration-300 transform group-hover:scale-105 active:scale-95 cursor-pointer">
                    <div class="w-24 h-24 sm:w-28 sm:h-28 rounded-full bg-cover bg-center border-4 shadow-xl mx-auto relative z-10" style="background-image: url('${partner.photoURL}'); border-color: ${borderColor}"></div>
                    ${partner.userId === userId && !hasFeeling ? '<div class="absolute -right-1 bottom-0 w-8 h-8 bg-white text-primary rounded-full flex items-center justify-center shadow-md z-20 animate-bounce"><i class="fas fa-plus"></i></div>' : ''}
                </div>
                <div class="mt-3 text-white font-bold text-base drop-shadow-md bg-black/20 backdrop-blur-sm px-3 py-1 rounded-full inline-block">${partner.name}</div>
            `;
        }

        function updateFeelingCountdowns() {
            $$('.feeling-countdown').forEach(el => {
                const remaining = parseInt(el.dataset.expiresAt, 10) - Date.now();
                if (remaining <= 0) { if (el.parentElement) el.parentElement.remove(); }
                else {
                    const h = Math.floor(remaining / 3600000), m = Math.floor((remaining % 3600000) / 60000);
                    el.innerHTML = `<i class="fas fa-clock mr-1"></i>${h}h ${m}p`;
                }
            });
        }

        function renderStreak() {
            const streak = coupleData.streak;
            const todayStr = new Date().toISOString().split("T")[0];
            $('#streak-count').textContent = streak.count || 0;

            const renderStatus = (p, pNum) => {
                const el = $(`#partner${pNum}-checkin-status`);
                if (!p) return el.innerHTML = `<i class="fas fa-circle text-gray-200 text-3xl"></i><span class="text-xs text-gray-400">...</span>`;
                const checked = streak[`p${pNum}_checkedToday`] && streak.lastCheckIn === todayStr;
                el.innerHTML = `
                    <div class="relative">
                        <img src="${p.photoURL}" class="w-10 h-10 rounded-full border-2 ${checked ? 'border-green-500 grayscale-0' : 'border-gray-200 grayscale'} transition-all object-cover">
                        ${checked ? '<div class="absolute -bottom-1 -right-1 bg-green-500 text-white text-[8px] w-4 h-4 rounded-full flex items-center justify-center"><i class="fas fa-check"></i></div>' : ''}
                    </div>
                    <span class="text-xs font-semibold ${checked ? 'text-green-600' : 'text-gray-400'}">${checked ? 'Đã điểm danh' : 'Chưa điểm danh'}</span>
                `;
                if (p.userId === userId) {
                    $('#check-in-btn').disabled = checked;
                    $('#check-in-btn').textContent = checked ? "Đã xong hôm nay!" : "Điểm danh ngay";
                    $('#check-in-btn').className = `w-full py-4 rounded-2xl font-bold text-lg shadow-lg transition-all ${checked ? 'bg-green-100 text-green-600' : 'bg-primary text-white shadow-primary/30 active:scale-95'}`;
                }
            }
            renderStatus(coupleData.partner1, 1);
            renderStatus(coupleData.partner2, 2);
        }

        function renderStories(stories) {
            const feed = $('#story-feed');
            if (stories.length === 0) return feed.innerHTML = `<div class="flex flex-col items-center justify-center h-64 text-gray-400"><i class="fas fa-book-open text-4xl mb-4 opacity-30"></i><p>Chưa có kỷ niệm nào.</p></div>`;
            
            feed.innerHTML = stories.map(s => `
                <div class="bg-surface rounded-3xl shadow-sm border border-gray-100 overflow-hidden animate-slide-up" data-id="${s.id}">
                    <div class="p-4 flex items-center gap-3">
                        <img src="${s.authorId === coupleData?.partner1?.userId ? coupleData.partner1.photoURL : coupleData.partner2.photoURL}" class="w-10 h-10 rounded-full object-cover ring-2 ring-gray-50">
                        <div>
                            <div class="font-bold text-gray-800 text-sm">${s.authorName}</div>
                            <div class="text-xs text-gray-400">${s.timestamp.toDate().toLocaleString('vi-VN')}</div>
                        </div>
                    </div>
                    ${s.content ? `<div class="px-4 pb-2 text-gray-700 leading-relaxed text-sm whitespace-pre-wrap">${s.content}</div>` : ''}
                    ${s.imageUrl ? `<div class="mt-2"><img src="${s.imageUrl}" class="w-full h-auto max-h-96 object-cover"></div>` : ''}
                    <div class="px-4 py-3 border-t border-gray-50 flex items-center justify-between mt-2">
                        <button class="like-btn flex items-center gap-2 text-sm font-semibold transition-colors ${s.likes?.includes(userId) ? 'text-primary' : 'text-gray-400 hover:text-gray-600'}">
                            <i class="${s.likes?.includes(userId) ? 'fas' : 'far'} fa-heart text-lg"></i> <span>${s.likes?.length || 0}</span>
                        </button>
                        ${s.authorId === userId ? `<button class="delete-story-btn text-gray-400 hover:text-red-500 transition-colors p-2"><i class="fas fa-trash-alt"></i></button>` : ''}
                    </div>
                </div>
            `).join('');
        }

        function renderEvents(events) {
            const list = $('#event-list');
            const sorted = events.map(e => {
                const next = e.date.toDate();
                if (e.repeat === 'yearly' && next < new Date()) {
                    let y = new Date().getFullYear();
                    next.setFullYear(y);
                    if (next < new Date()) next.setFullYear(y + 1);
                }
                return { ...e, next };
            }).sort((a, b) => a.next - b.next);

            if (sorted.length === 0) return list.innerHTML = `<div class="flex flex-col items-center justify-center h-64 text-gray-400"><i class="fas fa-calendar text-4xl mb-4 opacity-30"></i><p>Chưa có sự kiện nào.</p></div>`;

            list.innerHTML = sorted.map((e, idx) => `
                <div class="event-card relative rounded-3xl overflow-hidden shadow-lg group ${idx === 0 ? 'h-64' : 'h-48'} transition-all duration-300" data-id="${e.id}">
                    <div class="absolute inset-0 bg-cover bg-center transition-transform duration-700 group-hover:scale-110" style="background-image: url(${e.imageUrl || 'https://i.ibb.co/L1pS1XF/pixel-art-sakura-tree-and-mountain-landscape-for-8bit-game-free-vector.jpg'})"></div>
                    <div class="absolute inset-0 bg-gradient-to-t from-black/80 via-black/20 to-transparent"></div>
                    
                    <div class="absolute top-4 right-4 flex gap-2 opacity-0 group-hover:opacity-100 transition-opacity">
                        <button class="edit-event-btn w-8 h-8 rounded-full bg-white/20 backdrop-blur-md text-white hover:bg-white/40 flex items-center justify-center"><i class="fas fa-pencil-alt text-xs"></i></button>
                        <button class="delete-event-btn w-8 h-8 rounded-full bg-white/20 backdrop-blur-md text-white hover:bg-red-500/80 flex items-center justify-center"><i class="fas fa-trash text-xs"></i></button>
                    </div>

                    <div class="absolute bottom-0 left-0 right-0 p-5 text-white">
                        <div class="flex items-end justify-between">
                            <div>
                                <h3 class="${idx === 0 ? 'text-3xl' : 'text-xl'} font-bold mb-1 drop-shadow-md leading-tight">${e.name}</h3>
                                <p class="text-white/80 text-sm flex items-center gap-2"><i class="fas fa-clock text-xs"></i> ${e.next.toLocaleDateString('vi-VN')}</p>
                            </div>
                        </div>
                        <div class="countdown-container flex gap-3 mt-4 pt-4 border-t border-white/20" data-date="${e.next.toISOString()}"></div>
                    </div>
                </div>
            `).join('');
        }

        function updateEventCountdowns() {
            $$('.countdown-container').forEach(el => {
                const diff = new Date(el.dataset.date) - new Date();
                if (diff < 0) return el.innerHTML = '<span class="text-yellow-400 font-bold animate-bounce">Hôm nay! 🎉</span>';
                
                const units = [
                    { val: Math.floor(diff / 864e5), label: 'Ngày' },
                    { val: Math.floor((diff % 864e5) / 36e5), label: 'Giờ' },
                    { val: Math.floor((diff % 36e5) / 6e4), label: 'Phút' },
                    { val: Math.floor((diff % 6e4) / 1e3), label: 'Giây' }
                ];
                
                el.innerHTML = units.map(u => `
                    <div class="text-center">
                        <div class="text-xl font-bold font-mono leading-none">${u.val}</div>
                        <div class="text-[9px] uppercase tracking-wider opacity-70 mt-1">${u.label}</div>
                    </div>
                `).join('');
            });
        }

        function renderChat(messages) {
            const container = $('#chat-messages');
            // Group logic remains same, but styling changes
            const grouped = messages.reduce((acc, msg) => {
                const last = acc[acc.length - 1];
                if (last && last.authorId === msg.authorId && msg.timestamp.toMillis() - last.ts < 300000) { last.msgs.push(msg.content); }
                else { acc.push({ authorId: msg.authorId, msgs: [msg.content], ts: msg.timestamp.toMillis() }); }
                return acc;
            }, []);

            container.innerHTML = grouped.map(g => {
                const isMe = g.authorId === userId;
                return `
                    <div class="flex flex-col ${isMe ? 'items-end' : 'items-start'} mb-4 animate-fade-in w-full">
                        ${g.msgs.map((txt, i) => `
                            <div class="px-4 py-2 my-0.5 max-w-[80%] text-[15px] break-words leading-relaxed shadow-sm
                                ${isMe 
                                    ? `bg-[var(--my-message-color)] text-white rounded-l-2xl ${i===0?'rounded-tr-2xl':'rounded-tr-md'} ${i===g.msgs.length-1?'rounded-br-2xl':'rounded-br-md'}` 
                                    : `bg-[var(--their-message-color)] text-gray-800 border border-gray-100 rounded-r-2xl ${i===0?'rounded-tl-2xl':'rounded-tl-md'} ${i===g.msgs.length-1?'rounded-bl-2xl':'rounded-bl-md'}`
                                }">
                                ${txt}
                            </div>
                        `).join('')}
                    </div>
                `;
            }).join('');
        }

        // --- COMMON UI LOGIC ---
        function renderSettings() {
            const theme = { ...defaultTheme, ...coupleData.theme };
            $('#theme-primary-color').value = theme['--primary-color'];
            $('#theme-bg-color').value = theme['--background-primary'];
            $('#theme-text-color').value = theme['--text-primary'];

            const renderPInfo = (p) => !p ? '' : `<div class="bg-white p-3 rounded-xl border border-gray-100"><h4 class="font-bold text-sm mb-2 text-primary">${p.name}</h4><input data-pid="${p.userId}" data-f="name" value="${p.name}" class="w-full mb-2 p-2 bg-gray-50 rounded-lg text-xs border-0"><input data-pid="${p.userId}" data-f="photoURL" value="${p.photoURL}" class="w-full p-2 bg-gray-50 rounded-lg text-xs border-0 text-gray-500"></div>`;
            $('#partner-info-settings').innerHTML = renderPInfo(coupleData.partner1) + renderPInfo(coupleData.partner2);
            $('#setting-start-date').value = coupleData.startDate ? coupleData.startDate.toDate().toISOString().split('T')[0] : '';
            $('#setting-couple-code').value = coupleCode;
            
            // Customization borders
            const renderBorder = (p, num) => p ? `<div class="flex items-center justify-between bg-white p-3 rounded-xl border border-gray-100 mb-2"><label class="text-xs font-bold text-gray-500">Viền avatar ${p.name}</label><input type="color" id="setting-p${num}-border" value="${coupleData.customization?.[`partner${num}Border`] || '#FFF'}" class="w-8 h-8 rounded-full border-0"></div>` : '';
            $('#avatar-border-colors').innerHTML = renderBorder(coupleData.partner1, 1) + renderBorder(coupleData.partner2, 2);
            
            // Background type
            const bgType = coupleData.background?.type || 'image';
            $(`input[name="bg-type"][value="${bgType}"]`).checked = true;
            $('#background-image-settings').classList.toggle('hidden', bgType !== 'image');
            $('#background-gradient-settings').classList.toggle('hidden', bgType !== 'gradient');
            if (bgType === 'image') $('#setting-game-background').value = coupleData.background.value;
            else { $('#setting-gradient-1').value = coupleData.background.value[0]; $('#setting-gradient-2').value = coupleData.background.value[1]; }
            
            $('#setting-decoration').value = coupleData.decoration || 'none';
            $('#setting-counter-shape').value = coupleData.customization?.counterShape || 'rectangle';
        }

        function createModal(id, title, body, footer) {
            if($(`#${id}`)) $(`#${id}`).remove();
            const m = document.createElement('div');
            m.id = id;
            m.className = "fixed inset-0 z-50 flex items-center justify-center bg-black/40 backdrop-blur-sm p-4 animate-fade-in";
            m.innerHTML = `
                <div class="bg-white w-full max-w-sm rounded-3xl shadow-2xl overflow-hidden animate-slide-up">
                    <div class="px-6 py-4 border-b border-gray-100 flex justify-between items-center">
                        <h3 class="font-bold text-lg text-gray-800">${title}</h3>
                        <button class="w-8 h-8 rounded-full bg-gray-50 text-gray-400 hover:bg-gray-100 flex items-center justify-center close-modal"><i class="fas fa-times"></i></button>
                    </div>
                    <div class="p-6">${body}</div>
                    <div class="px-6 pb-6 flex gap-3">${footer}</div>
                </div>`;
            $('#modals-container').appendChild(m);
            m.addEventListener('click', e => { if(e.target === m || e.target.closest('.close-modal')) m.remove(); });
            return m;
        }

        // --- EVENT HANDLERS ---
        $('#check-in-btn').addEventListener('click', async () => {
             const today = new Date().toISOString().split("T")[0];
             const yesterday = new Date(Date.now() - 864e5).toISOString().split("T")[0];
             const isP1 = coupleData.partner1.userId === userId;
             const updates = { "streak.lastCheckIn": today, [isP1 ? "streak.p1_checkedToday" : "streak.p2_checkedToday"]: true };
             if (coupleData.streak.lastCheckIn !== today) {
                 updates[isP1 ? "streak.p2_checkedToday" : "streak.p1_checkedToday"] = false;
                 updates["streak.count"] = increment(coupleData.streak.lastCheckIn === yesterday ? 1 : (1 - (coupleData.streak.count || 0)));
                 if(coupleData.streak.lastCheckIn !== yesterday) updates["streak.count"] = 1;
             }
             await updateDoc(doc(db, "couples", coupleCode), updates);
        });

        $('#add-story-btn').addEventListener('click', () => {
            const m = createModal('story-modal', 'Viết Kỷ Niệm', 
                `<input id="st-title" placeholder="Tiêu đề..." class="w-full mb-3 p-3 bg-gray-50 rounded-xl border-none focus:ring-1 focus:ring-primary"><textarea id="st-content" rows="4" placeholder="Viết gì đó..." class="w-full mb-3 p-3 bg-gray-50 rounded-xl border-none focus:ring-1 focus:ring-primary"></textarea><input id="st-img" placeholder="URL ảnh..." class="w-full p-3 bg-gray-50 rounded-xl border-none text-xs">`,
                `<button id="save-st" class="w-full py-3 bg-primary text-white rounded-xl font-bold">Đăng</button>`
            );
            m.querySelector('#save-st').addEventListener('click', async () => {
                const [t, c, i] = ['#st-title', '#st-content', '#st-img'].map(s => m.querySelector(s).value);
                if(c||i) {
                    await addDoc(collection(db,"couples",coupleCode,"stories"), { title:t, content:c, imageUrl:i, authorId:userId, authorName: coupleData.partner1.userId === userId ? coupleData.partner1.name : coupleData.partner2.name, timestamp:Timestamp.now(), likes:[] });
                    m.remove();
                }
            });
        });

        // Chat & Settings Handlers
        $('#chat-send-btn').addEventListener('click', async () => {
            const val = $('#chat-input').value.trim();
            if(!val) return;
            if(val.startsWith('@del')) {
                 const col = `chat_${currentChatMode}`;
                 const q = val === '@del-me' ? query(collection(db,"couples",coupleCode,col), where("authorId","==",userId)) : query(collection(db,"couples",coupleCode,col));
                 const snaps = await getDocs(q); const b = writeBatch(db); snaps.forEach(d=>b.delete(d.ref)); await b.commit();
            } else if (val === '@feel') {
                 document.body.dispatchEvent(new Event('edit-feeling'));
            } else {
                 await addDoc(collection(db,"couples",coupleCode,`chat_${currentChatMode}`), { content:val, authorId:userId, timestamp:Timestamp.now() });
            }
            $('#chat-input').value = '';
        });
        
        $('#chat-mode-toggle').addEventListener('click', async () => {
            const isSecret = currentChatMode === 'secret';
            if(isSecret) await updateDoc(doc(db,"couples",coupleCode), {chatMode:'normal'});
            else await updateDoc(doc(db,"couples",coupleCode), {chatMode:'secret'});
        });
        
        function updateChatUI() {
             const isSecret = currentChatMode === 'secret';
             $('.chat-header').className = `chat-header flex-none px-4 py-3 safe-pt border-b flex justify-between items-center shadow-sm z-20 transition-colors duration-300 ${isSecret ? 'bg-purple-600 border-purple-700 text-white' : 'bg-surface border-gray-100'}`;
             $('.chat-title').innerText = isSecret ? 'Mật Ngọt (Bí mật)' : 'Trò chuyện';
             $('.chat-title').className = `chat-title font-bold text-lg ${isSecret ? 'text-white' : 'text-gray-800'}`;
             $('#chat-mode-toggle').innerHTML = isSecret ? '<i class="fas fa-lock-open"></i>' : '<i class="fas fa-lock"></i>';
             if(isSecret) $('.chat-header button').classList.add('text-white', 'hover:bg-purple-500');
        }

        // Settings Save
        $('#save-info-btn').addEventListener('click', async () => {
            const bgType = $('input[name="bg-type"]:checked').value;
            const bgVal = bgType === 'image' ? $('#setting-game-background').value : [$('#setting-gradient-1').value, $('#setting-gradient-2').value];
            const updates = { 
                startDate: Timestamp.fromDate(new Date($('#setting-start-date').value)),
                background: { type: bgType, value: bgVal },
                decoration: $('#setting-decoration').value,
                customization: { 
                    partner1Border: $('#setting-p1-border')?.value || '#FFF', 
                    partner2Border: $('#setting-p2-border')?.value || '#FFF',
                    counterShape: $('#setting-counter-shape').value
                }
            };
            $$('input[data-pid]').forEach(i => {
                const p = coupleData.partner1.userId === i.dataset.pid ? 'partner1' : 'partner2';
                updates[`${p}.${i.dataset.f}`] = i.value;
            });
            await updateDoc(doc(db, "couples", coupleCode), updates);
        });
        
        // Navigation Logic
        $$('.nav-link').forEach(l => l.addEventListener('click', () => {
             $$('.nav-link').forEach(n => n.classList.remove('active'));
             l.classList.add('active');
             $$('.tab-content').forEach(c => {
                 if(c.id === `${l.dataset.tab}-content`) {
                     c.classList.remove('hidden');
                     setTimeout(()=>c.classList.remove('opacity-0'), 10);
                 } else {
                     c.classList.add('opacity-0');
                     setTimeout(()=>c.classList.add('hidden'), 300);
                 }
             });
        }));

        // Accordion
        $$('.accordion-header').forEach(h => h.addEventListener('click', () => {
            const c = h.nextElementSibling;
            const open = c.style.maxHeight;
            c.style.maxHeight = open ? null : c.scrollHeight + "px";
            h.querySelector('.fa-chevron-down').style.transform = open ? 'rotate(0deg)' : 'rotate(180deg)';
        }));

        // Feeling Logic
        document.body.addEventListener('edit-feeling', () => {
             const m = createModal('feel-mod', 'Cảm xúc', `<input id="f-txt" placeholder="Nghĩ gì thế..." class="w-full p-3 mb-3 bg-gray-50 rounded-xl border-0"><select id="f-dur" class="w-full p-3 bg-gray-50 rounded-xl border-0 text-sm"><option value="3600">1 giờ</option><option value="86400">24 giờ</option><option value="inf">Mãi mãi</option></select>`, `<button id="save-f" class="w-full py-3 bg-primary text-white rounded-xl font-bold">Lưu</button>`);
             m.querySelector('#save-f').addEventListener('click', async () => {
                 const t = m.querySelector('#f-txt').value;
                 const d = m.querySelector('#f-dur').value;
                 const exp = d === 'inf' ? null : Timestamp.fromMillis(Date.now() + d * 1000);
                 const p = coupleData.partner1.userId === userId ? 'partner1' : 'partner2';
                 await updateDoc(doc(db,"couples",coupleCode), { [`${p}.feeling`]: t, [`${p}.feelingExpiresAt`]: exp });
                 m.remove();
             });
        });
        // Long press logic
        document.addEventListener('touchstart', e => { if(e.target.closest('.character-container[data-user-id="'+userId+'"]')) pressTimer = setTimeout(()=>document.body.dispatchEvent(new Event('edit-feeling')), 800); }, {passive:true});
        document.addEventListener('touchend', () => clearTimeout(pressTimer));
        
        $('#logout-btn').addEventListener('click', () => signOut(auth));
        $('#copy-code-btn').addEventListener('click', () => { navigator.clipboard.writeText(coupleCode); alert('Đã sao chép!'); });
        $$('input[name="bg-type"]').forEach(r => r.addEventListener('change', e => { $('#background-image-settings').classList.toggle('hidden', e.target.value !== 'image'); $('#background-gradient-settings').classList.toggle('hidden', e.target.value !== 'gradient'); }));
        $('#command-toggle-btn').addEventListener('click', () => $('#command-popup').classList.toggle('hidden'));
        $('#command-popup').addEventListener('click', e => { const b = e.target.closest('button'); if(b) { if(b.dataset.command === '@feel') document.body.dispatchEvent(new Event('edit-feeling')); else $('#chat-input').value = b.dataset.command; $('#command-popup').classList.add('hidden'); }});
        
        // Initial setup
        const renderProfileSetupModal = (pNum) => {
            if ($('#profile-setup-modal')) return;
            const m = createModal('profile-setup-modal', 'Chào mừng!', 
                `<p class="mb-4 text-gray-500 text-sm">Hãy nhập thông tin để người ấy nhận ra bạn nhé.</p><input id="p-name" placeholder="Tên hiển thị" class="w-full mb-3 p-3 bg-gray-50 rounded-xl"><input id="p-dob" type="date" class="w-full mb-3 p-3 bg-gray-50 rounded-xl"><select id="p-gen" class="w-full p-3 bg-gray-50 rounded-xl"><option value="male">Nam</option><option value="female">Nữ</option></select>`, 
                `<button id="save-p" class="w-full py-3 bg-primary text-white rounded-xl font-bold">Bắt đầu</button>`
            );
            m.querySelector('#save-p').addEventListener('click', async () => {
                const [n,d,g] = ['#p-name','#p-dob','#p-gen'].map(s=>m.querySelector(s).value);
                if(!n||!d) return;
                await updateDoc(doc(db,"couples",coupleCode), { [`partner${pNum}`]: { userId, name:n, dob:d, gender:g, photoURL: g==='male'?'https://i.ibb.co/1M832Ww/image.png':'https://i.ibb.co/3kCcvS0/image.png', feeling:'' } });
                m.remove();
            });
        };

        // --- DECORATION CANVAS (Ported logic) ---
        function startDecorationAnimation(effect) {
             if (decorationAnimationId) cancelAnimationFrame(decorationAnimationId);
             const canvas = $('#decoration-canvas');
             const ctx = canvas.getContext('2d');
             canvas.width = canvas.offsetWidth; canvas.height = canvas.offsetHeight;
             ctx.clearRect(0, 0, canvas.width, canvas.height);
             if (!effect || effect === 'none') return;

             let particles = [];
             if (effect === 'snow') {
                 for(let i=0;i<100;i++) particles.push({x:Math.random()*canvas.width, y:Math.random()*canvas.height, r:Math.random()*3+1, d:Math.random()+1});
                 const anim = () => {
                     ctx.clearRect(0,0,canvas.width,canvas.height); ctx.fillStyle="rgba(255,255,255,0.8)"; ctx.beginPath();
                     particles.forEach(p=>{ ctx.moveTo(p.x,p.y); ctx.arc(p.x,p.y,p.r,0,Math.PI*2,true); }); ctx.fill();
                     particles.forEach(p=>{ p.y+=p.d; p.x+=Math.sin(p.y/50)*0.2; if(p.y>canvas.height){p.y=-10;p.x=Math.random()*canvas.width;} });
                     decorationAnimationId = requestAnimationFrame(anim);
                 }; anim();
             } else if (effect === 'sakura') {
                 for(let i=0;i<40;i++) particles.push({x:Math.random()*canvas.width, y:Math.random()*canvas.height, s:Math.random()*2+3, d:Math.random()+1, r:Math.random()*360, rs:(Math.random()-0.5)});
                 const anim = () => {
                     ctx.clearRect(0,0,canvas.width,canvas.height); ctx.fillStyle="rgba(255,192,203,0.8)"; ctx.font="20px serif";
                     particles.forEach(p=>{ ctx.save(); ctx.translate(p.x,p.y); ctx.rotate(p.r*Math.PI/180); ctx.fillText('🌸',0,0); ctx.restore(); p.y+=p.d; p.x+=Math.sin(p.y/50)*0.5; p.r+=p.rs; if(p.y>canvas.height) p.y=-20; });
                     decorationAnimationId = requestAnimationFrame(anim);
                 }; anim();
             } else if (effect === 'stars') {
                 for(let i=0;i<100;i++) particles.push({x:Math.random()*canvas.width, y:Math.random()*canvas.height, r:Math.random()*1.5, o:Math.random(), f:Math.random()>0.5});
                 const anim = () => {
                     ctx.clearRect(0,0,canvas.width,canvas.height); 
                     particles.forEach(p=>{ ctx.fillStyle=`rgba(255,255,255,${p.o})`; ctx.beginPath(); ctx.arc(p.x,p.y,p.r,0,Math.PI*2); ctx.fill(); p.o+=p.f?0.005:-0.005; if(p.o<=0.1)p.f=true; if(p.o>=1)p.f=false; });
                     decorationAnimationId = requestAnimationFrame(anim);
                 }; anim();
             }
        }
    </script>
</body>
</html>