<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Trình Quản Lý Đơn Hàng (Nâng cao)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        .toggle-checkbox:checked {
            right: 0;
            border-color: #4f46e5;
        }
        .toggle-checkbox:checked + .toggle-label {
            background-color: #4f46e5;
        }
        .modal {
            transition: opacity 0.3s ease, visibility 0.3s ease;
        }
        .modal-content {
            transition: transform 0.3s ease;
        }
        #table-container .table-wrapper {
            margin-bottom: 2rem;
        }
    </style>
</head>
<body class="bg-gray-100 text-gray-800">

    <div class="container mx-auto p-4 md:p-8">
        <header class="text-center mb-8">
            <h1 class="text-3xl md:text-4xl font-bold text-indigo-600">Trình Quản Lý Đơn Hàng</h1>
            <p class="text-gray-500 mt-2">Tạo, tìm kiếm và quản lý đơn hàng chuyên nghiệp.</p>
        </header>

        <div class="flex justify-center mb-8">
            <button id="create-order-btn" class="bg-indigo-600 text-white font-bold py-3 px-6 rounded-lg shadow-lg hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:ring-opacity-50 transition-transform transform hover:scale-105">
                <i class="fas fa-plus mr-2"></i> Tạo Đơn Hàng Mới
            </button>
        </div>

        <!-- Controls: Search, Filter, Split View -->
        <div class="bg-white p-4 rounded-xl shadow-md mb-8 grid grid-cols-1 md:grid-cols-3 gap-4 items-end">
            <div class="col-span-1 md:col-span-1">
                <label for="search-input" class="block text-sm font-medium text-gray-700 mb-1">Tìm kiếm</label>
                <div class="relative">
                    <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                        <i class="fas fa-search text-gray-400"></i>
                    </div>
                    <input type="search" id="search-input" class="w-full pl-10 pr-4 py-2 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500" placeholder="Tên khách hàng hoặc mã đơn...">
                </div>
            </div>
            <div class="col-span-1 md:col-span-1">
                <label for="customer-filter" class="block text-sm font-medium text-gray-700 mb-1">Lọc theo khách hàng</label>
                <select id="customer-filter" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500 bg-white">
                    <option value="all">Tất cả khách hàng</option>
                </select>
            </div>
            <div class="col-span-1 md:col-span-1 flex justify-start md:justify-end">
                 <button id="split-view-btn" class="bg-teal-500 text-white font-bold py-2 px-4 rounded-lg hover:bg-teal-600 w-full md:w-auto">
                    <i class="fas fa-columns mr-2"></i> Tách theo khách hàng
                </button>
            </div>
        </div>

        <!-- Table Container -->
        <div id="table-container">
             <!-- Tables will be rendered here by JavaScript -->
        </div>

    </div>

    <!-- Modal for creating order -->
    <div id="order-modal" class="modal fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 invisible opacity-0">
        <div id="modal-content" class="modal-content bg-white rounded-xl shadow-2xl w-full max-w-md transform scale-95">
            <!-- Step 1: Customer Name -->
            <div id="step-1">
                <div class="p-6 border-b"><h3 class="text-lg font-semibold">Bước 1: Nhập Tên Khách Hàng</h3></div>
                <div class="p-6">
                    <label for="customer-name" class="block text-sm font-medium text-gray-700 mb-2">Tên khách hàng</label>
                    <input type="text" id="customer-name" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500" placeholder="Ví dụ: Nguyễn Văn A">
                </div>
                <div class="p-4 bg-gray-50 flex justify-end rounded-b-xl">
                    <button id="close-modal-btn-1" class="bg-gray-200 text-gray-700 font-bold py-2 px-4 rounded-lg mr-2 hover:bg-gray-300">Hủy</button>
                    <button id="next-step-btn" class="bg-indigo-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-indigo-700">Tiếp theo <i class="fas fa-arrow-right ml-1"></i></button>
                </div>
            </div>

            <!-- Step 2: Order Code -->
            <div id="step-2" class="hidden">
                <div class="p-6 border-b"><h3 class="text-lg font-semibold">Bước 2: Nhập Mã Đơn Hàng</h3></div>
                <div class="p-6 space-y-4">
                    <div>
                        <label for="order-code" class="block text-sm font-medium text-gray-700 mb-2">Nội dung đơn hàng (mỗi mã một dòng)</label>
                        <textarea id="order-code" rows="5" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500" placeholder="Dán danh sách mã đơn hàng vào đây. Mỗi mã sẽ là một hàng riêng."></textarea>
                    </div>
                    <div class="flex items-center justify-between">
                        <button id="paste-btn" class="bg-green-500 text-white font-bold py-2 px-4 rounded-lg hover:bg-green-600 flex items-center"><i class="fas fa-paste mr-2"></i> Dán</button>
                        <div class="flex items-center space-x-2">
                            <span class="text-sm font-medium text-gray-700">Dán nhanh</span>
                            <div class="relative inline-block w-10 mr-2 align-middle select-none transition duration-200 ease-in">
                                <input type="checkbox" name="toggle" id="quick-paste-toggle" class="toggle-checkbox absolute block w-6 h-6 rounded-full bg-white border-4 appearance-none cursor-pointer"/>
                                <label for="quick-paste-toggle" class="toggle-label block overflow-hidden h-6 rounded-full bg-gray-300 cursor-pointer"></label>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="p-4 bg-gray-50 flex justify-between rounded-b-xl">
                    <button id="back-step-btn" class="bg-gray-200 text-gray-700 font-bold py-2 px-4 rounded-lg hover:bg-gray-300"><i class="fas fa-arrow-left mr-1"></i> Quay lại</button>
                    <div>
                        <button id="close-modal-btn-2" class="bg-gray-200 text-gray-700 font-bold py-2 px-4 rounded-lg mr-2 hover:bg-gray-300">Hủy</button>
                        <button id="confirm-order-btn" class="bg-indigo-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-indigo-700">Xác nhận <i class="fas fa-check ml-1"></i></button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
    document.addEventListener('DOMContentLoaded', () => {
        // --- DOM Elements ---
        const createOrderBtn = document.getElementById('create-order-btn');
        const orderModal = document.getElementById('order-modal');
        const modalContent = document.getElementById('modal-content');
        const closeModalBtn1 = document.getElementById('close-modal-btn-1');
        const closeModalBtn2 = document.getElementById('close-modal-btn-2');
        const step1 = document.getElementById('step-1');
        const customerNameInput = document.getElementById('customer-name');
        const nextStepBtn = document.getElementById('next-step-btn');
        const step2 = document.getElementById('step-2');
        const orderCodeTextarea = document.getElementById('order-code');
        const pasteBtn = document.getElementById('paste-btn');
        const quickPasteToggle = document.getElementById('quick-paste-toggle');
        const backStepBtn = document.getElementById('back-step-btn');
        const confirmOrderBtn = document.getElementById('confirm-order-btn');
        const tableContainer = document.getElementById('table-container');
        const searchInput = document.getElementById('search-input');
        const customerFilter = document.getElementById('customer-filter');
        const splitViewBtn = document.getElementById('split-view-btn');

        // --- State ---
        let orders = [];
        let currentCustomerName = '';
        let isSplitView = false;

        // --- Modal Handling ---
        const showModal = () => {
            orderModal.classList.remove('invisible', 'opacity-0');
            modalContent.classList.remove('scale-95');
        };
        const hideModal = () => {
            modalContent.classList.add('scale-95');
            orderModal.classList.add('opacity-0');
            setTimeout(() => {
                orderModal.classList.add('invisible');
                resetModal();
            }, 300);
        };
        const resetModal = () => {
            step1.classList.remove('hidden');
            step2.classList.add('hidden');
            customerNameInput.value = '';
            orderCodeTextarea.value = '';
            currentCustomerName = '';
            quickPasteToggle.checked = false;
        };
        createOrderBtn.addEventListener('click', showModal);
        closeModalBtn1.addEventListener('click', hideModal);
        closeModalBtn2.addEventListener('click', hideModal);
        orderModal.addEventListener('click', (e) => e.target === orderModal && hideModal());

        // --- Step Navigation ---
        nextStepBtn.addEventListener('click', () => {
            if (customerNameInput.value.trim() === '') {
                alert('Vui lòng nhập tên khách hàng.');
                return;
            }
            currentCustomerName = customerNameInput.value.trim();
            step1.classList.add('hidden');
            step2.classList.remove('hidden');
        });
        backStepBtn.addEventListener('click', () => {
            step2.classList.add('hidden');
            step1.classList.remove('hidden');
        });

        // --- Clipboard and Order Logic ---
        const handlePaste = async () => {
            try {
                const text = await navigator.clipboard.readText();
                const currentText = orderCodeTextarea.value;
                if (currentText.trim()) {
                    orderCodeTextarea.value = currentText + '\n' + text;
                } else {
                    orderCodeTextarea.value = text;
                }
            } catch (err) {
                console.error('Failed to read clipboard: ', err);
                alert('Không thể dán từ clipboard.');
            }
        };
        pasteBtn.addEventListener('click', handlePaste);
        window.addEventListener('focus', () => {
            if (quickPasteToggle.checked && document.activeElement !== orderCodeTextarea) {
                handlePaste();
            }
        });

        confirmOrderBtn.addEventListener('click', () => {
            const orderCodes = orderCodeTextarea.value.trim().split('\n').filter(code => code.trim() !== '');
            if (orderCodes.length === 0) {
                alert('Vui lòng nhập ít nhất một mã đơn hàng.');
                return;
            }
            orderCodes.forEach(code => {
                const newOrder = {
                    id: Date.now() + Math.random(), // Use random to avoid collision
                    customer: currentCustomerName,
                    code: code.trim()
                };
                orders.push(newOrder);
            });
            updateCustomerFilter();
            render();
            hideModal();
        });

        // --- Rendering Logic ---
        const render = () => {
            if (isSplitView) {
                renderSplitView();
                splitViewBtn.innerHTML = '<i class="fas fa-compress-arrows-alt mr-2"></i> Gộp Bảng';
                splitViewBtn.classList.replace('bg-teal-500', 'bg-orange-500');
                splitViewBtn.classList.replace('hover:bg-teal-600', 'hover:bg-orange-600');
            } else {
                renderCombinedTable();
                splitViewBtn.innerHTML = '<i class="fas fa-columns mr-2"></i> Tách theo khách hàng';
                splitViewBtn.classList.replace('bg-orange-500', 'bg-teal-500');
                splitViewBtn.classList.replace('hover:bg-orange-600', 'hover:bg-teal-600');
            }
        };

        const getFilteredOrders = () => {
            const searchTerm = searchInput.value.toLowerCase();
            const selectedCustomer = customerFilter.value;

            return orders.filter(order => {
                const matchesSearch = searchTerm === '' ||
                    order.customer.toLowerCase().includes(searchTerm) ||
                    order.code.toLowerCase().includes(searchTerm);
                const matchesFilter = selectedCustomer === 'all' || order.customer === selectedCustomer;
                return matchesSearch && matchesFilter;
            });
        };

        const createTableHTML = (orderList, title) => {
            if (orderList.length === 0) {
                return title ? '' : `<div class="bg-white rounded-xl shadow-lg p-12 text-center text-gray-400">
                                        <i class="fas fa-box-open fa-3x mb-3"></i>
                                        <p>Không có đơn hàng nào phù hợp.</p>
                                     </div>`;
            }

            const rows = orderList.map((order, index) => `
                <tr class="hover:bg-gray-50">
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${index + 1}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-600">${escapeHTML(order.customer)}</td>
                    <td class="px-6 py-4 whitespace-pre-wrap text-sm text-gray-600">${escapeHTML(order.code)}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-center text-sm font-medium">
                        <button class="text-red-600 hover:text-red-900" onclick="deleteOrder(${order.id})">
                            <i class="fas fa-trash-alt mr-1"></i> Xóa
                        </button>
                    </td>
                </tr>
            `).join('');

            return `
                <div class="table-wrapper bg-white rounded-xl shadow-lg overflow-hidden">
                    ${title ? `<div class="p-4 sm:p-6 border-b border-gray-200"><h2 class="text-xl font-semibold">${escapeHTML(title)}</h2></div>` : ''}
                    <div class="overflow-x-auto">
                        <table class="min-w-full divide-y divide-gray-200">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">STT</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Khách Hàng</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Mã Đơn Hàng</th>
                                    <th class="px-6 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">Hành động</th>
                                </tr>
                            </thead>
                            <tbody class="bg-white divide-y divide-gray-200">${rows}</tbody>
                        </table>
                    </div>
                </div>
            `;
        };

        const renderCombinedTable = () => {
            const filteredOrders = getFilteredOrders();
            tableContainer.innerHTML = createTableHTML(filteredOrders, 'Danh Sách Đơn Hàng');
        };

        const renderSplitView = () => {
            const filteredOrders = getFilteredOrders();
            const groupedByCustomer = filteredOrders.reduce((acc, order) => {
                (acc[order.customer] = acc[order.customer] || []).push(order);
                return acc;
            }, {});

            let html = '';
            const sortedCustomers = Object.keys(groupedByCustomer).sort();

            for (const customerName of sortedCustomers) {
                html += createTableHTML(groupedByCustomer[customerName], `Khách hàng: ${customerName}`);
            }

            if(html === '') {
                 html = `<div class="bg-white rounded-xl shadow-lg p-12 text-center text-gray-400">
                            <i class="fas fa-users fa-3x mb-3"></i>
                            <p>Không có khách hàng nào phù hợp.</p>
                         </div>`;
            }
            tableContainer.innerHTML = html;
        };

        // --- Event Listeners for Controls ---
        searchInput.addEventListener('input', render);
        customerFilter.addEventListener('change', render);
        splitViewBtn.addEventListener('click', () => {
            isSplitView = !isSplitView;
            render();
        });

        // --- Utility Functions ---
        const updateCustomerFilter = () => {
            const uniqueCustomers = [...new Set(orders.map(o => o.customer))].sort();
            const currentSelection = customerFilter.value;
            customerFilter.innerHTML = '<option value="all">Tất cả khách hàng</option>';
            uniqueCustomers.forEach(customer => {
                const option = document.createElement('option');
                option.value = customer;
                option.textContent = customer;
                customerFilter.appendChild(option);
            });
             // Restore selection if possible
            if (uniqueCustomers.includes(currentSelection)) {
                customerFilter.value = currentSelection;
            }
        };

        window.deleteOrder = (id) => {
            if (confirm('Bạn có chắc chắn muốn xóa đơn hàng này không?')) {
                orders = orders.filter(order => order.id !== id);
                updateCustomerFilter();
                render();
            }
        };

        function escapeHTML(str) {
            return str.replace(/[&<>"']/g, match => ({
                '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#39;'
            }[match]));
        }

        // --- Initial Load ---
        render();
    });
    </script>
</body>
</html>
