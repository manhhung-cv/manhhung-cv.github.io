<!DOCTYPE html>
<html lang="vi">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Family Chore App</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">

    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="mobile-web-app-capable" content="yes">
    <link rel="icon" href="/Asset/logo/iconApps.png" />
    <link rel="apple-touch-icon" href="/Asset/logo/iconApps.png" sizes="150x150" />

    <meta property="og:image" content="/Asset/img/Banner.png" />
    <meta property="og:title" content="Share&Go" />
    <meta property="og:description" content="Thi·∫øt k·∫ø v√† l·∫≠p tr√¨nh ƒêinh M·∫°nh H√πng" />


    <script src="https://cdn.tailwindcss.com"></script>

    <link href="https://fonts.googleapis.com/css2?family=Nunito:wght@400;600;700;800&display=swap" rel="stylesheet">

    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-auth.js";
        import { getFirestore, collection, addDoc, updateDoc, deleteDoc, doc, onSnapshot, query, orderBy, limit, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-firestore.js";

        // --- C·∫§U H√åNH FIREBASE ---
        const firebaseConfig = {
            apiKey: "AIzaSyBevgQ-MEoSg1tnLyvOFY8ndcKN7HvaahU",
            authDomain: "fami-wallet.firebaseapp.com",
            projectId: "fami-wallet",
            storageBucket: "fami-wallet.firebasestorage.app",
            messagingSenderId: "851225524722",
            appId: "1:851225524722:web:023d64b5b0d7205045d36b",
            measurementId: "G-4DNH0PN1CS"
        };

        const activeConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : firebaseConfig;
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'family-app';

        const app = initializeApp(activeConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // --- STATE ---
        let state = {
            user: null,
            members: [],
            tasks: [],
            announcements: [],
            guides: [],
            reports: [],
            currentView: 'home',
            isAdminUnlocked: false,
            selectedMemberFilter: 'all',
            calendarDate: new Date(),
            reportTargetId: null
        };

        // --- AUTH ---
        signInAnonymously(auth);
        onAuthStateChanged(auth, (user) => {
            if (user) {
                state.user = user;
                initDataListeners();
            }
        });

        // --- LISTENERS ---
        function initDataListeners() {
            onSnapshot(collection(db, 'artifacts', appId, 'public', 'data', 'members'), (snap) => {
                state.members = snap.docs.map(d => ({ id: d.id, ...d.data() }));
                renderApp();
            });
            onSnapshot(collection(db, 'artifacts', appId, 'public', 'data', 'tasks'), (snap) => {
                state.tasks = snap.docs.map(d => ({ id: d.id, ...d.data() }));
                state.tasks.sort((a, b) => a.status === 'pending' ? -1 : 1);
                renderApp();
            });
            onSnapshot(query(collection(db, 'artifacts', appId, 'public', 'data', 'announcements'), orderBy('createdAt', 'desc'), limit(10)), (snap) => {
                state.announcements = snap.docs.map(d => ({ id: d.id, ...d.data() }));
                renderApp();
            });
            onSnapshot(query(collection(db, 'artifacts', appId, 'public', 'data', 'guides'), orderBy('createdAt', 'desc')), (snap) => {
                state.guides = snap.docs.map(d => ({ id: d.id, ...d.data() }));
                renderApp();
            });
            onSnapshot(query(collection(db, 'artifacts', appId, 'public', 'data', 'reports'), orderBy('createdAt', 'desc')), (snap) => {
                state.reports = snap.docs.map(d => ({ id: d.id, ...d.data() }));
                renderApp();
            });
        }

        // --- DOM ---
        const appContainer = document.getElementById('app-content');
        const modalContainer = document.getElementById('modal-container');

        // --- HELPERS ---
        window.getAvatarEmoji = (m) => m?.emoji || m?.avatarSeed || 'üë§';
        window.formatDate = (ts) => {
            if (!ts) return '';
            const d = ts.toDate ? ts.toDate() : new Date(ts);
            return d.toLocaleDateString('vi-VN', { hour: '2-digit', minute: '2-digit', day: 'numeric', month: 'numeric' });
        }
        window.getTodayString = () => new Date().toISOString().split('T')[0];

        // --- RENDER MAIN ---
        window.renderApp = function () {
            const hasNew = state.announcements.length > 0 && state.announcements[0].id !== localStorage.getItem('lastReadAnnouncementId');

            let html = `
                <div class="max-w-md mx-auto bg-gray-50 min-h-screen flex flex-col shadow-2xl relative bg-white">
                    <header class="bg-gradient-to-r from-blue-600 to-indigo-700 text-white p-5 rounded-b-[2rem] shadow-lg z-10 sticky top-0">
                        <div class="flex justify-between items-center mb-4">
                            <div>
                                <h1 class="text-2xl font-black tracking-tight flex items-center gap-2"><i class="fas fa-home"></i> Family App</h1>
                                <p class="text-blue-200 text-xs font-medium">Qu·∫£n l√Ω vi·ªác nh√† th√¥ng minh</p>
                            </div>
                            <div class="flex gap-3">
                                ${state.isAdminUnlocked ? '<span class="px-2 py-1 bg-yellow-400 text-yellow-900 text-xs font-bold rounded-full h-fit self-center">Admin</span>' : ''}
                                <div onclick="openNotifications()" class="h-10 w-10 bg-white/10 rounded-full flex items-center justify-center backdrop-blur-sm relative cursor-pointer hover:bg-white/20 transition-colors">
                                    <i class="fas fa-bell text-white"></i>
                                    ${hasNew ? '<span class="absolute top-2 right-2 w-2.5 h-2.5 bg-red-500 border-2 border-indigo-600 rounded-full animate-pulse"></span>' : ''}
                                </div>
                            </div>
                        </div>
                        ${state.currentView === 'home' ? renderMemberFilter() : ''}
                    </header>

                    <main class="flex-1 overflow-y-auto p-4 pb-24 scroll-smooth bg-gray-50">
                        ${renderCurrentView()}
                    </main>

                    <nav class="fixed bottom-0 w-full max-w-md bg-white/90 backdrop-blur-md border-t border-gray-200 px-4 py-3 shadow-[0_-4px_6px_-1px_rgba(0,0,0,0.05)] z-50 left-1/2 transform -translate-x-1/2 rounded-t-2xl">
                        <div class="flex justify-between items-end">
                            ${renderNavItem('home', 'fa-list-check', 'Vi·ªác nh√†')}
                            ${renderNavItem('calendar', 'fa-calendar-days', 'L·ªãch')}
                            ${renderNavItem('guide', 'fa-book-open', 'H.D·∫´n')}
                            ${renderNavItem('report', 'fa-flag', 'B√°o c√°o')}
                            ${renderNavItem('menu', 'fa-bars', 'Menu')}
                        </div>
                    </nav>
                </div>
            `;
            appContainer.innerHTML = html;
        }

        function renderNavItem(view, icon, label) {
            const active = state.currentView === view;
            return `
                <button onclick="setView('${view}')" class="flex flex-col items-center gap-1 w-1/5 group transition-all">
                    <div class="text-xl ${active ? 'text-blue-600 transform -translate-y-1' : 'text-gray-400 hover:text-gray-600'} transition-transform duration-200">
                        <i class="fas ${icon}"></i>
                    </div>
                    <span class="text-[10px] font-bold ${active ? 'text-blue-600' : 'text-gray-400'}">${label}</span>
                </button>
            `;
        }

        function renderMemberFilter() {
            if (state.members.length === 0) return '';
            let html = `<div class="flex gap-3 overflow-x-auto pb-2 scrollbar-hide items-end h-20">`;
            html += `
                <button onclick="setFilter('all')" class="flex flex-col items-center min-w-[56px] group flex-shrink-0">
                    <div class="w-10 h-10 rounded-full border-2 ${state.selectedMemberFilter === 'all' ? 'border-white bg-white/30' : 'border-transparent bg-white/10'} flex items-center justify-center mb-1 transition-all">
                        <i class="fas fa-users text-white text-sm"></i>
                    </div>
                    <span class="text-[10px] text-white font-medium">T·∫•t c·∫£</span>
                </button>
            `;
            state.members.forEach(m => {
                const active = state.selectedMemberFilter === m.id;
                html += `
                    <button onclick="setFilter('${m.id}')" class="flex flex-col items-center min-w-[56px] group flex-shrink-0">
                        <div class="w-10 h-10 rounded-full border-2 ${active ? 'border-white shadow-lg scale-110' : 'border-transparent opacity-80'} overflow-hidden mb-1 transition-all bg-white flex items-center justify-center text-xl">
                            ${getAvatarEmoji(m)}
                        </div>
                        <span class="text-[10px] text-white font-medium ${active ? 'font-bold' : ''} truncate max-w-[60px]">${m.name}</span>
                    </button>
                `;
            });
            html += `</div>`;
            return html;
        }

        // --- VIEWS ---
        function renderCurrentView() {
            switch (state.currentView) {
                case 'home': return renderHome();
                case 'calendar': return renderCalendar();
                case 'guide': return renderGuide();
                case 'report': return renderReport();
                case 'menu': return renderMenu();
                default: return renderHome();
            }
        }

        function renderHome() {
            let tasks = state.tasks;
            if (state.selectedMemberFilter !== 'all') tasks = tasks.filter(t => t.assignedTo === state.selectedMemberFilter);

            if (tasks.length === 0) return `<div class="flex flex-col items-center justify-center h-64 text-center p-6"><i class="fas fa-check-circle text-6xl text-blue-100 mb-4"></i><h3 class="text-xl font-bold text-gray-700">S·∫°ch b√≥ng!</h3></div>`;

            return `<div class="space-y-3 animate-fade-in-up">
                    ${tasks.map(t => {
                const m = state.members.find(m => m.id === t.assignedTo);
                const isDone = t.status === 'done';
                return `
                        <div class="bg-white p-4 rounded-2xl shadow-sm border border-gray-100 flex items-center gap-4 transition-all ${isDone ? 'opacity-60 grayscale' : ''}">
                            <div onclick="toggleTaskStatus('${t.id}', '${t.status}', '${t.assignedTo}', ${t.points})" class="w-12 h-12 rounded-full flex-shrink-0 flex items-center justify-center cursor-pointer ${isDone ? 'bg-green-100 text-green-600' : 'bg-gray-100 text-gray-400'}"><i class="fas ${isDone ? 'fa-check' : 'fa-circle'} text-xl"></i></div>
                            <div class="flex-1 min-w-0">
                                <div class="flex justify-between items-start"><h4 class="font-bold text-gray-800 truncate ${isDone ? 'line-through' : ''}">${t.title}</h4><span class="text-[10px] font-bold px-2 py-1 rounded-full bg-blue-50 text-blue-600">+${t.points}ƒë</span></div>
                                <div class="flex items-center gap-2 mt-1">
                                    ${m ? `<div class="flex items-center gap-1 bg-gray-50 px-2 py-0.5 rounded-full"><span class="text-sm">${getAvatarEmoji(m)}</span><span class="text-xs text-gray-600 truncate">${m.name}</span></div>` : `<span class="text-xs text-gray-400 italic">Ch∆∞a ph√¢n c√¥ng</span>`}
                                    <span class="text-[10px] text-gray-400 border-l pl-2 border-gray-300 capitalize">${t.frequency === 'daily' ? 'H√†ng ng√†y' : 'H√†ng tu·∫ßn'}</span>
                                </div>
                            </div>
                        </div>`
            }).join('')}
                </div>`;
        }

        function renderCalendar() {
            const now = state.calendarDate;
            const daysInMonth = new Date(now.getFullYear(), now.getMonth() + 1, 0).getDate();
            const firstDay = new Date(now.getFullYear(), now.getMonth(), 1).getDay();
            let daysHtml = '';
            for (let i = 0; i < firstDay; i++) daysHtml += `<div class="h-10"></div>`;
            for (let d = 1; d <= daysInMonth; d++) {
                const isSelected = d === now.getDate();
                daysHtml += `<div onclick="selectDate(${d})" class="h-10 flex items-center justify-center rounded-lg cursor-pointer text-sm font-medium ${isSelected ? 'bg-blue-600 text-white shadow-md' : 'text-gray-700 hover:bg-gray-100'}">${d}</div>`;
            }
            const selectedDateStr = now.toDateString();
            const tasksForDate = state.tasks.filter(t => t.frequency === 'daily' || (t.createdAt && new Date(t.createdAt.seconds * 1000).toDateString() === selectedDateStr));
            return `
                <div class="animate-fade-in-up">
                    <div class="bg-white rounded-2xl p-4 shadow-sm border border-gray-100 mb-4">
                        <div class="flex justify-between items-center mb-4">
                            <button onclick="changeMonth(-1)" class="w-8 h-8 rounded-full bg-gray-50 flex items-center justify-center"><i class="fas fa-chevron-left"></i></button>
                            <h2 class="text-lg font-bold text-gray-800">Th√°ng ${now.getMonth() + 1}, ${now.getFullYear()}</h2>
                            <button onclick="changeMonth(1)" class="w-8 h-8 rounded-full bg-gray-50 flex items-center justify-center"><i class="fas fa-chevron-right"></i></button>
                        </div>
                        <div class="grid grid-cols-7 gap-1 text-center mb-2 font-bold text-gray-400 text-xs"><span>CN</span><span>T2</span><span>T3</span><span>T4</span><span>T5</span><span>T6</span><span>T7</span></div>
                        <div class="grid grid-cols-7 gap-1">${daysHtml}</div>
                    </div>
                    <div class="px-1"><h3 class="font-bold text-gray-700 mb-3">C√¥ng vi·ªác ng√†y ${now.getDate()}</h3>
                        <div class="space-y-2">${tasksForDate.length > 0 ? tasksForDate.map(t => `<div class="bg-white p-3 rounded-xl border border-gray-100 flex items-center gap-3"><div class="w-2 h-10 ${t.status === 'done' ? 'bg-green-500' : 'bg-gray-300'} rounded-full"></div><div class="flex-1 text-sm font-bold text-gray-800">${t.title}</div>${t.status === 'done' ? '<i class="fas fa-check text-green-500"></i>' : ''}</div>`).join('') : '<p class="text-center text-sm text-gray-400 italic">Kh√¥ng c√≥ l·ªãch.</p>'}</div>
                    </div>
                </div>`;
        }

        function renderGuide() {
            return `<div class="animate-fade-in-up space-y-4">
                <div class="flex justify-between items-center mb-2 px-1"><h2 class="text-xl font-bold text-gray-800">H∆∞·ªõng d·∫´n</h2>${state.isAdminUnlocked ? `<button onclick="openModal('addGuide')" class="text-xs bg-blue-100 text-blue-600 px-3 py-1 rounded-full font-bold">+ Vi·∫øt b√†i</button>` : ''}</div>
                ${state.guides.map(g => `<div class="bg-white rounded-2xl p-5 shadow-sm border border-gray-100"><h3 class="font-bold text-lg text-gray-800 mb-2">${g.title}</h3><div class="text-sm text-gray-600 whitespace-pre-line">${g.content}</div>${state.isAdminUnlocked ? `<div class="mt-3 text-right"><button onclick="deleteGuide('${g.id}')" class="text-xs text-red-500">Xo√°</button></div>` : ''}</div>`).join('')}
            </div>`;
        }

        function renderReport() {
            return `
                <div class="animate-fade-in-up pb-10">
                    <div class="bg-white rounded-2xl p-6 shadow-sm border border-gray-100 mb-6">
                        <h2 class="text-xl font-bold text-red-600 mb-2 flex items-center gap-2">
                            <i class="fas fa-shield-alt"></i> B√°o C√°o Vi Ph·∫°m
                        </h2>
                        
                        <p class="text-xs font-bold text-gray-600 mb-2 mt-4">Ai ƒë√£ vi ph·∫°m?</p>
                        <div class="grid grid-cols-4 gap-2 mb-4">
                            ${state.members.map(m => `
                                <div onclick="setReportTarget('${m.id}')" 
                                    class="flex flex-col items-center justify-center p-2 rounded-xl border-2 transition-all cursor-pointer ${state.reportTargetId === m.id ? 'border-red-500 bg-red-50' : 'border-gray-100 hover:border-red-200'}">
                                    <div class="text-2xl">${getAvatarEmoji(m)}</div>
                                    <div class="text-[10px] font-bold text-gray-700 truncate w-full text-center mt-1">${m.name}</div>
                                </div>
                            `).join('')}
                        </div>

                        <p class="text-xs font-bold text-gray-600 mb-2">Th·ªùi gian</p>
                        <input type="date" id="report-date" value="${getTodayString()}" class="w-full p-3 border border-gray-200 rounded-xl bg-gray-50 text-sm font-medium mb-4">

                        <p class="text-xs font-bold text-gray-600 mb-2">L√Ω do b√°o c√°o</p>
                        <textarea id="report-reason" rows="2" placeholder="V√≠ d·ª•: Ch∆∞a r·ª≠a b√°t..." class="w-full p-3 border border-gray-200 rounded-xl bg-gray-50 text-sm mb-4"></textarea>
                        
                        <button onclick="submitReport()" class="w-full bg-red-500 text-white font-bold py-3 rounded-xl hover:bg-red-600 shadow-md">
                            G·ª≠i B√°o C√°o
                        </button>
                    </div>

                    ${state.isAdminUnlocked ? renderAdminReports() : ''}
                </div>
            `;
        }

        function renderAdminReports() {
            return `
                <div class="bg-red-50 rounded-2xl p-4 border border-red-100">
                    <h3 class="font-bold text-red-800 mb-3 text-sm">X·ª¨ L√ù B√ÅO C√ÅO (ADMIN)</h3>
                    <div class="space-y-3">
                        ${state.reports.map(r => {
                const target = state.members.find(m => m.id === r.targetId);
                return `
                                <div class="bg-white p-3 rounded-xl border border-red-100 shadow-sm">
                                    <div class="flex justify-between text-xs font-bold text-gray-700 mb-1">
                                        <span class="text-red-600"><i class="fas fa-exclamation-circle"></i> B·ªã b√°o c√°o: ${target ? target.name : '?'}</span>
                                        <span class="text-gray-400">${r.date}</span>
                                    </div>
                                    <p class="text-sm text-gray-800 my-2">"${r.reason}"</p>
                                    <div class="flex gap-2 justify-end pt-2 border-t border-gray-50">
                                        <button onclick="deleteReport('${r.id}')" class="px-3 py-1.5 rounded-lg bg-gray-100 text-gray-500 text-xs font-bold">Hu·ª∑ b·ªè</button>
                                        <button onclick="resolveReport('${r.id}', '${r.targetId}', '${r.reason}')" class="px-3 py-1.5 rounded-lg bg-red-600 text-white text-xs font-bold shadow-sm">
                                            <i class="fas fa-gavel"></i> X√°c th·ª±c & Tr·ª´ ƒëi·ªÉm
                                        </button>
                                    </div>
                                </div>
                             `
            }).join('')}
                        ${state.reports.length === 0 ? '<p class="text-xs text-center text-red-400 italic">Kh√¥ng c√≥ b√°o c√°o n√†o.</p>' : ''}
                    </div>
                </div>
             `
        }

        function renderMenu() {
            const sorted = [...state.members].sort((a, b) => (b.totalPoints || 0) - (a.totalPoints || 0));
            return `<div class="animate-fade-in-up space-y-6">
                <div class="bg-gradient-to-br from-yellow-100 to-orange-100 rounded-3xl p-6 shadow-sm relative overflow-hidden">
                    <h2 class="text-xl font-bold text-orange-800 mb-4 flex items-center gap-2 relative z-10"><i class="fas fa-trophy text-yellow-500"></i> B·∫£ng X·∫øp H·∫°ng</h2>
                    <div class="space-y-3 relative z-10">${sorted.map((m, i) => `<div class="bg-white/80 backdrop-blur-sm p-3 rounded-xl flex items-center gap-3"><div class="font-bold text-lg w-6 text-center text-gray-600">${i + 1}</div><div class="text-2xl">${getAvatarEmoji(m)}</div><div class="flex-1 font-bold text-gray-800 text-sm">${m.name}</div><div class="font-black text-orange-600">${m.totalPoints || 0}ƒë</div></div>`).join('')}</div>
                </div>
                <div class="bg-white rounded-2xl p-6 shadow-sm border border-gray-100">
                    <h2 class="text-lg font-bold text-gray-800 mb-4 flex items-center gap-2"><i class="fas fa-user-shield text-purple-600"></i> Qu·∫£n tr·ªã vi√™n</h2>
                    ${!state.isAdminUnlocked ? `<div class="flex gap-2"><input type="password" id="admin-pin" placeholder="PIN (123456)" class="flex-1 p-3 border border-gray-200 rounded-xl text-center font-bold tracking-widest"><button onclick="checkPin()" class="bg-purple-600 text-white px-6 rounded-xl font-bold">M·ªü</button></div><p id="pin-error" class="text-red-500 text-xs hidden mt-2">M√£ PIN sai!</p>` : renderAdminPanel()}
                </div>
            </div>`;
        }

        function renderAdminPanel() {
            return `
                <div class="space-y-4">
                    <div class="flex justify-between items-center bg-purple-50 p-3 rounded-xl border border-purple-100"><span class="text-purple-700 font-bold text-sm">Ch·∫ø ƒë·ªô Admin</span><button onclick="lockAdmin()" class="text-xs bg-white text-purple-600 px-3 py-1 rounded-lg border border-purple-200">Kho√°</button></div>
                    <div class="grid grid-cols-2 gap-3">
                        <button onclick="openModal('addMember')" class="p-3 bg-gray-50 rounded-xl text-center"><i class="fas fa-user-plus text-green-500 mb-1 text-xl"></i><div class="text-xs font-bold text-gray-700">Th√™m ng∆∞·ªùi</div></button>
                        <button onclick="openModal('addTask')" class="p-3 bg-gray-50 rounded-xl text-center"><i class="fas fa-plus-circle text-blue-500 mb-1 text-xl"></i><div class="text-xs font-bold text-gray-700">Th√™m Vi·ªác</div></button>
                        <button onclick="openModal('postAnnouncement')" class="p-3 bg-gray-50 rounded-xl text-center"><i class="fas fa-bullhorn text-orange-500 mb-1 text-xl"></i><div class="text-xs font-bold text-gray-700">Th√¥ng B√°o</div></button>
                        <button onclick="openModal('assignOptions')" class="p-3 bg-indigo-50 border border-indigo-200 rounded-xl text-center"><i class="fas fa-random text-indigo-600 mb-1 text-xl"></i><div class="text-xs font-bold text-indigo-700">Ph√¢n C√¥ng</div></button>
                    </div>

                    <div class="pt-4 border-t border-gray-100">
                         <p class="text-xs font-bold text-gray-400 uppercase mb-2">Qu·∫£n l√Ω th√†nh vi√™n & ƒêi·ªÉm</p>
                         <div class="space-y-2">
                            ${state.members.map(m => `
                                <div class="flex justify-between items-center bg-gray-50 p-2 rounded-lg border border-gray-100">
                                    <div class="flex items-center gap-2">
                                        <span class="text-xl">${getAvatarEmoji(m)}</span>
                                        <span class="text-sm font-bold text-gray-700">${m.name}</span>
                                        <span class="text-[10px] bg-purple-100 text-purple-700 px-1.5 py-0.5 rounded font-bold">${m.totalPoints || 0}ƒë</span>
                                    </div>
                                    <div class="flex gap-1">
                                        <button onclick="openModal('adjustPoints', '${m.id}')" class="w-8 h-8 bg-white text-yellow-600 rounded-full shadow-sm flex items-center justify-center hover:bg-yellow-50 border border-gray-200" title="C·ªông/Tr·ª´ ƒëi·ªÉm">
                                            <i class="fas fa-coins text-xs"></i>
                                        </button>
                                        <button onclick="openModal('editMember', '${m.id}')" class="w-8 h-8 bg-white text-blue-600 rounded-full shadow-sm flex items-center justify-center hover:bg-blue-50 border border-gray-200">
                                            <i class="fas fa-pencil-alt text-xs"></i>
                                        </button>
                                        <button onclick="deleteMember('${m.id}')" class="w-8 h-8 bg-white text-red-500 rounded-full shadow-sm flex items-center justify-center hover:bg-red-50 border border-gray-200">
                                            <i class="fas fa-trash text-xs"></i>
                                        </button>
                                    </div>
                                </div>
                            `).join('')}
                         </div>
                    </div>
                </div>
            `;
        }

        // --- CORE FUNCTIONS ---
        window.setView = (v) => { state.currentView = v; renderApp(); }
        window.setFilter = (id) => { state.selectedMemberFilter = id; renderApp(); }
        window.changeMonth = (d) => { state.calendarDate.setMonth(state.calendarDate.getMonth() + d); state.calendarDate = new Date(state.calendarDate); renderApp(); }
        window.selectDate = (d) => { state.calendarDate.setDate(d); state.calendarDate = new Date(state.calendarDate); renderApp(); }
        window.checkPin = () => { if (document.getElementById('admin-pin').value === '123456') { state.isAdminUnlocked = true; renderApp(); } else document.getElementById('pin-error').classList.remove('hidden'); }
        window.lockAdmin = () => { state.isAdminUnlocked = false; renderApp(); }
        window.setReportTarget = (id) => { state.reportTargetId = id; renderApp(); }

        // --- FIXED MODAL CLOSE FUNCTION ---
        // S·ª≠a l·ªói: Th√™m ki·ªÉm tra !e ƒë·ªÉ handle tr∆∞·ªùng h·ª£p g·ªçi kh√¥ng tham s·ªë
        window.closeModal = (e, force) => {
            if (force || !e || e.target === e.currentTarget) {
                modalContainer.innerHTML = '';
                modalContainer.classList.add('hidden');
            }
        }

        window.openModal = (type, dataId) => {
            let content = '';
            if (type === 'adjustPoints') {
                const m = state.members.find(mem => mem.id === dataId);
                content = `
                    <h3 class="font-bold text-lg mb-2 text-center">ƒêi·ªÅu ch·ªânh ƒëi·ªÉm cho ${m.name}</h3>
                    <div class="text-center text-3xl mb-4">${getAvatarEmoji(m)}</div>
                    
                    <label class="text-xs font-bold text-gray-500">S·ªë ƒëi·ªÉm thay ƒë·ªïi (V√≠ d·ª•: 5 ho·∫∑c -5)</label>
                    <input id="adj-amount" type="number" placeholder="+ / -" class="w-full mb-3 p-3 border rounded-xl font-bold text-xl text-center">
                    
                    <label class="text-xs font-bold text-gray-500">L√Ω do (B·∫Øt bu·ªôc)</label>
                    <input id="adj-reason" type="text" placeholder="L√Ω do..." class="w-full mb-4 p-3 border rounded-xl">
                    
                    <div class="flex gap-2">
                        <button onclick="submitAdjustPoints('${dataId}')" class="flex-1 bg-yellow-500 text-white font-bold py-3 rounded-xl hover:bg-yellow-600">L∆∞u & Th√¥ng b√°o</button>
                    </div>
                `;
            }
            else if (type === 'assignOptions') {
                // ƒê√£ c·∫≠p nh·∫≠t n√∫t Th·ªß c√¥ng g·ªçi closeModal(null, true) cho ch·∫Øc ch·∫Øn
                content = `<h3 class="font-bold text-lg mb-4 text-center">Ph√¢n c√¥ng</h3><div class="space-y-3"><button onclick="closeModal(null, true)" class="w-full p-4 bg-white border border-gray-200 rounded-2xl flex items-center gap-4 hover:shadow-md"><div class="w-10 h-10 bg-blue-100 text-blue-600 rounded-full flex items-center justify-center"><i class="fas fa-hand-pointer"></i></div><div><div class="font-bold text-gray-800">Th·ªß c√¥ng</div><div class="text-xs text-gray-500">G√°n t·ª´ng vi·ªác b√™n d∆∞·ªõi</div></div></button><button onclick="smartDistribute()" class="w-full p-4 bg-indigo-50 border border-indigo-200 rounded-2xl flex items-center gap-4"><div class="w-10 h-10 bg-indigo-600 text-white rounded-full flex items-center justify-center"><i class="fas fa-brain"></i></div><div><div class="font-bold text-indigo-800">T·ª± ƒë·ªông</div><div class="text-xs text-indigo-600">Chia ƒë·ªÅu vi·ªác ch∆∞a l√†m</div></div></button></div>`;
            } else if (type === 'manualAssign') {
                const task = state.tasks.find(t => t.id === dataId);
                content = `<h3 class="font-bold text-lg mb-2">Giao vi·ªác: ${task.title}</h3><div class="grid grid-cols-3 gap-2">${state.members.map(m => `<button onclick="submitManualAssign('${dataId}', '${m.id}')" class="flex flex-col items-center p-2 rounded-xl border border-gray-200 hover:bg-blue-50"><div class="text-2xl mb-1">${getAvatarEmoji(m)}</div><div class="text-xs font-bold text-gray-700 truncate w-full text-center">${m.name}</div></button>`).join('')}<button onclick="submitManualAssign('${dataId}', null)" class="flex flex-col items-center p-2 rounded-xl border border-gray-200 bg-gray-50 text-gray-400"><div class="text-2xl mb-1"><i class="fas fa-times-circle"></i></div><div class="text-xs font-bold">Hu·ª∑ Giao</div></button></div>`;
            } else if (type === 'editMember') {
                const m = state.members.find(mem => mem.id === dataId);
                content = `<h3 class="font-bold text-lg mb-4 text-center">S·ª≠a Th√†nh Vi√™n</h3><div class="flex justify-center mb-4"><div id="edit-preview" class="w-20 h-20 rounded-full bg-gray-100 flex items-center justify-center text-5xl border-2 border-blue-500">${getAvatarEmoji(m)}</div></div><input id="edit-name" value="${m.name}" class="w-full mb-3 p-3 border rounded-xl font-bold"><div class="flex gap-2 mb-4"><input id="edit-emoji" value="${getAvatarEmoji(m)}" class="w-16 text-center text-2xl p-2 border rounded-xl" oninput="document.getElementById('edit-preview').innerText=this.value"><button onclick="randomEmojiInput('edit-emoji', 'edit-preview')" class="flex-1 bg-gray-100 rounded-xl text-gray-600 text-xs font-bold">üé≤ Random</button></div><button onclick="submitEditMember('${dataId}')" class="w-full bg-blue-600 text-white font-bold py-3 rounded-xl">L∆∞u</button>`;
            } else if (type === 'addMember') {
                content = `<h3 class="font-bold text-lg mb-3">Th√™m Th√†nh Vi√™n</h3><input id="new-mem-name" placeholder="T√™n" class="w-full mb-3 p-3 border rounded-xl"><button onclick="submitAddMember()" class="w-full bg-green-600 text-white font-bold py-3 rounded-xl">Th√™m</button>`;
            } else if (type === 'addTask') {
                content = `<h3 class="font-bold text-lg mb-3">Th√™m Vi·ªác</h3><input id="new-task-title" placeholder="T√™n vi·ªác" class="w-full mb-3 p-3 border rounded-xl"><div class="flex gap-2 mb-3"><input id="new-task-points" type="number" placeholder="ƒêi·ªÉm" class="w-1/2 p-3 border rounded-xl"><select id="new-task-freq" class="w-1/2 p-3 border rounded-xl bg-white"><option value="daily">H√†ng ng√†y</option><option value="weekly">H√†ng tu·∫ßn</option></select></div><button onclick="submitAddTask()" class="w-full bg-blue-600 text-white font-bold py-3 rounded-xl">Th√™m</button>`;
            } else if (type === 'postAnnouncement') {
                content = `<h3 class="font-bold text-lg mb-3">Th√¥ng B√°o</h3><textarea id="ann-content" rows="3" placeholder="N·ªôi dung..." class="w-full mb-3 p-3 border rounded-xl"></textarea><button onclick="submitAnnouncement()" class="w-full bg-orange-500 text-white font-bold py-3 rounded-xl">G·ª≠i</button>`;
            } else if (type === 'addGuide') {
                content = `<h3 class="font-bold text-lg mb-3">Vi·∫øt H∆∞·ªõng D·∫´n</h3><input id="guide-title" placeholder="Ti√™u ƒë·ªÅ" class="w-full mb-3 p-3 border rounded-xl"><textarea id="guide-content" rows="5" placeholder="N·ªôi dung..." class="w-full mb-3 p-3 border rounded-xl"></textarea><button onclick="submitAddGuide()" class="w-full bg-blue-600 text-white font-bold py-3 rounded-xl">ƒêƒÉng</button>`;
            } else if (type === 'notifications') {
                content = `<h3 class="font-bold text-lg mb-3">Th√¥ng b√°o</h3><div class="space-y-2 max-h-60 overflow-y-auto">${state.announcements.map(a => `<div class="bg-gray-50 p-3 rounded-lg text-sm">${a.content}<div class="text-[10px] text-gray-400 mt-1">${formatDate(a.createdAt)}</div></div>`).join('')}</div>`;
                if (state.announcements.length > 0) { localStorage.setItem('lastReadAnnouncementId', state.announcements[0].id); renderApp(); }
            }

            modalContainer.innerHTML = `<div class="fixed inset-0 bg-black/50 z-50 flex items-center justify-center p-4 backdrop-blur-sm" onclick="closeModal(event)"><div class="bg-white w-full max-w-sm rounded-3xl p-6 shadow-2xl animate-scale-in" onclick="event.stopPropagation()">${content}<button onclick="closeModal(null, true)" class="mt-4 w-full text-gray-400 text-sm font-medium hover:text-gray-600">ƒê√≥ng</button></div></div>`;
            modalContainer.classList.remove('hidden');
        }

        window.randomEmojiInput = (inputId, viewId) => {
            const arr = ['üê∂', 'üê±', 'üê≠', 'üêπ', 'üê∞', 'ü¶ä', 'üêª', 'üêº', 'üê®', 'üêØ', 'ü¶Å', 'üêÆ', 'üê∑', 'üê∏', 'üêµ', 'ü¶Ñ', 'üêù', 'ü¶ñ', 'üêô', 'ü¶à'];
            const r = arr[Math.floor(Math.random() * arr.length)];
            document.getElementById(inputId).value = r;
            document.getElementById(viewId).innerText = r;
        }

        // 1. Admin Resolve Report
        window.resolveReport = async (reportId, targetId, reason) => {
            const pointsStr = prompt("B·∫°n mu·ªën tr·ª´ bao nhi√™u ƒëi·ªÉm ph·∫°t? (Nh·∫≠p s·ªë d∆∞∆°ng)", "5");
            if (pointsStr === null) return;
            const points = parseInt(pointsStr);
            if (isNaN(points)) return alert("Vui l√≤ng nh·∫≠p s·ªë!");

            const member = state.members.find(m => m.id === targetId);
            if (!member) return alert("Th√†nh vi√™n kh√¥ng t·ªìn t·∫°i");

            const newPoints = Math.max(0, (member.totalPoints || 0) - points);

            try {
                await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'members', targetId), { totalPoints: newPoints });
                await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'announcements'), {
                    content: `‚ö†Ô∏è PH·∫†T: ${member.name} b·ªã tr·ª´ ${points} ƒëi·ªÉm. L√Ω do: "${reason}" ƒë√£ ƒë∆∞·ª£c x√°c th·ª±c.`,
                    createdAt: serverTimestamp()
                });
                await deleteDoc(doc(db, 'artifacts', appId, 'public', 'data', 'reports', reportId));
                alert("ƒê√£ x·ª≠ l√Ω xong!");
            } catch (e) {
                alert("L·ªói: " + e.message);
            }
        }

        // 2. Admin Manual Adjust Points
        window.submitAdjustPoints = async (memberId) => {
            const amount = parseInt(document.getElementById('adj-amount').value);
            const reason = document.getElementById('adj-reason').value;

            if (isNaN(amount) || !reason) return alert("Vui l√≤ng nh·∫≠p s·ªë ƒëi·ªÉm v√† l√Ω do!");

            const member = state.members.find(m => m.id === memberId);
            const newPoints = Math.max(0, (member.totalPoints || 0) + amount);

            try {
                await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'members', memberId), { totalPoints: newPoints });
                const actionText = amount > 0 ? "th∆∞·ªüng" : "tr·ª´";
                const icon = amount > 0 ? "üéÅ" : "üìâ";
                await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'announcements'), {
                    content: `${icon} ${member.name} ƒë∆∞·ª£c ${actionText} ${Math.abs(amount)} ƒëi·ªÉm. L√Ω do: ${reason}.`,
                    createdAt: serverTimestamp()
                });
                closeModal(null, true);
            } catch (e) {
                alert("L·ªói: " + e.message);
            }
        }

        // --- SUBMIT ACTIONS ---
        window.submitReport = async () => {
            if (!state.reportTargetId) return alert("Ch∆∞a ch·ªçn ng∆∞·ªùi vi ph·∫°m!");
            const date = document.getElementById('report-date').value;
            const reason = document.getElementById('report-reason').value;
            if (!reason || !date) return alert("Thi·∫øu th√¥ng tin");
            await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'reports'), { targetId: state.reportTargetId, date, reason, createdAt: serverTimestamp() });
            alert("ƒê√£ b√°o c√°o!");
            state.reportTargetId = null;
            document.getElementById('report-reason').value = '';
            renderApp();
        }

        window.submitEditMember = async (id) => {
            const name = document.getElementById('edit-name').value;
            const emoji = document.getElementById('edit-emoji').value;
            if (!name) return;
            await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'members', id), { name, emoji });
            closeModal(null, true);
        }
        window.submitManualAssign = async (taskId, memberId) => {
            await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'tasks', taskId), { assignedTo: memberId });
            closeModal(null, true);
        }
        window.smartDistribute = async () => {
            if (state.members.length === 0) return alert("C·∫ßn c√≥ th√†nh vi√™n!");
            const pendingTasks = state.tasks.filter(t => t.status === 'pending');
            if (pendingTasks.length === 0) return alert("Kh√¥ng c√≤n vi·ªác n√†o ch∆∞a l√†m.");

            let simulatedMembers = state.members.map(m => ({ id: m.id, totalPoints: m.totalPoints || 0 }));
            pendingTasks.sort((a, b) => b.points - a.points);
            const updates = [];
            pendingTasks.forEach(task => {
                simulatedMembers.sort((a, b) => a.totalPoints - b.totalPoints);
                const candidate = simulatedMembers[0];
                updates.push(updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'tasks', task.id), { assignedTo: candidate.id }));
                candidate.totalPoints += task.points;
            });
            if (confirm(`Ph√¢n ph·ªëi l·∫°i ${pendingTasks.length} vi·ªác?`)) {
                await Promise.all(updates);
                closeModal(null, true);
                alert("ƒê√£ chia xong!");
            }
        }
        window.submitAddMember = async () => {
            const name = document.getElementById('new-mem-name').value;
            if (!name) return;
            const emoji = ['üê∂', 'üê±', 'üê≠', 'üêπ', 'üê∞'][Math.floor(Math.random() * 5)];
            await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'members'), { name, emoji, totalPoints: 0, createdAt: serverTimestamp() });
            closeModal(null, true);
        }
        window.submitAddTask = async () => {
            const title = document.getElementById('new-task-title').value;
            const points = parseInt(document.getElementById('new-task-points').value) || 1;
            const frequency = document.getElementById('new-task-freq').value;
            if (!title) return;
            await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'tasks'), { title, points, frequency, status: 'pending', assignedTo: null, createdAt: serverTimestamp() });
            closeModal(null, true);
        }
        window.submitAnnouncement = async () => {
            const content = document.getElementById('ann-content').value;
            if (!content) return;
            await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'announcements'), { content, createdAt: serverTimestamp() });
            closeModal(null, true);
        }
        window.submitAddGuide = async () => {
            const title = document.getElementById('guide-title').value;
            const content = document.getElementById('guide-content').value;
            if (!title) return;
            await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'guides'), { title, content, createdAt: serverTimestamp() });
            closeModal(null, true);
        }
        window.toggleTaskStatus = async (id, status, assign, pts) => {
            if (!assign || assign === 'null') return alert("Ch∆∞a ph√¢n c√¥ng!");
            const newS = status === 'pending' ? 'done' : 'pending';
            await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'tasks', id), { status: newS });
            const m = state.members.find(x => x.id === assign);
            if (m) {
                let p = m.totalPoints || 0;
                p = newS === 'done' ? p + pts : Math.max(0, p - pts);
                await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'members', assign), { totalPoints: p });
            }
        }
        window.deleteTask = async (id) => { if (confirm("Xo√°?")) deleteDoc(doc(db, 'artifacts', appId, 'public', 'data', 'tasks', id)); }
        window.deleteGuide = async (id) => { if (confirm("Xo√°?")) deleteDoc(doc(db, 'artifacts', appId, 'public', 'data', 'guides', id)); }
        window.deleteReport = async (id) => { if (confirm("Xo√°?")) deleteDoc(doc(db, 'artifacts', appId, 'public', 'data', 'reports', id)); }
        window.deleteMember = async (id) => { if (confirm("Xo√°?")) deleteDoc(doc(db, 'artifacts', appId, 'public', 'data', 'members', id)); }
        window.openNotifications = () => openModal('notifications');

        renderApp();
    </script>
    <style>
        body {
            font-family: 'Nunito', sans-serif;
            background-color: #f9fafb;
        }

        .scrollbar-hide::-webkit-scrollbar {
            display: none;
        }

        .animate-fade-in-up {
            animation: f 0.4s ease-out forwards;
        }

        .animate-scale-in {
            animation: s 0.2s ease-out forwards;
        }

        @keyframes f {
            from {
                opacity: 0;
                transform: translateY(10px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        @keyframes s {
            from {
                opacity: 0;
                transform: scale(0.95);
            }

            to {
                opacity: 1;
                transform: scale(1);
            }
        }
    </style>
</head>

<body>
    <div id="app-content"></div>
    <div id="modal-container" class="hidden"></div>
</body>

</html>