<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Family Chore App (Cyclic)</title>

    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Nunito:wght@400;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>

    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>

    <style>
        body { font-family: 'Nunito', sans-serif; background-color: #f3f4f6; touch-action: manipulation; }
        .scrollbar-hide::-webkit-scrollbar { display: none; }
        .animate-fade-in-up { animation: fadeInUp 0.4s ease-out forwards; }
        .animate-scale-in { animation: scaleIn 0.2s ease-out forwards; }
        @keyframes fadeInUp { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        @keyframes scaleIn { from { opacity: 0; transform: scale(0.95); } to { opacity: 1; transform: scale(1); } }
        
        input[type=range] { -webkit-appearance: none; width: 100%; background: transparent; }
        input[type=range]::-webkit-slider-thumb { -webkit-appearance: none; height: 24px; width: 24px; border-radius: 50%; background: #3b82f6; cursor: pointer; margin-top: -10px; box-shadow: 0 2px 6px rgba(0,0,0,0.2); }
        input[type=range]::-webkit-slider-runnable-track { width: 100%; height: 4px; cursor: pointer; background: #e5e7eb; border-radius: 2px; }

        .toast-enter { transform: translateX(100%); opacity: 0; }
        .toast-enter-active { transform: translateX(0); opacity: 1; transition: all 0.3s cubic-bezier(0.68, -0.55, 0.265, 1.55); }
        .toast-exit-active { transform: translateX(100%); opacity: 0; transition: all 0.3s ease-in; }
    </style>
</head>

<body>
    <div id="app-content">ƒêang t·∫£i...</div>
    <div id="modal-container" class="hidden"></div>
    <div id="toast-box" class="fixed top-4 right-4 z-[70] flex flex-col items-end pointer-events-none"></div>

    <script>
        // --- CONFIG ---
        const firebaseConfig = {
            apiKey: "AIzaSyBevgQ-MEoSg1tnLyvOFY8ndcKN7HvaahU",
            authDomain: "fami-wallet.firebaseapp.com",
            projectId: "fami-wallet",
            storageBucket: "fami-wallet.firebasestorage.app",
            messagingSenderId: "851225524722",
            appId: "1:851225524722:web:023d64b5b0d7205045d36b",
            measurementId: "G-4DNH0PN1CS"
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        const auth = firebase.auth();
        const appId = 'family-app';

        // --- STATE ---
        let state = {
            user: null, members: [], tasks: [], activities: [], guides: [], reports: [],
            currentView: 'home', isAdminUnlocked: false, selectedMemberFilter: 'all',
            calendarDate: new Date(), 
            lastVisit: localStorage.getItem('lastVisit') ? new Date(localStorage.getItem('lastVisit')) : new Date(),
            newTask: { emoji: 'üßπ', title: '', assignee: null, points: 10, type: 'daily' },
            editTaskId: null
        };

        // --- INIT ---
        auth.signInAnonymously().catch(console.error);
        auth.onAuthStateChanged(u => { if(u){ state.user = u; initData(); }});

        function initData() {
            const ref = db.collection('artifacts').doc(appId).collection('public').doc('data');
            ref.collection('members').onSnapshot(s => { state.members = s.docs.map(d=>({id:d.id, ...d.data()})); renderApp(); });
            ref.collection('tasks').onSnapshot(s => { state.tasks = s.docs.map(d=>({id:d.id, ...d.data()})); renderApp(); });
            ref.collection('activities').orderBy('createdAt','desc').limit(20).onSnapshot(s => { 
                const newActivities = s.docs.map(d=>({id:d.id, ...d.data()}));
                if(state.activities.length > 0 && newActivities.length > 0 && newActivities[0].id !== state.activities[0].id) {
                    showToast(newActivities[0].content, 'info');
                }
                state.activities = newActivities;
                renderApp(); 
            });
            ref.collection('reports').orderBy('createdAt','desc').onSnapshot(s => { state.reports = s.docs.map(d=>({id:d.id, ...d.data()})); renderApp(); });
            setTimeout(() => { localStorage.setItem('lastVisit', new Date().toISOString()); }, 2000);
        }

        // --- HELPERS ---
        const appContainer = document.getElementById('app-content');
        const modalContainer = document.getElementById('modal-container');
        window.getAvatarEmoji = (m) => m?.emoji || 'üë§';
        window.formatDateSimple = (d) => {
            const today = new Date();
            if (d.toDateString() === today.toDateString()) return "H√¥m nay";
            const tom = new Date(today); tom.setDate(today.getDate()+1);
            if (d.toDateString() === tom.toDateString()) return "Ng√†y mai";
            return d.toLocaleDateString('vi-VN', {day:'numeric', month:'numeric'});
        }
        window.formatTime = (ts) => { if(!ts) return ''; const d = ts.toDate ? ts.toDate() : new Date(ts); return d.getHours() + ':' + (d.getMinutes()<10?'0':'') + d.getMinutes(); }
        window.formatDate = (ts) => ts ? new Date(ts.toDate?ts.toDate():ts).toLocaleDateString('vi-VN') : '';

        window.showToast = (msg, type='success') => {
            const box = document.getElementById('toast-box');
            const t = document.createElement('div');
            const colors = type==='success'?'bg-green-600':(type==='error'?'bg-red-500':'bg-blue-600');
            t.className = `${colors} text-white px-4 py-3 rounded-xl shadow-lg flex items-center gap-3 mb-2 toast-enter toast-enter-active pointer-events-auto`;
            t.innerHTML = `<i class="fas ${type==='success'?'fa-check-circle':(type==='error'?'fa-times-circle':'fa-bell')}"></i><span class="font-bold text-sm">${msg}</span>`;
            box.appendChild(t);
            requestAnimationFrame(()=>t.classList.remove('toast-enter-active'));
            setTimeout(()=>{ t.classList.add('toast-exit-active'); setTimeout(()=>t.remove(),300); }, 4000);
        }

        // --- ALGORITHM: CYCLIC ROTATION (BƒÇNG CHUY·ªÄN) ---
        window.rotateTasks = async () => {
            // Ch·ªâ xoay tua c√°c vi·ªác H·∫±ng ng√†y (daily)
            const dailyTasks = state.tasks.filter(t => t.frequency === 'daily');
            
            if(dailyTasks.length === 0) return showToast("Kh√¥ng c√≥ vi·ªác h·∫±ng ng√†y ƒë·ªÉ xoay!", "error");
            if(state.members.length === 0) return;

            // 1. S·∫Øp x·∫øp danh s√°ch c·ªë ƒë·ªãnh (A-Z) ƒë·ªÉ ƒë·∫£m b·∫£o th·ª© t·ª± kh√¥ng ƒë·ªïi khi reload
            const sortedMembers = [...state.members].sort((a,b) => a.name.localeCompare(b.name));
            const sortedTasks = [...dailyTasks].sort((a,b) => a.title.localeCompare(b.title));
            
            // 2. T√≠nh s·ªë ng√†y t√≠nh t·ª´ m·ªëc (Epoch) ƒë·ªÉ l√†m ch·ªâ s·ªë xoay
            const now = new Date();
            const start = new Date(now.getFullYear(), 0, 0); // Ng√†y ƒë·∫ßu nƒÉm
            const diff = now - start;
            const oneDay = 1000 * 60 * 60 * 24;
            const dayIndex = Math.floor(diff / oneDay); // H√¥m nay l√† ng√†y th·ª© bao nhi√™u trong nƒÉm

            const batch = db.batch();
            let changedCount = 0;

            // 3. G√°n vi·ªác theo c√¥ng th·ª©c: (Index vi·ªác - Index ng√†y) % S·ªë ng∆∞·ªùi
            // ƒêi·ªÅu n√†y t·∫°o ra hi·ªáu ·ª©ng: Ng∆∞·ªùi ƒë·ª©ng y√™n, vi·ªác tr√¥i ƒëi.
            // V√≠ d·ª•: Ng√†y 1 A l√†m vi·ªác 1. Ng√†y 2 vi·ªác 1 tr√¥i sang ng∆∞·ªùi B (ho·∫∑c ng∆∞·ª£c l·∫°i tu·ª≥ ph√©p to√°n).
            // ·ªû ƒë√¢y ta mu·ªën: Ng∆∞·ªùi A h√¥m nay l√†m Vi·ªác 1, mai l√†m Vi·ªác 2.
            // T·ª©c l√†: Vi·ªác[i] g√°n cho Ng∆∞·ªùi[(i - dayIndex) % N]
            
            sortedTasks.forEach((task, tIndex) => {
                // To√°n t·ª≠ % trong JS c√≥ th·ªÉ ra s·ªë √¢m, c·∫ßn x·ª≠ l√Ω: ((a % n) + n) % n
                let mIndex = (tIndex - dayIndex) % sortedMembers.length;
                mIndex = (mIndex + sortedMembers.length) % sortedMembers.length;
                
                const assignedMember = sortedMembers[mIndex];
                
                // Ch·ªâ update n·∫øu c√≥ thay ƒë·ªïi
                if (task.assignedTo !== assignedMember.id) {
                    const ref = db.collection('artifacts').doc(appId).collection('public').doc('data').collection('tasks').doc(task.id);
                    batch.update(ref, { assignedTo: assignedMember.id, status: 'pending' }); // Reset v·ªÅ pending lu√¥n
                    changedCount++;
                }
            });

            if(changedCount > 0) {
                if(confirm(`C·∫≠p nh·∫≠t xoay tua cho ${changedCount} c√¥ng vi·ªác h√¥m nay?`)) {
                    await batch.commit();
                    showToast("ƒê√£ xoay tua theo l·ªãch!", "success");
                    confetti();
                    logActivity("üîÑ H·ªá th·ªëng ƒë√£ xoay tua c√¥ng vi·ªác h·∫±ng ng√†y");
                }
            } else {
                showToast("L·ªãch h√¥m nay ƒë√£ ƒë√∫ng th·ª© t·ª±!", "info");
            }
        }

        // --- RENDER MAIN ---
        window.renderApp = () => {
            const unreadCount = state.activities.filter(a => (a.createdAt.toDate?a.createdAt.toDate():new Date(a.createdAt)) > state.lastVisit).length;
            appContainer.innerHTML = `
                <div class="max-w-md mx-auto bg-gray-50 min-h-screen flex flex-col shadow-2xl relative bg-white">
                    <header class="bg-gradient-to-r from-indigo-600 to-purple-700 text-white p-5 rounded-b-[2rem] shadow-lg z-10 sticky top-0">
                        <div class="flex justify-between items-center mb-4">
                            <div><h1 class="text-2xl font-black flex items-center gap-2"><i class="fas fa-home"></i> Family App</h1><p class="text-indigo-200 text-xs font-medium">Phi√™n b·∫£n BƒÉng Chuy·ªÅn</p></div>
                            <div class="flex gap-3">
                                ${state.isAdminUnlocked ? '<span class="px-2 py-1 bg-yellow-400 text-yellow-900 text-xs font-bold rounded-full h-fit self-center">Admin</span>' : ''}
                                <div onclick="setView('notifications')" class="h-10 w-10 bg-white/10 rounded-full flex items-center justify-center relative cursor-pointer hover:bg-white/20"><i class="fas fa-bell"></i>${unreadCount>0 ? `<span class="absolute top-2 right-2 w-2.5 h-2.5 bg-red-500 border-2 border-indigo-600 rounded-full animate-pulse"></span>` : ''}</div>
                            </div>
                        </div>
                        ${['home','shop'].includes(state.currentView) ? renderFilters() : ''}
                    </header>
                    <main class="flex-1 overflow-y-auto p-4 pb-24 scroll-smooth bg-gray-50">${renderView()}</main>
                    <nav class="fixed bottom-0 w-full max-w-md bg-white/95 backdrop-blur-md border-t border-gray-200 px-4 py-3 z-50 left-1/2 transform -translate-x-1/2 rounded-t-2xl">
                        <div class="flex justify-between items-end">
                            ${navBtn('home','fa-list-check','Vi·ªác nh√†')}
                            ${navBtn('calendar','fa-calendar-days','L·ªãch')}
                            ${state.isAdminUnlocked ? `<button onclick="openModal('createTask')" class="mb-4 -mt-8 bg-blue-600 text-white w-14 h-14 rounded-full shadow-xl flex items-center justify-center transform hover:scale-110 transition-transform border-4 border-gray-50"><i class="fas fa-plus text-xl"></i></button>` : navBtn('shop','fa-gift','ƒê·ªïi Qu√†')}
                            ${navBtn('report','fa-flag','B√°o c√°o')}
                            ${navBtn('menu','fa-bars','Menu')}
                        </div>
                    </nav>
                </div>
            `;
        }

        const navBtn = (v,i,l) => {
            const active = state.currentView === v;
            return `<button onclick="setView('${v}')" class="flex flex-col items-center gap-1 w-1/5 group"><div class="text-xl ${active?'text-blue-600 -translate-y-1':'text-gray-400'} transition-all"><i class="fas ${i}"></i></div><span class="text-[10px] font-bold ${active?'text-blue-600':'text-gray-400'}">${l}</span></button>`;
        }

        const renderFilters = () => {
            if(!state.members.length) return '';
            let h = `<div class="flex gap-3 overflow-x-auto pb-2 scrollbar-hide items-end h-20"><button onclick="setFilter('all')" class="flex flex-col items-center min-w-[56px] flex-shrink-0"><div class="w-10 h-10 rounded-full border-2 ${state.selectedMemberFilter==='all'?'border-white bg-white/30':'border-transparent bg-white/10'} flex items-center justify-center mb-1"><i class="fas fa-users text-sm"></i></div><span class="text-[10px] font-medium text-white">T·∫•t c·∫£</span></button>`;
            state.members.forEach(m => {
                const a = state.selectedMemberFilter===m.id;
                h += `<button onclick="setFilter('${m.id}')" class="flex flex-col items-center min-w-[56px] flex-shrink-0"><div class="w-10 h-10 rounded-full border-2 ${a?'border-white shadow-lg scale-110':'border-transparent opacity-80'} overflow-hidden mb-1 bg-white flex items-center justify-center text-xl">${getAvatarEmoji(m)}</div><span class="text-[10px] font-medium ${a?'font-bold':''} text-white truncate max-w-[60px]">${m.name}</span></button>`;
            });
            return h + '</div>';
        }

        const renderView = () => {
            switch(state.currentView){
                case 'home': return renderHome();
                case 'notifications': return renderNotificationsPage();
                case 'calendar': return renderCalendar();
                case 'shop': return renderShop();
                case 'report': return renderReport();
                case 'menu': return renderMenu();
                default: return renderHome();
            }
        }

        // --- VIEW: HOME ---
        function renderHome() {
            let tasks = state.tasks;
            if(state.selectedMemberFilter!=='all') tasks = tasks.filter(t => t.assignedTo===state.selectedMemberFilter);
            const selDateStr = state.calendarDate.toDateString();
            tasks = tasks.filter(t => t.frequency==='daily' || (t.createdAt && new Date(t.createdAt.seconds*1000).toDateString()===selDateStr));
            tasks.sort((a,b) => (a.status==='done') - (b.status==='done'));

            const dateNav = `<div class="flex items-center justify-between bg-white p-2 rounded-xl border border-gray-100 shadow-sm mb-4">
                <button onclick="changeDate(-1)" class="w-8 h-8 flex items-center justify-center rounded-lg hover:bg-gray-100 text-gray-500"><i class="fas fa-chevron-left"></i></button>
                <div class="flex flex-col items-center cursor-pointer" onclick="goToToday()"><span class="text-sm font-black text-gray-800 uppercase">${formatDateSimple(state.calendarDate)}</span><span class="text-[10px] text-gray-400 font-bold">Danh s√°ch vi·ªác</span></div>
                <div class="flex gap-2">
                    ${state.isAdminUnlocked ? `<button onclick="rotateTasks()" class="w-8 h-8 flex items-center justify-center rounded-lg bg-indigo-50 text-indigo-600 animate-pulse border border-indigo-100" title="B·∫•m ƒë·ªÉ xoay tua vi·ªác"><i class="fas fa-sync-alt"></i></button>` : ''}
                    <button onclick="changeDate(1)" class="w-8 h-8 flex items-center justify-center rounded-lg hover:bg-gray-100 text-gray-500"><i class="fas fa-chevron-right"></i></button>
                </div>
            </div>`;

            if(!tasks.length) return `<div class="animate-fade-in-up">${dateNav}<div class="flex flex-col items-center justify-center h-48 text-center p-6"><i class="fas fa-mug-hot text-6xl text-gray-200 mb-4"></i><h3 class="text-xl font-bold text-gray-700">R·∫£nh r·ªói!</h3>${state.isAdminUnlocked?'<button onclick="openModal(\'createTask\')" class="mt-4 bg-blue-100 text-blue-600 px-4 py-2 rounded-full text-sm font-bold">+ Giao vi·ªác nhanh</button>':''}</div></div>`;

            return `<div class="space-y-3 animate-fade-in-up">${dateNav}${tasks.map(t=>{
                const m = state.members.find(x=>x.id===t.assignedTo);
                const done = t.status==='done';
                const isDaily = t.frequency === 'daily';
                return `<div class="bg-white p-4 rounded-2xl shadow-sm border-l-4 ${done?'border-green-400 opacity-60 grayscale':'border-blue-500'} flex items-center gap-4 transition-all relative overflow-hidden group">
                    <div class="absolute top-2 right-2 text-[10px] font-bold px-2 py-0.5 rounded-full ${isDaily ? 'bg-purple-100 text-purple-600' : 'bg-gray-100 text-gray-500'}">
                        ${isDaily ? '<i class="fas fa-sync-alt mr-1"></i>L·∫∑p l·∫°i' : '<i class="fas fa-bolt mr-1"></i>1 l·∫ßn'}
                    </div>
                    <div onclick="toggleTaskStatus('${t.id}','${t.status}','${t.assignedTo}',${t.points}, '${t.title}')" class="w-12 h-12 rounded-full flex-shrink-0 flex items-center justify-center cursor-pointer active:scale-90 ${done?'bg-green-100 text-green-600':'bg-gray-100 text-gray-400'}"><i class="fas ${done?'fa-check':'fa-circle'} text-xl"></i></div>
                    <div class="flex-1 min-w-0 pt-2">
                        <div class="flex justify-between items-end"><h4 class="font-bold text-gray-800 text-lg truncate ${done?'line-through':''}">${t.title}</h4></div>
                        <div class="flex items-center gap-2 mt-1">
                            <span class="text-xs font-bold text-blue-600 bg-blue-50 px-2 py-0.5 rounded">+${t.points}ƒë</span>
                            ${m?`<div class="flex items-center gap-1 bg-gray-100 px-2 py-0.5 rounded-full"><span class="text-xs">${getAvatarEmoji(m)} ${m.name}</span></div>`:`<span class="text-xs text-red-400 italic font-bold">‚ö†Ô∏è Ch∆∞a g√°n</span>`}
                        </div>
                    </div>
                    ${state.isAdminUnlocked ? `<button onclick="openEditTask('${t.id}')" class="absolute bottom-2 right-2 text-gray-300 hover:text-blue-500 p-2"><i class="fas fa-pencil-alt"></i></button>` : ''}
                </div>`;
            }).join('')}</div>`;
        }

        // --- EDIT TASK MODAL ---
        window.openEditTask = (taskId) => {
            const task = state.tasks.find(t => t.id === taskId);
            if(!task) return;
            state.editTaskId = taskId;
            state.newTask = { ...task, type: task.frequency };

            const html = `
                <div class="flex justify-between items-center mb-4"><h3 class="font-black text-xl text-gray-800">S·ª≠a C√¥ng Vi·ªác</h3><button onclick="closeModal(null,true)" class="text-gray-400 hover:text-gray-600"><i class="fas fa-times text-xl"></i></button></div>
                <div class="bg-gray-50 p-4 rounded-2xl mb-4 border border-gray-100">
                    <div class="mb-3"><label class="text-xs font-bold text-gray-500 block mb-1">T√™n vi·ªác</label><input id="edit-title" type="text" value="${task.title}" class="w-full bg-white px-4 py-3 rounded-xl border border-gray-200 font-bold"></div>
                    <div class="flex justify-between items-center mb-2"><span class="text-xs font-bold text-gray-500">Th∆∞·ªüng: <span class="text-blue-600 text-lg" id="edit-points-val">${task.points}</span> ƒëi·ªÉm</span><input type="range" min="5" max="50" step="5" value="${task.points}" oninput="document.getElementById('edit-points-val').innerText=this.value; state.newTask.points=this.value;" class="w-32"></div>
                </div>
                <div class="grid grid-cols-2 gap-3 mb-4">
                     <button onclick="updateEditState('type', 'daily')" class="p-3 rounded-xl border-2 text-sm font-bold flex items-center justify-center gap-2 ${state.newTask.type==='daily'?'border-purple-500 bg-purple-50 text-purple-700':'border-gray-100 bg-white text-gray-400'}"><i class="fas fa-sync-alt"></i> H·∫±ng ng√†y</button>
                     <button onclick="updateEditState('type', 'once')" class="p-3 rounded-xl border-2 text-sm font-bold flex items-center justify-center gap-2 ${state.newTask.type==='once'?'border-blue-500 bg-blue-50 text-blue-700':'border-gray-100 bg-white text-gray-400'}"><i class="fas fa-bolt"></i> M·ªôt l·∫ßn</button>
                </div>
                <div class="mb-6"><p class="text-xs font-bold text-gray-400 uppercase mb-2">Ng∆∞·ªùi l√†m:</p><div class="flex gap-2 overflow-x-auto pb-2 scrollbar-hide">${state.members.map(m => `<button onclick="updateEditState('assignee', '${m.id}')" class="flex flex-col items-center min-w-[50px] group"><div class="w-12 h-12 rounded-full border-2 ${state.newTask.assignedTo===m.id?'border-green-500 ring-2 ring-green-200 scale-110':'border-gray-200'} bg-white flex items-center justify-center text-2xl transition-all shadow-sm">${getAvatarEmoji(m)}</div></button>`).join('')}</div></div>
                <div class="flex gap-3"><button onclick="deleteTask('${taskId}')" class="flex-1 bg-red-100 text-red-600 py-4 rounded-2xl font-bold"><i class="fas fa-trash"></i> Xo√°</button><button onclick="saveEditTask()" class="flex-[2] bg-gray-900 text-white py-4 rounded-2xl font-bold shadow-lg">L∆∞u thay ƒë·ªïi</button></div>
            `;
            modalContainer.innerHTML = `<div class="bg-white w-full max-w-sm rounded-[2rem] p-6 shadow-2xl animate-scale-in mx-4">${html}</div>`;
            modalContainer.className = "fixed inset-0 bg-black/60 z-50 flex items-center justify-center backdrop-blur-sm";
        }

        window.updateEditState = (k, v) => { 
            if(k==='type') state.newTask.type = v; 
            if(k==='assignee') state.newTask.assignedTo = v;
            const prevTitle = document.getElementById('edit-title').value;
            const prevPoints = state.newTask.points;
            openEditTask(state.editTaskId); // Re-render simple
            setTimeout(()=>{ document.getElementById('edit-title').value = prevTitle; state.newTask.points = prevPoints; document.getElementById('edit-points-val').innerText = prevPoints; }, 10);
        }

        window.saveEditTask = async () => {
            const title = document.getElementById('edit-title').value;
            const { points, type, assignedTo } = state.newTask;
            try {
                await db.collection('artifacts').doc(appId).collection('public').doc('data').collection('tasks').doc(state.editTaskId).update({ title, points: parseInt(points), frequency: type, assignedTo });
                closeModal(null,true); showToast("ƒê√£ c·∫≠p nh·∫≠t!");
            } catch(e){ showToast(e.message, 'error'); }
        }

        window.deleteTask = async (id) => { if(confirm("Xo√° c√¥ng vi·ªác n√†y?")) { await db.collection('artifacts').doc(appId).collection('public').doc('data').collection('tasks').doc(id).delete(); closeModal(null,true); showToast("ƒê√£ xo√°!"); } }

        // --- CREATE TASK WIZARD ---
        function renderCreateTaskModal() {
            const presets = [
                { t: 'R·ª≠a b√°t', e: 'üçΩÔ∏è', p: 15 }, { t: 'Qu√©t nh√†', e: 'üßπ', p: 10 }, { t: 'Lau nh√†', e: 'ü™£', p: 20 },
                { t: 'ƒê·ªï r√°c', e: 'üóëÔ∏è', p: 10 }, { t: 'N·∫•u c∆°m', e: 'üçö', p: 25 }, { t: 'Ph∆°i ƒë·ªì', e: 'üëï', p: 15 },
                { t: 'D·ªçn WC', e: 'üöΩ', p: 30 }, { t: 'T∆∞·ªõi c√¢y', e: 'ü™¥', p: 10 }
            ];
            const { points, type, assignee, title } = state.newTask;
            const assigneeObj = state.members.find(m => m.id === assignee);
            
            const html = `
                <div class="flex justify-between items-center mb-4"><h3 class="font-black text-xl text-gray-800">Giao Vi·ªác Nhanh</h3><button onclick="closeModal(null,true)" class="text-gray-400 hover:text-gray-600"><i class="fas fa-times text-xl"></i></button></div>
                <div class="mb-4 overflow-x-auto pb-2 scrollbar-hide"><div class="flex gap-2">${presets.map(p => `<button onclick="applyPreset('${p.t}', '${p.e}', ${p.p})" class="flex-shrink-0 bg-gray-50 border border-gray-200 rounded-xl px-3 py-2 flex items-center gap-2 hover:bg-blue-50 hover:border-blue-200 transition-colors"><span class="text-xl">${p.e}</span> <span class="text-sm font-bold text-gray-700">${p.t}</span></button>`).join('')}</div></div>
                <div class="bg-gray-50 p-4 rounded-2xl mb-4 border border-gray-100">
                    <div class="flex gap-3 mb-3"><input id="wizard-title" type="text" value="${title}" placeholder="T√™n c√¥ng vi·ªác..." class="flex-1 bg-white px-4 py-3 rounded-xl border border-gray-200 font-bold focus:outline-none focus:border-blue-500"></div>
                    <div class="flex justify-between items-center mb-2"><span class="text-xs font-bold text-gray-500">Th∆∞·ªüng: <span class="text-blue-600 text-lg">${points}</span> ƒëi·ªÉm</span><input type="range" min="5" max="50" step="5" value="${points}" oninput="updateWizardState('points', this.value)" class="w-32"></div>
                </div>
                <div class="grid grid-cols-2 gap-3 mb-4">
                    <button onclick="updateWizardState('type', 'daily')" class="p-3 rounded-xl border-2 text-sm font-bold flex items-center justify-center gap-2 ${type==='daily'?'border-purple-500 bg-purple-50 text-purple-700':'border-gray-100 bg-white text-gray-400'}"><i class="fas fa-sync-alt"></i> H·∫±ng ng√†y</button>
                    <button onclick="updateWizardState('type', 'once')" class="p-3 rounded-xl border-2 text-sm font-bold flex items-center justify-center gap-2 ${type==='once'?'border-blue-500 bg-blue-50 text-blue-700':'border-gray-100 bg-white text-gray-400'}"><i class="fas fa-bolt"></i> M·ªôt l·∫ßn</button>
                </div>
                <div class="mb-6"><p class="text-xs font-bold text-gray-400 uppercase mb-2">Ng∆∞·ªùi th·ª±c hi·ªán: ${assigneeObj ? `<span class="text-green-600">${assigneeObj.name}</span>` : '?'}</p><div class="flex gap-2 overflow-x-auto pb-2 scrollbar-hide">${state.members.map(m => `<button onclick="updateWizardState('assignee', '${m.id}')" class="flex flex-col items-center min-w-[50px] group"><div class="w-12 h-12 rounded-full border-2 ${assignee===m.id?'border-green-500 ring-2 ring-green-200 scale-110':'border-gray-200'} bg-white flex items-center justify-center text-2xl transition-all shadow-sm">${getAvatarEmoji(m)}</div></button>`).join('')}</div></div>
                <button onclick="submitWizardTask()" class="w-full bg-gray-900 text-white py-4 rounded-2xl font-bold text-lg shadow-lg hover:bg-gray-800 transform active:scale-95 transition-all">X√°c Nh·∫≠n T·∫°o</button>
            `;
            modalContainer.innerHTML = `<div class="bg-white w-full max-w-sm rounded-[2rem] p-6 shadow-2xl animate-scale-in mx-4">${html}</div>`;
            modalContainer.className = "fixed inset-0 bg-black/60 z-50 flex items-center justify-center backdrop-blur-sm";
        }

        window.applyPreset = (t, e, p) => { state.newTask.title = t; state.newTask.points = p; renderCreateTaskModal(); }
        window.updateWizardState = (key, val) => { const ti = document.getElementById('wizard-title'); if(ti) state.newTask.title = ti.value; state.newTask[key] = val; renderCreateTaskModal(); }
        window.submitWizardTask = async () => {
            const title = document.getElementById('wizard-title').value; if(!title) return showToast("Ch∆∞a nh·∫≠p t√™n!", "error");
            const { points, type, assignee } = state.newTask;
            try {
                await db.collection('artifacts').doc(appId).collection('public').doc('data').collection('tasks').add({
                    title, points: parseInt(points), frequency: type, status: 'pending', assignedTo: assignee, createdAt: new Date(), lastPerformerId: null
                });
                const m = state.members.find(x=>x.id===assignee);
                logActivity(assignee ? `ƒê√£ giao "${title}" cho ${m.name}` : `ƒê√£ t·∫°o vi·ªác "${title}"`);
                closeModal(null, true); showToast("ƒê√£ t·∫°o!", "success"); confetti({ particleCount: 50, spread: 60, origin: { y: 0.8 } });
            } catch(e) { showToast(e.message, "error"); }
        }

        // --- CORE ---
        window.logActivity = async (content) => { await db.collection('artifacts').doc(appId).collection('public').doc('data').collection('activities').add({ content, createdAt: new Date() }); }
        window.clearActivities = async () => { if(confirm('Xo√° l·ªãch s·ª≠?')) { const s = await db.collection('artifacts').doc(appId).collection('public').doc('data').collection('activities').get(); s.forEach(d => d.ref.delete()); showToast('ƒê√£ d·ªçn d·∫πp!'); } }
        window.toggleTaskStatus = async (id,s,u,p,title) => {
            if(!u) return showToast("Ch∆∞a ai nh·∫≠n!", "error");
            const ns = s==='pending'?'done':'pending';
            try {
                await db.collection('artifacts').doc(appId).collection('public').doc('data').collection('tasks').doc(id).update({status:ns});
                const m = state.members.find(x=>x.id===u);
                if(m) {
                    const newPoints = ns==='done'?(m.totalPoints||0)+p:Math.max(0,(m.totalPoints||0)-p);
                    await db.collection('artifacts').doc(appId).collection('public').doc('data').collection('members').doc(u).update({totalPoints: newPoints});
                }
                if(ns==='done') { confetti({particleCount:100,spread:70,origin:{y:0.6}}); showToast(`Tuy·ªát! +${p}ƒë`); logActivity(`${m.name} xong: ${title} (+${p}ƒë)`); }
            } catch(e){}
        }
        window.redeemReward = async (n,c) => { 
            if(state.selectedMemberFilter==='all') return showToast("Ch·ªçn ng∆∞·ªùi tr∆∞·ªõc!", "error");
            const m = state.members.find(x=>x.id===state.selectedMemberFilter);
            if((m.totalPoints||0)<c) return showToast("Kh√¥ng ƒë·ªß ƒëi·ªÉm!", "error");
            if(confirm(`ƒê·ªïi ${n}?`)) {
                await db.collection('artifacts').doc(appId).collection('public').doc('data').collection('members').doc(m.id).update({totalPoints: (m.totalPoints||0)-c});
                logActivity(`üéÅ ${m.name} ƒë·ªïi qu√†: ${n} (-${c}ƒë)`); showToast("ƒê·ªïi th√†nh c√¥ng!"); confetti();
            }
        }
        window.setView = v => { state.currentView=v; renderApp(); }
        window.setFilter = id => { state.selectedMemberFilter=id; renderApp(); }
        window.changeDate = d => { state.calendarDate.setDate(state.calendarDate.getDate()+d); state.calendarDate=new Date(state.calendarDate); renderApp(); }
        window.goToToday = () => { state.calendarDate=new Date(); renderApp(); }
        window.closeModal = (e,force) => { if(force || e.target===modalContainer){ modalContainer.innerHTML=''; modalContainer.className='hidden'; } }
        window.openModal = (type) => { if(type==='createTask') renderCreateTaskModal(); }
        window.checkPin = () => { if(document.getElementById('admin-pin').value==='1231'){ state.isAdminUnlocked=true; renderApp(); showToast('Hello Admin!'); } }
        window.lockAdmin = () => { state.isAdminUnlocked=false; renderApp(); }
        
        function renderNotificationsPage() { setTimeout(() => { localStorage.setItem('lastVisit', new Date().toISOString()); renderApp(); }, 1000); return `<div class="animate-fade-in-up pb-20"><div class="flex justify-between items-center mb-4 px-2"><h2 class="text-xl font-black text-gray-800">Ho·∫°t ƒê·ªông</h2><button onclick="clearActivities()" class="text-xs text-gray-400 hover:text-red-500">Xo√° h·∫øt</button></div><div class="space-y-4">${state.activities.map(a => `<div class="bg-white p-4 rounded-2xl shadow-sm flex gap-3 items-start border border-gray-100"><div class="w-8 h-8 rounded-full bg-blue-50 flex items-center justify-center text-blue-500 shrink-0 mt-1"><i class="fas fa-bell"></i></div><div><p class="text-gray-800 text-sm font-medium leading-relaxed">${a.content}</p><p class="text-xs text-gray-400 mt-1 font-bold">${formatTime(a.createdAt)} - ${formatDate(a.createdAt)}</p></div></div>`).join('')}${state.activities.length===0?'<p class="text-center text-gray-400 mt-10">Tr·ªëng.</p>':''}</div></div>`; }
        function renderCalendar() { const now=state.calendarDate; const dM=new Date(now.getFullYear(),now.getMonth()+1,0).getDate(); const fD=new Date(now.getFullYear(),now.getMonth(),1).getDay(); let h=''; for(let i=0;i<fD;i++) h+=`<div class="h-10"></div>`; for(let d=1;d<=dM;d++) h+=`<div onclick="selectDate(${d})" class="h-10 flex items-center justify-center rounded-lg cursor-pointer text-sm font-medium ${d===now.getDate()?'bg-indigo-600 text-white shadow-md':'text-gray-700 hover:bg-gray-100'}">${d}</div>`; const tasks=state.tasks.filter(t=>t.frequency==='daily'||(t.createdAt&&new Date(t.createdAt.seconds*1000).toDateString()===now.toDateString())); return `<div class="animate-fade-in-up"><div class="bg-white rounded-2xl p-4 shadow-sm border border-gray-100 mb-4"><div class="grid grid-cols-7 gap-1 text-center mb-2 font-bold text-gray-400 text-xs"><span>CN</span><span>T2</span><span>T3</span><span>T4</span><span>T5</span><span>T6</span><span>T7</span></div><div class="grid grid-cols-7 gap-1">${h}</div></div><div class="px-1"><h3 class="font-bold text-gray-700 mb-3">L·ªãch ng√†y ${now.getDate()}</h3><div class="space-y-2">${tasks.map(t=>{ const m=state.members.find(x=>x.id===t.assignedTo); return `<div class="bg-white p-3 rounded-xl border border-gray-100 flex items-center gap-3"><div class="w-2 h-10 ${t.status==='done'?'bg-green-500':'bg-gray-300'} rounded-full"></div><div class="flex-1 text-sm font-bold text-gray-800">${t.title} ${m?`<span class="text-blue-600 bg-blue-50 px-1 rounded ml-1">[${m.name}]</span>`:''}</div>${t.status==='done'?'<i class="fas fa-check text-green-500"></i>':''}</div>`; }).join('') || '<p class="text-center text-sm text-gray-400 italic">Tr·ªëng.</p>'}</div></div></div>`; }
        window.selectDate = d => { state.calendarDate.setDate(d); state.calendarDate=new Date(state.calendarDate); renderApp(); }
        function renderShop() { const r=[{n:'TV 1h',c:50,i:'üì∫'},{n:'Tr√† s·ªØa',c:100,i:'ü•§'},{n:'Game 30p',c:80,i:'üéÆ'}]; const cur=state.members.find(m=>m.id===state.selectedMemberFilter)||{totalPoints:0}; return `<div class="animate-fade-in-up pb-20"><div class="bg-gradient-to-r from-pink-500 to-rose-500 rounded-2xl p-6 text-white shadow-lg mb-6"><h2 class="text-2xl font-black mb-1">C·ª≠a H√†ng</h2><p class="text-pink-100 text-sm">S·ªë d∆∞: ${cur.totalPoints||0} xu</p></div><div class="grid grid-cols-2 gap-3">${r.map(x=>`<button onclick="redeemReward('${x.n}',${x.c})" class="bg-white p-4 rounded-2xl shadow-sm border-2 ${cur.totalPoints>=x.c?'hover:border-pink-500':'opacity-60 grayscale'}"><div class="text-4xl mb-3">${x.i}</div><div class="font-bold text-gray-800 text-sm">${x.n}</div><div class="text-xs font-black px-2 py-1 rounded-full bg-pink-100 text-pink-600 inline-block">-${x.c}</div></button>`).join('')}</div></div>`; }
        function renderReport() { return `<div class="animate-fade-in-up"><div class="bg-white rounded-2xl p-6 shadow-sm border border-gray-100 mb-6"><h2 class="text-xl font-bold text-red-600 mb-4">B√°o C√°o</h2><div class="grid grid-cols-4 gap-2 mb-4">${state.members.map(m=>`<div onclick="state.reportTargetId='${m.id}';renderApp()" class="flex flex-col items-center p-2 rounded-xl border-2 cursor-pointer ${state.reportTargetId===m.id?'border-red-500 bg-red-50':'border-gray-100'}"><div class="text-2xl">${getAvatarEmoji(m)}</div><div class="text-[10px] font-bold mt-1">${m.name}</div></div>`).join('')}</div><textarea id="rep-reason" class="w-full p-3 border rounded-xl bg-gray-50 text-sm mb-4" placeholder="L√Ω do..."></textarea><button onclick="submitReport()" class="w-full bg-red-500 text-white font-bold py-3 rounded-xl">G·ª≠i</button></div></div>`; }
        function renderMenu() { const s=[...state.members].sort((a,b)=>(b.totalPoints||0)-(a.totalPoints||0)); return `<div class="animate-fade-in-up space-y-6"><div class="bg-gradient-to-br from-yellow-100 to-orange-100 rounded-3xl p-6 shadow-sm"><h2 class="text-xl font-bold text-orange-800 mb-4">üèÜ B·∫£ng X·∫øp H·∫°ng</h2><div class="space-y-3">${s.map((m,i)=>`<div class="bg-white/80 p-3 rounded-xl flex items-center gap-3"><div class="font-bold text-lg w-6 text-center text-gray-600">${i+1}</div><div class="text-2xl">${getAvatarEmoji(m)}</div><div class="flex-1 font-bold text-gray-800 text-sm">${m.name}</div><div class="font-black text-orange-600">${m.totalPoints||0}</div></div>`).join('')}</div></div><div class="bg-white rounded-2xl p-6 shadow-sm border border-gray-100"><h2 class="text-lg font-bold text-gray-800 mb-4">Qu·∫£n tr·ªã vi√™n</h2>${!state.isAdminUnlocked?`<div class="flex gap-2"><input type="password" id="admin-pin" placeholder="PIN" class="flex-1 p-3 border border-gray-200 rounded-xl text-center font-bold tracking-widest"><button onclick="checkPin()" class="bg-purple-600 text-white px-6 rounded-xl font-bold">M·ªü</button></div>`:`<button onclick="lockAdmin()" class="w-full bg-red-100 text-red-600 py-3 rounded-xl font-bold">Tho√°t Admin</button><div class="grid grid-cols-2 gap-2 mt-4"><button onclick="openModal('addMember')" class="p-3 bg-gray-50 rounded-xl font-bold text-xs">Th√™m TV</button></div>`}</div></div>`; }
        window.addMem = async () => { const n=document.getElementById('n-mem').value; if(n){ await db.collection('artifacts').doc(appId).collection('public').doc('data').collection('members').add({name:n, emoji:'üôÇ', totalPoints:0}); closeModal(null,true); } }
        window.openModal = (type) => { 
            if(type==='createTask') renderCreateTaskModal(); 
            else if(type==='addMember') { modalContainer.innerHTML=`<div class="bg-white p-6 rounded-2xl w-80"><h3 class="font-bold mb-3">Th√™m TV</h3><input id="n-mem" class="w-full border p-2 rounded mb-3" placeholder="T√™n"><button onclick="addMem()" class="w-full bg-green-500 text-white py-2 rounded font-bold">Th√™m</button></div>`; modalContainer.className="fixed inset-0 bg-black/50 z-50 flex items-center justify-center"; }
        }
        window.submitReport = async () => { if(state.reportTargetId && document.getElementById('rep-reason').value){ await db.collection('artifacts').doc(appId).collection('public').doc('data').collection('reports').add({targetId:state.reportTargetId, reason:document.getElementById('rep-reason').value, createdAt:new Date()}); showToast("ƒê√£ b√°o c√°o"); logActivity(`‚ö†Ô∏è M·ªôt b√°o c√°o vi ph·∫°m v·ª´a ƒë∆∞·ª£c t·∫°o`); } }

        renderApp();
    </script>
</body>
</html>