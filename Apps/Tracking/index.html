<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FastShip - ƒê·∫∑t H√†ng Qu·ªëc T·∫ø</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: { sans: ['Inter', 'sans-serif'] },
                    colors: { brand: { 500: '#3b82f6', 600: '#2563eb', 50: '#eff6ff' } }
                }
            }
        }
    </script>
    <style>
        .step-card { transition: all 0.2s ease-in-out; cursor: pointer; border: 2px solid transparent; }
        .step-card:hover { transform: translateY(-2px); box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1); }
        .step-card.active { border-color: #2563eb; background-color: #eff6ff; }
        .step-card.active .check-icon { display: block; }
        /* ·∫®n hi·ªán m∆∞·ª£t m√† */
        .fade-in { animation: fadeIn 0.5s ease-in-out forwards; opacity: 0; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body class="bg-slate-50 text-slate-800 pb-20">

    <nav class="bg-white shadow-sm sticky top-0 z-50">
        <div class="max-w-3xl mx-auto px-4 h-16 flex items-center justify-between">
            <div class="font-bold text-xl text-brand-600"><i class="fa-solid fa-paper-plane mr-2"></i>FastShip</div>
        </div>
    </nav>

    <main class="max-w-3xl mx-auto px-4 py-8 space-y-8">
        
        <section id="step1">
            <h3 class="text-sm font-bold text-slate-400 uppercase tracking-wider mb-3">B∆∞·ªõc 1: B·∫°n mu·ªën mua h√†ng t·ª´ ƒë√¢u?</h3>
            <div class="grid grid-cols-2 sm:grid-cols-4 gap-4" id="fromContainer">
                </div>
        </section>

        <section id="step2" class="hidden">
            <h3 class="text-sm font-bold text-slate-400 uppercase tracking-wider mb-3">B∆∞·ªõc 2: Chuy·ªÉn h√†ng v·ªÅ ƒë√¢u?</h3>
            <div class="grid grid-cols-2 sm:grid-cols-4 gap-4" id="toContainer">
                </div>
            <div id="noRouteMsg" class="hidden text-red-500 text-sm mt-2 bg-red-50 p-3 rounded-lg">
                <i class="fa-solid fa-circle-exclamation mr-1"></i> Hi·ªán ch∆∞a h·ªó tr·ª£ tuy·∫øn v·∫≠n chuy·ªÉn t·ª´ qu·ªëc gia n√†y.
            </div>
        </section>

        <section id="step3" class="hidden">
            <div class="border-t border-slate-200 my-6"></div>
            
            <h3 class="text-lg font-bold text-slate-800 mb-4 flex items-center gap-2">
                <span class="bg-brand-600 text-white text-xs rounded-full w-6 h-6 flex items-center justify-center">3</span>
                Chi ti·∫øt ƒë∆°n h√†ng
            </h3>

            <form id="orderForm" class="space-y-6">
                <div id="productList" class="space-y-4"></div>

                <button type="button" onclick="addProductItem()" class="w-full py-3 border-2 border-dashed border-slate-300 text-slate-500 rounded-xl font-medium hover:border-brand-500 hover:text-brand-600 transition-colors">
                    <i class="fa-solid fa-plus mr-1"></i> Th√™m s·∫£n ph·∫©m kh√°c
                </button>

                <div class="bg-white p-4 rounded-xl border border-slate-200">
                    <label class="block text-sm font-medium text-slate-700 mb-2">Ghi ch√∫ ƒë∆°n h√†ng</label>
                    <textarea class="w-full border-slate-200 rounded-lg text-sm p-3 focus:ring-brand-500 focus:border-brand-500" rows="2" placeholder="V√≠ d·ª•: Gi·ªØ h·ªôp, b·ªè h·ªôp..."></textarea>
                </div>

                <button type="submit" class="w-full bg-brand-600 text-white py-4 rounded-xl font-bold text-lg shadow-lg shadow-brand-500/30 hover:bg-brand-700 transition-all">
                    X√°c nh·∫≠n g·ª≠i ƒë∆°n
                </button>
            </form>
        </section>

    </main>

  <script>
    // --- 1. DATA QU·ªêC GIA ---
    const locations = {
        'JP': { name: 'Nh·∫≠t B·∫£n', flag: 'üáØüáµ' },
        'VN': { name: 'Vi·ªát Nam', flag: 'üáªüá≥' },
        'CN': { name: 'Trung Qu·ªëc', flag: 'üá®üá≥' },
        'KR': { name: 'H√†n Qu·ªëc', flag: 'üá∞üá∑' },
        'US': { name: 'M·ªπ', flag: 'üá∫üá∏' }
    };
    const supportedRoutes = {
        'JP': ['VN'], 'CN': ['VN', 'JP'], 'KR': ['VN'], 'VN': []
    };
    let selectedFrom = null; 
    let selectedTo = null;

    // --- 2. RENDER CARD (GI·ªÆ NGUY√äN) ---
    function createCardHTML(code, isSelected, onClickFn) {
        const loc = locations[code];
        const activeClass = isSelected ? 'active border-brand-600 bg-brand-50 ring-1 ring-brand-500' : 'border-slate-200 bg-white hover:border-brand-300';
        return `
        <div onclick="${onClickFn}('${code}')" class="step-card relative rounded-xl p-4 flex flex-col items-center justify-center gap-2 h-24 sm:h-28 text-center ${activeClass}">
            <div class="text-3xl">${loc.flag}</div>
            <div class="font-medium text-slate-700">${loc.name}</div>
        </div>`;
    }

    function renderFromStep() {
        document.getElementById('fromContainer').innerHTML = Object.keys(supportedRoutes).map(code => 
            createCardHTML(code, selectedFrom === code, 'selectFrom')
        ).join('');
    }

    function selectFrom(code) {
        selectedFrom = code; selectedTo = null;
        renderFromStep();
        document.getElementById('step2').classList.remove('hidden');
        document.getElementById('step3').classList.add('hidden');
        renderToStep();
    }

    function renderToStep() {
        const container = document.getElementById('toContainer');
        const valid = supportedRoutes[selectedFrom] || [];
        if (valid.length === 0) { container.innerHTML = ''; return; }
        container.innerHTML = valid.map(code => 
            createCardHTML(code, selectedTo === code, 'selectTo')
        ).join('');
    }

    function selectTo(code) {
        selectedTo = code;
        renderToStep();
        document.getElementById('step3').classList.remove('hidden');
        if(document.getElementById('productList').children.length === 0) addProductItem();
        document.getElementById('step3').scrollIntoView({ behavior: 'smooth' });
    }

    // --- 3. LOGIC X·ª¨ L√ù ·∫¢NH (N√ÇNG C·∫§P) ---

    // H√†m g·ªçi API l·∫•y ·∫£nh (C√≥ x·ª≠ l√Ω l·ªói Shopee)
    async function fetchPreview(inputElement, imgId, spinnerId, wrapperId) {
        const url = inputElement.value;
        const imgEl = document.getElementById(imgId);
        const spinner = document.getElementById(spinnerId);
        const wrapper = document.getElementById(wrapperId);

        if (!url || !url.startsWith('http')) {
            resetImageState(imgEl, wrapper);
            return;
        }

        // B·∫≠t tr·∫°ng th√°i loading
        spinner.classList.remove('hidden');
        imgEl.classList.add('hidden');
        wrapper.classList.add('bg-slate-100'); // Reset m√†u n·ªÅn

        try {
            // Th·ª≠ g·ªçi API
            const response = await fetch(`https://api.microlink.io/?url=${encodeURIComponent(url)}&palette=true`);
            const json = await response.json();

            if (json.status === 'success' && json.data.image) {
                imgEl.src = json.data.image.url;
                imgEl.classList.remove('hidden');
                wrapper.classList.remove('bg-slate-100'); // B·ªè n·ªÅn x√°m ƒë·ªÉ ·∫£nh hi·ªán ƒë·∫πp h∆°n
            } else {
                // API tr·∫£ v·ªÅ success nh∆∞ng kh√¥ng c√≥ ·∫£nh (th∆∞·ªùng g·∫∑p v·ªõi Shopee)
                console.warn("Kh√¥ng t√¨m th·∫•y ·∫£nh t·ª± ƒë·ªông");
                resetImageState(imgEl, wrapper);
            }
        } catch (error) {
            console.error("L·ªói k·∫øt n·ªëi:", error);
            resetImageState(imgEl, wrapper);
        } finally {
            spinner.classList.add('hidden');
        }
    }

    // H√†m reset v·ªÅ tr·∫°ng th√°i m·∫∑c ƒë·ªãnh
    function resetImageState(imgEl, wrapper) {
        imgEl.classList.add('hidden');
        imgEl.src = '';
        wrapper.classList.add('bg-slate-100');
    }

    // H√†m cho ph√©p ng∆∞·ªùi d√πng t·ª± d√°n link ·∫£nh (Manual Override)
    function manualImagePrompt(imgId, wrapperId) {
        const url = prompt("Kh√¥ng t√¨m th·∫•y ·∫£nh t·ª± ƒë·ªông. B·∫°n c√≥ mu·ªën d√°n link ·∫£nh tr·ª±c ti·∫øp v√†o ƒë√¢y kh√¥ng?");
        if (url && url.startsWith('http')) {
            const imgEl = document.getElementById(imgId);
            const wrapper = document.getElementById(wrapperId);
            imgEl.src = url;
            imgEl.classList.remove('hidden');
            wrapper.classList.remove('bg-slate-100');
        }
    }

    // --- 4. RENDER FORM S·∫¢N PH·∫®M ---
    let productCount = 0;
    
    function addProductItem() {
        productCount++;
        const container = document.getElementById('productList');
        const div = document.createElement('div');
        div.className = 'bg-white p-4 rounded-xl border border-slate-200 shadow-sm relative group transition-all hover:shadow-md';
        div.id = `item-${productCount}`;
        
        const imgId = `preview-img-${productCount}`;
        const spinnerId = `spinner-${productCount}`;
        const wrapperId = `img-wrapper-${productCount}`;

        const removeBtn = productCount > 1 ? 
            `<button type="button" onclick="this.parentElement.remove()" class="absolute top-3 right-3 text-slate-300 hover:text-red-500"><i class="fa-solid fa-times"></i></button>` : '';

        div.innerHTML = `
            ${removeBtn}
            <div class="flex gap-4 items-start">
                
                <div class="flex-shrink-0 cursor-pointer" onclick="manualImagePrompt('${imgId}', '${wrapperId}')" title="Click ƒë·ªÉ d√°n link ·∫£nh th·ªß c√¥ng">
                    <div id="${wrapperId}" class="w-20 h-20 bg-slate-100 rounded-lg border border-slate-200 flex items-center justify-center overflow-hidden relative transition-colors hover:border-brand-400">
                        <i class="fa-solid fa-image text-slate-300 text-xl absolute"></i>
                        
                        <i id="${spinnerId}" class="fa-solid fa-circle-notch fa-spin text-brand-500 absolute hidden z-20"></i>
                        
                        <img id="${imgId}" class="w-full h-full object-cover relative z-10 hidden" src="" onError="this.style.display='none'">
                    </div>
                    <div class="text-[10px] text-center text-slate-400 mt-1">S·ª≠a ·∫£nh</div>
                </div>

                <div class="flex-grow space-y-3">
                    <div class="text-xs font-bold text-brand-600 uppercase">S·∫£n ph·∫©m #${productCount}</div>
                    
                    <input type="url" name="link[]" 
                           onchange="fetchPreview(this, '${imgId}', '${spinnerId}', '${wrapperId}')"
                           onpaste="setTimeout(() => fetchPreview(this, '${imgId}', '${spinnerId}', '${wrapperId}'), 100)"
                           required 
                           class="w-full bg-slate-50 border-slate-200 rounded-lg p-2.5 text-sm focus:ring-brand-500 focus:border-brand-500 transition-colors" 
                           placeholder="üîó D√°n link s·∫£n ph·∫©m (Shopee, Amazon...)">
                    
                    <div class="flex gap-3">
                        <input type="text" name="attr[]" class="w-2/3 bg-slate-50 border-slate-200 rounded-lg p-2.5 text-sm" placeholder="M√†u / Size">
                        <input type="number" name="qty[]" value="1" class="w-1/3 bg-slate-50 border-slate-200 rounded-lg p-2.5 text-sm text-center font-bold" placeholder="SL">
                    </div>
                </div>
            </div>
        `;
        container.appendChild(div);
    }

    // Init
    renderFromStep();
</script>
</body>
</html>