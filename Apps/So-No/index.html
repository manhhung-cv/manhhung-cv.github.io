<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Debt Manager</title>
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;600;700&display=swap" rel="stylesheet">

    <style>
        :root {
            /* ZEN PALETTE */
            --bg-body: #FAFAFA;
            --bg-surface: #FFFFFF;
            --bg-input: #F5F5F5;
            
            --text-main: #1A1A1A;
            --text-sub: #888888;
            --text-placeholder: #CCCCCC;
            
            --primary: #1A1A1A;
            --primary-fg: #FFFFFF;
            
            --success: #34C759;
            --success-bg: rgba(52, 199, 89, 0.1);
            --danger: #FF3B30;
            --danger-bg: rgba(255, 59, 48, 0.1);
            
            --shadow-sm: 0 2px 8px rgba(0,0,0,0.04);
            --radius-pill: 50px;
            --radius-card: 24px;
            --radius-input: 16px;
            
            --anim: cubic-bezier(0.2, 0.8, 0.2, 1);
        }

        [data-theme="dark"] {
            --bg-body: #000000;
            --bg-surface: #1C1C1E;
            --bg-input: #2C2C2E;
            --text-main: #FFFFFF;
            --text-sub: #8E8E93;
            --primary: #FFFFFF;
            --primary-fg: #000000;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Outfit', sans-serif; -webkit-tap-highlight-color: transparent; outline: none; }
        body { background-color: var(--bg-body); color: var(--text-main); transition: background 0.3s ease; padding-bottom: 120px; font-size: 16px; }
        
        /* LAYOUT & UTILS */
        .container { max-width: 480px; margin: 0 auto; padding: 20px; min-height: 100vh; position: relative; }
        .hidden { display: none !important; }
        .flex-between { display: flex; align-items: center; justify-content: space-between; }
        .w-full { width: 100%; }
        .text-sm { font-size: 0.875rem; color: var(--text-sub); }
        .text-xs { font-size: 0.75rem; color: var(--text-sub); }
        h1 { font-weight: 700; font-size: 1.8rem; letter-spacing: -0.5px; }
        h2 { font-weight: 600; font-size: 1.4rem; }
        
        /* INPUTS & BUTTONS */
        button { border: none; background: none; cursor: pointer; font-weight: 500; font-size: 1rem; transition: transform 0.1s; color: var(--text-main); }
        button:active { transform: scale(0.96); }
        
        .btn-primary { background: var(--primary); color: var(--primary-fg); padding: 16px; border-radius: var(--radius-pill); width: 100%; font-weight: 600; box-shadow: var(--shadow-sm); }
        .btn-secondary { background: var(--bg-input); color: var(--text-main); padding: 16px; border-radius: var(--radius-pill); width: 100%; font-weight: 600; }
        .btn-icon-soft { width: 50px; height: 50px; border-radius: 20px; background: var(--bg-input); display: grid; place-items: center; color: var(--text-sub); transition: 0.2s; }
        .btn-icon-soft.danger { background: var(--danger-bg); color: var(--danger); }
        .btn-text { color: var(--text-sub); font-size: 0.9rem; text-decoration: underline; padding: 10px; }
        
        .input-group { margin-bottom: 16px; }
        .input-label { display: block; font-size: 0.8rem; color: var(--text-sub); margin-bottom: 6px; margin-left: 4px; font-weight: 500; }
        .input-box { background: var(--bg-input); border-radius: var(--radius-input); padding: 16px 20px; width: 100%; border: 2px solid transparent; font-size: 1rem; color: var(--text-main); transition: 0.3s; }
        .input-box:focus { background: var(--bg-surface); border-color: var(--primary); box-shadow: var(--shadow-sm); }
        .input-money { font-size: 1.8rem; font-weight: 700; text-align: center; padding: 24px; background: transparent; border-bottom: 1px solid var(--text-sub); border-radius: 0; margin-bottom: 20px; }
        .input-money:focus { border-color: var(--primary); background: transparent; box-shadow: none; }

        /* COMPONENTS */
        .auth-container { display: flex; flex-direction: column; justify-content: center; min-height: 80vh; text-align: center; }
        .auth-tabs { display: flex; background: var(--bg-input); border-radius: var(--radius-pill); padding: 4px; margin-bottom: 30px; position: relative; }
        .auth-tab { flex: 1; padding: 10px; z-index: 2; font-size: 0.9rem; color: var(--text-sub); transition: 0.3s; }
        .auth-tab.active { color: var(--text-main); font-weight: 600; }
        .tab-slider { position: absolute; top: 4px; bottom: 4px; left: 4px; width: calc(50% - 4px); background: var(--bg-surface); border-radius: var(--radius-pill); box-shadow: var(--shadow-sm); transition: 0.3s var(--anim); z-index: 1; }
        
        header { padding: 10px 0 20px; }
        .avatar { width: 40px; height: 40px; border-radius: 50%; background: var(--primary); color: var(--primary-fg); display: grid; place-items: center; font-weight: 600; font-size: 1.2rem; cursor: pointer; }
        
        .stat-card { background: var(--bg-surface); padding: 20px; border-radius: var(--radius-card); box-shadow: var(--shadow-sm); display: flex; flex-direction: column; min-height: 140px; }
        .card-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 16px; margin-bottom: 30px; }
        .stat-header { display: flex; align-items: center; gap: 8px; margin-bottom: 12px; padding-bottom: 12px; border-bottom: 1px dashed var(--bg-input); }
        .stat-icon { width: 28px; height: 28px; border-radius: 8px; display: grid; place-items: center; font-size: 0.8rem; }
        .stat-body { flex: 1; display: flex; flex-direction: column; justify-content: center; gap: 6px; }
        .currency-row { display: flex; justify-content: space-between; align-items: baseline; font-size: 1.1rem; font-weight: 700; }
        .currency-tag { font-size: 0.65rem; background: var(--bg-input); padding: 2px 6px; border-radius: 6px; color: var(--text-sub); font-weight: 500; margin-left: 4px; }
        .stat-count { font-size: 0.75rem; color: var(--text-sub); margin-top: 4px; }
        
        .stat-card.thu .stat-icon { background: var(--success-bg); color: var(--success); }
        .stat-card.thu .currency-row { color: var(--success); }
        .stat-card.chi .stat-icon { background: var(--danger-bg); color: var(--danger); }
        .stat-card.chi .currency-row { color: var(--danger); }

        .list-item { background: var(--bg-surface); padding: 16px; border-radius: 20px; margin-bottom: 12px; display: flex; align-items: center; gap: 16px; cursor: pointer; transition: 0.2s; box-shadow: var(--shadow-sm); }
        .list-item:active { transform: scale(0.98); }
        .item-icon { width: 48px; height: 48px; border-radius: 16px; display: grid; place-items: center; font-size: 1.2rem; flex-shrink: 0; }
        .item-icon.thu { background: var(--success-bg); color: var(--success); }
        .item-icon.chi { background: var(--danger-bg); color: var(--danger); }
        
        /* HISTORY & ACTION BAR */
        .history-list { margin-top: 20px; max-height: 250px; overflow-y: auto; padding-right: 4px; }
        .history-item { display: flex; justify-content: space-between; align-items: center; padding: 14px 0; border-bottom: 1px dashed var(--bg-input); }
        .history-item:last-child { border-bottom: none; }
        .history-info { flex: 1; }
        .history-date { font-size: 0.75rem; color: var(--text-sub); display: block; margin-bottom: 2px; }
        .history-note { font-size: 0.85rem; color: var(--text-main); font-style: italic; display: block; margin-top: 4px; opacity: 0.8; }
        .history-amount { font-weight: 600; font-size: 1rem; }
        .btn-delete-history { margin-left: 12px; color: var(--danger); padding: 8px; opacity: 0.6; transition: 0.2s; }
        .btn-delete-history:hover { opacity: 1; background: var(--danger-bg); border-radius: 50%; }

        .action-bar { display: flex; gap: 12px; margin-top: 20px; align-items: center; }
        .action-btn-main { flex: 2; }
        .action-btn-sub { flex: 1; }
        .action-btn-icon { flex: 0 0 50px; }

        .fab { position: fixed; bottom: 30px; right: 20px; width: 64px; height: 64px; border-radius: 22px; background: var(--primary); color: var(--primary-fg); display: grid; place-items: center; font-size: 1.6rem; z-index: 90; transition: 0.3s var(--anim); box-shadow: 0 16px 32px rgba(0,0,0,0.15); }
        .fab:active { transform: scale(0.9); }

        .modal-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.3); backdrop-filter: blur(4px); z-index: 100; opacity: 0; pointer-events: none; transition: 0.3s; }
        .modal-overlay.open { opacity: 1; pointer-events: auto; }
        .bottom-sheet { position: absolute; bottom: 0; left: 0; right: 0; background: var(--bg-surface); border-radius: 32px 32px 0 0; padding: 30px 24px 40px; transform: translateY(100%); transition: 0.4s var(--anim); max-height: 90vh; overflow-y: auto; }
        .modal-overlay.open .bottom-sheet { transform: translateY(0); }
        .sheet-handle { width: 40px; height: 4px; background: var(--text-placeholder); border-radius: 2px; margin: 0 auto 24px; opacity: 0.5; }

        .dialog-content { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%) scale(0.9); background: var(--bg-surface); padding: 24px; border-radius: 24px; width: 90%; max-width: 320px; text-align: center; transition: 0.3s var(--anim); opacity: 0; }
        .modal-overlay.dialog-mode .dialog-content { transform: translate(-50%, -50%) scale(1); opacity: 1; }

        .switcher { display: flex; background: var(--bg-input); padding: 4px; border-radius: 14px; margin-bottom: 20px; }
        .switch-opt { flex: 1; text-align: center; padding: 10px; font-size: 0.9rem; color: var(--text-sub); border-radius: 10px; transition: 0.2s; }
        .switch-opt.active { background: var(--bg-surface); color: var(--text-main); font-weight: 600; box-shadow: var(--shadow-sm); }
        
        .menu-btn { display: flex; align-items: center; width: 100%; padding: 16px; background: var(--bg-input); border-radius: 16px; margin-bottom: 10px; text-align: left; transition: 0.2s; }
        .menu-btn:active { background: var(--bg-surface); }
        .menu-btn i { width: 30px; font-size: 1.2rem; }

        .loader { position: fixed; inset: 0; background: var(--bg-body); z-index: 999; display: grid; place-items: center; }
        .spinner { width: 40px; height: 40px; border: 3px solid var(--bg-input); border-top-color: var(--primary); border-radius: 50%; animation: spin 0.8s infinite linear; }
        @keyframes spin { to {transform: rotate(360deg);} }
        .toast { position: fixed; top: 20px; left: 50%; transform: translateX(-50%) translateY(-20px); background: var(--primary); color: var(--primary-fg); padding: 12px 24px; border-radius: 30px; font-size: 0.9rem; opacity: 0; transition: 0.3s; pointer-events: none; z-index: 200; white-space: nowrap; }
        .toast.show { opacity: 1; transform: translateX(-50%) translateY(0); }

    </style>
</head>
<body>

    <div id="loader" class="loader"><div class="spinner"></div></div>
    <div id="toast" class="toast">Notification</div>

    <div id="auth-screen" class="container hidden auth-container">
        <div style="font-size: 3rem; margin-bottom: 10px;"><i class="fas fa-seedling"></i></div>
        <h1 style="margin-bottom: 10px;">Zen Debt</h1>
        <p class="text-sm" style="margin-bottom: 40px;">Quản lý tài chính tinh gọn</p>

        <div class="auth-tabs">
            <div class="tab-slider" id="tab-slider"></div>
            <div class="auth-tab active" onclick="switchAuth('login')">Đăng nhập</div>
            <div class="auth-tab" onclick="switchAuth('register')">Đăng ký</div>
        </div>

        <form id="login-form">
            <div class="input-group">
                <input type="email" id="l-email" class="input-box" placeholder="Email" required>
            </div>
            <div class="input-group">
                <input type="password" id="l-pass" class="input-box" placeholder="Mật khẩu" required>
            </div>
            <div style="text-align: right; margin-bottom: 20px;">
                <span class="text-xs" style="text-decoration: underline; cursor: pointer;" onclick="toggleForgot(true)">Quên mật khẩu?</span>
            </div>
            <button type="submit" class="btn-primary">Đăng Nhập</button>
        </form>

        <form id="register-form" class="hidden">
            <div class="input-group">
                <input type="email" id="r-email" class="input-box" placeholder="Email của bạn" required>
            </div>
            <div class="input-group">
                <input type="password" id="r-pass" class="input-box" placeholder="Mật khẩu (6+ ký tự)" required>
            </div>
            <button type="submit" class="btn-primary">Tạo Tài Khoản</button>
        </form>

        <form id="forgot-form" class="hidden">
            <p class="text-sm" style="margin-bottom: 20px;">Nhập email để nhận link reset.</p>
            <div class="input-group">
                <input type="email" id="f-email" class="input-box" placeholder="Email" required>
            </div>
            <button type="submit" class="btn-primary" style="margin-bottom: 10px;">Gửi Link</button>
            <button type="button" class="btn-text" onclick="toggleForgot(false)">Quay lại</button>
        </form>

        <div style="margin-top: 40px; padding-top: 20px; border-top: 1px solid var(--bg-input);">
            <button type="button" class="text-sm" onclick="enableOffline()">Hoặc dùng <b>Offline</b> (Không cần mạng)</button>
        </div>
    </div>

    <div id="app-screen" class="container hidden">
        <header class="flex-between">
            <div>
                <div class="text-sm" id="date-display">Today</div>
                <h2>Tổng quan</h2>
            </div>
            <div class="avatar" onclick="openSettings()" id="user-avatar">H</div>
        </header>

        <div class="card-grid">
            <div class="stat-card thu">
                <div class="stat-header">
                    <div class="stat-icon"><i class="fas fa-arrow-up"></i></div>
                    <div class="stat-label">Cho vay</div>
                </div>
                <div class="stat-body" id="container-thu">
                    <div class="currency-row">0</div>
                </div>
            </div>
            <div class="stat-card chi">
                <div class="stat-header">
                    <div class="stat-icon"><i class="fas fa-arrow-down"></i></div>
                    <div class="stat-label">Đi vay</div>
                </div>
                <div class="stat-body" id="container-chi">
                    <div class="currency-row">0</div>
                </div>
            </div>
        </div>

        <div class="flex-between" style="margin-bottom: 16px;">
            <div class="section-title" style="margin:0">Giao dịch gần đây</div>
            <input type="text" id="search-inp" placeholder="Tìm kiếm..." style="border:none; background: transparent; text-align: right; width: 120px; color: var(--text-main);">
        </div>

        <div id="list-container"></div>
    </div>

    <button class="fab hidden" id="fab-add" onclick="openAddEdit()"><i class="fas fa-plus"></i></button>

    <div id="modal-container"></div>
    <input type="file" id="file-input" class="hidden" accept=".json">

    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-storage.js"></script>

    <script>
        const firebaseConfig = { apiKey: "AIzaSyC1qeU_x_mpm5g01B3lzNKkOq3PL9ymUAU", authDomain: "so-no-4d452.firebaseapp.com", projectId: "so-no-4d452", storageBucket: "so-no-4d452.appspot.com", messagingSenderId: "852098567588", appId: "1:852098567588:web:2840cbbe6bdaac04198531" };

        let storageMode = localStorage.getItem('mode') || 'auth';
        let jpyMode = localStorage.getItem('jpy') || 'man';
        let themeMode = localStorage.getItem('themeMode') || 'system';
        let currentUser = null;
        let debts = [];
        let db, auth, colRef;

        const el = {
            loader: document.getElementById('loader'),
            toast: document.getElementById('toast'),
            auth: document.getElementById('auth-screen'),
            app: document.getElementById('app-screen'),
            fab: document.getElementById('fab-add'),
            list: document.getElementById('list-container'),
            conThu: document.getElementById('container-thu'),
            conChi: document.getElementById('container-chi'),
            modal: document.getElementById('modal-container'),
            date: document.getElementById('date-display'),
            avatar: document.getElementById('user-avatar'),
            slider: document.getElementById('tab-slider'),
            fileIn: document.getElementById('file-input')
        };

        const showToast = (msg) => { el.toast.textContent = msg; el.toast.classList.add('show'); setTimeout(()=>el.toast.classList.remove('show'), 2000); };
        const toggleLoader = (show) => el.loader.classList.toggle('hidden', !show);
        const formatNumber = (n) => n.replace(/\D/g, "").replace(/\B(?=(\d{3})+(?!\d))/g, ".");
        const getRaw = (n) => Number(n.replace(/\./g, ""));
        
        const formatMoney = (n, c) => {
            if(!n && n!==0) return '0';
            if(c === 'JPY') {
                if(jpyMode === 'man' && Math.abs(n) >= 10000) {
                    const m = Math.floor(n/10000), r = n%10000;
                    return r===0 ? `${new Intl.NumberFormat('ja-JP').format(m)}万` : `${new Intl.NumberFormat('ja-JP').format(m)}万${r}`;
                }
                return new Intl.NumberFormat('ja-JP', {style:'currency', currency:'JPY'}).format(n);
            }
            return new Intl.NumberFormat('vi-VN', {style:'currency', currency: c||'VND', maximumFractionDigits:0}).format(n);
        };

        const formatDate = (s) => s ? new Date(s).toLocaleDateString('vi-VN', {day:'2-digit', month:'2-digit'}) : '';
        const formatDateTime = (s) => s ? new Date(s).toLocaleString('vi-VN', {day:'2-digit', month:'2-digit', hour:'2-digit', minute:'2-digit'}) : '';

        const applyTheme = () => {
            const sysDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
            let isDark = false;
            if (themeMode === 'system') isDark = sysDark;
            else if (themeMode === 'dark') isDark = true;
            document.documentElement.setAttribute('data-theme', isDark ? 'dark' : 'light');
        };

        const cycleTheme = () => {
            if (themeMode === 'system') themeMode = 'light';
            else if (themeMode === 'light') themeMode = 'dark';
            else themeMode = 'system';
            localStorage.setItem('themeMode', themeMode);
            applyTheme();
            renderSettingsMenu();
        };

        window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', applyTheme);

        const openModal = (html, isDialog = false) => {
            const div = document.createElement('div');
            div.className = `modal-overlay ${isDialog ? 'dialog-mode' : ''}`;
            div.innerHTML = isDialog ? `<div class="dialog-content">${html}</div>` : `<div class="bottom-sheet"><div class="sheet-handle"></div>${html}</div>`;
            el.modal.appendChild(div);
            setTimeout(() => div.classList.add('open'), 10);
            div.onclick = (e) => { if(e.target === div) closeModal(); };
        };

        const closeModal = () => {
            const div = document.querySelector('.modal-overlay');
            if(div) { div.classList.remove('open'); setTimeout(() => div.remove(), 300); }
        };

        const openConfirm = (title, msg, callback) => {
            openModal(`
                <h3 style="margin-bottom:10px">${title}</h3>
                <p class="text-sm" style="margin-bottom:20px">${msg}</p>
                <div class="flex-between" style="gap:10px">
                    <button class="btn-text" onclick="closeModal()">Hủy</button>
                    <button class="btn-primary" style="background:var(--danger); color:white" id="confirm-yes">Xác nhận</button>
                </div>
            `, true);
            document.getElementById('confirm-yes').onclick = () => { callback(); closeModal(); };
        };

        const switchAuth = (type) => {
            const isLogin = type === 'login';
            el.slider.style.transform = isLogin ? 'translateX(0)' : 'translateX(100%)';
            document.getElementById('login-form').classList.toggle('hidden', !isLogin);
            document.getElementById('register-form').classList.toggle('hidden', isLogin);
            document.getElementById('forgot-form').classList.add('hidden');
        };

        const toggleForgot = (show) => {
            document.getElementById('login-form').classList.toggle('hidden', show);
            document.getElementById('forgot-form').classList.toggle('hidden', !show);
            document.querySelector('.auth-tabs').classList.toggle('hidden', show);
        };

        const enableOffline = () => { localStorage.setItem('mode', 'local'); storageMode = 'local'; initData(); };

        const handleSecureLogout = () => {
            openConfirm("Đăng xuất & Xóa dữ liệu?", "Dữ liệu trên thiết bị này sẽ bị xóa hoàn toàn để bảo mật.", async () => {
                toggleLoader(true);
                try {
                    if(storageMode === 'firebase' || storageMode === 'auth') await auth.signOut();
                    localStorage.removeItem('debts'); localStorage.removeItem('mode');
                    currentUser = null; debts = []; window.location.reload();
                } catch (error) { showToast("Lỗi: " + error.message); toggleLoader(false); }
            });
        };

        const initData = async () => {
            if(storageMode === 'local') {
                debts = JSON.parse(localStorage.getItem('debts')) || []; render(); showApp(true);
            } else if (currentUser) {
                storageMode = 'firebase'; localStorage.setItem('mode', 'firebase');
                colRef = db.collection('users').doc(currentUser.uid).collection('debts');
                colRef.onSnapshot(snap => { debts = snap.docs.map(d => ({id: d.id, ...d.data()})); render(); showApp(true); });
            } else { showApp(false); }
        };

        const saveData = async (data, id = null) => {
            toggleLoader(true);
            try {
                if(storageMode === 'local') {
                    if(id) debts = debts.map(d => d.id === id ? {...d, ...data} : d);
                    else debts.push({id: Date.now().toString(), createdAt: new Date().toISOString(), payments: [], totalPaid: 0, status: 'pending', ...data});
                    localStorage.setItem('debts', JSON.stringify(debts)); render();
                } else {
                    if(id) await colRef.doc(id).update({...data, updatedAt: new Date().toISOString()});
                    else await colRef.add({createdAt: new Date().toISOString(), payments: [], totalPaid: 0, status: 'pending', ...data});
                }
                closeModal();
            } catch(e) { showToast("Lỗi lưu dữ liệu!"); }
            toggleLoader(false);
        };

        const deleteData = (id) => {
            openConfirm("Xóa giao dịch này?", "Hành động này không thể hoàn tác.", async () => {
                toggleLoader(true);
                if(storageMode === 'local') {
                    debts = debts.filter(d => d.id !== id); localStorage.setItem('debts', JSON.stringify(debts)); render();
                } else { await colRef.doc(id).delete(); }
                toggleLoader(false);
            });
        };

        const addPayment = async (id, amt, note) => {
            toggleLoader(true);
            const pObj = {amount: amt, date: new Date().toISOString(), note: note || ''};
            if(storageMode === 'local') {
                const d = debts.find(x => x.id === id);
                if(d) {
                    d.payments = [...(d.payments||[]), pObj];
                    d.totalPaid = d.payments.reduce((s, i) => s + i.amount, 0);
                    d.status = d.totalPaid >= d.amount ? 'paid' : 'pending';
                    localStorage.setItem('debts', JSON.stringify(debts)); render();
                }
            } else {
                await db.runTransaction(async (t) => {
                    const ref = colRef.doc(id); const doc = await t.get(ref); const d = doc.data();
                    const np = [...(d.payments||[]), pObj];
                    const paid = np.reduce((s, i) => s + i.amount, 0);
                    t.update(ref, { payments: np, totalPaid: paid, status: paid >= d.amount ? 'paid' : 'pending' });
                });
            }
            closeModal(); toggleLoader(false);
        };

        const deletePayment = (debtId, pIndex) => {
            openConfirm("Xóa lịch sử này?", "Số tiền đã trả sẽ bị trừ lại.", async () => {
                toggleLoader(true);
                if(storageMode === 'local') {
                    const d = debts.find(x => x.id === debtId);
                    if(d && d.payments) {
                        d.payments.splice(pIndex, 1);
                        d.totalPaid = d.payments.reduce((s, i) => s + i.amount, 0);
                        d.status = d.totalPaid >= d.amount ? 'paid' : 'pending';
                        localStorage.setItem('debts', JSON.stringify(debts)); render();
                        closeModal(); openDetail(d); 
                    }
                } else {
                    await db.runTransaction(async (t) => {
                        const ref = colRef.doc(debtId); const doc = await t.get(ref); const d = doc.data();
                        const np = [...d.payments];
                        np.splice(pIndex, 1);
                        const paid = np.reduce((s, i) => s + i.amount, 0);
                        t.update(ref, { payments: np, totalPaid: paid, status: paid >= d.amount ? 'paid' : 'pending' });
                    });
                    closeModal();
                }
                toggleLoader(false);
            });
        };

        const render = () => {
            const term = document.getElementById('search-inp').value.toLowerCase();
            const filtered = debts.filter(d => d.name.toLowerCase().includes(term) || (d.amount+"").includes(term));
            filtered.sort((a,b) => new Date(b.createdAt) - new Date(a.createdAt));

            const sums = filtered.reduce((acc, d) => {
                const rem = d.amount - (d.totalPaid||0);
                if(d.status !== 'paid') {
                    const c = d.currency || 'VND';
                    if(!acc[c]) acc[c] = {thu:0, chi:0, countThu: 0, countChi: 0};
                    if(d.type==='thu') { acc[c].thu += rem; acc[c].countThu++; } 
                    else { acc[c].chi += rem; acc[c].countChi++; }
                }
                return acc;
            }, {});

            const renderDetailedStats = (type, container) => {
                const currencies = Object.keys(sums);
                if(currencies.length === 0) { container.innerHTML = '<div class="currency-row" style="color:var(--text-sub)">0</div>'; return; }
                let html = ''; let hasData = false;
                currencies.forEach(c => {
                    const val = sums[c][type]; const count = sums[c][type === 'thu' ? 'countThu' : 'countChi'];
                    if(val > 0 || count > 0) { hasData = true; html += `<div style="margin-bottom: 8px;"><div class="currency-row">${formatMoney(val, c)} <span class="currency-tag">${c}</span></div><div class="stat-count">${count} khoản</div></div>`; }
                });
                container.innerHTML = hasData ? html : '<div class="currency-row" style="color:var(--text-sub)">0</div>';
            };

            renderDetailedStats('thu', el.conThu); renderDetailedStats('chi', el.conChi);

            el.list.innerHTML = filtered.length ? filtered.map(d => {
                const rem = d.amount - (d.totalPaid||0); const isPaid = d.status === 'paid' || rem <= 0;
                return `
                <div class="list-item" onclick='openDetail(${JSON.stringify(d).replace(/'/g, "&#39;")})'>
                    <div class="item-icon ${d.type}"><i class="fas ${d.type==='thu'?'fa-arrow-up':'fa-arrow-down'}"></i></div>
                    <div style="flex:1; overflow:hidden">
                        <div style="font-weight:600; white-space:nowrap; overflow:hidden; text-overflow:ellipsis">${d.name}</div>
                        <div class="text-xs">${formatDate(d.date)} ${d.currency}</div>
                    </div>
                    <div style="text-align:right">
                        <div style="font-weight:600; color:${isPaid?'var(--text-placeholder)':(d.type==='thu'?'var(--success)':'var(--danger)')}">
                            ${isPaid ? 'Hoàn tất' : formatMoney(rem, d.currency)}
                        </div>
                    </div>
                </div>`;
            }).join('') : '<div class="empty-state"><i class="fas fa-wind" style="font-size: 2rem; margin-bottom: 10px;"></i><p>Chưa có dữ liệu</p></div>';
        };

        const showApp = (show) => {
            el.auth.classList.toggle('hidden', show); el.app.classList.toggle('hidden', !show); el.fab.classList.toggle('hidden', !show); toggleLoader(false);
            if(show) { el.date.textContent = new Date().toLocaleDateString('vi-VN', {weekday:'long', day:'numeric', month:'short'}); el.avatar.textContent = storageMode==='local' ? 'L' : (currentUser?.email[0].toUpperCase() || 'H'); }
        };

        window.openAddEdit = (d = null) => {
            openModal(`
                <h2 style="margin-bottom:20px">${d?'Sửa':'Thêm'} giao dịch</h2>
                <form id="action-form">
                    <div class="switcher"><div class="switch-opt ${!d||d.type==='thu'?'active':''}" onclick="selectSwitch(this, 'type', 'thu')">Cho vay</div><div class="switch-opt ${d?.type==='chi'?'active':''}" onclick="selectSwitch(this, 'type', 'chi')">Đi vay</div></div>
                    <input type="hidden" id="inp-type" value="${d?.type||'thu'}">
                    <div class="switcher"><div class="switch-opt ${!d||d.currency==='VND'?'active':''}" onclick="selectSwitch(this, 'curr', 'VND')">VND</div><div class="switch-opt ${d?.currency==='JPY'?'active':''}" onclick="selectSwitch(this, 'curr', 'JPY')">JPY</div><div class="switch-opt ${d?.currency==='USD'?'active':''}" onclick="selectSwitch(this, 'curr', 'USD')">USD</div></div>
                    <input type="hidden" id="inp-curr" value="${d?.currency||'VND'}">
                    
                    <div class="input-group">
                        <label class="input-label">Số tiền</label>
                        <input type="text" id="inp-amt" class="input-box input-money" placeholder="0" value="${d ? formatNumber(d.amount.toString()) : ''}" inputmode="numeric" required>
                    </div>
                    
                    <div class="input-group">
                        <label class="input-label">Người liên quan / Chủ đề</label>
                        <input type="text" id="inp-name" class="input-box" placeholder="Ví dụ: Nguyễn Văn A..." value="${d?.name||''}" required>
                    </div>

                    <div class="input-group">
                        <label class="input-label">Ghi chú (Tùy chọn)</label>
                        <input type="text" id="inp-note" class="input-box" placeholder="Ghi chú chi tiết..." value="${d?.note||''}">
                    </div>

                    <div style="display:flex; gap:10px">
                        <div style="flex:1" class="input-group">
                            <label class="input-label">Ngày tạo</label>
                            <input type="date" id="inp-date" class="input-box" value="${d?.date||new Date().toISOString().split('T')[0]}">
                        </div>
                        <div style="flex:1" class="input-group">
                            <label class="input-label">Hẹn trả</label>
                            <input type="date" id="inp-due" class="input-box" value="${d?.dueDate||''}">
                        </div>
                    </div>
                    <button type="submit" class="btn-primary">Lưu</button>
                </form>
            `);
            const amt = document.getElementById('inp-amt'); amt.oninput = () => amt.value = formatNumber(amt.value);
            document.getElementById('action-form').onsubmit = (e) => {
                e.preventDefault();
                saveData({ 
                    type: document.getElementById('inp-type').value, 
                    currency: document.getElementById('inp-curr').value, 
                    amount: getRaw(amt.value), 
                    name: document.getElementById('inp-name').value, 
                    note: document.getElementById('inp-note').value,
                    date: document.getElementById('inp-date').value, 
                    dueDate: document.getElementById('inp-due').value || null 
                }, d?.id);
            };
        };

        window.openDetail = (d) => {
            const rem = d.amount - (d.totalPaid||0);
            const history = (d.payments||[]).slice().reverse().map((p, idx) => `
                <div class="history-item">
                    <div class="history-info">
                        <span class="history-date">${formatDateTime(p.date)}</span>
                        <div class="history-amount">${formatMoney(p.amount, d.currency)}</div>
                        ${p.note ? `<span class="history-note">"${p.note}"</span>` : ''}
                    </div>
                    <button class="btn-delete-history" onclick="deletePayment('${d.id}', ${d.payments.length - 1 - idx})"><i class="fas fa-times"></i></button>
                </div>
            `).join('') || '<div class="text-xs" style="text-align:center; padding:10px">Chưa có thanh toán</div>';

            openModal(`
                <div style="text-align:center; margin-bottom:20px">
                    <div class="text-sm">Còn lại</div>
                    <div style="font-size:2.5rem; font-weight:700; color:${rem>0?(d.type==='thu'?'var(--success)':'var(--danger)'):'var(--text-placeholder)'}">${rem > 0 ? formatMoney(rem, d.currency) : 'Hoàn tất'}</div>
                    <div class="text-xs">Tổng gốc: ${formatMoney(d.amount, d.currency)}</div>
                    ${d.note ? `<div style="margin-top:8px; font-style:italic; color:var(--text-main); font-size:0.9rem">"${d.note}"</div>` : ''}
                </div>
                <h4 style="margin-bottom:10px; font-size:0.9rem; text-transform:uppercase; color:var(--text-sub); font-weight:600">Lịch sử thanh toán</h4>
                <div class="history-list">${history}</div>
                
                <div class="action-bar">
                    <button class="action-btn-icon btn-icon-soft danger" onclick="closeModal(); deleteData('${d.id}')"><i class="fas fa-trash"></i></button>
                    <button class="action-btn-sub btn-secondary" onclick="closeModal(); openAddEdit(debts.find(x=>x.id=='${d.id}'))">Sửa</button>
                    ${rem>0 ? `<button class="action-btn-main btn-primary" onclick="closeModal(); openPay('${d.id}', '${d.currency}', ${rem})">Thanh toán</button>` : ''}
                </div>
            `);
        };

        window.openPay = (id, curr, max) => {
            openModal(`
                <h3>Thêm thanh toán</h3>
                <form id="pay-form" style="margin-top:20px">
                    <div class="input-group">
                        <label class="input-label">Số tiền trả</label>
                        <input type="text" id="p-amt" class="input-box input-money" placeholder="0" inputmode="numeric" required>
                    </div>
                    <div class="input-group">
                        <label class="input-label">Ghi chú giao dịch (Bắt buộc)</label>
                        <input type="text" id="p-note" class="input-box" placeholder="Ví dụ: Chuyển khoản, Tiền mặt..." required>
                    </div>
                    <p class="text-xs" style="text-align:center; margin-bottom:20px">Còn nợ: ${formatMoney(max, curr)}</p>
                    <button type="submit" class="btn-primary">Xác nhận</button>
                </form>
            `);
            const amt = document.getElementById('p-amt'); amt.oninput = () => amt.value = formatNumber(amt.value);
            document.getElementById('pay-form').onsubmit = (e) => {
                e.preventDefault(); const val = getRaw(amt.value);
                if(val <= 0 || val > max) return showToast("Số tiền không hợp lệ");
                addPayment(id, val, document.getElementById('p-note').value);
            };
        };

        window.openSettings = () => { renderSettingsMenu(); };
        const renderSettingsMenu = () => {
            const userText = currentUser ? currentUser.email : "Offline User";
            const themeLabel = themeMode === 'system' ? 'Hệ thống' : (themeMode === 'dark' ? 'Tối' : 'Sáng');
            const themeIcon = themeMode === 'system' ? 'fa-adjust' : (themeMode === 'dark' ? 'fa-moon' : 'fa-sun');
            const html = `
                <div style="text-align:center; margin-bottom:30px"><div style="width:60px; height:60px; background:var(--bg-input); border-radius:50%; margin:0 auto 10px; display:grid; place-items:center; font-size:1.5rem"><i class="fas fa-user-circle"></i></div><h3>${userText}</h3><div class="text-xs">${storageMode === 'local' ? 'Dữ liệu trên máy' : 'Đã đồng bộ Cloud'}</div></div>
                <button class="menu-btn" onclick="cycleTheme()"><i class="fas ${themeIcon}"></i> Giao diện: ${themeLabel}</button>
                <button class="menu-btn" onclick="toggleJPY()"><i class="fas fa-yen-sign"></i> Đổi hiển thị JPY (¥/万)</button>
                <button class="menu-btn" onclick="exportData()"><i class="fas fa-file-export"></i> Xuất dữ liệu (Backup)</button>
                <button class="menu-btn" onclick="document.getElementById('file-input').click()"><i class="fas fa-file-import"></i> Nhập dữ liệu (Restore)</button>
                <button class="menu-btn" style="color:var(--danger)" onclick="handleSecureLogout()"><i class="fas fa-sign-out-alt"></i> ${storageMode==='local'?'Xóa dữ liệu & Thoát':'Đăng xuất an toàn'}</button>
            `;
            const existing = document.querySelector('.bottom-sheet');
            if(existing) existing.innerHTML = `<div class="sheet-handle"></div>` + html; else openModal(html);
        };

        window.selectSwitch = (el, type, val) => { el.parentNode.querySelectorAll('.switch-opt').forEach(x => x.classList.remove('active')); el.classList.add('active'); document.getElementById('inp-'+type).value = val; };
        window.toggleJPY = () => { jpyMode = jpyMode === 'man' ? 'yen' : 'man'; localStorage.setItem('jpy', jpyMode); render(); showToast("Đã đổi kiểu hiển thị tiền tệ"); };
        window.exportData = () => { const str = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(debts)); const a = document.createElement('a'); a.href = str; a.download = "zen_debt_backup.json"; a.click(); };

        document.addEventListener('DOMContentLoaded', () => {
            if(!firebase.apps.length) firebase.initializeApp(firebaseConfig);
            auth = firebase.auth(); db = firebase.firestore();
            applyTheme();
            auth.onAuthStateChanged(u => {
                currentUser = u;
                if(u) { localStorage.setItem('mode', 'auth'); storageMode='auth'; initData(); }
                else if(storageMode === 'local') { initData(); }
                else { showApp(false); toggleLoader(false); }
            });
            const handleAuth = async (e, type) => {
                e.preventDefault(); toggleLoader(true);
                const email = e.target.querySelector('input[type="email"]').value;
                const pass = e.target.querySelector('input[type="password"]')?.value;
                try {
                    if(type === 'login') await auth.signInWithEmailAndPassword(email, pass);
                    else if(type === 'register') await auth.createUserWithEmailAndPassword(email, pass);
                    else if(type === 'reset') { await auth.sendPasswordResetEmail(email); showToast("Đã gửi link!"); toggleForgot(false); }
                } catch(err) { showToast("Lỗi: " + err.message); }
                toggleLoader(false);
            };
            document.getElementById('login-form').onsubmit = (e) => handleAuth(e, 'login');
            document.getElementById('register-form').onsubmit = (e) => handleAuth(e, 'register');
            document.getElementById('forgot-form').onsubmit = (e) => handleAuth(e, 'reset');
            el.fileIn.onchange = (e) => {
                const f = e.target.files[0]; if(!f) return;
                const r = new FileReader();
                r.onload = async (ev) => {
                    try {
                        const json = JSON.parse(ev.target.result);
                        if(Array.isArray(json)) { for(const d of json) await saveData(d); showToast("Nhập thành công!"); }
                    } catch(err) { showToast("File lỗi!"); }
                }; r.readAsText(f);
            };
            document.getElementById('search-inp').oninput = render;
        });
    </script>
</body>
</html>