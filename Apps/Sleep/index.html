<!DOCTYPE html>
<html lang="vi">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Zen Minimal - Sleep Smart</title>

    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@200;300;400;500;600&display=swap" rel="stylesheet">

    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #09090b;
            /* Zinc 950 */
            color: #e4e4e7;
            /* Zinc 200 */
            -webkit-tap-highlight-color: transparent;
        }

        /* Minimal Slider */
        input[type=range] {
            -webkit-appearance: none;
            background: transparent;
            height: 2px;
            width: 100%;
            cursor: pointer;
        }

        input[type=range]::-webkit-slider-thumb {
            -webkit-appearance: none;
            height: 12px;
            width: 12px;
            border-radius: 50%;
            background: #fff;
            margin-top: -5px;
            transition: transform 0.1s;
        }

        input[type=range]::-webkit-slider-thumb:active {
            transform: scale(1.2);
        }

        input[type=range]::-webkit-slider-runnable-track {
            width: 100%;
            height: 2px;
            background: #3f3f46;
        }

        /* Minimal Time Input Override */
        input[type="time"]::-webkit-calendar-picker-indicator {
            filter: invert(1);
            cursor: pointer;
            opacity: 0.6;
        }

        input[type="time"] {
            font-family: 'Inter', sans-serif;
            color-scheme: dark;
        }

        /* Utilities */
        .hide-scrollbar::-webkit-scrollbar {
            display: none;
        }

        .active-sound {
            background-color: #ffffff !important;
            color: #000000 !important;
        }

        .tab-active {
            background-color: #27272a;
            color: white;
            border-color: #52525b;
        }

        .tab-inactive {
            color: #71717a;
            border-color: transparent;
        }

        /* Animation cho chế độ thở */
        @keyframes breathe-anim {

            0%,
            100% {
                transform: scale(1);
                opacity: 0.3;
                border-color: #52525b;
            }

            /* Thở ra / Nghỉ */
            50% {
                transform: scale(1.5);
                opacity: 1;
                border-color: #fff;
            }

            /* Hít vào */
        }

        .breathing-active {
            animation: breathe-anim 10s infinite ease-in-out;
            /* Chu kỳ 10s: 5s hít, 5s thở */
        }

        /* Trạng thái Hít vào (Vòng tròn to ra) */
        .breath-in {
            transform: scale(1.5) !important;
            border-color: #fff !important;
            box-shadow: 0 0 50px rgba(255, 255, 255, 0.3) !important;
        }

        /* Trạng thái Thở ra (Vòng tròn thu nhỏ - Mặc định là scale-50) */
    </style>
</head>

<body class="min-h-screen flex flex-col justify-between p-6 md:p-12 relative overflow-hidden">

    <header class="flex justify-between items-start z-20">
        <div>
            <div id="dateDisplay" class="text-xs font-medium tracking-[0.2em] text-zinc-500 uppercase mb-1">...</div>
            <div id="weatherDisplay" class="text-xs text-zinc-600 flex items-center gap-2">
                <i data-lucide="loader" class="w-3 h-3 animate-spin"></i> Đang tải...
            </div>
        </div>
        <button onclick="toggleMenu()" class="p-2 -mr-2 text-zinc-400 hover:text-white transition-colors">
            <i data-lucide="menu" class="w-5 h-5"></i>
        </button>
    </header>

    <main class="flex-grow flex flex-col items-center justify-center z-10 py-10 relative">
        <div id="mainClock"
            class="text-[12vh] md:text-[20vh] font-extralight leading-none tracking-tighter select-none transition-all duration-500">
            00:00
        </div>

        <div id="focusLabel"
            class="hidden text-xs font-bold tracking-[0.3em] uppercase mt-4 text-zinc-500 animate-pulse">ĐANG TẬP TRUNG
        </div>

        <button id="btn-stop-main" onclick="stopFocus()"
            class="hidden mt-8 px-8 py-2 border border-red-900/50 text-red-400 hover:bg-red-900/10 rounded-full text-xs tracking-widest transition-all duration-500 opacity-0 transform translate-y-4">
            DỪNG LẠI
        </button>

        <div id="quoteDisplay"
            class="mt-8 text-sm font-light text-zinc-500 text-center max-w-md italic opacity-0 transition-opacity duration-1000">
        </div>
    </main>

    <div id="bottomPanel" class="z-20 transition-all duration-500">
        <div class="flex items-center justify-between mb-4">
            <h2 class="text-xs font-bold tracking-widest text-zinc-600 uppercase">Âm thanh</h2>
            <button onclick="stopAllSounds()"
                class="text-[10px] text-zinc-600 hover:text-red-400 transition-colors uppercase tracking-wide">Dừng tất
                cả</button>
        </div>

        <div class="flex gap-4 overflow-x-auto hide-scrollbar pb-4 snap-x" id="soundGrid"></div>

        <div id="activeControls" class="h-0 overflow-hidden transition-all duration-300 opacity-0">
            <div class="bg-zinc-900 rounded-2xl p-4 mt-2 flex items-center gap-4 border border-zinc-800">
                <span id="controlName" class="text-xs font-medium w-20 truncate">Sound</span>
                <input type="range" id="globalVolumeControl" min="0" max="1" step="0.05" class="flex-1">
            </div>
        </div>
    </div>

    <div id="menuOverlay"
        class="fixed inset-0 bg-black z-50 transform translate-y-full transition-transform duration-500 flex flex-col">
        <div class="p-6 md:p-12 flex justify-between items-center">
            <h2 class="text-xl font-light tracking-tight">Công Cụ</h2>
            <button onclick="toggleMenu()" class="p-2 text-zinc-400 hover:text-white"><i data-lucide="x"
                    class="w-6 h-6"></i></button>
        </div>

        <div class="flex-1 overflow-y-auto px-6 md:px-12 pb-12 space-y-12">

            <section>
                <h3 class="text-xs font-bold text-zinc-600 uppercase tracking-widest mb-4">Máy Tính Giấc Ngủ</h3>
                <div class="bg-zinc-900 border border-zinc-800 rounded-xl p-1 overflow-hidden">
                    <div class="grid grid-cols-3 text-xs font-medium mb-4 bg-zinc-950/50 rounded-lg p-1 gap-1">
                        <button onclick="switchSleepTab('bedtime')" id="tab-bedtime"
                            class="py-2 rounded transition-all tab-active">Giờ đi ngủ</button>
                        <button onclick="switchSleepTab('waketime')" id="tab-waketime"
                            class="py-2 rounded transition-all tab-inactive">Giờ thức dậy</button>
                        <button onclick="switchSleepTab('duration')" id="tab-duration"
                            class="py-2 rounded transition-all tab-inactive">Khoảng cách</button>
                    </div>

                    <div class="px-4 pb-4">
                        <div id="view-bedtime" class="space-y-4">
                            <p class="text-[10px] text-zinc-500 uppercase tracking-wider">Nếu tôi đi ngủ lúc:</p>
                            <div
                                class="flex items-center rounded-lg border border-zinc-700 bg-black overflow-hidden focus-within:border-zinc-500 transition-colors">
                                <input type="time" id="input-bedtime"
                                    class="flex-1 bg-transparent text-white p-3 text-center outline-none border-none">
                                <button onclick="setCurrentTime('input-bedtime')"
                                    class="self-stretch px-3 bg-zinc-900 hover:bg-zinc-800 text-zinc-400 border-l border-zinc-700 transition-colors flex items-center justify-center">
                                    <i data-lucide="clock" class="w-4 h-4"></i>
                                </button>
                            </div>
                            <button onclick="calcSmartSleep('bedtime')"
                                class="w-full bg-white text-black py-3 rounded-lg text-sm font-semibold hover:bg-zinc-200">Tìm
                                giờ thức dậy tốt nhất</button>
                        </div>

                        <div id="view-waketime" class="space-y-4 hidden">
                            <p class="text-[10px] text-zinc-500 uppercase tracking-wider">Nếu tôi muốn dậy lúc:</p>
                            <input type="time" id="input-waketime"
                                class="w-full bg-black border border-zinc-700 text-white rounded-lg p-3 text-center outline-none focus:border-zinc-500 transition-colors">
                            <button onclick="calcSmartSleep('waketime')"
                                class="w-full bg-white text-black py-3 rounded-lg text-sm font-semibold hover:bg-zinc-200">Tìm
                                giờ đi ngủ</button>
                        </div>

                        <div id="view-duration" class="space-y-4 hidden">
                            <div class="grid grid-cols-2 gap-4">

                                <div>
                                    <label class="text-[10px] text-zinc-500 block mb-1">Bắt đầu</label>
                                    <div
                                        class="flex items-center rounded-lg border border-zinc-700 bg-black overflow-hidden focus-within:border-zinc-500 transition-colors">
                                        <input type="time" id="diff-start"
                                            class="flex-1 bg-transparent text-white p-2 text-sm text-center outline-none border-none">
                                        <button onclick="setCurrentTime('diff-start')"
                                            class="self-stretch px-3 bg-zinc-900 hover:bg-zinc-800 text-zinc-400 border-l border-zinc-700 transition-colors flex items-center justify-center">
                                            <i data-lucide="clock" class="w-3 h-3"></i>
                                        </button>
                                    </div>
                                </div>

                                <div>
                                    <label class="text-[10px] text-zinc-500 block mb-1">Kết thúc</label>
                                    <div
                                        class="flex items-center rounded-lg border border-zinc-700 bg-black overflow-hidden focus-within:border-zinc-500 transition-colors">
                                        <input type="time" id="diff-end"
                                            class="flex-1 bg-transparent text-white p-2 text-sm text-center outline-none border-none">
                                        <button onclick="setCurrentTime('diff-end')"
                                            class="self-stretch px-3 bg-zinc-900 hover:bg-zinc-800 text-zinc-400 border-l border-zinc-700 transition-colors flex items-center justify-center">
                                            <i data-lucide="clock" class="w-3 h-3"></i>
                                        </button>
                                    </div>
                                </div>

                            </div>
                            <button onclick="calcDuration()"
                                class="w-full bg-zinc-800 text-white py-3 rounded-lg text-sm font-medium hover:bg-zinc-700">Tính
                                thời gian</button>
                        </div>
                    </div>

                    <div id="sleepResultContainer" class="hidden border-t border-zinc-800 p-4 bg-zinc-950/30">
                        <div id="sleepResultContent" class="grid grid-cols-2 gap-2"></div>
                        <div id="durationResult" class="text-center text-lg font-light text-white hidden"></div>
                        <p class="text-[10px] text-zinc-600 text-center mt-3 italic">*Đã bao gồm 14 phút để chìm vào
                            giấc ngủ (chỉ áp dụng với giờ đi ngủ & giờ thức dậy ).</p>
                    </div>
                </div>
            </section>

            <section>
                <h3 class="text-xs font-bold text-zinc-600 uppercase tracking-widest mb-4">Kể Chuyện Đêm Khuya</h3>
                <div class="flex items-center justify-between bg-zinc-900 border border-zinc-800 rounded-xl p-4">
                    <span class="text-sm text-zinc-300">Chuyến Tàu Đêm (ASMR)</span>
                    <button onclick="toggleStory()" id="storyBtn"
                        class="w-10 h-10 rounded-full bg-zinc-800 flex items-center justify-center hover:bg-white hover:text-black transition-all">
                        <i data-lucide="play" class="w-4 h-4"></i>
                    </button>
                </div>
            </section>



            <section>
                <h3 class="text-xs font-bold text-zinc-600 uppercase tracking-widest mb-4">Thư Giãn & Nhịp Thở</h3>
                <div class="bg-zinc-900 border border-zinc-800 rounded-xl p-6 text-center">
                    <p class="text-sm font-light text-zinc-400 mb-4">Chọn thời gian để bắt đầu thư giãn</p>
                    <div class="flex gap-3 justify-center">
                        <button onclick="startBreathing(15)"
                            class="px-4 py-2 rounded-lg bg-zinc-800 hover:bg-white hover:text-black text-white text-xs font-medium transition-all">15
                            giây</button>
                        <button onclick="startBreathing(30)"
                            class="px-4 py-2 rounded-lg bg-zinc-800 hover:bg-white hover:text-black text-white text-xs font-medium transition-all">30
                            giây</button>
                        <button onclick="startBreathing(60)"
                            class="px-4 py-2 rounded-lg bg-zinc-800 hover:bg-white hover:text-black text-white text-xs font-medium transition-all">1
                            phút</button>
                    </div>
                </div>
            </section>

            <section>
                <h3 class="text-xs font-bold text-zinc-600 uppercase tracking-widest mb-4">Tập Trung (Pomodoro)</h3>

                <div
                    class="flex items-center rounded-lg border border-zinc-700 bg-black overflow-hidden focus-within:border-zinc-500 transition-colors mb-3">
                    <input type="number" id="customFocusInput" placeholder="Nhập số phút (VD: 25)"
                        class="flex-1 bg-transparent text-white p-3 text-sm outline-none border-none text-center appearance-none m-0">
                    <button onclick="startFocusCustom()"
                        class="self-stretch px-6 bg-zinc-900 hover:bg-zinc-800 text-zinc-300 border-l border-zinc-700 transition-colors text-xs font-bold tracking-wider">
                        BẮT ĐẦU
                    </button>
                </div>

                <div class="flex gap-2 justify-center">
                    <button onclick="setInputAndStart(15)"
                        class="px-3 py-1 rounded bg-zinc-900 text-[10px] text-zinc-500 hover:text-white hover:bg-zinc-800 transition-colors">15p</button>
                    <button onclick="setInputAndStart(25)"
                        class="px-3 py-1 rounded bg-zinc-900 text-[10px] text-zinc-500 hover:text-white hover:bg-zinc-800 transition-colors">25p</button>
                    <button onclick="setInputAndStart(45)"
                        class="px-3 py-1 rounded bg-zinc-900 text-[10px] text-zinc-500 hover:text-white hover:bg-zinc-800 transition-colors">45p</button>
                    <button onclick="setInputAndStart(60)"
                        class="px-3 py-1 rounded bg-zinc-900 text-[10px] text-zinc-500 hover:text-white hover:bg-zinc-800 transition-colors">60p</button>
                </div>
            </section>

            <section>
                <h3 class="text-xs font-bold text-zinc-600 uppercase tracking-widest mb-4">Vị trí & Thời tiết</h3>
                <div class="flex flex-col gap-2">
                    <label class="text-[10px] text-zinc-500">Nhập tên thành phố (hoặc để trống để dùng GPS)</label>
                    <div
                        class="flex items-center rounded-lg border border-zinc-700 bg-black overflow-hidden focus-within:border-zinc-500 transition-colors">
                        <input type="text" id="manualLocation" placeholder="VD: Hanoi, Ho Chi Minh..."
                            class="flex-1 bg-transparent text-white p-3 text-sm outline-none border-none">
                        <button onclick="saveLocation()"
                            class="self-stretch px-4 bg-zinc-900 hover:bg-zinc-800 text-zinc-400 border-l border-zinc-700 transition-colors font-medium text-xs">
                            LƯU
                        </button>
                    </div>
                    <div class="flex justify-between items-center mt-1">
                        <button onclick="useGPS()"
                            class="text-[10px] text-blue-400 hover:text-blue-300 flex items-center gap-1">
                            <i data-lucide="map-pin" class="w-3 h-3"></i> Dùng định vị GPS
                        </button>
                        <span id="locStatus" class="text-[10px] text-zinc-500 italic"></span>
                    </div>

                </div>
            </section>


        </div>
    </div>


    <div id="breathingOverlay"
        class="fixed inset-0 z-[60] bg-black flex flex-col items-center justify-center opacity-0 pointer-events-none transition-opacity duration-700">

        <div id="breathCircleContainer" class="relative flex items-center justify-center transition-all duration-500">
            <div id="breathGhost" class="absolute w-64 h-64 rounded-full border border-zinc-700 opacity-30 scale-50">
            </div>
            <div id="breathCircleMain"
                class="w-64 h-64 rounded-full border-2 border-zinc-500 shadow-[0_0_30px_rgba(255,255,255,0.1)] scale-50 transition-all duration-[5000ms] ease-in-out">
            </div>

            <div class="absolute text-center">
                <div id="breathInstruct"
                    class="text-2xl font-light text-white tracking-widest uppercase transition-opacity duration-500">
                    Chuẩn bị...</div>
            </div>
        </div>

        <div id="breathResult" class="hidden text-center transform transition-all duration-700">
            <div class="text-4xl md:text-6xl font-thin text-white mb-4 tracking-tighter">Tốt lắm</div>
            <p class="text-zinc-500 text-sm tracking-widest uppercase">Bạn đã hoàn thành thư giãn</p>
        </div>

        <div id="breathTimerDisplay"
            class="mt-16 text-zinc-500 font-mono text-xl tracking-widest transition-opacity duration-500">00:00</div>

        <button id="btnCloseBreath" onclick="closeBreathingOverlay()"
            class="mt-8 px-8 py-3 border border-zinc-800 text-zinc-500 hover:text-white hover:border-zinc-500 rounded-full text-xs uppercase tracking-widest transition-all">
            THOÁT
        </button>
    </div>

    <script>
        /* --- CORE DATA --- */
        const sounds = [
            { id: 'rain', name: 'Mưa', icon: 'cloud-rain' },
            { id: 'thunder', name: 'Sấm', icon: 'zap' },
            { id: 'wind', name: 'Gió', icon: 'wind' },
            { id: 'fire', name: 'Lửa', icon: 'flame' },
            { id: 'night', name: 'Đêm', icon: 'moon' },
            { id: 'waves', name: 'Sóng', icon: 'waves' },
            { id: 'fan', name: 'Quạt', icon: 'fan' }
        ];

        const soundManager = {};
        let activeSoundId = null;

        /* --- INITIALIZATION --- */
        document.addEventListener('DOMContentLoaded', () => {
            renderSounds();
            updateClock();
            setInterval(updateClock, 1000);

            // --- THAY ĐỔI Ở ĐÂY ---
            initWeather(); // Gọi hàm khởi tạo thông minh mới
            // ---------------------

            // Set giờ mặc định cho các input
            const nowStr = new Date().toTimeString().substring(0, 5);
            if (document.getElementById('input-bedtime')) document.getElementById('input-bedtime').value = nowStr;
            if (document.getElementById('diff-start')) document.getElementById('diff-start').value = nowStr;
            if (document.getElementById('input-waketime')) document.getElementById('input-waketime').value = "06:30";

            setTimeout(() => {
                const q = document.getElementById('quoteDisplay');
                if (q) {
                    q.innerText = '"Tâm tĩnh lặng, đời an nhiên."';
                    q.classList.remove('opacity-0');
                }
            }, 500);
            lucide.createIcons();
        });

        /* --- SOUND ENGINE --- */
        class SoundNode {
            constructor(id) {
                this.id = id;
                this.audio = new Audio(`./Sounds/${id}.mp3`); // Ensure files exist
                this.audio.loop = true;
                this.audio.volume = 0.5;
                this.isPlaying = false;
                this.audio.onerror = () => console.log(`Audio ${id} missing (Demo mode)`);
            }
            toggle() {
                if (this.isPlaying) { this.audio.pause(); this.isPlaying = false; }
                else { this.audio.play().catch(e => { }); this.isPlaying = true; }
                updateSoundUI(this.id);
            }
            stop() { this.audio.pause(); this.audio.currentTime = 0; this.isPlaying = false; updateSoundUI(this.id); }
            setVolume(v) { this.audio.volume = v; }
        }

        function renderSounds() {
            const grid = document.getElementById('soundGrid');
            sounds.forEach(s => {
                soundManager[s.id] = new SoundNode(s.id);
                grid.innerHTML += `
                    <button id="btn-${s.id}" onclick="clickSound('${s.id}')" 
                        class="flex flex-col items-center justify-center min-w-[70px] h-[70px] bg-zinc-900 border border-zinc-800 rounded-2xl transition-all duration-300 hover:border-zinc-600 snap-center group">
                        <i data-lucide="${s.icon}" class="w-5 h-5 text-zinc-500 mb-1 transition-colors group-hover:text-zinc-300"></i>
                        <span class="text-[10px] font-medium text-zinc-600 transition-colors group-hover:text-zinc-400">${s.name}</span>
                    </button>
                `;
            });
        }

        function clickSound(id) {
            const sound = soundManager[id];
            sound.toggle();
            if (sound.isPlaying) { activeSoundId = id; showVolumeControl(id); }
            else {
                if (activeSoundId === id) {
                    const other = Object.values(soundManager).find(s => s.isPlaying);
                    if (other) showVolumeControl(other.id); else hideVolumeControl();
                }
            }
        }

        function updateSoundUI(id) {
            const btn = document.getElementById(`btn-${id}`);
            const node = soundManager[id];
            if (node.isPlaying) {
                btn.classList.add('active-sound', 'scale-105');
                btn.classList.remove('bg-zinc-900', 'border-zinc-800');
            } else {
                btn.classList.remove('active-sound', 'scale-105');
                btn.classList.add('bg-zinc-900', 'border-zinc-800');
            }
            lucide.createIcons();
        }

        function showVolumeControl(id) {
            const panel = document.getElementById('activeControls');
            document.getElementById('controlName').innerText = sounds.find(s => s.id === id).name;
            const slider = document.getElementById('globalVolumeControl');
            slider.value = soundManager[id].audio.volume;
            slider.oninput = (e) => soundManager[id].setVolume(e.target.value);
            panel.classList.remove('opacity-0'); panel.style.height = '70px';
        }

        function hideVolumeControl() {
            const panel = document.getElementById('activeControls');
            panel.classList.add('opacity-0'); panel.style.height = '0';
        }
        function stopAllSounds() { Object.values(soundManager).forEach(s => s.stop()); hideVolumeControl(); }

        /* --- CLOCK & DATE --- */
        function updateClock() {
            if (focusActive) updateFocusTimer();
            else {
                const now = new Date();
                document.getElementById('mainClock').innerText = now.toLocaleTimeString('vi-VN', { hour: '2-digit', minute: '2-digit' });
                document.getElementById('dateDisplay').innerText = now.toLocaleDateString('vi-VN', { weekday: 'long', month: 'long', day: 'numeric' });
            }
        }

        // Hàm tính toán và hiển thị thời gian đếm ngược
function updateFocusTimer() {
    const diff = focusEnd - Date.now();
    
    // Nếu hết giờ
    if(diff <= 0) {
        stopFocus();
        // Phát âm thanh thông báo (nếu muốn)
        const bell = document.getElementById('bellSound');
        if(bell) { bell.currentTime=0; bell.play().catch(e=>{}); }
        return;
    }

    // Tính phút và giây
    const m = Math.floor(diff / 60000);
    const s = Math.floor((diff % 60000) / 1000);
    
    // Cập nhật lên đồng hồ chính
    document.getElementById('mainClock').innerText = `${m}:${s.toString().padStart(2,'0')}`;
}

        function fetchWeather() {
            // Demo static weather
            document.getElementById('weatherDisplay').innerHTML = '<i data-lucide="cloud" class="w-3 h-3"></i> 24°C • Hà Nội'; lucide.createIcons();
        }

        /* --- FOCUS MODE --- */
        /* --- FOCUS MODE (CUSTOM & MAIN BUTTON) --- */
        let focusActive = false, focusEnd = 0, focusInterval = null;

        // Hàm hỗ trợ chọn nhanh
        function setInputAndStart(val) {
            document.getElementById('customFocusInput').value = val;
            startFocus(val);
        }

        // Hàm lấy giá trị từ ô input
        function startFocusCustom() {
            const val = document.getElementById('customFocusInput').value;
            if (val && val > 0) {
                startFocus(val);
            } else {
                alert("Vui lòng nhập số phút hợp lệ!");
            }
        }

        function startFocus(mins) {
            if (focusInterval) clearInterval(focusInterval);
            focusEnd = Date.now() + mins * 60000;
            focusActive = true;

            // 1. Đóng menu
            const menu = document.getElementById('menuOverlay');
            if (!menu.classList.contains('translate-y-full')) toggleMenu();

            // 2. Ẩn các thành phần thừa
            document.getElementById('quoteDisplay').classList.add('opacity-0'); // Ẩn trích dẫn cho đỡ rối
            document.getElementById('bottomPanel').style.opacity = '0.1';
            document.getElementById('bottomPanel').style.pointerEvents = 'none';

            // 3. Hiện nhãn và nút Dừng (với hiệu ứng)
            document.getElementById('focusLabel').classList.remove('hidden');

            const btnMain = document.getElementById('btn-stop-main');
            btnMain.classList.remove('hidden');
            // Timeout nhỏ để kích hoạt transition CSS (fade in + slide up)
            setTimeout(() => {
                btnMain.classList.remove('opacity-0', 'translate-y-4');
            }, 50);

            updateClock();
        }

        function stopFocus() {
            focusActive = false;
            if (focusInterval) clearInterval(focusInterval);

            // 1. Ẩn nhãn và nút dừng
            document.getElementById('focusLabel').classList.add('hidden');

            const btnMain = document.getElementById('btn-stop-main');
            btnMain.classList.add('opacity-0', 'translate-y-4'); // Fade out trước
            setTimeout(() => {
                btnMain.classList.add('hidden'); // Ẩn hẳn sau khi animation xong
            }, 500);

            // 2. Hiện lại giao diện cũ
            document.getElementById('quoteDisplay').classList.remove('opacity-0');
            document.getElementById('bottomPanel').style.opacity = '1';
            document.getElementById('bottomPanel').style.pointerEvents = 'auto';

            updateClock();
        }

        /* --- BREATHING EXERCISE --- */
        /* --- BREATHING MODE (FULL SCREEN & END SCREEN) --- */
        let breathTimerInterval = null;
        let breathCycleInterval = null;
        let breathTimeLeft = 0;
        let isBreathFinished = false; // Biến cờ để kiểm soát trạng thái kết thúc

        function startBreathing(seconds) {
            // Reset trạng thái
            isBreathFinished = false;
            document.getElementById('breathResult').classList.add('hidden'); // Ẩn lời khen
            document.getElementById('breathTimerDisplay').classList.remove('hidden'); // Hiện đồng hồ
            document.getElementById('breathCircleContainer').classList.remove('hidden'); // Hiện vòng tròn
            document.getElementById('btnCloseBreath').innerText = "THOÁT"; // Nút thoát thường

            // 1. Đóng menu & Hiện overlay
            toggleMenu();
            const overlay = document.getElementById('breathingOverlay');
            overlay.classList.remove('opacity-0', 'pointer-events-none');

            // 2. Thiết lập thời gian
            breathTimeLeft = seconds;
            updateBreathTimerDisplay();

            // 3. Bắt đầu đếm ngược
            if (breathTimerInterval) clearInterval(breathTimerInterval);
            breathTimerInterval = setInterval(() => {
                breathTimeLeft--;
                updateBreathTimerDisplay();

                if (breathTimeLeft <= 0) {
                    finishBreathing(); // Chuyển sang hàm kết thúc thay vì stop ngay
                }
            }, 1000);

            // 4. Bắt đầu chu kỳ thở
            const text = document.getElementById('breathInstruct');
            text.innerText = "Hít vào...";

            setTimeout(() => { runBreathCycle(); }, 100);

            if (breathCycleInterval) clearInterval(breathCycleInterval);
            breathCycleInterval = setInterval(() => {
                runBreathCycle();
            }, 10000);
        }

        function runBreathCycle() {
            if (isBreathFinished) return; // Nếu đã xong thì không chạy nữa

            const circle = document.getElementById('breathCircleMain');
            const text = document.getElementById('breathInstruct');

            // HÍT VÀO
            circle.classList.add('breath-in');
            text.innerText = "Hít vào...";
            text.style.opacity = "1";

            // THỞ RA (Sau 5 giây)
            setTimeout(() => {
                if (!isBreathFinished) {
                    circle.classList.remove('breath-in');
                    text.innerText = "Thở ra...";
                    text.style.opacity = "0.7";
                }
            }, 5000);
        }

        // Hàm xử lý khi hết giờ (Màn hình Tốt lắm)
        function finishBreathing() {
            isBreathFinished = true;
            clearInterval(breathTimerInterval);
            clearInterval(breathCycleInterval);

            // Ẩn vòng tròn và đồng hồ
            document.getElementById('breathCircleContainer').classList.add('hidden');
            document.getElementById('breathTimerDisplay').classList.add('hidden');

            // Hiện lời khen
            const result = document.getElementById('breathResult');
            result.classList.remove('hidden');
            result.classList.add('fade-enter'); // Thêm hiệu ứng hiện dần

            // Đổi nút thoát thành Đóng ngay
            document.getElementById('btnCloseBreath').innerText = "ĐÓNG";

            // Tự động tắt sau 5 giây
            setTimeout(() => {
                // Chỉ tắt nếu người dùng vẫn đang ở màn hình này (chưa bấm đóng thủ công)
                const overlay = document.getElementById('breathingOverlay');
                if (!overlay.classList.contains('opacity-0')) {
                    closeBreathingOverlay();
                }
            }, 5000);
        }

        // Hàm đóng hẳn Overlay (Reset về ban đầu)
        function closeBreathingOverlay() {
            clearInterval(breathTimerInterval);
            clearInterval(breathCycleInterval);

            const overlay = document.getElementById('breathingOverlay');
            overlay.classList.add('opacity-0', 'pointer-events-none');

            // Reset giao diện về trạng thái chờ
            setTimeout(() => {
                document.getElementById('breathCircleMain').classList.remove('breath-in');
                document.getElementById('breathInstruct').innerText = "Chuẩn bị...";
                document.getElementById('breathResult').classList.add('hidden');
                document.getElementById('breathCircleContainer').classList.remove('hidden');
            }, 500);
        }

        function updateBreathTimerDisplay() {
            if (breathTimeLeft < 0) breathTimeLeft = 0;
            const m = Math.floor(breathTimeLeft / 60);
            const s = breathTimeLeft % 60;
            document.getElementById('breathTimerDisplay').innerText =
                `${m.toString().padStart(2, '0')}:${s.toString().padStart(2, '0')}`;
        }

        /* --- WEATHER & LOCATION ENGINE --- */
        /* --- HỆ THỐNG VỊ TRÍ & THỜI TIẾT (V3 - LƯU TỌA ĐỘ) --- */

        // 1. Khởi tạo: Ưu tiên dùng Tọa độ đã lưu
        function initWeather() {
            const savedName = localStorage.getItem('zenLocation');
            const savedLat = localStorage.getItem('zenLat');
            const savedLon = localStorage.getItem('zenLon');

            // Nếu có đủ Tên và Tọa độ -> Dùng luôn, không cần tìm kiếm lại
            if (savedName && savedLat && savedLon) {
                document.getElementById('manualLocation').value = savedName;
                document.getElementById('locStatus').innerText = "Đã khôi phục vị trí cũ.";
                fetchWeatherAPI(savedLat, savedLon, savedName);
            }
            // Nếu chỉ có tên (dữ liệu cũ) -> Phải tìm kiếm
            else if (savedName) {
                document.getElementById('manualLocation').value = savedName;
                getWeatherByCity(savedName);
            }
            // Chưa có gì -> Dùng GPS
            else {
                useGPS();
            }
        }

        // 2. Nhập tay và Lưu: Tìm tọa độ từ tên rồi lưu lại
        async function saveLocation() {
            const city = document.getElementById('manualLocation').value.trim();
            if (!city) return;

            document.getElementById('locStatus').innerText = "Đang tìm kiếm...";
            document.getElementById('locStatus').className = "text-[10px] text-blue-400 italic";

            await getWeatherByCity(city);
        }

        // 3. Tìm kiếm thành phố (Dùng cho nhập tay)
        async function getWeatherByCity(city) {
            try {
                // Tìm tọa độ từ tên thành phố
                const geoRes = await fetch(`https://geocoding-api.open-meteo.com/v1/search?name=${encodeURIComponent(city)}&count=1&language=vi&format=json`);
                const geoData = await geoRes.json();

                if (!geoData.results || geoData.results.length === 0) {
                    document.getElementById('locStatus').innerText = "Không tìm thấy địa điểm này.";
                    document.getElementById('locStatus').className = "text-[10px] text-red-400 italic";
                    return;
                }

                const { latitude, longitude, name, admin1 } = geoData.results[0];
                const displayName = admin1 ? `${name}, ${admin1}` : name;

                // --- LƯU TẤT CẢ VÀO BỘ NHỚ ---
                localStorage.setItem('zenLocation', displayName);
                localStorage.setItem('zenLat', latitude);
                localStorage.setItem('zenLon', longitude);
                // -----------------------------

                document.getElementById('manualLocation').value = displayName;
                document.getElementById('locStatus').innerText = "Đã lưu thiết lập.";
                document.getElementById('locStatus').className = "text-[10px] text-green-400 italic";

                await fetchWeatherAPI(latitude, longitude, displayName);

            } catch (e) {
                console.error(e);
                document.getElementById('locStatus').innerText = "Lỗi kết nối mạng.";
            }
        }

        // 4. Dùng GPS (Cập nhật lưu tọa độ)
        async function useGPS() {
            const status = document.getElementById('locStatus');
            status.innerText = "Đang kết nối vệ tinh...";
            status.className = "text-[10px] text-blue-400 italic";

            if (!navigator.geolocation) {
                status.innerText = "Thiết bị không hỗ trợ GPS.";
                return;
            }

            const options = { enableHighAccuracy: false, timeout: 15000, maximumAge: 300000 };

            navigator.geolocation.getCurrentPosition(
                async (position) => {
                    const lat = position.coords.latitude;
                    const lon = position.coords.longitude;
                    let finalName = `${lat.toFixed(3)}, ${lon.toFixed(3)}`;
                    let isSuccess = false;

                    try {
                        status.innerText = "Đang lấy tên đường...";
                        // Dùng API BigDataCloud (Ổn định hơn Open-Meteo)
                        const res = await fetch(`https://api.bigdatacloud.net/data/reverse-geocode-client?latitude=${lat}&longitude=${lon}&localityLanguage=vi`);

                        if (res.ok) {
                            const data = await res.json();
                            const city = data.city || data.locality || "";
                            const province = data.principalSubdivision || "";

                            if (city) {
                                finalName = city;
                                if (province && !city.includes(province)) finalName += `, ${province}`;
                                isSuccess = true;
                            } else if (province) {
                                finalName = province;
                                isSuccess = true;
                            }
                        }
                    } catch (e) {
                        console.warn("Lỗi lấy tên, dùng tọa độ số.");
                    }

                    // --- LƯU TỌA ĐỘ QUAN TRỌNG ---
                    localStorage.setItem('zenLocation', finalName);
                    localStorage.setItem('zenLat', lat);
                    localStorage.setItem('zenLon', lon);
                    // -----------------------------

                    document.getElementById('manualLocation').value = finalName;

                    if (isSuccess) {
                        status.innerText = "Đã cập nhật vị trí.";
                        status.className = "text-[10px] text-green-400 italic";
                    } else {
                        status.innerText = "Dùng tọa độ GPS.";
                    }

                    await fetchWeatherAPI(lat, lon, finalName);
                },
                (error) => {
                    status.className = "text-[10px] text-red-400 italic";
                    status.innerText = "Lỗi định vị hoặc bị chặn.";
                },
                options
            );
        }

        // Hàm lấy thời tiết (Giữ nguyên logic cũ nhưng đảm bảo gọi đúng)
        async function fetchWeatherAPI(lat, lon, name) {
            try {
                const res = await fetch(`https://api.open-meteo.com/v1/forecast?latitude=${lat}&longitude=${lon}&current_weather=true`);
                const data = await res.json();
                const w = data.current_weather;

                let weatherIcon = 'cloud';
                // Map icon đơn giản
                if (w.weathercode === 0) weatherIcon = 'sun';
                else if (w.weathercode <= 3) weatherIcon = 'cloud-sun';
                else if (w.weathercode <= 67) weatherIcon = 'cloud-rain';
                else if (w.weathercode <= 99) weatherIcon = 'zap';

                document.getElementById('weatherDisplay').innerHTML = `
            <i data-lucide="${weatherIcon}" class="w-3 h-3"></i> 
            ${Math.round(w.temperature)}°C • ${name}
        `;
                lucide.createIcons();
            } catch (e) {
                document.getElementById('weatherDisplay').innerText = "Lỗi thời tiết";
            }
        }

        /* --- SMART SLEEP CALCULATOR LOGIC --- */
        let currentSleepTab = 'bedtime';

        function switchSleepTab(tab) {
            currentSleepTab = tab;
            // Update Tab Styles
            ['bedtime', 'waketime', 'duration'].forEach(t => {
                const el = document.getElementById(`tab-${t}`);
                if (t === tab) { el.classList.replace('tab-inactive', 'tab-active'); el.style.backgroundColor = '#27272a'; }
                else { el.classList.replace('tab-active', 'tab-inactive'); el.style.backgroundColor = 'transparent'; }

                const view = document.getElementById(`view-${t}`);
                if (t === tab) view.classList.remove('hidden'); else view.classList.add('hidden');
            });
            document.getElementById('sleepResultContainer').classList.add('hidden');
        }

        function setCurrentTime(inputId) {
            const now = new Date();
            document.getElementById(inputId).value = `${String(now.getHours()).padStart(2, '0')}:${String(now.getMinutes()).padStart(2, '0')}`;
        }

        function calcSmartSleep(mode) {
            const resultBox = document.getElementById('sleepResultContainer');
            const list = document.getElementById('sleepResultContent');
            const durationTxt = document.getElementById('durationResult');

            resultBox.classList.remove('hidden');
            list.classList.remove('hidden');
            durationTxt.classList.add('hidden');
            list.innerHTML = '';

            let baseTime = new Date();
            const inputId = mode === 'bedtime' ? 'input-bedtime' : 'input-waketime';
            const timeVal = document.getElementById(inputId).value;
            if (!timeVal) return;

            const [h, m] = timeVal.split(':');
            baseTime.setHours(parseInt(h), parseInt(m), 0);

            // Logic: 
            // If 'bedtime': Calculate wake up times. Add 14mins fall asleep + N * 90mins.
            // If 'waketime': Calculate bed times. Subtract N * 90mins - 14mins fall asleep.

            // Cycles to show: 3 (4.5h), 4 (6h), 5 (7.5h), 6 (9h)
            const cycles = mode === 'bedtime' ? [3, 4, 5, 6] : [6, 5, 4, 3];

            cycles.forEach(c => {
                let calculatedTime = new Date(baseTime.getTime());
                let minutesToAdd = (c * 90) + 14;

                if (mode === 'bedtime') {
                    // Bedtime -> Wake time (Move Forward)
                    // If time is earlier than now, assume tomorrow
                    if (calculatedTime < new Date()) calculatedTime.setDate(calculatedTime.getDate() + 1);
                    calculatedTime.setMinutes(calculatedTime.getMinutes() + minutesToAdd);
                } else {
                    // Wake time -> Bedtime (Move Backward)
                    if (calculatedTime < new Date()) calculatedTime.setDate(calculatedTime.getDate() + 1); // Set to next occurrence of wake time
                    calculatedTime.setMinutes(calculatedTime.getMinutes() - minutesToAdd);
                }

                const isBest = (c === 5 || c === 6); // 7.5h or 9h is best
                const timeStr = calculatedTime.toLocaleTimeString('vi-VN', { hour: '2-digit', minute: '2-digit' });

                const itemHtml = `
                    <div class="rounded-lg p-3 border ${isBest ? 'bg-white text-black border-white' : 'bg-zinc-800 border-zinc-700 text-zinc-400'} flex flex-col items-center justify-center relative">
                        ${isBest ? '<div class="absolute -top-2 -right-2 text-yellow-500"><i data-lucide="star" class="w-4 h-4 fill-current"></i></div>' : ''}
                        <span class="text-xl font-bold tracking-tight">${timeStr}</span>
                        <span class="text-[10px] uppercase tracking-wide opacity-80">${c} chu kỳ (${c * 1.5}h)</span>
                    </div>
                `;
                list.innerHTML += itemHtml;
            });
            lucide.createIcons();
        }

        function calcDuration() {
            const start = document.getElementById('diff-start').value;
            const end = document.getElementById('diff-end').value;
            const resultBox = document.getElementById('sleepResultContainer');
            const list = document.getElementById('sleepResultContent');
            const durationTxt = document.getElementById('durationResult');

            if (!start || !end) return;

            resultBox.classList.remove('hidden');
            list.classList.add('hidden');
            durationTxt.classList.remove('hidden');

            const [h1, m1] = start.split(':').map(Number);
            const [h2, m2] = end.split(':').map(Number);

            let min1 = h1 * 60 + m1;
            let min2 = h2 * 60 + m2;

            if (min2 < min1) min2 += 24 * 60; // Handle overnight

            const diff = min2 - min1;
            const h = Math.floor(diff / 60);
            const m = diff % 60;

            durationTxt.innerHTML = `
                <div class="text-xs text-zinc-500 mb-2 uppercase tracking-widest">Tổng thời gian</div>
                <div class="text-4xl font-light">${h}<span class="text-sm font-normal text-zinc-500">h</span> ${m}<span class="text-sm font-normal text-zinc-500">m</span></div>
            `;
        }

        /* --- UTILS --- */
        function toggleMenu() {
            const menu = document.getElementById('menuOverlay');
            menu.classList.toggle('translate-y-full');
        }

        let isStoryPlaying = false;
        const storyAudio = new Audio('https://actions.google.com/sounds/v1/water/waves_crashing_on_rock_beach.ogg');
        function toggleStory() {
            const btn = document.getElementById('storyBtn');
            if (isStoryPlaying) {
                storyAudio.pause();
                btn.innerHTML = '<i data-lucide="play" class="w-4 h-4"></i>';
                btn.classList.replace('bg-white', 'bg-zinc-800'); btn.classList.replace('text-black', 'text-white');
            } else {
                storyAudio.play();
                btn.innerHTML = '<i data-lucide="pause" class="w-4 h-4"></i>';
                btn.classList.replace('bg-zinc-800', 'bg-white'); btn.classList.replace('text-white', 'text-black');
            }
            isStoryPlaying = !isStoryPlaying; lucide.createIcons();
        }
    </script>
</body>

</html>