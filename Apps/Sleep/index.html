<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">

    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="mobile-web-app-capable" content="yes">
    <link rel="icon" href="/Asset/logo/iconApps.png" />
    <link rel="apple-touch-icon" href="/Asset/logo/iconApps.png" sizes="150x150" />

    <title>Giấc Ngủ Ngon (Final)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Quicksand:wght@300;400;500;600;700&family=Share+Tech+Mono&display=swap');

        body {
            font-family: 'Quicksand', sans-serif;
            overflow-x: hidden;
            background-color: #0f172a;
            color: white;
            transition: background-color 1s ease;
            -webkit-tap-highlight-color: transparent; /* Loại bỏ highlight khi tap trên mobile */
        }

        /* Custom Scrollbar */
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: rgba(255, 255, 255, 0.05); }
        ::-webkit-scrollbar-thumb { background: rgba(255, 255, 255, 0.2); border-radius: 4px; }

        /* Background Layers */
        #videoBg { position: fixed; top: 0; left: 0; width: 100%; height: 100%; object-fit: cover; z-index: -2; opacity: 0; transition: opacity 1s ease; }
        #bgCanvas { position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: -1; filter: blur(60px) contrast(1.2); transform: scale(1.1); transition: opacity 1s ease; }
        #particleCanvas { position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: -1; pointer-events: none; }

        /* Glassmorphism */
        .glass-panel {
            background: rgba(20, 20, 30, 0.65);
            backdrop-filter: blur(16px);
            -webkit-backdrop-filter: blur(16px);
            border: 1px solid rgba(255, 255, 255, 0.08);
            border-radius: 20px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.2);
        }

        .tab-active { border-bottom: 2px solid #a78bfa; color: #a78bfa; }

        /* Controls */
        input[type=range] { -webkit-appearance: none; background: transparent; }
        input[type=range]::-webkit-slider-thumb {
            -webkit-appearance: none; height: 14px; width: 14px;
            border-radius: 50%; background: #ffffff; cursor: pointer;
            margin-top: -5px; box-shadow: 0 0 10px rgba(255,255,255,0.5);
        }
        input[type=range]::-webkit-slider-runnable-track { width: 100%; height: 4px; cursor: pointer; background: rgba(255,255,255,0.2); border-radius: 2px; }

        /* Zen Fonts & Widgets */
        .zen-clock { font-family: 'Share Tech Mono', monospace; text-shadow: 0 0 20px rgba(255,255,255,0.3); }
        .ui-hidden { opacity: 0; pointer-events: none; transform: scale(0.98); }
        .fade-transition { transition: opacity 0.6s cubic-bezier(0.4, 0, 0.2, 1), transform 0.6s ease; }
        
        /* Input Styling */
        .input-dark {
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            color: white; transition: all 0.2s;
        }
        .input-dark:focus { background: rgba(255, 255, 255, 0.1); border-color: rgba(167, 139, 250, 0.5); outline: none; }
        
        .loading-pulse { animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite; }
        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: .5; } }
    </style>
</head>
<body class="min-h-screen flex flex-col relative">

    <video id="videoBg" loop muted playsinline></video>
    <canvas id="bgCanvas"></canvas> 
    <canvas id="particleCanvas"></canvas>

    <div id="zenContainer" class="fixed inset-0 flex flex-col items-center justify-center z-50 opacity-0 pointer-events-none transition-opacity duration-1000 p-8 cursor-pointer">
        <div class="flex flex-col items-center justify-between h-full w-full max-w-4xl py-12 pointer-events-none">
            
            <div id="zenTopWidget" class="text-center space-y-4 opacity-90 w-full pointer-events-none">
                <div id="zenWeatherContainer" class="hidden flex flex-wrap items-center justify-center gap-6 md:gap-12"></div>
                <div id="zenDate" class="hidden text-xl tracking-widest font-light text-purple-200 mt-2">...</div>
            </div>

            <div id="zenClockWidget" class="text-center pointer-events-none">
                <div id="digitalClock" class="zen-clock text-7xl md:text-9xl font-thin tracking-widest text-white/95">00:00</div>
                <div id="zenQuote" class="hidden mt-8 text-lg md:text-xl italic font-light text-white/70 max-w-2xl mx-auto px-4 leading-relaxed">
                    "..."
                </div>
            </div>

            <div id="zenBottomWidget" class="text-center space-y-4 pointer-events-none">
                <div id="zenNowPlaying" class="hidden glass-panel px-6 py-3 inline-flex items-center gap-3">
                    <div class="w-2 h-2 rounded-full bg-green-400 animate-pulse"></div>
                    <span id="nowPlayingText" class="text-sm font-medium tracking-wide">Đang phát...</span>
                </div>
                <p class="text-xs text-white/20 animate-pulse mt-4">Chạm vào màn hình để mở giao diện</p>
            </div>
        </div>
    </div>

    <div id="settingsModal" class="fixed inset-0 z-50 hidden flex items-center justify-center bg-black/80 backdrop-blur-sm opacity-0 transition-opacity duration-300">
        <div class="glass-panel w-full max-w-md p-6 m-4 transform scale-95 transition-transform duration-300 relative max-h-[90vh] flex flex-col" id="settingsContent">
            <button onclick="toggleSettings()" class="absolute top-4 right-4 text-gray-400 hover:text-white"><i data-lucide="x"></i></button>
            <h2 class="text-2xl font-bold mb-6 flex items-center gap-2"><i data-lucide="settings"></i> Cài Đặt</h2>
            
            <div class="space-y-6 overflow-y-auto pr-2 custom-scrollbar flex-1">
                <div>
                    <h3 class="text-xs font-bold text-purple-300 uppercase tracking-wider mb-2">Hẹn Giờ Tắt</h3>
                    <div class="flex gap-2">
                        <input type="number" id="timerInput" placeholder="Số phút" class="input-dark w-full rounded-lg p-2.5 text-center">
                        <button onclick="setManualTimer()" class="bg-purple-600 hover:bg-purple-700 text-white px-4 rounded-lg text-sm font-medium whitespace-nowrap">Bắt đầu</button>
                        <button onclick="cancelTimer()" class="bg-red-500/20 text-red-200 px-3 rounded-lg hover:bg-red-500/30"><i data-lucide="x-circle" class="w-5 h-5"></i></button>
                    </div>
                    <p id="timerStatus" class="text-xs text-purple-200 mt-2 text-center h-4"></p>
                </div>

                <div>
                    <h3 class="text-xs font-bold text-blue-300 uppercase tracking-wider mb-2">Thời Tiết (Tối đa 2)</h3>
                    <div class="flex gap-2 mb-3">
                        <input type="text" id="cityInput" placeholder="Nhập tên thành phố (VD: Hanoi)" class="input-dark w-full rounded-lg p-2.5 text-sm">
                        <button onclick="addCity()" class="bg-blue-600 hover:bg-blue-700 text-white px-3 rounded-lg"><i data-lucide="plus" class="w-5 h-5"></i></button>
                    </div>
                    <div id="cityList" class="space-y-2"></div>
                    <p id="weatherError" class="text-xs text-red-300 mt-1"></p>
                </div>

                <div>
                    <h3 class="text-xs font-bold text-gray-400 uppercase tracking-wider mb-2">Hiển thị Zen Mode</h3>
                    <div class="space-y-2">
                        <label class="flex justify-between items-center p-2 rounded hover:bg-white/5 cursor-pointer">
                            <span class="text-sm">Đồng hồ</span> <input type="checkbox" id="optClock" checked class="accent-purple-500" onchange="updateZenConfig()">
                        </label>
                        <label class="flex justify-between items-center p-2 rounded hover:bg-white/5 cursor-pointer">
                            <span class="text-sm">Ngày tháng</span> <input type="checkbox" id="optDate" checked class="accent-purple-500" onchange="updateZenConfig()">
                        </label>
                        <label class="flex justify-between items-center p-2 rounded hover:bg-white/5 cursor-pointer">
                            <span class="text-sm">Thời tiết</span> <input type="checkbox" id="optWeather" checked class="accent-purple-500" onchange="updateZenConfig()">
                        </label>
                        <label class="flex justify-between items-center p-2 rounded hover:bg-white/5 cursor-pointer">
                            <span class="text-sm">Quote (Ngẫu nhiên)</span> <input type="checkbox" id="optQuote" checked class="accent-purple-500" onchange="updateZenConfig()">
                        </label>
                         <label class="flex justify-between items-center p-2 rounded hover:bg-white/5 cursor-pointer">
                            <span class="text-sm">Thông tin nhạc</span> <input type="checkbox" id="optNowPlaying" checked class="accent-purple-500" onchange="updateZenConfig()">
                        </label>
                    </div>
                </div>

                <div>
                    <h3 class="text-xs font-bold text-green-300 uppercase tracking-wider mb-2">Media từ URL</h3>
                    <div class="input-dark p-3 rounded-xl space-y-2">
                        <input type="text" id="mediaUrlInput" placeholder="Link mp3/mp4..." class="w-full bg-transparent border-b border-white/10 pb-1 text-sm outline-none">
                        <div class="flex justify-between items-center pt-2">
                            <div class="flex gap-3 text-xs">
                                <label class="flex gap-1"><input type="radio" name="mediaType" value="audio" checked> Audio</label>
                                <label class="flex gap-1"><input type="radio" name="mediaType" value="video"> Video</label>
                            </div>
                            <button onclick="loadMediaFromUrl()" class="text-xs bg-green-600 px-3 py-1 rounded">Phát</button>
                        </div>
                    </div>
                    <div id="customPlayer" class="hidden mt-2 flex items-center gap-2 bg-white/5 p-2 rounded-lg">
                        <button id="customPlayBtn" onclick="toggleCustomMedia()" class="p-1.5 bg-green-600 rounded-full"><i data-lucide="pause" class="w-3 h-3 fill-current"></i></button>
                        <div class="flex-1 min-w-0"><div class="text-xs truncate text-green-300">Media URL</div><input type="range" id="customVolume" max="1" step="0.05" class="w-full h-1"></div>
                        <button onclick="removeCustomMedia()" class="text-red-400"><i data-lucide="trash-2" class="w-4 h-4"></i></button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div id="mainUI" class="flex-grow flex flex-col fade-transition z-10 w-full h-full pb-8">
        <header class="p-6 text-center">
            <div class="flex justify-between items-start max-w-6xl mx-auto w-full relative">
                <button onclick="toggleSettings()" class="w-10 h-10 rounded-full bg-white/5 hover:bg-white/10 flex items-center justify-center transition-colors">
                    <i data-lucide="settings" class="w-5 h-5 text-gray-300"></i>
                </button>
                <div class="flex flex-col items-center">
                    <div class="flex justify-center items-center gap-3 mb-2">
                        <i data-lucide="moon" class="w-8 h-8 text-purple-300"></i>
                        <h1 class="text-3xl font-bold tracking-wide">Giấc Ngủ Ngon</h1>
                    </div>
                </div>
                <button onclick="toggleZenMode()" class="w-10 h-10 rounded-full bg-white/5 hover:bg-white/10 flex items-center justify-center transition-colors">
                    <i data-lucide="eye-off" class="w-5 h-5 text-gray-300"></i>
                </button>
            </div>
        </header>

        <main class="flex-grow container mx-auto px-4 grid grid-cols-1 lg:grid-cols-2 gap-8 max-w-6xl">
            <section class="glass-panel p-6 h-fit">
                <div class="flex items-center gap-2 mb-4 border-b border-white/10 pb-2">
                    <i data-lucide="clock" class="text-purple-400 w-5 h-5"></i>
                    <h2 class="font-semibold">Tính Giờ Ngủ</h2>
                </div>
                <div class="flex bg-black/20 rounded-lg p-1 mb-4">
                    <button onclick="switchTab('wakeUp')" id="btn-wakeUp" class="flex-1 py-2 text-xs font-medium rounded-md bg-white/10 text-white shadow">Báo Thức</button>
                    <button onclick="switchTab('sleepNow')" id="btn-sleepNow" class="flex-1 py-2 text-xs font-medium rounded-md text-gray-400 hover:text-white">Ngủ Ngay</button>
                </div>
                <div id="tab-wakeUp" class="space-y-3">
                    <div class="text-sm text-gray-300">Bạn muốn dậy lúc mấy giờ?</div>
                    <div class="flex gap-2">
                        <input type="time" id="wakeTimeInput" class="input-dark rounded-lg p-2.5 w-full text-center">
                        <button onclick="calculateSleep('wake')" class="bg-purple-600 text-white px-4 rounded-lg"><i data-lucide="calculator" class="w-5 h-5"></i></button>
                    </div>
                </div>
                <div id="tab-sleepNow" class="hidden">
                    <button onclick="calculateSleep('now')" class="w-full bg-indigo-600 hover:bg-indigo-700 text-white py-3 rounded-lg text-sm font-medium">Xem giờ dậy tốt nhất</button>
                </div>
                <div id="sleepResult" class="mt-4 hidden p-3 bg-purple-900/20 rounded-xl border border-purple-500/20">
                    <div id="timesList" class="grid grid-cols-2 gap-2 text-center"></div>
                </div>
            </section>

            <div class="space-y-6">
                <section class="glass-panel p-6">
                    <div class="flex items-center justify-between mb-4 border-b border-white/10 pb-2">
                        <div class="flex items-center gap-2">
                            <i data-lucide="sliders" class="text-pink-400 w-5 h-5"></i>
                            <h2 class="font-semibold">Phối Âm Thanh</h2>
                        </div>
                        <button onclick="stopAllSounds()" class="text-xs bg-red-500/10 text-red-300 px-3 py-1 rounded-full">Dừng tất cả</button>
                    </div>
                    <div class="grid grid-cols-1 sm:grid-cols-2 gap-3 max-h-[50vh] overflow-y-auto pr-2 custom-scrollbar" id="soundGrid"></div>
                </section>

                <section class="glass-panel p-4 flex items-center justify-between">
                    <div class="flex items-center gap-3">
                        <div class="w-10 h-10 rounded-full bg-amber-900/50 flex items-center justify-center">
                            <i data-lucide="book-open" class="text-amber-400 w-5 h-5"></i>
                        </div>
                        <div>
                            <h3 class="text-sm font-medium">Kể Chuyện: Chuyến Tàu Đêm</h3>
                            <input type="range" id="storyVolume" max="1" step="0.05" class="w-24 h-1 bg-gray-600 rounded mt-1">
                        </div>
                    </div>
                    <button id="storyBtn" onclick="toggleStory()" class="w-10 h-10 rounded-full bg-amber-600 hover:bg-amber-500 flex items-center justify-center">
                        <i data-lucide="play" class="w-5 h-5 fill-white text-white"></i>
                    </button>
                </section>
            </div>
        </main>
    </div>

    <script>
        // --- 1. ZEN QUOTES (40 Quotes) ---
        const zenQuotes = [
            "Hơi thở là chiếc neo giữ tâm trí bạn ở lại hiện tại.",
            "Tâm an vạn sự an. Lòng tĩnh vạn sự bình.",
            "Đừng để ngày hôm qua chiếm quá nhiều thời gian của ngày hôm nay.",
            "Hạnh phúc không phải là đích đến, mà là hành trình.",
            "Ngủ ngon là cách tốt nhất để tha thứ cho chính mình.",
            "Giữa những biến động, hãy giữ tâm bất biến.",
            "Chỉ cần bạn không dừng lại, việc bạn đi chậm thế nào không quan trọng.",
            "Hãy buông bỏ những gì bạn không thể kiểm soát.",
            "Sự yên bình đến từ bên trong. Đừng tìm nó bên ngoài.",
            "Mỗi hơi thở là một cơ hội mới.",
            "Yêu bản thân là khởi đầu của một cuộc tình lãng mạn trọn đời.",
            "Điều duy nhất bạn thực sự sở hữu là khoảnh khắc này.",
            "Lắng nghe sự im lặng, nó có rất nhiều điều để nói.",
            "Đừng suy nghĩ quá nhiều, hãy để cuộc đời trôi chảy.",
            "Bình yên không có nghĩa là ở nơi không có tiếng ồn, mà là giữ tâm tĩnh lặng giữa chốn ồn ào.",
            "Ngày hôm nay là một món quà, đó là lý do chúng ta gọi nó là 'Hiện tại'.",
            "Căng thẳng là do bạn muốn mọi thứ khác đi. Bình an là chấp nhận mọi thứ như nó vốn là.",
            "Hãy nhẹ nhàng với chính mình. Bạn đang làm tốt nhất có thể.",
            "Giấc ngủ là sợi dây vàng nối kết sức khỏe và cơ thể.",
            "Một tâm trí bình thản là vũ khí mạnh mẽ nhất chống lại mọi thử thách.",
            "Hãy sống đơn giản để người khác có thể đơn giản sống.",
            "Hạnh phúc là khi những gì bạn nghĩ, nói và làm hòa hợp với nhau.",
            "Đừng lo lắng về ngày mai, vì ngày mai sẽ tự lo cho chính nó.",
            "Thở vào tâm tĩnh lặng, thở ra miệng mỉm cười.",
            "Chỉ có giây phút hiện tại là sự sống đích thực.",
            "Hãy làm rỗng tâm trí, trở nên vô hình như nước.",
            "Vẻ đẹp của vạn vật nằm trong tâm trí người ngắm nhìn.",
            "Không có con đường nào dẫn đến hạnh phúc. Hạnh phúc chính là con đường.",
            "Mọi chuyện rồi sẽ ổn thôi. Hãy ngủ một giấc thật ngon.",
            "Bóng tối không thể xua tan bóng tối, chỉ có ánh sáng mới làm được điều đó.",
            "Sự tĩnh lặng là câu trả lời hay nhất cho những câu hỏi phức tạp nhất.",
            "Hãy biết ơn những gì bạn đang có, bạn sẽ có nhiều hơn.",
            "Đừng cố gắng trở thành người thành công, hãy cố gắng trở thành người có giá trị.",
            "Cuộc sống thật sự bắt đầu khi bạn bước ra khỏi vùng an toàn.",
            "Hãy là sự thay đổi mà bạn muốn thấy trên thế giới.",
            "Gieo suy nghĩ, gặt hành động. Gieo hành động, gặt thói quen.",
            "Không gì là vĩnh cửu, kể cả những rắc rối của bạn.",
            "Hãy cười lên, vì nụ cười là liều thuốc bổ cho tâm hồn.",
            "Thất bại chỉ là cơ hội để bắt đầu lại một cách thông minh hơn.",
            "Hãy để tâm trí bạn nghỉ ngơi, nó đã làm việc vất vả cả ngày rồi."
        ];
        function getRandomQuote() { return zenQuotes[Math.floor(Math.random() * zenQuotes.length)]; }

        // --- 2. WEATHER API (Open-Meteo) ---
        let savedCities = JSON.parse(localStorage.getItem('zenCities')) || [];
        const weatherCodeMap = {
            0: { text: 'Trời quang', icon: 'sun' }, 1: { text: 'Ít mây', icon: 'cloud-sun' }, 2: { text: 'Có mây', icon: 'cloud' },
            3: { text: 'Nhiều mây', icon: 'cloud' }, 45: { text: 'Sương mù', icon: 'cloud-fog' }, 48: { text: 'Sương mù', icon: 'cloud-fog' },
            51: { text: 'Mưa phùn', icon: 'cloud-drizzle' }, 53: { text: 'Mưa phùn', icon: 'cloud-drizzle' }, 55: { text: 'Mưa phùn', icon: 'cloud-drizzle' },
            61: { text: 'Mưa nhỏ', icon: 'cloud-rain' }, 63: { text: 'Mưa vừa', icon: 'cloud-rain' }, 65: { text: 'Mưa to', icon: 'cloud-rain' },
            80: { text: 'Mưa rào', icon: 'cloud-lightning' }, 81: { text: 'Mưa rào', icon: 'cloud-lightning' }, 82: { text: 'Mưa rất to', icon: 'cloud-lightning' },
            95: { text: 'Dông', icon: 'zap' }, 96: { text: 'Dông & Mưa đá', icon: 'cloud-hail' }, 99: { text: 'Dông & Mưa đá', icon: 'cloud-hail' }
        };

        async function addCity() {
            const input = document.getElementById('cityInput');
            const cityName = input.value.trim();
            const errorEl = document.getElementById('weatherError');
            if (!cityName) return;
            if (savedCities.length >= 2) { errorEl.textContent = "Chỉ được thêm tối đa 2 thành phố."; return; }
            try {
                const geoRes = await fetch(`https://geocoding-api.open-meteo.com/v1/search?name=${encodeURIComponent(cityName)}&count=1&language=vi&format=json`);
                const geoData = await geoRes.json();
                if (!geoData.results || geoData.results.length === 0) { errorEl.textContent = "Không tìm thấy thành phố này."; return; }
                const city = geoData.results[0];
                savedCities.push({ name: city.name, lat: city.latitude, lon: city.longitude });
                localStorage.setItem('zenCities', JSON.stringify(savedCities));
                input.value = ''; errorEl.textContent = ''; renderCityList();
            } catch (e) { errorEl.textContent = "Lỗi kết nối. Vui lòng thử lại."; console.error(e); }
        }

        function removeCity(index) {
            savedCities.splice(index, 1); localStorage.setItem('zenCities', JSON.stringify(savedCities)); renderCityList();
        }

        function renderCityList() {
            const list = document.getElementById('cityList');
            list.innerHTML = savedCities.map((c, i) => `
                <div class="flex justify-between items-center bg-white/5 p-2 rounded text-sm">
                    <span>${c.name}</span>
                    <button onclick="removeCity(${i})" class="text-red-400 hover:text-red-300"><i data-lucide="x" class="w-4 h-4"></i></button>
                </div>
            `).join('');
            document.getElementById('weatherError').textContent = '';
        }

        async function fetchWeatherForZen() {
            const container = document.getElementById('zenWeatherContainer');
            if (savedCities.length === 0) { container.innerHTML = '<span class="text-sm italic opacity-50">Chưa thêm thành phố trong Cài đặt</span>'; return; }
            container.innerHTML = ''; 
            for (const city of savedCities) {
                try {
                    const res = await fetch(`https://api.open-meteo.com/v1/forecast?latitude=${city.lat}&longitude=${city.lon}&current_weather=true`);
                    const data = await res.json();
                    const w = data.current_weather;
                    const info = weatherCodeMap[w.weathercode] || { text: 'Không rõ', icon: 'help-circle' };
                    const div = document.createElement('div');
                    div.className = "flex flex-col items-center animate-fade-in";
                    div.innerHTML = `
                        <div class="flex items-center gap-2 text-2xl md:text-3xl font-light"><i data-lucide="${info.icon}"></i><span>${Math.round(w.temperature)}°C</span></div>
                        <div class="text-xs md:text-sm uppercase tracking-widest opacity-70 mt-1">${city.name} • ${info.text}</div>
                    `;
                    container.appendChild(div);
                } catch (e) { console.error("Weather load fail", e); }
            }
            lucide.createIcons();
        }

        // --- 3. FILE AUDIO ENGINE ---
        class SoundNode {
            constructor(id, config) {
                this.id = id; this.config = config; this.isPlaying = false;
                this.audio = new Audio(`./Sounds/${id}.mp3`); 
                this.audio.loop = true; this.audio.volume = 0.5;
                this.audio.onerror = () => { if(this.isPlaying) { alert(`Thiếu file: /Sounds/${id}.mp3`); this.stop(true); } };
            }
            play(delay = 0) {
                if(this.isPlaying) return;
                if(delay > 0) this.timer = setTimeout(() => this._start(), delay*1000);
                else this._start();
                this.isPlaying = true;
            }
            _start() { this.audio.play().catch(()=>{}); updateZenNowPlaying(); updateVisualState(); }
            setVolume(val) { this.audio.volume = val; }
            stop(force = false) {
                if(this.timer) clearTimeout(this.timer);
                if(!force && !this.audio.paused) {
                    const fade = setInterval(() => { if(this.audio.volume > 0.05) this.audio.volume -= 0.05; else { clearInterval(fade); this._hardStop(); } }, 50);
                } else this._hardStop();
            }
            _hardStop() {
                this.audio.pause(); this.audio.currentTime = 0; this.isPlaying = false; this.audio.volume=0.5;
                updateZenNowPlaying(); updateVisualState();
                const cb = document.querySelector(`input[onchange="toggleSound('${this.id}', this)"]`);
                if(cb && cb.checked) { cb.checked = false; document.getElementById(`controls-${this.id}`).classList.add('opacity-50', 'pointer-events-none'); }
            }
        }

        const soundManager = {};
        const sounds = [
            { id: 'rain', name: 'Mưa Nhẹ', icon: 'cloud-rain', color: '#3b82f6', type: 'rain' },
            { id: 'rain_heavy', name: 'Mưa Rào', icon: 'cloud-lightning', color: '#1e3a8a', type: 'rain' },
            { id: 'thunder', name: 'Sấm', icon: 'zap', color: '#f59e0b', type: 'thunder' },
            { id: 'fire', name: 'Lửa Trại', icon: 'flame', color: '#f97316', type: 'fire' }, 
            { id: 'wind', name: 'Gió', icon: 'wind', color: '#a8a29e', type: 'wind' },
            { id: 'bird', name: 'Chim', icon: 'bird', color: '#0b6623', type: 'nature' },
            { id: 'blizzard', name: 'Bão Tuyết', icon: 'snowflake', color: '#cbd5e1', type: 'snow' },
            { id: 'fan', name: 'Quạt', icon: 'fan', color: '#78716c', type: 'wind' },
            { id: 'clock', name: 'Đồng Hồ', icon: 'clock', color: '#d6d3d1', type: 'clock' },
            { id: 'insects', name: 'Côn Trùng', icon: 'bug', color: '#84cc16', type: 'nature' },
            { id: 'stream', name: 'Suối', icon: 'droplets', color: '#06b6d4', type: 'water' },
        ];
        
        const soundGrid = document.getElementById('soundGrid');
        sounds.forEach(sound => {
            soundManager[sound.id] = new SoundNode(sound.id, sound);
            soundGrid.innerHTML += `
                <div class="bg-gray-800/50 rounded-xl p-4 border border-gray-700 hover:border-gray-500 transition-all">
                    <div class="flex items-center justify-between mb-3">
                        <div class="flex items-center gap-3">
                            <div class="p-2 rounded-lg bg-gray-700"><i data-lucide="${sound.icon}" style="color: ${sound.color}"></i></div>
                            <span class="font-medium text-sm">${sound.name}</span>
                        </div>
                        <label class="relative inline-flex items-center cursor-pointer">
                            <input type="checkbox" class="sr-only peer" onchange="toggleSound('${sound.id}', this)">
                            <div class="w-11 h-6 bg-gray-700 peer-focus:outline-none rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-purple-600"></div>
                        </label>
                    </div>
                    <div class="space-y-3 opacity-50 pointer-events-none transition-opacity" id="controls-${sound.id}">
                        <div class="flex items-center gap-2">
                            <i data-lucide="volume-2" class="w-3 h-3 text-gray-400"></i>
                            <input type="range" min="0" max="1" step="0.01" value="0.5" class="w-full" oninput="changeVolume('${sound.id}', this.value)">
                        </div>
                        <div class="flex items-center gap-2">
                            <i data-lucide="hourglass" class="w-3 h-3 text-gray-400"></i>
                            <select class="text-xs bg-gray-900 border border-gray-700 rounded px-1 py-1 text-gray-400 w-full outline-none" id="delay-${sound.id}">
                                <option value="0">Phát ngay</option><option value="5">Chờ 5s</option><option value="30">Chờ 30s</option>
                            </select>
                        </div>
                    </div>
                </div>`;
        });

        function toggleSound(id, cb) {
            const ctrl = document.getElementById(`controls-${id}`);
            const delay = document.getElementById(`delay-${id}`).value;
            const vol = ctrl.querySelector('input').value;
            if (cb.checked) { ctrl.classList.remove('opacity-50', 'pointer-events-none'); soundManager[id].setVolume(vol); soundManager[id].play(parseInt(delay)); } 
            else { ctrl.classList.add('opacity-50', 'pointer-events-none'); soundManager[id].stop(); }
        }
        function changeVolume(id, val) { soundManager[id].setVolume(val); }

        // --- STORY & MEDIA ---
        let isStoryPlaying = false;
        const storyAudio = new Audio('https://actions.google.com/sounds/v1/water/waves_crashing_on_rock_beach.ogg'); storyAudio.loop = true;
        function toggleStory() {
            const btn = document.getElementById('storyBtn');
            if(isStoryPlaying) { storyAudio.pause(); btn.innerHTML='<i data-lucide="play" class="w-5 h-5 fill-white text-white"></i>'; }
            else { storyAudio.play(); btn.innerHTML='<i data-lucide="pause" class="w-5 h-5 fill-white text-white"></i>'; }
            isStoryPlaying = !isStoryPlaying; lucide.createIcons(); updateZenNowPlaying();
        }
        document.getElementById('storyVolume').addEventListener('input', e => storyAudio.volume = e.target.value);

        let customMediaEl = null; let isCustomPlaying = false;
        function loadMediaFromUrl() {
            const url = document.getElementById('mediaUrlInput').value; if(!url) return;
            if(customMediaEl) customMediaEl.pause();
            const type = document.querySelector('input[name="mediaType"]:checked').value;
            if(type === 'video') { customMediaEl = document.getElementById('videoBg'); customMediaEl.src = url; customMediaEl.style.opacity = 1; document.getElementById('bgCanvas').style.opacity = 0; } 
            else customMediaEl = new Audio(url);
            customMediaEl.loop = true; document.getElementById('customPlayer').classList.remove('hidden'); toggleCustomMedia();
        }
        function toggleCustomMedia() {
            if(!customMediaEl) return;
            const btn = document.getElementById('customPlayBtn');
            customMediaEl.volume = document.getElementById('customVolume').value;
            if(isCustomPlaying) { customMediaEl.pause(); btn.innerHTML='<i data-lucide="play" class="w-3 h-3 fill-current"></i>'; }
            else { customMediaEl.play(); btn.innerHTML='<i data-lucide="pause" class="w-3 h-3 fill-current"></i>'; }
            isCustomPlaying = !isCustomPlaying; lucide.createIcons(); updateZenNowPlaying();
        }
        document.getElementById('customVolume').addEventListener('input', e => { if(customMediaEl) customMediaEl.volume = e.target.value; });
        function removeCustomMedia() {
            if(customMediaEl) { customMediaEl.pause(); if(customMediaEl.tagName==='VIDEO') { customMediaEl.src=''; customMediaEl.style.opacity=0; document.getElementById('bgCanvas').style.opacity=1; } }
            customMediaEl = null; isCustomPlaying=false; document.getElementById('customPlayer').classList.add('hidden'); updateZenNowPlaying();
        }
        function stopAllSounds() { Object.values(soundManager).forEach(s => s.stop()); if(isStoryPlaying) toggleStory(); if(isCustomPlaying) toggleCustomMedia(); }

        // --- TIMER & ZEN ---
        let timerId=null, cdId=null;
        function setManualTimer() {
            cancelTimer(); const min = parseInt(document.getElementById('timerInput').value); if(!min) return;
            const end = Date.now() + min*60000; const stat = document.getElementById('timerStatus');
            cdId = setInterval(() => {
                const rem = Math.ceil((end - Date.now())/1000);
                if(rem<=0) { cancelTimer(); stopAllSounds(); stat.innerText="Đã tắt!"; return; }
                stat.innerText = `Tắt sau: ${Math.floor(rem/60)}p ${rem%60}s`;
            }, 1000);
            timerId = setTimeout(() => { stopAllSounds(); cancelTimer(); stat.innerText="Đã tắt!"; }, min*60000);
        }
        function cancelTimer() { clearTimeout(timerId); clearInterval(cdId); document.getElementById('timerStatus').innerText=""; }

        let zenMode = false;
        function toggleZenMode() {
            zenMode = !zenMode;
            const ui = document.getElementById('mainUI');
            const zen = document.getElementById('zenContainer');
            if (zenMode) {
                ui.classList.add('ui-hidden'); zen.classList.remove('opacity-0', 'pointer-events-none');
                document.getElementById('zenQuote').innerText = `"${getRandomQuote()}"`;
                updateZenConfig(); fetchWeatherForZen(); startClock();
            } else {
                ui.classList.remove('ui-hidden'); zen.classList.add('opacity-0', 'pointer-events-none');
            }
        }
        // FIX: Tap anywhere to close
        document.getElementById('zenContainer').addEventListener('click', () => { if(zenMode) toggleZenMode(); });

        function updateZenConfig() {
            const showClock = document.getElementById('optClock').checked;
            const showDate = document.getElementById('optDate').checked;
            const showWeather = document.getElementById('optWeather').checked;
            const showQuote = document.getElementById('optQuote').checked;
            const showPlay = document.getElementById('optNowPlaying').checked;
            document.getElementById('digitalClock').style.display = showClock ? 'block' : 'none';
            document.getElementById('zenDate').classList.toggle('hidden', !showDate);
            document.getElementById('zenWeatherContainer').classList.toggle('hidden', !showWeather);
            document.getElementById('zenQuote').classList.toggle('hidden', !showQuote);
            const playW = document.getElementById('zenNowPlaying');
            const hasAudio = Object.values(soundManager).some(s=>s.isPlaying) || isStoryPlaying || isCustomPlaying;
            if(showPlay && hasAudio) playW.classList.remove('hidden'); else playW.classList.add('hidden');
        }
        function updateZenNowPlaying() {
            updateZenConfig();
            let names = [];
            if(isCustomPlaying) names.push("Media"); if(isStoryPlaying) names.push("Kể Chuyện");
            Object.values(soundManager).forEach(s => { if(s.isPlaying) names.push(s.config.name); });
            document.getElementById('nowPlayingText').innerText = names.length ? "Đang phát: " + names.join(", ") : "Đang tạm dừng";
        }
        function startClock() {
            const update = () => {
                const now = new Date();
                document.getElementById('digitalClock').innerText = now.toLocaleTimeString('vi-VN', {hour:'2-digit', minute:'2-digit'});
                document.getElementById('zenDate').innerText = now.toLocaleDateString('vi-VN', {weekday:'long', day:'numeric', month:'long'});
            };
            update(); if(!window.clockInt) window.clockInt = setInterval(update, 1000);
        }

        // --- UTILS ---
        function switchTab(t) {
            ['wakeUp', 'sleepNow'].forEach(k => {
                document.getElementById(`tab-${k}`).classList.add('hidden');
                document.getElementById(`btn-${k}`).className = "flex-1 py-2 text-xs font-medium rounded-md text-gray-400 hover:text-white";
            });
            document.getElementById(`tab-${t}`).classList.remove('hidden');
            document.getElementById(`btn-${t}`).className = "flex-1 py-2 text-xs font-medium rounded-md bg-white/10 text-white shadow";
        }
        function calculateSleep(type) {
            const list = document.getElementById('timesList'); list.innerHTML='';
            let base = new Date();
            if(type==='wake') {
                const val = document.getElementById('wakeTimeInput').value; if(!val) return;
                const [h,m] = val.split(':'); base.setHours(h,m,0);
                if(base < new Date()) base.setDate(base.getDate()+1);
                [6,5,4,3].forEach(c => addTimeCard(new Date(base.getTime() - (c*90+14)*60000), c, list));
            } else {
                const sleep = new Date(base.getTime() + 14*60000);
                [3,4,5,6].forEach(c => addTimeCard(new Date(sleep.getTime() + c*90*60000), c, list));
            }
            document.getElementById('sleepResult').classList.remove('hidden');
        }
        function addTimeCard(d, c, el) { el.innerHTML += `<div class="bg-black/20 rounded p-2 border border-white/5"><div class="text-lg font-bold ${c>=5?'text-green-300':'text-purple-300'}">${d.toLocaleTimeString([],{hour:'2-digit',minute:'2-digit'})}</div><div class="text-[10px] text-gray-400">${c} chu kỳ</div></div>`; }
        function toggleSettings() {
            const m = document.getElementById('settingsModal');
            if(m.classList.contains('hidden')) { m.classList.remove('hidden'); setTimeout(()=>m.classList.remove('opacity-0'),10); renderCityList(); }
            else { m.classList.add('opacity-0'); setTimeout(()=>m.classList.add('hidden'),300); }
        }

        // Visuals
        const bgCtx=document.getElementById('bgCanvas').getContext('2d'), pCtx=document.getElementById('particleCanvas').getContext('2d');
        let w, h, parts=[], blobs=[], cols=[];
        function resize() { w=window.innerWidth; h=window.innerHeight; bgCtx.canvas.width=w; bgCtx.canvas.height=h; pCtx.canvas.width=w; pCtx.canvas.height=h; parts=Array(100).fill().map(createP); blobs=Array(6).fill().map((_,i)=>createB(i)); }
        const createP=()=>({x:Math.random()*w, y:Math.random()*h, s:Math.random()*2, v:Math.random()*2+1});
        const createB=(i)=>({x:Math.random()*w, y:Math.random()*h, r:Math.min(w,h)*(0.3+Math.random()*0.3), dx:(Math.random()-.5)*.5, dy:(Math.random()-.5)*.5, c:{r:15,g:23,b:42}});
        const hex2rgb=h=>({r:parseInt(h.slice(1,3),16),g:parseInt(h.slice(3,5),16),b:parseInt(h.slice(5,7),16)});
        function updateVisualState() { cols=[]; Object.values(soundManager).forEach(s=>{if(s.isPlaying) cols.push(hex2rgb(s.config.color))}); }
        function animate() {
            if(!customMediaEl || customMediaEl.tagName!=='VIDEO' || customMediaEl.paused) {
                bgCtx.fillStyle='#0f172a'; bgCtx.fillRect(0,0,w,h);
                blobs.forEach((b,i)=>{
                    b.x+=b.dx; b.y+=b.dy; if(b.x<0||b.x>w) b.dx*=-1; if(b.y<0||b.y>h) b.dy*=-1;
                    const t=cols.length?cols[i%cols.length]:{r:15,g:23,b:42};
                    b.c.r+=(t.r-b.c.r)*0.02; b.c.g+=(t.g-b.c.g)*0.02; b.c.b+=(t.b-b.c.b)*0.02;
                    const g=bgCtx.createRadialGradient(b.x,b.y,0,b.x,b.y,b.r);
                    g.addColorStop(0,`rgba(${b.c.r},${b.c.g},${b.c.b},0.6)`); g.addColorStop(1,'transparent');
                    bgCtx.fillStyle=g; bgCtx.beginPath(); bgCtx.arc(b.x,b.y,b.r,0,Math.PI*2); bgCtx.fill();
                });
            }
            pCtx.clearRect(0,0,w,h);
            let m='normal'; Object.values(soundManager).forEach(s=>{if(s.isPlaying){if(s.config.type==='rain')m='rain'; if(s.config.type==='snow')m='snow';}});
            parts.forEach(p=>{
                pCtx.fillStyle=`rgba(255,255,255,0.3)`; pCtx.beginPath(); pCtx.arc(p.x,p.y,p.s,0,Math.PI*2); pCtx.fill();
                if(m==='rain'){ p.y+=p.v*3; p.x+=0.5; } else if(m==='snow'){ p.y+=p.v; p.x+=(Math.random()-.5)*2; } else { p.y+=0.2; p.x+=Math.sin(p.y/50)*0.5; }
                if(p.y>h){p.y=0; p.x=Math.random()*w;} if(p.x>w) p.x=0;
            });
            requestAnimationFrame(animate);
        }

        lucide.createIcons(); window.addEventListener('resize', resize); resize(); animate(); renderCityList();
    </script>
</body>
</html>