<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">

    <title>Giấc Ngủ Ngon (Zen Ultimate)</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    
    <link href="https://fonts.googleapis.com/css2?family=Quicksand:wght@300;400;500;600;700&family=Share+Tech+Mono&family=Orbitron:wght@400;700&family=Playfair+Display:ital,wght@0,400;1,400&family=Abril+Fatface&display=swap" rel="stylesheet">

    <style>
        body {
            font-family: 'Quicksand', sans-serif;
            background-color: #0f172a;
            color: white;
            overflow-x: hidden;
            -webkit-tap-highlight-color: transparent;
            user-select: none;
        }

        /* Scrollbar & Backgrounds */
        ::-webkit-scrollbar { width: 4px; }
        ::-webkit-scrollbar-track { background: rgba(255, 255, 255, 0.05); }
        ::-webkit-scrollbar-thumb { background: rgba(255, 255, 255, 0.2); border-radius: 4px; }
        #videoBg { position: fixed; top: 0; left: 0; width: 100%; height: 100%; object-fit: cover; z-index: -2; opacity: 0; transition: opacity 1s ease; }
        #bgCanvas { position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: -1; transition: opacity 1s ease; }
        #particleCanvas { position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: -1; pointer-events: none; }

        /* UI Components */
        .glass-panel {
            background: rgba(20, 25, 40, 0.7);
            backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.08);
            border-radius: 20px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.4);
        }

        .sound-card { transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1); border: 2px solid transparent; }
        .sound-card:active { transform: scale(0.98); }
        
        input[type=range] { -webkit-appearance: none; background: transparent; height: 20px; width: 100%; cursor: pointer; }
        input[type=range]::-webkit-slider-thumb {
            -webkit-appearance: none; height: 16px; width: 16px; border-radius: 50%; background: #fff; margin-top: -6px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.3);
        }
        input[type=range]::-webkit-slider-runnable-track { width: 100%; height: 4px; background: rgba(255,255,255,0.2); border-radius: 2px; }
        .input-dark { background: rgba(0, 0, 0, 0.3); border: 1px solid rgba(255, 255, 255, 0.1); color: white; }
        .input-dark:focus { border-color: #a78bfa; outline: none; }

        /* --- CLOCK STYLES --- */
        .font-digital { font-family: 'Share Tech Mono', monospace; }
        .font-elegant { font-family: 'Playfair Display', serif; }
        .font-neon { font-family: 'Orbitron', sans-serif; letter-spacing: 2px; text-shadow: 0 0 10px rgba(255,255,255,0.5); }
        .font-retro { font-family: 'Abril Fatface', cursive; letter-spacing: 1px; }

        /* --- CLOCK ANIMATIONS --- */
        /* Fade */
        .anim-fade { animation: fadeTick 1s infinite; }
        @keyframes fadeTick { 0%, 100% { opacity: 1; } 50% { opacity: 0.8; } }
        
        /* Slide Up */
        .anim-slide { position: relative; overflow: hidden; }
        .anim-slide span { display: inline-block; animation: slideUp 0.6s cubic-bezier(0.4, 0, 0.2, 1); }
        @keyframes slideUp { from { transform: translateY(20px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }

        /* 3D Flip */
        .anim-flip { perspective: 1000px; }
        .anim-flip span { display: inline-block; animation: flipX 0.8s cubic-bezier(0.4, 0, 0.2, 1); transform-origin: center center; }
        @keyframes flipX { 0% { transform: rotateX(0deg); } 50% { transform: rotateX(90deg); opacity: 0.5; } 100% { transform: rotateX(0deg); } }

        .ui-hidden { opacity: 0; pointer-events: none; transform: scale(0.95); }
        .fade-transition { transition: opacity 0.5s ease, transform 0.5s ease; }
    </style>
</head>
<body class="min-h-screen flex flex-col relative">

    <video id="videoBg" loop muted playsinline></video>
    <canvas id="bgCanvas"></canvas> 
    <canvas id="particleCanvas"></canvas>

    <div id="zenContainer" class="fixed inset-0 flex flex-col items-center justify-center z-50 opacity-0 pointer-events-none transition-opacity duration-1000 p-6 bg-black/40 cursor-pointer">
        <div class="flex flex-col items-center justify-between h-full w-full max-w-4xl py-8 pointer-events-none">
            
            <div id="zenTopWidget" class="text-center space-y-2 opacity-90 w-full">
                <div id="zenWeather" class="h-16 flex items-center justify-center transition-all duration-500">
                    </div>
                <div id="zenDate" class="text-lg tracking-widest font-light text-purple-100 uppercase opacity-80">...</div>
            </div>

            <div id="zenClockWidget" class="text-center relative">
                <div id="digitalClock" class="text-7xl md:text-9xl text-white/95 drop-shadow-2xl transition-all duration-300 select-none">
                    <span id="clockText">00:00</span>
                </div>
                <div id="focusLabel" class="hidden text-pink-300 text-xl tracking-[0.3em] font-bold mt-2 uppercase animate-pulse">Đang Tập Trung</div>
                <div id="zenQuote" class="mt-12 text-lg md:text-xl italic font-light text-white/80 max-w-2xl mx-auto px-4 leading-relaxed transition-opacity duration-500">"..."</div>
            </div>

            <div id="zenBottomWidget" class="text-center space-y-4">
                <div id="zenNowPlaying" class="hidden glass-panel px-6 py-3 inline-flex items-center gap-3 rounded-full">
                    <div class="w-2 h-2 rounded-full bg-green-400 animate-pulse"></div>
                    <span id="nowPlayingText" class="text-xs font-medium tracking-wide text-gray-200">...</span>
                </div>
                <p class="text-[10px] text-white/30 uppercase tracking-widest mt-4">Chạm để mở khóa</p>
            </div>
        </div>
    </div>

    <div id="settingsModal" class="fixed inset-0 z-50 hidden flex items-center justify-center bg-black/80 backdrop-blur-md opacity-0 transition-opacity duration-300">
        <div class="glass-panel w-full max-w-md p-5 m-4 transform scale-95 transition-transform duration-300 relative max-h-[90vh] flex flex-col">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-xl font-bold flex items-center gap-2"><i data-lucide="settings" class="w-5 h-5"></i> Cài Đặt</h2>
                <button onclick="toggleSettings()" class="text-gray-400 hover:text-white p-2"><i data-lucide="x"></i></button>
            </div>
            
            <div class="space-y-6 overflow-y-auto pr-2 custom-scrollbar flex-1 pb-4">
                
                <div class="bg-white/5 p-4 rounded-xl border border-pink-500/20">
                    <h3 class="text-xs font-bold text-pink-400 uppercase tracking-wider mb-2 flex items-center gap-2"><i data-lucide="zap" class="w-3 h-3"></i> Chế độ Tập trung</h3>
                    <div class="flex gap-2">
                        <input type="number" id="focusInput" value="25" class="input-dark w-16 text-center rounded-lg p-2 text-sm" placeholder="Phút">
                        <button onclick="startFocus()" class="bg-pink-600 hover:bg-pink-500 flex-1 rounded-lg text-sm font-bold shadow-lg shadow-pink-900/20">BẮT ĐẦU FOCUS</button>
                    </div>
                    <p class="text-[10px] text-gray-400 mt-2">*Sẽ thay thế đồng hồ Zen bằng bộ đếm ngược.</p>
                </div>

                <div class="bg-white/5 p-4 rounded-xl">
                    <h3 class="text-xs font-bold text-blue-300 uppercase tracking-wider mb-2">Thời Tiết</h3>
                    <div class="flex gap-2 mb-2">
                        <input type="text" id="cityInput" placeholder="Nhập tên TP (VD: Hanoi)" class="input-dark w-full rounded-lg p-2 text-sm">
                        <button onclick="addCityFromInput()" class="bg-blue-600 px-3 rounded-lg"><i data-lucide="search" class="w-4 h-4"></i></button>
                    </div>
                    <div id="cityList" class="space-y-2 max-h-24 overflow-y-auto"></div>
                    <p id="weatherError" class="text-xs text-red-300 mt-1"></p>
                </div>

                <div class="bg-white/5 p-4 rounded-xl space-y-4">
                    <h3 class="text-xs font-bold text-gray-300 uppercase tracking-wider">Giao diện Zen</h3>
                    
                    <div>
                        <label class="text-[10px] text-gray-400 block mb-1">Phong cách Đồng hồ</label>
                        <div class="grid grid-cols-4 gap-1">
                            <button onclick="setClockStyle('digital')" class="p-1 rounded bg-white/5 text-[10px] hover:bg-purple-600 font-digital">Digital</button>
                            <button onclick="setClockStyle('elegant')" class="p-1 rounded bg-white/5 text-[10px] hover:bg-purple-600 font-elegant">Elegant</button>
                            <button onclick="setClockStyle('neon')" class="p-1 rounded bg-white/5 text-[10px] hover:bg-purple-600 font-neon">Neon</button>
                            <button onclick="setClockStyle('retro')" class="p-1 rounded bg-white/5 text-[10px] hover:bg-purple-600 font-retro">Retro</button>
                        </div>
                    </div>

                    <div>
                        <label class="text-[10px] text-gray-400 block mb-1">Hiệu ứng chuyển số</label>
                        <div class="grid grid-cols-3 gap-1">
                            <button onclick="setClockAnim('none')" class="p-1 rounded bg-white/5 text-[10px] hover:bg-purple-600">Tắt</button>
                            <button onclick="setClockAnim('slide')" class="p-1 rounded bg-white/5 text-[10px] hover:bg-purple-600">Trượt</button>
                            <button onclick="setClockAnim('flip')" class="p-1 rounded bg-white/5 text-[10px] hover:bg-purple-600">Lật 3D</button>
                        </div>
                    </div>

                    <div class="grid grid-cols-2 gap-2 text-sm pt-2">
                        <label class="flex items-center gap-2 cursor-pointer"><input type="checkbox" id="optWeather" checked class="accent-purple-500" onchange="updateZenConfig()"> Thời tiết</label>
                        <label class="flex items-center gap-2 cursor-pointer"><input type="checkbox" id="optQuote" checked class="accent-purple-500" onchange="updateZenConfig()"> Trích dẫn</label>
                    </div>
                </div>

                <div>
                    <h3 class="text-xs font-bold text-gray-400 uppercase tracking-wider mb-2">Tiện ích khác</h3>
                    <div class="flex gap-2 mb-2">
                        <input type="number" id="timerInput" placeholder="Hẹn tắt (phút)" class="input-dark w-full rounded-lg p-2 text-center text-sm">
                        <button onclick="setManualTimer()" class="bg-purple-600 px-4 rounded-lg text-xs font-bold">BẮT ĐẦU</button>
                        <button onclick="cancelTimer()" class="bg-red-500/20 text-red-300 px-3 rounded-lg"><i data-lucide="x-circle" class="w-4 h-4"></i></button>
                    </div>
                    <p id="timerStatus" class="text-xs text-purple-300 text-center h-4 mb-2"></p>
                    
                    <div class="input-dark p-2 rounded-lg flex items-center gap-2">
                        <input type="text" id="mediaUrlInput" placeholder="URL nhạc/video..." class="bg-transparent w-full text-xs outline-none">
                        <button onclick="loadMediaFromUrl()" class="text-xs bg-green-600 px-2 py-1 rounded">Play</button>
                    </div>
                    <div id="customPlayer" class="hidden flex items-center gap-2 bg-black/40 p-2 rounded-lg mt-2">
                        <button onclick="toggleCustomMedia()" id="customPlayBtn"><i data-lucide="pause" class="w-3 h-3"></i></button>
                        <input type="range" id="customVolume" max="1" step="0.05" class="flex-1" oninput="event.stopPropagation()" ontouchstart="event.stopPropagation()">
                        <button onclick="removeCustomMedia()" class="text-red-400"><i data-lucide="trash-2" class="w-3 h-3"></i></button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div id="mainUI" class="flex-grow flex flex-col fade-transition z-10 w-full h-full pb-8">
        <header class="p-6 text-center">
            <div class="flex justify-between items-start max-w-6xl mx-auto w-full relative">
                <button onclick="toggleSettings()" class="w-10 h-10 rounded-full bg-white/5 hover:bg-white/10 flex items-center justify-center transition-colors">
                    <i data-lucide="settings" class="w-5 h-5 text-gray-300"></i>
                </button>
                <div class="flex flex-col items-center">
                    <div class="flex justify-center items-center gap-3 mb-2">
                        <i data-lucide="moon" class="w-8 h-8 text-purple-300"></i>
                        <h1 class="text-3xl font-bold tracking-wide">Giấc Ngủ Ngon</h1>
                    </div>
                </div>
                <button onclick="toggleZenMode()" class="w-10 h-10 rounded-full bg-white/5 hover:bg-white/10 flex items-center justify-center transition-colors">
                    <i data-lucide="eye-off" class="w-5 h-5 text-gray-300"></i>
                </button>
            </div>
        </header>

        <main class="flex-grow container mx-auto px-4 grid grid-cols-1 lg:grid-cols-12 gap-6 max-w-7xl">
            <section class="lg:col-span-4 glass-panel p-6 h-fit">
                <div class="flex items-center gap-2 mb-4 border-b border-white/10 pb-2">
                    <i data-lucide="clock" class="text-purple-400 w-5 h-5"></i>
                    <h2 class="font-semibold">Tính Giờ Ngủ</h2>
                </div>
                <div class="flex bg-black/20 rounded-lg p-1 mb-4">
                    <button onclick="switchTab('wakeUp')" id="btn-wakeUp" class="flex-1 py-2 text-xs font-medium rounded-md bg-white/10 text-white shadow">Báo Thức</button>
                    <button onclick="switchTab('sleepNow')" id="btn-sleepNow" class="flex-1 py-2 text-xs font-medium rounded-md text-gray-400 hover:text-white">Ngủ Ngay</button>
                </div>
                <div id="tab-wakeUp" class="space-y-3">
                    <div class="text-sm text-gray-300">Bạn muốn dậy lúc mấy giờ?</div>
                    <div class="flex gap-2">
                        <input type="time" id="wakeTimeInput" class="input-dark rounded-lg p-2.5 w-full text-center text-lg">
                        <button onclick="calculateSleep('wake')" class="bg-purple-600 text-white px-4 rounded-lg"><i data-lucide="calculator" class="w-5 h-5"></i></button>
                    </div>
                </div>
                <div id="tab-sleepNow" class="hidden">
                    <button onclick="calculateSleep('now')" class="w-full bg-indigo-600 hover:bg-indigo-700 text-white py-3 rounded-lg text-sm font-medium">Xem giờ dậy tốt nhất</button>
                </div>
                <div id="sleepResult" class="mt-4 hidden p-3 bg-purple-900/20 rounded-xl border border-purple-500/20">
                    <div id="timesList" class="grid grid-cols-2 gap-2 text-center"></div>
                </div>
            </section>

            <div class="lg:col-span-8 space-y-6">
                <section class="glass-panel p-6">
                    <div class="flex items-center justify-between mb-4 border-b border-white/10 pb-2">
                        <div class="flex items-center gap-2">
                            <i data-lucide="sliders" class="text-pink-400 w-5 h-5"></i>
                            <h2 class="font-semibold">Phối Âm Thanh</h2>
                        </div>
                        <button onclick="stopAllSounds()" class="text-xs bg-red-500/10 text-red-300 px-3 py-1 rounded-full border border-red-500/20 hover:bg-red-500/20 transition-colors">Dừng tất cả</button>
                    </div>
                    
                    <div class="grid grid-cols-2 md:grid-cols-3 gap-3 max-h-[55vh] overflow-y-auto pr-2 custom-scrollbar" id="soundGrid">
                        </div>
                </section>

                <section class="glass-panel p-4 flex items-center justify-between">
                    <div class="flex items-center gap-3 w-full">
                        <div class="w-10 h-10 rounded-full bg-amber-900/50 flex items-center justify-center flex-shrink-0">
                            <i data-lucide="book-open" class="text-amber-400 w-5 h-5"></i>
                        </div>
                        <div class="flex-1 min-w-0">
                            <h3 class="text-sm font-medium truncate">Kể Chuyện: Chuyến Tàu Đêm</h3>
                            <input type="range" id="storyVolume" max="1" step="0.05" class="w-full h-1 bg-gray-600 rounded mt-2" 
                                   oninput="event.stopPropagation();" ontouchstart="event.stopPropagation();">
                        </div>
                        <button id="storyBtn" onclick="toggleStory()" class="w-10 h-10 rounded-full bg-amber-600 hover:bg-amber-500 flex items-center justify-center flex-shrink-0 ml-2 shadow-lg shadow-amber-900/50">
                            <i data-lucide="play" class="w-5 h-5 fill-white text-white"></i>
                        </button>
                    </div>
                </section>
            </div>
        </main>
    </div>

    <audio id="bellSound" src="https://actions.google.com/sounds/v1/cartoon/clank_car_crash.ogg"></audio>

    <script>
        // --- 1. CORE SOUND ENGINE (Path: ./Sounds/) ---
        class SoundNode {
            constructor(id, config) {
                this.id = id; this.config = config; this.isPlaying = false;
                this.audio = new Audio(`./Sounds/${id}.mp3`); 
                this.audio.loop = true; this.audio.volume = 0.5; this.audio.preload = 'none';
                this.timer = null;
                this.audio.onerror = () => { if(this.isPlaying) { this.stop(true); console.warn(`Missing: ./Sounds/${id}.mp3`); } };
            }
            play(delay = 0) {
                if(this.isPlaying) return;
                this.isPlaying = true; updateVisualState(); updateZenNowPlaying(); updateUI(this.id);
                if(delay > 0) this.timer = setTimeout(() => this._internalPlay(), delay * 1000);
                else this._internalPlay();
            }
            _internalPlay() { this.audio.play().catch(e => {}); }
            setVolume(val) { this.audio.volume = val; }
            stop(force = false) {
                if(this.timer) clearTimeout(this.timer);
                this.isPlaying = false; updateVisualState(); updateZenNowPlaying(); updateUI(this.id);
                if(!force && !this.audio.paused) {
                    const fade = setInterval(() => {
                        if(this.audio.volume > 0.05) this.audio.volume -= 0.05;
                        else { clearInterval(fade); this._hardStop(); }
                    }, 50);
                } else this._hardStop();
            }
            _hardStop() { this.audio.pause(); this.audio.currentTime=0; this.audio.volume=0.5; }
        }

        const soundManager = {};
        const sounds = [
            { id: 'rain', name: 'Mưa Nhẹ', icon: 'cloud-rain', color: '#3b82f6' },
            { id: 'rain_heavy', name: 'Mưa Rào', icon: 'cloud-lightning', color: '#60a5fa' },
            { id: 'thunder', name: 'Sấm', icon: 'zap', color: '#facc15' },
            { id: 'fire', name: 'Lửa Trại', icon: 'flame', color: '#f97316' }, 
            { id: 'wind', name: 'Gió', icon: 'wind', color: '#a8a29e' },
            { id: 'hail', name: 'Mưa Đá', icon: 'cloud-hail', color: '#94a3b8' },
            { id: 'blizzard', name: 'Bão Tuyết', icon: 'snowflake', color: '#cbd5e1' },
            { id: 'fan', name: 'Quạt', icon: 'fan', color: '#78716c' },
            { id: 'clock', name: 'Đồng Hồ', icon: 'clock', color: '#d6d3d1' },
            { id: 'insects', name: 'Côn Trùng', icon: 'bug', color: '#bef264' },
            { id: 'stream', name: 'Suối', icon: 'droplets', color: '#22d3ee' },
        ];
        
        // --- RENDER MIXER (DIV CLICKABLE) ---
        const soundGrid = document.getElementById('soundGrid');
        sounds.forEach(sound => {
            soundManager[sound.id] = new SoundNode(sound.id, sound);
            soundGrid.innerHTML += `
                <div id="card-${sound.id}" onclick="toggleCard('${sound.id}')" 
                     class="sound-card bg-gray-800/40 rounded-xl p-3 cursor-pointer hover:bg-gray-800/60 relative overflow-hidden group">
                    <div class="flex items-center gap-3 mb-3 relative z-10">
                        <div class="p-2 rounded-lg bg-black/30 transition-colors" id="icon-bg-${sound.id}">
                            <i data-lucide="${sound.icon}" class="w-5 h-5" style="color: ${sound.color}"></i>
                        </div>
                        <span class="font-medium text-sm text-gray-200 select-none">${sound.name}</span>
                    </div>
                    <div class="space-y-2 relative z-10 opacity-40 transition-opacity pointer-events-none" id="controls-${sound.id}">
                        <div class="flex items-center gap-2">
                            <i data-lucide="volume-2" class="w-3 h-3 text-gray-400"></i>
                            <input type="range" min="0" max="1" step="0.05" value="0.5" class="w-full h-1" 
                                   oninput="changeVolume('${sound.id}', this.value); event.stopPropagation();" 
                                   onclick="event.stopPropagation()" ontouchstart="event.stopPropagation()">
                        </div>
                        <div class="flex items-center justify-between text-[10px] text-gray-400">
                            <i data-lucide="hourglass" class="w-3 h-3"></i>
                            <select class="bg-transparent outline-none border border-gray-600 rounded px-1" id="delay-${sound.id}" onclick="event.stopPropagation()">
                                <option value="0">Ngay</option><option value="5">5s</option><option value="30">30s</option>
                            </select>
                        </div>
                    </div>
                </div>`;
        });

        function toggleCard(id) {
            const node = soundManager[id];
            if (node.isPlaying) node.stop();
            else {
                const delay = document.getElementById(`delay-${id}`).value;
                node.play(parseInt(delay));
            }
        }

        function updateUI(id) {
            const node = soundManager[id];
            const card = document.getElementById(`card-${id}`);
            const controls = document.getElementById(`controls-${id}`);
            const iconBg = document.getElementById(`icon-bg-${id}`);
            
            if (node.isPlaying) {
                card.style.borderColor = node.config.color;
                card.style.backgroundColor = 'rgba(255,255,255,0.08)';
                controls.classList.remove('opacity-40', 'pointer-events-none');
                iconBg.style.backgroundColor = node.config.color + '33';
            } else {
                card.style.borderColor = 'transparent';
                card.style.backgroundColor = '';
                controls.classList.add('opacity-40', 'pointer-events-none');
                iconBg.style.backgroundColor = '';
            }
        }
        function changeVolume(id, val) { soundManager[id].setVolume(val); }

        // --- 2. FOCUS MODE (POMODORO) ---
        let focusActive = false;
        let focusEndTime = null;
        let focusInterval = null;

        function startFocus() {
            const mins = parseInt(document.getElementById('focusInput').value);
            if (!mins || mins <= 0) return alert("Vui lòng nhập số phút!");
            
            focusEndTime = Date.now() + mins * 60000;
            focusActive = true;
            toggleSettings(); // Close modal
            if (!zenMode) toggleZenMode(); // Enter Zen
            updateClockDisplay();
        }

        function stopFocus() {
            focusActive = false;
            clearInterval(focusInterval);
            document.getElementById('bellSound').play().catch(()=>{}); // Play notification
            document.getElementById('focusLabel').textContent = "HOÀN THÀNH!";
            setTimeout(() => { document.getElementById('focusLabel').classList.add('hidden'); }, 5000);
        }

        // --- 3. SMART WEATHER (Auto GPS + Saved Cities) ---
        let savedCities = JSON.parse(localStorage.getItem('zenCities')) || [];
        const weatherCodeMap = {
            0: {icon:'sun', text:'Quang đãng'}, 1:{icon:'cloud-sun', text:'Ít mây'}, 2:{icon:'cloud', text:'Có mây'}, 3:{icon:'cloud', text:'Nhiều mây'},
            45:{icon:'cloud-fog', text:'Sương mù'}, 51:{icon:'cloud-drizzle', text:'Mưa phùn'}, 61:{icon:'cloud-rain', text:'Mưa nhỏ'},
            80:{icon:'cloud-lightning', text:'Mưa rào'}, 95:{icon:'zap', text:'Dông'}
        };

        // Auto Load GPS on Start
        window.addEventListener('load', () => {
            if(savedCities.length === 0 && navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(p => {
                    const gpsCity = { name: "Vị trí của bạn", lat: p.coords.latitude, lon: p.coords.longitude, isGPS: true };
                    savedCities.unshift(gpsCity); // Add to top temporarily
                    renderCityList();
                });
            }
            renderCityList();
        });

        async function addCityFromInput() {
            const input = document.getElementById('cityInput').value.trim();
            const err = document.getElementById('weatherError');
            if(!input) return;
            
            try {
                const res = await fetch(`https://geocoding-api.open-meteo.com/v1/search?name=${encodeURIComponent(input)}&count=1&language=vi&format=json`);
                const data = await res.json();
                if(!data.results) { err.textContent = "Không tìm thấy!"; return; }
                const c = data.results[0];
                savedCities.push({ name: c.name, lat: c.latitude, lon: c.longitude });
                localStorage.setItem('zenCities', JSON.stringify(savedCities.filter(c => !c.isGPS))); // Don't save temp GPS
                document.getElementById('cityInput').value = '';
                renderCityList();
            } catch(e) { err.textContent = "Lỗi mạng!"; }
        }

        function removeCity(i) {
            savedCities.splice(i, 1);
            localStorage.setItem('zenCities', JSON.stringify(savedCities.filter(c => !c.isGPS)));
            renderCityList();
        }

        function renderCityList() {
            document.getElementById('cityList').innerHTML = savedCities.map((c, i) => `
                <div class="flex justify-between items-center bg-black/20 p-2 rounded text-sm">
                    <span>${c.name} ${c.isGPS ? '(GPS)' : ''}</span>
                    <button onclick="removeCity(${i})" class="text-red-400 p-1"><i data-lucide="trash-2" class="w-4 h-4"></i></button>
                </div>
            `).join('');
        }

        // --- ZEN CLOCK & ANIMATIONS ---
        let currentClockStyle = 'digital';
        let currentAnim = 'none';

        function setClockStyle(style) {
            currentClockStyle = style;
            const clock = document.getElementById('clockText');
            clock.className = ''; // Reset
            if (style === 'digital') clock.classList.add('font-digital');
            if (style === 'elegant') clock.classList.add('font-elegant');
            if (style === 'neon') clock.classList.add('font-neon');
            if (style === 'retro') clock.classList.add('font-retro');
        }

        function setClockAnim(anim) { currentAnim = anim; }

        function updateClockDisplay() {
            const clockEl = document.getElementById('clockText');
            const labelEl = document.getElementById('focusLabel');
            
            if (focusActive) {
                const now = Date.now();
                const diff = focusEndTime - now;
                if (diff <= 0) {
                    stopFocus();
                    return;
                }
                const m = Math.floor(diff / 60000);
                const s = Math.floor((diff % 60000) / 1000);
                clockEl.textContent = `${m.toString().padStart(2,'0')}:${s.toString().padStart(2,'0')}`;
                labelEl.classList.remove('hidden');
                labelEl.textContent = "ĐANG TẬP TRUNG";
                clockEl.style.color = '#f472b6'; // Pink for focus
            } else {
                const now = new Date();
                const timeStr = now.toLocaleTimeString('vi-VN', {hour:'2-digit', minute:'2-digit'});
                
                // Animation Logic
                if (clockEl.textContent !== timeStr) {
                    if (currentAnim === 'fade') {
                        clockEl.parentElement.classList.add('anim-fade');
                        setTimeout(() => clockEl.parentElement.classList.remove('anim-fade'), 1000);
                    } else if (currentAnim === 'slide') {
                        clockEl.innerHTML = `<div class="anim-slide"><span>${timeStr}</span></div>`;
                        return; // HTML structure handled
                    } else if (currentAnim === 'flip') {
                        clockEl.parentElement.classList.add('anim-flip');
                        setTimeout(() => clockEl.parentElement.classList.remove('anim-flip'), 800);
                    }
                    clockEl.textContent = timeStr;
                }
                labelEl.classList.add('hidden');
                clockEl.style.color = ''; // Reset color
                document.getElementById('zenDate').textContent = now.toLocaleDateString('vi-VN', {weekday:'long', day:'numeric', month:'long'});
            }
        }
        setInterval(updateClockDisplay, 1000);

        // --- WEATHER WIDGET CAROUSEL ---
        async function fetchWeatherForZen() {
            const container = document.getElementById('zenWeather');
            if (savedCities.length === 0) { container.innerHTML = '<span class="text-xs italic opacity-50">Chưa có thời tiết</span>'; return; }
            
            let html = '';
            for (const city of savedCities) {
                try {
                    const res = await fetch(`https://api.open-meteo.com/v1/forecast?latitude=${city.lat}&longitude=${city.lon}&current_weather=true`);
                    const data = await res.json();
                    const w = data.current_weather;
                    const info = weatherCodeMap[w.weathercode] || {icon:'sun', text:''};
                    
                    // Create a slide item
                    html += `
                        <div class="flex flex-col items-center animate-fade-in mx-8 min-w-[120px]">
                            <div class="flex items-center gap-2 text-3xl font-light">
                                <i data-lucide="${info.icon}"></i>
                                <span>${Math.round(w.temperature)}°</span>
                            </div>
                            <div class="text-[10px] uppercase tracking-widest opacity-70 mt-1">${city.name} • ${info.text}</div>
                        </div>
                    `;
                } catch (e) {}
            }
            container.innerHTML = html;
            lucide.createIcons();
        }

        // --- ZEN TOGGLE & UTILS ---
        let zenMode = false;
        function toggleZenMode() {
            zenMode = !zenMode;
            const ui = document.getElementById('mainUI'), zen = document.getElementById('zenContainer');
            if(zenMode) { 
                ui.classList.add('ui-hidden'); zen.classList.remove('opacity-0', 'pointer-events-none'); 
                fetchWeatherForZen(); 
                document.getElementById('zenQuote').innerText = `"${getRandomQuote()}"`;
            } else { 
                ui.classList.remove('ui-hidden'); zen.classList.add('opacity-0', 'pointer-events-none'); 
            }
        }
        document.getElementById('zenContainer').addEventListener('click', (e) => {
            // Prevent accidental close if clicking specific widgets? No, user wants close on tap anywhere usually.
            if(zenMode) toggleZenMode();
        });

        function toggleSettings() {
            const m = document.getElementById('settingsModal');
            if(m.classList.contains('hidden')) { m.classList.remove('hidden'); setTimeout(()=>m.classList.remove('opacity-0'),10); renderCityList(); }
            else { m.classList.add('opacity-0'); setTimeout(()=>m.classList.add('hidden'),300); }
        }

        function updateZenConfig() {
            document.getElementById('zenWeather').style.display = document.getElementById('optWeather').checked ? 'flex' : 'none';
            document.getElementById('zenQuote').style.display = document.getElementById('optQuote').checked ? 'block' : 'none';
        }

        const zenQuotes = ["Hơi thở là chiếc neo giữ tâm trí.", "Tâm an vạn sự an.", "Mỗi hơi thở là cơ hội mới.", "Bình yên đến từ bên trong.", "Giây phút này là tất cả."];
        function getRandomQuote() { return zenQuotes[Math.floor(Math.random() * zenQuotes.length)]; }

        // --- VISUALIZERS (LAVA) ---
        const bgCtx = document.getElementById('bgCanvas').getContext('2d');
        const pCtx = document.getElementById('particleCanvas').getContext('2d');
        let w, h, particles = [], blobs = [];
        function resize() { w=window.innerWidth; h=window.innerHeight; bgCtx.canvas.width=w; bgCtx.canvas.height=h; pCtx.canvas.width=w; pCtx.canvas.height=h; initVisuals(); }
        window.addEventListener('resize', resize);
        function initVisuals() {
            particles = Array(80).fill().map(() => ({x:Math.random()*w, y:Math.random()*h, s:Math.random()*2, v:Math.random()+0.5}));
            blobs = Array(5).fill().map(() => ({x:Math.random()*w, y:Math.random()*h, r:Math.min(w,h)*0.4, dx:(Math.random()-.5)*.5, dy:(Math.random()-.5)*.5, c:{r:15,g:23,b:42}}));
        }
        const hex2rgb = h => ({r:parseInt(h.slice(1,3),16),g:parseInt(h.slice(3,5),16),b:parseInt(h.slice(5,7),16)});
        function updateVisualState() {} // Colors pulled dynamically in animate loop
        
        function animate() {
            const cols = []; Object.values(soundManager).forEach(s=>{if(s.isPlaying) cols.push(hex2rgb(s.config.color))});
            if(cols.length===0) cols.push({r:15,g:23,b:42}); // Default

            bgCtx.fillStyle='#0f172a'; bgCtx.fillRect(0,0,w,h);
            blobs.forEach((b,i)=>{
                b.x+=b.dx; b.y+=b.dy; if(b.x<0||b.x>w) b.dx*=-1; if(b.y<0||b.y>h) b.dy*=-1;
                const t = cols[i%cols.length];
                b.c.r+=(t.r-b.c.r)*0.02; b.c.g+=(t.g-b.c.g)*0.02; b.c.b+=(t.b-b.c.b)*0.02;
                const g=bgCtx.createRadialGradient(b.x,b.y,0,b.x,b.y,b.r);
                g.addColorStop(0,`rgba(${b.c.r},${b.c.g},${b.c.b},0.6)`); g.addColorStop(1,'transparent');
                bgCtx.fillStyle=g; bgCtx.beginPath(); bgCtx.arc(b.x,b.y,b.r,0,Math.PI*2); bgCtx.fill();
            });

            pCtx.clearRect(0,0,w,h);
            particles.forEach(p=>{
                pCtx.fillStyle=`rgba(255,255,255,0.3)`; pCtx.beginPath(); pCtx.arc(p.x,p.y,p.s,0,Math.PI*2); pCtx.fill();
                p.y+=p.v; if(p.y>h) p.y=0;
            });
            requestAnimationFrame(animate);
        }

        // Utils (Standard)
        function stopAllSounds() { Object.values(soundManager).forEach(s => s.stop()); if(isStoryPlaying) toggleStory(); if(isCustomPlaying) toggleCustomMedia(); }
        function switchTab(t) {
            document.getElementById('tab-wakeUp').classList.toggle('hidden', t!=='wakeUp');
            document.getElementById('tab-sleepNow').classList.toggle('hidden', t!=='sleepNow');
            document.getElementById('btn-wakeUp').className = t==='wakeUp'?"flex-1 py-2 text-xs font-medium rounded-md bg-white/10 text-white shadow":"flex-1 py-2 text-xs font-medium rounded-md text-gray-400";
            document.getElementById('btn-sleepNow').className = t==='sleepNow'?"flex-1 py-2 text-xs font-medium rounded-md bg-white/10 text-white shadow":"flex-1 py-2 text-xs font-medium rounded-md text-gray-400";
        }
        function calculateSleep(type) {
            const list = document.getElementById('timesList'); list.innerHTML='';
            let base = new Date();
            if(type==='wake') {
                const val = document.getElementById('wakeTimeInput').value; if(!val) return;
                const [h,m] = val.split(':'); base.setHours(h,m,0);
                if(base < new Date()) base.setDate(base.getDate()+1);
                [6,5,4,3].forEach(c => addTimeCard(new Date(base.getTime() - (c*90+14)*60000), c, list));
            } else {
                const sleep = new Date(base.getTime() + 14*60000);
                [3,4,5,6].forEach(c => addTimeCard(new Date(sleep.getTime() + c*90*60000), c, list));
            }
            document.getElementById('sleepResult').classList.remove('hidden');
        }
        function addTimeCard(d, c, el) { el.innerHTML += `<div class="bg-black/20 rounded p-2 border border-white/5"><div class="text-lg font-bold ${c>=5?'text-green-300':'text-purple-300'}">${d.toLocaleTimeString([],{hour:'2-digit',minute:'2-digit'})}</div><div class="text-[10px] text-gray-400">${c} chu kỳ</div></div>`; }
        function updateZenNowPlaying() {
            let names = []; if(isCustomPlaying) names.push("Media"); if(isStoryPlaying) names.push("Story");
            Object.values(soundManager).forEach(s => { if(s.isPlaying) names.push(s.config.name); });
            document.getElementById('nowPlayingText').innerText = names.length ? "Đang phát: " + names.join(", ") : "...";
            document.getElementById('zenNowPlaying').classList.toggle('hidden', names.length === 0);
        }

        // Story & Media
        let isStoryPlaying=false, isCustomPlaying=false;
        const storyAudio = new Audio('https://actions.google.com/sounds/v1/water/waves_crashing_on_rock_beach.ogg'); storyAudio.loop=true;
        function toggleStory() {
            const btn = document.getElementById('storyBtn');
            if(isStoryPlaying) { storyAudio.pause(); btn.innerHTML='<i data-lucide="play" class="w-5 h-5 fill-white text-white"></i>'; }
            else { storyAudio.play(); btn.innerHTML='<i data-lucide="pause" class="w-5 h-5 fill-white text-white"></i>'; }
            isStoryPlaying = !isStoryPlaying; updateZenNowPlaying();
        }
        let customMediaEl=null;
        function loadMediaFromUrl() {
            const url = document.getElementById('mediaUrlInput').value; if(!url) return;
            if(customMediaEl) customMediaEl.pause();
            customMediaEl = new Audio(url); customMediaEl.loop=true; document.getElementById('customPlayer').classList.remove('hidden'); toggleCustomMedia();
        }
        function toggleCustomMedia() { if(customMediaEl.paused) {customMediaEl.play(); isCustomPlaying=true;} else {customMediaEl.pause(); isCustomPlaying=false;} updateZenNowPlaying(); }
        function removeCustomMedia() { if(customMediaEl) customMediaEl.pause(); customMediaEl=null; isCustomPlaying=false; document.getElementById('customPlayer').classList.add('hidden'); }
        
        // Timer
        let tId, cId;
        function setManualTimer() {
            cancelTimer(); const min = parseInt(document.getElementById('timerInput').value); if(!min) return;
            const end = Date.now() + min*60000;
            cId = setInterval(() => {
                const rem = Math.ceil((end - Date.now())/1000);
                if(rem<=0) { cancelTimer(); stopAllSounds(); return; }
                document.getElementById('timerStatus').innerText = `Tắt sau: ${Math.floor(rem/60)}:${(rem%60).toString().padStart(2,'0')}`;
            }, 1000);
            tId = setTimeout(() => { stopAllSounds(); cancelTimer(); }, min*60000);
        }
        function cancelTimer() { clearTimeout(tId); clearInterval(cId); document.getElementById('timerStatus').innerText=""; }

        // Start
        lucide.createIcons(); resize(); animate(); 
        setClockStyle('digital'); // Default
    </script>
</body>
</html>