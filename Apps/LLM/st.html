<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Full HTML to JSON Parser</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
    </style>
</head>
<body class="bg-gray-100 h-screen flex flex-col">

    <header class="bg-emerald-700 text-white p-4 shadow-lg">
        <div class="container mx-auto flex justify-between items-center">
            <h1 class="text-xl font-bold">Công cụ tách TOÀN BỘ dữ liệu HTML</h1>
            <span class="text-xs bg-emerald-800 px-2 py-1 rounded">Version 2.0 (Full Data)</span>
        </div>
    </header>

    <main class="flex-grow container mx-auto p-4 gap-4 flex flex-col md:flex-row h-full">
        
        <div class="flex-1 flex flex-col bg-white rounded shadow border border-gray-300">
            <div class="p-2 bg-gray-50 border-b flex justify-between items-center">
                <span class="font-bold text-gray-600">HTML Đầu vào</span>
                <button onclick="document.getElementById('htmlInput').value=''" class="text-red-500 text-sm hover:underline">Xóa</button>
            </div>
            <textarea id="htmlInput" class="flex-grow p-3 text-xs font-mono focus:outline-none resize-none" placeholder="Dán mã HTML vào đây..."></textarea>
        </div>

        <div class="flex md:flex-col justify-center gap-2">
            <button onclick="convertFull()" class="bg-emerald-600 hover:bg-emerald-700 text-white font-bold py-3 px-6 rounded shadow transition">
                Chuyển đổi ➔
            </button>
        </div>

        <div class="flex-1 flex flex-col bg-white rounded shadow border border-gray-300">
             <div class="p-2 bg-gray-50 border-b flex justify-between items-center">
                <span class="font-bold text-gray-600">JSON Kết quả</span>
                <button onclick="copyToClipboard()" id="copyBtn" class="bg-emerald-100 text-emerald-800 text-xs px-2 py-1 rounded hover:bg-emerald-200">Copy</button>
            </div>
            <textarea id="jsonOutput" class="flex-grow p-3 text-xs font-mono bg-gray-50 focus:outline-none resize-none" readonly placeholder="JSON sẽ hiện ở đây..."></textarea>
        </div>

    </main>

    <script>
        function convertFull() {
            const htmlContent = document.getElementById('htmlInput').value;
            if (!htmlContent.trim()) { alert("Chưa có HTML!"); return; }

            const parser = new DOMParser();
            const doc = parser.parseFromString(htmlContent, 'text/html');

            const result = {
                metadata: {
                    extracted_at: new Date().toISOString(),
                    source_type: "Academic Transcript"
                },
                student_info: parseStudentInfo(doc),
                semester_summary: parseSummaryTable(doc), // Bảng tóm tắt (học phí, rèn luyện)
                detailed_transcript: parseDetailedTranscript(doc) // Bảng điểm chi tiết
            };

            document.getElementById('jsonOutput').value = JSON.stringify(result, null, 2);
        }

        // 1. Tách thông tin sinh viên
        function parseStudentInfo(doc) {
            const tds = Array.from(doc.querySelectorAll('td'));
            const getValue = (label) => {
                const cell = tds.find(td => td.textContent.includes(label));
                return cell ? (cell.querySelector('b')?.innerText.trim() || '') : '';
            };
            
            // Lấy mã SV từ input hoặc dropdown
            let svCode = doc.querySelector('input[name*="txtStudentCode"]')?.value;
            if (!svCode) svCode = doc.querySelector('select option[selected]')?.value;

            return {
                student_code: svCode || getValue('Mã sinh viên'),
                full_name: getValue('Họ tên:'),
                dob: getValue('Ngày sinh:'),
                gender: getValue('Giới tính:'),
                class: getValue('Lớp:'),
                cohort: getValue('Khoá:'),
                department: getValue('Khoa:'),
                major: getValue('Nghề:'),
                level: getValue('Bậc:'),
                type: getValue('Loại:')
            };
        }

        // 2. Tách bảng tổng hợp (Học phí, Rèn luyện,...)
        function parseSummaryTable(doc) {
            const tables = doc.querySelectorAll('.Learning_Content table');
            if (tables.length < 1) return [];

            const summaryRows = Array.from(tables[0].querySelectorAll('tr')).slice(1); // Bỏ header
            
            return summaryRows.map(row => {
                const cols = row.querySelectorAll('td');
                if (cols.length < 10) return null;
                
                const getTxt = (idx) => cols[idx]?.innerText.trim() || null;

                return {
                    stt: getTxt(0),
                    academic_year: getTxt(1),
                    semester: getTxt(2),
                    financial: {
                        tuition_fee: getTxt(3),
                        paid: getTxt(4)
                    },
                    status: {
                        discipline: getTxt(5),
                        reward: getTxt(6)
                    },
                    scholarship: {
                        rank: getTxt(7),
                        amount: getTxt(8)
                    },
                    conduct: {
                        score: getTxt(9),
                        rank: getTxt(10)
                    }
                };
            }).filter(item => item !== null);
        }

        // 3. Tách bảng điểm chi tiết (Toàn bộ cột)
        function parseDetailedTranscript(doc) {
            const transcript = [];
            let currentSem = null;
            const tables = doc.querySelectorAll('.Learning_Content table');
            
            // Bảng điểm thường là bảng thứ 2
            if (tables.length < 2) return [];
            const rows = tables[1].querySelectorAll('tr');

            rows.forEach(row => {
                // Xử lý dòng tiêu đề học kỳ
                if (row.classList.contains('Learning_GroupRow')) {
                    if (currentSem) transcript.push(currentSem);

                    const text = row.innerText; 
                    currentSem = {
                        semester_header: {
                            raw_string: text,
                            year: text.match(/Niên học:\s*([^\s-]+)/)?.[1] || "",
                            semester: text.match(/Học kì:\s*(\d+)/)?.[1] || "",
                            avg_score: parseFloat(text.match(/TBHK\s*:\s*([\d\.]+)/)?.[1] || 0),
                            rank: text.match(/XLHK:\s*(.*)/)?.[1]?.trim() || ""
                        },
                        subjects: []
                    };
                } 
                // Xử lý dòng môn học
                else if (!row.classList.contains('Learning_Header') && currentSem) {
                    const cells = row.querySelectorAll('td');
                    // Cấu trúc bảng có 25 cột (dựa trên HTML bạn gửi)
                    if (cells.length >= 24) {
                        const getVal = (idx) => cells[idx]?.innerText.trim() || null;
                        const getNum = (idx) => {
                            const val = getVal(idx);
                            return val ? parseFloat(val) : null;
                        };

                        // Helper lấy mảng điểm từ cột start đến end
                        const getArrayScores = (start, end) => {
                            let arr = [];
                            for(let i=start; i<=end; i++) {
                                let val = getNum(i);
                                if(val !== null) arr.push({ col: i-start+1, score: val });
                            }
                            return arr;
                        };

                        currentSem.subjects.push({
                            stt: getVal(0),
                            subject_name: getVal(1),
                            credits: getNum(2),
                            components: {
                                // Cột 3 -> 9: Kiểm tra thường xuyên (7 cột)
                                regular_tests: getArrayScores(3, 9), 
                                // Cột 10 -> 16: Kiểm tra định kỳ (7 cột)
                                periodic_tests: getArrayScores(10, 16),
                                // Cột 17: Trung bình kiểm tra
                                test_avg: getNum(17) 
                            },
                            exams: {
                                l1: getNum(18),
                                l2: getNum(19),
                                l3: getNum(20)
                            },
                            final_summary: {
                                l1: getNum(21),
                                l2: getNum(22),
                                l3: getNum(23)
                            },
                            result: getVal(24) // Cột KQ
                        });
                    }
                }
            });

            if (currentSem) transcript.push(currentSem);
            return transcript;
        }

        function copyToClipboard() {
            const output = document.getElementById('jsonOutput');
            output.select();
            document.execCommand('copy');
            const btn = document.getElementById('copyBtn');
            btn.innerText = "Đã chép";
            setTimeout(() => btn.innerText = "Copy", 2000);
        }
    </script>
</body>
</html>