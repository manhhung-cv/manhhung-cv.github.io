<!DOCTYPE html>
<html lang="vi">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Trình Theo Dõi Mục Tiêu - Minimal</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600&display=swap" rel="stylesheet">
    <style>
        /* --- VARIABLES --- */
        :root {
            --bg-body: #fafafa;
            --bg-card: #ffffff;
            --text-main: #171717;
            --text-secondary: #737373;
            --border-color: #e5e5e5;
            --primary: #171717; /* Đen tuyền */
            --primary-text: #ffffff;
            --danger: #ef4444;
            --success: #10b981;
            --radius: 12px;
            --shadow: 0 1px 3px rgba(0,0,0,0.05);
            --modal-overlay: rgba(255, 255, 255, 0.8);
            --font-main: 'Inter', -apple-system, sans-serif;
        }

        body.dark-mode {
            --bg-body: #0a0a0a;
            --bg-card: #171717;
            --text-main: #ededed;
            --text-secondary: #a1a1a1;
            --border-color: #333333;
            --primary: #ededed; /* Trắng */
            --primary-text: #000000;
            --modal-overlay: rgba(0, 0, 0, 0.8);
        }

        /* --- BASE RESET --- */
        * { box-sizing: border-box; }
        body {
            font-family: var(--font-main);
            background-color: var(--bg-body);
            color: var(--text-main);
            margin: 0;
            padding: 40px 20px;
            transition: background-color 0.3s ease, color 0.3s ease;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        /* --- HEADER --- */
        .header {
            width: 100%;
            max-width: 800px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 60px;
            padding-bottom: 20px;
            border-bottom: 1px solid var(--border-color);
        }

        h1 {
            font-weight: 600;
            font-size: 1.5rem;
            letter-spacing: -0.02em;
            margin: 0;
        }

        .dark-mode-toggle {
            background: transparent;
            border: 1px solid var(--border-color);
            color: var(--text-main);
            padding: 10px;
            border-radius: 50%;
            cursor: pointer;
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
        }

        .dark-mode-toggle:hover {
            background-color: var(--border-color);
        }

        /* --- LAYOUT --- */
        .goals-container {
            width: 100%;
            max-width: 800px;
            display: flex;
            flex-direction: column;
            gap: 24px;
            margin-bottom: 100px;
        }

        /* --- CARD STYLE --- */
        .goal-card {
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            border-radius: var(--radius);
            padding: 24px;
            display: flex;
            flex-direction: column;
            gap: 20px;
            transition: transform 0.2s ease, box-shadow 0.2s ease;
        }

        .goal-card:hover {
            box-shadow: 0 10px 30px -10px rgba(0,0,0,0.08);
            border-color: var(--text-secondary);
        }

        .goal-card-header {
            display: flex;
            gap: 20px;
            align-items: flex-start;
        }

        .goal-card-image {
            width: 60px;
            height: 60px;
            border-radius: 8px;
            object-fit: cover;
            background-color: var(--bg-body);
            border: 1px solid var(--border-color);
        }

        .goal-card-info {
            flex: 1;
        }

        .goal-card-info h3 {
            margin: 0 0 4px 0;
            font-size: 1.1rem;
            font-weight: 600;
        }

        .goal-card-info p {
            margin: 0;
            font-size: 0.85rem;
            color: var(--text-secondary);
        }

        /* --- PROGRESS BAR --- */
        .goal-card-progress-bar {
            width: 100%;
            height: 4px; /* Thin line */
            background-color: var(--border-color);
            border-radius: 2px;
            overflow: hidden;
            margin-top: 8px;
        }

        .goal-card-progress-fill {
            height: 100%;
            background-color: var(--primary);
            width: 0%;
            transition: width 0.6s ease;
        }

        .goal-card.completed .goal-card-progress-fill {
            background-color: var(--success);
        }

        .goal-card-progress-text {
            font-size: 0.85rem;
            margin-top: 8px;
            color: var(--text-secondary);
            display: flex;
            justify-content: space-between;
        }

        .goal-card-progress-text span.current {
            color: var(--text-main);
            font-weight: 500;
        }

        /* --- BUTTONS --- */
        .goal-card-actions {
            display: flex;
            gap: 12px;
            margin-top: 10px;
            border-top: 1px solid var(--border-color);
            padding-top: 15px;
        }

        .button {
            border: 1px solid var(--border-color);
            background: transparent;
            color: var(--text-main);
            padding: 8px 16px;
            font-size: 0.85rem;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.2s;
            display: inline-flex;
            align-items: center;
            gap: 6px;
            font-weight: 500;
        }

        .button:hover {
            border-color: var(--text-main);
            background-color: var(--bg-body);
        }

        .button.primary {
            background-color: var(--primary);
            color: var(--primary-text);
            border-color: var(--primary);
        }

        .button.primary:hover {
            opacity: 0.9;
            transform: translateY(-1px);
        }

        .button.danger {
            color: var(--danger);
            border-color: var(--border-color);
        }
        
        .button.danger:hover {
            background-color: rgba(239, 68, 68, 0.05);
            border-color: var(--danger);
        }

        /* --- FAB --- */
        .fab-button {
            position: fixed;
            bottom: 40px;
            right: 40px;
            width: 56px;
            height: 56px;
            background-color: var(--primary);
            color: var(--primary-text);
            border-radius: 50%;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 1.5rem;
            cursor: pointer;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            transition: transform 0.2s;
            z-index: 99;
        }

        .fab-button:hover {
            transform: scale(1.05);
        }

        /* --- MODALS --- */
        .modal-overlay {
            position: fixed;
            top: 0; left: 0;
            width: 100%; height: 100%;
            background-color: var(--modal-overlay);
            backdrop-filter: blur(5px);
            display: flex;
            justify-content: center;
            align-items: center;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s;
            z-index: 1000;
        }

        .modal-overlay.active {
            opacity: 1;
            visibility: visible;
        }

        .modal-content {
            background-color: var(--bg-card);
            border: 1px solid var(--border-color);
            padding: 40px;
            border-radius: var(--radius);
            width: 90%;
            max-width: 500px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            position: relative;
            transform: translateY(20px);
            transition: transform 0.3s;
        }

        .modal-overlay.active .modal-content {
            transform: translateY(0);
        }

        .modal-content h2 {
            margin-top: 0;
            margin-bottom: 25px;
            font-size: 1.25rem;
            text-align: left;
            border-bottom: 1px solid var(--border-color);
            padding-bottom: 15px;
        }

        .modal-close-button {
            position: absolute;
            top: 20px;
            right: 20px;
            background: none;
            border: none;
            cursor: pointer;
            color: var(--text-secondary);
            font-size: 1.2rem;
        }

        /* --- FORMS --- */
        .form-group { margin-bottom: 18px; }
        .form-group label {
            display: block;
            margin-bottom: 6px;
            font-size: 0.85rem;
            font-weight: 500;
            color: var(--text-secondary);
        }

        input[type="text"], input[type="date"], select, textarea {
            width: 100%;
            padding: 10px 12px;
            background: var(--bg-body);
            border: 1px solid var(--border-color);
            border-radius: 6px;
            color: var(--text-main);
            font-family: var(--font-main);
            font-size: 0.95rem;
            outline: none;
            transition: border-color 0.2s;
        }

        input:focus, select:focus, textarea:focus {
            border-color: var(--text-main);
        }

        /* --- IMAGE SWITCH --- */
        .image-option-switch {
            display: flex;
            border-bottom: 1px solid var(--border-color);
            margin-bottom: 15px;
        }
        
        .image-option-switch .switch-option {
            padding: 8px 15px;
            font-size: 0.85rem;
            cursor: pointer;
            color: var(--text-secondary);
            border-bottom: 2px solid transparent;
        }
        
        .image-option-switch .switch-option.active {
            color: var(--text-main);
            border-bottom-color: var(--text-main);
            font-weight: 500;
        }

        .image-preview {
            width: 100%;
            height: 150px;
            object-fit: contain;
            background: var(--bg-body);
            border: 1px solid var(--border-color);
            border-radius: 6px;
            margin-top: 10px;
            display: none;
        }

        /* --- EMPTY STATE --- */
        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: var(--text-secondary);
        }
        .empty-state i {
            font-size: 2rem;
            margin-bottom: 15px;
            opacity: 0.5;
        }

        /* --- NOTIFICATION --- */
        #messageBox {
            position: fixed;
            bottom: 30px;
            left: 50%;
            transform: translateX(-50%) translateY(20px);
            background: var(--primary);
            color: var(--primary-text);
            padding: 10px 20px;
            border-radius: 30px;
            font-size: 0.9rem;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s;
            z-index: 2000;
        }
        #messageBox.active {
            opacity: 1;
            visibility: visible;
            transform: translateX(-50%) translateY(0);
        }
        
        /* Spinner */
        .spinner {
            border: 2px solid rgba(255,255,255,0.3);
            border-radius: 50%;
            border-top: 2px solid #fff;
            width: 16px; height: 16px;
            animation: spin 1s linear infinite;
            display: none;
        }
        .button.loading .spinner { display: inline-block; }
        .button.loading .button-text { display: none; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>

<body>
    <div class="header">
        <h1>Mục Tiêu.</h1>
        <button id="darkModeToggle" class="dark-mode-toggle" aria-label="Toggle dark mode">
            <i class="fas fa-moon"></i>
        </button>
    </div>

    <div class="goals-container" id="goalsContainer">
        </div>

    <div id="addGoalFab" class="fab-button" onclick="openModal('newGoalModal')">
        <i class="fas fa-plus"></i>
    </div>

    <div id="messageBox"></div>

    <div id="newGoalModal" class="modal-overlay">
        <div class="modal-content">
            <button class="modal-close-button" onclick="closeModal('newGoalModal')"><i class="fas fa-times"></i></button>
            <h2>Mục tiêu mới</h2>
            <form id="goalForm">
                <div class="form-group">
                    <label>Hình ảnh</label>
                    <div class="image-option-switch" data-form-type="new">
                        <div class="switch-option active" data-option="url">Link ảnh</div>
                        <div class="switch-option" data-option="upload">Tải lên</div>
                    </div>
                    <div id="imageURLInputContainer_new">
                        <input type="text" id="goalImageURL_new" placeholder="https://...">
                    </div>
                    <div id="imageUploadInputContainer_new" style="display: none;">
                        <input type="file" id="goalImageUpload_new" accept="image/*">
                    </div>
                    <img id="imagePreview_new" class="image-preview" alt="Preview">
                </div>
                <div class="form-group">
                    <label>Tên mục tiêu</label>
                    <input type="text" id="goalName_new" required placeholder="Mua nhà, chạy bộ...">
                </div>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                    <div class="form-group">
                        <label>Loại</label>
                        <select id="goalType_new" required>
                            <option value="money">Tiền tệ</option>
                            <option value="steps">Bước chân</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Đích đến</label>
                        <input type="text" id="goalTarget_new" required placeholder="0">
                    </div>
                </div>
                <div class="form-group">
                    <label>Hạn chót (Tùy chọn)</label>
                    <input type="date" id="goalDeadline_new">
                </div>
                <div class="form-group">
                    <label>Ghi chú</label>
                    <textarea id="goalNotes_new" rows="3"></textarea>
                </div>
                <div style="text-align: right;">
                    <button type="submit" class="button primary">
                        <span class="button-text">Tạo mục tiêu</span>
                        <div class="spinner"></div>
                    </button>
                </div>
            </form>
        </div>
    </div>

    <div id="editGoalModal" class="modal-overlay">
        <div class="modal-content">
            <button class="modal-close-button" onclick="closeModal('editGoalModal')"><i class="fas fa-times"></i></button>
            <h2>Sửa mục tiêu</h2>
            <form id="editGoalForm">
                <input type="hidden" id="editGoalId">
                <div class="form-group">
                    <label>Hình ảnh</label>
                    <div class="image-option-switch" data-form-type="edit">
                        <div class="switch-option active" data-option="url">Link ảnh</div>
                        <div class="switch-option" data-option="upload">Tải lên</div>
                    </div>
                    <div id="imageURLInputContainer_edit">
                        <input type="text" id="goalImageURL_edit" placeholder="https://...">
                    </div>
                    <div id="imageUploadInputContainer_edit" style="display: none;">
                        <input type="file" id="goalImageUpload_edit" accept="image/*">
                    </div>
                    <img id="imagePreview_edit" class="image-preview" alt="Preview">
                </div>
                <div class="form-group">
                    <label>Tên mục tiêu</label>
                    <input type="text" id="goalName_edit" required>
                </div>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                    <div class="form-group">
                        <label>Loại</label>
                        <select id="goalType_edit" required>
                            <option value="money">Tiền tệ</option>
                            <option value="steps">Bước chân</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Đích đến</label>
                        <input type="text" id="goalTarget_edit" required>
                    </div>
                </div>
                <div class="form-group">
                    <label>Hạn chót</label>
                    <input type="date" id="goalDeadline_edit">
                </div>
                <div class="form-group">
                    <label>Ghi chú</label>
                    <textarea id="goalNotes_edit" rows="3"></textarea>
                </div>
                <div style="text-align: right;">
                    <button type="submit" class="button primary">
                        <span class="button-text">Lưu thay đổi</span>
                        <div class="spinner"></div>
                    </button>
                </div>
            </form>
        </div>
    </div>

    <div id="progressModal" class="modal-overlay">
        <div class="modal-content">
            <button class="modal-close-button" onclick="closeModal('progressModal')"><i class="fas fa-times"></i></button>
            <h2>Cập nhật tiến độ</h2>
            <form id="progressForm">
                <input type="hidden" id="progressGoalId">
                <div class="form-group">
                    <label>Hiện tại</label>
                    <input type="text" id="currentProgressDisplay" readonly style="background: var(--bg-body); opacity: 0.7;">
                </div>
                <div style="display: grid; grid-template-columns: 1fr 100px; gap: 15px;">
                     <div class="form-group">
                        <label>Số lượng</label>
                        <input type="text" id="progressAmount" required placeholder="Nhập số...">
                    </div>
                    <div class="form-group">
                        <label>Thao tác</label>
                        <select id="progressType" required>
                            <option value="add">Thêm</option>
                            <option value="subtract">Bớt</option>
                        </select>
                    </div>
                </div>
                <div style="text-align: right; margin-top: 20px;">
                    <button type="button" class="button" onclick="closeModal('progressModal')" style="margin-right: 10px;">Hủy</button>
                    <button type="submit" class="button primary">
                        <span class="button-text">Cập nhật</span>
                        <div class="spinner"></div>
                    </button>
                </div>
            </form>
        </div>
    </div>

    <div id="historyModal" class="modal-overlay">
        <div class="modal-content">
            <button class="modal-close-button" onclick="closeModal('historyModal')"><i class="fas fa-times"></i></button>
            <h2>Lịch sử</h2>
            <div id="historyList" style="max-height: 300px; overflow-y: auto; border: 1px solid var(--border-color); border-radius: 6px; padding: 0;">
                </div>
            <div style="text-align: right; margin-top: 20px;">
                <button type="button" class="button" onclick="closeModal('historyModal')">Đóng</button>
            </div>
        </div>
    </div>

    <script>
        // --- JAVASCRIPT LOGIC (GIỮ NGUYÊN CORE LOGIC, CHỈ CHỈNH UI RENDER) ---
        let goals = [];
        let darkModeEnabled = false;

        const goalsContainer = document.getElementById('goalsContainer');
        const darkModeToggle = document.getElementById('darkModeToggle');
        const messageBox = document.getElementById('messageBox');
        const goalForm = document.getElementById('goalForm');
        const editGoalForm = document.getElementById('editGoalForm');
        const progressForm = document.getElementById('progressForm');

        document.addEventListener('DOMContentLoaded', () => {
            loadDarkMode();
            loadGoals();
            applyDarkMode();
            renderGoals();

            darkModeToggle.addEventListener('click', toggleDarkMode);
            goalForm.addEventListener('submit', handleCreateGoal);
            editGoalForm.addEventListener('submit', handleSaveChanges);
            progressForm.addEventListener('submit', handleUpdateProgress);

            ['goalTarget_new', 'goalTarget_edit', 'progressAmount'].forEach(id => {
                document.getElementById(id).addEventListener('input', formatNumberInput);
            });

            setupImageInput('new');
            setupImageInput('edit');

            document.querySelectorAll('.modal-overlay').forEach(modal => {
                modal.addEventListener('click', (e) => {
                    if (e.target === modal) closeModal(modal.id);
                });
            });
        });

        function saveGoals() { localStorage.setItem('goals_minimal', JSON.stringify(goals)); }
        function loadGoals() {
            const storedGoals = localStorage.getItem('goals_minimal') || localStorage.getItem('goals'); // Fallback to old key if needed
            if (storedGoals) goals = JSON.parse(storedGoals);
        }
        function saveDarkMode() { localStorage.setItem('darkMode_minimal', JSON.stringify(darkModeEnabled)); }
        function loadDarkMode() {
            const storedDarkMode = localStorage.getItem('darkMode_minimal');
            if (storedDarkMode !== null) darkModeEnabled = JSON.parse(storedDarkMode);
        }

        function handleCreateGoal(event) {
            event.preventDefault();
            const btn = event.target.querySelector('button[type="submit"]');
            showLoading(btn);

            // Simple delay to simulate processing and show spinner
            setTimeout(() => {
                const name = document.getElementById('goalName_new').value.trim();
                const type = document.getElementById('goalType_new').value;
                const target = parseFloat(document.getElementById('goalTarget_new').value.replace(/\./g, ''));
                const deadline = document.getElementById('goalDeadline_new').value;
                const notes = document.getElementById('goalNotes_new').value.trim();
                const imageFile = document.getElementById('goalImageUpload_new').files[0];
                let imageURL = document.getElementById('goalImageURL_new').value.trim();

                if (!name || !type || isNaN(target) || target <= 0) {
                    showMessage('Vui lòng kiểm tra lại thông tin.');
                    hideLoading(btn);
                    return;
                }

                const finalize = (imgSrc) => {
                    goals.unshift({
                        id: crypto.randomUUID(),
                        name, type, target, deadline, notes, image: imgSrc,
                        currentAmount: 0, currentSteps: 0, history: [],
                        createdAt: new Date().toISOString()
                    });
                    saveGoals(); renderGoals();
                    resetAndCloseForm(goalForm, 'newGoalModal', 'new');
                    showMessage('Đã tạo mục tiêu mới');
                    hideLoading(btn);
                };

                if (imageFile) {
                    const reader = new FileReader();
                    reader.onload = (e) => finalize(e.target.result);
                    reader.readAsDataURL(imageFile);
                } else {
                    finalize(imageURL);
                }
            }, 300);
        }

        function handleSaveChanges(event) {
            event.preventDefault();
            const btn = event.target.querySelector('button[type="submit"]');
            showLoading(btn);

            const goalId = document.getElementById('editGoalId').value;
            const name = document.getElementById('goalName_edit').value.trim();
            const type = document.getElementById('goalType_edit').value;
            const target = parseFloat(document.getElementById('goalTarget_edit').value.replace(/\./g, ''));
            const deadline = document.getElementById('goalDeadline_edit').value;
            const notes = document.getElementById('goalNotes_edit').value.trim();
            const imageFile = document.getElementById('goalImageUpload_edit').files[0];
            let imageURL = document.getElementById('goalImageURL_edit').value.trim();

            const idx = goals.findIndex(g => g.id === goalId);
            if (idx === -1) { hideLoading(btn); return; }

            const finalize = (imgSrc) => {
                goals[idx] = { ...goals[idx], name, type, target, deadline, notes, image: imgSrc };
                saveGoals(); renderGoals();
                resetAndCloseForm(editGoalForm, 'editGoalModal', 'edit');
                showMessage('Đã cập nhật mục tiêu');
                hideLoading(btn);
            };

            if (imageFile) {
                const reader = new FileReader();
                reader.onload = (e) => finalize(e.target.result);
                reader.readAsDataURL(imageFile);
            } else {
                finalize(imageURL);
            }
        }

        function handleUpdateProgress(event) {
            event.preventDefault();
            const btn = event.target.querySelector('button[type="submit"]');
            showLoading(btn);

            const goalId = document.getElementById('progressGoalId').value;
            const amount = parseFloat(document.getElementById('progressAmount').value.replace(/\./g, ''));
            const type = document.getElementById('progressType').value;

            const idx = goals.findIndex(g => g.id === goalId);
            if (idx > -1 && !isNaN(amount)) {
                const goal = goals[idx];
                const key = goal.type === 'money' ? 'currentAmount' : 'currentSteps';
                const oldVal = goal[key] || 0;
                const newVal = type === 'add' ? oldVal + amount : Math.max(0, oldVal - amount);
                
                goal[key] = newVal;
                goal.history.push({
                    date: new Date().toISOString(), type: type === 'add' ? 'Thêm' : 'Bớt',
                    amount, oldValue: oldVal, newValue: newVal, unit: goal.type === 'money' ? 'VNĐ' : 'bước'
                });
                
                saveGoals(); renderGoals();
                closeModal('progressModal');
                showMessage('Cập nhật thành công');
            }
            hideLoading(btn);
        }

        window.deleteGoal = function (id) {
            if(confirm('Xóa mục tiêu này?')) {
                goals = goals.filter(g => g.id !== id);
                saveGoals(); renderGoals();
                showMessage('Đã xóa mục tiêu');
            }
        }

        function renderGoals() {
            goalsContainer.innerHTML = '';
            if (goals.length === 0) {
                goalsContainer.innerHTML = `
                    <div class="empty-state">
                        <i class="far fa-circle"></i>
                        <h3>Danh sách trống</h3>
                        <p>Bắt đầu bằng cách tạo mục tiêu đầu tiên của bạn.</p>
                    </div>`;
                return;
            }

            goals.forEach(goal => {
                const current = goal.type === 'money' ? goal.currentAmount : goal.currentSteps;
                const pct = goal.target > 0 ? Math.min(100, (current / goal.target * 100)).toFixed(1) : 0;
                const isDone = pct >= 100;
                const img = goal.image || 'https://via.placeholder.com/60/f0f0f0/cccccc?text=+';

                const el = document.createElement('div');
                el.className = `goal-card ${isDone ? 'completed' : ''}`;
                el.innerHTML = `
                    <div class="goal-card-header">
                        <img src="${img}" class="goal-card-image" onerror="this.src='https://via.placeholder.com/60'">
                        <div class="goal-card-info">
                            <h3>${escapeHtml(goal.name)}</h3>
                            <p>${calculateRemainingDays(goal.deadline)} &bull; ${goal.type === 'money' ? 'Tài chính' : 'Sức khỏe'}</p>
                        </div>
                    </div>
                    <div>
                        <div class="goal-card-progress-bar">
                            <div class="goal-card-progress-fill" style="width: ${pct}%;"></div>
                        </div>
                        <div class="goal-card-progress-text">
                            <span class="current">${formatNumber(current)} / ${formatNumber(goal.target)}</span>
                            <span>${pct}%</span>
                        </div>
                    </div>
                    <div class="goal-card-actions">
                        <button class="button" onclick="openProgressModal('${goal.id}')"><i class="fas fa-plus"></i> Cập nhật</button>
                        <button class="button" onclick="openEditModal('${goal.id}')"><i class="fas fa-pen"></i></button>
                        <button class="button" onclick="openHistoryModal('${goal.id}')"><i class="fas fa-clock"></i></button>
                        <button class="button danger" onclick="deleteGoal('${goal.id}')"><i class="fas fa-trash"></i></button>
                    </div>
                `;
                goalsContainer.appendChild(el);
            });
        }

        // --- HELPERS ---
        window.openEditModal = (id) => {
            const g = goals.find(x => x.id === id);
            if(!g) return;
            
            document.getElementById('editGoalId').value = g.id;
            document.getElementById('goalName_edit').value = g.name;
            document.getElementById('goalType_edit').value = g.type;
            document.getElementById('goalTarget_edit').value = formatNumber(g.target);
            document.getElementById('goalDeadline_edit').value = g.deadline;
            document.getElementById('goalNotes_edit').value = g.notes;

            const prev = document.getElementById('imagePreview_edit');
            const urlInput = document.getElementById('goalImageURL_edit');
            document.getElementById('goalImageUpload_edit').value = '';
            
            if(g.image) {
                prev.src = g.image;
                prev.style.display = 'block';
                if(g.image.startsWith('data:')) toggleImageInput('upload', 'edit');
                else { urlInput.value = g.image; toggleImageInput('url', 'edit'); }
            } else {
                prev.style.display = 'none';
                urlInput.value = '';
                toggleImageInput('url', 'edit');
            }
            openModal('editGoalModal');
        }

        window.openProgressModal = (id) => {
            const g = goals.find(x => x.id === id);
            if(!g) return;
            document.getElementById('progressGoalId').value = id;
            const cur = g.type === 'money' ? g.currentAmount : g.currentSteps;
            const unit = g.type === 'money' ? 'VNĐ' : 'bước';
            document.getElementById('currentProgressDisplay').value = `${formatNumber(cur)} ${unit}`;
            document.getElementById('progressAmount').value = '';
            openModal('progressModal');
        }

        window.openHistoryModal = (id) => {
            const g = goals.find(x => x.id === id);
            const list = document.getElementById('historyList');
            list.innerHTML = '';
            if(!g || !g.history || g.history.length === 0) {
                list.innerHTML = '<div style="padding: 20px; text-align: center; color: var(--text-secondary)">Chưa có dữ liệu</div>';
            } else {
                [...g.history].reverse().forEach(h => {
                    const row = document.createElement('div');
                    row.style.padding = '12px 15px';
                    row.style.borderBottom = '1px solid var(--border-color)';
                    row.style.fontSize = '0.9rem';
                    row.innerHTML = `
                        <div style="display:flex; justify-content:space-between; margin-bottom: 4px;">
                            <strong>${h.type === 'Thêm' ? '+' : '-'}${formatNumber(h.amount)}</strong>
                            <span style="color:var(--text-secondary)">${new Date(h.date).toLocaleDateString('vi-VN')}</span>
                        </div>
                        <div style="font-size: 0.8rem; color: var(--text-secondary)">
                            ${formatNumber(h.oldValue)} ➝ ${formatNumber(h.newValue)}
                        </div>
                    `;
                    list.appendChild(row);
                });
            }
            openModal('historyModal');
        }

        function toggleDarkMode() {
            darkModeEnabled = !darkModeEnabled;
            saveDarkMode(); applyDarkMode();
        }
        function applyDarkMode() {
            document.body.classList.toggle('dark-mode', darkModeEnabled);
            darkModeToggle.innerHTML = darkModeEnabled ? '<i class="fas fa-sun"></i>' : '<i class="fas fa-moon"></i>';
        }
        function formatNumber(n) { return (n || 0).toLocaleString('vi-VN'); }
        function formatNumberInput(e) {
            let v = e.target.value.replace(/\D/g, '');
            e.target.value = v ? parseFloat(v).toLocaleString('vi-VN') : '';
        }
        function calculateRemainingDays(d) {
            if(!d) return 'Không thời hạn';
            const diff = new Date(d).setHours(23,59,59) - new Date();
            const days = Math.ceil(diff / 86400000);
            return days < 0 ? 'Đã quá hạn' : (days === 0 ? 'Hôm nay' : `${days} ngày còn lại`);
        }
        function escapeHtml(s) { return (s || '').replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;"); }
        window.openModal = (id) => document.getElementById(id).classList.add('active');
        window.closeModal = (id) => document.getElementById(id).classList.remove('active');
        function showMessage(msg) {
            messageBox.textContent = msg; messageBox.classList.add('active');
            setTimeout(() => messageBox.classList.remove('active'), 3000);
        }
        function showLoading(btn) { btn.disabled = true; btn.classList.add('loading'); }
        function hideLoading(btn) { btn.disabled = false; btn.classList.remove('loading'); }

        function setupImageInput(type) {
            const box = document.querySelector(`.image-option-switch[data-form-type="${type}"]`);
            const opts = box.querySelectorAll('.switch-option');
            const urlInput = document.getElementById(`imageURLInputContainer_${type}`);
            const upInput = document.getElementById(`imageUploadInputContainer_${type}`);
            
            opts.forEach(opt => opt.addEventListener('click', () => {
                opts.forEach(o => o.classList.remove('active'));
                opt.classList.add('active');
                toggleImageInput(opt.dataset.option, type);
            }));

            const fInput = document.getElementById(`goalImageUpload_${type}`);
            const pView = document.getElementById(`imagePreview_${type}`);
            
            fInput.addEventListener('change', () => {
                if(fInput.files[0]) {
                    const r = new FileReader();
                    r.onload = e => { pView.src = e.target.result; pView.style.display = 'block'; };
                    r.readAsDataURL(fInput.files[0]);
                }
            });
            
            document.getElementById(`goalImageURL_${type}`).addEventListener('input', (e) => {
                if(e.target.value.trim()) {
                    pView.src = e.target.value; pView.style.display = 'block';
                } else pView.style.display = 'none';
            });
        }

        function toggleImageInput(opt, type) {
            const uWrap = document.getElementById(`imageURLInputContainer_${type}`);
            const fWrap = document.getElementById(`imageUploadInputContainer_${type}`);
            if(opt === 'url') { uWrap.style.display = 'block'; fWrap.style.display = 'none'; }
            else { uWrap.style.display = 'none'; fWrap.style.display = 'block'; }
        }

        function resetAndCloseForm(form, modalId, type) {
            form.reset();
            const p = document.getElementById(`imagePreview_${type}`);
            if(p) { p.style.display = 'none'; p.src = ''; }
            // Reset switch visual
            const opts = document.querySelectorAll(`.image-option-switch[data-form-type="${type}"] .switch-option`);
            opts.forEach(o => o.classList.remove('active'));
            opts[0].classList.add('active'); // Default to URL
            toggleImageInput('url', type);
            closeModal(modalId);
        }
    </script>
</body>
</html>