<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Danh s√°ch ∆∞·ªõc m∆°</title>
    <meta name="description" content="Qu·∫£n l√Ω ∆∞·ªõc m∆°">
    <meta name="author" content="Hunq">
    <meta name="theme-color" content="#000000">
    <meta name="robots" content="index, follow">
    <link rel="canonical" href="mhung.siite">
    <link rel="icon" href="/Asset/logo/logo.png">

    <meta property="og:url" content="mhung.siite">
    <meta property="og:type" content="website">
    <meta property="og:title" content="Danh s√°ch ∆∞·ªõc m∆°">
    <meta property="og:description" content="Qu·∫£n l√Ω ∆∞·ªõc m∆°">
    <meta property="og:image" content="/Asset/Banner/Banner.png">

    <meta name="twitter:card" content="summary_large_image">
    <meta property="twitter:domain" content="mhung.siite">
    <meta property="twitter:url" content="mhung.siite">
    <meta name="twitter:title" content="Danh s√°ch ∆∞·ªõc m∆°">
    <meta name="twitter:description" content="Qu·∫£n l√Ω ∆∞·ªõc m∆°">
    <meta name="twitter:image" content="/Asset/Banner/Banner.png">

    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <meta name="apple-mobile-web-app-title" content="Danh s√°ch ∆∞·ªõc m∆°">
    <link rel="apple-touch-icon" href="/Asset/logo/logo.png">
    <title>Danh S√°ch ∆Ø·ªõc M∆°</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    fontFamily: { sans: ['Inter', 'ui-sans-serif', 'system-ui', 'sans-serif'] },
                    colors: { oled: '#000000', zinc: { 850: '#1f2023', 900: '#18181b', 950: '#09090b' },indigo: {600: '#121212'} }
                }
            }
        }
    </script>
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 4px; }
        .dark ::-webkit-scrollbar-thumb { background: #3f3f46; }
        ::-webkit-scrollbar-thumb:hover { background: #94a3b8; }
        input[type="file"] { display: none; }
        .scrollbar-hide::-webkit-scrollbar { display: none; }
        .scrollbar-hide { -ms-overflow-style: none; scrollbar-width: none; }
    </style>
</head>
<body class="bg-[#F4F6F8] dark:bg-oled text-slate-800 dark:text-zinc-100 font-sans transition-colors duration-300 min-h-screen pb-10">

    <div class="max-w-7xl mx-auto p-3 md:p-8">
        <!-- Header & Theme Switcher -->
        <header class="flex flex-col md:flex-row justify-between items-start md:items-center mb-6 gap-4">
            <div>
                <h1 class="text-2xl md:text-3xl font-bold tracking-tight text-slate-900 dark:text-white">Danh s√°ch ∆∞·ªõc m∆°</h1>
                <p class="text-sm md:text-base text-slate-500 dark:text-zinc-400 mt-1">L∆∞u gi·ªØ v√† theo d√µi nh·ªØng m·ª•c ti√™u c·ªßa cu·ªôc ƒë·ªùi b·∫°n.</p>
            </div>
            
            <div class="flex flex-wrap items-center gap-2 w-full md:w-auto justify-between md:justify-end">
                <!-- Theme Switcher -->
                <div class="flex bg-white dark:bg-zinc-900 p-1 rounded-xl border border-slate-200 dark:border-zinc-800 shadow-sm shrink-0">
                    <button onclick="setTheme('light')" id="theme-light" class="p-2 w-9 h-9 flex justify-center items-center rounded-lg text-slate-500 hover:text-slate-900 dark:hover:text-white transition-colors" title="Ch·∫ø ƒë·ªô S√°ng"><i class="fa-solid fa-sun text-sm"></i></button>
                    <button onclick="setTheme('system')" id="theme-system" class="p-2 w-9 h-9 flex justify-center items-center rounded-lg text-slate-500 hover:text-slate-900 dark:hover:text-white transition-colors" title="Theo H·ªá th·ªëng"><i class="fa-solid fa-desktop text-sm"></i></button>
                    <button onclick="setTheme('dark')" id="theme-dark" class="p-2 w-9 h-9 flex justify-center items-center rounded-lg text-slate-500 hover:text-slate-900 dark:hover:text-white transition-colors" title="Ch·∫ø ƒë·ªô T·ªëi"><i class="fa-solid fa-moon text-sm"></i></button>
                </div>

                <!-- Settings Dropdown (Export/Import) -->
                <div class="relative shrink-0">
                    <button onclick="toggleMenu(event, 'settings')" class="flex justify-center items-center bg-white dark:bg-zinc-800 text-slate-700 dark:text-zinc-200 w-11 h-11 rounded-xl hover:bg-slate-50 dark:hover:bg-zinc-700 transition-colors shadow-sm text-sm border border-slate-200 dark:border-zinc-700 focus:outline-none">
                        <i class="fa-solid fa-gear"></i>
                    </button>
                    <div id="menu-settings" class="absolute right-0 top-full mt-1 w-48 bg-white dark:bg-zinc-800 border border-slate-100 dark:border-zinc-700 shadow-xl rounded-xl hidden z-40 py-1.5 origin-top-right transform transition-all">
                        <label class="w-full text-left px-3 py-2 text-xs font-medium text-slate-700 dark:text-zinc-300 hover:bg-slate-50 dark:hover:bg-zinc-700/50 flex items-center gap-2.5 cursor-pointer">
                            <i class="fa-solid fa-file-import w-4 text-center text-slate-400"></i> Ph·ª•c h·ªìi d·ªØ li·ªáu
                            <input type="file" id="importDataInput" accept=".json" class="hidden" onchange="importData(event)">
                        </label>
                        <button onclick="exportData()" class="w-full text-left px-3 py-2 text-xs font-medium text-slate-700 dark:text-zinc-300 hover:bg-slate-50 dark:hover:bg-zinc-700/50 flex items-center gap-2.5">
                            <i class="fa-solid fa-file-export w-4 text-center text-slate-400"></i> Sao l∆∞u (T·∫£i file)
                        </button>
                        <div class="h-px bg-slate-100 dark:bg-zinc-700/50 my-1.5"></div>
                        <button onclick="clearAllData()" class="w-full text-left px-3 py-2 text-xs font-medium text-red-600 dark:text-red-400 hover:bg-red-50 dark:hover:bg-red-900/20 flex items-center gap-2.5">
                            <i class="fa-solid fa-trash-can w-4 text-center text-red-400"></i> X√≥a t·∫•t c·∫£ d·ªØ li·ªáu
                        </button>
                    </div>
                </div>

                <button onclick="openHistoryModal()" class="flex justify-center items-center gap-2 bg-white dark:bg-zinc-800 text-slate-700 dark:text-zinc-200 px-3 md:px-4 py-2 h-11 rounded-xl font-medium hover:bg-slate-50 dark:hover:bg-zinc-700 transition-colors shadow-sm text-sm border border-slate-200 dark:border-zinc-700 shrink-0">
                    <i class="fa-solid fa-clock-rotate-left"></i>
                    <span class="hidden md:inline">L·ªãch s·ª≠</span>
                </button>

                <button onclick="openGoalModal()" class="flex flex-1 md:flex-none justify-center items-center gap-2 bg-slate-900 dark:bg-indigo-600 text-white px-4 py-2 h-11 rounded-xl font-medium hover:bg-slate-800 dark:hover:bg-indigo-700 transition-colors active:scale-95 shadow-sm text-sm whitespace-nowrap">
                    <i class="fa-solid fa-plus"></i>
                    Th√™m m·ªõi
                </button>
            </div>
        </header>

        <!-- Search, Filter & View Controls -->
        <div class="flex flex-col md:flex-row gap-3 mb-6">
            <div class="relative flex-grow">
                <i class="fa-solid fa-search absolute left-3 md:left-4 top-1/2 transform -translate-y-1/2 text-slate-400 text-sm"></i>
                <input type="text" id="searchInput" placeholder="T√¨m ki·∫øm ∆∞·ªõc m∆°..." class="w-full pl-9 md:pl-11 pr-4 py-2.5 md:py-3 text-sm md:text-base bg-white dark:bg-zinc-900 border border-slate-200 dark:border-zinc-800 rounded-xl focus:outline-none focus:ring-2 focus:ring-slate-900 dark:focus:ring-indigo-500 text-slate-900 dark:text-white transition-all shadow-sm">
            </div>
            
            <div class="flex gap-2">
                <select id="categoryFilter" class="px-3 md:px-4 py-2.5 md:py-3 text-sm md:text-base bg-white dark:bg-zinc-900 border border-slate-200 dark:border-zinc-800 rounded-xl focus:outline-none focus:ring-2 focus:ring-slate-900 dark:focus:ring-indigo-500 text-slate-900 dark:text-white transition-all shadow-sm flex-1 md:w-48 appearance-none cursor-pointer">
                    <option value="T·∫•t c·∫£">T·∫•t c·∫£ danh m·ª•c</option>
                    <option value="Tr·∫£i nghi·ªám">Tr·∫£i nghi·ªám</option>
                    <option value="T√†i s·∫£n">T√†i s·∫£n (Mua s·∫Øm)</option>
                    <option value="Ph√°t tri·ªÉn b·∫£n th√¢n">Ph√°t tri·ªÉn b·∫£n th√¢n</option>
                    <option value="Du l·ªãch">Du l·ªãch</option>
                    <option value="Kh√°c">Kh√°c</option>
                </select>
                
                <!-- View Modes Selector -->
                <div class="flex bg-white dark:bg-zinc-900 p-1 rounded-xl border border-slate-200 dark:border-zinc-800 shadow-sm shrink-0">
                    <button onclick="setViewMode('grid')" id="view-grid" class="p-2 w-10 h-full flex justify-center items-center rounded-lg text-slate-500 hover:text-slate-900 dark:hover:text-white transition-colors" title="D·∫°ng l∆∞·ªõi"><i class="fa-solid fa-border-all text-sm"></i></button>
                    <button onclick="setViewMode('list')" id="view-list" class="p-2 w-10 h-full flex justify-center items-center rounded-lg text-slate-500 hover:text-slate-900 dark:hover:text-white transition-colors" title="D·∫°ng danh s√°ch"><i class="fa-solid fa-list text-sm"></i></button>
                    <button onclick="setViewMode('minimal')" id="view-minimal" class="p-2 w-10 h-full flex justify-center items-center rounded-lg text-slate-500 hover:text-slate-900 dark:hover:text-white transition-colors" title="D·∫°ng si√™u t·ªëi gi·∫£n"><i class="fa-solid fa-bars-staggered text-sm"></i></button>
                </div>
            </div>
        </div>

        <!-- Goals Container -->
        <div id="goalsContainer" class="grid gap-4 md:gap-6">
            <!-- D·ªØ li·ªáu s·∫Ω ƒë∆∞·ª£c render b·∫±ng JS t·∫°i ƒë√¢y -->
        </div>
    </div>

    <!-- MODAL: Th√™m / S·ª≠a M·ª•c Ti√™u -->
    <div id="goalModal" class="fixed inset-0 z-50 hidden flex items-center justify-center p-3 md:p-4 bg-slate-900/40 dark:bg-black/80 backdrop-blur-sm transition-opacity">
        <div class="bg-white dark:bg-zinc-900 rounded-2xl w-full max-w-lg shadow-2xl overflow-hidden flex flex-col max-h-[90vh]">
            <div class="flex justify-between items-center p-4 md:p-6 border-b border-slate-100 dark:border-zinc-800 shrink-0">
                <h2 id="goalModalTitle" class="text-lg md:text-xl font-semibold text-slate-900 dark:text-white">Th√™m ∆∞·ªõc m∆° m·ªõi</h2>
                <button onclick="closeModal('goalModal')" class="text-slate-400 hover:text-slate-600 dark:hover:text-zinc-300 transition-colors p-1">
                    <i class="fa-solid fa-xmark text-xl"></i>
                </button>
            </div>
            
            <form id="goalForm" class="p-4 md:p-6 overflow-y-auto custom-scrollbar flex-grow">
                <input type="hidden" id="goalId">
                
                <div class="space-y-4">
                    <!-- ·∫¢nh b√¨a -->
                    <div>
                        <label class="block text-xs md:text-sm font-medium text-slate-700 dark:text-zinc-300 mb-1.5">H√¨nh ·∫£nh (T√πy ch·ªçn - T·ªëi ƒëa 5 ·∫£nh)</label>
                        <div class="flex flex-wrap items-center gap-3">
                            <label for="imageUpload" class="cursor-pointer flex flex-col items-center justify-center w-20 h-20 md:w-24 md:h-24 bg-slate-50 dark:bg-zinc-800 border-2 border-dashed border-slate-300 dark:border-zinc-700 rounded-xl hover:border-slate-400 dark:hover:border-zinc-500 transition-colors relative group shrink-0">
                                <i class="fa-solid fa-camera text-slate-400 text-lg md:text-xl group-hover:text-slate-500"></i>
                                <span class="text-[10px] md:text-xs text-slate-500 mt-1">T·∫£i ·∫£nh</span>
                                <input type="file" id="imageUpload" accept="image/*" multiple>
                            </label>
                            <div id="imagePreviewContainer" class="flex flex-wrap gap-2"></div>
                        </div>
                    </div>

                    <!-- T√™n ∆∞·ªõc m∆° -->
                    <div>
                        <label class="block text-xs md:text-sm font-medium text-slate-700 dark:text-zinc-300 mb-1.5">T√™n ∆∞·ªõc m∆°</label>
                        <input type="text" id="goalTitle" required placeholder="VD: Mua xe m√°y, ƒêi Nh·∫≠t B·∫£n..." class="w-full px-3 py-2.5 md:px-4 md:py-3 text-sm md:text-base bg-slate-50 dark:bg-zinc-800 border border-slate-200 dark:border-zinc-700 rounded-xl focus:outline-none focus:ring-2 focus:ring-slate-900 dark:focus:ring-indigo-500 dark:text-white transition-all">
                    </div>

                    <!-- Layout 3 c·ªôt: Danh m·ª•c, Quan tr·ªçng, Ng√†y -->
                    <div class="grid grid-cols-2 md:grid-cols-3 gap-3 md:gap-4">
                        <div>
                            <label class="block text-xs md:text-sm font-medium text-slate-700 dark:text-zinc-300 mb-1.5">Danh m·ª•c</label>
                            <select id="goalCategory" required class="w-full px-3 py-2.5 md:px-4 md:py-3 text-sm md:text-base bg-slate-50 dark:bg-zinc-800 border border-slate-200 dark:border-zinc-700 rounded-xl focus:outline-none focus:ring-2 focus:ring-slate-900 dark:focus:ring-indigo-500 dark:text-white transition-all appearance-none cursor-pointer">
                                <option value="Tr·∫£i nghi·ªám">Tr·∫£i nghi·ªám</option>
                                <option value="T√†i s·∫£n">T√†i s·∫£n</option>
                                <option value="Ph√°t tri·ªÉn b·∫£n th√¢n">Ph√°t tri·ªÉn b·∫£n th√¢n</option>
                                <option value="Du l·ªãch">Du l·ªãch</option>
                                <option value="Kh√°c">Kh√°c</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-xs md:text-sm font-medium text-slate-700 dark:text-zinc-300 mb-1.5">ƒê·ªô quan tr·ªçng</label>
                            <select id="goalPriority" required class="w-full px-3 py-2.5 md:px-4 md:py-3 text-sm md:text-base bg-slate-50 dark:bg-zinc-800 border border-slate-200 dark:border-zinc-700 rounded-xl focus:outline-none focus:ring-2 focus:ring-slate-900 dark:focus:ring-indigo-500 dark:text-white transition-all appearance-none cursor-pointer">
                                <option value="high">üî• Cao</option>
                                <option value="medium" selected>‚≠ê B√¨nh th∆∞·ªùng</option>
                                <option value="low">üçÉ Th·∫•p</option>
                            </select>
                        </div>
                        <div class="col-span-2 md:col-span-1">
                            <label class="block text-xs md:text-sm font-medium text-slate-700 dark:text-zinc-300 mb-1.5">Ng√†y m·ª•c ti√™u</label>
                            <input type="date" id="goalDate" required class="w-full px-3 py-2.5 md:px-4 md:py-3 text-sm md:text-base bg-slate-50 dark:bg-zinc-800 border border-slate-200 dark:border-zinc-700 rounded-xl focus:outline-none focus:ring-2 focus:ring-slate-900 dark:focus:ring-indigo-500 dark:text-white transition-all">
                        </div>
                    </div>

                    <!-- Lo·∫°i ƒëo l∆∞·ªùng -->
                    <div class="p-3 md:p-4 bg-slate-50 dark:bg-zinc-850 rounded-xl border border-slate-200 dark:border-zinc-800">
                        <label class="block text-xs md:text-sm font-semibold text-slate-900 dark:text-white mb-3">Lo·∫°i ƒëo l∆∞·ªùng ti·∫øn ƒë·ªô</label>
                        <div class="grid grid-cols-3 gap-2">
                            <label class="flex flex-col items-center justify-center p-2 border border-slate-200 dark:border-zinc-700 rounded-lg cursor-pointer hover:bg-slate-100 dark:hover:bg-zinc-700 transition-colors has-[:checked]:bg-indigo-50 has-[:checked]:border-indigo-500 dark:has-[:checked]:bg-indigo-900/30 dark:has-[:checked]:border-indigo-500">
                                <input type="radio" name="goalType" value="finance" class="hidden" checked onchange="toggleTypeFields()">
                                <i class="fa-solid fa-coins text-lg mb-1 text-slate-600 dark:text-zinc-400"></i>
                                <span class="text-[10px] md:text-xs font-medium text-center text-slate-700 dark:text-zinc-300">T√†i ch√≠nh</span>
                            </label>
                            <label class="flex flex-col items-center justify-center p-2 border border-slate-200 dark:border-zinc-700 rounded-lg cursor-pointer hover:bg-slate-100 dark:hover:bg-zinc-700 transition-colors has-[:checked]:bg-indigo-50 has-[:checked]:border-indigo-500 dark:has-[:checked]:bg-indigo-900/30 dark:has-[:checked]:border-indigo-500">
                                <input type="radio" name="goalType" value="progress" class="hidden" onchange="toggleTypeFields()">
                                <i class="fa-solid fa-bars-progress text-lg mb-1 text-slate-600 dark:text-zinc-400"></i>
                                <span class="text-[10px] md:text-xs font-medium text-center text-slate-700 dark:text-zinc-300">S·ªë l∆∞·ª£ng</span>
                            </label>
                            <label class="flex flex-col items-center justify-center p-2 border border-slate-200 dark:border-zinc-700 rounded-lg cursor-pointer hover:bg-slate-100 dark:hover:bg-zinc-700 transition-colors has-[:checked]:bg-indigo-50 has-[:checked]:border-indigo-500 dark:has-[:checked]:bg-indigo-900/30 dark:has-[:checked]:border-indigo-500">
                                <input type="radio" name="goalType" value="simple" class="hidden" onchange="toggleTypeFields()">
                                <i class="fa-solid fa-check-double text-lg mb-1 text-slate-600 dark:text-zinc-400"></i>
                                <span class="text-[10px] md:text-xs font-medium text-center text-slate-700 dark:text-zinc-300">1 L·∫ßn</span>
                            </label>
                        </div>

                        <div id="dynamicFields" class="mt-4 pt-4 border-t border-slate-200 dark:border-zinc-700">
                            <!-- Field: T√†i ch√≠nh -->
                            <div id="fieldFinance">
                                <label class="block text-xs md:text-sm font-medium text-slate-700 dark:text-zinc-300 mb-1.5">S·ªë ti·ªÅn c·∫ßn ƒë·∫°t (VNƒê)</label>
                                <input type="text" inputmode="numeric" oninput="formatNumberInput(this)" id="financeAmount" placeholder="VD: 35.000.000" class="w-full px-3 py-2.5 md:px-4 md:py-3 text-sm md:text-base bg-white dark:bg-zinc-900 border border-slate-200 dark:border-zinc-700 rounded-xl focus:outline-none focus:ring-2 focus:ring-slate-900 dark:focus:ring-indigo-500 dark:text-white transition-all">
                            </div>
                            
                            <!-- Field: S·ªë l∆∞·ª£ng / Ti·∫øn ƒë·ªô -->
                            <div id="fieldProgress" class="hidden grid grid-cols-2 gap-3">
                                <div>
                                    <label class="block text-xs md:text-sm font-medium text-slate-700 dark:text-zinc-300 mb-1.5">T·ªïng s·ªë l∆∞·ª£ng</label>
                                    <input type="text" inputmode="numeric" oninput="formatNumberInput(this)" id="progressAmount" placeholder="VD: 50" class="w-full px-3 py-2.5 md:px-4 md:py-3 text-sm md:text-base bg-white dark:bg-zinc-900 border border-slate-200 dark:border-zinc-700 rounded-xl focus:outline-none focus:ring-2 focus:ring-slate-900 dark:focus:ring-indigo-500 dark:text-white transition-all">
                                </div>
                                <div>
                                    <label class="block text-xs md:text-sm font-medium text-slate-700 dark:text-zinc-300 mb-1.5">ƒê∆°n v·ªã ƒëo</label>
                                    <input type="text" id="progressUnit" placeholder="VD: cu·ªën, km, kg..." class="w-full px-3 py-2.5 md:px-4 md:py-3 text-sm md:text-base bg-white dark:bg-zinc-900 border border-slate-200 dark:border-zinc-700 rounded-xl focus:outline-none focus:ring-2 focus:ring-slate-900 dark:focus:ring-indigo-500 dark:text-white transition-all">
                                </div>
                            </div>

                            <!-- Field: ƒê∆°n gi·∫£n -->
                            <div id="fieldSimple" class="hidden">
                                <p class="text-xs md:text-sm text-slate-500 dark:text-zinc-400 italic">∆Ø·ªõc m∆° n√†y ch·ªâ c√≥ 2 tr·∫°ng th√°i: "Ch∆∞a ho√†n th√†nh" v√† "ƒê√£ ho√†n th√†nh". Kh√¥ng c·∫ßn nh·∫≠p s·ªë l∆∞·ª£ng.</p>
                            </div>
                        </div>
                    </div>

                    <div>
                        <label class="block text-xs md:text-sm font-medium text-slate-700 dark:text-zinc-300 mb-1.5">M√¥ t·∫£ (H·ªó tr·ª£ Link)</label>
                        <textarea id="goalDescription" rows="2" placeholder="VD: ƒê·∫∑t v√© t·∫°i https://booking.com..." class="w-full px-3 py-2.5 md:px-4 md:py-3 text-sm md:text-base bg-slate-50 dark:bg-zinc-800 border border-slate-200 dark:border-zinc-700 rounded-xl focus:outline-none focus:ring-2 focus:ring-slate-900 dark:focus:ring-indigo-500 dark:text-white transition-all resize-none"></textarea>
                    </div>
                </div>
            </form>
            
            <div class="p-4 md:p-6 border-t border-slate-100 dark:border-zinc-800 shrink-0 bg-white dark:bg-zinc-900">
                <div class="flex gap-3">
                    <button type="button" onclick="closeModal('goalModal')" class="flex-1 px-4 py-3 bg-slate-100 dark:bg-zinc-800 text-slate-700 dark:text-zinc-200 rounded-xl font-medium hover:bg-slate-200 dark:hover:bg-zinc-700 transition-colors text-sm md:text-base">H·ªßy</button>
                    <button type="button" onclick="handleSaveGoal(event)" id="goalSubmitBtn" class="flex-1 px-4 py-3 bg-slate-900 dark:bg-indigo-600 text-white rounded-xl font-medium hover:bg-slate-800 dark:hover:bg-indigo-700 transition-colors shadow-sm text-sm md:text-base">L∆∞u ∆∞·ªõc m∆°</button>
                </div>
            </div>
        </div>
    </div>

    <!-- MODAL: C·∫≠p nh·∫≠t Ti·∫øn ƒë·ªô -->
    <div id="updateModal" class="fixed inset-0 z-[50] hidden flex items-center justify-center p-4 bg-slate-900/40 dark:bg-black/80 backdrop-blur-sm transition-opacity">
        <div class="bg-white dark:bg-zinc-900 rounded-2xl w-full max-w-sm shadow-2xl overflow-hidden">
            <div class="flex justify-between items-center p-5 md:p-6 border-b border-slate-100 dark:border-zinc-800">
                <div class="flex items-center gap-2">
                    <div id="updateIconBg" class="w-8 h-8 rounded-full bg-indigo-100 dark:bg-indigo-900/50 flex items-center justify-center">
                        <i id="updateIcon" class="fa-solid fa-bolt text-indigo-600 dark:text-indigo-400"></i>
                    </div>
                    <h2 id="updateTitle" class="text-lg md:text-xl font-semibold text-slate-900 dark:text-white">C·∫≠p nh·∫≠t ti·∫øn ƒë·ªô</h2>
                </div>
                <button onclick="closeModal('updateModal')" class="text-slate-400 hover:text-slate-600 dark:hover:text-zinc-300 p-1"><i class="fa-solid fa-xmark text-xl"></i></button>
            </div>
            
            <form id="updateForm" onsubmit="handleUpdateProgress(event)" class="p-5 md:p-6 overflow-y-auto max-h-[70vh] custom-scrollbar">
                <input type="hidden" id="updateGoalId">
                <input type="hidden" id="updateGoalType">
                
                <div class="mb-4 text-sm text-slate-600 dark:text-zinc-400" id="updateHint"></div>

                <div id="updateFinanceWrapper" class="hidden">
                    <div class="flex gap-2 mb-4">
                        <label class="flex-1 text-center py-2 bg-slate-100 dark:bg-zinc-800 rounded-lg cursor-pointer has-[:checked]:bg-emerald-100 has-[:checked]:text-emerald-700 dark:has-[:checked]:bg-emerald-900/30 dark:has-[:checked]:text-emerald-400 transition-colors font-medium text-sm border border-transparent has-[:checked]:border-emerald-200 dark:has-[:checked]:border-emerald-800">
                            <input type="radio" name="financeAction" value="add" class="hidden" checked>
                            <i class="fa-solid fa-arrow-up mr-1"></i> N·∫°p th√™m
                        </label>
                        <label class="flex-1 text-center py-2 bg-slate-100 dark:bg-zinc-800 rounded-lg cursor-pointer has-[:checked]:bg-red-100 has-[:checked]:text-red-700 dark:has-[:checked]:bg-red-900/30 dark:has-[:checked]:text-red-400 transition-colors font-medium text-sm border border-transparent has-[:checked]:border-red-200 dark:has-[:checked]:border-red-800">
                            <input type="radio" name="financeAction" value="sub" class="hidden">
                            <i class="fa-solid fa-arrow-down mr-1"></i> R√∫t b·ªõt
                        </label>
                    </div>
                    <label class="block text-xs md:text-sm font-medium text-slate-700 dark:text-zinc-300 mb-1.5">S·ªë ti·ªÅn (VNƒê)</label>
                    <input type="text" inputmode="numeric" oninput="formatNumberInput(this)" id="updateFinanceAmount" placeholder="VD: 500.000" class="w-full px-4 py-3 bg-slate-50 dark:bg-zinc-800 border border-slate-200 dark:border-zinc-700 rounded-xl focus:outline-none focus:ring-2 focus:ring-indigo-500 dark:text-white text-lg font-medium transition-all">
                </div>

                <div id="updateProgressWrapper" class="hidden">
                    <label class="block text-xs md:text-sm font-medium text-slate-700 dark:text-zinc-300 mb-1.5">Nh·∫≠p s·ªë l∆∞·ª£ng b·∫°n v·ª´a l√†m th√™m</label>
                    <div class="relative">
                        <input type="text" inputmode="numeric" oninput="formatNumberInput(this)" id="updateProgressAmount" placeholder="VD: 2" class="w-full px-4 py-3 pr-16 bg-slate-50 dark:bg-zinc-800 border border-slate-200 dark:border-zinc-700 rounded-xl focus:outline-none focus:ring-2 focus:ring-indigo-500 dark:text-white text-lg font-medium transition-all">
                        <span id="updateProgressUnit" class="absolute right-4 top-1/2 transform -translate-y-1/2 text-slate-400 dark:text-zinc-500 font-medium"></span>
                    </div>
                </div>

                <!-- Th√™m Ghi ch√∫ -->
                <div class="mt-4">
                    <label class="block text-xs md:text-sm font-medium text-slate-700 dark:text-zinc-300 mb-1.5">Ghi ch√∫ (Tu·ª≥ ch·ªçn)</label>
                    <textarea id="updateNote" rows="2" placeholder="VD: Ti·ªÅn th∆∞·ªüng T·∫øt, ƒê·ªçc xong ch∆∞∆°ng 2..." class="w-full px-4 py-3 bg-slate-50 dark:bg-zinc-800 border border-slate-200 dark:border-zinc-700 rounded-xl focus:outline-none focus:ring-2 focus:ring-indigo-500 dark:text-white text-sm transition-all resize-none"></textarea>
                </div>
                
                <div class="mt-6">
                    <button type="submit" id="updateSubmitBtn" class="w-full px-4 py-3 text-white rounded-xl font-medium transition-colors bg-slate-900 hover:bg-slate-800 dark:bg-indigo-600 dark:hover:bg-indigo-700 shadow-sm text-sm md:text-base">X√°c nh·∫≠n c·∫≠p nh·∫≠t</button>
                </div>
            </form>
        </div>
    </div>

    <!-- MODAL: L·ªãch S·ª≠ -->
    <div id="historyModal" class="fixed inset-0 z-[40] hidden flex items-center justify-center p-3 md:p-4 bg-slate-900/40 dark:bg-black/80 backdrop-blur-sm transition-opacity">
        <div class="bg-white dark:bg-zinc-900 rounded-2xl w-full max-w-lg shadow-2xl overflow-hidden flex flex-col max-h-[90vh]">
            <div class="flex justify-between items-center p-4 md:p-6 border-b border-slate-100 dark:border-zinc-800 shrink-0">
                <div class="flex items-center gap-2">
                    <div class="w-8 h-8 rounded-full bg-slate-100 dark:bg-zinc-800 flex items-center justify-center">
                        <i class="fa-solid fa-clock-rotate-left text-slate-600 dark:text-zinc-300"></i>
                    </div>
                    <h2 id="historyModalTitle" class="text-lg md:text-xl font-semibold text-slate-900 dark:text-white line-clamp-1">L·ªãch s·ª≠ ho·∫°t ƒë·ªông</h2>
                </div>
                <button onclick="closeModal('historyModal')" class="text-slate-400 hover:text-slate-600 dark:hover:text-zinc-300 p-1"><i class="fa-solid fa-xmark text-xl"></i></button>
            </div>
            
            <div class="p-4 md:p-6 overflow-y-auto custom-scrollbar flex-grow bg-slate-50 dark:bg-zinc-850/50">
                <div id="historyContainer" class="space-y-3">
                    <!-- History logs -->
                </div>
            </div>
        </div>
    </div>

    <!-- MODAL: Ch·ªânh s·ª≠a Ghi ch√∫ L·ªãch s·ª≠ -->
    <div id="editLogModal" class="fixed inset-0 z-[60] hidden flex items-center justify-center p-4 bg-slate-900/40 dark:bg-black/80 backdrop-blur-sm transition-opacity">
        <div class="bg-white dark:bg-zinc-900 rounded-2xl w-full max-w-sm shadow-2xl overflow-hidden">
            <div class="p-5">
                <h3 class="text-lg font-bold text-slate-900 dark:text-white mb-3">S·ª≠a ghi ch√∫ l·ªãch s·ª≠</h3>
                <input type="hidden" id="editLogId">
                <textarea id="editLogNote" rows="3" class="w-full px-4 py-3 bg-slate-50 dark:bg-zinc-800 border border-slate-200 dark:border-zinc-700 rounded-xl focus:outline-none focus:ring-2 focus:ring-indigo-500 dark:text-white text-sm transition-all resize-none"></textarea>
                <div class="flex gap-3 mt-4">
                    <button onclick="closeModal('editLogModal')" class="flex-1 px-4 py-2 bg-slate-100 dark:bg-zinc-800 text-slate-700 dark:text-zinc-200 rounded-xl font-medium hover:bg-slate-200 transition-colors">H·ªßy</button>
                    <button onclick="saveEditLog()" class="flex-1 px-4 py-2 bg-slate-900 dark:bg-indigo-600 text-white rounded-xl font-medium hover:bg-slate-800 transition-colors">L∆∞u</button>
                </div>
            </div>
        </div>
    </div>

    <!-- MODAL: Alert & Confirm -->
    <div id="alertModal" class="fixed inset-0 z-[70] hidden flex items-center justify-center p-4 bg-slate-900/40 dark:bg-black/80 backdrop-blur-sm transition-opacity">
        <div class="bg-white dark:bg-zinc-900 rounded-2xl w-full max-w-sm shadow-2xl overflow-hidden"><div class="p-6 text-center"><div id="alertIconBox" class="w-12 h-12 rounded-full mx-auto flex items-center justify-center mb-4"><i id="alertIcon" class="fa-solid fa-circle-exclamation text-2xl"></i></div><h3 id="alertTitle" class="text-lg font-bold text-slate-900 dark:text-white mb-2">Th√¥ng b√°o</h3><p id="alertMessage" class="text-sm text-slate-500 dark:text-zinc-400 mb-6"></p><button onclick="closeModal('alertModal')" class="w-full px-4 py-2.5 bg-slate-900 dark:bg-indigo-600 text-white rounded-xl font-medium">ƒê√≥ng</button></div></div>
    </div>

    <div id="confirmModal" class="fixed inset-0 z-[70] hidden flex items-center justify-center p-4 bg-slate-900/40 dark:bg-black/80 backdrop-blur-sm transition-opacity">
        <div class="bg-white dark:bg-zinc-900 rounded-2xl w-full max-w-sm shadow-2xl overflow-hidden"><div class="p-6"><div class="flex items-start gap-4 mb-5"><div class="w-10 h-10 rounded-full bg-red-100 dark:bg-red-900/30 flex flex-shrink-0 items-center justify-center"><i class="fa-solid fa-triangle-exclamation text-red-600 dark:text-red-400 text-lg"></i></div><div><h3 id="confirmTitle" class="text-lg font-bold text-slate-900 dark:text-white mb-1">X√°c nh·∫≠n</h3><p id="confirmMessage" class="text-sm text-slate-500 dark:text-zinc-400"></p></div></div><div class="flex gap-3"><button onclick="closeModal('confirmModal')" class="flex-1 px-4 py-2.5 bg-slate-100 dark:bg-zinc-800 text-slate-700 dark:text-zinc-200 rounded-xl font-medium">H·ªßy</button><button id="confirmActionBtn" class="flex-1 px-4 py-2.5 bg-red-500 text-white rounded-xl font-medium shadow-sm">ƒê·ªìng √Ω</button></div></div></div>
    </div>

    <!-- JavaScript Logic -->
    <script>
        // --- DATA & STATE ---
        let goals = JSON.parse(localStorage.getItem('bucketlist_goals')) || [];
        let historyLogs = JSON.parse(localStorage.getItem('bucketlist_history')) || [];
        let currentTheme = localStorage.getItem('savings_theme') || 'system';
        let currentViewMode = localStorage.getItem('savings_viewmode') || 'grid';
        let tempImageUrls = [];
        let currentHistoryGoalId = null; 
        let activeMenu = null;
        
        // Priority Configs
        const priorityConfig = {
            'high': { icon: 'fa-fire', color: 'text-red-600 dark:text-red-400', bg: 'bg-red-100 dark:bg-red-900/30', label: 'Cao' },
            'medium': { icon: 'fa-star', color: 'text-amber-600 dark:text-amber-400', bg: 'bg-amber-100 dark:bg-amber-900/30', label: 'Th∆∞·ªùng' },
            'low': { icon: 'fa-leaf', color: 'text-emerald-600 dark:text-emerald-400', bg: 'bg-emerald-100 dark:bg-emerald-900/30', label: 'Th·∫•p' }
        };

        // Data Migration
        goals = goals.map(g => {
            if (g.imageUrl && !g.imageUrls) { g.imageUrls = [g.imageUrl]; delete g.imageUrl; }
            if (!g.imageUrls) g.imageUrls = [];
            if (!g.priority) g.priority = 'medium';
            return g;
        });

        // --- INIT ---
        document.addEventListener('DOMContentLoaded', () => {
            initTheme();
            setViewMode(currentViewMode, false);
            
            if (goals.length === -1) {
                const id1 = Date.now().toString() + '1';
                goals = [{ id: id1, type: 'finance', title: 'Mua Macbook Pro', category: 'T√†i s·∫£n', priority: 'high', description: 'D√πng cho c√¥ng vi·ªác l·∫≠p tr√¨nh', targetValue: 45000000, currentValue: 15000000, targetDate: '2026-12-01', imageUrls: ['https://images.unsplash.com/photo-1517336714731-489689fd1ca8?auto=format&fit=crop&q=80&w=800'] }];
                saveData();
                addLog(id1, 'Mua Macbook Pro', 'finance', 'CREATE', 'ƒê√£ kh·ªüi t·∫°o qu·ªπ ti·∫øt ki·ªám', '');
            }

            renderGoals();
            document.getElementById('searchInput').addEventListener('input', renderGoals);
            document.getElementById('categoryFilter').addEventListener('change', renderGoals);
            
            // X·ª≠ l√Ω ƒë√≥ng menu khi click ra ngo√†i
            document.addEventListener('click', () => {
                if (activeMenu) { activeMenu.classList.add('hidden'); activeMenu = null; }
            });
        });

        // --- EXPORT & IMPORT DATA LOGIC ---
        function exportData() {
            const data = {
                goals: goals,
                history: historyLogs,
                theme: currentTheme,
                viewMode: currentViewMode,
                exportDate: new Date().toISOString()
            };
            
            const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(data, null, 2));
            const downloadAnchorNode = document.createElement('a');
            downloadAnchorNode.setAttribute("href", dataStr);
            downloadAnchorNode.setAttribute("download", "danh_sach_uoc_mo_backup.json");
            document.body.appendChild(downloadAnchorNode); // required for firefox
            downloadAnchorNode.click();
            downloadAnchorNode.remove();
            
            toggleMenu(new Event('click'), 'settings'); // ƒê√≥ng menu
            customAlert("ƒê√£ t·∫£i xu·ªëng file sao l∆∞u th√†nh c√¥ng!", "Sao l∆∞u d·ªØ li·ªáu", "info");
        }

        function importData(event) {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const importedData = JSON.parse(e.target.result);
                    
                    if (importedData && importedData.goals && Array.isArray(importedData.goals)) {
                        customConfirm("B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën ghi ƒë√® to√†n b·ªô d·ªØ li·ªáu hi·ªán t·∫°i b·∫±ng d·ªØ li·ªáu t·ª´ file n√†y kh√¥ng?", () => {
                            goals = importedData.goals;
                            historyLogs = importedData.history || [];
                            if (importedData.theme) setTheme(importedData.theme);
                            if (importedData.viewMode) setViewMode(importedData.viewMode, false);
                            
                            saveData();
                            saveHistory();
                            renderGoals();
                            customAlert("ƒê√£ ph·ª•c h·ªìi d·ªØ li·ªáu th√†nh c√¥ng!", "Ph·ª•c h·ªìi d·ªØ li·ªáu", "info");
                        }, "Ph·ª•c h·ªìi d·ªØ li·ªáu");
                    } else {
                        customAlert("File kh√¥ng ƒë√∫ng ƒë·ªãnh d·∫°ng Danh s√°ch ∆∞·ªõc m∆°.", "L·ªói nh·∫≠p file", "error");
                    }
                } catch (error) {
                    customAlert("Kh√¥ng th·ªÉ ƒë·ªçc file d·ªØ li·ªáu. File c√≥ th·ªÉ b·ªã h·ªèng.", "L·ªói", "error");
                }
            };
            reader.readAsText(file);
            event.target.value = ''; // X√≥a input ƒë·ªÉ c√≥ th·ªÉ ch·ªçn l·∫°i c√πng file
            toggleMenu(new Event('click'), 'settings'); // ƒê√≥ng menu
        }

        function clearAllData() {
            toggleMenu(new Event('click'), 'settings'); // ƒê√≥ng menu
            customConfirm("B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën x√≥a TO√ÄN B·ªò d·ªØ li·ªáu ∆∞·ªõc m∆° v√† l·ªãch s·ª≠? H√†nh ƒë·ªông n√†y KH√îNG TH·ªÇ HO√ÄN T√ÅC!", () => {
                goals = [];
                historyLogs = [];
                saveData();
                saveHistory();
                renderGoals();
                customAlert("ƒê√£ x√≥a to√†n b·ªô d·ªØ li·ªáu ·ª©ng d·ª•ng.", "ƒê√£ x√≥a", "info");
            }, "X√≥a t·∫•t c·∫£");
        }

        // --- UTILS ---
        function formatNumberRaw(num) { return num.toString().replace(/\B(?=(\d{3})+(?!\d))/g, '.'); }
        function formatNumberInput(input) {
            let val = input.value.replace(/\./g, '').replace(/\D/g, '');
            input.value = val === '' ? '' : formatNumberRaw(val);
        }
        function parseFormattedNumber(val) { return val ? Number(val.replace(/\./g, '')) : 0; }
        const formatCurrency = (amount) => new Intl.NumberFormat('vi-VN', { style: 'currency', currency: 'VND' }).format(amount);
        const calculateProgress = (cur, tar) => tar <= 0 ? 0 : (cur / tar * 100 > 100 ? 100 : (cur / tar * 100).toFixed(1));
        const getDaysLeft = (date) => Math.max(0, Math.ceil((new Date(date) - new Date()) / 86400000));
        function escapeHTML(str) { return str.replace(/[&<>'"]/g, tag => ({ '&': '&amp;', '<': '&lt;', '>': '&gt;', "'": '&#39;', '"': '&quot;' }[tag] || tag)); }
        function linkify(text) {
            if (!text) return ''; let escaped = escapeHTML(text); const urlRegex = /(https?:\/\/[^\s]+)/g;
            return escaped.replace(urlRegex, url => `<a href="${url}" target="_blank" class="text-blue-500 hover:text-blue-600 dark:text-blue-400 underline break-all inline" onclick="event.stopPropagation()"><i class="fa-solid fa-link text-[10px] mr-0.5"></i>${url}</a>`);
        }

        // --- THEME & VIEW MODE ---
        function initTheme() {
            setTheme(currentTheme, false);
            window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', () => { if(currentTheme === 'system') applyThemeToDOM('system'); });
        }
        function setTheme(theme, save = true) {
            currentTheme = theme; if (save) localStorage.setItem('savings_theme', theme);
            document.querySelectorAll('#theme-light, #theme-system, #theme-dark').forEach(btn => btn.classList.remove('bg-slate-100', 'dark:bg-zinc-800', 'shadow-inner'));
            document.getElementById(`theme-${theme}`).classList.add('bg-slate-100', 'dark:bg-zinc-800', 'shadow-inner');
            applyThemeToDOM(theme);
        }
        function applyThemeToDOM(theme) {
            const isDark = theme === 'dark' || (theme === 'system' && window.matchMedia('(prefers-color-scheme: dark)').matches);
            isDark ? document.documentElement.classList.add('dark') : document.documentElement.classList.remove('dark');
        }

        function setViewMode(mode, reRender = true) {
            currentViewMode = mode;
            localStorage.setItem('savings_viewmode', mode);
            document.querySelectorAll('#view-grid, #view-list, #view-minimal').forEach(btn => btn.classList.remove('bg-slate-100', 'dark:bg-zinc-800', 'shadow-inner', 'text-slate-900', 'dark:text-white'));
            document.getElementById(`view-${mode}`).classList.add('bg-slate-100', 'dark:bg-zinc-800', 'shadow-inner', 'text-slate-900', 'dark:text-white');
            
            const container = document.getElementById('goalsContainer');
            container.className = mode === 'grid' ? 'grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-4 md:gap-6' : 'grid grid-cols-1 gap-3 md:gap-4';
            if(reRender) renderGoals();
        }

        // --- ALERTS & CONFIRMS ---
        let confirmCallback = null;
        function customAlert(msg, title = "Th√¥ng b√°o", type = "warning") {
            document.getElementById('alertMessage').innerText = msg; document.getElementById('alertTitle').innerText = title;
            const iconBox = document.getElementById('alertIconBox'), icon = document.getElementById('alertIcon');
            if (type === "warning") { iconBox.className = "w-12 h-12 rounded-full mx-auto flex items-center justify-center mb-4 bg-orange-100 dark:bg-orange-900/30 text-orange-600 dark:text-orange-400"; icon.className = "fa-solid fa-triangle-exclamation text-2xl"; }
            else if (type === "error") { iconBox.className = "w-12 h-12 rounded-full mx-auto flex items-center justify-center mb-4 bg-red-100 dark:bg-red-900/30 text-red-600 dark:text-red-400"; icon.className = "fa-solid fa-circle-xmark text-2xl"; }
            else if (type === "info") { iconBox.className = "w-12 h-12 rounded-full mx-auto flex items-center justify-center mb-4 bg-blue-100 dark:bg-blue-900/30 text-blue-600 dark:text-blue-400"; icon.className = "fa-solid fa-circle-info text-2xl"; }
            openModal('alertModal');
        }
        function customConfirm(msg, onConfirm, title = "X√°c nh·∫≠n") {
            document.getElementById('confirmMessage').innerText = msg; document.getElementById('confirmTitle').innerText = title;
            confirmCallback = onConfirm; openModal('confirmModal');
        }
        document.getElementById('confirmActionBtn').addEventListener('click', () => { if (confirmCallback) confirmCallback(); closeModal('confirmModal'); });

        // --- MENU DROPDOWN LOGIC ---
        function toggleMenu(e, id) {
            e.stopPropagation();
            const menu = document.getElementById('menu-' + id);
            if (activeMenu && activeMenu !== menu) activeMenu.classList.add('hidden');
            if (menu) {
                menu.classList.toggle('hidden');
                activeMenu = menu.classList.contains('hidden') ? null : menu;
            }
        }

        // --- HISTORY LOGIC ---
        function saveHistory() {
            if (historyLogs.length > 500) historyLogs = historyLogs.slice(0, 500);
            try { localStorage.setItem('bucketlist_history', JSON.stringify(historyLogs)); } catch(e) {}
        }
        function addLog(goalId, goalTitle, type, action, message, note = '') {
            historyLogs.unshift({ id: Date.now().toString() + Math.random().toString(36).substr(2,4), goalId, goalTitle, type, action, message, note, date: new Date().toISOString() });
            saveHistory();
        }

        // --- MODAL LOGIC & IMAGES ---
        function openModal(id) { document.getElementById(id).classList.remove('hidden'); }
        function closeModal(id) { document.getElementById(id).classList.add('hidden'); }

        document.getElementById('imageUpload').addEventListener('change', function(e) {
            const files = Array.from(e.target.files);
            if (tempImageUrls.length + files.length > 5) { customAlert("T·ªëi ƒëa 5 ·∫£nh cho m·ªói ∆∞·ªõc m∆°."); return; }
            files.forEach(file => {
                const reader = new FileReader();
                reader.onload = (event) => {
                    const img = new Image();
                    img.onload = () => {
                        const canvas = document.createElement('canvas');
                        let w = img.width, h = img.height;
                        if(w > h) { if(w>600){ h*=600/w; w=600; } } else { if(h>600){ w*=600/h; h=600; } }
                        canvas.width = w; canvas.height = h;
                        canvas.getContext('2d').drawImage(img, 0, 0, w, h);
                        tempImageUrls.push(canvas.toDataURL('image/jpeg', 0.6));
                        renderImagePreviews();
                    };
                    img.src = event.target.result;
                };
                reader.readAsDataURL(file);
            });
            this.value = '';
        });

        function renderImagePreviews() {
            const container = document.getElementById('imagePreviewContainer');
            container.innerHTML = tempImageUrls.map((url, i) => `
                <div class="relative w-20 h-20 md:w-24 md:h-24 rounded-xl overflow-hidden shadow-sm border border-slate-200 dark:border-zinc-700 shrink-0 group">
                    <img src="${url}" class="w-full h-full object-cover">
                    <button type="button" onclick="removeTempImage(${i})" class="absolute top-1 right-1 bg-black/60 hover:bg-red-500 text-white rounded-full w-6 h-6 flex items-center justify-center backdrop-blur-sm transition-colors opacity-0 group-hover:opacity-100"><i class="fa-solid fa-xmark text-xs"></i></button>
                </div>
            `).join('');
        }
        function removeTempImage(i) { tempImageUrls.splice(i, 1); renderImagePreviews(); }

        // --- RENDER GOALS ---
        function saveData() { try { localStorage.setItem('bucketlist_goals', JSON.stringify(goals)); } catch (e) { customAlert("B·ªô nh·ªõ tr√¨nh duy·ªát ƒë·∫ßy. Vui l√≤ng x√≥a b·ªõt ·∫£nh.", "L·ªói l∆∞u tr·ªØ", "error"); } }
        function scrollSlides(id, dir) { const el = document.getElementById('slide-' + id); if(el) el.scrollBy({ left: dir * el.clientWidth, behavior: 'smooth' }); }

        function renderGoals() {
            const container = document.getElementById('goalsContainer');
            const search = document.getElementById('searchInput').value.toLowerCase();
            const cat = document.getElementById('categoryFilter').value;

            const filtered = goals.filter(g => (g.title.toLowerCase().includes(search) || (g.description||'').toLowerCase().includes(search)) && (cat === 'T·∫•t c·∫£' || g.category === cat));

            if (filtered.length === 0) {
                container.innerHTML = `<div class="col-span-full text-center py-16 bg-white dark:bg-zinc-900 rounded-2xl border border-slate-200 dark:border-zinc-800 border-dashed"><div class="w-14 h-14 bg-slate-50 dark:bg-zinc-800 rounded-full flex items-center justify-center mx-auto mb-4"><i class="fa-solid fa-parachute-box text-2xl text-slate-400"></i></div><p class="text-slate-500 dark:text-zinc-400">Kh√¥ng t√¨m th·∫•y ∆∞·ªõc m∆° n√†o.</p></div>`;
                return;
            }

            container.innerHTML = filtered.map(goal => {
                const prog = calculateProgress(goal.currentValue, goal.targetValue);
                const isComp = goal.currentValue >= goal.targetValue;
                const days = getDaysLeft(goal.targetDate);
                const prio = priorityConfig[goal.priority || 'medium'];
                const priorityBadge = `<span class="inline-flex items-center gap-1 px-1.5 py-0.5 rounded text-[10px] font-medium ${prio.bg} ${prio.color} whitespace-nowrap"><i class="fa-solid ${prio.icon}"></i> ${prio.label}</span>`;
                
                let progHTML = '', actBtn = '', actBtnSm = '', progHTML_compact = '';
                
                if (goal.type === 'finance') {
                    progHTML = `<div class="text-xl md:text-2xl font-bold text-slate-900 dark:text-white tracking-tight">${formatCurrency(goal.currentValue)}</div><div class="text-[11px] text-slate-500 flex gap-1"><i class="fa-solid fa-bullseye opacity-70"></i> ${formatCurrency(goal.targetValue)}</div>`;
                    progHTML_compact = `${formatCurrency(goal.currentValue)}`;
                    actBtn = `<button onclick="openUpdateModal('${goal.id}')" class="w-full flex justify-center items-center gap-1.5 bg-slate-100 dark:bg-zinc-800 text-slate-800 dark:text-zinc-200 hover:bg-slate-200 dark:hover:bg-zinc-700 py-1.5 md:py-2.5 rounded-xl text-xs md:text-sm font-medium transition-colors"><i class="fa-solid fa-pen-to-square"></i> C·∫≠p nh·∫≠t</button>`;
                    actBtnSm = `<button onclick="openUpdateModal('${goal.id}')" class="w-8 h-8 sm:w-9 sm:h-9 flex justify-center items-center bg-indigo-50 dark:bg-indigo-900/30 text-indigo-600 dark:text-indigo-400 hover:bg-indigo-100 dark:hover:bg-indigo-900/50 rounded-xl transition-colors shrink-0 shadow-sm" title="C·∫≠p nh·∫≠t"><i class="fa-solid fa-plus text-[12px]"></i></button>`;
                } else if (goal.type === 'progress') {
                    progHTML = `<div class="text-xl md:text-2xl font-bold text-slate-900 dark:text-white tracking-tight">${formatNumberRaw(goal.currentValue)} <span class="text-sm md:text-base text-slate-500">/ ${formatNumberRaw(goal.targetValue)}</span></div><div class="text-[11px] text-slate-500 uppercase flex gap-1"><i class="fa-solid fa-chart-simple opacity-70"></i> ${goal.unit || 'l·∫ßn'}</div>`;
                    progHTML_compact = `${formatNumberRaw(goal.currentValue)} / ${formatNumberRaw(goal.targetValue)} ${goal.unit||''}`;
                    actBtn = `<button onclick="openUpdateModal('${goal.id}')" class="w-full flex justify-center items-center gap-1.5 bg-slate-100 dark:bg-zinc-800 text-slate-800 dark:text-zinc-200 hover:bg-slate-200 dark:hover:bg-zinc-700 py-1.5 md:py-2.5 rounded-xl text-xs md:text-sm font-medium transition-colors"><i class="fa-solid fa-plus"></i> Ti·∫øn ƒë·ªô</button>`;
                    actBtnSm = `<button onclick="openUpdateModal('${goal.id}')" class="w-8 h-8 sm:w-9 sm:h-9 flex justify-center items-center bg-indigo-50 dark:bg-indigo-900/30 text-indigo-600 dark:text-indigo-400 hover:bg-indigo-100 dark:hover:bg-indigo-900/50 rounded-xl transition-colors shrink-0 shadow-sm" title="Ti·∫øn ƒë·ªô"><i class="fa-solid fa-plus text-[12px]"></i></button>`;
                } else {
                    progHTML = `<div class="flex items-center gap-2 py-1"><i class="fa-solid ${isComp?'fa-check text-emerald-500':'fa-hourglass-half text-slate-400'}"></i><span class="text-xs font-bold ${isComp?'text-emerald-500':'text-slate-500'}">${isComp?'HO√ÄN TH√ÄNH':'CH∆ØA XONG'}</span></div>`;
                    progHTML_compact = `<span class="text-xs font-bold ${isComp?'text-emerald-500':'text-slate-500'}">${isComp?'HO√ÄN TH√ÄNH':'CH∆ØA XONG'}</span>`;
                    actBtn = `<button onclick="toggleSimpleGoal('${goal.id}')" class="w-full flex justify-center items-center gap-1.5 ${isComp?'bg-slate-100 dark:bg-zinc-800 text-slate-600 dark:text-zinc-400 hover:bg-slate-200 dark:hover:bg-zinc-700':'bg-emerald-500 hover:bg-emerald-600 text-white shadow-sm'} py-1.5 md:py-2.5 rounded-xl text-xs md:text-sm font-medium transition-colors"><i class="fa-solid ${isComp?'fa-rotate-left':'fa-check'}"></i> ${isComp?'Ho√†n t√°c':'ƒê√£ Xong'}</button>`;
                    actBtnSm = `<button onclick="toggleSimpleGoal('${goal.id}')" class="w-8 h-8 sm:w-9 sm:h-9 flex justify-center items-center ${isComp?'bg-slate-100 dark:bg-zinc-800 text-slate-500':'bg-emerald-100 dark:bg-emerald-900/30 text-emerald-600 dark:text-emerald-400'} hover:opacity-80 rounded-xl transition-colors shadow-sm"><i class="fa-solid ${isComp?'fa-rotate-left':'fa-check'} text-[12px]"></i></button>`;
                }

                // Menu 3 ch·∫•m ƒë·ªìng b·ªô
                const actionMenu = `
                    <div class="relative shrink-0 ml-1">
                        <button onclick="toggleMenu(event, '${goal.id}')" class="w-7 h-7 flex items-center justify-center text-slate-400 hover:text-slate-600 dark:text-zinc-500 dark:hover:text-zinc-300 hover:bg-slate-100 dark:hover:bg-zinc-800 rounded-lg transition-colors focus:outline-none">
                            <i class="fa-solid fa-ellipsis-vertical text-sm"></i>
                        </button>
                        <div id="menu-${goal.id}" class="absolute right-0 top-full mt-1 w-36 bg-white dark:bg-zinc-800 border border-slate-100 dark:border-zinc-700 shadow-xl rounded-xl hidden z-30 py-1.5 origin-top-right transform transition-all">
                            <button onclick="openHistoryModal('${goal.id}')" class="w-full text-left px-3 py-2 text-xs font-medium text-slate-700 dark:text-zinc-300 hover:bg-slate-50 dark:hover:bg-zinc-700/50 flex items-center gap-2.5"><i class="fa-solid fa-clock-rotate-left w-3.5 text-center text-slate-400"></i> L·ªãch s·ª≠</button>
                            <button onclick="openGoalModal('${goal.id}')" class="w-full text-left px-3 py-2 text-xs font-medium text-slate-700 dark:text-zinc-300 hover:bg-slate-50 dark:hover:bg-zinc-700/50 flex items-center gap-2.5"><i class="fa-solid fa-pen w-3.5 text-center text-slate-400"></i> Ch·ªânh s·ª≠a</button>
                            <div class="h-px bg-slate-100 dark:bg-zinc-700/50 my-1.5"></div>
                            <button onclick="deleteGoal('${goal.id}')" class="w-full text-left px-3 py-2 text-xs font-medium text-red-600 dark:text-red-400 hover:bg-red-50 dark:hover:bg-red-900/20 flex items-center gap-2.5"><i class="fa-solid fa-trash w-3.5 text-center text-red-400"></i> X√≥a b·ªè</button>
                        </div>
                    </div>`;

                // Menu 3 ch·∫•m n·ªïi (Frosted Glass cho Grid View)
                const actionMenuFloating = `
                    <div class="absolute top-2 right-2 z-10">
                        <button onclick="toggleMenu(event, '${goal.id}')" class="w-8 h-8 flex items-center justify-center text-slate-700 dark:text-zinc-200 bg-white/90 dark:bg-zinc-900/90 backdrop-blur-sm hover:bg-white dark:hover:bg-zinc-800 rounded-xl shadow-sm transition-colors focus:outline-none">
                            <i class="fa-solid fa-ellipsis-vertical text-sm"></i>
                        </button>
                        <div id="menu-${goal.id}" class="absolute right-0 top-full mt-1 w-36 bg-white dark:bg-zinc-800 border border-slate-100 dark:border-zinc-700 shadow-xl rounded-xl hidden z-30 py-1.5 origin-top-right transform transition-all">
                            <button onclick="openHistoryModal('${goal.id}')" class="w-full text-left px-3 py-2 text-xs font-medium text-slate-700 dark:text-zinc-300 hover:bg-slate-50 dark:hover:bg-zinc-700/50 flex items-center gap-2.5"><i class="fa-solid fa-clock-rotate-left w-3.5 text-center text-slate-400"></i> L·ªãch s·ª≠</button>
                            <button onclick="openGoalModal('${goal.id}')" class="w-full text-left px-3 py-2 text-xs font-medium text-slate-700 dark:text-zinc-300 hover:bg-slate-50 dark:hover:bg-zinc-700/50 flex items-center gap-2.5"><i class="fa-solid fa-pen w-3.5 text-center text-slate-400"></i> Ch·ªânh s·ª≠a</button>
                            <div class="h-px bg-slate-100 dark:bg-zinc-700/50 my-1.5"></div>
                            <button onclick="deleteGoal('${goal.id}')" class="w-full text-left px-3 py-2 text-xs font-medium text-red-600 dark:text-red-400 hover:bg-red-50 dark:hover:bg-red-900/20 flex items-center gap-2.5"><i class="fa-solid fa-trash w-3.5 text-center text-red-400"></i> X√≥a b·ªè</button>
                        </div>
                    </div>`;

                // Render Slideshow
                let imagesHTML = '', thumbnailHTML = '';
                if(goal.imageUrls && goal.imageUrls.length > 0) {
                    const slides = goal.imageUrls.map(url => `<img src="${url}" class="snap-center w-full h-full object-cover shrink-0">`).join('');
                    const arrows = goal.imageUrls.length > 1 ? `
                        <button onclick="scrollSlides('${goal.id}', -1)" class="absolute left-2 top-1/2 -translate-y-1/2 w-6 h-6 rounded-full bg-black/40 text-white flex items-center justify-center opacity-0 group-hover:opacity-100 transition-opacity backdrop-blur-sm pointer-events-auto"><i class="fa-solid fa-chevron-left text-[10px]"></i></button>
                        <button onclick="scrollSlides('${goal.id}', 1)" class="absolute right-2 top-1/2 -translate-y-1/2 w-6 h-6 rounded-full bg-black/40 text-white flex items-center justify-center opacity-0 group-hover:opacity-100 transition-opacity backdrop-blur-sm pointer-events-auto"><i class="fa-solid fa-chevron-right text-[10px]"></i></button>
                        <div class="absolute bottom-2 right-3 px-2 py-0.5 rounded-md bg-black/50 backdrop-blur-sm text-[10px] text-white font-medium flex items-center gap-1"><i class="fa-regular fa-images"></i> ${goal.imageUrls.length}</div>
                    ` : '';
                    imagesHTML = `<div class="relative w-full h-full overflow-hidden group/slide"><div id="slide-${goal.id}" class="flex overflow-x-auto snap-x snap-mandatory scrollbar-hide h-full w-full">${slides}</div>${arrows}</div>`;
                    thumbnailHTML = `<img src="${goal.imageUrls[0]}" class="w-full h-full object-cover">`;
                } else {
                    imagesHTML = `<div class="w-full h-full bg-gradient-to-br from-slate-800 to-slate-900 dark:from-zinc-800 dark:to-zinc-950 flex items-center justify-center"><i class="fa-solid fa-star text-3xl text-white/10"></i></div>`;
                    thumbnailHTML = `<div class="w-full h-full bg-gradient-to-br from-slate-800 to-slate-900 dark:from-zinc-800 dark:to-zinc-950 flex items-center justify-center"><i class="fa-solid fa-star text-white/20"></i></div>`;
                }

                // --- RENDER MINIMAL VIEW ---
                if (currentViewMode === 'minimal') {
                    return `
                    <div class="bg-white dark:bg-zinc-900 p-2.5 sm:p-3 rounded-2xl border border-slate-200 dark:border-zinc-800 flex items-center gap-2.5 sm:gap-4 hover:shadow-sm transition-all relative ${isComp ? 'ring-1 ring-emerald-500/50' : ''}">
                        <div class="w-12 h-12 sm:w-14 sm:h-14 shrink-0 rounded-xl overflow-hidden bg-slate-100 dark:bg-zinc-800 relative border border-slate-100 dark:border-zinc-800/50">${thumbnailHTML}</div>
                        <div class="flex-1 min-w-0 py-0.5">
                            <div class="flex items-center gap-1.5 mb-0.5 overflow-x-auto scrollbar-hide">
                                ${priorityBadge}
                            </div>
                            <h3 class="text-[13px] sm:text-base font-semibold text-slate-900 dark:text-white truncate mb-1" title="${goal.title}">${goal.title}</h3>
                            <div class="flex items-center gap-2">
                                <div class="flex-1 max-w-[120px] bg-slate-100 dark:bg-zinc-800 rounded-full h-1 overflow-hidden"><div class="${isComp?'bg-emerald-500':'bg-slate-900 dark:bg-indigo-500'} h-full rounded-full transition-all" style="width: ${prog}%"></div></div>
                                <span class="text-[9px] sm:text-[10px] text-slate-500 font-medium">${prog}%</span>
                            </div>
                        </div>
                        <div class="flex items-center gap-1.5 shrink-0 pl-1">
                            ${actBtnSm}
                            ${actionMenu}
                        </div>
                    </div>`;
                } 
                // --- RENDER LIST VIEW ---
                else if (currentViewMode === 'list') {
                    return `
                    <div class="bg-white dark:bg-zinc-900 rounded-2xl border border-slate-200 dark:border-zinc-800 flex flex-row hover:shadow-md transition-all overflow-hidden min-h-[100px] sm:min-h-[128px] ${isComp ? 'ring-1 ring-emerald-500/50' : ''}">
                        <div class="w-24 sm:w-36 shrink-0 relative border-r border-slate-100 dark:border-zinc-800">${imagesHTML}</div>
                        <div class="p-3 sm:p-4 flex flex-col justify-between flex-1 min-w-0">
                            <div class="flex justify-between items-start gap-2 mb-2">
                                <div class="min-w-0 flex-1">
                                    <div class="flex items-center gap-1.5 mb-1.5 overflow-x-auto scrollbar-hide">
                                        ${priorityBadge}
                                        <span class="text-[9px] sm:text-[10px] bg-slate-100 dark:bg-zinc-800 px-1.5 py-0.5 rounded text-slate-600 dark:text-zinc-400 whitespace-nowrap">${goal.category}</span>
                                    </div>
                                    <h3 class="text-sm sm:text-base font-semibold text-slate-900 dark:text-white line-clamp-1 sm:line-clamp-2 leading-tight" title="${goal.title}">${goal.title}</h3>
                                </div>
                                ${actionMenu}
                            </div>
                            <div class="flex flex-row items-end justify-between gap-3 mt-auto">
                                <div class="flex-1 min-w-0">
                                    <div class="text-[11px] sm:text-sm font-bold text-slate-900 dark:text-white truncate">${progHTML_compact}</div>
                                    <div class="w-full bg-slate-100 dark:bg-zinc-800 rounded-full h-1 sm:h-1.5 mt-1 max-w-[120px]"><div class="${isComp?'bg-emerald-500':'bg-slate-900 dark:bg-indigo-500'} h-full rounded-full transition-all" style="width: ${prog}%"></div></div>
                                </div>
                                <div class="shrink-0">
                                    <!-- Hi·ªÉn th·ªã n√∫t nh·ªè tr√™n mobile, n√∫t l·ªõn tr√™n desktop -->
                                    <div class="sm:hidden">${actBtnSm}</div>
                                    <div class="hidden sm:block w-28">${actBtn}</div>
                                </div>
                            </div>
                        </div>
                    </div>`;
                }
                
                // --- RENDER GRID VIEW ---
                return `
                <div class="bg-white dark:bg-zinc-900 rounded-2xl border border-slate-200 dark:border-zinc-800 flex flex-col h-full hover:shadow-lg transition-all overflow-hidden relative group ${isComp ? 'ring-2 ring-emerald-400/80 dark:ring-emerald-500/50' : ''}">
                    <div class="h-36 md:h-40 w-full relative shrink-0">
                        ${imagesHTML}
                        <div class="absolute top-2 left-2 bg-white/90 dark:bg-zinc-900/90 backdrop-blur-sm text-[10px] px-2 py-1 rounded-md text-slate-700 dark:text-zinc-200">${goal.category||'Kh√°c'}</div>
                        ${actionMenuFloating}
                    </div>
                    <div class="p-4 flex flex-col flex-grow">
                        <div class="flex justify-between items-start mb-2 gap-2">
                            <div>
                                <h3 class="text-lg font-semibold text-slate-900 dark:text-white line-clamp-2 leading-tight">${goal.title}</h3>
                                <div class="mt-1.5">${priorityBadge}</div>
                            </div>
                        </div>
                        ${goal.description ? `<div class="text-[11px] text-slate-500 dark:text-zinc-400 mb-3 line-clamp-2 mt-1">${linkify(goal.description)}</div>` : ''}
                        
                        <div class="mt-auto mb-4">${progHTML}</div>
                        
                        <div class="mb-4">
                            <div class="flex justify-between text-[11px] font-medium mb-1.5"><span class="${isComp?'text-emerald-500':'text-slate-700 dark:text-zinc-300'}">${prog}%</span><span class="text-slate-400">${days>0?`C√≤n ${days} ng√†y`:'H·∫øt h·∫°n'}</span></div>
                            <div class="w-full bg-slate-100 dark:bg-zinc-800 rounded-full h-1.5"><div class="${isComp?'bg-emerald-500':'bg-slate-900 dark:bg-indigo-500'} h-full rounded-full transition-all" style="width: ${prog}%"></div></div>
                        </div>
                        <div class="pt-3 border-t border-slate-100 dark:border-zinc-800">${actBtn}</div>
                    </div>
                </div>`;
            }).join('');
        }

        // --- GOAL FORM LOGIC ---
        function toggleTypeFields() {
            const type = document.querySelector('input[name="goalType"]:checked').value;
            ['fieldFinance','fieldProgress','fieldSimple'].forEach(id => document.getElementById(id).classList.add('hidden'));
            document.getElementById('financeAmount').required = false; document.getElementById('progressAmount').required = false;
            
            if (type === 'finance') { document.getElementById('fieldFinance').classList.remove('hidden'); document.getElementById('financeAmount').required = true; }
            else if (type === 'progress') { document.getElementById('fieldProgress').classList.remove('hidden'); document.getElementById('progressAmount').required = true; }
            else { document.getElementById('fieldSimple').classList.remove('hidden'); }
        }

        function openGoalModal(id = null) {
            tempImageUrls = []; renderImagePreviews();
            const form = document.getElementById('goalForm'); form.reset();
            
            if (id) {
                const goal = goals.find(g => g.id === id);
                document.getElementById('goalModalTitle').innerText = 'Ch·ªânh s·ª≠a ∆∞·ªõc m∆°';
                document.getElementById('goalId').value = goal.id;
                document.getElementById('goalTitle').value = goal.title;
                document.getElementById('goalDate').value = goal.targetDate;
                document.getElementById('goalCategory').value = goal.category || 'Kh√°c';
                document.getElementById('goalPriority').value = goal.priority || 'medium';
                document.getElementById('goalDescription').value = goal.description || '';
                
                document.querySelector(`input[name="goalType"][value="${goal.type}"]`).checked = true; toggleTypeFields();
                if (goal.type === 'finance') document.getElementById('financeAmount').value = formatNumberRaw(goal.targetValue);
                else if (goal.type === 'progress') { document.getElementById('progressAmount').value = formatNumberRaw(goal.targetValue); document.getElementById('progressUnit').value = goal.unit || ''; }
                
                if (goal.imageUrls) { tempImageUrls = [...goal.imageUrls]; renderImagePreviews(); }
            } else {
                document.getElementById('goalModalTitle').innerText = 'Th√™m ∆∞·ªõc m∆° m·ªõi';
                document.getElementById('goalId').value = '';
                document.getElementById('goalPriority').value = 'medium';
                document.querySelector('input[name="goalType"][value="finance"]').checked = true; toggleTypeFields();
            }
            openModal('goalModal');
        }

        function handleSaveGoal(e) {
            e.preventDefault();
            if(!document.getElementById('goalTitle').value || !document.getElementById('goalDate').value) {
                customAlert('Vui l√≤ng nh·∫≠p t√™n v√† ng√†y m·ª•c ti√™u.', 'Thi·∫øu th√¥ng tin', 'warning'); return;
            }

            const id = document.getElementById('goalId').value;
            const type = document.querySelector('input[name="goalType"]:checked').value;
            let targetValue = 1, unit = '';

            if (type === 'finance') {
                targetValue = parseFormattedNumber(document.getElementById('financeAmount').value);
                if (targetValue <= 0) { customAlert('Nh·∫≠p s·ªë ti·ªÅn h·ª£p l·ªá.', '', 'warning'); return; }
            } else if (type === 'progress') {
                targetValue = parseFormattedNumber(document.getElementById('progressAmount').value);
                unit = document.getElementById('progressUnit').value;
                if (targetValue <= 0) { customAlert('Nh·∫≠p s·ªë l∆∞·ª£ng h·ª£p l·ªá.', '', 'warning'); return; }
            }

            const data = { type, title: document.getElementById('goalTitle').value, targetValue, unit, targetDate: document.getElementById('goalDate').value, category: document.getElementById('goalCategory').value, priority: document.getElementById('goalPriority').value, description: document.getElementById('goalDescription').value, imageUrls: [...tempImageUrls] };

            if (id) {
                const idx = goals.findIndex(g => g.id === id);
                let currentVal = goals[idx].type === type ? goals[idx].currentValue : 0;
                goals[idx] = { ...goals[idx], ...data, currentValue: currentVal };
                addLog(id, data.title, type, 'EDIT', 'ƒê√£ ch·ªânh s·ª≠a th√¥ng tin');
            } else {
                const newId = Date.now().toString();
                goals.unshift({ id: newId, currentValue: 0, ...data });
                addLog(newId, data.title, type, 'CREATE', `ƒê√£ t·∫°o ∆∞·ªõc m∆°: ${type==='finance'?formatCurrency(targetValue):(type==='progress'?formatNumberRaw(targetValue)+' '+unit:'1 l·∫ßn')}`);
            }

            saveData(); renderGoals(); closeModal('goalModal');
        }

        function deleteGoal(id) {
            customConfirm('X√≥a ∆∞·ªõc m∆° n√†y kh·ªèi danh s√°ch? H√†nh ƒë·ªông n√†y kh√¥ng th·ªÉ ho√†n t√°c.', () => {
                goals = goals.filter(g => g.id !== id);
                historyLogs = historyLogs.filter(h => h.goalId !== id);
                saveData(); saveHistory(); renderGoals();
            });
        }

        // --- UPDATE PROGRESS LOGIC ---
        function toggleSimpleGoal(id) {
            const idx = goals.findIndex(g => g.id === id);
            if (idx > -1) {
                const isComplete = goals[idx].currentValue >= 1;
                goals[idx].currentValue = isComplete ? 0 : 1;
                addLog(id, goals[idx].title, goals[idx].type, isComplete?'UNCOMPLETE':'COMPLETE', isComplete?'B·ªè ƒë√°nh d·∫•u ho√†n th√†nh':'Tuy·ªát v·ªùi! ƒê√£ ho√†n th√†nh!');
                saveData(); renderGoals();
            }
        }

        function openUpdateModal(id) {
            const goal = goals.find(g => g.id === id); if (!goal) return;
            document.getElementById('updateGoalId').value = id;
            document.getElementById('updateGoalType').value = goal.type;
            document.getElementById('updateNote').value = '';
            
            const hint = document.getElementById('updateHint');
            document.getElementById('updateFinanceWrapper').classList.add('hidden');
            document.getElementById('updateProgressWrapper').classList.add('hidden');
            document.getElementById('updateFinanceAmount').required = false; document.getElementById('updateProgressAmount').required = false;

            if (goal.type === 'finance') {
                hint.innerHTML = `Hi·ªán c√≥: <strong>${formatCurrency(goal.currentValue)}</strong> / ${formatCurrency(goal.targetValue)}`;
                document.getElementById('updateFinanceWrapper').classList.remove('hidden');
                document.getElementById('updateFinanceAmount').required = true; document.getElementById('updateFinanceAmount').value = '';
            } else if (goal.type === 'progress') {
                hint.innerHTML = `ƒê·∫°t: <strong>${formatNumberRaw(goal.currentValue)}</strong> / ${formatNumberRaw(goal.targetValue)} ${goal.unit || ''}`;
                document.getElementById('updateProgressWrapper').classList.remove('hidden');
                document.getElementById('updateProgressUnit').innerText = goal.unit || '';
                document.getElementById('updateProgressAmount').required = true; document.getElementById('updateProgressAmount').value = '';
            }
            openModal('updateModal');
        }

        function handleUpdateProgress(e) {
            e.preventDefault();
            const id = document.getElementById('updateGoalId').value;
            const type = document.getElementById('updateGoalType').value;
            const noteText = document.getElementById('updateNote').value.trim();
            const idx = goals.findIndex(g => g.id === id); if (idx === -1) return;

            if (type === 'finance') {
                const amount = parseFormattedNumber(document.getElementById('updateFinanceAmount').value);
                if (amount <= 0) return;
                const isAdd = document.querySelector('input[name="financeAction"]:checked').value === 'add';
                goals[idx].currentValue = Math.max(0, goals[idx].currentValue + (isAdd ? amount : -amount));
                addLog(id, goals[idx].title, type, isAdd?'ADD':'SUB', `ƒê√£ ${isAdd?'n·∫°p th√™m':'r√∫t ra'} ${formatCurrency(amount)}`, noteText);
            } else if (type === 'progress') {
                const amount = parseFormattedNumber(document.getElementById('updateProgressAmount').value);
                if (amount <= 0) return;
                goals[idx].currentValue = Math.min(goals[idx].targetValue, goals[idx].currentValue + amount);
                addLog(id, goals[idx].title, type, 'ADD', `C·∫≠p nh·∫≠t ti·∫øn ƒë·ªô +${formatNumberRaw(amount)} ${goals[idx].unit||''}`, noteText);
            }
            saveData(); renderGoals(); closeModal('updateModal');
        }

        // --- HISTORY RENDER & EDIT ---
        function openHistoryModal(goalId = null) {
            currentHistoryGoalId = goalId;
            const container = document.getElementById('historyContainer');
            const title = document.getElementById('historyModalTitle');
            
            let logs = goalId ? historyLogs.filter(l => l.goalId === goalId) : historyLogs;
            title.innerText = goalId ? `L·ªãch s·ª≠: ${goals.find(g=>g.id===goalId)?.title||''}` : 'L·ªãch s·ª≠ chung';

            if (logs.length === 0) {
                container.innerHTML = '<div class="text-center py-10 text-slate-400 dark:text-zinc-600"><i class="fa-solid fa-ghost text-3xl mb-3"></i><br>Ch∆∞a c√≥ l·ªãch s·ª≠.</div>';
            } else {
                container.innerHTML = logs.map(log => {
                    const d = new Date(log.date);
                    let icon = 'fa-pen', col = 'text-blue-500 bg-blue-100 dark:bg-blue-900/30';
                    if (log.action === 'CREATE') { icon = 'fa-plus'; col = 'text-emerald-500 bg-emerald-100 dark:bg-emerald-900/30'; }
                    else if (log.action === 'DELETE') { icon = 'fa-trash'; col = 'text-red-500 bg-red-100 dark:bg-red-900/30'; }
                    else if (['ADD', 'COMPLETE'].includes(log.action)) { icon = 'fa-arrow-up'; col = 'text-emerald-500 bg-emerald-100 dark:bg-emerald-900/30'; }
                    else if (['SUB', 'UNCOMPLETE'].includes(log.action)) { icon = 'fa-arrow-down'; col = 'text-orange-500 bg-orange-100 dark:bg-orange-900/30'; }

                    return `
                        <div class="flex gap-3 bg-white dark:bg-zinc-900 p-3 rounded-xl border border-slate-200 dark:border-zinc-800 relative group">
                            <div class="w-8 h-8 rounded-full flex items-center justify-center shrink-0 ${col}"><i class="fa-solid ${icon} text-[10px]"></i></div>
                            <div class="flex-grow min-w-0 pr-10">
                                <div class="flex flex-col mb-1">
                                    <h4 class="text-xs font-semibold text-slate-900 dark:text-white truncate">${log.goalTitle}</h4>
                                    <span class="text-[9px] text-slate-400">${d.toLocaleTimeString('vi-VN',{hour:'2-digit',minute:'2-digit'})} - ${d.toLocaleDateString('vi-VN')}</span>
                                </div>
                                <p class="text-[11px] text-slate-700 dark:text-zinc-300 font-medium">${log.message}</p>
                                ${log.note ? `<div class="mt-1.5 p-1.5 bg-slate-50 dark:bg-zinc-800 rounded text-[11px] text-slate-600 dark:text-zinc-400 italic">" ${linkify(log.note)} "</div>` : ''}
                            </div>
                            <div class="absolute top-2 right-2 flex flex-col gap-1 opacity-0 group-hover:opacity-100 transition-opacity">
                                <button onclick="promptEditLog('${log.id}')" class="p-1 text-slate-400 hover:text-blue-500 rounded"><i class="fa-solid fa-pen text-[10px]"></i></button>
                                <button onclick="deleteLog('${log.id}')" class="p-1 text-slate-400 hover:text-red-500 rounded"><i class="fa-solid fa-trash text-[10px]"></i></button>
                            </div>
                        </div>`;
                }).join('');
            }
            openModal('historyModal');
        }

        function promptEditLog(id) {
            const log = historyLogs.find(l => l.id === id); if(!log) return;
            document.getElementById('editLogId').value = id;
            document.getElementById('editLogNote').value = log.note || '';
            openModal('editLogModal');
        }

        function saveEditLog() {
            const id = document.getElementById('editLogId').value;
            const newNote = document.getElementById('editLogNote').value;
            const log = historyLogs.find(l => l.id === id);
            if(log) { log.note = newNote; saveHistory(); openHistoryModal(currentHistoryGoalId); }
            closeModal('editLogModal');
        }

        function deleteLog(id) {
            customConfirm("X√≥a d√≤ng l·ªãch s·ª≠ n√†y?", () => {
                historyLogs = historyLogs.filter(l => l.id !== id);
                saveHistory(); openHistoryModal(currentHistoryGoalId);
            });
        }
    </script>
</body>
</html>