<!DOCTYPE html>
<html lang="vi">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Hũ tiết kiệm</title>
    <meta name="description" content="Tiết kiệm tiết kiệm">
    <meta name="author" content="Hunq">
    <meta name="theme-color" content="#ffffff">
    <meta name="robots" content="index, follow">
    <link rel="canonical" href="mhung.siite">
    <link rel="icon" href="/Asset/logo/logo.png">

    <meta property="og:url" content="mhung.siite">
    <meta property="og:type" content="website">
    <meta property="og:title" content="Hũ tiết kiệm">
    <meta property="og:description" content="Tiết kiệm tiết kiệm">
    <meta property="og:image" content="/Asset/Banner/Banner.png">

    <meta name="twitter:card" content="summary_large_image">
    <meta property="twitter:domain" content="mhung.siite">
    <meta property="twitter:url" content="mhung.siite">
    <meta name="twitter:title" content="Hũ tiết kiệm">
    <meta name="twitter:description" content="Tiết kiệm tiết kiệm">
    <meta name="twitter:image" content="/Asset/Banner/Banner.png">

    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <meta name="apple-mobile-web-app-title" content="Hũ tiết kiệm">
    <link rel="apple-touch-icon" href="/Asset/logo/logo.png">
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Inter', 'ui-sans-serif', 'system-ui', 'sans-serif'],
                    }
                }
            }
        }
    </script>
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        /* Tùy chỉnh thanh cuộn cho đẹp hơn */
        ::-webkit-scrollbar {
            width: 8px;
        }

        ::-webkit-scrollbar-track {
            background: transparent;
        }

        ::-webkit-scrollbar-thumb {
            background: #cbd5e1;
            border-radius: 4px;
        }

        .dark ::-webkit-scrollbar-thumb {
            background: #3f3f46;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: #94a3b8;
        }

        /* Ẩn input file mặc định */
        input[type="file"] {
            display: none;
        }
    </style>
</head>

<body
    class="bg-[#F4F6F8] dark:bg-black text-slate-800 dark:text-zinc-100 font-sans transition-colors duration-300 min-h-screen">

    <div class="max-w-7xl mx-auto p-4 md:p-8">
        <!-- Header & Theme Switcher -->
        <header class="flex flex-col md:flex-row justify-between items-start md:items-center mb-8 gap-4">
            <div>
                <h1 class="text-3xl font-bold tracking-tight text-slate-900 dark:text-white">Mục tiêu tiết kiệm</h1>
                <p class="text-slate-500 dark:text-zinc-400 mt-1">Quản lý các hũ tài chính của bạn một cách dễ dàng.</p>
            </div>

            <div class="flex items-center gap-4 w-full md:w-auto justify-between md:justify-end">
                <!-- Theme Switcher -->
                <div
                    class="flex bg-white dark:bg-zinc-900 p-1 rounded-xl border border-slate-200 dark:border-zinc-800 shadow-sm">
                    <button onclick="setTheme('light')" id="theme-light"
                        class="p-2 rounded-lg text-slate-500 hover:text-slate-900 dark:hover:text-white transition-colors"
                        title="Chế độ Sáng">
                        <i class="fa-solid fa-sun"></i>
                    </button>
                    <button onclick="setTheme('system')" id="theme-system"
                        class="p-2 rounded-lg text-slate-500 hover:text-slate-900 dark:hover:text-white transition-colors"
                        title="Theo Hệ thống">
                        <i class="fa-solid fa-desktop"></i>
                    </button>
                    <button onclick="setTheme('dark')" id="theme-dark"
                        class="p-2 rounded-lg text-slate-500 hover:text-slate-900 dark:hover:text-white transition-colors"
                        title="Chế độ Tối">
                        <i class="fa-solid fa-moon"></i>
                    </button>
                </div>

                <button onclick="openGoalModal()"
                    class="flex items-center gap-2 bg-slate-900 dark:bg-indigo-600 text-white px-5 py-2.5 rounded-xl font-medium hover:bg-slate-800 dark:hover:bg-indigo-700 transition-colors active:scale-95 shadow-sm whitespace-nowrap">
                    <i class="fa-solid fa-plus"></i>
                    Thêm hũ
                </button>
            </div>
        </header>

        <!-- Search and Filter Bar -->
        <div class="flex flex-col md:flex-row gap-4 mb-8">
            <div class="relative flex-grow">
                <i class="fa-solid fa-search absolute left-4 top-1/2 transform -translate-y-1/2 text-slate-400"></i>
                <input type="text" id="searchInput" placeholder="Tìm kiếm mục tiêu..."
                    class="w-full pl-11 pr-4 py-3 bg-white dark:bg-zinc-900 border border-slate-200 dark:border-zinc-800 rounded-xl focus:outline-none focus:ring-2 focus:ring-slate-900 dark:focus:ring-indigo-500 text-slate-900 dark:text-white transition-all shadow-sm">
            </div>
            <select id="categoryFilter"
                class="px-4 py-3 bg-white dark:bg-zinc-900 border border-slate-200 dark:border-zinc-800 rounded-xl focus:outline-none focus:ring-2 focus:ring-slate-900 dark:focus:ring-indigo-500 text-slate-900 dark:text-white transition-all shadow-sm md:w-48 appearance-none cursor-pointer">
                <option value="Tất cả">Tất cả danh mục</option>
                <option value="Mua sắm">Mua sắm</option>
                <option value="Du lịch">Du lịch</option>
                <option value="Giáo dục">Giáo dục</option>
                <option value="Nhà cửa">Nhà cửa</option>
                <option value="Khác">Khác</option>
            </select>
        </div>

        <!-- Goals Grid -->
        <!-- Goals Grid -->
        <div id="goalsContainer" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6">
            <!-- Dữ liệu sẽ được render bằng JS tại đây -->
        </div>
    </div>

    <!-- MODAL: Thêm / Sửa Mục Tiêu -->
    <div id="goalModal"
        class="fixed inset-0 z-50 hidden flex items-center justify-center p-4 bg-slate-900/40 dark:bg-black/80 backdrop-blur-sm transition-opacity">
        <div
            class="bg-white dark:bg-zinc-900 rounded-2xl w-full max-w-lg shadow-2xl overflow-hidden flex flex-col max-h-[90vh]">
            <div class="flex justify-between items-center p-6 border-b border-slate-100 dark:border-zinc-800 shrink-0">
                <h2 id="goalModalTitle" class="text-xl font-semibold text-slate-900 dark:text-white">Tạo mục tiêu mới
                </h2>
                <button onclick="closeModal('goalModal')"
                    class="text-slate-400 hover:text-slate-600 dark:hover:text-zinc-300 transition-colors">
                    <i class="fa-solid fa-xmark text-2xl"></i>
                </button>
            </div>

            <form id="goalForm" onsubmit="handleSaveGoal(event)" class="p-6 overflow-y-auto">
                <input type="hidden" id="goalId">
                <input type="hidden" id="goalImageUrl">

                <div class="space-y-4">
                    <!-- Ảnh bìa -->
                    <div>
                        <label class="block text-sm font-medium text-slate-700 dark:text-zinc-300 mb-1.5">Ảnh bìa (Tùy
                            chọn)</label>
                        <div class="flex items-center gap-4">
                            <label for="imageUpload"
                                class="cursor-pointer flex flex-col items-center justify-center w-24 h-24 bg-slate-50 dark:bg-zinc-800 border-2 border-dashed border-slate-300 dark:border-zinc-700 rounded-xl hover:border-slate-400 dark:hover:border-zinc-500 transition-colors relative overflow-hidden group">
                                <i class="fa-solid fa-camera text-slate-400 text-xl group-hover:text-slate-500"></i>
                                <span class="text-xs text-slate-500 mt-1">Tải ảnh</span>
                                <input type="file" id="imageUpload" accept="image/*">
                            </label>

                            <div id="imagePreviewContainer"
                                class="hidden relative w-32 h-24 rounded-xl overflow-hidden shadow-sm border border-slate-200 dark:border-zinc-700">
                                <img id="imagePreview" src="" alt="Preview" class="w-full h-full object-cover">
                                <button type="button" onclick="removeImage()"
                                    class="absolute top-1 right-1 bg-black/50 hover:bg-black/70 text-white rounded-full w-6 h-6 flex items-center justify-center backdrop-blur-sm transition-colors">
                                    <i class="fa-solid fa-xmark text-xs"></i>
                                </button>
                            </div>
                        </div>
                    </div>

                    <div>
                        <label class="block text-sm font-medium text-slate-700 dark:text-zinc-300 mb-1.5">Tên mục
                            tiêu</label>
                        <input type="text" id="goalTitle" required placeholder="VD: Mua iPhone 16 Pro"
                            class="w-full px-4 py-3 bg-slate-50 dark:bg-zinc-800 border border-slate-200 dark:border-zinc-700 rounded-xl focus:outline-none focus:ring-2 focus:ring-slate-900 dark:focus:ring-indigo-500 dark:text-white transition-all">
                    </div>

                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-slate-700 dark:text-zinc-300 mb-1.5">Số tiền
                                (VNĐ)</label>
                            <input type="number" id="goalAmount" required min="1000" placeholder="VD: 35000000"
                                class="w-full px-4 py-3 bg-slate-50 dark:bg-zinc-800 border border-slate-200 dark:border-zinc-700 rounded-xl focus:outline-none focus:ring-2 focus:ring-slate-900 dark:focus:ring-indigo-500 dark:text-white transition-all">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-slate-700 dark:text-zinc-300 mb-1.5">Ngày mục
                                tiêu</label>
                            <input type="date" id="goalDate" required
                                class="w-full px-4 py-3 bg-slate-50 dark:bg-zinc-800 border border-slate-200 dark:border-zinc-700 rounded-xl focus:outline-none focus:ring-2 focus:ring-slate-900 dark:focus:ring-indigo-500 dark:text-white transition-all">
                        </div>
                    </div>

                    <div>
                        <label class="block text-sm font-medium text-slate-700 dark:text-zinc-300 mb-1.5">Danh
                            mục</label>
                        <select id="goalCategory" required
                            class="w-full px-4 py-3 bg-slate-50 dark:bg-zinc-800 border border-slate-200 dark:border-zinc-700 rounded-xl focus:outline-none focus:ring-2 focus:ring-slate-900 dark:focus:ring-indigo-500 dark:text-white transition-all appearance-none cursor-pointer">
                            <option value="Mua sắm">Mua sắm</option>
                            <option value="Du lịch">Du lịch</option>
                            <option value="Giáo dục">Giáo dục</option>
                            <option value="Nhà cửa">Nhà cửa</option>
                            <option value="Khác">Khác</option>
                        </select>
                    </div>

                    <div>
                        <label class="block text-sm font-medium text-slate-700 dark:text-zinc-300 mb-1.5">Ghi chú / Nội
                            dung</label>
                        <textarea id="goalDescription" rows="2" placeholder="Chi tiết thêm về mục tiêu này..."
                            class="w-full px-4 py-3 bg-slate-50 dark:bg-zinc-800 border border-slate-200 dark:border-zinc-700 rounded-xl focus:outline-none focus:ring-2 focus:ring-slate-900 dark:focus:ring-indigo-500 dark:text-white transition-all resize-none"></textarea>
                    </div>
                </div>

                <div class="mt-8 flex gap-3 shrink-0">
                    <button type="button" onclick="closeModal('goalModal')"
                        class="flex-1 px-4 py-3 bg-slate-100 dark:bg-zinc-800 text-slate-700 dark:text-zinc-200 rounded-xl font-medium hover:bg-slate-200 dark:hover:bg-zinc-700 transition-colors">
                        Hủy
                    </button>
                    <button type="submit" id="goalSubmitBtn"
                        class="flex-1 px-4 py-3 bg-slate-900 dark:bg-indigo-600 text-white rounded-xl font-medium hover:bg-slate-800 dark:hover:bg-indigo-700 transition-colors">
                        Tạo mới
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- MODAL: Thêm / Rút Tiền -->
    <div id="transactionModal"
        class="fixed inset-0 z-50 hidden flex items-center justify-center p-4 bg-slate-900/40 dark:bg-black/80 backdrop-blur-sm transition-opacity">
        <div class="bg-white dark:bg-zinc-900 rounded-2xl w-full max-w-sm shadow-2xl overflow-hidden">
            <div class="flex justify-between items-center p-6 border-b border-slate-100 dark:border-zinc-800">
                <div class="flex items-center gap-2">
                    <i id="transactionIcon" class="fa-solid fa-wallet text-2xl"></i>
                    <h2 id="transactionTitle" class="text-xl font-semibold text-slate-900 dark:text-white">Giao dịch
                    </h2>
                </div>
                <button onclick="closeModal('transactionModal')"
                    class="text-slate-400 hover:text-slate-600 dark:hover:text-zinc-300">
                    <i class="fa-solid fa-xmark text-2xl"></i>
                </button>
            </div>

            <form id="transactionForm" onsubmit="handleTransaction(event)" class="p-6">
                <input type="hidden" id="transGoalId">
                <input type="hidden" id="transType">

                <div>
                    <label class="block text-sm font-medium text-slate-700 dark:text-zinc-300 mb-1.5">Nhập số tiền
                        (VNĐ)</label>
                    <input type="number" id="transAmount" required min="1000" placeholder="VD: 500000"
                        class="w-full px-4 py-3 bg-slate-50 dark:bg-zinc-800 border border-slate-200 dark:border-zinc-700 rounded-xl focus:outline-none focus:ring-2 focus:ring-slate-900 dark:focus:ring-indigo-500 dark:text-white text-lg font-medium transition-all">
                </div>

                <div class="mt-8">
                    <button type="submit" id="transSubmitBtn"
                        class="w-full px-4 py-3 text-white rounded-xl font-medium transition-colors">
                        Xác nhận
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- JavaScript Logic -->
    <script>
        // --- QUẢN LÝ DỮ LIỆU & STATE ---
        let goals = JSON.parse(localStorage.getItem('savings_goals')) || [];
        let currentTheme = localStorage.getItem('savings_theme') || 'system';

        // Khởi tạo ứng dụng
        document.addEventListener('DOMContentLoaded', () => {
            initTheme();
            renderGoals();

            // Lắng nghe sự kiện tìm kiếm & lọc
            document.getElementById('searchInput').addEventListener('input', renderGoals);
            document.getElementById('categoryFilter').addEventListener('change', renderGoals);
        });

        // Lấy dữ liệu mục tiêu ví dụ nếu chưa có gì (chạy lần đầu)
        if (goals.length === 0) {
            goals = [
                {
                    id: Date.now().toString(),
                    title: 'Mua iPhone 16 Pro',
                    category: 'Mua sắm',
                    description: 'Bản 256GB Titan tự nhiên',
                    targetAmount: 35000000,
                    currentAmount: 5000000,
                    targetDate: '2026-09-19',
                    imageUrl: 'https://images.unsplash.com/photo-1603898037225-9bc306c28f11?auto=format&fit=crop&q=80&w=800'
                }
            ];
            saveData();
        }

        // --- QUẢN LÝ THEME (GIAO DIỆN) ---
        function initTheme() {
            setTheme(currentTheme, false);
            // Lắng nghe thay đổi hệ thống
            window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', () => {
                if (currentTheme === 'system') applyThemeToDOM('system');
            });
        }

        function setTheme(theme, save = true) {
            currentTheme = theme;
            if (save) localStorage.setItem('savings_theme', theme);

            // Cập nhật UI nút bấm
            document.querySelectorAll('#theme-light, #theme-system, #theme-dark').forEach(btn => {
                btn.classList.remove('bg-slate-100', 'dark:bg-zinc-800', 'shadow-inner');
            });
            document.getElementById(`theme-${theme}`).classList.add('bg-slate-100', 'dark:bg-zinc-800', 'shadow-inner');

            applyThemeToDOM(theme);
        }

        function applyThemeToDOM(theme) {
            const isDark = theme === 'dark' || (theme === 'system' && window.matchMedia('(prefers-color-scheme: dark)').matches);
            if (isDark) {
                document.documentElement.classList.add('dark');
            } else {
                document.documentElement.classList.remove('dark');
            }
        }

        // --- TIỆN ÍCH ---
        const formatCurrency = (amount) => new Intl.NumberFormat('vi-VN', { style: 'currency', currency: 'VND' }).format(amount);

        const calculateProgress = (current, target) => {
            const percent = (current / target) * 100;
            return percent > 100 ? 100 : percent.toFixed(1);
        };

        const getDaysLeft = (targetDate) => {
            const diffDays = Math.ceil((new Date(targetDate) - new Date()) / (1000 * 60 * 60 * 24));
            return diffDays > 0 ? diffDays : 0;
        };

        function saveData() {
            try {
                localStorage.setItem('savings_goals', JSON.stringify(goals));
            } catch (e) {
                alert("Bộ nhớ trình duyệt đã đầy (Quota Exceeded). Vui lòng xóa bớt mục tiêu hoặc ảnh kích thước lớn.");
            }
        }

        // --- QUẢN LÝ ẢNH TRÌNH DUYỆT (LOCAL BASE64) ---
        document.getElementById('imageUpload').addEventListener('change', function (e) {
            const file = e.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function (event) {
                const img = new Image();
                img.onload = function () {
                    // Nén ảnh bằng Canvas để tránh làm đầy localStorage
                    const canvas = document.createElement('canvas');
                    const MAX_WIDTH = 600;
                    const MAX_HEIGHT = 600;
                    let width = img.width;
                    let height = img.height;

                    if (width > height) {
                        if (width > MAX_WIDTH) { height *= MAX_WIDTH / width; width = MAX_WIDTH; }
                    } else {
                        if (height > MAX_HEIGHT) { width *= MAX_HEIGHT / height; height = MAX_HEIGHT; }
                    }

                    canvas.width = width;
                    canvas.height = height;
                    const ctx = canvas.getContext('2d');
                    ctx.drawImage(img, 0, 0, width, height);

                    // Chuyển thành chuỗi Base64 JPEG chất lượng 0.7
                    const dataUrl = canvas.toDataURL('image/jpeg', 0.7);

                    document.getElementById('goalImageUrl').value = dataUrl;
                    document.getElementById('imagePreview').src = dataUrl;
                    document.getElementById('imagePreviewContainer').classList.remove('hidden');
                };
                img.src = event.target.result;
            };
            reader.readAsDataURL(file);
        });

        function removeImage() {
            document.getElementById('goalImageUrl').value = '';
            document.getElementById('imageUpload').value = '';
            document.getElementById('imagePreviewContainer').classList.add('hidden');
        }

        // --- RENDER GIAO DIỆN ---
        function renderGoals() {
            const container = document.getElementById('goalsContainer');
            const searchQuery = document.getElementById('searchInput').value.toLowerCase();
            const filterCategory = document.getElementById('categoryFilter').value;

            // Lọc dữ liệu
            const filteredGoals = goals.filter(goal => {
                const matchSearch = goal.title.toLowerCase().includes(searchQuery) || (goal.description || '').toLowerCase().includes(searchQuery);
                const matchCategory = filterCategory === 'Tất cả' || goal.category === filterCategory;
                return matchSearch && matchCategory;
            });

            if (filteredGoals.length === 0) {
                container.innerHTML = `
                    <div class="col-span-full text-center py-20 bg-white dark:bg-zinc-900 rounded-2xl border border-slate-200 dark:border-zinc-800 border-dashed">
                        <div class="w-16 h-16 bg-slate-50 dark:bg-zinc-800 rounded-full flex items-center justify-center mx-auto mb-4">
                            <i class="fa-solid fa-bullseye text-2xl text-slate-400 dark:text-zinc-500"></i>
                        </div>
                        <h3 class="text-lg font-medium text-slate-900 dark:text-white">Không tìm thấy mục tiêu nào</h3>
                        <p class="text-slate-500 dark:text-zinc-400 mt-1">Hãy thử tìm kiếm khác hoặc thêm mục tiêu mới.</p>
                    </div>
                `;
                return;
            }

            container.innerHTML = filteredGoals.map(goal => {
                const progress = calculateProgress(goal.currentAmount, goal.targetAmount);
                const daysLeft = getDaysLeft(goal.targetDate);

                // Mã HTML cho 1 thẻ Goal
                return `
                <div class="bg-white dark:bg-zinc-900 rounded-2xl border border-slate-200 dark:border-zinc-800 flex flex-col h-full hover:border-slate-300 dark:hover:border-zinc-700 hover:shadow-lg transition-all overflow-hidden group">
                    <!-- Ảnh Cover -->
                    <div class="h-40 w-full bg-slate-100 dark:bg-zinc-800 relative overflow-hidden shrink-0">
                        ${goal.imageUrl
                        ? `<img src="${goal.imageUrl}" alt="${goal.title}" class="w-full h-full object-cover group-hover:scale-105 transition-transform duration-500" onerror="this.src='https://images.unsplash.com/photo-1579621970563-ebec7560ff3e?auto=format&fit=crop&q=80&w=800'">`
                        : `<div class="w-full h-full bg-gradient-to-br from-slate-800 to-slate-900 dark:from-indigo-950 dark:to-black flex items-center justify-center">
                                 <i class="fa-solid fa-crosshairs text-4xl text-white/20"></i>
                               </div>`
                    }
                        
                        <!-- Tags & Actions trên ảnh -->
                        <div class="absolute top-3 left-3">
                            <span class="bg-white/90 dark:bg-zinc-900/90 backdrop-blur-sm text-xs font-semibold px-2.5 py-1 rounded-lg text-slate-700 dark:text-zinc-200 shadow-sm border border-white/20 dark:border-zinc-700/50">
                                ${goal.category || 'Khác'}
                            </span>
                        </div>
                        <div class="absolute top-3 right-3 flex gap-2">
                            <button onclick="openGoalModal('${goal.id}')" class="w-8 h-8 flex items-center justify-center bg-white/90 dark:bg-zinc-900/90 backdrop-blur-sm text-slate-700 dark:text-zinc-300 hover:text-indigo-600 dark:hover:text-indigo-400 rounded-xl shadow-sm transition-all" title="Chỉnh sửa">
                                <i class="fa-solid fa-pen text-sm"></i>
                            </button>
                            <button onclick="deleteGoal('${goal.id}')" class="w-8 h-8 flex items-center justify-center bg-white/90 dark:bg-zinc-900/90 backdrop-blur-sm text-red-500 hover:text-red-400 rounded-xl shadow-sm transition-all" title="Xóa">
                                <i class="fa-solid fa-trash text-sm"></i>
                            </button>
                        </div>
                    </div>

                    <div class="p-5 flex flex-col flex-grow">
                        <!-- Thông tin cơ bản -->
                        <div class="mb-4">
                            <h3 class="text-xl font-semibold text-slate-900 dark:text-white line-clamp-1" title="${goal.title}">${goal.title}</h3>
                            ${goal.description ? `<p class="text-sm text-slate-500 dark:text-zinc-400 mt-1 line-clamp-2">${goal.description}</p>` : ''}
                        </div>

                        <!-- Số tiền -->
                        <div class="mb-5 mt-auto">
                            <div class="text-3xl font-bold text-slate-900 dark:text-white mb-1 tracking-tight">
                                ${formatCurrency(goal.currentAmount)}
                            </div>
                            <div class="text-sm text-slate-500 dark:text-zinc-400 flex items-center gap-1.5 font-medium">
                                <i class="fa-solid fa-bullseye opacity-70"></i>
                                Mục tiêu: ${formatCurrency(goal.targetAmount)}
                            </div>
                        </div>

                        <!-- Tiến độ -->
                        <div class="mb-5">
                            <div class="flex justify-between text-sm font-medium mb-2">
                                <span class="text-slate-700 dark:text-zinc-300">${progress}%</span>
                                <span class="text-slate-500 dark:text-zinc-400 flex items-center gap-1.5">
                                    <i class="fa-regular fa-calendar opacity-70"></i>
                                    Còn ${daysLeft} ngày
                                </span>
                            </div>
                            <div class="w-full bg-slate-100 dark:bg-zinc-800 rounded-full h-2.5 overflow-hidden">
                                <div class="bg-slate-900 dark:bg-indigo-500 h-full rounded-full transition-all duration-700 ease-out" style="width: ${progress}%"></div>
                            </div>
                        </div>

                        <!-- Nút Giao dịch -->
                        <div class="grid grid-cols-2 gap-3 pt-4 border-t border-slate-100 dark:border-zinc-800">
                            <button onclick="openTransactionModal('${goal.id}', 'withdraw')" class="flex items-center justify-center gap-2 bg-slate-50 dark:bg-zinc-800 text-slate-700 dark:text-zinc-200 hover:bg-slate-100 dark:hover:bg-zinc-700 border border-slate-200 dark:border-zinc-700 py-2.5 rounded-xl font-medium transition-colors">
                                <i class="fa-solid fa-minus"></i> Rút
                            </button>
                            <button onclick="openTransactionModal('${goal.id}', 'add')" class="flex items-center justify-center gap-2 bg-slate-900 dark:bg-indigo-600 text-white hover:bg-slate-800 dark:hover:bg-indigo-700 py-2.5 rounded-xl font-medium transition-colors shadow-sm">
                                <i class="fa-solid fa-plus"></i> Thêm
                            </button>
                        </div>
                    </div>
                </div>
                `;
            }).join('');
        }

        // --- QUẢN LÝ MODAL & FORM ---
        function openModal(modalId) {
            const modal = document.getElementById(modalId);
            modal.classList.remove('hidden');
        }

        function closeModal(modalId) {
            document.getElementById(modalId).classList.add('hidden');
        }

        function openGoalModal(id = null) {
            removeImage(); // Xóa preview ảnh cũ
            const form = document.getElementById('goalForm');

            if (id) {
                const goal = goals.find(g => g.id === id);
                document.getElementById('goalModalTitle').innerText = 'Chỉnh sửa mục tiêu';
                document.getElementById('goalSubmitBtn').innerText = 'Cập nhật';

                document.getElementById('goalId').value = goal.id;
                document.getElementById('goalTitle').value = goal.title;
                document.getElementById('goalAmount').value = goal.targetAmount;
                document.getElementById('goalDate').value = goal.targetDate;
                document.getElementById('goalCategory').value = goal.category || 'Khác';
                document.getElementById('goalDescription').value = goal.description || '';

                if (goal.imageUrl) {
                    document.getElementById('goalImageUrl').value = goal.imageUrl;
                    document.getElementById('imagePreview').src = goal.imageUrl;
                    document.getElementById('imagePreviewContainer').classList.remove('hidden');
                }
            } else {
                document.getElementById('goalModalTitle').innerText = 'Tạo mục tiêu mới';
                document.getElementById('goalSubmitBtn').innerText = 'Tạo mới';
                form.reset();
                document.getElementById('goalId').value = '';
                document.getElementById('goalCategory').value = 'Mua sắm';
            }
            openModal('goalModal');
        }

        function handleSaveGoal(e) {
            e.preventDefault();
            const id = document.getElementById('goalId').value;

            const goalData = {
                title: document.getElementById('goalTitle').value,
                targetAmount: Number(document.getElementById('goalAmount').value),
                targetDate: document.getElementById('goalDate').value,
                category: document.getElementById('goalCategory').value,
                description: document.getElementById('goalDescription').value,
                imageUrl: document.getElementById('goalImageUrl').value
            };

            if (id) {
                // Cập nhật
                const index = goals.findIndex(g => g.id === id);
                if (index > -1) {
                    goals[index] = { ...goals[index], ...goalData };
                }
            } else {
                // Thêm mới
                goals.push({
                    id: Date.now().toString(),
                    currentAmount: 0,
                    ...goalData
                });
            }

            saveData();
            renderGoals();
            closeModal('goalModal');
        }

        function deleteGoal(id) {
            if (confirm('Bạn có chắc chắn muốn xóa mục tiêu này? Hành động này không thể hoàn tác.')) {
                goals = goals.filter(g => g.id !== id);
                saveData();
                renderGoals();
            }
        }

        // --- GIAO DỊCH (NẠP / RÚT) ---
        function openTransactionModal(id, type) {
            document.getElementById('transGoalId').value = id;
            document.getElementById('transType').value = type;
            document.getElementById('transAmount').value = '';

            const title = document.getElementById('transactionTitle');
            const icon = document.getElementById('transactionIcon');
            const btn = document.getElementById('transSubmitBtn');

            if (type === 'add') {
                title.innerText = 'Thêm tiền vào hũ';
                icon.className = 'fa-solid fa-wallet text-2xl text-emerald-500';
                btn.innerText = 'Xác nhận nạp';
                btn.className = 'w-full px-4 py-3 text-white rounded-xl font-medium transition-colors bg-slate-900 hover:bg-slate-800 dark:bg-emerald-600 dark:hover:bg-emerald-700 shadow-sm';
            } else {
                title.innerText = 'Rút tiền từ hũ';
                icon.className = 'fa-solid fa-money-bill-transfer text-2xl text-red-500';
                btn.innerText = 'Xác nhận rút';
                btn.className = 'w-full px-4 py-3 text-white rounded-xl font-medium transition-colors bg-red-500 hover:bg-red-600 shadow-sm';
            }

            openModal('transactionModal');
            setTimeout(() => document.getElementById('transAmount').focus(), 100);
        }

        function handleTransaction(e) {
            e.preventDefault();
            const id = document.getElementById('transGoalId').value;
            const type = document.getElementById('transType').value;
            const amount = Number(document.getElementById('transAmount').value);

            if (amount <= 0) return;

            const index = goals.findIndex(g => g.id === id);
            if (index > -1) {
                if (type === 'add') {
                    goals[index].currentAmount += amount;
                } else if (type === 'withdraw') {
                    goals[index].currentAmount = Math.max(0, goals[index].currentAmount - amount);
                }
                saveData();
                renderGoals();
                closeModal('transactionModal');
            }
        }
    </script>
</body>

</html>