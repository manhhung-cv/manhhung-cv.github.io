<!DOCTYPE html>
<html lang="vi">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Tr√¨nh Qu·∫£n L√Ω ƒê∆°n H√†ng ‚ú®</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.7.77/Tone.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Nunito:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">

    <meta name="apple-mobile-web-app-capable" content="yes">

    <link rel="icon" href="logo.png" />

    <link rel="apple-touch-icon" href="logo.png" sizes="150x150" />

    <meta property="og:image" content="/Asset/img/Banner.png" />
    <meta property="og:title" content="Qu·∫£n l√Ω ƒë∆°n h" />
    <meta property="og:description" content="Thi·∫øt k·∫ø v√† l·∫≠p tr√¨nh ƒêinh M·∫°nh H√πng" />

    <style>
        /* CSS Custom Properties for Theming */
        :root,
        html[data-theme='pink'] {
            --bg-primary: #fff1f2;
            /* rose-50 */
            --bg-secondary: #ffffff;
            /* white */
            --bg-secondary-hover: #fdf2f8;
            /* pink-50 */
            --text-primary: #334155;
            /* slate-700 */
            --text-secondary: #64748b;
            /* slate-500 */
            --text-accent: #c026d3;
            /* fuchsia-600 */
            --border-color: #f1f5f9;
            /* slate-100 */
            --border-color-heavy: #e2e8f0;
            /* slate-200 */
            --accent-primary: #ec4899;
            /* pink-500 */
            --accent-primary-hover: #db2777;
            /* pink-600 */
            --accent-secondary: #fce7f3;
            /* pink-100 */
            --accent-secondary-text: #9d174d;
            /* pink-800 */
            --shadow-color: rgba(236, 72, 153, 0.1);
        }

        html[data-theme='blue'] {
            --bg-primary: #f0f9ff;
            /* sky-50 */
            --bg-secondary: #ffffff;
            --bg-secondary-hover: #f0f9ff;
            --text-primary: #334155;
            --text-secondary: #64748b;
            --text-accent: #2563eb;
            /* blue-600 */
            --border-color: #f1f5f9;
            --border-color-heavy: #e2e8f0;
            --accent-primary: #3b82f6;
            /* blue-500 */
            --accent-primary-hover: #2563eb;
            /* blue-600 */
            --accent-secondary: #dbeafe;
            /* blue-100 */
            --accent-secondary-text: #1e40af;
            /* blue-800 */
            --shadow-color: rgba(59, 130, 246, 0.1);
        }

        html[data-theme='dark'] {
            --bg-primary: #000000;
            /* black */
            --bg-secondary: #0d0d0d;
            /* very dark grey */
            --bg-secondary-hover: #1a1a1a;
            /* dark grey */
            --text-primary: #ffffff;
            /* white */
            --text-secondary: #a0a0a0;
            /* light grey */
            --text-accent: #ffffff;
            /* white */
            --border-color: #2a2a2a;
            /* grey border */
            --border-color-heavy: #404040;
            /* heavier grey border */
            --accent-primary: #333333;
            /* grey for buttons */
            --accent-primary-hover: #4d4d4d;
            /* lighter grey for hover */
            --accent-secondary: #222222;
            /* dark grey for badges */
            --accent-secondary-text: #ffffff;
            /* white text on badges */
            --shadow-color: rgba(255, 255, 255, 0.05);
            /* subtle white shadow */
        }

        body {
            font-family: 'Nunito', sans-serif;
            background-color: var(--bg-primary);
            color: var(--text-primary);
            transition: background-color 0.3s, color 0.3s;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }

        .hidden {
            display: none;
        }

        .toast {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 0.75rem 1.25rem;
            border-radius: 0.75rem;
            color: white;
            z-index: 1000;
            opacity: 0;
            transform: translateY(-20px);
            transition: all 0.3s ease-in-out;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
            font-weight: 600;
        }

        .toast.show {
            opacity: 1;
            transform: translateY(0);
        }

        .toast.success {
            background-color: #2dd4bf;
        }

        .toast.error {
            background-color: #f43f5e;
        }

        .toast.info {
            background-color: #fb923c;
        }

        .switch {
            position: relative;
            display: inline-block;
            width: 50px;
            height: 28px;
        }

        .switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #9ca3af;
            transition: .4s;
            border-radius: 28px;
        }

        .slider:before {
            position: absolute;
            content: "";
            height: 20px;
            width: 20px;
            left: 4px;
            bottom: 4px;
            background-color: white;
            transition: .4s;
            border-radius: 50%;
        }

        input:checked+.slider {
            background-color: var(--accent-primary);
        }

        input:checked+.slider:before {
            transform: translateX(22px);
        }

        .modal-backdrop {
            backdrop-filter: blur(5px);
        }

        .shadow-cute {
            box-shadow: 0 4px 10px -2px var(--shadow-color), 0 2px 6px -2px var(--shadow-color);
        }

        .shadow-cute-lg {
            box-shadow: 0 10px 25px -5px var(--shadow-color), 0 8px 10px -6px var(--shadow-color);
        }

        .selection-cell {
            display: none;
        }

        .selection-mode-active .selection-cell {
            display: table-cell;
        }

        .selection-mode-active .selection-row {
            cursor: pointer;
        }

        .selection-mode-active .selection-row:hover {
            background-color: var(--bg-secondary-hover);
        }

        .tab-btn {
            padding: 0.5rem 1rem;
            font-weight: 600;
            border-radius: 0.75rem;
            color: var(--accent-secondary-text);
            background-color: var(--accent-secondary);
            transition: all 0.2s;
        }

        .tab-btn.active {
            color: white;
            background-color: var(--accent-primary);
            box-shadow: 0 2px 5px var(--shadow-color);
        }
    </style>
</head>

<body>

    <div id="app-container" class="container mx-auto p-4 md:p-6">

        <div id="loading-spinner" class="fixed inset-0 bg-white bg-opacity-70 flex items-center justify-center z-[100]">
            <div class="animate-spin rounded-full h-16 w-16 border-t-4 border-b-4 border-[var(--accent-primary)]"></div>
        </div>

        <div id="auth-view">
            <div class="max-w-md mx-auto bg-[var(--bg-secondary)] rounded-3xl shadow-cute-lg mt-10 p-8 text-center">
                <h1 class="text-3xl font-bold text-[var(--text-primary)]">Qu·∫£n L√Ω ƒê∆°n H√†ng Nh√≥m üå∏</h1>
                <p class="text-[var(--text-secondary)] mt-3">ƒêƒÉng nh·∫≠p ƒë·ªÉ t·∫°o nh√≥m ho·∫∑c nh·∫≠p m√£ ƒë·ªÉ xem ƒë∆°n h√†ng nh√©!</p>
                <div class="mt-8">
                    <input type="text" id="group-code-input"
                        class="w-full p-3 border border-[var(--border-color-heavy)] rounded-xl bg-[var(--bg-primary)] focus:outline-none focus:ring-2 focus:ring-[var(--accent-primary)] transition"
                        placeholder="Nh·∫≠p m√£ nh√≥m z√¥ ƒë√¢y n√®">
                    <button id="view-with-code-btn"
                        class="w-full mt-4 bg-slate-800 hover:bg-black text-white font-bold py-3 px-4 rounded-xl transition duration-300 shadow-cute transform hover:scale-105">
                        <i class="fas fa-binoculars mr-2"></i>Xem V·ªõi M√£ Nh√≥m
                    </button>
                </div>
                <div class="my-6 flex items-center justify-center"><span
                        class="border-b w-1/5 lg:w-1/4 border-[var(--border-color)]"></span><span
                        class="text-xs text-center text-slate-400 uppercase mx-4 font-semibold">Ho·∫∑c</span><span
                        class="border-b w-1/5 lg:w-1/4 border-[var(--border-color)]"></span></div>
                <button id="open-login-modal-btn"
                    class="w-full bg-[var(--accent-primary)] hover:bg-[var(--accent-primary-hover)] text-white font-bold py-3 px-4 rounded-xl transition duration-300 shadow-cute transform hover:scale-105">
                    <span class="mr-2">üëã</span>ƒêƒÉng Nh·∫≠p / ƒêƒÉng K√Ω
                </button>
            </div>
        </div>

        <div id="create-group-view" class="hidden">
            <div class="max-w-md mx-auto bg-[var(--bg-secondary)] rounded-3xl shadow-cute-lg mt-10 p-8 text-center">
                <h1 class="text-3xl font-bold text-[var(--text-primary)]">T·∫°o m·ªôt nh√≥m m·ªõi üöÄ</h1>
                <p class="text-[var(--text-secondary)] mt-2">H√£y ƒë·∫∑t m·ªôt c√°i t√™n th·∫≠t k√™u cho nh√≥m c·ªßa b·∫°n nh√©!</p>
                <div class="mt-8">
                    <input type="text" id="group-name-input"
                        class="w-full p-3 border border-[var(--border-color-heavy)] rounded-xl bg-[var(--bg-primary)] focus:outline-none focus:ring-2 focus:ring-[var(--accent-primary)] transition"
                        placeholder="V√≠ d·ª•: Team Ch·ªët ƒê∆°n">
                    <button id="create-group-btn"
                        class="w-full mt-4 bg-[var(--accent-primary)] hover:bg-[var(--accent-primary-hover)] text-white font-bold py-3 px-4 rounded-xl transition duration-300 shadow-cute transform hover:scale-105">
                        <i class="fas fa-users mr-2"></i>T·∫°o Nh√≥m
                    </button>
                </div>
            </div>
        </div>

        <div id="select-group-view" class="hidden">
            <div class="max-w-2xl mx-auto bg-[var(--bg-secondary)] rounded-3xl shadow-cute-lg mt-10 p-8">
                <div class="flex flex-col sm:flex-row justify-between items-center mb-6 gap-4">
                    <h1 class="text-3xl font-bold text-[var(--text-primary)]">Ch·ªçn Nh√≥m C·ªßa B·∫°n</h1>
                    <div class="flex items-center gap-3">
                        <button id="create-new-group-from-list-btn"
                            class="bg-[var(--accent-primary)] hover:bg-[var(--accent-primary-hover)] text-white font-bold py-2 px-4 rounded-xl transition duration-300 shadow-cute transform hover:scale-105">
                            <i class="fas fa-plus mr-2"></i>T·∫°o M·ªõi
                        </button>
                        <button id="user-logout-btn"
                            class="bg-slate-700 hover:bg-black text-white font-bold py-2 px-4 rounded-xl transition duration-300 shadow-cute transform hover:scale-105">
                            <i class="fas fa-sign-out-alt mr-2"></i>Bye Bye
                        </button>
                    </div>
                </div>
                <div id="group-list-container" class="space-y-4"></div>
            </div>
        </div>

        <div id="main-app-view" class="hidden">
            <div class="bg-[var(--bg-secondary)] p-4 md:p-5 rounded-3xl shadow-cute ">
                <div class="flex flex-col md:flex-row justify-between items-start md:items-center gap-4">
                    <div class="flex-grow">
                        <div class="flex items-center gap-3">
                            <button id="back-to-groups-btn"
                                class="hidden text-slate-400 hover:text-[var(--accent-primary)] transition"
                                title="Quay l·∫°i danh s√°ch nh√≥m"><i class="fas fa-arrow-left fa-lg"></i></button>
                            <h1 id="display-group-name"
                                class="text-2xl md:text-3xl font-extrabold text-[var(--text-primary)] truncate"></h1>
                        </div>
                        <div class="flex items-center mt-2 pl-1 md:pl-0">
                            <span class="text-sm font-semibold mr-2 text-[var(--text-secondary)]">M√£ m·ªùi:</span>
                            <span id="display-group-code"
                                class="bg-[var(--accent-secondary)] text-[var(--accent-secondary-text)] px-3 py-1 rounded-full font-mono font-bold text-sm"></span>
                            <button id="copy-group-code-btn"
                                class="ml-2 text-[var(--accent-primary)] hover:opacity-70 transition"><i
                                    class="fas fa-copy"></i></button>
                        </div>
                        <p class="text-xs text-slate-400 mt-2 pl-1 md:pl-0"><span id="display-user-email"></span></p>
                    </div>

                    <div class="flex items-center gap-2 self-start md:self-center">
                        <button id="theme-switcher-btn" title="ƒê·ªïi giao di·ªán"
                            class="h-10 w-10 bg-slate-200 hover:bg-slate-300 text-slate-600 font-bold rounded-xl flex items-center justify-center transition">
                            <i class="fas fa-palette"></i>
                        </button>
                        <button id="logout-btn"
                            class="bg-slate-700 hover:bg-black text-white font-bold py-2 px-4 rounded-xl transition duration-300 text-sm shadow-cute transform hover:scale-105">
                        </button>
                        <div id="header-settings-container" class="relative">
                            <button id="header-settings-btn"
                                class="hidden h-10 w-10 bg-slate-200 hover:bg-slate-300 text-slate-600 font-bold rounded-xl flex items-center justify-center transition">
                                <i class="fas fa-cog"></i>
                            </button>
                            <div id="header-settings-menu"
                                class="hidden absolute right-0 mt-2 w-56 bg-[var(--bg-secondary)] rounded-xl shadow-lg z-20 ring-1 ring-[var(--border-color)]">
                                <div class="py-2">
                                    <a href="#" id="edit-group-name-btn"
                                        class="flex items-center px-4 py-2 text-sm text-[var(--text-primary)] hover:bg-[var(--bg-secondary-hover)] hover:text-[var(--text-accent)] transition">
                                        <i class="fas fa-pencil-alt w-6 mr-2"></i><span>S·ª≠a t√™n nh√≥m</span>
                                    </a>
                                    <a href="#" id="change-group-code-btn"
                                        class="flex items-center px-4 py-2 text-sm text-[var(--text-primary)] hover:bg-[var(--bg-secondary-hover)] hover:text-[var(--text-accent)] transition">
                                        <i class="fas fa-key w-6 mr-2"></i><span>ƒê·ªïi m√£ nh√≥m</span>
                                    </a>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="my-2 container mx-auto text-center text-gray-400">
                <p><span class="text-sm font-light">With love for</span> <span class="text-rose-500 font-bold">Thy
                        ‚ù§Ô∏è</span></p>
            </div>

            <div id="order-form-container" class="bg-[var(--bg-secondary)] p-6 rounded-3xl shadow-cute mb-6">
                <h2 class="text-xl font-bold mb-4 text-[var(--text-primary)]">Th√™m ƒê∆°n H√†ng M·ªõi üì¶</h2>
                <form id="add-order-form">
                    <input type="text" id="owner-name-input" placeholder="T√™n ng∆∞·ªùi nh·∫≠n h√†ng"
                        class="w-full p-3 border border-[var(--border-color-heavy)] rounded-xl bg-[var(--bg-primary)] focus:outline-none focus:ring-2 focus:ring-[var(--accent-primary)] transition"
                        required>
                    <div class="mt-4">
                        <label for="order-code-input"
                            class="block text-sm font-medium text-[var(--text-secondary)] mb-1">M√£ ƒë∆°n h√†ng (m·ªói m√£ m·ªôt
                            d√≤ng)</label>
                        <div class="relative">
                            <textarea id="order-code-input" rows="4" placeholder="D√°n c√°c m√£ ƒë∆°n h√†ng v√†o ƒë√¢y..."
                                class="w-full p-3 border border-[var(--border-color-heavy)] rounded-xl bg-[var(--bg-primary)] focus:outline-none focus:ring-2 focus:ring-[var(--accent-primary)] transition pr-24"></textarea>
                            <button type="button" id="paste-button"
                                class="absolute top-3 right-3 bg-[var(--accent-secondary)] text-[var(--accent-secondary-text)] px-3 py-1 rounded-lg text-sm font-semibold hover:opacity-80 transition">
                                <i class="fas fa-paste"></i> D√°n
                            </button>
                        </div>
                    </div>
                    <div class="flex items-center justify-between mt-4">
                        <button type="submit"
                            class="bg-[var(--accent-primary)] hover:bg-[var(--accent-primary-hover)] text-white font-bold py-2 px-5 rounded-xl transition duration-300 shadow-cute transform hover:scale-105">
                            <i class="fas fa-plus-circle mr-2"></i>Th√™m ƒê∆°n
                        </button>
                        <div class="flex items-center space-x-2">
                            <label for="auto-paste-toggle" class="text-sm font-medium text-[var(--text-secondary)]">T·ª±
                                ƒë·ªông d√°n</label>
                            <label class="switch">
                                <input type="checkbox" id="auto-paste-toggle">
                                <span class="slider"></span>
                            </label>
                        </div>
                    </div>
                </form>
            </div>

            <div class="bg-[var(--bg-secondary)] p-4 sm:p-6 rounded-3xl shadow-cute">
                <div class="flex flex-col md:flex-row justify-between items-center mb-4 gap-4">
                    <h2 class="text-xl font-bold text-[var(--text-primary)]">Danh S√°ch ƒê∆°n H√†ng</h2>
                    <div class="flex items-center gap-2 w-full md:w-auto">
                        <div class="relative flex-grow">
                            <span class="absolute inset-y-0 left-0 flex items-center pl-4 text-slate-400"><i
                                    class="fas fa-search"></i></span>
                            <input type="text" id="search-input" placeholder="T√¨m ki·∫øm..."
                                class="w-full pl-12 pr-4 py-2.5 border border-[var(--border-color-heavy)] rounded-xl bg-[var(--bg-primary)] focus:outline-none focus:ring-2 focus:ring-[var(--accent-primary)] transition">
                        </div>
                        <button id="open-scanner-btn" title="Ki·ªÉm h√†ng"
                            class="flex-shrink-0 bg-green-400 hover:bg-green-500 text-white font-bold h-11 w-11 flex items-center justify-center rounded-xl transition duration-300 transform hover:scale-110">
                            <i class="fa-solid fa-check-to-slot"></i> </button>
                        <button id="toggle-selection-mode-btn" title="Ch·∫ø ƒë·ªô ch·ªçn h√†ng lo·∫°t"
                            class="flex-shrink-0 bg-pink-400 hover:bg-pink-500 text-white font-bold h-11 w-11 flex items-center justify-center rounded-xl transition duration-300 transform hover:scale-110">
                            <i class="fas fa-check-double fa-lg"></i>
                        </button>
                        <div class="relative" id="more-actions-container">
                            <button id="more-actions-btn" title="Th√™m h√†nh ƒë·ªông"
                                class="flex-shrink-0 bg-slate-600 hover:bg-slate-700 text-white font-bold h-11 w-11 flex items-center justify-center rounded-xl transition duration-300 transform hover:scale-110">
                                <i class="fas fa-ellipsis-v"></i>
                            </button>
                            <div id="dropdown-menu"
                                class="hidden absolute right-0 mt-2 w-56 bg-[var(--bg-secondary)] rounded-xl shadow-lg z-20 ring-1 ring-[var(--border-color)]">
                                <div class="py-2" role="menu">
                                    <a href="#" id="dropdown-toggle-view"
                                        class="flex items-center px-4 py-2 text-sm text-[var(--text-primary)] hover:bg-[var(--bg-secondary-hover)] hover:text-[var(--text-accent)] transition"
                                        role="menuitem">
                                        <i class="fas fa-table w-6 mr-2"></i> <span id="toggle-view-text">T√°ch
                                            B·∫£ng</span>
                                    </a>
                                    <a href="#" id="dropdown-copy"
                                        class="flex items-center px-4 py-2 text-sm text-[var(--text-primary)] hover:bg-[var(--bg-secondary-hover)] hover:text-[var(--text-accent)] transition"
                                        role="menuitem">
                                        <i class="fas fa-copy w-6 mr-2"></i> <span>Sao ch√©p d·ªØ li·ªáu</span>
                                    </a>
                                    <a href="#" id="dropdown-import"
                                        class="flex items-center px-4 py-2 text-sm text-[var(--text-primary)] hover:bg-[var(--bg-secondary-hover)] hover:text-[var(--text-accent)] transition"
                                        role="menuitem">
                                        <i class="fas fa-upload w-6 mr-2"></i> <span>Nh·∫≠p D·ªØ Li·ªáu</span>
                                    </a>
                                    <a href="#" id="dropdown-export"
                                        class="flex items-center px-4 py-2 text-sm text-[var(--text-primary)] hover:bg-[var(--bg-secondary-hover)] hover:text-[var(--text-accent)] transition"
                                        role="menuitem">
                                        <i class="fas fa-download w-6 mr-2"></i> <span>Xu·∫•t D·ªØ Li·ªáu</span>
                                    </a>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div id="bulk-action-bar"
                    class="hidden bg-[var(--accent-secondary)] border border-[var(--accent-primary)] p-3 rounded-xl mb-4 flex flex-col sm:flex-row items-center justify-between gap-3">
                    <span class="font-semibold text-[var(--accent-secondary-text)]"><span id="selection-count">0</span>
                        m·ª•c ƒë√£ ƒë∆∞·ª£c ch·ªçn</span>
                    <div class="flex items-center gap-2">
                        <button id="bulk-edit-btn"
                            class="bg-amber-400 hover:bg-amber-500 text-white font-bold py-2 px-3 rounded-lg text-sm transition disabled:bg-slate-300 disabled:cursor-not-allowed">
                            <i class="fas fa-user-edit"></i> S·ª≠a
                        </button>
                        <button id="bulk-delete-btn"
                            class="bg-rose-500 hover:bg-rose-600 text-white font-bold py-2 px-3 rounded-lg text-sm transition">
                            <i class="fas fa-trash"></i> X√≥a
                        </button>
                    </div>
                </div>

                <div id="orders-container" class="space-y-6"></div>
            </div>
        </div>
    </div>

    <input type="file" id="import-file-input" class="hidden" accept=".json">

    <div id="login-modal"
        class="hidden fixed inset-0 bg-gray-900 bg-opacity-50 flex items-center justify-center z-[90] p-4 modal-backdrop">
        <div class="bg-[var(--bg-secondary)] rounded-3xl shadow-xl w-full max-w-sm">
            <div class="p-5 border-b border-[var(--border-color)] flex justify-between items-center">
                <h2 id="login-modal-title" class="text-xl font-bold text-[var(--text-primary)]">ƒêƒÉng Nh·∫≠p</h2>
                <button id="close-login-modal-btn"
                    class="text-slate-400 hover:text-[var(--text-primary)] text-3xl leading-none transition">&times;</button>
            </div>
            <div class="p-6">
                <form id="login-form">
                    <input type="email" id="login-email" placeholder="Email"
                        class="w-full p-3 mb-4 border border-[var(--border-color-heavy)] rounded-xl bg-[var(--bg-primary)] focus:outline-none focus:ring-2 focus:ring-[var(--accent-primary)] transition"
                        required>
                    <input type="password" id="login-password" placeholder="M·∫≠t kh·∫©u"
                        class="w-full p-3 mb-4 border border-[var(--border-color-heavy)] rounded-xl bg-[var(--bg-primary)] focus:outline-none focus:ring-2 focus:ring-[var(--accent-primary)] transition"
                        required>
                    <button type="submit"
                        class="w-full bg-[var(--accent-primary)] text-white py-3 rounded-xl hover:bg-[var(--accent-primary-hover)] font-bold transition">ƒêƒÉng
                        Nh·∫≠p</button>
                    <p class="text-center text-sm mt-3"><a href="#" id="forgot-password-link"
                            class="font-semibold text-[var(--text-accent)] hover:underline">Qu√™n m·∫≠t kh·∫©u?</a></p>
                </form>
                <form id="register-form" class="hidden">
                    <input type="email" id="register-email" placeholder="Email"
                        class="w-full p-3 mb-4 border border-[var(--border-color-heavy)] rounded-xl bg-[var(--bg-primary)] focus:outline-none focus:ring-2 focus:ring-[var(--accent-primary)] transition"
                        required>
                    <input type="password" id="register-password" placeholder="M·∫≠t kh·∫©u (√≠t nh·∫•t 6 k√Ω t·ª±)"
                        class="w-full p-3 mb-4 border border-[var(--border-color-heavy)] rounded-xl bg-[var(--bg-primary)] focus:outline-none focus:ring-2 focus:ring-[var(--accent-primary)] transition"
                        required>
                    <button type="submit"
                        class="w-full bg-[var(--accent-primary)] text-white py-3 rounded-xl hover:bg-[var(--accent-primary-hover)] font-bold transition">ƒêƒÉng
                        K√Ω</button>
                </form>
                <p class="text-center text-sm mt-4 text-[var(--text-secondary)]">
                    <span id="login-text">Ch∆∞a c√≥ t√†i kho·∫£n? <a href="#" id="show-register-form"
                            class="font-semibold text-[var(--text-accent)] hover:underline">ƒêƒÉng k√Ω ngay</a></span>
                    <span id="register-text" class="hidden">ƒê√£ c√≥ t√†i kho·∫£n? <a href="#" id="show-login-form"
                            class="font-semibold text-[var(--text-accent)] hover:underline">ƒêƒÉng nh·∫≠p</a></span>
                </p>
            </div>
        </div>
    </div>

    <div id="confirm-modal"
        class="hidden fixed inset-0 bg-gray-900 bg-opacity-50 flex items-center justify-center z-[95] p-4 modal-backdrop">
        <div class="bg-[var(--bg-secondary)] rounded-3xl shadow-xl w-full max-w-sm p-6 text-center">
            <h3 id="confirm-title" class="text-lg font-bold mb-3 text-[var(--text-primary)]">X√°c nh·∫≠n h√†nh ƒë·ªông</h3>
            <p id="confirm-message" class="mb-6 text-[var(--text-secondary)]">B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën th·ª±c hi·ªán h√†nh ƒë·ªông
                n√†y?</p>
            <div class="flex justify-center space-x-4">
                <button id="confirm-cancel-btn"
                    class="px-6 py-2 bg-slate-200 text-slate-700 font-semibold rounded-xl hover:bg-slate-300 transition">H·ªßy</button>
                <button id="confirm-ok-btn"
                    class="px-6 py-2 bg-rose-500 text-white font-semibold rounded-xl hover:bg-rose-600 transition">X√°c
                    nh·∫≠n</button>
            </div>
        </div>
    </div>

    <div id="scanner-modal"
        class="hidden fixed inset-0 bg-gray-900 bg-opacity-50 flex items-center justify-center z-[90] p-4 modal-backdrop">
        <div class="bg-[var(--bg-secondary)] rounded-3xl shadow-xl w-full max-w-2xl max-h-[90vh] flex flex-col">
            <div class="p-4 border-b border-[var(--border-color)] flex justify-between items-center">
                <h2 class="text-xl font-bold text-[var(--text-primary)]">Ki·ªÉm Tra ƒê∆°n H√†ng üßê</h2>
                <button id="close-scanner-btn"
                    class="text-slate-400 hover:text-[var(--text-primary)] text-3xl leading-none transition">&times;</button>
            </div>
            <div class="p-6 flex-grow overflow-y-auto">
                <div class="mb-4">
                    <label for="scanner-owner-select"
                        class="block text-sm font-bold text-[var(--text-primary)] mb-1">B∆∞·ªõc 1: Ch·ªçn ng∆∞·ªùi nh·∫≠n
                        h√†ng</label>
                    <select id="scanner-owner-select"
                        class="w-full mt-1 p-3 border border-[var(--border-color-heavy)] rounded-xl bg-[var(--bg-primary)] focus:outline-none focus:ring-2 focus:ring-[var(--accent-primary)] transition">
                        <option value="">-- Vui l√≤ng ch·ªçn --</option>
                    </select>
                </div>
                <div id="scanner-method-container" class="hidden">
                    <div class="flex justify-center items-center gap-2 p-1 bg-[var(--bg-primary)] rounded-xl mb-4">
                        <button id="show-manual-check-tab" class="tab-btn w-1/2"><i class="fas fa-keyboard mr-2"></i>Th·ªß
                            C√¥ng</button>
                        <button id="show-qr-scanner-tab" class="tab-btn w-1/2"><i class="fas fa-qrcode mr-2"></i>Qu√©t
                            QR</button>
                    </div>
                    <div id="qr-scanner-view" class="hidden">
                        <div id="camera-selection-container" class="hidden mt-4 mb-2">
                            <label for="camera-select"
                                class="block text-sm font-bold text-[var(--text-primary)] mb-1">Ch·ªçn camera</label>
                            <select id="camera-select"
                                class="w-full p-3 border border-[var(--border-color-heavy)] rounded-xl bg-[var(--bg-primary)] focus:outline-none focus:ring-2 focus:ring-[var(--accent-primary)] transition"></select>
                        </div>
                        <label class="block text-sm font-bold text-[var(--text-primary)] mb-1">B∆∞·ªõc 2: Qu√©t m√£
                            QR</label>
                        <select id="focusModeSelect" class="qr-focus-mode">
                            <option value="full">Qu√©t to√†n m√†n h√¨nh</option>
                            <option value="center">Ch·ªâ qu√©t trung t√¢m</option>
                            <option value="tap">Ch·∫°m ƒë·ªÉ l·∫•y n√©t</option>
                            <option value="auto-refocus">T·ª± ƒë·ªông refocus m·∫°nh</option>
                        </select>

                        <div id="qr-reader"
                            class="w-full md:w-96 mx-auto border-2 border-dashed border-slate-300 rounded-2xl overflow-hidden bg-[var(--bg-primary)]">
                        </div>
                    </div>
                    <div id="manual-check-view">
                        <label for="manual-order-code-input"
                            class="block text-sm font-bold text-[var(--text-primary)] mb-1">B∆∞·ªõc 2: Nh·∫≠p m√£ ƒë∆°n ho·∫∑c t√™n
                            ng∆∞·ªùi nh·∫≠n</label>
                        <div class="relative">
                            <input type="text" id="manual-order-code-input" placeholder="Nh·∫≠p ƒë·ªÉ t√¨m ki·∫øm..."
                                class="w-full p-3 border border-[var(--border-color-heavy)] rounded-xl bg-[var(--bg-primary)] focus:outline-none focus:ring-2 focus:ring-[var(--accent-primary)] transition">
                            <div id="manual-suggestions-list"
                                class="hidden absolute w-full bg-[var(--bg-secondary)] border border-[var(--border-color-heavy)] rounded-xl shadow-lg mt-1 z-10 max-h-48 overflow-y-auto">
                            </div>
                        </div>
                    </div>
                </div>
                <div id="scan-result" class="mt-4 text-center font-semibold h-6"></div>
                <div class="mt-6">
                    <div class="flex justify-between items-center mb-2">
                        <h3 class="font-semibold text-[var(--text-primary)]">Danh s√°ch ƒë√£ ki·ªÉm k√™</h3>
                        <div id="tally-actions" class="hidden space-x-3">
                            <button id="download-tally-img-btn" title="T·∫£i ·∫£nh"
                                class="text-slate-500 hover:text-[var(--accent-primary)] transition"><i
                                    class="fas fa-camera"></i></button>
                            <button id="copy-tally-text-btn" title="Sao ch√©p"
                                class="text-slate-500 hover:text-[var(--accent-primary)] transition"><i
                                    class="fas fa-copy"></i></button>
                            <button id="export-tally-excel-btn" title="Xu·∫•t Excel"
                                class="text-slate-500 hover:text-[var(--accent-primary)] transition"><i
                                    class="fas fa-file-excel"></i></button>
                            <button id="clear-tally-btn" title="X√≥a d·ªØ li·ªáu"
                                class="text-rose-500 hover:text-rose-700 transition"><i
                                    class="fas fa-trash"></i></button>
                        </div>
                    </div>
                    <div id="tally-list-container"
                        class="mt-2 border border-[var(--border-color-heavy)] rounded-xl bg-[var(--bg-secondary)]">
                        <div
                            class="hidden md:grid grid-cols-12 gap-4 px-4 py-2 bg-[var(--bg-primary)] rounded-t-xl text-xs font-semibold text-slate-500 uppercase tracking-wider">
                            <div class="col-span-3">M√£ ƒê∆°n</div>
                            <div class="col-span-2">C√¢n n·∫∑ng</div>
                            <div class="col-span-4">Ghi ch√∫</div>
                            <div class="col-span-3 text-right">Th·ªùi Gian</div>
                        </div>
                        <div id="tally-list-body"></div>
                        <div id="tally-list-footer"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div id="manual-check-confirm-modal"
        class="hidden fixed inset-0 bg-gray-900 bg-opacity-70 flex items-center justify-center z-[98] p-4 modal-backdrop">
        <div class="bg-[var(--bg-secondary)] rounded-3xl shadow-xl w-full max-w-sm p-6">
            <h3 class="text-lg font-bold mb-2 text-[var(--text-primary)]">X√°c nh·∫≠n ki·ªÉm h√†ng</h3>
            <p class="mb-4 text-[var(--text-secondary)]">ƒê∆°n h√†ng: <span id="confirm-order-code"
                    class="font-mono font-bold"></span></p>
            <div class="space-y-4">
                <div>
                    <label for="confirm-weight-input" class="block text-sm font-medium text-[var(--text-secondary)]">C√¢n
                        n·∫∑ng (gram) - <span class="italic">Kh√¥ng b·∫Øt bu·ªôc</span></label>
                    <input type="number" id="confirm-weight-input" step="1" placeholder="V√≠ d·ª•: 1250"
                        class="mt-1 w-full p-2 border border-[var(--border-color-heavy)] rounded-xl bg-[var(--bg-primary)] focus:outline-none focus:ring-2 focus:ring-[var(--accent-primary)] transition">
                </div>
                <div>
                    <label for="confirm-note-input" class="block text-sm font-medium text-[var(--text-secondary)]">Ghi
                        ch√∫ - <span class="italic">Kh√¥ng b·∫Øt bu·ªôc</span></label>
                    <textarea id="confirm-note-input" rows="2" placeholder="V√≠ d·ª•: H√†ng d·ªÖ v·ª°"
                        class="mt-1 w-full p-2 border border-[var(--border-color-heavy)] rounded-xl bg-[var(--bg-primary)] focus:outline-none focus:ring-2 focus:ring-[var(--accent-primary)] transition"></textarea>
                </div>
            </div>
            <div class="flex justify-end space-x-3 mt-6">
                <button id="manual-confirm-cancel-btn"
                    class="px-5 py-2 bg-slate-200 text-slate-700 font-semibold rounded-xl hover:bg-slate-300 transition">H·ªßy</button>
                <button id="manual-confirm-ok-btn"
                    class="px-5 py-2 bg-[var(--accent-primary)] text-white font-semibold rounded-xl hover:bg-[var(--accent-primary-hover)] transition">X√°c
                    nh·∫≠n</button>
            </div>
        </div>
    </div>

    <div id="copy-modal"
        class="hidden fixed inset-0 bg-gray-900 bg-opacity-50 flex items-center justify-center z-[95] p-4 modal-backdrop">
        <div class="bg-[var(--bg-secondary)] rounded-3xl shadow-xl w-full max-w-sm p-6 text-center">
            <h3 class="text-lg font-bold mb-4 text-[var(--text-primary)]">Sao ch√©p d·ªØ li·ªáu ƒë∆°n h√†ng</h3>
            <p class="mb-6 text-[var(--text-secondary)]">Ch·ªçn th√¥ng tin b·∫°n mu·ªën sao ch√©p v√†o clipboard.</p>
            <div class="space-y-3">
                <button data-copy-type="all"
                    class="copy-option-btn w-full bg-slate-200 text-slate-700 font-semibold py-3 rounded-xl hover:bg-slate-300 transition">Sao
                    ch√©p t·∫•t c·∫£</button>
                <button data-copy-type="stt"
                    class="copy-option-btn w-full bg-slate-200 text-slate-700 font-semibold py-3 rounded-xl hover:bg-slate-300 transition">Ch·ªâ
                    sao ch√©p STT</button>
                <button data-copy-type="code"
                    class="copy-option-btn w-full bg-slate-200 text-slate-700 font-semibold py-3 rounded-xl hover:bg-slate-300 transition">Ch·ªâ
                    sao ch√©p M√£ ƒë∆°n</button>
                <button data-copy-type="owner"
                    class="copy-option-btn w-full bg-slate-200 text-slate-700 font-semibold py-3 rounded-xl hover:bg-slate-300 transition">Ch·ªâ
                    sao ch√©p Ng∆∞·ªùi s·ªü h·ªØu</button>
            </div>
            <button id="copy-modal-cancel-btn" class="mt-6 text-sm text-slate-500 hover:text-slate-700">H·ªßy</button>
        </div>
    </div>

    <div id="toast-notification" class="toast"></div>

    <script type="module">
        // Firebase SDK Imports
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, onAuthStateChanged, signOut, createUserWithEmailAndPassword, signInWithEmailAndPassword, sendPasswordResetEmail } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, setDoc, collection, onSnapshot, query, where, getDocs, deleteDoc, updateDoc, serverTimestamp, writeBatch } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Firebase Config & Init
        const firebaseConfig = {
            apiKey: "AIzaSyArx-5hcMsrq9DHTcy5HvN_aVehrVDv3HM",
            authDomain: "order-manager-d4042.firebaseapp.com",
            projectId: "order-manager-d4042",
            storageBucket: "order-manager-d4042.appspot.com",
            messagingSenderId: "62807324372",
            appId: "1:62807324372:web:b658e72655d03b8b03ed41",
            measurementId: "G-Q05TTEEG73"
        };
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const appId = firebaseConfig.appId;

        // Global State
        let currentUserId = null, currentGroupId = null, ordersListenerUnsubscribe = null;
        let isAutoPasteEnabled = false, isGuestMode = false, isGroupedView = false, isSelectionModeActive = false;
        let allOrders = [], selectedOrders = new Set(), availableCameras = [];
        let html5QrCode = null;
        const focusModeSelect = document.getElementById('focusModeSelect');
        const qrEl = document.getElementById('qr-reader'); let editingTallyOrderCode = null; // M·ªöI: Theo d√µi m√£ ƒë∆°n h√†ng ƒëang ƒë∆∞·ª£c s·ª≠a

        // UI Elements
        const loadingSpinner = document.getElementById('loading-spinner');
        const authView = document.getElementById('auth-view');
        const createGroupView = document.getElementById('create-group-view');
        const selectGroupView = document.getElementById('select-group-view');
        const mainAppView = document.getElementById('main-app-view');
        const searchInput = document.getElementById('search-input');
        const ordersContainer = document.getElementById('orders-container');
        const scannerModal = document.getElementById('scanner-modal');
        const scannerOwnerSelect = document.getElementById('scanner-owner-select');
        const scanResultEl = document.getElementById('scan-result');
        const tallyActions = document.getElementById('tally-actions');
        const loginModal = document.getElementById('login-modal');
        const confirmModal = document.getElementById('confirm-modal');
        const backToGroupsBtn = document.getElementById('back-to-groups-btn');
        const bulkActionBar = document.getElementById('bulk-action-bar');
        const selectionCountEl = document.getElementById('selection-count');
        const bulkDeleteBtn = document.getElementById('bulk-delete-btn');
        const bulkEditBtn = document.getElementById('bulk-edit-btn');
        const openScannerBtn = document.getElementById('open-scanner-btn');
        const toggleSelectionModeBtn = document.getElementById('toggle-selection-mode-btn');
        const importFileInput = document.getElementById('import-file-input');
        const copyModal = document.getElementById('copy-modal');

        // Main list actions
        const moreActionsBtn = document.getElementById('more-actions-btn');
        const dropdownMenu = document.getElementById('dropdown-menu');
        const dropdownToggleView = document.getElementById('dropdown-toggle-view');
        const dropdownCopy = document.getElementById('dropdown-copy');
        const dropdownImport = document.getElementById('dropdown-import');
        const dropdownExport = document.getElementById('dropdown-export');

        // Header Elements
        const headerSettingsBtn = document.getElementById('header-settings-btn');
        const headerSettingsMenu = document.getElementById('header-settings-menu');
        const editGroupNameBtn = document.getElementById('edit-group-name-btn');
        const changeGroupCodeBtn = document.getElementById('change-group-code-btn');
        const themeSwitcherBtn = document.getElementById('theme-switcher-btn');

        // Scanner Elements
        const scannerMethodContainer = document.getElementById('scanner-method-container');
        const showQrScannerTab = document.getElementById('show-qr-scanner-tab');
        const showManualCheckTab = document.getElementById('show-manual-check-tab');
        const qrScannerView = document.getElementById('qr-scanner-view');
        const manualCheckView = document.getElementById('manual-check-view');
        const manualOrderCodeInput = document.getElementById('manual-order-code-input');
        const manualSuggestionsList = document.getElementById('manual-suggestions-list');
        const cameraSelectionContainer = document.getElementById('camera-selection-container');
        const cameraSelect = document.getElementById('camera-select');

        // Manual Check Confirm Modal Elements
        const manualCheckConfirmModal = document.getElementById('manual-check-confirm-modal');
        const confirmOrderCodeEl = document.getElementById('confirm-order-code');
        const confirmWeightInput = document.getElementById('confirm-weight-input');
        const confirmNoteInput = document.getElementById('confirm-note-input');
        const manualConfirmOkBtn = document.getElementById('manual-confirm-ok-btn');
        const manualConfirmCancelBtn = document.getElementById('manual-confirm-cancel-btn');

        // Audio Context (Disabled)
        function playSuccessSound() { /* Sounds disabled */ }
        function playErrorSound() { /* Sounds disabled */ }

        // Helper Functions
        const showView = (viewId) => {
            [authView, createGroupView, mainAppView, selectGroupView].forEach(view => view.classList.add('hidden'));
            document.getElementById(viewId).classList.remove('hidden');
            loadingSpinner.style.display = 'none';
        };
        const showToast = (message, type = 'info') => {
            const toast = document.getElementById('toast-notification');
            toast.textContent = message;
            toast.className = `toast show ${type}`;
            setTimeout(() => { toast.className = 'toast'; }, 3000);
        };
        const generateRandomCode = (length = 8) => {
            const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789';
            let result = '';
            for (let i = 0; i < length; i++) result += chars.charAt(Math.floor(Math.random() * chars.length));
            return result;
        };
        const getPublicGroupCollectionPath = () => `/artifacts/${appId}/public/data/groups`;

        const showConfirmModal = (title, message, onConfirm) => {
            document.getElementById('confirm-title').textContent = title;
            document.getElementById('confirm-message').textContent = message;
            confirmModal.classList.remove('hidden');
            const confirmBtn = document.getElementById('confirm-ok-btn');
            const cancelBtn = document.getElementById('confirm-cancel-btn');
            const confirmHandler = () => { onConfirm(); hideConfirmModal(); };
            const cancelHandler = () => { showToast("H√†nh ƒë·ªông ƒë√£ ƒë∆∞·ª£c h·ªßy.", "info"); hideConfirmModal(); };
            const hideConfirmModal = () => {
                confirmModal.classList.add('hidden');
                confirmBtn.removeEventListener('click', confirmHandler);
                cancelBtn.removeEventListener('click', cancelHandler);
            };
            confirmBtn.addEventListener('click', confirmHandler);
            cancelBtn.addEventListener('click', cancelHandler);
        };

        // --- Theming ---
        const themes = ['pink', 'blue', 'dark'];
        const applyTheme = (themeName) => {
            document.documentElement.dataset.theme = themeName;
            localStorage.setItem('theme', themeName);
        };
        themeSwitcherBtn.addEventListener('click', () => {
            const currentTheme = document.documentElement.dataset.theme || 'pink';
            const currentIndex = themes.indexOf(currentTheme);
            const nextIndex = (currentIndex + 1) % themes.length;
            applyTheme(themes[nextIndex]);
        });
        const loadTheme = () => {
            const savedTheme = localStorage.getItem('theme');
            if (savedTheme && themes.includes(savedTheme)) {
                applyTheme(savedTheme);
            } else {
                applyTheme('pink');
            }
        };


        // Authentication
        const handleRegister = async (e) => {
            e.preventDefault();
            const email = document.getElementById('register-email').value, password = document.getElementById('register-password').value;
            loadingSpinner.style.display = 'flex';
            try {
                await createUserWithEmailAndPassword(auth, email, password);
                loginModal.classList.add('hidden');
            } catch (error) {
                if (error.code === 'auth/email-already-in-use') showToast('Email n√†y ƒë√£ ƒë∆∞·ª£c s·ª≠ d·ª•ng.', 'error');
                else if (error.code === 'auth/weak-password') showToast('M·∫≠t kh·∫©u qu√° y·∫øu.', 'error');
                else showToast('ƒêƒÉng k√Ω th·∫•t b·∫°i.', 'error');
            } finally {
                loadingSpinner.style.display = 'none';
            }
        };
        const handleLogin = async (e) => {
            e.preventDefault();
            const email = document.getElementById('login-email').value, password = document.getElementById('login-password').value;
            loadingSpinner.style.display = 'flex';
            try {
                await signInWithEmailAndPassword(auth, email, password);
                loginModal.classList.add('hidden');
                showToast('ƒêƒÉng nh·∫≠p th√†nh c√¥ng!', 'success');
            } catch (error) {
                showToast('Sai email ho·∫∑c m·∫≠t kh·∫©u.', 'error');
            } finally {
                loadingSpinner.style.display = 'none';
            }
        };
        const handleForgotPassword = async () => {
            const email = prompt("Vui l√≤ng nh·∫≠p email c·ªßa b·∫°n ƒë·ªÉ ƒë·∫∑t l·∫°i m·∫≠t kh·∫©u:");
            if (email) {
                loadingSpinner.style.display = 'flex';
                try {
                    await sendPasswordResetEmail(auth, email);
                    showToast("Email ƒë·∫∑t l·∫°i m·∫≠t kh·∫©u ƒë√£ ƒë∆∞·ª£c g·ª≠i!", "success");
                } catch (error) {
                    showToast("L·ªói: " + error.message, "error");
                } finally {
                    loadingSpinner.style.display = 'none';
                }
            }
        };
        const handleLogout = async () => {
            if (ordersListenerUnsubscribe) ordersListenerUnsubscribe();
            await signOut(auth);
            showToast("ƒê√£ ƒëƒÉng xu·∫•t th√†nh c√¥ng.", "success");
        };
        const handleGuestExit = () => {
            localStorage.removeItem('guest_group_id');
            if (ordersListenerUnsubscribe) ordersListenerUnsubscribe();
            currentGroupId = null; isGuestMode = false; allOrders = [];
            history.pushState("", document.title, window.location.pathname + window.location.search);
            window.location.hash = '';
            showView('auth-view');
            showToast("ƒê√£ tho√°t kh·ªèi nh√≥m.", "info");
        };

        // Group Management
        const renderGroupSelection = (groupDocs) => {
            const container = document.getElementById('group-list-container');
            container.innerHTML = groupDocs.length === 0 ? `<p class="text-center text-[var(--text-secondary)]">B·∫°n ch∆∞a c√≥ nh√≥m n√†o. T·∫°o m·ªôt nh√≥m m·ªõi nh√©!</p>` : '';
            groupDocs.forEach(doc => {
                const group = doc.data();
                const div = document.createElement('div');
                div.className = 'p-5 border border-[var(--border-color)] rounded-2xl flex flex-col sm:flex-row justify-between items-center gap-3 transition hover:shadow-cute hover:border-[var(--border-color-heavy)]';
                div.innerHTML = `
                    <div><p class="font-bold text-lg text-[var(--text-primary)]">${group.groupName}</p><p class="text-sm text-slate-400 font-mono">${doc.id}</p></div>
                    <div class="flex gap-2">
                        <button data-group-id="${doc.id}" class="select-group-btn bg-[var(--accent-primary)] text-white px-4 py-2 rounded-xl hover:bg-[var(--accent-primary-hover)] font-semibold transition">Ch·ªçn</button>
                        <button data-group-id="${doc.id}" data-group-name="${group.groupName}" class="delete-group-btn bg-slate-700 text-white px-4 py-2 rounded-xl hover:bg-black font-semibold transition">X√≥a</button>
                    </div>`;
                container.appendChild(div);
            });
            document.querySelectorAll('.select-group-btn').forEach(btn => btn.addEventListener('click', (e) => {
                currentGroupId = e.currentTarget.dataset.groupId; window.location.hash = currentGroupId; isGuestMode = false; loadGroupData(currentGroupId);
            }));
            document.querySelectorAll('.delete-group-btn').forEach(btn => btn.addEventListener('click', (e) => {
                const groupId = e.currentTarget.dataset.groupId, groupName = e.currentTarget.dataset.groupName;
                showConfirmModal(`X√≥a Nh√≥m "${groupName}"`, 'H√†nh ƒë·ªông n√†y kh√¥ng th·ªÉ ho√†n t√°c. T·∫•t c·∫£ ƒë∆°n h√†ng s·∫Ω b·ªã x√≥a.', () => handleDeleteGroup(groupId));
            }));
        };
        const checkUserGroup = async () => {
            loadingSpinner.style.display = 'flex';
            const q = query(collection(db, getPublicGroupCollectionPath()), where("ownerId", "==", currentUserId));
            try {
                const querySnapshot = await getDocs(q);
                if (querySnapshot.empty) showView('create-group-view'); else { renderGroupSelection(querySnapshot.docs); showView('select-group-view'); }
            } catch (error) { showToast("L·ªói khi ki·ªÉm tra th√¥ng tin nh√≥m.", "error"); showView('auth-view'); }
        };
        const handleCreateGroup = async () => {
            const groupName = document.getElementById('group-name-input').value.trim();
            if (!groupName) { showToast("Vui l√≤ng nh·∫≠p t√™n nh√≥m.", "error"); return; }
            loadingSpinner.style.display = 'flex';
            let newGroupId, groupExists = true;
            while (groupExists) { newGroupId = generateRandomCode(); const docSnap = await getDoc(doc(db, getPublicGroupCollectionPath(), newGroupId)); groupExists = docSnap.exists(); }
            try {
                await setDoc(doc(db, getPublicGroupCollectionPath(), newGroupId), { groupName: groupName, ownerId: currentUserId, createdAt: serverTimestamp() });
                currentGroupId = newGroupId; window.location.hash = currentGroupId; isGuestMode = false;
                await loadGroupData(currentGroupId);
                showToast("T·∫°o nh√≥m th√†nh c√¥ng!", "success");
            } catch (error) { showToast("T·∫°o nh√≥m th·∫•t b·∫°i.", "error"); loadingSpinner.style.display = 'none'; }
        };
        const handleDeleteGroup = async (groupId) => {
            loadingSpinner.style.display = 'flex';
            try {
                const ordersSnapshot = await getDocs(collection(db, getPublicGroupCollectionPath(), groupId, "orders"));
                const batch = writeBatch(db);
                ordersSnapshot.forEach(doc => batch.delete(doc.ref));
                await batch.commit();
                await deleteDoc(doc(db, getPublicGroupCollectionPath(), groupId));
                showToast("ƒê√£ x√≥a nh√≥m th√†nh c√¥ng.", "success");
                await checkUserGroup();
            } catch (error) { showToast("X√≥a nh√≥m th·∫•t b·∫°i.", "error"); loadingSpinner.style.display = 'none'; }
        };
        const handleViewGroupWithCode = async (groupCodeFromUrl) => {
            const groupCode = groupCodeFromUrl || document.getElementById('group-code-input').value.trim().toUpperCase();
            if (!groupCode) { showToast("Vui l√≤ng nh·∫≠p m√£ nh√≥m.", "error"); return; }
            loadingSpinner.style.display = 'flex';
            try {
                const groupDocRef = doc(db, getPublicGroupCollectionPath(), groupCode);
                const docSnap = await getDoc(groupDocRef);
                if (docSnap.exists()) {
                    if (!auth.currentUser) localStorage.setItem('guest_group_id', groupCode);
                    currentGroupId = groupCode; isGuestMode = true;
                    await loadGroupData(currentGroupId, true);
                    showToast(`ƒêang xem nh√≥m: ${docSnap.data().groupName}`, "info");
                } else {
                    if (groupCodeFromUrl) { localStorage.removeItem('guest_group_id'); history.pushState("", document.title, window.location.pathname); window.location.hash = ''; }
                    showToast("M√£ nh√≥m kh√¥ng t·ªìn t·∫°i.", "error");
                    showView('auth-view');
                }
            } catch (error) { showToast("Kh√¥ng th·ªÉ t√¨m th·∫•y nh√≥m.", "error"); showView('auth-view'); }
        };
        const handleEditGroupName = async () => {
            if (isGuestMode) return;
            const currentName = document.getElementById('display-group-name').textContent;
            const newName = prompt("Nh·∫≠p t√™n nh√≥m m·ªõi:", currentName);
            if (newName && newName.trim() !== '' && newName.trim() !== currentName) {
                loadingSpinner.style.display = 'flex';
                try { await updateDoc(doc(db, getPublicGroupCollectionPath(), currentGroupId), { groupName: newName.trim() }); showToast("ƒê√£ c·∫≠p nh·∫≠t t√™n nh√≥m!", "success"); }
                catch (error) { showToast("C·∫≠p nh·∫≠t t√™n nh√≥m th·∫•t b·∫°i.", "error"); }
                finally { loadingSpinner.style.display = 'none'; }
            }
        };
        const handleChangeGroupCode = async () => {
            if (isGuestMode) return;
            const newGroupId = prompt("Nh·∫≠p m√£ nh√≥m m·ªõi (ch·ªØ hoa, kh√¥ng d·∫•u). M√£ c≈© s·∫Ω b·ªã x√≥a vƒ©nh vi·ªÖn:")?.trim().toUpperCase();
            if (!newGroupId || newGroupId === currentGroupId) { showToast("H√†nh ƒë·ªông ƒë√£ ƒë∆∞·ª£c h·ªßy ho·∫∑c m√£ m·ªõi kh√¥ng h·ª£p l·ªá.", "info"); return; }
            loadingSpinner.style.display = 'flex';
            const oldGroupRef = doc(db, getPublicGroupCollectionPath(), currentGroupId), newGroupRef = doc(db, getPublicGroupCollectionPath(), newGroupId);
            try {
                const newGroupSnap = await getDoc(newGroupRef);
                if (newGroupSnap.exists()) { showToast(`M√£ nh√≥m "${newGroupId}" ƒë√£ t·ªìn t·∫°i.`, 'error'); return; }
                const oldGroupData = (await getDoc(oldGroupRef)).data();
                if (!oldGroupData) { showToast("Kh√¥ng t√¨m th·∫•y d·ªØ li·ªáu nh√≥m c≈©.", "error"); return; }
                const oldOrdersSnap = await getDocs(collection(oldGroupRef, "orders"));
                const batch = writeBatch(db);
                batch.set(newGroupRef, oldGroupData);
                oldOrdersSnap.forEach(orderDoc => batch.set(doc(collection(newGroupRef, "orders"), orderDoc.id), orderDoc.data()));
                oldOrdersSnap.forEach(orderDoc => batch.delete(orderDoc.ref));
                batch.delete(oldGroupRef);
                await batch.commit();
                showToast(`ƒê√£ ƒë·ªïi m√£ nh√≥m th√†nh c√¥ng th√†nh "${newGroupId}"!`, "success");
                currentGroupId = newGroupId; window.location.hash = newGroupId;
                await loadGroupData(currentGroupId);
            } catch (error) { showToast("ƒê·ªïi m√£ nh√≥m th·∫•t b·∫°i.", "error"); }
            finally { loadingSpinner.style.display = 'none'; }
        };

        // Data Loading and Rendering
        const loadGroupData = async (groupId, isReadOnly = false) => {
            try {
                onSnapshot(doc(db, getPublicGroupCollectionPath(), groupId), (docSnap) => {
                    if (!docSnap.exists()) { showToast("Nh√≥m kh√¥ng c√≤n t·ªìn t·∫°i.", "error"); isGuestMode ? handleGuestExit() : checkUserGroup(); return; }
                    document.getElementById('display-group-name').textContent = docSnap.data().groupName;
                });
                document.getElementById('display-group-code').textContent = groupId;
                document.getElementById('copy-group-code-btn').dataset.copyLink = `${window.location.origin}${window.location.pathname}#${groupId}`;
                const isAdmin = !(isReadOnly || isGuestMode);
                document.getElementById('order-form-container').classList.toggle('hidden', !isAdmin);
                headerSettingsBtn.classList.toggle('hidden', !isAdmin);
                toggleSelectionModeBtn.classList.toggle('hidden', !isAdmin);
                document.getElementById('dropdown-import').classList.toggle('hidden', !isAdmin);
                backToGroupsBtn.classList.toggle('hidden', isReadOnly);
                const logoutBtn = document.getElementById('logout-btn');
                const newLogoutBtn = logoutBtn.cloneNode(true);
                logoutBtn.parentNode.replaceChild(newLogoutBtn, logoutBtn);
                if (isReadOnly) { newLogoutBtn.innerHTML = `<i class="fas fa-door-open mr-2"></i>Tho√°t Nh√≥m`; newLogoutBtn.addEventListener('click', handleGuestExit); }
                else { newLogoutBtn.innerHTML = `<i class="fas fa-sign-out-alt mr-2"></i>ƒêƒÉng Xu·∫•t`; newLogoutBtn.addEventListener('click', handleLogout); }
                if (ordersListenerUnsubscribe) ordersListenerUnsubscribe();
                ordersListenerUnsubscribe = onSnapshot(query(collection(db, getPublicGroupCollectionPath(), groupId, "orders")), (snapshot) => {
                    allOrders = []; selectedOrders.clear();
                    snapshot.forEach(doc => allOrders.push({ id: doc.id, ...doc.data() }));
                    allOrders.sort((a, b) => (b.createdAt?.toMillis() || 0) - (a.createdAt?.toMillis() || 0));
                    handleSearch(); updateBulkActionBar();
                }, (error) => { showToast("Kh√¥ng th·ªÉ t·∫£i danh s√°ch ƒë∆°n h√†ng.", "error"); });
                showView('main-app-view');
            } catch (error) { showToast("Kh√¥ng th·ªÉ t·∫£i d·ªØ li·ªáu nh√≥m.", "error"); showView('auth-view'); }
        };
        const renderOrders = (orders, isReadOnly) => {
            ordersContainer.innerHTML = orders.length === 0 ? `<p class="text-center py-8 text-[var(--text-secondary)]">Ch∆∞a c√≥ ƒë∆°n h√†ng n√†o, th√™m ngay th√¥i! üéâ</p>` : '';
            const headerCheckboxHTML = isReadOnly ? '' : `<th class="w-12 px-6 py-3 selection-cell"><input type="checkbox" class="select-all-checkbox h-4 w-4 rounded border-slate-300 text-[var(--accent-primary)] focus:ring-[var(--accent-primary)]"></th>`;
            const rowCheckboxHTML = (id) => isReadOnly ? '' : `<td class="px-6 py-4 selection-cell"><input type="checkbox" class="row-checkbox h-4 w-4 rounded border-slate-300 text-[var(--accent-primary)] focus:ring-[var(--accent-primary)]" data-id="${id}"></td>`;
            if (isGroupedView) {
                [...new Set(orders.map(o => o.ownerName))].sort().forEach(owner => {
                    const ownerOrders = orders.filter(o => o.ownerName === owner);
                    const tableId = `table-for-${owner.replace(/[^a-zA-Z0-9]/g, '-')}`;
                    const groupDiv = document.createElement('div');
                    groupDiv.innerHTML = `<h3 class="text-lg font-bold mb-2 p-3 bg-[var(--accent-secondary)] rounded-xl text-[var(--accent-secondary-text)]">${owner} (${ownerOrders.length} ƒë∆°n)</h3><div class="overflow-x-auto"><table class="min-w-full"><thead class="bg-[var(--bg-primary)]"><tr>${headerCheckboxHTML}<th class="px-6 py-3 text-left text-xs font-semibold text-slate-500 uppercase tracking-wider">STT</th><th class="px-6 py-3 text-left text-xs font-semibold text-slate-500 uppercase tracking-wider">M√£ ƒê∆°n H√†ng</th></tr></thead><tbody id="${tableId}" class="bg-[var(--bg-secondary)]"></tbody></table></div>`;
                    ordersContainer.appendChild(groupDiv);
                    const tableBody = document.getElementById(tableId);
                    ownerOrders.forEach((order, index) => {
                        const row = document.createElement('tr');
                        row.className = 'selection-row border-b border-[var(--border-color)] last:border-b-0';
                        row.innerHTML = `${rowCheckboxHTML(order.id)}<td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-slate-500">${index + 1}</td><td class="px-6 py-4 whitespace-nowrap text-sm font-mono text-[var(--text-primary)]">${order.orderCode || ''}</td>`;
                        tableBody.appendChild(row);
                    });
                });
            } else {
                const tableContainer = document.createElement('div');
                tableContainer.innerHTML = `<div class="overflow-x-auto"><table class="min-w-full"><thead class="bg-[var(--bg-primary)]"><tr>${headerCheckboxHTML}<th class="px-6 py-3 text-left text-xs font-semibold text-slate-500 uppercase tracking-wider">STT</th><th class="px-6 py-3 text-left text-xs font-semibold text-slate-500 uppercase tracking-wider">M√£ ƒê∆°n H√†ng</th><th class="px-6 py-3 text-left text-xs font-semibold text-slate-500 uppercase tracking-wider">S·ªü H·ªØu</th></tr></thead><tbody id="single-table" class="bg-[var(--bg-secondary)]"></tbody></table></div>`;
                ordersContainer.appendChild(tableContainer);
                const tableBody = document.getElementById('single-table');
                orders.forEach((order, index) => {
                    const row = document.createElement('tr');
                    row.className = 'selection-row border-b border-[var(--border-color)] last:border-b-0';
                    row.innerHTML = `${rowCheckboxHTML(order.id)}<td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-slate-500">${index + 1}</td><td class="px-6 py-4 whitespace-nowrap text-sm font-mono text-[var(--text-primary)]">${order.orderCode || ''}</td><td class="px-6 py-4 whitespace-nowrap text-sm text-[var(--text-secondary)] font-semibold">${order.ownerName || ''}</td>`;
                    tableBody.appendChild(row);
                });
            }
            selectedOrders.forEach(id => { const cb = ordersContainer.querySelector(`.row-checkbox[data-id="${id}"]`); if (cb) cb.checked = true; });
            updateAllSelectAllCheckboxes();
        };
        function updateAllSelectAllCheckboxes() {
            ordersContainer.querySelectorAll('table').forEach(table => {
                const rows = table.querySelectorAll('.row-checkbox'), selectAll = table.querySelector('.select-all-checkbox');
                if (selectAll) { const checkedCount = Array.from(rows).filter(cb => cb.checked).length; selectAll.checked = rows.length > 0 && checkedCount === rows.length; }
            });
        }
        const handleAddOrder = async (e) => {
            e.preventDefault(); if (isGuestMode) return;
            const ownerName = document.getElementById('owner-name-input').value.trim(), orderCodesRaw = document.getElementById('order-code-input').value.trim();
            if (!ownerName || !orderCodesRaw) { showToast("Vui l√≤ng nh·∫≠p t√™n v√† m√£ ƒë∆°n h√†ng.", "error"); return; }
            const orderCodes = orderCodesRaw.split('\n').map(c => c.trim()).filter(Boolean);
            let addedCount = 0, duplicateCodes = [], existingCodes = new Set(allOrders.map(o => o.orderCode));
            const batch = writeBatch(db);
            for (const code of orderCodes) {
                if (existingCodes.has(code)) { duplicateCodes.push(code); continue; }
                batch.set(doc(collection(db, getPublicGroupCollectionPath(), currentGroupId, "orders")), { orderCode: code, ownerName, createdAt: serverTimestamp() });
                addedCount++;
            }
            try {
                await batch.commit();
                let msg = `ƒê√£ th√™m ${addedCount} ƒë∆°n h√†ng m·ªõi.`;
                if (duplicateCodes.length > 0) showToast(`C√°c m√£ sau ƒë√£ t·ªìn t·∫°i: ${duplicateCodes.join(', ')}`, 'error');
                showToast(msg, "success");
                document.getElementById('order-code-input').value = '';
            } catch (error) { showToast(`L·ªói khi th√™m ƒë∆°n h√†ng.`, "error"); }
        };

        // Bulk Actions
        function updateBulkActionBar() {
            if (isGuestMode) return; const count = selectedOrders.size;
            if (isSelectionModeActive && count > 0) {
                bulkActionBar.classList.remove('hidden'); selectionCountEl.textContent = count;
                const items = allOrders.filter(o => selectedOrders.has(o.id));
                const firstOwner = items.length > 0 ? items[0].ownerName : null;
                bulkEditBtn.disabled = !items.every(o => o.ownerName === firstOwner);
            } else bulkActionBar.classList.add('hidden');
        }
        async function handleBulkDelete() {
            const count = selectedOrders.size; if (count === 0) return;
            showConfirmModal(`X√≥a ${count} m·ª•c`, `B·∫°n ch·∫Øc ch·∫Øn mu·ªën x√≥a ${count} ƒë∆°n h√†ng ƒë√£ ch·ªçn?`, async () => {
                loadingSpinner.style.display = 'flex';
                const batch = writeBatch(db);
                selectedOrders.forEach(id => batch.delete(doc(db, getPublicGroupCollectionPath(), currentGroupId, "orders", id)));
                try { await batch.commit(); showToast(`ƒê√£ x√≥a th√†nh c√¥ng ${count} ƒë∆°n h√†ng.`, 'success'); }
                catch (error) { showToast("X√≥a h√†ng lo·∫°t th·∫•t b·∫°i.", "error"); }
                finally { loadingSpinner.style.display = 'none'; }
            });
        }
        async function handleBulkEditOwner() {
            const items = allOrders.filter(o => selectedOrders.has(o.id)); if (items.length === 0) return;
            const currentOwner = items[0].ownerName;
            const newOwner = prompt("Nh·∫≠p t√™n ng∆∞·ªùi s·ªü h·ªØu m·ªõi:", currentOwner);
            if (newOwner && newOwner.trim() !== '' && newOwner.trim() !== currentOwner) {
                loadingSpinner.style.display = 'flex';
                const batch = writeBatch(db);
                selectedOrders.forEach(id => batch.update(doc(db, getPublicGroupCollectionPath(), currentGroupId, "orders", id), { ownerName: newOwner.trim() }));
                try { await batch.commit(); showToast(`ƒê√£ c·∫≠p nh·∫≠t ${selectedOrders.size} ƒë∆°n h√†ng.`, 'success'); }
                catch (error) { showToast("C·∫≠p nh·∫≠t h√†ng lo·∫°t th·∫•t b·∫°i.", "error"); }
                finally { loadingSpinner.style.display = 'none'; }
            }
        }

        // Import/Export
        const handleExport = () => {
            if (allOrders.length === 0) { showToast("Kh√¥ng c√≥ d·ªØ li·ªáu ƒë·ªÉ xu·∫•t.", "info"); return; }
            const groupName = document.getElementById('display-group-name').textContent.replace(/\s/g, '_'), date = new Date().toISOString().slice(0, 10);
            const dataToExport = allOrders.map(({ orderCode, ownerName }) => ({ orderCode, ownerName }));
            const blob = new Blob([JSON.stringify(dataToExport, null, 2)], { type: 'application/json' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob); link.download = `export_${groupName}_${date}.json`;
            document.body.appendChild(link); link.click(); document.body.removeChild(link);
            showToast("ƒê√£ b·∫Øt ƒë·∫ßu t·∫£i xu·ªëng.", "success");
        };
        const handleImport = async (event) => {
            const file = event.target.files[0]; if (!file) return;
            loadingSpinner.style.display = 'flex';
            const reader = new FileReader();
            reader.onload = async (e) => {
                try {
                    const data = JSON.parse(e.target.result); if (!Array.isArray(data)) throw new Error("File JSON ph·∫£i l√† m·ªôt m·∫£ng.");
                    let skipped = 0, imported = 0, existing = new Set(allOrders.map(o => o.orderCode));
                    const batch = writeBatch(db);
                    for (const item of data) {
                        if (item && item.orderCode && item.ownerName) {
                            if (existing.has(item.orderCode)) skipped++;
                            else {
                                batch.set(doc(collection(db, getPublicGroupCollectionPath(), currentGroupId, "orders")), { orderCode: item.orderCode, ownerName: item.ownerName, createdAt: serverTimestamp() });
                                imported++; existing.add(item.orderCode);
                            }
                        }
                    }
                    if (imported > 0) await batch.commit();
                    let msg = `Nh·∫≠p th√†nh c√¥ng ${imported} ƒë∆°n h√†ng.`;
                    if (skipped > 0) msg += ` B·ªè qua ${skipped} ƒë∆°n h√†ng tr√πng l·∫∑p.`;
                    showToast(msg, imported > 0 ? "success" : "info");
                } catch (error) { showToast(`L·ªói nh·∫≠p t·ªáp: ${error.message}`, "error"); }
                finally { loadingSpinner.style.display = 'none'; event.target.value = null; }
            };
            reader.readAsText(file);
        };
        const copyOrderData = (type) => {
            if (allOrders.length === 0) {
                showToast("Kh√¥ng c√≥ d·ªØ li·ªáu ƒë·ªÉ sao ch√©p.", "info");
                return;
            }
            const searchTerm = searchInput.value.toLowerCase();
            const displayedOrders = searchTerm ? allOrders.filter(o => o.orderCode.toLowerCase().includes(searchTerm) || o.ownerName.toLowerCase().includes(searchTerm)) : allOrders;

            let textToCopy = '';
            switch (type) {
                case 'all':
                    textToCopy = displayedOrders.map((order, index) => `${index + 1}\t${order.orderCode}\t${order.ownerName}`).join('\n');
                    break;
                case 'stt':
                    textToCopy = displayedOrders.map((order, index) => `${index + 1}`).join('\n');
                    break;
                case 'code':
                    textToCopy = displayedOrders.map(order => order.orderCode).join('\n');
                    break;
                case 'owner':
                    textToCopy = displayedOrders.map(order => order.ownerName).join('\n');
                    break;
                default: return;
            }
            navigator.clipboard.writeText(textToCopy).then(
                () => showToast('ƒê√£ sao ch√©p v√†o clipboard!', 'success'),
                () => showToast('Sao ch√©p th·∫•t b·∫°i.', 'error')
            );
        };
        ordersContainer.addEventListener('change', (e) => {
            if (e.target.matches('.row-checkbox, .select-all-checkbox')) {
                const isSelectAll = e.target.matches('.select-all-checkbox');
                const table = e.target.closest('table');
                const rows = table.querySelectorAll('.row-checkbox');
                rows.forEach(cb => {
                    const id = cb.dataset.id;
                    const shouldBeChecked = isSelectAll ? e.target.checked : (e.target === cb ? cb.checked : selectedOrders.has(id));
                    if (shouldBeChecked) selectedOrders.add(id); else selectedOrders.delete(id);
                    if (isSelectAll) cb.checked = e.target.checked;
                });
                updateBulkActionBar(); updateAllSelectAllCheckboxes();
            }
        });

        // Search & Tally Logic
        const handleSearch = () => {
            const term = searchInput.value.toLowerCase();
            const filtered = term ? allOrders.filter(o => o.orderCode.toLowerCase().includes(term) || o.ownerName.toLowerCase().includes(term)) : allOrders;
            renderOrders(filtered, isGuestMode);
        };
        const openScanner = () => {
            scannerModal.classList.remove('hidden');
            scanResultEl.innerHTML = ''; // X√≥a k·∫øt qu·∫£ qu√©t c≈©
            // Lu√¥n hi·ªÉn th·ªã ph·∫ßn ch·ªçn ph∆∞∆°ng th·ª©c qu√©t/nh·∫≠p
            scannerMethodContainer.classList.remove('hidden');
            showManualCheckTab.classList.add('active'); // M·∫∑c ƒë·ªãnh tab Th·ªß c√¥ng
            showQrScannerTab.classList.remove('active');
            manualCheckView.classList.remove('hidden'); // Hi·ªÉn th·ªã view Th·ªß c√¥ng
            qrScannerView.classList.add('hidden'); // ·∫®n view Qu√©t QR
            manualOrderCodeInput.value = ''; // X√≥a input th·ªß c√¥ng c≈©
            manualSuggestionsList.classList.add('hidden'); // ·∫®n g·ª£i √Ω c≈©

            const owners = [...new Set(allOrders.map(o => o.ownerName))].sort();
            // Th√™m l·ª±a ch·ªçn "Ki·ªÉm tra t·∫•t c·∫£" v√†o ƒë·∫ßu danh s√°ch
            scannerOwnerSelect.innerHTML = `<option value="">-- Ki·ªÉm tra t·∫•t c·∫£ --</option>${owners.map(o => `<option value="${o}">${o}</option>`).join('')}`;
            scannerOwnerSelect.value = ''; // ƒê·∫∑t gi√° tr·ªã m·∫∑c ƒë·ªãnh l√† ki·ªÉm tra t·∫•t c·∫£
            renderTallyTable(); // Hi·ªÉn th·ªã b·∫£ng ki·ªÉm k√™ (n·∫øu c√≥ d·ªØ li·ªáu c≈©)

            // T·ª± ƒë·ªông b·∫Øt ƒë·∫ßu qu√©t n·∫øu ng∆∞·ªùi d√πng chuy·ªÉn sang tab 
        };
        const closeScanner = () => {
            if (html5QrCode && html5QrCode.isScanning) html5QrCode.stop().catch(console.error);
            scannerModal.classList.add('hidden'); availableCameras = [];
        };
        const processCheckedOrder = (orderCode) => {
            const selectedOwner = scannerOwnerSelect.value; // L·∫•y ng∆∞·ªùi nh·∫≠n ƒëang ƒë∆∞·ª£c ch·ªçn (c√≥ th·ªÉ r·ªóng)
            const foundOrder = allOrders.find(o => o.orderCode.toLowerCase() === orderCode.toLowerCase());

            // D·ª´ng qu√©t QR n·∫øu ƒëang qu√©t
            if (html5QrCode && html5QrCode.isScanning) {
                html5QrCode.stop().catch(console.error);
            }

            if (foundOrder) {
                // Ki·ªÉm tra xem c√≥ c·∫ßn l·ªçc theo ng∆∞·ªùi nh·∫≠n kh√¥ng
                if (!selectedOwner || foundOrder.ownerName === selectedOwner) {
                    // T√¨m th·∫•y ƒë∆°n h√†ng h·ª£p l·ªá
                    playSuccessSound(); // Ph√°t √¢m thanh th√†nh c√¥ng
                    // Hi·ªÉn th·ªã th√¥ng b√°o t√¨m th·∫•y t·∫°m th·ªùi
                    scanResultEl.innerHTML = `<span class="text-blue-600 font-semibold">T√¨m th·∫•y: ${foundOrder.orderCode} (${foundOrder.ownerName}). Nh·∫≠p chi ti·∫øt:</span>`;

                    // Hi·ªÉn th·ªã modal ƒë·ªÉ nh·∫≠p c√¢n n·∫∑ng v√† ghi ch√∫
                    manualCheckConfirmModal.classList.remove('hidden');
                    confirmOrderCodeEl.textContent = foundOrder.orderCode; // Hi·ªÉn th·ªã m√£ ƒë∆°n trong modal
                    confirmWeightInput.value = ''; // X√≥a gi√° tr·ªã c≈©
                    confirmNoteInput.value = ''; // X√≥a gi√° tr·ªã c≈©
                    confirmWeightInput.focus(); // Focus v√†o √¥ nh·∫≠p c√¢n n·∫∑ng
                    // L∆∞u tr·ªØ th√¥ng tin ƒë∆°n h√†ng t√¨m th·∫•y v√†o dataset c·ªßa n√∫t OK ƒë·ªÉ x·ª≠ l√Ω sau
                    manualConfirmOkBtn.dataset.order = JSON.stringify(foundOrder);

                } else {
                    // T√¨m th·∫•y ƒë∆°n h√†ng nh∆∞ng kh√¥ng thu·ªôc ng∆∞·ªùi nh·∫≠n ƒë√£ ch·ªçn
                    playErrorSound();
                    scanResultEl.innerHTML = `<span class="text-amber-500 font-bold">‚ö†Ô∏è SAI H√ÄNG! M√£ ${orderCode} thu·ªôc v·ªÅ ${foundOrder.ownerName}.</span>`;
                    // T·ª± ƒë·ªông qu√©t l·∫°i sau m·ªôt kho·∫£ng th·ªùi gian ng·∫Øn n·∫øu ƒëang d√πng QR
                    if (showQrScannerTab.classList.contains('active') && html5QrCode) {
                        setTimeout(startQrScanner, 1500); // Qu√©t l·∫°i sau 1.5 gi√¢y
                    }
                }
            } else {
                // Kh√¥ng t√¨m th·∫•y m√£ ƒë∆°n h√†ng trong danh s√°ch
                playErrorSound();
                scanResultEl.innerHTML = `<span class="text-rose-500 font-bold">‚ùå Kh√¥ng t√¨m th·∫•y m√£ '${orderCode}'.</span>`;
                // T·ª± ƒë·ªông qu√©t l·∫°i sau m·ªôt kho·∫£ng th·ªùi gian ng·∫Øn n·∫øu ƒëang d√πng QR
                if (showQrScannerTab.classList.contains('active') && html5QrCode) {
                    setTimeout(startQrScanner, 1500); // Qu√©t l·∫°i sau 1.5 gi√¢y
                }
            }
        };
        manualConfirmOkBtn.addEventListener('click', () => {
            const orderString = manualConfirmOkBtn.dataset.order; // L·∫•y th√¥ng tin ƒë∆°n h√†ng ƒë√£ l∆∞u
            if (!orderString) {
                console.error("Kh√¥ng t√¨m th·∫•y th√¥ng tin ƒë∆°n h√†ng ƒë·ªÉ x√°c nh·∫≠n.");
                manualCheckConfirmModal.classList.add('hidden'); // ·∫®n modal n·∫øu c√≥ l·ªói
                return;
            }

            try {
                const order = JSON.parse(orderString);
                const weight = confirmWeightInput.value; // L·∫•y c√¢n n·∫∑ng ƒë√£ nh·∫≠p
                const note = confirmNoteInput.value; // L·∫•y ghi ch√∫ ƒë√£ nh·∫≠p
                const tallyOwner = order.ownerName; // L·∫•y t√™n ng∆∞·ªùi nh·∫≠n t·ª´ ƒë∆°n h√†ng

                // Th√™m ƒë∆°n h√†ng v√†o danh s√°ch ki·ªÉm k√™ c·ª•c b·ªô
                addOrderToLocalTally(order, tallyOwner, weight, note);

                // Hi·ªÉn th·ªã th√¥ng b√°o th√†nh c√¥ng cu·ªëi c√πng
                scanResultEl.innerHTML = `<span class="text-green-500 font-bold">‚úÖ ƒê√É KI·ªÇM: ${order.orderCode}</span>`;

                manualCheckConfirmModal.classList.add('hidden'); // ·∫®n modal
                manualOrderCodeInput.value = ''; // X√≥a input m√£ ƒë∆°n th·ªß c√¥ng
                manualSuggestionsList.classList.add('hidden'); // ·∫®n danh s√°ch g·ª£i √Ω

                // X√≥a th√¥ng tin ƒë∆°n h√†ng ƒë√£ l∆∞u kh·ªèi n√∫t
                manualConfirmOkBtn.removeAttribute('data-order');

                // N·∫øu ƒëang ·ªü tab qu√©t QR, b·∫Øt ƒë·∫ßu qu√©t l·∫°i
                if (showQrScannerTab.classList.contains('active')) {
                    startQrScanner();
                }

            } catch (error) {
                console.error("L·ªói khi x·ª≠ l√Ω x√°c nh·∫≠n ki·ªÉm h√†ng:", error);
                showToast("C√≥ l·ªói x·∫£y ra, vui l√≤ng th·ª≠ l·∫°i.", "error");
                manualCheckConfirmModal.classList.add('hidden'); // ·∫®n modal n·∫øu c√≥ l·ªói
                // N·∫øu ƒëang ·ªü tab qu√©t QR, b·∫Øt ƒë·∫ßu qu√©t l·∫°i
                if (showQrScannerTab.classList.contains('active')) {
                    startQrScanner();
                }
            }
        });

        // Event listener cho n√∫t H·ªßy trong modal nh·∫≠p c√¢n n·∫∑ng/ghi ch√∫
        manualConfirmCancelBtn.addEventListener('click', () => {
            manualCheckConfirmModal.classList.add('hidden'); // Ch·ªâ c·∫ßn ·∫©n modal
            scanResultEl.innerHTML = ''; // X√≥a th√¥ng b√°o t√¨m th·∫•y
            manualConfirmOkBtn.removeAttribute('data-order'); // X√≥a th√¥ng tin ƒë∆°n h√†ng ƒë√£ l∆∞u
            // N·∫øu ƒëang ·ªü tab qu√©t QR, b·∫Øt ƒë·∫ßu qu√©t l·∫°i
            if (showQrScannerTab.classList.contains('active')) {
                startQrScanner();
            }
        });
        manualConfirmCancelBtn.addEventListener('click', () => manualCheckConfirmModal.classList.add('hidden'));
        function startQrScanner() {
            // D·ª´ng qu√©t c≈© n·∫øu ƒëang ch·∫°y
            if (html5QrCode && html5QrCode.isScanning) {
                html5QrCode.stop().catch(() => { });
                html5QrCode = null;
            }

            scanResultEl.innerHTML = '';

            if (!qrEl) {
                showToast("Kh√¥ng t√¨m th·∫•y v√πng qu√©t QR.", "error");
                return;
            }

            if (!html5QrCode) {
                try {
                    html5QrCode = new Html5Qrcode("qr-reader");
                } catch (e) {
                    console.error(e);
                    showToast("L·ªói kh·ªüi t·∫°o QR library", "error");
                    qrEl.innerHTML = `<p style="color:red;">Kh√¥ng th·ªÉ kh·ªüi t·∫°o</p>`;
                    return;
                }
            }

            const focusMode = focusModeSelect ? focusModeSelect.value : "full";

            const baseConfig = {
                fps: 10,
                videoConstraints: {
                    facingMode: { ideal: "environment" },
                    width: { ideal: 1280 },
                    height: { ideal: 720 },
                    advanced: [{ focusMode: "continuous" }, { zoom: 1.1 }]
                }
            };

            if (focusMode === "center") {
                baseConfig.qrbox = (vw, vh) => {
                    const edge = Math.min(vw, vh) * 0.6;
                    return { width: edge, height: edge };
                };
            }

            const applyRefocusMode = () => {
                // Xo√° callback c≈©
                qrEl.onclick = null;
                if (window._refocusTimer) clearInterval(window._refocusTimer);

                if (focusMode === "tap") {
                    qrEl.onclick = () => {
                        if (html5QrCode?.isScanning) {
                            html5QrCode.pause(true);
                            setTimeout(() => html5QrCode.resume(), 150);
                        }
                    };
                }

                if (focusMode === "auto-refocus") {
                    window._refocusTimer = setInterval(() => {
                        if (html5QrCode?.isScanning) {
                            html5QrCode.pause(true);
                            setTimeout(() => html5QrCode.resume(), 100);
                        }
                    }, 2500);
                }

                const originalStop = html5QrCode.stop.bind(html5QrCode);
                html5QrCode.stop = () => {
                    clearInterval(window._refocusTimer);
                    return originalStop();
                };
            };

            const startScan = (config, camConfig) => {
                html5QrCode.start(camConfig, config, processCheckedOrder, () => { })
                    .then(applyRefocusMode)
                    .catch(err => {
                        console.error("Kh√¥ng th·ªÉ kh·ªüi ƒë·ªông camera:", err);
                        showToast("ƒêang th·ª≠ fallback config...", "warning");

                        const simpleConfig = { fps: 10 };
                        const simpleCamConfig = camConfig;

                        html5QrCode.start(simpleCamConfig, simpleConfig, processCheckedOrder, () => { })
                            .then(applyRefocusMode)
                            .catch(finalErr => {
                                console.error(finalErr);
                                showToast("Kh√¥ng th·ªÉ truy c·∫≠p camera.", "error");
                                qrEl.innerHTML = `<p style="color:red;padding:10px;">Vui l√≤ng c·∫•p quy·ªÅn camera</p>`;
                                html5QrCode = null;
                            });
                    });
            };

            const initCameraListAndStart = () => {
                Html5Qrcode.getCameras().then(cameras => {
                    if (!cameras.length) {
                        showToast("Kh√¥ng t√¨m th·∫•y camera n√†o", "error");
                        return;
                    }
                    availableCameras = cameras;

                    if (cameras.length > 1 && cameraSelect) {
                        cameraSelectionContainer.classList.remove('hidden');
                        cameraSelect.innerHTML = cameras.map(cam =>
                            `<option value="${cam.id}">${cam.label || cam.id}</option>`
                        ).join('');
                        cameraSelect.onchange = startQrScanner;
                    } else if (cameraSelectionContainer) {
                        cameraSelectionContainer.classList.add('hidden');
                    }

                    const camConfig = cameraSelect && cameraSelect.value
                        ? { deviceId: { exact: cameraSelect.value } }
                        : { facingMode: "environment" };

                    startScan(baseConfig, camConfig);
                }).catch(err => {
                    console.error(err);
                    showToast("Kh√¥ng th·ªÉ truy c·∫≠p camera", "error");
                    qrEl.innerHTML = `<p style="color:red;">Kh√¥ng c√≥ quy·ªÅn camera</p>`;
                });
            };
            if (focusModeSelect) focusModeSelect.onchange = startQrScanner;


            if (!availableCameras.length) initCameraListAndStart();
            else {
                const camConfig = cameraSelect && cameraSelect.value
                    ? { deviceId: { exact: cameraSelect.value } }
                    : { facingMode: "environment" };
                startScan(baseConfig, camConfig);
            }
        }

        const getTallyData = () => JSON.parse(localStorage.getItem(`tally_${currentGroupId}`) || '[]');
        const saveTallyData = (data) => localStorage.setItem(`tally_${currentGroupId}`, JSON.stringify(data));
        const addOrderToLocalTally = (order, tallyOwner, weight, note) => {
            const data = getTallyData();
            if (data.some(item => item.orderCode === order.orderCode)) { scanResultEl.innerHTML = `<span class="text-blue-500 font-bold">ü§î M√£ ${order.orderCode} ƒë√£ ƒë∆∞·ª£c ki·ªÉm k√™ r·ªìi.</span>`; return; }
            data.push({ orderCode: order.orderCode, tallyOwner, weight: weight || '', note: note || '', timestamp: new Date().toISOString() });
            saveTallyData(data);
            showToast(`ƒê√£ ki·ªÉm k√™: ${order.orderCode}`, 'success');
            renderTallyTable();
        };

        // ============================================================================================
        // H√ÄM RENDER TALLY TABLE ƒê√É ƒê∆Ø·ª¢C C·∫¨P NH·∫¨T HO√ÄN TO√ÄN
        // ============================================================================================
        const renderTallyTable = () => {
            const data = getTallyData();
            const listBody = document.getElementById('tally-list-body');
            const listFooter = document.getElementById('tally-list-footer');
            listBody.innerHTML = '';
            listFooter.innerHTML = '';

            // X√≥a header c≈© v√† t·∫°o header m·ªõi v·ªõi c·ªôt "H√†nh ƒê·ªông"
            const headerContainer = document.querySelector('#tally-list-container .grid-cols-12');
            if (headerContainer) {
                headerContainer.innerHTML = `
                    <div class="col-span-3">M√£ ƒê∆°n</div>
                    <div class="col-span-2">C√¢n n·∫∑ng</div>
                    <div class="col-span-3">Ghi ch√∫</div>
                    <div class="col-span-3 text-right">Th·ªùi Gian</div>
                    <div class="col-span-1 text-center">H√†nh ƒê·ªông</div>
                `;
                // Th√™m class m·ªõi ƒë·ªÉ ƒëi·ªÅu ch·ªânh layout
                headerContainer.classList.remove('grid-cols-12');
                headerContainer.classList.add('grid-cols-13');
            }

            const formatWeightPrecise = (grams) => {
                const numGrams = Number(grams);
                if (!numGrams || numGrams === 0) return '-';
                if (numGrams < 1000) return `${numGrams.toLocaleString('vi-VN')} g`;
                return `${(numGrams / 1000).toFixed(3).replace('.', ',')} kg`;
            };

            data.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp)).forEach(item => {
                const isEditing = item.orderCode === editingTallyOrderCode;
                const rowDiv = document.createElement('div');
                // Thay ƒë·ªïi grid-cols-12 th√†nh grid-cols-13 ƒë·ªÉ th√™m c·ªôt h√†nh ƒë·ªông
                rowDiv.className = 'grid grid-cols-1 md:grid-cols-13 gap-x-4 gap-y-1 px-4 py-3 border-b border-[var(--border-color)] last:border-b-0 items-center';

                // Giao di·ªán hi·ªÉn th·ªã ho·∫∑c ch·ªânh s·ª≠a t√πy thu·ªôc v√†o bi·∫øn isEditing
                rowDiv.innerHTML = `
                    <div class="md:col-span-3 flex justify-between items-center">
                        <span class="md:hidden font-semibold text-[var(--text-secondary)]">M√£ ƒê∆°n:</span>
                        <span class="font-mono text-sm">${item.orderCode}</span>
                    </div>
                    <div class="md:col-span-2 flex justify-between items-center">
                        <span class="md:hidden font-semibold text-[var(--text-secondary)]">C√¢n n·∫∑ng:</span>
                        ${isEditing ? `
                            <input type="number" id="edit-weight-input" value="${item.weight || ''}" placeholder="gram" class="w-full text-sm p-1 border border-[var(--border-color-heavy)] rounded-md bg-[var(--bg-primary)]">
                        ` : `
                            <span class="text-sm">${formatWeightPrecise(item.weight)}</span>
                        `}
                    </div>
                    <div class="md:col-span-3 flex justify-between items-center">
                        <span class="md:hidden font-semibold text-[var(--text-secondary)]">Ghi ch√∫:</span>
                         ${isEditing ? `
                            <input type="text" id="edit-note-input" value="${item.note || ''}" placeholder="ghi ch√∫" class="w-full text-sm p-1 border border-[var(--border-color-heavy)] rounded-md bg-[var(--bg-primary)]">
                        ` : `
                            <span class="text-sm italic text-slate-500">${item.note || '-'}</span>
                        `}
                    </div>
                    <div class="md:col-span-3 flex justify-between items-center md:justify-end">
                        <span class="md:hidden font-semibold text-[var(--text-secondary)]">Th·ªùi gian:</span>
                        <span class="text-xs text-slate-500">${new Date(item.timestamp).toLocaleString('vi-VN')}</span>
                    </div>
                    <div class="md:col-span-1 flex justify-end items-center space-x-2 gap-2">
                        ${isEditing ? `
                            <button title="L∆∞u" class="save-tally-item-btn text-green-500 hover:text-green-700" data-order-code="${item.orderCode}"><i class="fas fa-check-circle fa-lg"></i></button>
                            <button title="H·ªßy" class="cancel-edit-tally-btn text-slate-500 hover:text-slate-700"><i class="fas fa-times-circle fa-lg"></i></button>
                        ` : `
                            <button title="S·ª≠a" class="edit-tally-item-btn text-blue-500 hover:text-blue-700" data-order-code="${item.orderCode}"><i class="fas fa-pencil-alt"></i></button>
                            <button title="X√≥a" class="delete-tally-item-btn text-rose-500 hover:text-rose-700" data-order-code="${item.orderCode}"><i class="fas fa-trash"></i></button>
                        `}
                    </div>
                `;
                listBody.appendChild(rowDiv);
            });

            // Ph·∫ßn footer gi·ªØ nguy√™n kh√¥ng thay ƒë·ªïi
            if (data.length > 0) {
                const totalWeightInGrams = data.reduce((sum, item) => sum + (Number(item.weight) || 0), 0);
                const totalKg = Math.floor(totalWeightInGrams / 1000);
                const remainingG = totalWeightInGrams % 1000;

                let primaryDisplay;
                if (totalKg > 0 && remainingG > 0) primaryDisplay = `${totalKg}kg ${remainingG}g`;
                else if (totalKg > 0) primaryDisplay = `${totalKg}kg`;
                else primaryDisplay = `${remainingG}g`;

                const secondaryDisplay = `(${totalWeightInGrams.toLocaleString('vi-VN')} g)`;
                const finalWeightDisplay = `${primaryDisplay} ${secondaryDisplay}`;

                const footerDiv = document.createElement('div');
                footerDiv.className = 'bg-[var(--bg-primary)] font-bold px-4 py-3 text-sm text-center rounded-b-xl';
                footerDiv.innerHTML = `
                    <div class="flex items-center justify-center gap-x-2">
                        <span><strong>T·ªïng c·ªông:</strong> ${data.length} ki·ªán / ${finalWeightDisplay}</span>
                        <button id="copy-total-weight-btn" title="Sao ch√©p t·ªïng c√¢n n·∫∑ng (g)" class="p-1 rounded-md hover:bg-slate-200 dark:hover:bg-slate-700 transition-colors">
                            <svg id="copy-icon" xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-clipboard" viewBox="0 0 16 16"><path d="M4 1.5H3a2 2 0 0 0-2 2V14a2 2 0 0 0 2 2h10a2 2 0 0 0 2-2V3.5a2 2 0 0 0-2-2h-1v1h1a1 1 0 0 1 1 1V14a1 1 0 0 1-1 1H3a1 1 0 0 1-1-1V3.5a1 1 0 0 1 1-1h1v-1z"/><path d="M9.5 1a.5.5 0 0 1 .5.5v1a.5.5 0 0 1-.5.5h-3a.5.5 0 0 1-.5-.5v-1a.5.5 0 0 1 .5-.5h3zm-3-1A1.5 1.5 0 0 0 5 1.5v1A1.5 1.5 0 0 0 6.5 4h3A1.5 1.5 0 0 0 11 2.5v-1A1.5 1.5 0 0 0 9.5 0h-3z"/></svg>
                            <svg id="check-icon" xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-check-lg hidden text-green-500" viewBox="0 0 16 16"><path d="M12.736 3.97a.733.733 0 0 1 1.047 0c.286.289.29.756.01 1.05L7.88 12.01a.733.733 0 0 1-1.065.02L3.217 8.384a.757.757 0 0 1 0-1.06.733.733 0 0 1 1.047 0l3.052 3.093 5.4-6.425a.247.247 0 0 1 .02-.022z"/></svg>
                        </button>
                    </div>
                `;
                listFooter.appendChild(footerDiv);

                const copyBtn = document.getElementById('copy-total-weight-btn');
                const copyIcon = document.getElementById('copy-icon');
                const checkIcon = document.getElementById('check-icon');
                copyBtn.addEventListener('click', () => {
                    navigator.clipboard.writeText(totalWeightInGrams).then(() => {
                        copyIcon.classList.add('hidden');
                        checkIcon.classList.remove('hidden');
                        setTimeout(() => {
                            copyIcon.classList.remove('hidden');
                            checkIcon.classList.add('hidden');
                        }, 1500);
                    }).catch(err => {
                        console.error('L·ªói sao ch√©p: ', err);
                        alert('Kh√¥ng th·ªÉ sao ch√©p!');
                    });
                });
            }
            tallyActions.classList.toggle('hidden', data.length === 0);
        };
        const handlePaste = async () => {
            try {
                const text = await navigator.clipboard.readText();
                const input = document.getElementById('order-code-input');
                input.value = (input.value.trim() ? input.value.trim() + '\n' : '') + text;
                input.focus();
                showToast("ƒê√£ d√°n t·ª´ clipboard.", "info");
            } catch (err) { showToast("Kh√¥ng th·ªÉ ƒë·ªçc clipboard.", "error"); }
        };
        const handleAutoPasteToggle = (e) => { isAutoPasteEnabled = e.target.checked; showToast(`T·ª± ƒë·ªông d√°n: ${isAutoPasteEnabled ? 'B·∫≠t' : 'T·∫Øt'}`, "info"); };
        window.addEventListener('focus', async () => { if (isAutoPasteEnabled && mainAppView.offsetParent !== null && !isGuestMode) await handlePaste(); });
        const handleDownloadTallyImage = () => { html2canvas(document.getElementById('tally-list-container')).then(c => { const l = document.createElement('a'); l.download = `kiem-ke-${currentGroupId}-${new Date().toISOString().slice(0, 10)}.png`; l.href = c.toDataURL(); l.click(); }); };
        const handleCopyTallyText = () => {
            const data = getTallyData();
            const text = "M√£ ƒê∆°n\tC√¢n n·∫∑ng (g)\tGhi ch√∫\tTh·ªùi Gian\n" + data.map(item => `${item.orderCode}\t${item.weight}\t${item.note}\t${new Date(item.timestamp).toLocaleString('vi-VN')}`).join('\n');
            navigator.clipboard.writeText(text).then(() => showToast('ƒê√£ sao ch√©p!', 'success'), () => showToast('Sao ch√©p th·∫•t b·∫°i.', 'error'));
        };
        const handleExportTallyExcel = () => {
            const data = getTallyData();
            let csv = "data:text/csv;charset=utf-8,M√£ ƒê∆°n,C√¢n n·∫∑ng (g),Ghi ch√∫,Th·ªùi Gian\n" + data.map(i => `"${i.orderCode}","${i.weight}","${i.note}","${new Date(i.timestamp).toLocaleString('vi-VN')}"`).join("\n");
            const link = document.createElement("a"); link.href = encodeURI(csv); link.download = `kiem-ke-${currentGroupId}-${new Date().toISOString().slice(0, 10)}.csv`;
            document.body.appendChild(link); link.click(); document.body.removeChild(link);
        };
        const handleClearTallyData = () => { showConfirmModal('X√≥a D·ªØ Li·ªáu Ki·ªÉm K√™', 'H√†nh ƒë·ªông n√†y s·∫Ω xo√° to√†n b·ªô d·ªØ li·ªáu ki·ªÉm k√™ tr√™n m√°y n√†y?', () => { localStorage.removeItem(`tally_${currentGroupId}`); renderTallyTable(); showToast("ƒê√£ xo√° d·ªØ li·ªáu.", "success"); }); };
        const handleManualInputSearch = (e) => {
            const owner = scannerOwnerSelect.value; // L·∫•y ng∆∞·ªùi nh·∫≠n ƒëang ch·ªçn (c√≥ th·ªÉ r·ªóng)
            const suggestionsList = document.getElementById('manual-suggestions-list'); // L·∫•y element danh s√°ch g·ª£i √Ω
            const term = e.target.value.toLowerCase().trim(); // L·∫•y v√† l√†m s·∫°ch t·ª´ kh√≥a t√¨m ki·∫øm

            suggestionsList.innerHTML = ''; // X√≥a g·ª£i √Ω c≈©

            if (!term) { // N·∫øu √¥ t√¨m ki·∫øm tr·ªëng
                suggestionsList.classList.add('hidden'); // ·∫®n danh s√°ch
                return; // D·ª´ng h√†m
            }

            // L·ªçc danh s√°ch ƒë∆°n h√†ng d·ª±a tr√™n vi·ªác c√≥ ch·ªçn ng∆∞·ªùi nh·∫≠n c·ª• th·ªÉ hay kh√¥ng
            const filtered = allOrders.filter(order => {
                const codeMatch = order.orderCode.toLowerCase().includes(term);
                if (owner) { // N·∫øu c√≥ ch·ªçn ng∆∞·ªùi nh·∫≠n c·ª• th·ªÉ
                    return order.ownerName === owner && codeMatch;
                } else { // N·∫øu ƒëang ch·ªçn "Ki·ªÉm tra t·∫•t c·∫£"
                    return codeMatch; // Ch·ªâ c·∫ßn kh·ªõp m√£ ƒë∆°n
                }
            }).slice(0, 5); // V·∫´n gi·ªõi h·∫°n 5 g·ª£i √Ω cho g·ªçn

            if (filtered.length > 0) {
                // T·∫°o c√°c m·ª•c g·ª£i √Ω
                filtered.forEach(order => {
                    const item = document.createElement('div');
                    item.className = 'px-4 py-2 hover:bg-[var(--bg-secondary-hover)] cursor-pointer text-sm border-b border-[var(--border-color)] last:border-b-0';
                    // N·∫øu ƒëang ki·ªÉm tra t·∫•t c·∫£, hi·ªÉn th·ªã c·∫£ t√™n ng∆∞·ªùi nh·∫≠n
                    if (!owner) {
                        item.innerHTML = `<strong class="font-mono">${order.orderCode}</strong> - <span class="text-[var(--text-secondary)]">${order.ownerName}</span>`;
                    } else { // N·∫øu ƒë√£ ch·ªçn ng∆∞·ªùi nh·∫≠n, ch·ªâ hi·ªÉn th·ªã m√£ ƒë∆°n
                        item.innerHTML = `<strong class="font-mono">${order.orderCode}</strong>`;
                    }
                    item.dataset.orderCode = order.orderCode; // L∆∞u m√£ ƒë∆°n v√†o dataset
                    suggestionsList.appendChild(item);
                });
                suggestionsList.classList.remove('hidden'); // Hi·ªÉn th·ªã danh s√°ch
            } else {
                suggestionsList.classList.add('hidden'); // ·∫®n danh s√°ch n·∫øu kh√¥ng c√≥ k·∫øt qu·∫£
            }
        };
        const handleSuggestionClick = (e) => {
            const target = e.target.closest('[data-order-code]');
            if (target) {
                processCheckedOrder(target.dataset.orderCode);
                manualOrderCodeInput.value = ''; manualSuggestionsList.classList.add('hidden');
            }
        }

        // Event Listeners Setup
        function setupEventListeners() {
            document.getElementById('open-login-modal-btn').addEventListener('click', () => loginModal.classList.remove('hidden'));
            document.getElementById('close-login-modal-btn').addEventListener('click', () => loginModal.classList.add('hidden'));
            document.getElementById('show-register-form').addEventListener('click', (e) => { e.preventDefault(); loginModal.querySelector('#login-form').classList.add('hidden'); loginModal.querySelector('#register-form').classList.remove('hidden'); loginModal.querySelector('#login-text').classList.add('hidden'); loginModal.querySelector('#register-text').classList.remove('hidden'); loginModal.querySelector('#login-modal-title').textContent = 'ƒêƒÉng K√Ω'; });
            document.getElementById('show-login-form').addEventListener('click', (e) => { e.preventDefault(); loginModal.querySelector('#register-form').classList.add('hidden'); loginModal.querySelector('#login-form').classList.remove('hidden'); loginModal.querySelector('#register-text').classList.add('hidden'); loginModal.querySelector('#login-text').classList.remove('hidden'); loginModal.querySelector('#login-modal-title').textContent = 'ƒêƒÉng Nh·∫≠p'; });
            document.getElementById('forgot-password-link').addEventListener('click', (e) => {
                e.preventDefault();
                handleForgotPassword();
            });
            document.getElementById('login-form').addEventListener('submit', handleLogin); document.getElementById('register-form').addEventListener('submit', handleRegister); document.getElementById('user-logout-btn').addEventListener('click', handleLogout);
            document.getElementById('view-with-code-btn').addEventListener('click', () => handleViewGroupWithCode(null)); document.getElementById('create-group-btn').addEventListener('click', handleCreateGroup); document.getElementById('create-new-group-from-list-btn').addEventListener('click', () => showView('create-group-view'));
            document.getElementById('add-order-form').addEventListener('submit', handleAddOrder); document.getElementById('paste-button').addEventListener('click', handlePaste); document.getElementById('auto-paste-toggle').addEventListener('change', handleAutoPasteToggle);
            document.getElementById('copy-group-code-btn').addEventListener('click', (e) => { const link = e.currentTarget.dataset.copyLink; if (link) navigator.clipboard.writeText(link).then(() => showToast('ƒê√£ sao ch√©p li√™n k·∫øt!', 'success'), () => showToast('Sao ch√©p th·∫•t b·∫°i.', 'error')); });
            searchInput.addEventListener('input', handleSearch); openScannerBtn.addEventListener('click', openScanner); document.getElementById('close-scanner-btn').addEventListener('click', closeScanner); backToGroupsBtn.addEventListener('click', checkUserGroup);
            editGroupNameBtn.addEventListener('click', (e) => { e.preventDefault(); handleEditGroupName(); headerSettingsMenu.classList.add('hidden'); });
            changeGroupCodeBtn.addEventListener('click', (e) => { e.preventDefault(); handleChangeGroupCode(); headerSettingsMenu.classList.add('hidden'); });
            headerSettingsBtn.addEventListener('click', (e) => { e.stopPropagation(); headerSettingsMenu.classList.toggle('hidden'); });
            moreActionsBtn.addEventListener('click', (e) => { e.stopPropagation(); dropdownMenu.classList.toggle('hidden'); });
            window.addEventListener('click', (e) => { if (!dropdownMenu.classList.contains('hidden') && !moreActionsBtn.contains(e.target)) dropdownMenu.classList.add('hidden'); if (!headerSettingsMenu.classList.contains('hidden') && !headerSettingsBtn.contains(e.target)) headerSettingsMenu.classList.add('hidden'); if (!manualSuggestionsList.classList.contains('hidden') && !manualOrderCodeInput.contains(e.target)) manualSuggestionsList.classList.add('hidden'); });
            dropdownToggleView.addEventListener('click', (e) => { e.preventDefault(); isGroupedView = !isGroupedView; document.getElementById('toggle-view-text').textContent = isGroupedView ? 'G·ªôp B·∫£ng' : 'T√°ch B·∫£ng'; handleSearch(); dropdownMenu.classList.add('hidden'); });
            dropdownCopy.addEventListener('click', (e) => {
                e.preventDefault();
                if (allOrders.length === 0) {
                    showToast("Kh√¥ng c√≥ d·ªØ li·ªáu ƒë·ªÉ sao ch√©p.", "info");
                    return;
                }
                copyModal.classList.remove('hidden');
                dropdownMenu.classList.add('hidden');
            });
            document.getElementById('copy-modal-cancel-btn').addEventListener('click', () => {
                copyModal.classList.add('hidden');
            });
            copyModal.addEventListener('click', (e) => {
                const button = e.target.closest('.copy-option-btn');
                if (button) {
                    const copyType = button.dataset.copyType;
                    copyOrderData(copyType);
                    copyModal.classList.add('hidden');
                }
            });
            dropdownImport.addEventListener('click', (e) => { e.preventDefault(); if (isGuestMode) { showToast("Kh√°ch kh√¥ng th·ªÉ d√πng ch·ª©c nƒÉng n√†y.", "info"); return; } importFileInput.click(); dropdownMenu.classList.add('hidden'); });
            importFileInput.addEventListener('change', handleImport); dropdownExport.addEventListener('click', (e) => { e.preventDefault(); handleExport(); dropdownMenu.classList.add('hidden'); });
            scannerOwnerSelect.addEventListener('change', () => {
                scanResultEl.textContent = ''; // X√≥a k·∫øt qu·∫£ qu√©t/t√¨m ki·∫øm c≈©
                manualOrderCodeInput.value = ''; // X√≥a n·ªôi dung input th·ªß c√¥ng
                manualSuggestionsList.classList.add('hidden'); // ·∫®n danh s√°ch g·ª£i √Ω

                // N·∫øu ƒëang ·ªü tab qu√©t QR, d·ª´ng qu√©t c≈© (n·∫øu c√≥) v√† b·∫Øt ƒë·∫ßu qu√©t m·ªõi
                if (showQrScannerTab.classList.contains('active')) {
                    if (html5QrCode && html5QrCode.isScanning) {
                        html5QrCode.stop().then(() => {
                            startQrScanner(); // B·∫Øt ƒë·∫ßu qu√©t l·∫°i sau khi d·ª´ng th√†nh c√¥ng
                        }).catch(err => {
                            console.error("L·ªói d·ª´ng QR scanner:", err);
                            startQrScanner(); // V·∫´n c·ªë g·∫Øng b·∫Øt ƒë·∫ßu l·∫°i
                        });
                    } else {
                        startQrScanner(); // N·∫øu ch∆∞a qu√©t th√¨ b·∫Øt ƒë·∫ßu
                    }
                }
            });
            showQrScannerTab.addEventListener('click', () => { showQrScannerTab.classList.add('active'); showManualCheckTab.classList.remove('active'); qrScannerView.classList.remove('hidden'); manualCheckView.classList.add('hidden'); startQrScanner(); });
            showManualCheckTab.addEventListener('click', () => { showManualCheckTab.classList.add('active'); showQrScannerTab.classList.remove('active'); manualCheckView.classList.remove('hidden'); qrScannerView.classList.add('hidden'); if (html5QrCode && html5QrCode.isScanning) html5QrCode.stop().catch(console.error); });
            manualOrderCodeInput.addEventListener('input', handleManualInputSearch); manualSuggestionsList.addEventListener('click', handleSuggestionClick);
            cameraSelect.addEventListener('change', startQrScanner); document.getElementById('download-tally-img-btn').addEventListener('click', handleDownloadTallyImage); document.getElementById('copy-tally-text-btn').addEventListener('click', handleCopyTallyText); document.getElementById('export-tally-excel-btn').addEventListener('click', handleExportTallyExcel); document.getElementById('clear-tally-btn').addEventListener('click', handleClearTallyData);
            bulkDeleteBtn.addEventListener('click', handleBulkDelete); bulkEditBtn.addEventListener('click', handleBulkEditOwner);
            toggleSelectionModeBtn.addEventListener('click', () => { if (isGuestMode) { showToast("Kh√°ch kh√¥ng th·ªÉ d√πng ch·ª©c nƒÉng n√†y.", "info"); return; } isSelectionModeActive = !isSelectionModeActive; ordersContainer.classList.toggle('selection-mode-active', isSelectionModeActive); if (isSelectionModeActive) { toggleSelectionModeBtn.classList.add('bg-rose-500', 'hover:bg-rose-600'); toggleSelectionModeBtn.classList.remove('bg-pink-400', 'hover:bg-pink-500'); } else { toggleSelectionModeBtn.classList.remove('bg-rose-500', 'hover:bg-rose-600'); toggleSelectionModeBtn.classList.add('bg-pink-400', 'hover:bg-pink-500'); selectedOrders.clear(); document.querySelectorAll('.row-checkbox:checked, .select-all-checkbox:checked').forEach(cb => cb.checked = false); updateBulkActionBar(); } });
            ordersContainer.addEventListener('click', (e) => { if (!isSelectionModeActive || e.target.closest('input, button, a')) return; const row = e.target.closest('.selection-row'); if (row) { const cb = row.querySelector('.row-checkbox'); if (cb) { cb.checked = !cb.checked; cb.dispatchEvent(new Event('change', { bubbles: true })); } } });

            // ============================================================================================
            // EVENT LISTENER M·ªöI CHO C√ÅC H√ÄNH ƒê·ªòNG TRONG B·∫¢NG KI·ªÇM K√ä
            // ============================================================================================
            document.getElementById('tally-list-body').addEventListener('click', (e) => {
                const orderCode = e.target.closest('button')?.dataset.orderCode;

                // X·ª≠ l√Ω n√∫t X√≥a
                if (e.target.closest('.delete-tally-item-btn')) {
                    showConfirmModal(`X√≥a m·ª•c ${orderCode}`, 'B·∫°n c√≥ ch·∫Øc mu·ªën x√≥a m·ª•c n√†y kh·ªèi danh s√°ch ƒë√£ ki·ªÉm k√™?', () => {
                        let data = getTallyData();
                        const newData = data.filter(item => item.orderCode !== orderCode);
                        saveTallyData(newData);
                        renderTallyTable();
                        showToast(`ƒê√£ x√≥a m·ª•c ${orderCode}.`, 'success');
                    });
                }

                // X·ª≠ l√Ω n√∫t S·ª≠a
                if (e.target.closest('.edit-tally-item-btn')) {
                    editingTallyOrderCode = orderCode;
                    renderTallyTable();
                }

                // X·ª≠ l√Ω n√∫t H·ªßy
                if (e.target.closest('.cancel-edit-tally-btn')) {
                    editingTallyOrderCode = null;
                    renderTallyTable();
                }

                // X·ª≠ l√Ω n√∫t L∆∞u
                if (e.target.closest('.save-tally-item-btn')) {
                    const newWeight = document.getElementById('edit-weight-input').value;
                    const newNote = document.getElementById('edit-note-input').value;

                    let data = getTallyData();
                    const itemIndex = data.findIndex(item => item.orderCode === orderCode);
                    if (itemIndex > -1) {
                        data[itemIndex].weight = newWeight.trim();
                        data[itemIndex].note = newNote.trim();
                        saveTallyData(data);
                        editingTallyOrderCode = null;
                        renderTallyTable();
                        showToast(`ƒê√£ c·∫≠p nh·∫≠t m·ª•c ${orderCode}.`, 'success');
                    }
                }
            });
        }

        // App Initialization
        loadTheme();
        setupEventListeners();
        onAuthStateChanged(auth, async (user) => {
            const groupCodeFromHash = window.location.hash.substring(1).toUpperCase();
            if (!user && groupCodeFromHash) {
                history.pushState("", document.title, window.location.pathname);
                await handleViewGroupWithCode(groupCodeFromHash);
                return;
            }
            if (user) {
                localStorage.removeItem('guest_group_id');
                currentUserId = user.uid;
                document.getElementById('display-user-email').textContent = user.email || '·∫®n danh';
                if (groupCodeFromHash) { currentGroupId = groupCodeFromHash; isGuestMode = false; loadGroupData(currentGroupId); }
                else await checkUserGroup();
            } else {
                const savedGuestGroupId = localStorage.getItem('guest_group_id');
                if (savedGuestGroupId) await handleViewGroupWithCode(savedGuestGroupId);
                else showView('auth-view');
            }
        });
    </script>
</body>

</html>