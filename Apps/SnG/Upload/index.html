<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Hệ thống Quản lý File Pro (Multi-Upload)</title>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    
    <style>
        body { font-family: 'Segoe UI', sans-serif; max-width: 900px; margin: 0 auto; padding: 20px; background: #f0f2f5; }
        .hidden { display: none !important; }
        
        /* Login Form Styles */
        .login-container { background: white; padding: 30px; border-radius: 10px; box-shadow: 0 4px 10px rgba(0,0,0,0.1); max-width: 400px; margin: 50px auto; text-align: center; }
        .input-group { margin-bottom: 15px; }
        input[type="email"], input[type="password"], input[type="text"] { width: 100%; padding: 10px; margin-top: 5px; box-sizing: border-box; border: 1px solid #ccc; border-radius: 5px; }
        
        /* Buttons */
        .btn { padding: 10px 20px; cursor: pointer; border: none; border-radius: 5px; font-weight: bold; transition: 0.2s; color: white; }
        .btn-primary { background: #007bff; width: 100%; margin-bottom: 10px; }
        .btn-google { background: #db4437; width: 100%; }
        .btn-logout { background: #6c757d; float: right; }
        .btn-upload { background: #28a745; }
        
        /* Main App Styles */
        .header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        .upload-section { background: white; padding: 20px; border-radius: 8px; margin-bottom: 20px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
        
        /* File List Styles */
        .file-item { background: white; padding: 15px; margin-bottom: 10px; display: flex; justify-content: space-between; align-items: center; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.05); transition: 0.2s; }
        .file-item:hover { transform: translateY(-2px); box-shadow: 0 4px 8px rgba(0,0,0,0.1); }
        
        .file-left { display: flex; align-items: center; gap: 15px; flex-grow: 1; }
        .file-thumb { width: 50px; height: 50px; object-fit: cover; border-radius: 4px; border: 1px solid #eee; }
        .file-details h4 { margin: 0 0 5px 0; font-size: 16px; color: #333; }
        .file-details span { font-size: 12px; color: #777; }
        
        .action-buttons { display: flex; gap: 8px; }
        .icon-btn { width: 35px; height: 35px; border-radius: 50%; border: none; cursor: pointer; display: flex; align-items: center; justify-content: center; color: white; font-size: 14px; }
        
        /* Action Button Colors */
        .btn-copy { background: #17a2b8; }
        .btn-down { background: #28a745; }
        .btn-edit { background: #ffc107; color: #333; }
        .btn-del { background: #dc3545; }
        .disabled { background: #e9ecef; color: #adb5bd; cursor: not-allowed; }

        #uploadStatus { margin-top: 10px; font-weight: bold; font-size: 14px; }
        .progress-log { font-size: 12px; color: #666; margin-top: 5px; max-height: 60px; overflow-y: auto; }
    </style>
</head>
<body>

    <div id="loginScreen" class="login-container">
        <h2>Đăng Nhập</h2>
        <div class="input-group">
            <input type="email" id="email" placeholder="Email của bạn">
        </div>
        <div class="input-group">
            <input type="password" id="password" placeholder="Mật khẩu">
        </div>
        <button class="btn btn-primary" onclick="loginEmail()">Đăng nhập</button>
        <button class="btn btn-primary" style="background:#6c757d" onclick="registerEmail()">Đăng ký</button>
        <hr>
        <button class="btn btn-google" onclick="loginGoogle()"><i class="fab fa-google"></i> Đăng nhập Google</button>
    </div>

    <div id="mainApp" class="hidden">
        <div class="header">
            <div id="userInfo">Đang tải...</div>
            <button class="btn btn-logout" onclick="logout()"><i class="fas fa-sign-out-alt"></i> Đăng xuất</button>
        </div>
        
        <div class="upload-section">
            <div style="display: flex; gap: 10px;">
                <input type="file" id="fileInput" multiple style="flex-grow: 1; border: 1px solid #ddd; padding: 8px; border-radius: 4px;">
                <button class="btn btn-upload" id="uploadBtn" onclick="handleUpload()"><i class="fas fa-cloud-upload-alt"></i> Upload</button>
            </div>
            <p id="uploadStatus"></p>
            <div id="progressLog" class="progress-log"></div>
        </div>

        <h3><i class="fas fa-folder-open"></i> Danh sách File</h3>
        <div id="fileList">Loading...</div>
    </div>

    <script>
        // ===============================================
        // CẤU HÌNH (THAY THÔNG TIN CỦA BẠN VÀO ĐÂY)
        // ===============================================
        const firebaseConfig = {
    apiKey: "AIzaSyBQOcwUdtv1quQ1UWV8oaGY6kIUwITlSos",
    authDomain: "sharengo-hunq.firebaseapp.com",
    projectId: "sharengo-hunq",
    storageBucket: "sharengo-hunq.firebasestorage.app",
    messagingSenderId: "20454542571",
    appId: "1:20454542571:web:8021a519b26f9be30882ae",
    measurementId: "G-T0XNLVWXYV"
};


        const BUCKET_NAME = 'SnG'; 
        // ===============================================

        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();
        let supabase = null;
        let currentUser = null;
        let currentUserRole = 'user';

        // --- AUTHENTICATION ---
        auth.onAuthStateChanged(async (user) => {
            if (user) {
                currentUser = user;
                document.getElementById('loginScreen').classList.add('hidden');
                document.getElementById('mainApp').classList.remove('hidden');
                initSystem(user.uid);
            } else {
                document.getElementById('loginScreen').classList.remove('hidden');
                document.getElementById('mainApp').classList.add('hidden');
            }
        });

        function loginGoogle() { auth.signInWithPopup(new firebase.auth.GoogleAuthProvider()).catch(err => alert(err.message)); }
        function loginEmail() {
            const email = document.getElementById('email').value;
            const pass = document.getElementById('password').value;
            auth.signInWithEmailAndPassword(email, pass).catch(err => alert("Lỗi: " + err.message));
        }
        function registerEmail() {
            const email = document.getElementById('email').value;
            const pass = document.getElementById('password').value;
            auth.createUserWithEmailAndPassword(email, pass)
                .then(() => alert("Đăng ký thành công! Vui lòng nhờ Admin cấp quyền."))
                .catch(err => alert("Lỗi: " + err.message));
        }
        function logout() { auth.signOut().then(() => location.reload()); }

        // --- SYSTEM INIT ---
        async function initSystem(uid) {
            try {
                const userDoc = await db.collection('users').doc(uid).get();
                if (userDoc.exists) {
                    currentUserRole = userDoc.data().role || 'user';
                    document.getElementById('userInfo').innerHTML = `Xin chào, <b>${currentUser.email}</b> <span style="background:#eee; padding:2px 6px; border-radius:4px; font-size:12px">${currentUserRole.toUpperCase()}</span>`;
                } else {
                    alert("Tài khoản này chưa được cấp quyền truy cập!");
                    logout();
                    return;
                }

                const configDoc = await db.collection('config').doc('supabase').get();
                const sbConfig = configDoc.data();
                supabase = window.supabase.createClient(sbConfig.url, sbConfig.key);
                loadFiles();

            } catch (error) {
                console.error(error);
                alert("Lỗi hệ thống: " + error.message);
            }
        }

        // --- MULTI UPLOAD FUNCTION (THAY ĐỔI CHÍNH) ---
        async function handleUpload() {
            const fileInput = document.getElementById('fileInput');
            const files = fileInput.files; // Lấy danh sách file (Array)
            
            if (files.length === 0) return alert("Chưa chọn file!");

            const btn = document.getElementById('uploadBtn');
            const status = document.getElementById('uploadStatus');
            const logDiv = document.getElementById('progressLog');
            
            btn.disabled = true;
            status.innerHTML = `<i class="fas fa-spinner fa-spin"></i> Đang xử lý ${files.length} file...`;
            logDiv.innerHTML = ""; // Xóa log cũ

            let successCount = 0;
            let errorCount = 0;

            // Duyệt qua từng file và upload tuần tự
            for (let i = 0; i < files.length; i++) {
                const file = files[i];
                const fileNameRaw = Date.now() + "_" + file.name;

                try {
                    // Update trạng thái chi tiết
                    logDiv.innerHTML += `<div>⏳ Đang tải: ${file.name}...</div>`;
                    
                    // 1. Upload Supabase
                    const { error } = await supabase.storage.from(BUCKET_NAME).upload(fileNameRaw, file);
                    if (error) throw error;

                    // 2. Lấy URL
                    const { data: publicUrlData } = supabase.storage.from(BUCKET_NAME).getPublicUrl(fileNameRaw);

                    // 3. Lưu Firestore
                    await db.collection('files').add({
                        fileName: fileNameRaw,
                        displayName: file.name,
                        url: publicUrlData.publicUrl,
                        uid: currentUser.uid,
                        uploadedBy: currentUser.email,
                        createdAt: firebase.firestore.FieldValue.serverTimestamp()
                    });

                    successCount++;
                    // Update log thành công (thay thế dòng cuối)
                    logDiv.lastElementChild.innerHTML = `<div style="color:green">✔ Xong: ${file.name}</div>`;

                } catch (err) {
                    errorCount++;
                    console.error(err);
                    logDiv.lastElementChild.innerHTML = `<div style="color:red">✖ Lỗi: ${file.name} - ${err.message}</div>`;
                }
            }

            // Kết thúc
            btn.disabled = false;
            btn.innerHTML = '<i class="fas fa-cloud-upload-alt"></i> Upload';
            status.innerHTML = `Hoàn tất! Thành công: <b>${successCount}</b>, Lỗi: <b style="color:red">${errorCount}</b>`;
            fileInput.value = ""; // Reset input
        }

        // --- CÁC CHỨC NĂNG KHÁC (GIỮ NGUYÊN) ---
        function loadFiles() {
            db.collection('files').orderBy('createdAt', 'desc').onSnapshot((snapshot) => {
                const listDiv = document.getElementById('fileList');
                listDiv.innerHTML = "";
                
                snapshot.forEach(doc => {
                    const data = doc.data();
                    const id = doc.id;
                    const isOwner = data.uid === currentUser.uid;
                    const canEdit = (currentUserRole === 'admin') || isOwner;

                    listDiv.innerHTML += `
                        <div class="file-item">
                            <div class="file-left">
                                <img src="${data.url}" class="file-thumb" onerror="this.src='https://via.placeholder.com/50?text=File'">
                                <div class="file-details">
                                    <h4 id="name-${id}">${data.displayName || data.fileName}</h4>
                                    <span>${data.uploadedBy} • ${new Date(data.createdAt?.toDate()).toLocaleDateString('vi-VN')}</span>
                                </div>
                            </div>
                            
                            <div class="action-buttons">
                                <button class="icon-btn btn-copy" onclick="copyLink('${data.url}')" title="Sao chép Link"><i class="fas fa-link"></i></button>
                                <button class="icon-btn btn-down" onclick="downloadFile('${data.url}', '${data.displayName}')" title="Tải xuống"><i class="fas fa-download"></i></button>
                                ${canEdit ? `
                                <button class="icon-btn btn-edit" onclick="renameFile('${id}', '${data.displayName}')" title="Đổi tên"><i class="fas fa-pen"></i></button>
                                <button class="icon-btn btn-del" onclick="deleteFile('${id}', '${data.fileName}')" title="Xóa"><i class="fas fa-trash"></i></button>
                                ` : ''}
                            </div>
                        </div>
                    `;
                });
            });
        }

        function copyLink(url) { navigator.clipboard.writeText(url).then(() => alert("Đã copy link!")); }
        async function downloadFile(url, filename) {
            try {
                const response = await fetch(url);
                const blob = await response.blob();
                const blobUrl = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = blobUrl; a.download = filename || "download";
                document.body.appendChild(a); a.click(); document.body.removeChild(a);
                window.URL.revokeObjectURL(blobUrl);
            } catch (err) { window.open(url, '_blank'); }
        }
        function renameFile(docId, oldName) {
            const newName = prompt("Nhập tên mới:", oldName);
            if (newName && newName !== oldName) {
                db.collection('files').doc(docId).update({ displayName: newName }).catch(err => alert("Lỗi: " + err.message));
            }
        }
        async function deleteFile(docId, fileName) {
            if (!confirm("Chắc chắn xóa file này?")) return;
            try {
                await db.collection('files').doc(docId).delete();
                await supabase.storage.from(BUCKET_NAME).remove([fileName]);
            } catch (err) { alert("Lỗi xóa: " + err.message); }
        }
    </script>
</body>
</html>