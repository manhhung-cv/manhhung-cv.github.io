<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Love Story - Kỷ niệm tình yêu</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Quicksand:wght@300..700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <style>
        body {
            font-family: 'Quicksand', sans-serif;
            background-color: #fde4e4; /* Soft pink background */
        }
        .tab-content { display: none; }
        .tab-content.active { display: block; }
        .nav-link {
            cursor: pointer;
            transition: all 0.3s ease;
            border-bottom: 2px solid transparent;
        }
        .nav-link.active {
            color: #ec4899; /* Pink-500 */
            border-bottom-color: #ec4899;
        }
        .heart-beat {
            animation: heartBeat 1.5s infinite;
        }
        @keyframes heartBeat {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.15); }
        }
        .modal-backdrop {
            background-color: rgba(0,0,0,0.5);
        }
        
        /* Styling cho Popup Chat */
        #chat-popup {
            transition: transform 0.3s ease-out, opacity 0.3s ease-out;
            transform: scale(0.5) translateY(20px);
            opacity: 0;
            pointer-events: none;
        }
        #chat-popup.active {
            transform: scale(1) translateY(0);
            opacity: 1;
            pointer-events: auto;
        }
        #chat-fab {
            transition: transform 0.3s ease;
        }
        #chat-fab:hover {
            transform: scale(1.1);
        }
        .delete-msg-btn {
            opacity: 0;
            transition: opacity 0.2s;
        }
        .message-container:hover .delete-msg-btn {
            opacity: 1;
        }
        /* Story styles */
        .comment-section, #filter-controls {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.5s ease-in-out;
        }
        .comment-section.active, #filter-controls.active {
            max-height: 1000px; /* Large enough for content */
        }
        .like-btn.liked, .comment-like-btn.liked {
            color: #ec4899;
        }
    </style>
</head>
<body class="text-gray-800">

    <div id="loading-overlay" class="hidden fixed inset-0 bg-white/80 z-50 flex items-center justify-center">
        <div class="text-center">
            <i class="fas fa-heart text-pink-500 text-6xl heart-beat"></i>
            <p id="loading-text" class="mt-4 text-pink-500 font-semibold">Đang xử lý...</p>
        </div>
    </div>

    <!-- Auth Screen -->
    <div id="auth-screen" class="min-h-screen flex items-center justify-center p-4">
        <div class="w-full max-w-md bg-white rounded-2xl shadow-xl p-8">
            <div id="auth-container">
                <!-- Login Form -->
                <div id="login-form">
                    <h2 class="text-3xl font-bold text-center text-pink-500 mb-6">Đăng Nhập</h2>
                    <div id="login-error" class="text-red-500 text-sm mb-4"></div>
                    <input id="login-email" type="email" placeholder="Email" class="w-full px-4 py-3 mb-4 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-pink-400">
                    <input id="login-password" type="password" placeholder="Mật khẩu" class="w-full px-4 py-3 mb-4 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-pink-400">
                    <button id="login-btn" class="w-full bg-pink-500 text-white py-3 rounded-lg font-semibold hover:bg-pink-600 transition">Đăng Nhập</button>
                    <p class="text-center mt-4">Chưa có tài khoản? <a href="#" id="show-register" class="text-pink-500 hover:underline">Đăng ký ngay</a></p>
                </div>
                <!-- Register Form -->
                <div id="register-form" class="hidden">
                    <h2 class="text-3xl font-bold text-center text-pink-500 mb-6">Đăng Ký</h2>
                    <div id="register-error" class="text-red-500 text-sm mb-4"></div>
                    <input id="register-email" type="email" placeholder="Email" class="w-full px-4 py-3 mb-4 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-pink-400">
                    <input id="register-password" type="password" placeholder="Mật khẩu" class="w-full px-4 py-3 mb-4 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-pink-400">
                    <input id="register-invite-code" type="text" placeholder="Mã mời" class="w-full px-4 py-3 mb-4 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-pink-400">
                    <button id="register-btn" class="w-full bg-pink-500 text-white py-3 rounded-lg font-semibold hover:bg-pink-600 transition">Đăng Ký</button>
                    <p class="text-center mt-4">Đã có tài khoản? <a href="#" id="show-login" class="text-pink-500 hover:underline">Đăng nhập</a></p>
                </div>
            </div>
        </div>
    </div>

    <!-- Couple Code Screen -->
    <div id="couple-code-screen" class="hidden min-h-screen flex items-center justify-center p-4">
        <div class="w-full max-w-md bg-white rounded-2xl shadow-xl p-8 text-center">
            <h2 class="text-3xl font-bold text-pink-500 mb-6">Mã Cặp Đôi</h2>
            <p class="mb-6 text-gray-600">Nhập mã để tham gia, hoặc nhập mã riêng của bạn để tạo mới.</p>
            <div id="couple-code-error" class="text-red-500 text-sm mb-4"></div>
            <input id="couple-code-input" type="text" placeholder="Nhập mã cặp đôi..." class="w-full px-4 py-3 mb-4 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-pink-400 text-center">
            <button id="join-couple-btn" class="w-full bg-pink-500 text-white py-3 rounded-lg font-semibold hover:bg-pink-600 transition mb-2">Tham Gia</button>
            <p class="my-4 text-gray-500 text-sm">hoặc</p>
            <button id="create-custom-couple-btn" class="w-full bg-green-500 text-white py-3 rounded-lg font-semibold hover:bg-green-600 transition">Tạo Cặp Đôi với Mã Này</button>
        </div>
    </div>

    <!-- Profile Setup Screen -->
    <div id="profile-setup-screen" class="hidden min-h-screen flex items-center justify-center p-4">
        <div class="w-full max-w-md bg-white rounded-2xl shadow-xl p-8">
            <h2 class="text-3xl font-bold text-center text-pink-500 mb-6">Thiết Lập Thông Tin</h2>
            <div id="profile-setup-error" class="text-red-500 text-sm mb-4"></div>
            <input id="profile-name" type="text" placeholder="Tên của bạn" class="w-full px-4 py-3 mb-4 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-pink-400">
            <input id="profile-dob" type="text" onfocus="(this.type='date')" onblur="(this.type='text')" placeholder="Ngày sinh" class="w-full px-4 py-3 mb-4 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-pink-400">
            <select id="profile-gender" class="w-full px-4 py-3 mb-4 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-pink-400 bg-white">
                <option value="" disabled selected>Chọn giới tính</option>
                <option value="male">Nam</option>
                <option value="female">Nữ</option>
            </select>
            <button id="save-profile-btn" class="w-full bg-pink-500 text-white py-3 rounded-lg font-semibold hover:bg-pink-600 transition">Lưu Thông Tin</button>
        </div>
    </div>

    <!-- Main App -->
    <div id="main-app" class="hidden">
        <header class="bg-white/80 backdrop-blur-sm shadow-md sticky top-0 z-30">
            <div class="container mx-auto px-4 py-2 flex justify-between items-center">
                <h1 class="text-2xl font-bold text-pink-500">Love Story</h1>
                <button id="logout-btn" class="text-gray-500 hover:text-pink-500"><i class="fas fa-sign-out-alt text-xl"></i></button>
            </div>
        </header>

        <main class="container mx-auto p-4">
            <!-- Tab Navigation (Chat tab removed) -->
            <nav class="bg-white rounded-xl shadow-md p-2 mb-6 flex justify-around items-center text-sm md:text-base">
                <a class="nav-link active" data-tab="main"><i class="fas fa-heart mr-1 md:mr-2"></i>Trang Chính</a>
                <a class="nav-link" data-tab="story"><i class="fas fa-book-open mr-1 md:mr-2"></i>Story</a>
                <a class="nav-link" data-tab="events"><i class="fas fa-calendar-alt mr-1 md:mr-2"></i>Sự Kiện</a>
                <a class="nav-link" data-tab="settings"><i class="fas fa-cog mr-1 md:mr-2"></i>Cài Đặt</a>
            </nav>

            <!-- Main Tab -->
            <div id="main-content" class="tab-content active">
                <div class="bg-white rounded-2xl shadow-xl p-6 text-center mb-6">
                    <h2 class="text-2xl font-semibold text-pink-500 mb-2">Chúng ta đã bên nhau</h2>
                    <div id="day-counter" class="text-5xl md:text-7xl font-bold text-gray-800 my-4">...</div>
                    <div id="ymd-counter" class="text-lg text-gray-600">... năm ... tháng ... ngày</div>
                    <div class="mt-4 text-sm text-gray-500">Ngày bắt đầu: <span id="start-date-display">...</span></div>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div id="partner-1-card" class="bg-white rounded-2xl shadow-xl p-6 flex flex-col items-center relative"></div>
                    <div id="partner-2-card" class="bg-white rounded-2xl shadow-xl p-6 flex flex-col items-center relative"></div>
                </div>
            </div>

            <!-- Story Tab -->
            <div id="story-content" class="tab-content">
                <div class="text-right mb-4">
                    <button id="add-story-btn" class="bg-pink-500 text-white px-6 py-2 rounded-lg font-semibold hover:bg-pink-600 transition"><i class="fas fa-plus mr-2"></i>Viết Story Mới</button>
                </div>
                <!-- Filter & Sort Controls -->
                <div class="bg-white rounded-xl shadow-md p-4 mb-6 max-w-2xl mx-auto">
                    <button id="toggle-filters-btn" class="w-full text-left font-semibold text-gray-700 mb-2">
                        <i class="fas fa-filter mr-2"></i> Mở bộ lọc <i class="fas fa-chevron-down float-right transition-transform"></i>
                    </button>
                    <div id="filter-controls" class="">
                        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-2 gap-4 items-end pt-4 border-t">
                            <div>
                                <label for="filter-author" class="text-sm font-medium text-gray-700 block mb-1">Người đăng</label>
                                <select id="filter-author" class="w-full p-2 border border-gray-300 rounded-lg text-sm">
                                    <option value="all">Tất cả</option>
                                    <!-- Options will be added by JS -->
                                </select>
                            </div>
                            <div>
                                <label for="filter-date" class="text-sm font-medium text-gray-700 block mb-1">Ngày đăng</label>
                                <input type="date" id="filter-date" class="w-full p-2 border border-gray-300 rounded-lg text-sm">
                            </div>
                            <div>
                                <label for="filter-location" class="text-sm font-medium text-gray-700 block mb-1">Vị trí</label>
                                <input type="text" id="filter-location" placeholder="Tìm theo vị trí..." class="w-full p-2 border border-gray-300 rounded-lg text-sm">
                            </div>
                            <div>
                                <label for="filter-tag" class="text-sm font-medium text-gray-700 block mb-1">Thẻ (Tag)</label>
                                <input type="text" id="filter-tag" placeholder="vd: #kiniem" class="w-full p-2 border border-gray-300 rounded-lg text-sm">
                            </div>
                            <div class="md:col-span-2 lg:col-span-2">
                                <label for="sort-stories" class="text-sm font-medium text-gray-700 block mb-1">Sắp xếp</label>
                                <select id="sort-stories" class="w-full p-2 border border-gray-300 rounded-lg text-sm">
                                    <option value="desc">Mới nhất</option>
                                    <option value="asc">Cũ nhất</option>
                                </select>
                            </div>
                        </div>
                        <button id="reset-filters-btn" class="mt-4 w-full md:w-auto text-sm text-blue-600 hover:underline">Xóa bộ lọc</button>
                    </div>
                </div>
                <div id="story-feed" class="space-y-6 max-w-2xl mx-auto">
                    <!-- Story posts will be injected here -->
                </div>
            </div>

            <!-- Events Tab -->
            <div id="events-content" class="tab-content">
                 <div class="text-right mb-4">
                    <button id="add-event-btn" class="bg-blue-500 text-white px-6 py-2 rounded-lg font-semibold hover:bg-blue-600 transition"><i class="fas fa-plus mr-2"></i>Thêm Sự Kiện</button>
                </div>
                <div id="event-list" class="space-y-4">
                    <!-- Events will be injected here -->
                </div>
            </div>

            <!-- Settings Tab -->
            <div id="settings-content" class="tab-content">
                <div class="bg-white rounded-2xl shadow-xl p-6 max-w-2xl mx-auto">
                    <h2 class="text-2xl font-bold text-pink-500 mb-6 border-b pb-4">Cài Đặt Chung</h2>
                    <div class="mb-6">
                        <label for="setting-couple-code" class="block font-semibold mb-2">Mã Cặp Đôi của bạn:</label>
                        <div class="flex items-center">
                           <input id="setting-couple-code" type="text" readonly class="w-full px-4 py-2 bg-gray-100 border rounded-lg">
                           <button id="copy-code-btn" class="ml-2 px-4 py-2 bg-gray-200 rounded-lg hover:bg-gray-300"><i class="fas fa-copy"></i></button>
                        </div>
                    </div>
                    <div class="mb-6">
                        <label for="setting-start-date" class="block font-semibold mb-2">Ngày bắt đầu yêu</label>
                        <input id="setting-start-date" type="date" class="w-full px-4 py-2 border rounded-lg">
                    </div>

                    <h3 class="text-xl font-bold text-pink-500 mt-8 mb-4 border-b pb-4">Đổi Mã Cặp Đôi</h3>
                    <div class="mb-6">
                        <label for="setting-new-couple-code" class="block font-semibold mb-2">Mã Cặp Đôi Mới</label>
                        <p class="text-sm text-gray-500 mb-2">Lưu ý: Hành động này sẽ thay đổi mã cho cả hai bạn. Mã cũ sẽ không còn hiệu lực.</p>
                        <div class="flex items-center space-x-2">
                            <input id="setting-new-couple-code" type="text" placeholder="Nhập mã mới" class="w-full px-4 py-2 border rounded-lg">
                            <button id="change-code-btn" class="bg-blue-500 text-white px-6 py-2 rounded-lg font-semibold hover:bg-blue-600 transition flex-shrink-0">Đổi Mã</button>
                        </div>
                        <div id="change-code-error" class="text-red-500 text-sm mt-2"></div>
                    </div>
                    
                    <h3 class="text-xl font-bold text-pink-500 mt-8 mb-4 border-b pb-4">Thông Tin Cá Nhân</h3>
                    <div id="settings-partner-1"></div>
                    <div id="settings-partner-2" class="mt-6"></div>

                    <button id="save-settings-btn" class="w-full mt-8 bg-pink-500 text-white py-3 rounded-lg font-semibold hover:bg-pink-600 transition">Lưu Thay Đổi</button>
                </div>
            </div>
        </main>
    </div>

    <!-- Floating Action Button for Chat -->
    <button id="chat-fab" class="hidden fixed bottom-6 right-6 w-16 h-16 bg-pink-500 rounded-full text-white text-3xl shadow-lg flex items-center justify-center z-40">
        <i class="fas fa-heart"></i>
    </button>

    <!-- Chat Popup -->
    <div id="chat-popup" class="fixed bottom-24 right-6 w-[90vw] max-w-sm h-[60vh] bg-white rounded-2xl shadow-2xl flex flex-col z-40">
        <!-- Chat Header -->
        <div id="chat-header" class="p-4 border-b flex justify-between items-center rounded-t-2xl bg-white transition-colors duration-300">
            <button id="toggle-chat-mode-btn" class="text-sm font-semibold px-3 py-1 rounded-full transition-colors">
                <!-- Text will be set by JS -->
            </button>
            <button id="close-chat-btn" class="text-gray-400 hover:text-gray-700">
                <i class="fas fa-times text-xl"></i>
            </button>
        </div>
        <!-- Messages Area -->
        <div id="chat-messages" class="flex-1 p-4 overflow-y-auto flex flex-col-reverse">
            <!-- Messages will be injected here -->
        </div>
        <!-- Message Input -->
        <div class="p-4 border-t">
            <div class="flex items-center space-x-2">
                <input id="chat-input" type="text" placeholder="Nhập tin nhắn..." class="w-full px-4 py-2 border rounded-full focus:outline-none focus:ring-2 focus:ring-pink-400">
                <button id="chat-send-btn" class="bg-pink-500 text-white rounded-full w-10 h-10 flex-shrink-0 flex items-center justify-center hover:bg-pink-600 transition">
                    <i class="fas fa-paper-plane"></i>
                </button>
            </div>
        </div>
    </div>

    <!-- Modals -->
    <div id="story-modal" class="hidden fixed inset-0 z-40 flex items-center justify-center modal-backdrop p-4">
        <div class="bg-white rounded-2xl shadow-xl p-6 w-full max-w-lg">
            <h2 class="text-2xl font-bold text-pink-500 mb-4">Viết Story Mới</h2>
            <input id="story-title" type="text" placeholder="Tiêu đề" class="w-full px-4 py-2 mb-3 border rounded-lg">
            <textarea id="story-textarea" rows="6" placeholder="Bạn đang nghĩ gì..." class="w-full p-4 border rounded-lg focus:outline-none focus:ring-2 focus:ring-pink-400"></textarea>
            <input id="story-location" type="text" placeholder="Vị trí (ví dụ: Cafe The Lofi)" class="w-full px-4 py-2 mt-3 border rounded-lg">
            <input id="story-tags" type="text" placeholder="Gắn thẻ (ví dụ: #kiniem, #henho)" class="w-full px-4 py-2 mt-3 border rounded-lg">
            <div class="flex justify-end mt-4 space-x-4">
                <button id="cancel-story-btn" class="px-6 py-2 bg-gray-300 rounded-lg hover:bg-gray-400">Hủy</button>
                <button id="post-story-btn" class="px-6 py-2 bg-pink-500 text-white rounded-lg hover:bg-pink-600">Đăng</button>
            </div>
        </div>
    </div>
    <div id="feeling-modal" class="hidden fixed inset-0 z-40 flex items-center justify-center modal-backdrop p-4">
        <div class="bg-white rounded-2xl shadow-xl p-6 w-full max-w-md">
            <h2 class="text-2xl font-bold text-pink-500 mb-4">Cảm nhận của bạn</h2>
            <input id="feeling-input" type="text" placeholder="Hôm nay bạn thấy thế nào?" class="w-full px-4 py-2 border rounded-lg">
            <div class="flex justify-end mt-4 space-x-4">
                <button id="cancel-feeling-btn" class="px-6 py-2 bg-gray-300 rounded-lg hover:bg-gray-400">Hủy</button>
                <button id="save-feeling-btn" class="px-6 py-2 bg-pink-500 text-white rounded-lg hover:bg-pink-600">Lưu</button>
            </div>
        </div>
    </div>
    <div id="event-modal" class="hidden fixed inset-0 z-40 flex items-center justify-center modal-backdrop p-4">
        <div class="bg-white rounded-2xl shadow-xl p-8 w-full max-w-lg">
            <h2 class="text-2xl font-bold text-blue-500 mb-4">Thêm Sự Kiện Mới</h2>
            <input id="event-name" type="text" placeholder="Tên sự kiện" class="w-full px-4 py-2 mb-4 border rounded-lg">
            <input id="event-date" type="date" class="w-full px-4 py-2 mb-4 border rounded-lg">
            <input id="event-image-url" type="text" placeholder="URL hình ảnh (tùy chọn)" class="w-full px-4 py-2 mb-4 border rounded-lg">
            <select id="event-repeat" class="w-full px-4 py-2 mb-4 border rounded-lg bg-white">
                <option value="none">Không lặp lại</option>
                <option value="daily">Mỗi ngày</option>
                <option value="weekly">Mỗi tuần</option>
                <option value="monthly">Mỗi tháng</option>
                <option value="yearly">Mỗi năm</option>
                <option value="interval">Khoảng ngày</option>
            </select>
            <input id="event-interval-days" type="number" placeholder="Lặp lại sau bao nhiêu ngày?" class="hidden w-full px-4 py-2 mb-4 border rounded-lg">
            <div class="flex justify-end mt-4 space-x-4">
                <button id="cancel-event-btn" class="px-6 py-2 bg-gray-300 rounded-lg hover:bg-gray-400">Hủy</button>
                <button id="save-event-btn" class="px-6 py-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600">Lưu</button>
            </div>
        </div>
    </div>
    <div id="confirm-modal" class="hidden fixed inset-0 z-50 flex items-center justify-center modal-backdrop">
        <div class="bg-white rounded-2xl shadow-xl p-8 w-full max-w-sm text-center">
            <p id="confirm-message" class="text-lg mb-6"></p>
            <div class="flex justify-center space-x-4">
                <button id="confirm-cancel-btn" class="px-8 py-2 bg-gray-300 rounded-lg hover:bg-gray-400">Hủy</button>
                <button id="confirm-ok-btn" class="px-8 py-2 bg-red-500 text-white rounded-lg hover:bg-red-600">OK</button>
            </div>
        </div>
    </div>


    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { 
            getAuth, 
            createUserWithEmailAndPassword, 
            signInWithEmailAndPassword, 
            onAuthStateChanged, 
            signOut 
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { 
            getFirestore, 
            doc, 
            getDoc, 
            setDoc, 
            updateDoc, 
            collection, 
            addDoc,
            query, 
            where,
            getDocs,
            onSnapshot,
            orderBy,
            Timestamp,
            writeBatch,
            deleteDoc,
            arrayUnion,
            arrayRemove
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Cấu hình Firebase của bạn
        const firebaseConfig = {
            apiKey: "AIzaSyAr9tTx-Q0OWrJ4Iaslb33-o1PJLe1S3GQ",
            authDomain: "lovstory-b6e07.firebaseapp.com",
            projectId: "lovstory-b6e07",
            storageBucket: "lovstory-b6e07.appspot.com",
            messagingSenderId: "810969018898",
            appId: "1:810969018898:web:c8e525581a77ed7d515ecb",
            measurementId: "G-1RP88QT28C"
        };

        // Khởi tạo Firebase
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // Biến toàn cục
        let currentUser = null;
        let userId = null;
        let coupleCode = null;
        let coupleData = null;
        let allStories = []; // Lưu trữ tất cả story để lọc
        let localLastMessageTimestamp = null;
        let unsubscribeCouple = null;
        let unsubscribeEvents = null;
        let unsubscribeNormalChat = null;
        let unsubscribeSecretChat = null;
        let storyCommentListeners = {};
        let currentChatMode = 'normal';
        let wasInSecretChat = false;

        // DOM Elements
        const loadingOverlay = document.getElementById('loading-overlay');
        const loadingText = document.getElementById('loading-text');
        const authScreen = document.getElementById('auth-screen');
        const coupleCodeScreen = document.getElementById('couple-code-screen');
        const profileSetupScreen = document.getElementById('profile-setup-screen');
        const mainApp = document.getElementById('main-app');
        const chatFab = document.getElementById('chat-fab');
        const chatPopup = document.getElementById('chat-popup');
        const closeChatBtn = document.getElementById('close-chat-btn');
        const chatHeader = document.getElementById('chat-header');
        const chatMessages = document.getElementById('chat-messages');
        const chatInput = document.getElementById('chat-input');
        const toggleChatModeBtn = document.getElementById('toggle-chat-mode-btn');
        const filterAuthor = document.getElementById('filter-author');
        const filterDate = document.getElementById('filter-date');
        const filterLocation = document.getElementById('filter-location');
        const filterTag = document.getElementById('filter-tag');
        const sortStories = document.getElementById('sort-stories');
        const resetFiltersBtn = document.getElementById('reset-filters-btn');
        const toggleFiltersBtn = document.getElementById('toggle-filters-btn');
        const navLinks = document.querySelectorAll('.nav-link');
        const tabContents = document.querySelectorAll('.tab-content');

        // --- HÀM TIỆN ÍCH ---
        const showView = (viewId) => {
            [authScreen, coupleCodeScreen, profileSetupScreen, mainApp].forEach(screen => screen.classList.add('hidden'));
            document.getElementById(viewId).classList.remove('hidden');
            loadingOverlay.classList.add('hidden');
        };
        
        const showConfirm = (message, onOk, onCancel = () => {}) => {
            const confirmModal = document.getElementById('confirm-modal');
            document.getElementById('confirm-message').textContent = message;
            document.getElementById('confirm-cancel-btn').classList.remove('hidden');
            confirmModal.classList.remove('hidden');

            const okBtn = document.getElementById('confirm-ok-btn');
            const cancelBtn = document.getElementById('confirm-cancel-btn');

            const okListener = () => {
                onOk();
                cleanup();
            };
            const cancelListener = () => {
                onCancel();
                cleanup();
            };
            
            function cleanup() {
                confirmModal.classList.add('hidden');
                okBtn.removeEventListener('click', okListener);
                cancelBtn.removeEventListener('click', cancelListener);
            }

            okBtn.addEventListener('click', okListener);
            cancelBtn.addEventListener('click', cancelListener);
        };
        
        const showAlert = (message) => {
             showConfirm(message, () => {});
             document.getElementById('confirm-cancel-btn').classList.add('hidden');
        };


        // --- QUẢN LÝ XÁC THỰC ---
        onAuthStateChanged(auth, async (user) => {
            if (user) {
                currentUser = user;
                userId = user.uid;
                // Dọn dẹp listener cũ
                if (unsubscribeCouple) unsubscribeCouple();
                if (unsubscribeEvents) unsubscribeEvents();
                if (unsubscribeNormalChat) unsubscribeNormalChat();
                if (unsubscribeSecretChat) unsubscribeSecretChat();
                Object.values(storyCommentListeners).forEach(unsub => unsub());
                storyCommentListeners = {};
                allStories = [];

                const userDocRef = doc(db, "users", userId);
                const userDocSnap = await getDoc(userDocRef);

                if (userDocSnap.exists() && userDocSnap.data().coupleCode) {
                    coupleCode = userDocSnap.data().coupleCode;
                    await setupRealtimeListeners();
                    showView('main-app');
                    chatFab.classList.remove('hidden');
                } else {
                    showView('couple-code-screen');
                    chatFab.classList.add('hidden');
                }
            } else {
                currentUser = null;
                userId = null;
                coupleCode = null;
                coupleData = null;
                if (unsubscribeCouple) unsubscribeCouple();
                if (unsubscribeEvents) unsubscribeEvents();
                if (unsubscribeNormalChat) unsubscribeNormalChat();
                if (unsubscribeSecretChat) unsubscribeSecretChat();
                Object.values(storyCommentListeners).forEach(unsub => unsub());
                storyCommentListeners = {};
                allStories = [];
                showView('auth-screen');
                chatFab.classList.add('hidden');
                chatPopup.classList.remove('active');
            }
        });

        // --- XỬ LÝ FORM ĐĂNG NHẬP/ĐĂNG KÝ ---
        document.getElementById('show-register').addEventListener('click', (e) => { e.preventDefault(); document.getElementById('login-form').classList.add('hidden'); document.getElementById('register-form').classList.remove('hidden'); });
        document.getElementById('show-login').addEventListener('click', (e) => { e.preventDefault(); document.getElementById('register-form').classList.add('hidden'); document.getElementById('login-form').classList.remove('hidden'); });
        document.getElementById('register-btn').addEventListener('click', async () => {
            const email = document.getElementById('register-email').value, password = document.getElementById('register-password').value, inviteCode = document.getElementById('register-invite-code').value, errorDiv = document.getElementById('register-error');
            errorDiv.textContent = '';
            if (!email || !password || !inviteCode) { errorDiv.textContent = 'Vui lòng nhập đầy đủ thông tin.'; return; }
            try {
                const inviteCodeRef = doc(db, "invitationCodes", inviteCode);
                const inviteCodeSnap = await getDoc(inviteCodeRef);
                if (!inviteCodeSnap.exists() || inviteCodeSnap.data().used) { errorDiv.textContent = 'Mã mời không hợp lệ hoặc đã được sử dụng.'; return; }
                await createUserWithEmailAndPassword(auth, email, password);
            } catch (error) { console.error("Lỗi đăng ký:", error); errorDiv.textContent = "Đã xảy ra lỗi. Vui lòng thử lại. " + error.message; }
        });
        document.getElementById('login-btn').addEventListener('click', async () => {
            const email = document.getElementById('login-email').value, password = document.getElementById('login-password').value, errorDiv = document.getElementById('login-error');
            errorDiv.textContent = '';
            if (!email || !password) { errorDiv.textContent = 'Vui lòng nhập email và mật khẩu.'; return; }
            try { await signInWithEmailAndPassword(auth, email, password); } catch (error) { console.error("Lỗi đăng nhập:", error); errorDiv.textContent = "Email hoặc mật khẩu không đúng."; }
        });
        document.getElementById('logout-btn').addEventListener('click', async () => { 
            if(wasInSecretChat) {
                showConfirm("Bạn có muốn xóa cuộc trò chuyện bí mật trước khi đăng xuất?", async () => {
                    await clearSecretChat();
                    await signOut(auth);
                });
            } else {
                await signOut(auth); 
            }
        });

        // --- XỬ LÝ CẶP ĐÔI & PROFILE ---
        document.getElementById('join-couple-btn').addEventListener('click', async () => {
            const code = document.getElementById('couple-code-input').value.trim(), errorDiv = document.getElementById('couple-code-error'); errorDiv.textContent = '';
            if (!code) { errorDiv.textContent = 'Vui lòng nhập mã.'; return; }
            const coupleDocRef = doc(db, "couples", code);
            const coupleDocSnap = await getDoc(coupleDocRef);
            if (!coupleDocSnap.exists()) { errorDiv.textContent = 'Mã cặp đôi không tồn tại.'; return; }
            const data = coupleDocSnap.data();
            if (data.partner1 && data.partner2) { errorDiv.textContent = 'Cặp đôi này đã đủ thành viên.'; return; }
            coupleCode = code; await prepareProfileSetup(data); showView('profile-setup-screen');
        });
        
        document.getElementById('create-custom-couple-btn').addEventListener('click', async () => {
            const code = document.getElementById('couple-code-input').value.trim();
            const errorDiv = document.getElementById('couple-code-error');
            errorDiv.textContent = '';

            if (!code) {
                errorDiv.textContent = 'Vui lòng nhập một mã để tạo.';
                return;
            }

            const coupleDocRef = doc(db, "couples", code);
            const coupleDocSnap = await getDoc(coupleDocRef);

            if (coupleDocSnap.exists()) {
                errorDiv.textContent = 'Mã này đã tồn tại. Vui lòng chọn mã khác hoặc nhấn "Tham Gia".';
                return;
            }
            
            coupleCode = code;
            await setDoc(doc(db, "couples", coupleCode), {
                createdAt: Timestamp.now(),
                startDate: null,
                partner1: null,
                partner2: null
            });

            await prepareProfileSetup({});
            showView('profile-setup-screen');
        });

        const prepareProfileSetup = async (coupleData) => {
            const genderSelect = document.getElementById('profile-gender'); genderSelect.disabled = false; genderSelect.value = '';
            if (coupleData.partner1) { const existingGender = coupleData.partner1.gender; const otherGender = existingGender === 'male' ? 'female' : 'male'; genderSelect.value = otherGender; genderSelect.disabled = true; }
        };

        document.getElementById('save-profile-btn').addEventListener('click', async () => {
            const name = document.getElementById('profile-name').value, dob = document.getElementById('profile-dob').value, gender = document.getElementById('profile-gender').value, errorDiv = document.getElementById('profile-setup-error'); errorDiv.textContent = '';
            if (!name || !dob || !gender) { errorDiv.textContent = 'Vui lòng điền đầy đủ thông tin.'; return; }
            const coupleDocRef = doc(db, "couples", coupleCode); const coupleDocSnap = await getDoc(coupleDocRef); const data = coupleDocSnap.data();
            const newPartnerInfo = { userId: userId, name: name, dob: dob, gender: gender, photoURL: `https://placehold.co/150x150/fbcfe8/ec4899?text=${name.charAt(0)}`, feeling: "" };
            let updateData = {}; if (!data.partner1) { updateData.partner1 = newPartnerInfo; } else { updateData.partner2 = newPartnerInfo; }
            try { await updateDoc(coupleDocRef, updateData); await setDoc(doc(db, "users", userId), { coupleCode: coupleCode }); window.location.reload(); } catch (error) { console.error("Lỗi lưu profile:", error); errorDiv.textContent = "Đã có lỗi xảy ra."; }
        });


        // --- REALTIME LISTENERS ---
        async function setupRealtimeListeners() {
            const coupleDocRef = doc(db, "couples", coupleCode);
            unsubscribeCouple = onSnapshot(coupleDocRef, (docSnap) => {
                if (docSnap.exists()) {
                    const oldData = coupleData;
                    coupleData = docSnap.data();
                    
                    if (oldData && coupleData.lastMessage && coupleData.lastMessage.senderId !== userId) {
                        const newTimestamp = coupleData.lastMessage.timestamp;
                        if (!localLastMessageTimestamp || newTimestamp.toMillis() > localLastMessageTimestamp.toMillis()) {
                            if (!chatPopup.classList.contains('active')) {
                                chatPopup.classList.add('active');
                            }
                        }
                    }
                    localLastMessageTimestamp = coupleData.lastMessage?.timestamp;

                    renderMainPage();
                    renderSettings();
                } else {
                    signOut(auth);
                }
            });

            const storiesColRef = collection(db, "couples", coupleCode, "stories");
            onSnapshot(storiesColRef, (snapshot) => {
                allStories = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                updateStoryDisplay();
            });
            
            const eventsColRef = collection(db, "couples", coupleCode, "events");
            const eventsQuery = query(eventsColRef, orderBy("date", "asc"));
            unsubscribeEvents = onSnapshot(eventsQuery, (snapshot) => {
                renderEvents(snapshot.docs);
            });

            setupChatListeners();
        }

        // --- RENDER FUNCTIONS ---
        function renderMainPage() {
            if (!coupleData) return;
            const startDateDisplay = document.getElementById('start-date-display');
            if (coupleData.startDate) {
                const start = coupleData.startDate.toDate(); startDateDisplay.textContent = start.toLocaleDateString('vi-VN');
                const now = new Date(); const diffTime = Math.abs(now - start); const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
                let years = now.getFullYear() - start.getFullYear(); let months = now.getMonth() - start.getMonth(); let days = now.getDate() - start.getDate();
                if (days < 0) { months--; days += new Date(now.getFullYear(), now.getMonth(), 0).getDate(); }
                if (months < 0) { years--; months += 12; }
                document.getElementById('day-counter').textContent = diffDays; document.getElementById('ymd-counter').textContent = `${years} năm ${months} tháng ${days} ngày`;
            } else {
                startDateDisplay.textContent = 'Chưa thiết lập'; document.getElementById('day-counter').textContent = '♡'; document.getElementById('ymd-counter').textContent = 'Hãy vào Cài đặt để chọn ngày bắt đầu nhé!';
            }
            renderPartnerCard('partner-1-card', coupleData.partner1);
            renderPartnerCard('partner-2-card', coupleData.partner2);
        }

        function renderPartnerCard(elementId, partner) {
            const card = document.getElementById(elementId);
            if (!partner) { card.innerHTML = `<p class="text-gray-500">Đang chờ nửa kia...</p>`; return; }
            const dob = new Date(partner.dob);
            const isCurrentUser = partner.userId === userId;
            card.innerHTML = `
                ${partner.feeling ? `<div class="mb-3 bg-pink-100 text-pink-700 px-3 py-1 rounded-full text-sm italic">"${partner.feeling}"</div>` : ''}
                <img src="${partner.photoURL}" alt="${partner.name}" class="w-32 h-32 rounded-full object-cover mb-4 border-4 border-pink-300">
                <h3 class="text-2xl font-bold">${partner.name}</h3>
                <p class="text-gray-600"><i class="fas fa-birthday-cake mr-2"></i>${dob.toLocaleDateString('vi-VN')}</p>
                <div class="mt-2 text-2xl">${partner.gender === 'male' ? '<i class="fas fa-mars text-blue-500"></i>' : '<i class="fas fa-venus text-pink-500"></i>'}</div>
                ${isCurrentUser ? `<button data-partner-id="${partner.userId}" class="edit-feeling-btn absolute top-4 right-4 text-gray-400 hover:text-pink-500"><i class="fas fa-pencil-alt"></i></button>` : ''}
            `;
        }
        
        function renderEvents(docs) {
            const list = document.getElementById('event-list');
             if (docs.length === 0) {
                list.innerHTML = `<div class="text-center text-gray-500 p-8 bg-white rounded-xl">Chưa có sự kiện nào được thêm.</div>`;
                return;
            }
            list.innerHTML = docs.map(doc => {
                const event = doc.data();
                const eventDate = event.date.toDate();
                const now = new Date();
                now.setHours(0,0,0,0);
                
                let nextDate = new Date(eventDate);
                nextDate.setHours(0,0,0,0);

                if (nextDate < now) {
                    switch(event.repeat) {
                        case 'daily': nextDate = now; break;
                        case 'weekly': while(nextDate < now) nextDate.setDate(nextDate.getDate() + 7); break;
                        case 'monthly': while(nextDate < now) nextDate.setMonth(nextDate.getMonth() + 1); break;
                        case 'yearly': while(nextDate < now) nextDate.setFullYear(nextDate.getFullYear() + 1); break;
                        case 'interval': while(nextDate < now) nextDate.setDate(nextDate.getDate() + event.intervalDays); break;
                    }
                }
                
                const diffTime = nextDate - now;
                const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));

                return `
                    <div class="bg-white rounded-xl shadow-lg p-4 flex items-center space-x-4">
                        <img src="${event.imageUrl || 'https://placehold.co/100x100/a5b4fc/4338ca?text=Event'}" class="w-20 h-20 rounded-lg object-cover">
                        <div class="flex-grow">
                            <h4 class="font-bold text-lg text-blue-600">${event.name}</h4>
                            <p class="text-sm text-gray-500">${nextDate.toLocaleDateString('vi-VN')}</p>
                            <p class="text-sm text-gray-500"><i class="far fa-clock mr-1"></i> Lặp lại: ${getRepeatText(event.repeat, event.intervalDays)}</p>
                        </div>
                        <div class="text-center">
                            <div class="text-3xl font-bold text-blue-500">${diffDays > 0 ? diffDays : 'Hôm nay'}</div>
                            <div class="text-sm text-gray-600">${diffDays > 0 ? 'ngày nữa' : ''}</div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        function getRepeatText(repeatType, interval) {
            const map = {'none': 'Không', 'daily': 'Hàng ngày', 'weekly': 'Hàng tuần', 'monthly': 'Hàng tháng', 'yearly': 'Hàng năm'};
            return repeatType === 'interval' ? `Sau ${interval} ngày` : map[repeatType] || 'Không rõ';
        }

        function renderSettings() {
            if (!coupleData) return;
            document.getElementById('setting-couple-code').value = coupleCode;
            document.getElementById('setting-start-date').value = coupleData.startDate ? coupleData.startDate.toDate().toISOString().split('T')[0] : '';
            
            renderPartnerSettings('settings-partner-1', coupleData.partner1);
            renderPartnerSettings('settings-partner-2', coupleData.partner2);
        }

        function renderPartnerSettings(elementId, partner) {
            const container = document.getElementById(elementId);
            if (!partner) {
                container.innerHTML = `<p class="text-gray-500">Thông tin nửa kia chưa có.</p>`;
                return;
            }
            container.innerHTML = `
                <h4 class="font-semibold text-lg mb-2">${partner.name} (${partner.gender === 'male' ? 'Nam' : 'Nữ'})</h4>
                <div class="space-y-3">
                    <div>
                        <label class="text-sm font-medium">Tên</label>
                        <input type="text" data-partner-id="${partner.userId}" data-field="name" value="${partner.name}" class="w-full px-4 py-2 border rounded-lg">
                    </div>
                    <div>
                        <label class="text-sm font-medium">Ngày sinh</label>
                        <input type="date" data-partner-id="${partner.userId}" data-field="dob" value="${partner.dob}" class="w-full px-4 py-2 border rounded-lg">
                    </div>
                     <div>
                        <label class="text-sm font-medium">URL Ảnh đại diện</label>
                        <input type="text" data-partner-id="${partner.userId}" data-field="photoURL" value="${partner.photoURL}" class="w-full px-4 py-2 border rounded-lg">
                    </div>
                </div>
            `;
        }

        // --- STORY FILTER & SORT ---
        toggleFiltersBtn.addEventListener('click', () => {
            const filterControls = document.getElementById('filter-controls');
            filterControls.classList.toggle('active');
            toggleFiltersBtn.querySelector('.fa-chevron-down').classList.toggle('rotate-180');
        });

        function updateStoryDisplay() {
            if (!coupleData) return;

            if (filterAuthor.options.length <= 1) {
                filterAuthor.innerHTML = '<option value="all">Tất cả</option>'; // Reset before adding
                if (coupleData.partner1) filterAuthor.innerHTML += `<option value="${coupleData.partner1.userId}">${coupleData.partner1.name}</option>`;
                if (coupleData.partner2) filterAuthor.innerHTML += `<option value="${coupleData.partner2.userId}">${coupleData.partner2.name}</option>`;
            }

            let storiesToDisplay = [...allStories];

            const authorId = filterAuthor.value;
            if (authorId !== 'all') {
                storiesToDisplay = storiesToDisplay.filter(story => story.authorId === authorId);
            }

            const dateStr = filterDate.value;
            if (dateStr) {
                const selectedDate = new Date(dateStr);
                const startOfDay = new Date(selectedDate).setHours(0, 0, 0, 0);
                const endOfDay = new Date(selectedDate).setHours(23, 59, 59, 999);
                storiesToDisplay = storiesToDisplay.filter(story => {
                    const storyDate = story.timestamp.toDate().getTime();
                    return storyDate >= startOfDay && storyDate <= endOfDay;
                });
            }
            
            const location = filterLocation.value.trim().toLowerCase();
            if (location) {
                storiesToDisplay = storiesToDisplay.filter(story => 
                    story.location && story.location.toLowerCase().includes(location)
                );
            }

            const tag = filterTag.value.trim().toLowerCase();
            if (tag) {
                storiesToDisplay = storiesToDisplay.filter(story => 
                    story.tags && story.tags.toLowerCase().includes(tag)
                );
            }

            const sortOrder = sortStories.value;
            storiesToDisplay.sort((a, b) => {
                const timeA = a.timestamp.toDate().getTime();
                const timeB = b.timestamp.toDate().getTime();
                return sortOrder === 'asc' ? timeA - timeB : timeB - timeA;
            });

            renderStories(storiesToDisplay);
        }
        
        [filterAuthor, filterDate, sortStories, filterLocation, filterTag].forEach(el => el.addEventListener('input', updateStoryDisplay));
        resetFiltersBtn.addEventListener('click', () => {
            filterAuthor.value = 'all';
            filterDate.value = '';
            filterLocation.value = '';
            filterTag.value = '';
            sortStories.value = 'desc';
            updateStoryDisplay();
        });

        function renderStories(stories) {
            const feed = document.getElementById('story-feed');
            if (stories.length === 0) {
                feed.innerHTML = `<div class="text-center text-gray-500 p-8 bg-white rounded-xl">Không tìm thấy story nào phù hợp.</div>`;
                return;
            }
            const currentUserPartnerData = coupleData.partner1?.userId === userId ? coupleData.partner1 : coupleData.partner2;
            const currentUserPhoto = currentUserPartnerData?.photoURL || 'https://placehold.co/150x150/fbcfe8/ec4899?text=?';

            feed.innerHTML = stories.map(story => {
                const date = story.timestamp.toDate();
                const partner = story.authorId === coupleData.partner1?.userId ? coupleData.partner1 : coupleData.partner2;
                const tagsHTML = story.tags ? story.tags.split(',').map(tag => `<span class="bg-gray-200 text-gray-700 px-2 py-1 rounded-full text-xs">${tag.trim()}</span>`).join(' ') : '';
                const isLiked = story.likes?.includes(userId);
                
                const likerNames = (story.likes || []).map(uid => {
                    if (coupleData.partner1?.userId === uid) return coupleData.partner1.name;
                    if (coupleData.partner2?.userId === uid) return coupleData.partner2.name;
                    return 'Một người';
                }).join(', ');

                return `
                    <div class="bg-white rounded-xl shadow-lg overflow-hidden" id="story-${story.id}">
                        <div class="p-5">
                            <div class="flex items-center mb-3">
                                <img src="${partner?.photoURL || 'https://placehold.co/150x150/fbcfe8/ec4899?text=?'}" class="w-12 h-12 rounded-full mr-4 object-cover">
                                <div>
                                    <p class="font-bold text-pink-500">${story.authorName}</p>
                                    <p class="text-xs text-gray-400">${date.toLocaleString('vi-VN')}</p>
                                </div>
                            </div>
                            <h3 class="font-bold text-xl mb-2 text-gray-800">${story.title || ''}</h3>
                            <p class="text-gray-700 whitespace-pre-wrap mb-4">${story.content}</p>
                            <div class="flex justify-between items-center text-sm text-gray-500">
                                <div>
                                    ${story.location ? `<i class="fas fa-map-marker-alt mr-1"></i> ${story.location}` : ''}
                                </div>
                                <div class="flex flex-wrap gap-2">
                                    ${tagsHTML}
                                </div>
                            </div>
                        </div>
                        <div class="bg-gray-50 px-5 py-3 border-t">
                            <div class="flex items-center space-x-6 text-gray-600 mb-2">
                                <button class="like-btn ${isLiked ? 'liked' : ''} text-lg" data-story-id="${story.id}">
                                    <i class="fas fa-heart"></i>
                                </button>
                                <button class="comment-toggle-btn text-lg" data-story-id="${story.id}">
                                    <i class="fas fa-comment-alt"></i> <span class="comment-count text-sm font-semibold">0</span>
                                </button>
                            </div>
                            <div class="text-sm text-gray-600 like-display">
                                <span class="font-semibold like-count">${story.likes?.length || 0}</span> lượt thích
                                <span class="liker-names-display text-gray-500 ml-1">${likerNames ? `bởi ${likerNames}` : ''}</span>
                            </div>
                            <div class="comment-input-area-toplevel mt-3">
                                <div class="flex items-center space-x-2">
                                    <img src="${currentUserPhoto}" class="w-8 h-8 rounded-full object-cover">
                                    <input type="text" placeholder="Viết bình luận..." class="w-full p-2 border rounded-full text-sm comment-input-toplevel" data-story-id="${story.id}">
                                </div>
                            </div>
                            <div class="comment-section bg-gray-100 mt-3 -mx-5 px-5 py-4" id="comments-${story.id}">
                                <!-- Comments will be rendered here -->
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
            
            attachStoryInteractionListeners();
        }
        
        function attachStoryInteractionListeners() {
            document.querySelectorAll('.like-btn').forEach(btn => {
                btn.onclick = () => toggleLike(btn.dataset.storyId);
            });
            document.querySelectorAll('.comment-toggle-btn').forEach(btn => {
                btn.onclick = () => toggleCommentSection(btn.dataset.storyId);
            });
            document.querySelectorAll('.comment-input-toplevel').forEach(input => {
                input.onkeypress = (e) => {
                    if (e.key === 'Enter') {
                        postComment(input.dataset.storyId, null, input);
                    }
                }
            });
        }
        
        async function toggleLike(storyId) {
            const storyRef = doc(db, "couples", coupleCode, "stories", storyId);
            const storyDoc = await getDoc(storyRef);
            const likes = storyDoc.data().likes || [];
            
            if (likes.includes(userId)) {
                await updateDoc(storyRef, { likes: arrayRemove(userId) });
            } else {
                await updateDoc(storyRef, { likes: arrayUnion(userId) });
            }
        }

        function toggleCommentSection(storyId) {
            const commentSection = document.getElementById(`comments-${storyId}`);
            if (commentSection) {
                const isActive = commentSection.classList.toggle('active');
                if (isActive && !commentSection.querySelector('.comment-list')) { // Load comments only on first open
                    renderComments(storyId);
                }
            }
        }

        function renderComments(storyId) {
            const container = document.getElementById(`comments-${storyId}`);
            if (!container) return;

            if (storyCommentListeners[storyId]) {
                storyCommentListeners[storyId]();
            }

            container.innerHTML = `<div class="comment-list" id="comment-list-${storyId}"></div>`;
            
            const commentList = document.getElementById(`comment-list-${storyId}`);

            const q = query(collection(db, "couples", coupleCode, "stories", storyId, "comments"), orderBy("timestamp", "asc"));
            storyCommentListeners[storyId] = onSnapshot(q, (snapshot) => {
                const allComments = snapshot.docs.map(d => ({ id: d.id, ...d.data() }));
                
                const commentCountSpan = document.querySelector(`#story-${storyId} .comment-count`);
                if(commentCountSpan) commentCountSpan.textContent = allComments.length;

                const topLevelComments = allComments.filter(c => !c.parentId);
                commentList.innerHTML = topLevelComments.map(comment => {
                    const replies = allComments.filter(r => r.parentId === comment.id);
                    return getCommentHTML(comment, replies);
                }).join('');
                
                attachCommentActionListeners(storyId);
            });
        }
        
        function attachCommentActionListeners(storyId) {
            const container = document.getElementById(`comments-${storyId}`);
            if (!container) return;

            container.querySelectorAll('.reply-btn').forEach(btn => {
                btn.onclick = () => showReplyInput(btn.dataset.commentId, storyId);
            });
            container.querySelectorAll('.comment-like-btn').forEach(btn => {
                btn.onclick = () => handleLikeComment(storyId, btn.dataset.commentId);
            });
            container.querySelectorAll('.edit-comment-btn').forEach(btn => {
                btn.onclick = () => handleEditComment(btn.dataset.commentId);
            });
            container.querySelectorAll('.delete-comment-btn').forEach(btn => {
                btn.onclick = () => handleDeleteComment(storyId, btn.dataset.commentId);
            });
        }

        function getCommentHTML(comment, replies = []) {
             const partner = comment.authorId === coupleData.partner1?.userId ? coupleData.partner1 : coupleData.partner2;
             const repliesHTML = replies.map(reply => getCommentHTML(reply)).join('');
             const isMyComment = comment.authorId === userId;
             const isLiked = comment.likes?.includes(userId);

             return `
                <div class="comment-item mt-3" id="comment-item-${comment.id}">
                    <div class="flex items-start space-x-2">
                        <img src="${partner?.photoURL || ''}" class="w-8 h-8 rounded-full object-cover">
                        <div class="bg-white p-2 rounded-lg flex-1">
                            <p class="font-semibold text-sm">${comment.authorName}</p>
                            <p class="text-sm comment-content">${comment.content}</p>
                            <div class="edit-comment-area hidden">
                                <input type="text" value="${comment.content}" class="w-full p-1 border rounded text-sm">
                                <button class="save-edit-btn text-xs text-blue-600">Lưu</button>
                                <button class="cancel-edit-btn text-xs text-gray-500">Hủy</button>
                            </div>
                        </div>
                    </div>
                    <div class="ml-10 text-xs mt-1 flex items-center space-x-3">
                        <button class="comment-like-btn ${isLiked ? 'liked' : ''}" data-comment-id="${comment.id}">
                            <i class="fas fa-heart fa-xs"></i> <span>${comment.likes?.length || 0}</span>
                        </button>
                        <button class="reply-btn font-semibold text-gray-600" data-comment-id="${comment.id}">Trả lời</button>
                        ${isMyComment ? `<button class="edit-comment-btn font-semibold text-gray-600" data-comment-id="${comment.id}">Sửa</button>` : ''}
                        ${isMyComment ? `<button class="delete-comment-btn font-semibold text-red-500" data-comment-id="${comment.id}">Xóa</button>` : ''}
                    </div>
                    <div class="replies ml-10 mt-2 border-l-2 pl-3" id="replies-for-${comment.id}">${repliesHTML}</div>
                    <div class="reply-input-container ml-10 mt-2" id="reply-input-for-${comment.id}"></div>
                </div>
             `;
        }
        
        async function handleLikeComment(storyId, commentId) {
            const commentRef = doc(db, "couples", coupleCode, "stories", storyId, "comments", commentId);
            const commentDoc = await getDoc(commentRef);
            const likes = commentDoc.data().likes || [];
            
            if (likes.includes(userId)) {
                await updateDoc(commentRef, { likes: arrayRemove(userId) });
            } else {
                await updateDoc(commentRef, { likes: arrayUnion(userId) });
            }
        }

        function handleEditComment(commentId) {
            const item = document.getElementById(`comment-item-${commentId}`);
            const contentP = item.querySelector('.comment-content');
            const editArea = item.querySelector('.edit-comment-area');
            const input = editArea.querySelector('input');

            contentP.classList.add('hidden');
            editArea.classList.remove('hidden');
            input.focus();

            item.querySelector('.save-edit-btn').onclick = async () => {
                const newContent = input.value.trim();
                if (newContent) {
                    const storyId = item.closest('.bg-white').id.split('-')[1];
                    const commentRef = doc(db, "couples", coupleCode, "stories", storyId, "comments", commentId);
                    await updateDoc(commentRef, { content: newContent });
                }
                // UI will update automatically via onSnapshot
            };
            item.querySelector('.cancel-edit-btn').onclick = () => {
                editArea.classList.add('hidden');
                contentP.classList.remove('hidden');
            };
        }

        async function handleDeleteComment(storyId, commentId) {
            showConfirm("Bạn có chắc muốn xóa bình luận này?", async () => {
                const commentRef = doc(db, "couples", coupleCode, "stories", storyId, "comments", commentId);
                await deleteDoc(commentRef);
            });
        }


        function showReplyInput(commentId, storyId) {
            const container = document.getElementById(`reply-input-for-${commentId}`);
            if (container.innerHTML) { // Hide if already shown
                container.innerHTML = '';
                return;
            }
            container.innerHTML = `
                <input type="text" placeholder="Trả lời..." class="w-full p-2 border rounded-lg text-sm" id="reply-text-${commentId}">
                <button class="post-reply-btn mt-2 bg-blue-500 text-white px-4 py-1 text-sm rounded-lg" data-story-id="${storyId}" data-parent-id="${commentId}">Gửi</button>
            `;
            container.querySelector('.post-reply-btn').onclick = (e) => {
                const btn = e.target;
                postComment(btn.dataset.storyId, btn.dataset.parentId);
            };
        }

        async function postComment(storyId, parentId = null, inputElement = null) {
            let input;
            if (inputElement) {
                input = inputElement;
            } else {
                const inputId = `reply-text-${parentId}`;
                input = document.getElementById(inputId);
            }

            const content = input.value.trim();
            if (!content) return;

            const partner = coupleData.partner1.userId === userId ? coupleData.partner1 : coupleData.partner2;
            const commentData = {
                content,
                authorId: userId,
                authorName: partner.name,
                timestamp: Timestamp.now(),
                likes: []
            };
            if (parentId) {
                commentData.parentId = parentId;
            }

            await addDoc(collection(db, "couples", coupleCode, "stories", storyId, "comments"), commentData);
            input.value = '';
            if(parentId) document.getElementById(`reply-input-for-${parentId}`).innerHTML = '';
        }


        // --- CHAT POPUP LOGIC ---
        function setupChatListeners() {
            if (unsubscribeNormalChat) unsubscribeNormalChat();
            if (unsubscribeSecretChat) unsubscribeSecretChat();

            const normalChatRef = collection(db, "couples", coupleCode, "chat_normal");
            const normalQuery = query(normalChatRef, orderBy("timestamp", "desc"));
            unsubscribeNormalChat = onSnapshot(normalQuery, (snapshot) => {
                if (currentChatMode === 'normal') renderChatMessages(snapshot.docs.map(d => ({id: d.id, ...d.data()})));
            });

            const secretChatRef = collection(db, "couples", coupleCode, "chat_secret");
            const secretQuery = query(secretChatRef, orderBy("timestamp", "desc"));
            unsubscribeSecretChat = onSnapshot(secretQuery, (snapshot) => {
                if (currentChatMode === 'secret') renderChatMessages(snapshot.docs.map(d => ({id: d.id, ...d.data()})));
            });
        }

        function renderChatMessages(docs) {
            if (!coupleData) return;
            chatMessages.innerHTML = docs.map(msg => {
                const isMe = msg.authorId === userId;
                return `
                    <div class="flex items-end gap-2 ${isMe ? 'justify-end' : 'justify-start'} mb-3 message-container">
                        ${isMe && currentChatMode === 'normal' ? `<button class="delete-msg-btn text-gray-400 hover:text-red-500 mb-1" data-message-id="${msg.id}"><i class="fas fa-trash-alt fa-xs"></i></button>` : ''}
                        <div class="max-w-xs md:max-w-md">
                            <div class="${isMe ? 'bg-pink-500 text-white' : 'bg-gray-200 text-gray-800'} rounded-2xl px-4 py-2">
                                ${msg.content}
                            </div>
                            <div class="text-xs text-gray-400 mt-1 px-2 ${isMe ? 'text-right' : 'text-left'}">
                                ${msg.timestamp.toDate().toLocaleTimeString('vi-VN', {hour: '2-digit', minute:'2-digit'})}
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        }
        
        async function handleChatCommand(command) {
            if (command === '@del-me') {
                showConfirm("Bạn có chắc muốn xóa tất cả tin nhắn của mình không?", async () => {
                    const q = query(collection(db, "couples", coupleCode, "chat_normal"), where("authorId", "==", userId));
                    const snapshot = await getDocs(q);
                    const batch = writeBatch(db);
                    snapshot.forEach(doc => batch.delete(doc.ref));
                    await batch.commit();
                    showAlert("Đã xóa tất cả tin nhắn của bạn.");
                });
                return true;
            }
            if (command === '@del-all') {
                showConfirm("Bạn có chắc muốn xóa TOÀN BỘ cuộc trò chuyện không? Hành động này không thể hoàn tác.", async () => {
                    const q = query(collection(db, "couples", coupleCode, "chat_normal"));
                    const snapshot = await getDocs(q);
                    const batch = writeBatch(db);
                    snapshot.forEach(doc => batch.delete(doc.ref));
                    await batch.commit();
                    showAlert("Đã xóa toàn bộ cuộc trò chuyện.");
                });
                return true;
            }
            return false;
        }

        async function sendMessage() {
            const content = chatInput.value.trim();
            if (!content) return;

            if (currentChatMode === 'normal' && await handleChatCommand(content)) {
                chatInput.value = '';
                return;
            }

            const collectionName = currentChatMode === 'normal' ? 'chat_normal' : 'chat_secret';
            try {
                await addDoc(collection(db, "couples", coupleCode, collectionName), {
                    content: content,
                    authorId: userId,
                    timestamp: Timestamp.now()
                });
                await updateDoc(doc(db, "couples", coupleCode), {
                    lastMessage: {
                        senderId: userId,
                        timestamp: Timestamp.now()
                    }
                });
                chatInput.value = '';
            } catch (error) {
                console.error("Lỗi gửi tin nhắn:", error);
                showAlert("Không thể gửi tin nhắn.");
            }
        }

        async function clearSecretChat() {
            const secretChatRef = collection(db, "couples", coupleCode, "chat_secret");
            const q = query(secretChatRef);
            const querySnapshot = await getDocs(q);
            if(querySnapshot.empty) return;

            const batch = writeBatch(db);
            querySnapshot.forEach((doc) => {
                batch.delete(doc.ref);
            });
            await batch.commit();
            wasInSecretChat = false;
        }

        chatFab.addEventListener('click', () => {
            chatPopup.classList.toggle('active');
        });

        closeChatBtn.addEventListener('click', () => {
            chatPopup.classList.remove('active');
            if (wasInSecretChat) {
                showConfirm("Bạn có muốn xóa cuộc trò chuyện bí mật không?", async () => {
                    await clearSecretChat();
                });
            }
        });

        function updateChatModeVisuals(isSecret) {
            chatHeader.classList.toggle('bg-red-200', isSecret);
            toggleChatModeBtn.classList.toggle('bg-red-500', isSecret);
            toggleChatModeBtn.classList.toggle('text-white', isSecret);
            toggleChatModeBtn.classList.toggle('bg-blue-500', !isSecret);
            toggleChatModeBtn.classList.toggle('text-white', !isSecret);
            toggleChatModeBtn.innerHTML = isSecret ? '<i class="fas fa-user-secret mr-2"></i>Bí mật' : '<i class="fas fa-comments mr-2"></i>Bình thường';
        }

        async function setChatMode(isSecret) {
            currentChatMode = isSecret ? 'secret' : 'normal';
            wasInSecretChat = isSecret;
            updateChatModeVisuals(isSecret);

            const collectionName = currentChatMode === 'normal' ? 'chat_normal' : 'chat_secret';
            const ref = collection(db, "couples", coupleCode, collectionName);
            const q = query(ref, orderBy("timestamp", "desc"));
            const snapshot = await getDocs(q);
            renderChatMessages(snapshot.docs.map(d => ({id: d.id, ...d.data()})));
        }
        
        // Initialize chat mode button
        updateChatModeVisuals(false);

        toggleChatModeBtn.addEventListener('click', () => {
            const isCurrentlySecret = currentChatMode === 'secret';
            if (isCurrentlySecret) { // Switching from secret to normal
                showConfirm("Bạn có muốn xóa cuộc trò chuyện bí mật không?", 
                    async () => {
                       await clearSecretChat();
                       setChatMode(false);
                    }, 
                    () => {
                        setChatMode(false);
                    }
                );
            } else { // Switching from normal to secret
                setChatMode(true);
            }
        });

        document.getElementById('chat-send-btn').addEventListener('click', sendMessage);
        chatInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') sendMessage();
        });

        chatMessages.addEventListener('click', async (e) => {
            const deleteBtn = e.target.closest('.delete-msg-btn');
            if (deleteBtn && currentChatMode === 'normal') {
                const messageId = deleteBtn.dataset.messageId;
                showConfirm("Bạn có chắc muốn xóa tin nhắn này?", async () => {
                    await deleteDoc(doc(db, "couples", coupleCode, "chat_normal", messageId));
                });
            }
        });

        // --- QUẢN LÝ TAB ---
        navLinks.forEach(link => {
            link.addEventListener('click', () => {
                navLinks.forEach(l => l.classList.remove('active'));
                link.classList.add('active');
                
                const tabId = link.dataset.tab + '-content';
                tabContents.forEach(content => {
                    content.classList.toggle('active', content.id === tabId);
                });
            });
        });
        
        // --- MODAL STORY ---
        const storyModal = document.getElementById('story-modal');
        document.getElementById('add-story-btn').addEventListener('click', () => storyModal.classList.remove('hidden'));
        document.getElementById('cancel-story-btn').addEventListener('click', () => storyModal.classList.add('hidden'));
        document.getElementById('post-story-btn').addEventListener('click', async () => {
            const title = document.getElementById('story-title').value.trim();
            const content = document.getElementById('story-textarea').value.trim();
            const location = document.getElementById('story-location').value.trim();
            const tags = document.getElementById('story-tags').value.trim();

            if (!content) { showAlert('Vui lòng nhập nội dung.'); return; }
            
            const partner = coupleData.partner1.userId === userId ? coupleData.partner1 : coupleData.partner2;

            try {
                await addDoc(collection(db, "couples", coupleCode, "stories"), {
                    title: title, content: content, location: location, tags: tags,
                    authorId: userId, authorName: partner.name, timestamp: Timestamp.now(),
                    likes: []
                });
                document.getElementById('story-title').value = '';
                document.getElementById('story-textarea').value = '';
                document.getElementById('story-location').value = '';
                document.getElementById('story-tags').value = '';
                storyModal.classList.add('hidden');
            } catch (error) { console.error("Lỗi đăng story:", error); showAlert("Không thể đăng story."); }
        });
        
        // --- MODAL FEELING ---
        const feelingModal = document.getElementById('feeling-modal');
        document.body.addEventListener('click', (e) => {
            const btn = e.target.closest('.edit-feeling-btn');
            if (btn) {
                const partnerId = btn.dataset.partnerId;
                const partner = coupleData.partner1.userId === partnerId ? coupleData.partner1 : coupleData.partner2;
                document.getElementById('feeling-input').value = partner.feeling || '';
                feelingModal.classList.remove('hidden');
            }
        });
        document.getElementById('cancel-feeling-btn').addEventListener('click', () => feelingModal.classList.add('hidden'));
        document.getElementById('save-feeling-btn').addEventListener('click', async () => {
            const newFeeling = document.getElementById('feeling-input').value.trim();
            const partnerKey = coupleData.partner1.userId === userId ? 'partner1.feeling' : 'partner2.feeling';
            
            try {
                await updateDoc(doc(db, "couples", coupleCode), { [partnerKey]: newFeeling });
                feelingModal.classList.add('hidden');
            } catch (error) { console.error("Lỗi lưu cảm nhận:", error); showAlert("Không thể lưu cảm nhận."); }
        });


        // --- EVENT & SETTINGS LOGIC ---
        const eventModal = document.getElementById('event-modal');
        const eventIntervalInput = document.getElementById('event-interval-days');
        document.getElementById('event-repeat').addEventListener('change', (e) => { eventIntervalInput.classList.toggle('hidden', e.target.value !== 'interval'); });
        document.getElementById('add-event-btn').addEventListener('click', () => eventModal.classList.remove('hidden'));
        document.getElementById('cancel-event-btn').addEventListener('click', () => { eventModal.classList.add('hidden'); document.getElementById('event-name').value = ''; document.getElementById('event-date').value = ''; document.getElementById('event-image-url').value = ''; document.getElementById('event-repeat').value = 'none'; eventIntervalInput.classList.add('hidden'); eventIntervalInput.value = ''; });
        document.getElementById('save-event-btn').addEventListener('click', async () => {
            const name = document.getElementById('event-name').value, date = document.getElementById('event-date').value, repeat = document.getElementById('event-repeat').value, intervalDays = document.getElementById('event-interval-days').value;
            if (!name || !date || !repeat || (repeat === 'interval' && !intervalDays)) { showAlert('Vui lòng điền đủ thông tin sự kiện.'); return; }
            try {
                await addDoc(collection(db, "couples", coupleCode, "events"), { name: name, date: Timestamp.fromDate(new Date(date)), imageUrl: document.getElementById('event-image-url').value, repeat: repeat, intervalDays: repeat === 'interval' ? parseInt(intervalDays) : null, createdAt: Timestamp.now() });
                document.getElementById('cancel-event-btn').click();
            } catch (error) { console.error("Lỗi lưu sự kiện:", error); showAlert("Không thể lưu sự kiện."); }
        });
        
        document.getElementById('save-settings-btn').addEventListener('click', async () => {
            try {
                const startDate = document.getElementById('setting-start-date').value;
                let updateData = {};

                if (startDate) {
                    updateData.startDate = Timestamp.fromDate(new Date(startDate));
                }

                const inputs = document.querySelectorAll('#settings-content input[data-partner-id]');
                inputs.forEach(input => {
                    const partnerKey = coupleData.partner1.userId === input.dataset.partnerId ? 'partner1' : 'partner2';
                    const field = input.dataset.field;
                    if (!updateData[partnerKey]) updateData[partnerKey] = { ...coupleData[partnerKey] };
                    updateData[partnerKey][field] = input.value;
                });

                await updateDoc(doc(db, "couples", coupleCode), updateData);
                showAlert('Đã lưu cài đặt thành công!');
            } catch (error) {
                console.error("Lỗi lưu cài đặt:", error);
                showAlert('Có lỗi xảy ra khi lưu cài đặt.');
            }
        });
        
        document.getElementById('copy-code-btn').addEventListener('click', () => {
            const codeInput = document.getElementById('setting-couple-code');
            codeInput.select();
            codeInput.setSelectionRange(0, 99999);
            try {
                document.execCommand('copy');
                showAlert('Đã sao chép mã!');
            } catch (err) {
                showAlert('Không thể sao chép.');
            }
        });

        document.getElementById('change-code-btn').addEventListener('click', async () => {
            const newCode = document.getElementById('setting-new-couple-code').value.trim();
            const errorDiv = document.getElementById('change-code-error');
            errorDiv.textContent = '';

            if (!newCode) {
                errorDiv.textContent = 'Vui lòng nhập mã mới.';
                return;
            }
            if (newCode === coupleCode) {
                errorDiv.textContent = 'Mã mới phải khác với mã hiện tại.';
                return;
            }

            loadingText.textContent = "Đang kiểm tra mã mới...";
            loadingOverlay.classList.remove('hidden');
            const newCodeRef = doc(db, "couples", newCode);
            const newCodeSnap = await getDoc(newCodeRef);
            loadingOverlay.classList.add('hidden');

            if (newCodeSnap.exists()) {
                errorDiv.textContent = 'Mã này đã có người sử dụng. Vui lòng chọn mã khác.';
                return;
            }

            showConfirm(`Bạn có chắc muốn đổi mã cặp đôi thành "${newCode}" không? Mã cũ "${coupleCode}" sẽ bị xóa vĩnh viễn.`, async () => {
                try {
                    loadingText.textContent = "Đang di chuyển dữ liệu...";
                    loadingOverlay.classList.remove('hidden');
                    await migrateCoupleData(coupleCode, newCode);
                    showAlert('Đổi mã cặp đôi thành công! Ứng dụng sẽ tải lại.');
                    setTimeout(() => window.location.reload(), 3000);
                } catch (error) {
                    console.error("Lỗi khi đổi mã cặp đôi:", error);
                    showAlert(`Đã xảy ra lỗi nghiêm trọng: ${error.message}`);
                    loadingOverlay.classList.add('hidden');
                }
            });
        });

        async function migrateCoupleData(oldCode, newCode) {
            const oldCoupleDocRef = doc(db, "couples", oldCode);
            const oldCoupleSnap = await getDoc(oldCoupleDocRef);
            if (!oldCoupleSnap.exists()) throw new Error("Không tìm thấy dữ liệu cặp đôi cũ.");
            const coupleDataToMigrate = oldCoupleSnap.data();

            const newCoupleDocRef = doc(db, "couples", newCode);
            await setDoc(newCoupleDocRef, coupleDataToMigrate);

            const subcollectionsToMove = ['stories', 'events', 'chat_normal', 'chat_secret'];
            for (const scName of subcollectionsToMove) {
                loadingText.textContent = `Đang chuyển ${scName}...`;
                const oldSubCollectionRef = collection(db, "couples", oldCode, scName);
                const oldDocsSnapshot = await getDocs(oldSubCollectionRef);
                
                if (!oldDocsSnapshot.empty) {
                    const batch = writeBatch(db);
                    oldDocsSnapshot.forEach(d => {
                        const newDocRef = doc(db, "couples", newCode, scName, d.id);
                        batch.set(newDocRef, d.data());
                        batch.delete(d.ref);
                    });
                    await batch.commit();
                }
            }

            loadingText.textContent = "Đang cập nhật thông tin người dùng...";
            if (coupleDataToMigrate.partner1) {
                await updateDoc(doc(db, "users", coupleDataToMigrate.partner1.userId), { coupleCode: newCode });
            }
            if (coupleDataToMigrate.partner2) {
                await updateDoc(doc(db, "users", coupleDataToMigrate.partner2.userId), { coupleCode: newCode });
            }

            loadingText.textContent = "Đang dọn dẹp...";
            await deleteDoc(oldCoupleDocRef);
        }

    </script>
</body>
</html>
