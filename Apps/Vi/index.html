<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Trợ Lý Tài Chính Thông Minh</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Be+Vietnam+Pro:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        /* Theme: Dark (Default - VCB Priority Style) */
        .theme-dark {
            --primary-color: #d4af37; /* VCB Gold */
            --background-color: #0a1931; /* VCB Deep Navy */
            --card-background: #183153; /* VCB Lighter Navy */
            --text-primary: #f0f2f5; /* Off-white */
            --text-secondary: #a8b2c2; /* Light Gray/Blue */
            --income-color: #50c878; /* Green for income */
            --expense-color: #ff6b6b; /* Red for expense */
            --border-color: #2a4a75; /* Subtle border */
        }
        
        /* Theme: Light */
        .theme-light {
            --primary-color: #00529C; /* Classic Bank Blue */
            --background-color: #f4f7fa; /* Very light gray */
            --card-background: #ffffff;
            --text-primary: #121212; /* Almost black */
            --text-secondary: #6E757C; /* Gray */
            --income-color: #28a745;
            --expense-color: #dc3545;
            --border-color: #e1e4e8;
        }

        /* Theme: Mint */
        .theme-mint {
            --primary-color: #00C6AE; /* Mint Green */
            --background-color: #111827; /* Dark Slate Gray */
            --card-background: #1F2937; /* Lighter Slate Gray */
            --text-primary: #ffffff;
            --text-secondary: #9CA3AF;
            --income-color: #34D399;
            --expense-color: #F87171;
            --border-color: #374151;
        }

        /* Theme: Luxury */
        .theme-luxury {
            --primary-color: #E6B33D; /* Rich Gold */
            --background-color: #121212; /* Off-black */
            --card-background: #1E1E1E; /* Dark Charcoal */
            --text-primary: #EAEAEA; /* Elegant off-white */
            --text-secondary: #8A8A8A; /* Muted Gray */
            --income-color: #6AAB9C; /* Muted Teal Green */
            --expense-color: #C97C7C; /* Muted Rose Red */
            --border-color: #333333; /* Dark border */
        }

        body {
            font-family: 'Be Vietnam Pro', sans-serif;
            background-color: var(--background-color);
            color: var(--text-primary);
            transition: background-color 0.3s, color 0.3s;
        }
        .app-container {
            max-width: 420px;
            margin: auto;
            background-color: var(--background-color);
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            position: relative;
        }
        .main-content {
            flex-grow: 1;
            padding-bottom: 80px; /* Space for nav bar */
        }
        .screen { display: none; }
        .screen.active { display: block; }

        .bottom-nav {
            position: fixed;
            bottom: 0; left: 0; right: 0;
            max-width: 420px;
            margin: auto;
            background-color: var(--card-background);
            border-top: 1px solid var(--border-color);
            display: flex;
            justify-content: space-around;
            padding: 8px 0;
            box-shadow: 0 -2px 10px rgba(0,0,0,0.2);
            z-index: 50;
        }
        .nav-item {
            display: flex; flex-direction: column; align-items: center;
            font-size: 11px;
            color: var(--text-secondary);
            cursor: pointer;
            transition: color 0.2s;
            width: 20%;
            padding: 4px 0;
        }
        .nav-item i { font-size: 20px; margin-bottom: 4px; }
        .nav-item.active { color: var(--primary-color); }
        
        #fab-container {
            position: fixed;
            bottom: 80px; 
            right: 16px;
            z-index: 100;
            display: flex;
            flex-direction: column;
            align-items: flex-end;
        }
        #fab-main {
            width: 60px; height: 60px;
            border-radius: 50%;
            display: flex; align-items: center; justify-content: center;
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
            cursor: pointer; border: none;
            background-color: var(--primary-color);
            color: var(--background-color);
            transition: transform 0.3s ease;
            position: relative;
            z-index: 102;
        }
        .theme-light #fab-main { color: white; }
        #fab-main i {
            font-size: 24px;
            transition: transform 0.3s ease;
        }
        #fab-container.active #fab-main {
            transform: rotate(45deg);
        }

        .fab-action {
            display: flex;
            align-items: center;
            margin-bottom: 16px;
            opacity: 0;
            transform: translateY(20px) scale(0.8);
            transition: opacity 0.3s ease, transform 0.3s ease;
            visibility: hidden;
        }
        #fab-container.active .fab-action {
            opacity: 1;
            transform: translateY(0) scale(1);
            visibility: visible;
        }
        #fab-container.active .fab-action:nth-child(1) { transition-delay: 0.2s; }
        #fab-container.active .fab-action:nth-child(2) { transition-delay: 0.1s; }
        #fab-container.active .fab-action:nth-child(3) { transition-delay: 0s; }
        
        .fab-action-label {
            background-color: var(--card-background);
            color: var(--text-primary);
            padding: 6px 12px;
            border-radius: 6px;
            margin-right: 12px;
            font-size: 14px;
            font-weight: 500;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        }

        .mini-fab {
            width: 48px; height: 48px;
            border-radius: 50%;
            display: flex; align-items: center; justify-content: center;
            background-color: var(--card-background);
            color: var(--primary-color);
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
            border: 1px solid var(--border-color);
            cursor: pointer;
        }
        
        #fab-backdrop {
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background-color: rgba(0,0,0,0.5);
            z-index: 99;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s ease, visibility 0.3s ease;
        }
        #fab-backdrop.active {
            opacity: 1;
            visibility: visible;
        }

        .modal-backdrop {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background-color: rgba(0,0,0,0.7);
            display: flex; justify-content: center; align-items: center;
            z-index: 1000; opacity: 0; visibility: hidden;
            transition: opacity 0.3s, visibility 0.3s;
        }
        .modal-backdrop.visible { opacity: 1; visibility: visible; }
        .modal-content {
            background-color: var(--card-background);
            border: 1px solid var(--border-color);
            padding: 24px; border-radius: 16px;
            width: 90%; max-width: 380px;
            transform: scale(0.95); transition: transform 0.3s;
        }
        .modal-backdrop.visible .modal-content { transform: scale(1); }
        
        .form-input, .form-select {
            width: 100%;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 12px 14px;
            font-size: 16px;
            background-color: var(--background-color);
            color: var(--text-primary);
            transition: border-color 0.2s, box-shadow 0.2s;
        }
        .form-input:focus, .form-select:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 2px color-mix(in srgb, var(--primary-color) 20%, transparent);
        }

        .btn {
            padding: 12px; border-radius: 8px; font-weight: 600;
            text-align: center; transition: all 0.2s;
            cursor: pointer; border: none;
        }
        .btn-primary { 
            background-color: var(--primary-color); 
            color: var(--background-color); 
            font-weight: 700; 
        }
        .theme-light .btn-primary { color: white; }
        .btn-primary:hover { filter: brightness(1.1); }
        .btn-secondary { background-color: var(--card-background); color: var(--text-secondary); border: 1px solid var(--border-color); }
        
        .skeleton {
            background-color: var(--card-background);
            position: relative;
            overflow: hidden;
        }
        .skeleton::after {
            content: '';
            position: absolute;
            top: 0;
            left: -150%;
            width: 150%;
            height: 100%;
            background: linear-gradient(90deg, transparent, color-mix(in srgb, var(--text-secondary) 10%, transparent), transparent);
            animation: loading 1.5s infinite;
        }
        @keyframes loading {
            0% { left: -150%; }
            100% { left: 150%; }
        }

    </style>
</head>
<body class="theme-dark">
    <div class="app-container">
        <!-- Main Content Area -->
        <main class="main-content">
            <!-- Screen: Tổng quan -->
            <div id="dashboard-screen" class="screen active p-4">
                <header class="mb-6 flex justify-between items-center">
                    <div>
                        <h1 class="text-2xl font-bold">Tổng Quan</h1>
                        <p style="color:var(--text-secondary)">Chào mừng bạn trở lại!</p>
                    </div>
                    <button id="ai-assistant-btn" class="p-3 rounded-full shadow-sm" style="background-color: var(--card-background); color: var(--primary-color);">
                        <i class="fas fa-robot text-xl"></i>
                    </button>
                </header>
                
                <div class="p-6 rounded-2xl shadow-lg mb-8" style="background-color: var(--card-background);">
                    <p class="text-sm" style="color: var(--text-secondary);">Tổng số dư</p>
                    <p id="total-balance" class="text-4xl font-bold tracking-tight my-2" style="color: var(--primary-color);">0</p>
                    <div class="h-[1px] my-4" style="background-color: var(--border-color);"></div>
                    <div class="flex justify-between">
                        <div><p class="text-xs flex items-center" style="color: var(--text-secondary);"><i class="fas fa-arrow-up mr-2" style="color: var(--income-color);"></i> Thu nhập</p><p id="total-income" class="font-semibold text-lg">0</p></div>
                        <div><p class="text-xs flex items-center" style="color: var(--text-secondary);"><i class="fas fa-arrow-down mr-2" style="color: var(--expense-color);"></i> Chi tiêu</p><p id="total-expense" class="font-semibold text-lg">0</p></div>
                    </div>
                </div>

                <div class="grid grid-cols-3 gap-4 text-center mb-8">
                    <div>
                        <button id="quick-action-expense" class="w-16 h-16 rounded-full flex items-center justify-center mx-auto mb-2" style="background-color: var(--card-background);"><i class="fas fa-arrow-down text-2xl" style="color: var(--expense-color);"></i></button>
                        <p class="text-xs font-medium" style="color: var(--text-secondary)">Chi Tiêu</p>
                    </div>
                     <div>
                        <button id="quick-action-income" class="w-16 h-16 rounded-full flex items-center justify-center mx-auto mb-2" style="background-color: var(--card-background);"><i class="fas fa-arrow-up text-2xl" style="color: var(--income-color);"></i></button>
                        <p class="text-xs font-medium" style="color: var(--text-secondary)">Thu Nhập</p>
                    </div>
                     <div>
                        <button id="quick-action-transfer" class="w-16 h-16 rounded-full flex items-center justify-center mx-auto mb-2" style="background-color: var(--card-background);"><i class="fas fa-exchange-alt text-2xl" style="color: var(--primary-color);"></i></button>
                        <p class="text-xs font-medium" style="color: var(--text-secondary)">Chuyển Tiền</p>
                    </div>
                </div>

                <div class="flex justify-between items-center mb-4"><h2 class="text-xl font-bold">Tài khoản & Ví</h2><button id="add-wallet-btn-dashboard" class="font-semibold text-sm" style="color:var(--primary-color)">+ Thêm ví</button></div>
                <div id="wallet-list-dashboard" class="space-y-3"></div>
                <div class="mt-8"><h2 class="text-xl font-bold mb-4">Giao dịch gần đây</h2><div id="recent-transactions" class="space-y-3"></div></div>
            </div>

            <!-- Screen: Lịch sử -->
            <div id="history-screen" class="screen p-4">
                 <header class="mb-6"><h1 class="text-2xl font-bold">Lịch Sử Giao Dịch</h1>
                    <div class="mt-2"><label for="history-wallet-filter" class="text-sm font-medium" style="color:var(--text-secondary)">Lọc theo ví:</label><select id="history-wallet-filter" class="form-select mt-1"><option value="all">Tất cả ví</option></select></div>
                </header>
                <div id="full-transaction-list" class="space-y-3"></div>
            </div>

            <!-- Screen: Market -->
            <div id="market-screen" class="screen p-4">
                <header class="mb-6 flex justify-between items-center">
                    <h1 class="text-2xl font-bold">Thị Trường</h1>
                    <button id="refresh-market-data" class="p-2" style="color:var(--text-secondary)"><i class="fas fa-sync-alt"></i></button>
                </header>

                <!-- Gold Prices -->
                <div class="mb-8">
                    <h2 class="text-xl font-semibold mb-3">Tỉ Giá Vàng</h2>
                    <div id="gold-prices">
                        <!-- Gold data will be rendered here with new compact style -->
                    </div>
                </div>

                <!-- Forex -->
                <div class="mb-8">
                     <h2 class="text-xl font-semibold mb-3">Ngoại Tệ</h2>
                     <!-- Currency Converter -->
                    <div id="currency-converter" class="p-4 rounded-xl mb-4" style="background-color: var(--card-background);">
                        <div class="flex items-center gap-2">
                            <div class="flex-1">
                                <label class="text-xs font-medium" style="color:var(--text-secondary)">Từ</label>
                                <select id="converter-from-select" class="form-select mt-1"></select>
                                <input type="number" id="converter-from-amount" class="form-input mt-2" placeholder="0">
                            </div>
                            <button id="converter-swap-btn" class="pt-5 p-2 rounded-full hover:bg-[color-mix(in_srgb,_var(--primary-color)_10%,_transparent)]">
                                <i class="fas fa-exchange-alt" style="color: var(--primary-color);"></i>
                            </button>
                            <div class="flex-1">
                                <label class="text-xs font-medium" style="color:var(--text-secondary)">Sang</label>
                                <select id="converter-to-select" class="form-select mt-1"></select>
                                <input type="number" id="converter-to-amount" class="form-input mt-2" placeholder="0">
                            </div>
                        </div>
                    </div>
                    <!-- Rates Table -->
                    <h3 class="text-lg font-semibold mb-2" style="color:var(--text-secondary)">Tỉ giá (so với VNĐ)</h3>
                    <div class="mb-2">
                        <input type="text" id="forex-search-input" class="form-input" placeholder="Tìm kiếm tiền tệ...">
                    </div>
                    <div id="forex-rates" class="rounded-xl overflow-hidden" style="background-color: var(--card-background);">
                        <!-- Forex data will be rendered here -->
                    </div>
                </div>

                <!-- Crypto -->
                <div>
                    <h2 class="text-xl font-semibold mb-3">Tiền Ảo</h2>
                    <div id="crypto-prices" class="grid grid-cols-2 gap-3">
                        <!-- Crypto data will be rendered here -->
                    </div>
                </div>
            </div>
            
            <!-- Screen: Ví -->
            <div id="wallets-screen" class="screen p-4">
                <header class="mb-6 flex justify-between items-center"><h1 class="text-2xl font-bold">Quản Lý Ví</h1><button id="add-wallet-btn-wallets" class="btn btn-primary !py-2 !px-4 flex items-center"><i class="fas fa-plus mr-2"></i>Thêm mới</button></header>
                <div id="wallet-list-management" class="space-y-3"></div>
            </div>

            <!-- Screen: Cài đặt -->
            <div id="settings-screen" class="screen p-4">
                <header class="mb-6"><h1 class="text-2xl font-bold">Cài Đặt</h1></header>
                <div class="space-y-6">
                     <div><h3 class="text-lg font-semibold mb-3">Giao diện</h3>
                        <div class="grid grid-cols-2 gap-3">
                            <button class="theme-btn btn" data-theme="dark">Bóng Đêm</button>
                            <button class="theme-btn btn" data-theme="light">Cổ Điển</button>
                            <button class="theme-btn btn" data-theme="mint">Bạc Hà</button>
                            <button class="theme-btn btn" data-theme="luxury">Sang Trọng</button>
                        </div>
                    </div>
                    <div><h3 class="text-lg font-semibold mb-2">Tiền tệ</h3>
                        <select id="currency-select" class="form-select">
                            <option value="VND">Việt Nam Đồng (VNĐ)</option>
                            <option value="USD">US Dollar ($)</option>
                            <option value="JPY">Japanese Yen (¥)</option>
                        </select>
                    </div>
                    <div><h3 class="text-lg font-semibold mb-2">Quản lý Dữ liệu</h3>
                        <div class="flex gap-3">
                            <button id="export-data-btn" class="btn btn-primary w-full">Xuất Dữ Liệu</button>
                            <button id="import-data-btn" class="btn btn-secondary w-full">Nhập Dữ Liệu</button>
                            <input type="file" id="import-file-input" hidden accept=".json">
                        </div>
                    </div>
                     <div><h3 class="text-lg font-semibold mb-2">Xóa Dữ Liệu</h3>
                        <button id="reset-data-btn" class="btn w-full" style="background-color: var(--expense-color); color: white;">Xóa Toàn Bộ Dữ Liệu</button>
                     </div>
                </div>
            </div>

            <!-- Screen: AI Assistant (Hidden, shown via logic) -->
            <div id="ai-assistant-screen" class="screen">
                <header class="p-4 border-b flex items-center" style="border-color: var(--border-color); position: sticky; top: 0; background-color: var(--background-color); z-index: 10;">
                    <button id="back-from-ai-btn" class="mr-4" style="color:var(--text-primary)"><i class="fas fa-arrow-left text-xl"></i></button>
                    <h1 class="text-xl font-bold text-center flex-grow">Trợ lý Tài chính AI</h1>
                </header>
                 <div id="ai-chat-history" class="p-4"></div>
                <div class="p-4 border-t" style="border-color: var(--border-color); position: sticky; bottom: 0; background-color: var(--background-color);">
                    <form id="ai-chat-form" class="flex items-center gap-2">
                        <input type="text" id="ai-chat-input" class="form-input flex-grow" placeholder="Hỏi điều gì đó..." required>
                        <button type="submit" class="btn btn-primary !p-3 !rounded-full w-12 h-12 flex-shrink-0"><i class="fas fa-paper-plane"></i></button>
                    </form>
                </div>
            </div>
        </main>

        <!-- New Floating Action Button Structure -->
        <div id="fab-backdrop"></div>
        <div id="fab-container">
             <div class="fab-action">
                <span class="fab-action-label">Chuyển Tiền</span>
                <button id="fab-action-transfer" class="mini-fab"><i class="fas fa-exchange-alt"></i></button>
            </div>
             <div class="fab-action">
                <span class="fab-action-label">Thu Nhập</span>
                <button id="fab-action-income" class="mini-fab"><i class="fas fa-arrow-up"></i></button>
            </div>
             <div class="fab-action">
                <span class="fab-action-label">Chi Tiêu</span>
                <button id="fab-action-expense" class="mini-fab"><i class="fas fa-arrow-down"></i></button>
            </div>
            <button id="fab-main">
                <i class="fas fa-plus"></i>
            </button>
        </div>


        <!-- Bottom Navigation -->
        <nav class="bottom-nav">
            <div class="nav-item active" data-screen="dashboard-screen"><i class="fas fa-home"></i><span>Tổng quan</span></div>
            <div class="nav-item" data-screen="history-screen"><i class="fas fa-history"></i><span>Lịch sử</span></div>
            <div class="nav-item" data-screen="market-screen"><i class="fas fa-chart-line"></i><span>Thị trường</span></div>
            <div class="nav-item" data-screen="wallets-screen"><i class="fas fa-wallet"></i><span>Ví</span></div>
            <div class="nav-item" data-screen="settings-screen"><i class="fas fa-cog"></i><span>Cài đặt</span></div>
        </nav>
    </div>

    <!-- Modals (Unchanged from previous version) -->
    <div id="add-choice-modal" class="modal-backdrop">
        <div class="modal-content !p-4">
            <div class="grid grid-cols-1 gap-3">
                <button id="choice-add-expense" class="btn text-left !p-4 flex items-center" style="background-color: var(--card-background); color: var(--text-primary); border: 1px solid var(--border-color);">
                    <i class="fas fa-arrow-down mr-4 text-lg" style="color: var(--expense-color);"></i>
                    <div><p class="font-bold">Thêm Chi Tiêu</p><p class="text-xs" style="color:var(--text-secondary)">Ghi lại một khoản chi</p></div>
                </button>
                <button id="choice-add-income" class="btn text-left !p-4 flex items-center" style="background-color: var(--card-background); color: var(--text-primary); border: 1px solid var(--border-color);">
                    <i class="fas fa-arrow-up mr-4 text-lg" style="color: var(--income-color);"></i>
                     <div><p class="font-bold">Thêm Thu Nhập</p><p class="text-xs" style="color:var(--text-secondary)">Ghi lại một khoản thu</p></div>
                </button>
                <button id="choice-transfer" class="btn text-left !p-4 flex items-center" style="background-color: var(--card-background); color: var(--text-primary); border: 1px solid var(--border-color);">
                    <i class="fas fa-exchange-alt mr-4 text-lg" style="color: var(--primary-color);"></i>
                     <div><p class="font-bold">Chuyển Tiền</p><p class="text-xs" style="color:var(--text-secondary)">Di chuyển tiền giữa các ví</p></div>
                </button>
            </div>
             <button id="cancel-choice" class="btn btn-secondary w-full mt-4">Hủy</button>
        </div>
    </div>
    
    <div id="add-transaction-modal" class="modal-backdrop">
        <div class="modal-content">
            <h2 class="text-xl font-bold mb-4">Thêm Giao Dịch</h2>
            <form id="transaction-form">
                <div class="mb-3">
                    <div class="flex rounded-md shadow-sm">
                        <button type="button" id="type-expense" class="btn w-1/2 !rounded-r-none" style="background-color:var(--expense-color); color:white;">Chi Tiêu</button>
                        <button type="button" id="type-income" class="btn w-1/2 !rounded-l-none" style="background-color:var(--border-color); color:var(--text-secondary)">Thu Nhập</button>
                    </div>
                </div>
                <div class="mb-3"><label for="amount" class="block text-sm font-medium mb-1">Số tiền</label><input type="number" step="any" id="amount" class="form-input" placeholder="0" required></div>
                <div class="mb-3"><label for="category" class="block text-sm font-medium mb-1">Hạng mục</label><input type="text" id="category" class="form-input" placeholder="VD: Ăn uống, Lương" required></div>
                <div class="mb-3"><label for="wallet-select" class="block text-sm font-medium mb-1">Chọn ví</label><select id="wallet-select" class="form-select" required></select></div>
                <div class="mb-4"><label for="description" class="block text-sm font-medium mb-1">Ghi chú</label><input type="text" id="description" class="form-input" placeholder="VD: Cà phê với bạn bè"></div>
                <div class="flex space-x-3">
                    <button type="button" id="cancel-transaction" class="btn btn-secondary w-1/2">Hủy</button>
                    <button type="submit" class="btn btn-primary w-1/2">Lưu</button>
                </div>
            </form>
        </div>
    </div>
    <div id="add-wallet-modal" class="modal-backdrop">
        <div class="modal-content">
            <h2 class="text-xl font-bold mb-4">Thêm Ví Mới</h2>
            <form id="wallet-form">
                <div class="mb-3"><label for="wallet-name" class="block text-sm font-medium mb-1">Tên ví</p><input type="text" id="wallet-name" class="form-input" placeholder="VD: Tiền mặt, Ngân hàng" required></div>
                <div class="mb-4"><label for="initial-balance" class="block text-sm font-medium mb-1">Số dư ban đầu</p><input type="number" step="any" id="initial-balance" class="form-input" placeholder="0" required value="0"></div>
                <div class="flex space-x-3">
                    <button type="button" id="cancel-wallet" class="btn btn-secondary w-1/2">Hủy</button>
                    <button type="submit" class="btn btn-primary w-1/2">Tạo ví</button>
                </div>
            </form>
        </div>
    </div>
    <div id="edit-wallet-modal" class="modal-backdrop">
        <div class="modal-content">
            <h2 class="text-xl font-bold mb-4">Chỉnh Sửa Ví</h2>
            <form id="edit-wallet-form">
                <div class="mb-3">
                    <label for="edit-wallet-name" class="block text-sm font-medium mb-1">Tên ví</p>
                    <input type="text" id="edit-wallet-name" class="form-input" required>
                </div>
                <div class="mb-4">
                    <label for="edit-wallet-balance" class="block text-sm font-medium mb-1">Số dư hiện tại</p>
                    <input type="number" step="any" id="edit-wallet-balance" class="form-input" required>
                </div>
                <div class="flex space-x-3">
                    <button type="button" id="cancel-edit-wallet" class="btn btn-secondary w-1/2">Hủy</button>
                    <button type="submit" class="btn btn-primary w-1/2">Lưu Thay Đổi</button>
                </div>
            </form>
        </div>
    </div>
     <div id="edit-transaction-modal" class="modal-backdrop">
        <div class="modal-content">
            <h2 class="text-xl font-bold mb-4">Chỉnh Sửa Giao Dịch</h2>
            <form id="edit-transaction-form">
                <div class="mb-3">
                    <div class="flex rounded-md shadow-sm">
                        <button type="button" id="edit-type-expense" class="btn w-1/2 !rounded-r-none">Chi Tiêu</button>
                        <button type="button" id="edit-type-income" class="btn w-1/2 !rounded-l-none">Thu Nhập</button>
                    </div>
                </div>
                <div class="mb-3"><label for="edit-amount" class="block text-sm font-medium mb-1">Số tiền</label><input type="number" step="any" id="edit-amount" class="form-input" required></div>
                <div class="mb-3"><label for="edit-category" class="block text-sm font-medium mb-1">Hạng mục</label><input type="text" id="edit-category" class="form-input" required></div>
                <div class="mb-3"><label for="edit-wallet-select" class="block text-sm font-medium mb-1">Chọn ví</label><select id="edit-wallet-select" class="form-select" required></select></div>
                <div class="mb-4"><label for="edit-description" class="block text-sm font-medium mb-1">Ghi chú</label><input type="text" id="edit-description" class="form-input"></div>
                <div class="flex space-x-2">
                    <button type="button" id="delete-transaction-btn" class="btn !py-3 w-1/3" style="background-color: var(--expense-color); color: white;">Xóa</button>
                    <button type="button" id="cancel-edit-transaction" class="btn btn-secondary w-1/3">Hủy</button>
                    <button type="submit" class="btn btn-primary w-1/3">Lưu</button>
                </div>
            </form>
        </div>
    </div>
    <div id="transfer-modal" class="modal-backdrop">
        <div class="modal-content">
            <h2 class="text-xl font-bold mb-4">Chuyển Tiền</h2>
            <form id="transfer-form">
                <div class="mb-3">
                    <label for="transfer-amount" class="block text-sm font-medium mb-1">Số tiền</label>
                    <input type="number" step="any" id="transfer-amount" class="form-input" placeholder="0" required>
                </div>
                <div class="mb-3">
                    <label for="from-wallet-select" class="block text-sm font-medium mb-1">Từ ví</label>
                    <select id="from-wallet-select" class="form-select" required></select>
                </div>
                <div class="mb-3">
                    <label for="to-wallet-select" class="block text-sm font-medium mb-1">Đến ví</label>
                    <select id="to-wallet-select" class="form-select" required></select>
                </div>
                <div class="mb-4">
                    <label for="transfer-description" class="block text-sm font-medium mb-1">Ghi chú</label>
                    <input type="text" id="transfer-description" class="form-input" placeholder="Tùy chọn">
                </div>
                <div class="flex space-x-3">
                    <button type="button" id="cancel-transfer" class="btn btn-secondary w-1/2">Hủy</button>
                    <button type="submit" class="btn btn-primary w-1/2">Chuyển</button>
                </div>
            </form>
        </div>
    </div>
    <div id="confirm-modal" class="modal-backdrop">
        <div class="modal-content text-center">
            <h2 id="confirm-title" class="text-xl font-bold mb-2">Xác nhận</h2>
            <p id="confirm-message" class="mb-6 whitespace-pre-wrap" style="color: var(--text-secondary);"></p>
            <div class="flex space-x-3">
                <button id="confirm-cancel-btn" class="btn btn-secondary w-1/2">Hủy</button>
                <button id="confirm-ok-btn" class="btn btn-primary w-1/2">Đồng ý</button>
            </div>
        </div>
    </div>

    <script>
    document.addEventListener('DOMContentLoaded', () => {
        // STATE MANAGEMENT
        let state = {
            wallets: [],
            transactions: [],
            aiChatHistory: [],
            settings: {
                theme: 'dark',
                currency: 'VND',
            },
            marketData: {
                gold: null,
                forex_api: null,
                crypto: null,
            },
            followedCurrencies: [],
            editingWalletId: null,
            editingTransactionId: null,
        };
        
        const CURRENCY_DATA = {
            "VND": { name: "Đồng Việt Nam", flag: "🇻🇳" },
            "USD": { name: "Đô la Mỹ", flag: "🇺🇸" },
            "EUR": { name: "Euro", flag: "🇪🇺" },
            "JPY": { name: "Yên Nhật", flag: "🇯🇵" },
            "GBP": { name: "Bảng Anh", flag: "🇬🇧" },
            "AUD": { name: "Đô la Úc", flag: "🇦🇺" },
            "CAD": { name: "Đô la Canada", flag: "🇨🇦" },
            "CHF": { name: "Franc Thụy Sĩ", flag: "🇨🇭" },
            "CNY": { name: "Nhân dân tệ", flag: "🇨🇳" },
            "KRW": { name: "Won Hàn Quốc", flag: "🇰🇷" },
            "SGD": { name: "Đô la Singapore", flag: "🇸🇬" },
            "THB": { name: "Baht Thái", flag: "🇹🇭" }
        };

        // DOM ELEMENTS
        const fabContainer = document.getElementById('fab-container');
        const fabMain = document.getElementById('fab-main');
        const fabBackdrop = document.getElementById('fab-backdrop');
        const fabActionExpense = document.getElementById('fab-action-expense');
        const fabActionIncome = document.getElementById('fab-action-income');
        const fabActionTransfer = document.getElementById('fab-action-transfer');
        const body = document.body;
        const screens = document.querySelectorAll('.screen');
        const navItems = document.querySelectorAll('.nav-item');
        const totalBalanceEl = document.getElementById('total-balance');
        const totalIncomeEl = document.getElementById('total-income');
        const totalExpenseEl = document.getElementById('total-expense');
        const walletListDashboard = document.getElementById('wallet-list-dashboard');
        const recentTransactionsEl = document.getElementById('recent-transactions');
        const fullTransactionListEl = document.getElementById('full-transaction-list');
        const walletListManagementEl = document.getElementById('wallet-list-management');
        const historyWalletFilter = document.getElementById('history-wallet-filter');
        // Market Screen
        const goldPricesEl = document.getElementById('gold-prices');
        const forexRatesEl = document.getElementById('forex-rates');
        const cryptoPricesEl = document.getElementById('crypto-prices');
        const refreshMarketDataBtn = document.getElementById('refresh-market-data');
        const converterFromSelect = document.getElementById('converter-from-select');
        const converterToSelect = document.getElementById('converter-to-select');
        const converterFromAmount = document.getElementById('converter-from-amount');
        const converterToAmount = document.getElementById('converter-to-amount');
        const converterSwapBtn = document.getElementById('converter-swap-btn');
        const forexSearchInput = document.getElementById('forex-search-input');
        // Modals
        const addTransactionModal = document.getElementById('add-transaction-modal');
        const addWalletModal = document.getElementById('add-wallet-modal');
        const editWalletModal = document.getElementById('edit-wallet-modal');
        const editTransactionModal = document.getElementById('edit-transaction-modal');
        const transferModal = document.getElementById('transfer-modal');
        const confirmModal = document.getElementById('confirm-modal');
        // Forms & Buttons...
        const transactionForm = document.getElementById('transaction-form');
        const walletForm = document.getElementById('wallet-form');
        const typeExpenseBtn = document.getElementById('type-expense');
        const typeIncomeBtn = document.getElementById('type-income');
        const amountInput = document.getElementById('amount');
        const categoryInput = document.getElementById('category');
        const walletSelect = document.getElementById('wallet-select');
        const descriptionInput = document.getElementById('description');
        const editWalletForm = document.getElementById('edit-wallet-form');
        const editWalletNameInput = document.getElementById('edit-wallet-name');
        const editWalletBalanceInput = document.getElementById('edit-wallet-balance');
        const editTransactionForm = document.getElementById('edit-transaction-form');
        const transferForm = document.getElementById('transfer-form');
        const confirmTitleEl = document.getElementById('confirm-title');
        const confirmMessageEl = document.getElementById('confirm-message');
        const confirmOkBtn = document.getElementById('confirm-ok-btn');
        const confirmCancelBtn = document.getElementById('confirm-cancel-btn');
        const aiChatHistoryEl = document.getElementById('ai-chat-history');
        const aiChatForm = document.getElementById('ai-chat-form');
        const aiChatInput = document.getElementById('ai-chat-input');
        const aiAssistantBtn = document.getElementById('ai-assistant-btn');
        const backFromAiBtn = document.getElementById('back-from-ai-btn');
        
        let transactionType = 'expense';
        let editTransactionType = 'expense';
        let confirmCallback = () => {};

        // --- THEME ---
        const themeButtons = document.querySelectorAll('.theme-btn');
        const applyTheme = (themeName) => {
            body.className = `theme-${themeName}`;
            themeButtons.forEach(btn => {
                const isActive = btn.dataset.theme === themeName;
                btn.style.backgroundColor = isActive ? 'var(--primary-color)' : 'var(--card-background)';
                const color = isActive ? (themeName === 'light' ? 'white' : 'var(--background-color)') : 'var(--text-primary)';
                btn.style.color = color;
                btn.style.border = isActive ? 'none' : '1px solid var(--border-color)';
            });
            state.settings.theme = themeName;
        };
        themeButtons.forEach(btn => btn.addEventListener('click', () => {
            applyTheme(btn.dataset.theme);
            saveData();
        }));

        // --- CURRENCY ---
        const currencySelect = document.getElementById('currency-select');
        const formatCurrency = (num, currencyCode = state.settings.currency) => {
            try {
                return new Intl.NumberFormat('vi-VN', {
                    style: 'currency',
                    currency: currencyCode,
                    minimumFractionDigits: 0
                }).format(num);
            } catch (e) {
                 return new Intl.NumberFormat('en-US', {
                    style: 'currency',
                    currency: 'USD',
                    minimumFractionDigits: 0
                }).format(num);
            }
        };
        currencySelect.addEventListener('change', () => {
            state.settings.currency = currencySelect.value;
            renderAll();
        });
        
        // --- DATA PERSISTENCE ---
        const saveData = () => localStorage.setItem('financeAppState_v2.11', JSON.stringify(state));
        const loadData = () => {
            const data = localStorage.getItem('financeAppState_v2.11');
            if (data) {
                const loadedState = JSON.parse(data);
                state = {...state, ...loadedState};
                if (!state.settings) state.settings = { theme: 'dark', currency: 'VND' };
                if (!state.aiChatHistory) state.aiChatHistory = [];
                if (!state.marketData) state.marketData = { gold: null, forex_api: null, crypto: null };
                if (!state.followedCurrencies) state.followedCurrencies = [];

            } else {
                state.wallets.push({ id: Date.now(), name: 'Tài khoản VCB', balance: 10000000 });
                state.wallets.push({ id: Date.now()+1, name: 'Tiền mặt', balance: 500000 });
            }
            applyTheme(state.settings.theme || 'dark');
            currencySelect.value = state.settings.currency;
        };

        // --- MARKET DATA ---
        const renderMarketSkeletons = () => {
            goldPricesEl.innerHTML = `<div class="h-24 rounded-xl skeleton"></div>`;
            forexRatesEl.innerHTML = Array(4).fill('').map(() => `<div class="h-10 skeleton"></div>`).join('');
            cryptoPricesEl.innerHTML = Array(4).fill('').map(() => `<div class="h-24 rounded-xl skeleton"></div>`).join('');
        };

        const fetchAllMarketData = async () => {
            renderMarketSkeletons();
            await Promise.all([
                fetchGoldData(),
                fetchApiForexData(),
                fetchCryptoData()
            ]);
            renderMarketScreen();
            populateConverterSelects();
        };

        const fetchGoldData = async () => {
            state.marketData.gold = [
                { type: 'Vàng SJC 1L', buy: '74,980,000', sell: '76,980,000' },
                { type: 'Vàng nhẫn SJC 99.99', buy: '73,550,000', sell: '75,150,000' },
                { type: 'Vàng PNJ', buy: '73,500,000', sell: '75,200,000' }
            ];
        };

        const fetchApiForexData = async () => {
            try {
                const response = await fetch('https://api.exchangerate-api.com/v4/latest/VND');
                if (!response.ok) throw new Error('Network response was not ok');
                const data = await response.json();
                state.marketData.forex_api = data.rates;
            } catch (error) {
                 console.error("Failed to fetch API forex rates:", error);
                 state.marketData.forex_api = 'error';
            }
        };

        const fetchCryptoData = async () => {
            const url = 'https://api.coingecko.com/api/v3/coins/markets?vs_currency=usd&ids=bitcoin,ethereum,tether,binancecoin,solana,ripple&order=market_cap_desc&per_page=10&page=1&sparkline=false';
            try {
                const response = await fetch(url);
                if (!response.ok) throw new Error('Network response was not ok');
                const data = await response.json();
                state.marketData.crypto = data.map(coin => ({
                    id: coin.id, name: coin.name, symbol: coin.symbol.toUpperCase(),
                    image: coin.image, price: coin.current_price,
                    change24h: coin.price_change_percentage_24h,
                }));
            } catch (error) {
                console.error("Failed to fetch crypto prices:", error);
                state.marketData.crypto = 'error';
            }
        };

        const renderMarketScreen = () => {
            // Render Gold with new compact style
            if (state.marketData.gold) {
                goldPricesEl.innerHTML = `
                <div class="rounded-xl overflow-hidden" style="background-color: var(--card-background);">
                    <div class="grid grid-cols-3 text-xs font-bold p-3" style="background-color: color-mix(in srgb, var(--border-color) 50%, transparent);">
                        <span>Loại vàng</span>
                        <span class="text-right">Mua vào</span>
                        <span class="text-right">Bán ra</span>
                    </div>
                    <div class="divide-y" style="border-color: var(--border-color);">
                    ${state.marketData.gold.map(gold => `
                        <div class="grid grid-cols-3 p-3 text-sm">
                            <span class="font-semibold col-span-1">${gold.type}</span>
                            <span class="text-right col-span-1">${gold.buy}</span>
                            <span class="text-right col-span-1">${gold.sell}</span>
                        </div>
                    `).join('')}
                    </div>
                </div>`;
            } else {
                 goldPricesEl.innerHTML = `<p style="color:var(--text-secondary)">Không thể tải dữ liệu vàng.</p>`;
            }

            // Render Forex
            if (state.marketData.forex_api && typeof state.marketData.forex_api === 'object') {
                const searchTerm = forexSearchInput.value.toLowerCase();
                const allCodes = Object.keys(CURRENCY_DATA).filter(c => c !== 'VND');
                
                const filteredCodes = allCodes.filter(code => {
                    const currency = CURRENCY_DATA[code];
                    return code.toLowerCase().includes(searchTerm) || currency.name.toLowerCase().includes(searchTerm);
                });

                filteredCodes.sort((a, b) => {
                    const isAFollowed = state.followedCurrencies.includes(a);
                    const isBFollowed = state.followedCurrencies.includes(b);
                    if (isAFollowed && !isBFollowed) return -1;
                    if (!isAFollowed && isBFollowed) return 1;
                    return a.localeCompare(b);
                });

                forexRatesEl.innerHTML = `
                 <div class="grid grid-cols-4 text-xs font-bold p-3" style="background-color: color-mix(in srgb, var(--border-color) 50%, transparent);">
                    <span class="col-span-2">Ngoại tệ</span><span class="text-right">Tỉ giá / VNĐ</span><span></span>
                </div>
                <div class="divide-y max-h-60 overflow-y-auto" style="border-color: var(--border-color);">
                ${filteredCodes.map(code => {
                    const rate = state.marketData.forex_api[code];
                    if (!rate) return '';
                    const displayRate = 1 / rate;
                    const isFollowed = state.followedCurrencies.includes(code);
                    return `
                    <div class="grid grid-cols-4 p-3 text-sm items-center">
                        <div class="col-span-2 flex items-center">
                            <span class="mr-2 text-lg">${CURRENCY_DATA[code].flag}</span>
                            <div>
                                <p class="font-bold">${code}</p>
                                <p class="text-xs" style="color:var(--text-secondary)">${CURRENCY_DATA[code].name}</p>
                            </div>
                        </div>
                        <span class="text-right font-semibold">${displayRate.toLocaleString('vi-VN', {minimumFractionDigits: 2, maximumFractionDigits: 2})}</span>
                        <button class="follow-currency-btn text-right text-lg pl-4" data-code="${code}" style="color: ${isFollowed ? 'var(--primary-color)' : 'var(--text-secondary)'};">
                            <i class="${isFollowed ? 'fas' : 'far'} fa-star"></i>
                        </button>
                    </div>`
                }).join('')}
                </div>`;
            } else {
                 forexRatesEl.innerHTML = `<p class="p-4 text-center" style="color:var(--text-secondary)">Không thể tải dữ liệu tỉ giá.</p>`;
            }

            // Render Crypto
            if (Array.isArray(state.marketData.crypto)) {
                cryptoPricesEl.innerHTML = state.marketData.crypto.map(coin => {
                    const isPositive = coin.change24h >= 0;
                    const changeColor = isPositive ? 'var(--income-color)' : 'var(--expense-color)';
                    return `
                    <div class="p-3 rounded-xl flex flex-col justify-between" style="background-color: var(--card-background);">
                        <div class="flex items-center mb-2">
                            <img src="${coin.image}" class="w-6 h-6 mr-2">
                            <div>
                                <p class="font-bold text-sm">${coin.symbol}</p>
                                <p class="text-xs" style="color: var(--text-secondary);">${coin.name}</p>
                            </div>
                        </div>
                        <div>
                            <p class="font-semibold">${formatCurrency(coin.price, 'USD')}</p>
                            <p class="text-xs font-semibold" style="color: ${changeColor};">
                                ${isPositive ? '+' : ''}${coin.change24h.toFixed(2)}%
                            </p>
                        </div>
                    </div>`
                }).join('');
            } else {
                cryptoPricesEl.innerHTML = `<p class="p-4 text-center col-span-2" style="color:var(--text-secondary)">Không thể tải dữ liệu tiền ảo.</p>`;
            }
        };

        const populateConverterSelects = () => {
            if (!state.marketData.forex_api) return;
            const optionsHTML = Object.entries(CURRENCY_DATA)
                .map(([code, data]) => `<option value="${code}">${data.flag} ${code}</option>`)
                .join('');
            converterFromSelect.innerHTML = optionsHTML;
            converterToSelect.innerHTML = optionsHTML;
            converterFromSelect.value = 'USD';
            converterToSelect.value = 'VND';
        };
        
        const handleConversion = (source) => {
            const rates = state.marketData.forex_api;
            if(!rates) return;
            
            const fromCurrency = converterFromSelect.value;
            const toCurrency = converterToSelect.value;
            
            if (source === 'from') {
                const fromAmount = parseFloat(converterFromAmount.value);
                if (isNaN(fromAmount)) {
                    converterToAmount.value = '';
                    return;
                }
                const fromRate = rates[fromCurrency]; 
                const toRate = rates[toCurrency];     
                
                const amountInVND = fromAmount / fromRate;
                const toAmount = amountInVND * toRate;
                
                converterToAmount.value = toAmount.toFixed(2);
            } else { 
                const toAmount = parseFloat(converterToAmount.value);
                 if (isNaN(toAmount)) {
                    converterFromAmount.value = '';
                    return;
                }
                const fromRate = rates[fromCurrency];
                const toRate = rates[toCurrency];

                const amountInVND = toAmount / toRate;
                const fromAmount = amountInVND * fromRate;
                
                converterFromAmount.value = fromAmount.toFixed(2);
            }
        };

        converterFromAmount.addEventListener('input', () => handleConversion('from'));
        converterToAmount.addEventListener('input', () => handleConversion('to'));
        converterFromSelect.addEventListener('change', () => handleConversion('from'));
        converterToSelect.addEventListener('change', () => handleConversion('from'));
        converterSwapBtn.addEventListener('click', () => {
            const fromVal = converterFromSelect.value;
            converterFromSelect.value = converterToSelect.value;
            converterToSelect.value = fromVal;
            handleConversion('from');
        });
        forexSearchInput.addEventListener('input', renderMarketScreen);
        forexRatesEl.addEventListener('click', (e) => {
            const followBtn = e.target.closest('.follow-currency-btn');
            if (followBtn) {
                const code = followBtn.dataset.code;
                const index = state.followedCurrencies.indexOf(code);
                if (index > -1) {
                    state.followedCurrencies.splice(index, 1);
                } else {
                    state.followedCurrencies.push(code);
                }
                saveData();
                renderMarketScreen();
            }
        });


        refreshMarketDataBtn.addEventListener('click', fetchAllMarketData);
        

        // --- CORE APP LOGIC ---
        const switchScreen = (screenId) => {
            const lastActiveScreen = document.querySelector('.screen.active');
            if (lastActiveScreen) lastActiveScreen.classList.remove('active');
            
            const newScreen = document.getElementById(screenId);
            if(newScreen) newScreen.classList.add('active');

            navItems.forEach(item => {
                item.classList.toggle('active', item.dataset.screen === screenId);
            });
            
            if (screenId === 'market-screen' && !state.marketData.gold) {
                fetchAllMarketData();
            }
            fabContainer.style.display = (screenId === 'ai-assistant-screen') ? 'none' : 'flex';
        };
        const openModal = (modal) => modal.classList.add('visible');
        const closeModal = (modal) => modal.classList.remove('visible');
        const showConfirmation = ({ title, message, okText = 'Đồng ý', cancelText = 'Hủy', onConfirm = () => {} }) => {
            confirmTitleEl.textContent = title;
            confirmMessageEl.textContent = message;
            confirmOkBtn.textContent = okText;
            confirmCancelBtn.textContent = cancelText;
            
            if (okText.toLowerCase().includes('xóa')) {
                 confirmOkBtn.style.backgroundColor = 'var(--expense-color)';
                 confirmOkBtn.style.color = 'white';
            } else {
                 confirmOkBtn.style.backgroundColor = 'var(--primary-color)';
                 const color = state.settings.theme === 'light' ? 'white' : 'var(--background-color)';
                 confirmOkBtn.style.color = color;
            }
            
            confirmCallback = onConfirm;
            confirmCancelBtn.style.display = cancelText ? 'block' : 'none';
            confirmOkBtn.className = cancelText ? 'btn btn-primary w-1/2' : 'btn btn-primary w-full';
            confirmCancelBtn.className = 'btn btn-secondary w-1/2';
            
            openModal(confirmModal);
        };
        
        confirmOkBtn.addEventListener('click', () => { confirmCallback(); closeModal(confirmModal); });
        confirmCancelBtn.addEventListener('click', () => { closeModal(confirmModal); });

        const renderAll = () => { renderDashboard(); renderHistory(); renderWallets(); renderAIChat(); updateWalletFilters(); saveData(); };
        const renderDashboard = () => { const totalBalance = state.wallets.reduce((sum, w) => sum + w.balance, 0); const totalIncome = state.transactions.filter(tx => tx.type === 'income').reduce((sum, tx) => sum + tx.amount, 0); const totalExpense = state.transactions.filter(tx => tx.type === 'expense').reduce((sum, tx) => sum + tx.amount, 0); totalBalanceEl.textContent = formatCurrency(totalBalance); totalIncomeEl.textContent = formatCurrency(totalIncome); totalExpenseEl.textContent = formatCurrency(totalExpense); walletListDashboard.innerHTML = state.wallets.map(wallet => `<div style="background-color: var(--card-background)" class="p-4 rounded-xl flex justify-between items-center"><div class="flex items-center"><div class="w-10 h-10 rounded-full flex items-center justify-center mr-4" style="background-color: var(--background-color);"><i class="fas fa-wallet" style="color:var(--primary-color);"></i></div><div><p class="font-semibold">${wallet.name}</p><p class="text-sm" style="color:var(--text-secondary)">Số dư</p></div></div><p class="font-bold text-lg" style="color: var(--text-primary);">${formatCurrency(wallet.balance)}</p></div>`).join('') || `<p class="text-center py-4" style="color:var(--text-secondary)">Chưa có ví nào.</p>`; const recentTxs = [...state.transactions].reverse().slice(0, 5); recentTransactionsEl.innerHTML = recentTxs.map(tx => createTransactionHTML(tx)).join('') || `<p class="text-center py-4" style="color:var(--text-secondary)">Chưa có giao dịch nào.</p>`; };
        const createTransactionHTML = (tx) => { const wallet = state.wallets.find(w => w.id === tx.walletId); const isIncome = tx.type === 'income'; const color = isIncome ? 'var(--income-color)' : 'var(--expense-color)'; const bgColor = `color-mix(in srgb, ${color} 15%, transparent)`; const icon = tx.category === 'Chuyển tiền đi' || tx.category === 'Nhận tiền' ? 'fa-exchange-alt' : (isIncome ? 'fa-arrow-up' : 'fa-arrow-down'); return `<div style="background-color: transparent" class="transaction-item p-3 rounded-xl flex items-center cursor-pointer" data-id="${tx.id}"><div class="w-10 h-10 rounded-full flex items-center justify-center mr-4" style="background-color: ${bgColor};"><i class="fas ${icon}" style="color: ${color};"></i></div><div class="flex-grow"><p class="font-semibold">${tx.category}</p><p class="text-xs" style="color:var(--text-secondary)">${wallet ? wallet.name : 'Ví đã xóa'} - ${new Date(tx.date).toLocaleDateString('vi-VN')}</p></div><p class="font-bold" style="color: ${isIncome ? 'var(--income-color)' : 'var(--text-primary)'};">${isIncome ? '+' : '-'}${formatCurrency(tx.amount)}</p></div>`; };
        const renderHistory = () => { const filter = historyWalletFilter.value; const filteredTxs = state.transactions.filter(tx => filter === 'all' || tx.walletId == filter); fullTransactionListEl.innerHTML = [...filteredTxs].reverse().map(tx => createTransactionHTML(tx)).join('') || `<p class="text-center py-8" style="color:var(--text-secondary)">Không có giao dịch.</p>`; };
        const renderWallets = () => { walletListManagementEl.innerHTML = state.wallets.map(wallet => `<div style="background-color: var(--card-background)" class="p-4 rounded-xl flex justify-between items-center"><div><p class="font-bold text-lg">${wallet.name}</p><p style="color:var(--primary-color)">${formatCurrency(wallet.balance)}</p></div><div class="flex items-center gap-4"><button class="edit-wallet-btn p-2" data-id="${wallet.id}" style="color:var(--text-secondary);"><i class="fas fa-edit"></i></button><button class="delete-wallet-btn p-2" data-id="${wallet.id}" style="color:var(--text-secondary);"><i class="fas fa-trash-alt"></i></button></div></div>`).join('') || `<p class="text-center py-8" style="color:var(--text-secondary)">Chưa có ví nào.</p>`; };
        const updateWalletOptions = (selectElement) => { selectElement.innerHTML = state.wallets.map(w => `<option value="${w.id}">${w.name}</option>`).join(''); }; const updateWalletFilters = () => { const currentVal = historyWalletFilter.value; historyWalletFilter.innerHTML = '<option value="all">Tất cả ví</option>' + state.wallets.map(w => `<option value="${w.id}">${w.name}</option>`).join(''); historyWalletFilter.value = currentVal; };
        
        navItems.forEach(item => item.addEventListener('click', () => { if(item.dataset.screen) switchScreen(item.dataset.screen); }));
        aiAssistantBtn.addEventListener('click', () => switchScreen('ai-assistant-screen'));
        backFromAiBtn.addEventListener('click', () => switchScreen('dashboard-screen'));

        const handleAddExpense = () => { if (state.wallets.length === 0) { showConfirmation({title: 'Chưa có ví', message: 'Bạn cần tạo ví trước khi thực hiện giao dịch.', okText: 'OK', cancelText: null}); return; } fabContainer.classList.remove('active'); fabBackdrop.classList.remove('active'); updateWalletOptions(walletSelect); transactionForm.reset(); transactionType = 'expense'; typeExpenseBtn.style.backgroundColor = 'var(--expense-color)'; typeExpenseBtn.style.color = 'white'; typeIncomeBtn.style.backgroundColor = 'var(--border-color)'; typeIncomeBtn.style.color = 'var(--text-secondary)'; openModal(addTransactionModal); };
        const handleAddIncome = () => { if (state.wallets.length === 0) { showConfirmation({title: 'Chưa có ví', message: 'Bạn cần tạo ví trước khi thực hiện giao dịch.', okText: 'OK', cancelText: null}); return; } fabContainer.classList.remove('active'); fabBackdrop.classList.remove('active'); updateWalletOptions(walletSelect); transactionForm.reset(); transactionType = 'income'; typeIncomeBtn.style.backgroundColor = 'var(--income-color)'; typeIncomeBtn.style.color = 'white'; typeExpenseBtn.style.backgroundColor = 'var(--border-color)'; typeExpenseBtn.style.color = 'var(--text-secondary)'; openModal(addTransactionModal); };
        const handleTransfer = () => { fabContainer.classList.remove('active'); fabBackdrop.classList.remove('active'); if (state.wallets.length < 2) { showConfirmation({title: 'Yêu cầu 2 ví', message: 'Bạn cần có ít nhất 2 ví để thực hiện chuyển tiền.', okText: 'OK', cancelText: null}); return; } transferForm.reset(); const fromWalletSelect = document.getElementById('from-wallet-select'); const toWalletSelect = document.getElementById('to-wallet-select'); updateWalletOptions(fromWalletSelect); updateWalletOptions(toWalletSelect); if (fromWalletSelect.options.length > 1) { toWalletSelect.selectedIndex = 1; } openModal(transferModal); };
        
        fabMain.addEventListener('click', () => { fabContainer.classList.toggle('active'); fabBackdrop.classList.toggle('active');});
        fabBackdrop.addEventListener('click', () => { fabContainer.classList.remove('active'); fabBackdrop.classList.remove('active'); });
        fabActionExpense.addEventListener('click', handleAddExpense);
        fabActionIncome.addEventListener('click', handleAddIncome);
        fabActionTransfer.addEventListener('click', handleTransfer);

        document.getElementById('quick-action-expense').addEventListener('click', handleAddExpense); document.getElementById('quick-action-income').addEventListener('click', handleAddIncome); document.getElementById('quick-action-transfer').addEventListener('click', handleTransfer);
        document.getElementById('add-wallet-btn-dashboard').addEventListener('click', () => openModal(addWalletModal)); document.getElementById('add-wallet-btn-wallets').addEventListener('click', () => openModal(addWalletModal));
        document.getElementById('cancel-transaction').addEventListener('click', () => closeModal(addTransactionModal)); document.getElementById('cancel-wallet').addEventListener('click', () => closeModal(addWalletModal)); document.getElementById('cancel-edit-wallet').addEventListener('click', () => closeModal(editWalletModal)); document.getElementById('cancel-edit-transaction').addEventListener('click', () => closeModal(editTransactionModal)); document.getElementById('cancel-transfer').addEventListener('click', () => closeModal(transferModal)); document.getElementById('reset-data-btn').addEventListener('click', () => { showConfirmation({ title: 'Xóa Toàn Bộ Dữ Liệu?', message: 'Hành động này không thể hoàn tác. Bạn có chắc chắn muốn xóa tất cả ví và giao dịch không?', okText: 'Xóa Hết', onConfirm: () => { localStorage.removeItem('financeAppState_v2.10'); window.location.reload(); } }); });
        historyWalletFilter.addEventListener('change', renderHistory);
        const renderAIChat = () => { aiChatHistoryEl.innerHTML = state.aiChatHistory.map(msg => `<div class="chat-bubble ${msg.role === 'user' ? 'user-bubble' : 'bot-bubble'}">${msg.text.replace(/\n/g, '<br>')}</div>`).join(''); if(aiChatHistoryEl.scrollHeight > aiChatHistoryEl.clientHeight) { aiChatHistoryEl.scrollTop = aiChatHistoryEl.scrollHeight; } };
        aiChatForm.addEventListener('submit', async (e) => { e.preventDefault(); const userInput = aiChatInput.value.trim(); if (!userInput) return; state.aiChatHistory.push({ role: 'user', text: userInput }); renderAIChat(); aiChatInput.value = ''; state.aiChatHistory.push({ role: 'bot', text: '...' }); renderAIChat(); try { const totalBalance = state.wallets.reduce((sum, w) => sum + w.balance, 0); const financialSummary = `Dữ liệu tài chính của người dùng:\n- Tổng số dư: ${formatCurrency(totalBalance)}\n- Tổng số ví: ${state.wallets.length}\n- Tên các ví: ${state.wallets.map(w => `${w.name} (${formatCurrency(w.balance)})`).join(', ')}\n- 5 giao dịch gần nhất:\n${[...state.transactions].reverse().slice(0, 5).map(tx => `  - ${tx.type === 'income' ? 'Thu' : 'Chi'} ${formatCurrency(tx.amount)} cho ${tx.category}`).join('\n')}`; const systemPrompt = "Bạn là một trợ lý tài chính thân thiện, thông minh. Trả lời câu hỏi của người dùng dựa trên dữ liệu tài chính của họ. Đưa ra phân tích ngắn gọn, lời khuyên thực tế bằng tiếng Việt."; const userQuery = `${financialSummary}\n\nCâu hỏi: "${userInput}"`; const apiKey = ""; const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${apiKey}`; const payload = { contents: [{ parts: [{ text: userQuery }] }], systemInstruction: { parts: [{ text: systemPrompt }] }, }; const response = await fetch(apiUrl, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) }); if (!response.ok) throw new Error(`API error: ${response.statusText}`); const result = await response.json(); const botResponse = result.candidates[0].content.parts[0].text; state.aiChatHistory.pop(); state.aiChatHistory.push({ role: 'bot', text: botResponse }); } catch (error) { console.error("AI Chat Error:", error); state.aiChatHistory.pop(); state.aiChatHistory.push({ role: 'bot', text: 'Xin lỗi, tôi gặp sự cố kết nối. Vui lòng thử lại sau.' }); } renderAIChat(); saveData(); });
        typeExpenseBtn.addEventListener('click', () => { transactionType = 'expense'; typeExpenseBtn.style.backgroundColor = 'var(--expense-color)'; typeExpenseBtn.style.color = 'white'; typeIncomeBtn.style.backgroundColor = 'var(--border-color)'; typeIncomeBtn.style.color = 'var(--text-secondary)'; }); typeIncomeBtn.addEventListener('click', () => { transactionType = 'income'; typeIncomeBtn.style.backgroundColor = 'var(--income-color)'; typeIncomeBtn.style.color = 'white'; typeExpenseBtn.style.backgroundColor = 'var(--border-color)'; typeExpenseBtn.style.color = 'var(--text-secondary)'; });
        transactionForm.addEventListener('submit', (e) => { e.preventDefault(); const amount = parseFloat(amountInput.value); const walletId = parseInt(walletSelect.value); const wallet = state.wallets.find(w => w.id === walletId); if (!wallet) return; state.transactions.push({id: Date.now(), type: transactionType, amount, category: categoryInput.value, walletId, description: descriptionInput.value, date: new Date().toISOString()}); wallet.balance += (transactionType === 'income' ? amount : -amount); closeModal(addTransactionModal); renderAll(); });
        walletForm.addEventListener('submit', (e) => { e.preventDefault(); state.wallets.push({id: Date.now(), name: document.getElementById('wallet-name').value, balance: parseFloat(document.getElementById('initial-balance').value) || 0}); walletForm.reset(); closeModal(addWalletModal); renderAll(); });
        transferForm.addEventListener('submit', (e) => { e.preventDefault(); const amount = parseFloat(document.getElementById('transfer-amount').value); const fromWalletId = parseInt(document.getElementById('from-wallet-select').value); const toWalletId = parseInt(document.getElementById('to-wallet-select').value); const description = document.getElementById('transfer-description').value; if (fromWalletId === toWalletId) { showConfirmation({title: 'Lỗi', message: 'Ví nguồn và ví đích không được trùng nhau.', okText: 'OK', cancelText: null}); return; } const fromWallet = state.wallets.find(w => w.id === fromWalletId); const toWallet = state.wallets.find(w => w.id === toWalletId); if (!fromWallet || !toWallet || !amount || amount <= 0) { return; } const now = new Date().toISOString(); const commonDesc = description || `Từ ${fromWallet.name} đến ${toWallet.name}`; state.transactions.push({id: Date.now(), type: 'expense', amount: amount, category: 'Chuyển tiền đi', walletId: fromWalletId, description: commonDesc, date: now}); fromWallet.balance -= amount; state.transactions.push({id: Date.now() + 1, type: 'income', amount: amount, category: 'Nhận tiền', walletId: toWalletId, description: commonDesc, date: now}); toWallet.balance += amount; closeModal(transferModal); renderAll(); });
        function openEditWalletModal(walletId) { state.editingWalletId = walletId; const wallet = state.wallets.find(w => w.id === walletId); if(wallet) { editWalletNameInput.value = wallet.name; editWalletBalanceInput.value = wallet.balance; openModal(editWalletModal); } }
        function openEditTransactionModal(txId) { state.editingTransactionId = txId; const tx = state.transactions.find(t => t.id === txId); if(!tx || tx.category === "Điều chỉnh số dư" || tx.category === "Chuyển tiền đi" || tx.category === "Nhận tiền") { showConfirmation({title: 'Thông Báo', message: 'Giao dịch "Điều chỉnh số dư" và "Chuyển tiền" không thể chỉnh sửa.', okText: 'OK', cancelText: null}); return; }; const editAmount = document.getElementById('edit-amount'); const editCategory = document.getElementById('edit-category'); const editWalletSelect = document.getElementById('edit-wallet-select'); const editDescription = document.getElementById('edit-description'); const editTypeExpense = document.getElementById('edit-type-expense'); const editTypeIncome = document.getElementById('edit-type-income'); updateWalletOptions(editWalletSelect); editAmount.value = tx.amount; editCategory.value = tx.category; editWalletSelect.value = tx.walletId; editDescription.value = tx.description; editTransactionType = tx.type; if (tx.type === 'income') { editTypeIncome.style.backgroundColor = 'var(--income-color)'; editTypeIncome.style.color = 'white'; editTypeExpense.style.backgroundColor = 'var(--border-color)'; editTypeExpense.style.color = 'var(--text-secondary)'; } else { editTypeExpense.style.backgroundColor = 'var(--expense-color)'; editTypeExpense.style.color = 'white'; editTypeIncome.style.backgroundColor = 'var(--border-color)'; editTypeIncome.style.color = 'var(--text-secondary)'; } openModal(editTransactionModal); }
        document.getElementById('edit-type-expense').addEventListener('click', () => { editTransactionType = 'expense'; document.getElementById('edit-type-expense').style.backgroundColor = 'var(--expense-color)'; document.getElementById('edit-type-expense').style.color = 'white'; document.getElementById('edit-type-income').style.backgroundColor = 'var(--border-color)'; document.getElementById('edit-type-income').style.color = 'var(--text-secondary)'; }); document.getElementById('edit-type-income').addEventListener('click', () => { editTransactionType = 'income'; document.getElementById('edit-type-income').style.backgroundColor = 'var(--income-color)'; document.getElementById('edit-type-income').style.color = 'white'; document.getElementById('edit-type-expense').style.backgroundColor = 'var(--border-color)'; document.getElementById('edit-type-expense').style.color = 'var(--text-secondary)'; });
        editWalletForm.addEventListener('submit', (e) => { e.preventDefault(); const wallet = state.wallets.find(w => w.id === state.editingWalletId); if (wallet) { const newName = editWalletNameInput.value; const newBalance = parseFloat(editWalletBalanceInput.value); const oldBalance = wallet.balance; const adjustment = newBalance - oldBalance; if (adjustment !== 0) { const adjustmentType = adjustment > 0 ? 'income' : 'expense'; const adjustmentAmount = Math.abs(adjustment); state.transactions.push({id: Date.now(), type: adjustmentType, amount: adjustmentAmount, category: "Điều chỉnh số dư", walletId: wallet.id, description: `Từ ${formatCurrency(oldBalance)} thành ${formatCurrency(newBalance)}`, date: new Date().toISOString()}); } wallet.name = newName; wallet.balance = newBalance; } closeModal(editWalletModal); renderAll(); });
        editTransactionForm.addEventListener('submit', (e) => { e.preventDefault(); const txIndex = state.transactions.findIndex(t => t.id === state.editingTransactionId); if (txIndex === -1) return; const originalTx = { ...state.transactions[txIndex] }; const originalWallet = state.wallets.find(w => w.id === originalTx.walletId); if (originalWallet) { originalWallet.balance += originalTx.type === 'expense' ? originalTx.amount : -originalTx.amount; } const newAmount = parseFloat(document.getElementById('edit-amount').value); const newWalletId = parseInt(document.getElementById('edit-wallet-select').value); const newWallet = state.wallets.find(w => w.id === newWalletId); if(newWallet) { newWallet.balance += editTransactionType === 'income' ? newAmount : -newAmount; } state.transactions[txIndex] = {...originalTx, type: editTransactionType, amount: newAmount, category: document.getElementById('edit-category').value, walletId: newWalletId, description: document.getElementById('edit-description').value}; closeModal(editTransactionModal); renderAll(); });
        document.getElementById('delete-transaction-btn').addEventListener('click', () => { showConfirmation({ title: 'Xóa Giao Dịch?', message: 'Bạn có chắc chắn muốn xóa vĩnh viễn giao dịch này không?', okText: 'Xóa', onConfirm: () => { const txIndex = state.transactions.findIndex(t => t.id === state.editingTransactionId); if (txIndex === -1) return; const txToDelete = state.transactions[txIndex]; const wallet = state.wallets.find(w => w.id === txToDelete.walletId); if (wallet) { wallet.balance += txToDelete.type === 'expense' ? txToDelete.amount : -txToDelete.amount; } state.transactions.splice(txIndex, 1); closeModal(editTransactionModal); renderAll(); } }); });
        walletListManagementEl.addEventListener('click', (e) => { const editBtn = e.target.closest('.edit-wallet-btn'); const deleteBtn = e.target.closest('.delete-wallet-btn'); if (editBtn) { openEditWalletModal(parseInt(editBtn.dataset.id)); } if (deleteBtn) { const walletId = parseInt(deleteBtn.dataset.id); const wallet = state.wallets.find(w => w.id === walletId); const txCount = state.transactions.filter(tx => tx.walletId === walletId).length; showConfirmation({ title: `Xóa Ví "${wallet.name}"?`, message: `HÀNH ĐỘNG NÀY SẼ XÓA VĨNH VIỄN ${txCount} GIAO DỊCH LIÊN QUAN.\nBạn có chắc chắn không?`, okText: 'Xóa', onConfirm: () => { state.transactions = state.transactions.filter(tx => tx.walletId !== walletId); state.wallets = state.wallets.filter(w => w.id !== walletId); renderAll(); } }); } });
        function handleTransactionClick(event) { const item = event.target.closest('.transaction-item'); if (item) { openEditTransactionModal(parseInt(item.dataset.id)); } }
        fullTransactionListEl.addEventListener('click', handleTransactionClick); recentTransactionsEl.addEventListener('click', handleTransactionClick);
        const exportBtn = document.getElementById('export-data-btn'); const importBtn = document.getElementById('import-data-btn'); const importFileInput = document.getElementById('import-file-input');
        exportBtn.addEventListener('click', () => { const dataStr = JSON.stringify(state, null, 2); const dataBlob = new Blob([dataStr], { type: 'application/json' }); const url = URL.createObjectURL(dataBlob); const link = document.createElement('a'); link.href = url; link.download = `tro-ly-tai-chinh-data-${new Date().toISOString().split('T')[0]}.json`; link.click(); URL.revokeObjectURL(url); });
        importBtn.addEventListener('click', () => importFileInput.click()); importFileInput.addEventListener('change', (event) => { const file = event.target.files[0]; if (!file) return; showConfirmation({ title: 'Nhập Dữ Liệu', message: 'Nhập dữ liệu sẽ ghi đè lên tất cả dữ liệu hiện tại. Bạn có chắc chắn muốn tiếp tục?', okText: 'Nhập', onConfirm: () => { const reader = new FileReader(); reader.onload = (e) => { try { const importedState = JSON.parse(e.target.result); if (importedState.wallets && importedState.transactions && importedState.settings) { state = importedState; if(!state.aiChatHistory) state.aiChatHistory = []; applyTheme(state.settings.theme || 'dark'); currencySelect.value = state.settings.currency; renderAll(); } else { showConfirmation({title: 'Lỗi', message: 'Tệp dữ liệu không hợp lệ.', okText: 'OK', cancelText: null, onConfirm: () => {}}); } } catch (error) { showConfirmation({title: 'Lỗi', message: 'Không thể đọc tệp. Tệp có thể bị hỏng.', okText: 'OK', cancelText: null, onConfirm: () => {}}); console.error("Import error:", error); } }; reader.readAsText(file); } }); importFileInput.value = ''; });

        // INITIAL LOAD
        loadData();
        renderAll();
    });
    </script>
</body>
</html>

