<!DOCTYPE html>
<html lang="vi">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="theme-color" content="#84cc16">
    <meta name="description" content="LimeWallet Pro - Quản lý thu chi offline">
    <title>LimeWallet Pro - Offline</title>
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="mobile-web-app-capable" content="yes">
    <link rel="icon" href="/Asset/logo/iconApps.png" />
    <link rel="apple-touch-icon" href="/Asset/logo/iconApps.png" sizes="150x150" />

    <meta property="og:image" content="/Asset/Banner/Banner.png" />
    <meta property="og:title" content="Share&Go" />
    <meta property="og:description" content="Thiết kế và lập trình Đinh Mạnh Hùng" />

    <!-- PWA Manifest -->
    <link rel="manifest" href="manifest.json">

    <!-- LIBRARIES -->
    <!-- Sử dụng CDN để chạy ngay lập tức. Khi deploy offline thực tế, bạn có thể tải file về và thay đường dẫn -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Be+Vietnam+Pro:wght@400;500;600;700&display=swap"
        rel="stylesheet">

    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        lime: { 50: '#f7fee7', 100: '#ecfccb', 400: '#a3e635', 500: '#84cc16', 600: '#65a30d', 900: '#365314' },
                        dark: { bg: '#111827', card: '#1f2937', input: '#374151', text: '#f3f4f6', subtext: '#9ca3af' }
                    },
                    fontFamily: { sans: ['"Be Vietnam Pro"', 'sans-serif'] }
                }
            }
        }
    </script>
    <style>
        body {
            font-family: 'Be Vietnam Pro', sans-serif;
            -webkit-tap-highlight-color: transparent;
        }

        .hide-scrollbar::-webkit-scrollbar {
            display: none;
        }

        .hide-scrollbar {
            -ms-overflow-style: none;
            scrollbar-width: none;
        }

        .wallet-card {
            transition: transform 0.2s;
        }

        .wallet-card:active {
            transform: scale(0.98);
        }

        .message-bubble {
            max-width: 85%;
            border-radius: 1.2rem;
            padding: 0.75rem 1rem;
            position: relative;
            margin-bottom: 0.5rem;
        }

        .message-user {
            background-color: #84cc16;
            color: white;
            margin-left: auto;
            border-bottom-right-radius: 0.25rem;
        }

        .message-bot {
            background-color: #f3f4f6;
            color: #1f2937;
            margin-right: auto;
            border-bottom-left-radius: 0.25rem;
        }

        .dark .message-bot {
            background-color: #374151;
            color: #f3f4f6;
        }

        .anim-pop {
            animation: popIn 0.2s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }

        @keyframes popIn {
            0% {
                opacity: 0;
                transform: translateY(10px);
            }

            100% {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .pie-chart {
            width: 180px;
            height: 180px;
            border-radius: 50%;
            position: relative;
            margin: 0 auto;
            transition: background 0.5s;
        }

        .pie-center {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 70%;
            height: 70%;
            background: white;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-direction: column;
            box-shadow: inset 0 2px 5px rgba(0, 0, 0, 0.05);
        }

        .dark .pie-center {
            background: #1f2937;
            color: white;
            box-shadow: inset 0 2px 5px rgba(0, 0, 0, 0.2);
        }

        .loading {
            opacity: 0.5;
            pointer-events: none;
        }

        .highlight {
            background-color: #f0fdf4;
            border-color: #84cc16 !important;
        }

        .dark .highlight {
            background-color: #064e3b;
            border-color: #84cc16 !important;
        }

        .tooltip {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 8px 16px;
            border-radius: 8px;
            font-size: 12px;
            pointer-events: none;
            opacity: 0;
            transition: opacity 0.2s;
            z-index: 1000;
        }

        .tooltip.show {
            opacity: 1;
        }

        .chat-option-btn {
            border: 1px solid #e5e7eb;
            padding: 8px 12px;
            border-radius: 20px;
            font-size: 12px;
            background: white;
            color: #374151;
            transition: all 0.2s;
            white-space: nowrap;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .chat-option-btn:hover,
        .chat-option-btn:active {
            background: #ecfccb;
            border-color: #84cc16;
            color: #365314;
        }

        .dark .chat-option-btn {
            background: #374151;
            color: #e5e7eb;
            border-color: #4b5563;
        }

        .dark .chat-option-btn:hover {
            background: #065f46;
            border-color: #34d399;
            color: white;
        }

        .template-pill {
            background: #f0fdf4;
            border-color: #86efac;
            color: #166534;
        }

        .template-pill:hover {
            background: #dcfce7;
        }

        .dark .template-pill {
            background: #064e3b;
            border-color: #059669;
            color: #d1fae5;
        }

        .dark .template-pill:hover {
            background: #065f46;
        }

        .template-delete {
            width: 16px;
            height: 16px;
            background: #ef4444;
            color: white;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 8px;
            opacity: 0.7;
        }

        .report-tab {
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 13px;
            font-weight: 600;
            color: #6b7280;
            transition: all 0.2s;
        }

        .report-tab.active {
            background-color: #ecfccb;
            color: #365314;
        }

        .dark .report-tab {
            color: #9ca3af;
        }

        .dark .report-tab.active {
            background-color: #3f6212;
            color: #ecfccb;
        }

        .bar-fill {
            transition: height 1s ease-out;
        }
    </style>
</head>

<body
    class="bg-gray-50 text-gray-800 h-screen overflow-hidden flex flex-col dark:bg-dark-bg dark:text-dark-text transition-colors duration-300">

    <!-- HEADER -->
    <header class="bg-white pt-4 pb-2 px-6 shadow-sm z-10 sticky top-0 dark:bg-dark-card dark:border-gray-700">
        <div class="flex justify-between items-center mb-4">
            <div class="flex items-center gap-2">
                <div
                    class="w-8 h-8 bg-lime-500 rounded-full flex items-center justify-center text-white font-bold shadow-lg shadow-lime-200 dark:shadow-none">
                    <i class="fas fa-leaf"></i>
                </div>
                <h1 class="text-xl font-bold text-gray-800 dark:text-white">Lime<span
                        class="text-lime-600 dark:text-lime-400">Wallet</span></h1>
            </div>
            <div class="flex gap-3">
                <button onclick="toggleModal('settingsModal')"
                    class="text-gray-400 hover:text-gray-600 dark:hover:text-gray-200"><i
                        class="fas fa-cog text-lg"></i></button>
            </div>
        </div>

        <!-- Total Balance -->
        <div
            class="bg-gradient-to-br from-lime-500 to-lime-600 rounded-2xl p-5 text-white shadow-lg shadow-lime-200 transform transition-all hover:scale-[1.01] dark:shadow-none">
            <div class="flex justify-between items-start mb-2">
                <p class="text-lime-100 text-xs font-medium">Tổng tài sản</p>
                <span id="dateRangeDisplay" class="bg-white/20 px-2 rounded text-[10px] py-0.5">Tháng này</span>
            </div>
            <div class="grid grid-cols-2 gap-4 mt-1">
                <div>
                    <p class="text-[10px] text-lime-200 uppercase tracking-wide">VND</p>
                    <h2 class="text-2xl font-bold truncate" id="totalVND">0 đ</h2>
                </div>
                <div class="border-l border-lime-400 pl-4">
                    <p class="text-[10px] text-lime-200 uppercase tracking-wide">JPY</p>
                    <h2 class="text-2xl font-bold truncate" id="totalJPY">¥0</h2>
                </div>
            </div>
            <div class="flex mt-4 gap-4 text-sm">
                <div
                    class="bg-white/20 rounded-lg px-3 py-1 flex items-center gap-2 backdrop-blur-sm flex-1 justify-center">
                    <i class="fas fa-arrow-down text-lime-100"></i>
                    <span id="monthlyIncome">0</span>
                </div>
                <div
                    class="bg-white/20 rounded-lg px-3 py-1 flex items-center gap-2 backdrop-blur-sm flex-1 justify-center">
                    <i class="fas fa-arrow-up text-orange-200"></i>
                    <span id="monthlyExpense">0</span>
                </div>
            </div>
        </div>
    </header>

    <!-- MAIN CONTENT -->
    <main class="flex-1 overflow-y-auto overflow-x-hidden pb-24 hide-scrollbar px-4" id="mainView">
        <!-- Wallets Section -->
        <div class="mt-6">
            <div class="flex justify-between items-center mb-3 px-1">
                <h3 class="font-bold text-gray-700 dark:text-gray-200">Ví của bạn</h3>
                <button onclick="openWalletModal()"
                    class="text-lime-600 text-sm font-medium hover:underline dark:text-lime-400">+ Thêm ví</button>
            </div>
            <div class="flex gap-4 overflow-x-auto hide-scrollbar pb-4" id="walletList"></div>
        </div>

        <!-- Transaction History Header with Filter -->
        <div class="flex justify-between items-center mb-3 px-1 mt-6">
            <h3 class="font-bold text-gray-700 dark:text-gray-200">Lịch sử giao dịch</h3>
            <select id="txLimit" onchange="renderTransactions()"
                class="bg-gray-100 border-none text-xs rounded-lg px-2 py-1 text-gray-500 outline-none focus:ring-0 dark:bg-gray-800 dark:text-gray-300">
                <option value="10">10 mới nhất</option>
                <option value="30">30 mới nhất</option>
                <option value="all">Tất cả</option>
            </select>
        </div>

        <!-- Transaction List -->
        <div id="transactionList" class="space-y-3 pb-20"></div>
    </main>

    <!-- NAV MENU -->
    <nav
        class="fixed bottom-0 left-0 right-0 bg-white border-t border-gray-200 pb-safe dark:bg-dark-card dark:border-gray-800 z-40 h-16">
        <div class="flex justify-around items-center h-full">
            <button onclick="scrollToTop()"
                class="flex flex-col items-center justify-center w-full h-full text-lime-600 dark:text-lime-400">
                <i class="fas fa-home text-lg mb-1"></i>
                <span class="text-[10px]">Home</span>
            </button>
            <button onclick="openReportModal()"
                class="flex flex-col items-center justify-center w-full h-full text-gray-400 hover:text-lime-600 dark:text-gray-500 dark:hover:text-lime-400">
                <i class="fas fa-chart-pie text-lg mb-1"></i>
                <span class="text-[10px]">Báo cáo</span>
            </button>
            <div class="relative -top-6">
                <button onclick="toggleAddMenu()"
                    class="w-14 h-14 rounded-full bg-lime-500 text-white shadow-lg flex items-center justify-center transform transition-transform active:scale-95 border-4 border-gray-50 dark:border-dark-bg">
                    <i class="fas fa-plus text-xl"></i>
                </button>
            </div>
            <button onclick="toggleModal('exchangeModal')"
                class="flex flex-col items-center justify-center w-full h-full text-gray-400 hover:text-lime-600 dark:text-gray-500 dark:hover:text-lime-400">
                <i class="fas fa-calculator text-lg mb-1"></i>
                <span class="text-[10px]">Tỷ giá</span>
            </button>
            <button onclick="openChat()"
                class="flex flex-col items-center justify-center w-full h-full text-gray-400 hover:text-lime-600 dark:text-gray-500 dark:hover:text-lime-400">
                <i class="fas fa-robot text-lg mb-1"></i>
                <span class="text-[10px]">Chat AI</span>
            </button>
        </div>
    </nav>

    <!-- ADD MENU OVERLAY -->
    <div id="addMenuOverlay" class="fixed inset-0 bg-black/50 z-50 hidden flex items-end justify-center pb-24 anim-pop"
        onclick="toggleAddMenu()">
        <div class="flex gap-8" onclick="event.stopPropagation()">
            <button onclick="openTransactionModal('income'); toggleAddMenu()"
                class="flex flex-col items-center gap-2 group">
                <div
                    class="w-16 h-16 rounded-full bg-green-500 text-white flex items-center justify-center shadow-xl group-active:scale-95 transition-all border-4 border-white dark:border-gray-800">
                    <i class="fas fa-arrow-down text-2xl"></i></div>
                <span class="text-white font-bold text-sm drop-shadow-md bg-black/30 px-2 rounded">Thu Nhập</span>
            </button>
            <button onclick="openTransactionModal('expense'); toggleAddMenu()"
                class="flex flex-col items-center gap-2 group">
                <div
                    class="w-16 h-16 rounded-full bg-red-500 text-white flex items-center justify-center shadow-xl group-active:scale-95 transition-all border-4 border-white dark:border-gray-800">
                    <i class="fas fa-arrow-up text-2xl"></i></div>
                <span class="text-white font-bold text-sm drop-shadow-md bg-black/30 px-2 rounded">Chi Tiêu</span>
            </button>
        </div>
    </div>

    <!-- EXCHANGE RATE MODAL -->
    <div id="exchangeModal"
        class="hidden fixed inset-0 bg-black/50 z-50 flex items-center justify-center p-4 backdrop-blur-sm">
        <div
            class="bg-white rounded-2xl w-full max-w-sm p-6 shadow-2xl anim-pop h-[90vh] overflow-y-auto hide-scrollbar dark:bg-dark-card">
            <div class="flex justify-between items-start mb-4">
                <div>
                    <h3 class="text-lg font-bold text-gray-800 dark:text-white">Tính Tỷ Giá Smiles</h3>
                    <p class="text-xs text-gray-500 dark:text-gray-400" id="lastUpdatedTime">Đang cập nhật...</p>
                </div>
                <button onclick="toggleModal('exchangeModal')" class="text-gray-400"><i
                        class="fas fa-times"></i></button>
            </div>
            <div
                class="bg-blue-50 p-4 rounded-xl border border-blue-100 mb-4 flex justify-between items-center dark:bg-blue-900/30 dark:border-blue-800">
                <div>
                    <p class="text-xs text-blue-500 font-bold uppercase dark:text-blue-400">Tỷ giá hiện tại</p>
                    <h2 class="text-2xl font-bold text-blue-700 dark:text-blue-300" id="rateDisplay">Loading...</h2>
                </div>
                <button id="btnRefresh" onclick="forceUpdateRate()"
                    class="w-10 h-10 bg-white rounded-full shadow-sm text-blue-500 hover:text-blue-700 active:scale-95 flex items-center justify-center transition-transform dark:bg-gray-700 dark:text-blue-400"><i
                        class="fas fa-sync-alt"></i></button>
            </div>
            <div class="mb-6">
                <div class="flex items-center justify-between mb-1"><span id="modeLabel"
                        class="text-sm font-bold text-gray-600 dark:text-gray-300">Chế độ: Thường</span><label
                        class="relative inline-flex items-center cursor-pointer"><input type="checkbox" id="modeToggle"
                            class="sr-only peer" onchange="toggleMode()">
                        <div
                            class="w-11 h-6 bg-gray-200 peer-focus:outline-none rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-lime-500 dark:bg-gray-600">
                        </div>
                    </label></div>
                <p id="modeSub" class="text-xs text-gray-400">Nhập số tiền muốn gửi đi</p>
            </div>
            <div class="space-y-4">
                <div id="containerJPY"
                    class="p-3 bg-gray-50 rounded-xl border border-gray-200 transition-colors dark:bg-gray-800 dark:border-gray-600">
                    <label id="labelJPY" class="text-xs font-bold text-gray-500 block mb-1 dark:text-gray-400">Bạn gửi
                        đi (Tiền gốc JPY)</label><input type="text" inputmode="numeric" id="inputJPY"
                        class="w-full bg-transparent text-2xl font-bold outline-none text-gray-800 dark:text-white"
                        placeholder="0" oninput="formatCurrencyInput(this)"></div>
                <div class="p-3 bg-gray-50 rounded-xl border border-gray-200 dark:bg-gray-800 dark:border-gray-600">
                    <label class="text-xs font-bold text-gray-500 block mb-1 dark:text-gray-400">Người nhận được
                        (VND)</label><input type="text" inputmode="numeric" id="inputVND"
                        class="w-full bg-transparent text-2xl font-bold outline-none text-green-600" placeholder="0"
                        oninput="formatCurrencyInput(this)"></div>
                <div class="p-3 bg-gray-50 rounded-xl border border-gray-200 dark:bg-gray-800 dark:border-gray-600">
                    <label class="text-xs font-bold text-gray-500 block mb-1 dark:text-gray-400">Dùng điểm thưởng
                        (Points)</label><input type="text" inputmode="numeric" id="inputPoints"
                        class="w-full bg-transparent text-lg font-medium outline-none text-orange-500" placeholder="0"
                        oninput="formatCurrencyInput(this)"></div>
            </div>
            <div class="mt-6 space-y-3 border-t pt-4 dark:border-gray-700">
                <div class="flex justify-between items-center text-sm"><span
                        class="text-gray-500 dark:text-gray-400">Phí chuyển tiền</span><span
                        class="font-bold text-gray-800 dark:text-gray-200" id="feeDisplay">¥0</span></div>
                <div class="flex justify-between items-center text-sm"><span
                        class="text-gray-500 dark:text-gray-400">Điểm thưởng nhận được</span><span
                        class="font-bold text-green-600 dark:text-green-400" id="pointDisplay">+0 pts</span></div>
                <div id="rowRealSend" class="flex justify-between items-center text-sm hidden"><span
                        class="text-gray-500 dark:text-gray-400">Tiền thực gửi (Sau khi trừ phí)</span><span
                        class="font-bold text-blue-600 dark:text-blue-400" id="realSendDisplay">¥0</span></div>
                <div class="bg-lime-50 p-4 rounded-xl mt-4 dark:bg-lime-900/30">
                    <p class="text-xs text-lime-700 mb-1 dark:text-lime-300" id="labelTotal">Tổng thanh toán (Gốc + Phí
                        - Điểm)</p>
                    <div class="flex justify-between items-end">
                        <h2 class="text-3xl font-bold text-lime-700 dark:text-lime-400" id="totalPayDisplay">¥0</h2>
                        <button onclick="copyContent('totalPayDisplay', 'tooltipCopy')"
                            class="text-lime-600 hover:text-lime-800 text-sm font-bold bg-white px-3 py-1 rounded-lg shadow-sm dark:bg-gray-700 dark:text-lime-400">Copy</button>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div id="tooltipCopy" class="tooltip">Đã sao chép!</div>

    <!-- WALLET MODAL -->
    <div id="walletModal"
        class="hidden fixed inset-0 bg-black/50 z-50 flex items-center justify-center p-4 backdrop-blur-sm">
        <div class="bg-white rounded-2xl w-full max-w-sm p-6 shadow-2xl anim-pop dark:bg-dark-card">
            <h3 class="text-lg font-bold mb-4 text-center dark:text-white" id="walletModalTitle">Tạo Ví Mới</h3>
            <input type="hidden" id="walletEditId">
            <div class="space-y-4">
                <div><label class="text-xs font-bold text-gray-500 uppercase dark:text-gray-400">Tên Ví</label><input
                        type="text" id="walletNameInput"
                        class="w-full border-b-2 border-gray-200 focus:border-lime-500 outline-none py-2 text-lg dark:bg-transparent dark:text-white dark:border-gray-600"
                        placeholder="VD: Ví Tiền Mặt"></div>
                <div class="flex gap-4">
                    <div class="flex-1"><label class="text-xs font-bold text-gray-500 uppercase dark:text-gray-400">Số
                            dư</label><input type="text" inputmode="numeric" id="walletBalanceInput"
                            class="w-full border-b-2 border-gray-200 focus:border-lime-500 outline-none py-2 text-lg dark:bg-transparent dark:text-white dark:border-gray-600"
                            placeholder="0" oninput="formatCurrencyInput(this)"></div>
                    <div class="w-1/3"><label class="text-xs font-bold text-gray-500 uppercase dark:text-gray-400">Đơn
                            vị</label><select id="walletCurrencyInput"
                            class="w-full border-b-2 border-gray-200 bg-transparent py-2 text-lg outline-none font-bold text-gray-700 dark:text-white dark:border-gray-600">
                            <option value="VND">VND</option>
                            <option value="JPY">JPY</option>
                        </select></div>
                </div>
                <div><label class="text-xs font-bold text-gray-500 uppercase dark:text-gray-400">Loại Ví</label>
                    <div class="flex gap-3 mt-2 overflow-x-auto pb-2">
                        <div class="cursor-pointer p-2 rounded-lg border-2 border-transparent hover:border-lime-500 bg-gray-50 text-center min-w-[60px] dark:bg-gray-700"
                            onclick="selectIcon(this, 'fa-wallet')"><i
                                class="fas fa-wallet text-xl text-gray-600 mb-1 dark:text-gray-300"></i>
                            <div class="text-[10px] dark:text-gray-300">Thường</div>
                        </div>
                        <div class="cursor-pointer p-2 rounded-lg border-2 border-transparent hover:border-lime-500 bg-gray-50 text-center min-w-[60px] dark:bg-gray-700"
                            onclick="selectIcon(this, 'fa-credit-card')"><i
                                class="fas fa-credit-card text-xl text-blue-500 mb-1"></i>
                            <div class="text-[10px] dark:text-gray-300">Thẻ</div>
                        </div>
                        <div class="cursor-pointer p-2 rounded-lg border-2 border-transparent hover:border-lime-500 bg-gray-50 text-center min-w-[60px] dark:bg-gray-700"
                            onclick="selectIcon(this, 'fa-piggy-bank')"><i
                                class="fas fa-piggy-bank text-xl text-pink-500 mb-1"></i>
                            <div class="text-[10px] dark:text-gray-300">Heo đất</div>
                        </div>
                    </div>
                </div>
                <div class="flex gap-3 mt-6"><button onclick="toggleModal('walletModal')"
                        class="flex-1 py-3 text-gray-500 font-medium rounded-xl hover:bg-gray-100 dark:text-gray-400 dark:hover:bg-gray-700">Hủy</button><button
                        id="btnDeleteWallet" onclick="deleteWallet()"
                        class="hidden px-4 py-3 bg-red-100 text-red-500 font-bold rounded-xl hover:bg-red-200 dark:bg-red-900 dark:text-red-300"><i
                            class="fas fa-trash"></i></button><button onclick="saveWallet()"
                        class="flex-1 py-3 bg-lime-500 text-white font-bold rounded-xl shadow-lg shadow-lime-200 active:scale-95 transition-transform dark:shadow-none">Lưu</button>
                </div>
            </div>
        </div>
    </div>

    <!-- TRANSACTION MODAL -->
    <div id="transactionModal"
        class="hidden fixed inset-0 bg-black/50 z-50 flex items-center justify-center p-4 backdrop-blur-sm">
        <div class="bg-white rounded-2xl w-full max-w-sm p-6 shadow-2xl anim-pop dark:bg-dark-card">
            <h3 class="text-lg font-bold mb-4 text-center dark:text-white" id="transModalTitle">Ghi Chép</h3>
            <input type="hidden" id="transType"><input type="hidden" id="transEditId">
            <div class="space-y-4">
                <div><label class="text-xs font-bold text-gray-500 uppercase dark:text-gray-400">Số tiền</label>
                    <div class="flex items-end gap-2 border-b-2 border-gray-200 dark:border-gray-600"
                        id="transAmountWrapper"><input type="text" inputmode="numeric" id="transAmount"
                            class="w-full outline-none py-2 text-3xl font-bold text-center bg-transparent dark:text-white"
                            placeholder="0" oninput="formatCurrencyInput(this)"><span id="transCurrencyLabel"
                            class="text-gray-400 pb-2 font-medium">VND</span></div>
                </div>
                <div><label class="text-xs font-bold text-gray-500 uppercase dark:text-gray-400">Chọn ví</label><select
                        id="transWallet" onchange="updateTransCurrencyLabel()"
                        class="w-full bg-gray-50 p-3 rounded-xl border border-gray-200 mt-2 outline-none dark:bg-gray-700 dark:border-gray-600 dark:text-white"></select>
                </div>
                <div>
                    <div class="flex justify-between items-center mb-2"><label
                            class="text-xs font-bold text-gray-500 uppercase dark:text-gray-400">Danh mục</label><button
                            onclick="openCategoryManager()"
                            class="text-xs text-lime-600 font-bold hover:underline dark:text-lime-400"><i
                                class="fas fa-cog"></i> Sửa</button></div>
                    <div id="categoryList" class="flex flex-wrap gap-2 max-h-24 overflow-y-auto"></div><input
                        type="hidden" id="selectedCategory">
                </div>
                <div><label class="text-xs font-bold text-gray-500 uppercase dark:text-gray-400">Ghi chú (Tùy
                        chọn)</label><input type="text" id="transNote"
                        class="w-full border-b-2 border-gray-200 focus:border-gray-400 outline-none py-2 text-sm dark:bg-transparent dark:text-white dark:border-gray-600"
                        placeholder="Chi tiết..."></div>
                <div class="flex gap-3 mt-4"><button onclick="toggleModal('transactionModal')"
                        class="flex-1 py-3 text-gray-500 font-medium rounded-xl hover:bg-gray-100 dark:text-gray-400 dark:hover:bg-gray-700">Hủy</button><button
                        onclick="saveTransaction()" id="btnSaveTrans"
                        class="flex-1 py-3 text-white font-bold rounded-xl shadow-lg active:scale-95 transition-transform">Lưu</button>
                </div>
            </div>
        </div>
    </div>

    <!-- CATEGORY MANAGER MODAL -->
    <div id="categoryManagerModal"
        class="hidden fixed inset-0 bg-black/50 z-50 flex items-center justify-center p-4 backdrop-blur-sm">
        <div
            class="bg-white rounded-2xl w-full max-w-sm p-6 shadow-2xl anim-pop h-[80vh] flex flex-col dark:bg-dark-card">
            <h3 class="text-lg font-bold mb-4 text-center dark:text-white">Quản Lý Danh Mục</h3>
            <div class="flex gap-2 mb-4 border-b pb-4 dark:border-gray-700"><input type="text" id="newCatName"
                    class="flex-1 border rounded-lg px-3 py-2 text-sm outline-none focus:border-lime-500 dark:bg-gray-700 dark:border-gray-600 dark:text-white"
                    placeholder="Tên danh mục mới..."><button onclick="addCategory()"
                    class="bg-lime-500 text-white px-4 rounded-lg font-bold"><i class="fas fa-plus"></i></button></div>
            <div class="flex-1 overflow-y-auto pr-2" id="manageCategoryList"></div>
            <button onclick="closeCategoryManager()"
                class="w-full mt-4 py-3 bg-gray-100 text-gray-600 font-bold rounded-xl dark:bg-gray-700 dark:text-gray-300">Đóng</button>
        </div>
    </div>

    <!-- REPORT MODAL -->
    <div id="reportModal"
        class="hidden fixed inset-0 bg-black/50 z-50 flex items-end sm:items-center justify-center sm:p-4 backdrop-blur-sm">
        <div
            class="bg-white rounded-t-3xl sm:rounded-2xl w-full max-w-md h-[90vh] sm:h-auto sm:max-h-[90vh] shadow-2xl anim-pop flex flex-col dark:bg-dark-card">
            <div class="p-4 border-b flex flex-col gap-3 dark:border-gray-700">
                <div class="flex justify-between items-center">
                    <h3 class="font-bold text-gray-800 text-lg dark:text-white">Báo Cáo</h3><button
                        onclick="toggleModal('reportModal')"
                        class="w-8 h-8 rounded-full bg-gray-100 flex items-center justify-center text-gray-600 dark:bg-gray-700 dark:text-gray-400"><i
                            class="fas fa-times"></i></button>
                </div>
                <div class="flex items-center justify-between bg-gray-50 rounded-xl p-2 dark:bg-gray-800"><button
                        onclick="changeReportMonth(-1)"
                        class="w-8 h-8 flex items-center justify-center text-gray-500 hover:bg-gray-200 rounded-lg dark:hover:bg-gray-700"><i
                            class="fas fa-chevron-left"></i></button><span id="reportMonthLabel"
                        class="font-bold text-gray-700 text-sm dark:text-gray-200">Tháng 11, 2024</span><button
                        onclick="changeReportMonth(1)"
                        class="w-8 h-8 flex items-center justify-center text-gray-500 hover:bg-gray-200 rounded-lg dark:hover:bg-gray-700"><i
                            class="fas fa-chevron-right"></i></button></div>
                <div class="flex justify-center gap-3 my-1"><label class="flex items-center gap-1 cursor-pointer"><input
                            type="radio" name="repCurrency" value="VND" class="hidden peer"
                            onchange="switchReportCurrency('VND')"><span
                            class="px-3 py-1 rounded-lg text-xs font-bold bg-gray-100 text-gray-500 peer-checked:bg-lime-500 peer-checked:text-white transition-all dark:bg-gray-700 dark:text-gray-400">VND</span></label><label
                        class="flex items-center gap-1 cursor-pointer"><input type="radio" name="repCurrency"
                            value="JPY" class="hidden peer" checked onchange="switchReportCurrency('JPY')"><span
                            class="px-3 py-1 rounded-lg text-xs font-bold bg-gray-100 text-gray-500 peer-checked:bg-lime-500 peer-checked:text-white transition-all dark:bg-gray-700 dark:text-gray-400">JPY</span></label>
                </div>
                <div class="flex p-1 bg-gray-100 rounded-full dark:bg-gray-800"><button
                        onclick="switchReportTab('expense')" id="tabExpense"
                        class="report-tab flex-1 text-center active">Chi tiêu</button><button
                        onclick="switchReportTab('income')" id="tabIncome" class="report-tab flex-1 text-center">Thu
                        nhập</button><button onclick="switchReportTab('compare')" id="tabCompare"
                        class="report-tab flex-1 text-center">So sánh</button></div>
            </div>
            <div class="flex-1 overflow-y-auto p-4 hide-scrollbar">
                <div id="pieChartSection" class="mb-6 flex flex-col items-center">
                    <div id="pieChart" class="pie-chart shadow-inner bg-gray-100 mb-4 dark:bg-gray-800">
                        <div class="pie-center"><span class="text-xs text-gray-400" id="pieLabel">Tổng</span><span
                                class="font-bold text-lg text-gray-800 dark:text-white" id="pieTotal">0</span></div>
                    </div>
                </div>
                <div id="compareSection" class="hidden mb-6">
                    <div
                        class="flex items-end justify-center gap-8 h-40 border-b border-gray-200 pb-2 mb-4 px-8 dark:border-gray-700">
                        <div class="flex flex-col items-center gap-2 w-16 group"><span
                                class="text-xs font-bold text-green-600 dark:text-green-400" id="compareIncVal">0</span>
                            <div id="barIncome"
                                class="w-full bg-green-500 rounded-t-lg bar-fill min-h-[4px] relative group-hover:opacity-80">
                            </div><span class="text-xs text-gray-500 dark:text-gray-400">Thu</span>
                        </div>
                        <div class="flex flex-col items-center gap-2 w-16 group"><span
                                class="text-xs font-bold text-red-500 dark:text-red-400" id="compareExpVal">0</span>
                            <div id="barExpense"
                                class="w-full bg-red-500 rounded-t-lg bar-fill min-h-[4px] relative group-hover:opacity-80">
                            </div><span class="text-xs text-gray-500 dark:text-gray-400">Chi</span>
                        </div>
                    </div>
                    <div class="bg-gray-50 p-4 rounded-xl text-center dark:bg-gray-800">
                        <p class="text-xs text-gray-500 mb-1 dark:text-gray-400">Kết dư tháng</p>
                        <p class="text-xl font-bold" id="compareNet">0</p>
                    </div>
                </div>
                <h4 class="text-sm font-bold text-gray-500 uppercase mb-3 dark:text-gray-400" id="detailTitle">Chi tiết
                </h4>
                <div id="categoryBreakdown" class="space-y-4"></div>
            </div>
        </div>
    </div>

    <!-- SETTINGS MODAL -->
    <div id="settingsModal"
        class="hidden fixed inset-0 bg-black/50 z-50 flex items-center justify-center p-4 backdrop-blur-sm">
        <div class="bg-white rounded-2xl w-full max-w-sm p-6 shadow-2xl anim-pop dark:bg-dark-card">
            <h3 class="text-lg font-bold mb-4 text-center dark:text-white">Cài Đặt</h3>
            <div class="space-y-4">
                <div><label class="text-sm font-bold text-gray-700 block mb-2 dark:text-gray-300">Giao diện</label>
                    <div class="flex bg-gray-100 rounded-lg p-1 dark:bg-gray-700"><button onclick="setTheme('auto')"
                            id="themeAuto" class="flex-1 py-2 text-xs rounded-md font-medium transition-all">Thiết
                            bị</button><button onclick="setTheme('light')" id="themeLight"
                            class="flex-1 py-2 text-xs rounded-md font-medium transition-all">Sáng</button><button
                            onclick="setTheme('dark')" id="themeDark"
                            class="flex-1 py-2 text-xs rounded-md font-medium transition-all">Tối</button></div>
                </div>
                <div><label class="text-sm font-bold text-gray-700 block mb-2 dark:text-gray-300">Ngày bắt đầu
                        tháng</label>
                    <div
                        class="flex items-center gap-2 border border-gray-200 rounded-xl px-3 py-2 dark:border-gray-600 dark:bg-gray-700">
                        <i class="far fa-calendar-alt text-gray-400"></i><input type="number" id="settingStartDay"
                            min="1" max="28"
                            class="flex-1 outline-none font-bold text-center text-lime-600 bg-transparent"
                            value="1"><span class="text-gray-500 text-sm dark:text-gray-300">hàng tháng</span></div>
                </div>
                <div><label class="text-sm font-bold text-gray-700 block mb-2 dark:text-gray-300">Dữ liệu</label>
                    <div class="flex gap-2"><button onclick="exportData()"
                            class="flex-1 py-2 bg-blue-50 text-blue-600 font-bold rounded-lg border border-blue-100 hover:bg-blue-100 dark:bg-blue-900/30 dark:border-blue-800 dark:text-blue-300"><i
                                class="fas fa-file-export mr-1"></i> Sao lưu</button><button
                            onclick="document.getElementById('importFile').click()"
                            class="flex-1 py-2 bg-green-50 text-green-600 font-bold rounded-lg border border-green-100 hover:bg-green-100 dark:bg-green-900/30 dark:border-green-800 dark:text-green-300"><i
                                class="fas fa-file-import mr-1"></i> Khôi phục</button><input type="file"
                            id="importFile" class="hidden" accept=".json" onchange="importData(this)"></div>
                </div>
                <button onclick="resetData()"
                    class="w-full py-3 mt-2 text-red-500 bg-red-50 font-medium rounded-xl hover:bg-red-100 border border-red-100 flex items-center justify-center gap-2 dark:bg-red-900/20 dark:border-red-900"><i
                        class="fas fa-trash-alt"></i> Xóa toàn bộ dữ liệu</button>
                <div class="flex gap-3 mt-4"><button onclick="saveSettings()"
                        class="flex-1 py-3 bg-lime-500 text-white font-bold rounded-xl shadow-lg active:scale-95 transition-transform">Lưu
                        & Đóng</button></div>
            </div>
        </div>
    </div>

    <!-- CHAT OVERLAY -->
    <div id="chatOverlay"
        class="fixed inset-0 bg-white z-50 transform translate-y-full transition-transform duration-300 flex flex-col dark:bg-dark-bg">
        <div
            class="bg-white border-b px-4 py-3 flex items-center justify-between shadow-sm dark:bg-dark-card dark:border-gray-700">
            <div class="flex items-center gap-3">
                <button onclick="closeChat()"
                    class="w-8 h-8 flex items-center justify-center text-gray-500 hover:bg-gray-100 rounded-full dark:text-gray-400 dark:hover:bg-gray-700"><i
                        class="fas fa-chevron-down"></i></button>
                <div>
                    <h3 class="font-bold text-gray-800 text-sm dark:text-white">Trợ lý Lime</h3>
                    <div class="flex items-center gap-2 mt-1"><button onclick="setChatMode('auto')" id="btnModeAuto"
                            class="px-2 py-0.5 rounded text-[10px] font-bold bg-lime-100 text-lime-700 border border-lime-200 dark:bg-lime-900 dark:text-lime-300 dark:border-lime-800"><i
                                class="fas fa-bolt"></i> Tự động</button><button onclick="setChatMode('step')"
                            id="btnModeStep"
                            class="px-2 py-0.5 rounded text-[10px] font-bold bg-gray-100 text-gray-500 border border-transparent dark:bg-gray-700 dark:text-gray-400"><i
                                class="fas fa-list-ol"></i> Từng mục</button></div>
                </div>
            </div>
            <div
                class="w-8 h-8 bg-lime-50 rounded-full flex items-center justify-center text-lime-600 dark:bg-lime-900 dark:text-lime-300">
                <i class="fas fa-robot"></i></div>
        </div>
        <div id="chatMessages" class="flex-1 overflow-y-auto p-4 space-y-4 bg-gray-50 dark:bg-dark-bg"></div>
        <div class="p-3 bg-white border-t pb-safe dark:bg-dark-card dark:border-gray-700">
            <div id="chatOptionsArea" class="flex gap-2 mb-2 overflow-x-auto hide-scrollbar hidden px-1"></div>
            <div
                class="flex items-center gap-2 bg-gray-100 rounded-full px-4 py-2 border border-transparent focus-within:border-lime-500 focus-within:bg-white transition-all dark:bg-gray-700 dark:focus-within:bg-gray-800 dark:focus-within:border-lime-500">
                <input type="text" id="chatInput" placeholder="Nhập tin nhắn..."
                    class="flex-1 bg-transparent outline-none text-sm py-1 dark:text-white dark:placeholder-gray-400">
                <button onclick="sendMessage()"
                    class="w-8 h-8 bg-lime-500 text-white rounded-full flex items-center justify-center shadow-md hover:bg-lime-600 active:scale-95 transition-transform"><i
                        class="fas fa-paper-plane text-xs"></i></button>
            </div>
        </div>
    </div>

    <!-- SCRIPTS -->
    <script>
        // --- CONSTANTS & CONFIG ---
        const EXCHANGE_RATE = { VND: 1, JPY: 170 };
        const SCRAPINGBEE_KEYS = ["YFH8ZPMDE27ABK3HAVVALLVZLVAF4PNMDYE12GSH2ILVSQ5AVLTGMTUZCDNG2SAGCII7PKXLZWJI7GD7"];
        const DEFAULT_CATEGORIES = { expense: [{ id: 'an-uong', name: 'Ăn uống', icon: 'fa-utensils', color: '#f97316' }, { id: 'di-chuyen', name: 'Di chuyển', icon: 'fa-motorcycle', color: '#2563eb' }, { id: 'mua-sam', name: 'Mua sắm', icon: 'fa-shopping-bag', color: '#db2777' }, { id: 'nha-cua', name: 'Nhà cửa', icon: 'fa-home', color: '#9333ea' }, { id: 'giai-tri', name: 'Giải trí', icon: 'fa-gamepad', color: '#4f46e5' }, { id: 'khac', name: 'Khác', icon: 'fa-ellipsis-h', color: '#6b7280' }], income: [{ id: 'luong', name: 'Lương', icon: 'fa-money-bill-wave', color: '#16a34a' }, { id: 'thuong', name: 'Thưởng', icon: 'fa-gift', color: '#ca8a04' }, { id: 'dau-tu', name: 'Đầu tư', icon: 'fa-chart-line', color: '#2563eb' }, { id: 'khac', name: 'Khác', icon: 'fa-ellipsis-h', color: '#6b7280' }] };

        let selectedIcon = 'fa-wallet';
        let chatMode = 'auto';
        let chatStep = 0;
        let chatData = {};
        let lastChatTransaction = null;
        let currentReportDate = new Date();
        let currentReportTab = 'expense';
        let currentReportCurrency = 'JPY';

        const defaultWallets = [{ id: 1, name: 'Tiền mặt', balance: 500000, currency: 'VND', icon: 'fa-wallet', color: 'text-gray-600' }, { id: 2, name: 'Visa (JPY)', balance: 10000, currency: 'JPY', icon: 'fa-credit-card', color: 'text-blue-500' }];
        let appData = JSON.parse(localStorage.getItem('limeWalletData')) || { wallets: defaultWallets, transactions: [], settings: { startDay: 1, theme: 'auto' }, categories: JSON.parse(JSON.stringify(DEFAULT_CATEGORIES)), chatTemplates: [] };
        if (!appData.settings) appData.settings = { startDay: 1, theme: 'auto' };
        if (!appData.categories) appData.categories = JSON.parse(JSON.stringify(DEFAULT_CATEGORIES));
        if (!appData.chatTemplates) appData.chatTemplates = [];
        appData.wallets.forEach(w => { if (!w.currency) w.currency = 'VND'; });

        const LOCAL_KEY = 'smiles_rate_data';
        let currentRate = 0;
        let isReverseMode = false;

        // --- CORE LOGIC ---
        function saveData() { localStorage.setItem('limeWalletData', JSON.stringify(appData)); renderAll(); }
        function formatMoney(amount, currency = 'VND') { return new Intl.NumberFormat('vi-VN', { style: 'currency', currency: currency, maximumFractionDigits: 0 }).format(amount).replace('₫', 'đ').replace('¥', '¥'); }
        function formatCurrencyInput(input) { let value = input.value.replace(/\D/g, ''); if (!value) { input.value = ''; if (input.id.startsWith('input')) calculate(input.id === 'inputPoints' ? 'inputJPY' : input.id); return; } input.value = parseInt(value).toLocaleString('vi-VN'); if (input.id === 'inputJPY' || input.id === 'inputVND' || input.id === 'inputPoints') calculate(input.id === 'inputPoints' ? 'inputJPY' : input.id); }
        function getCategoryInfo(id, type = 'expense') { const list = type === 'expense' ? appData.categories.expense : appData.categories.income; let found = list.find(c => c.id === id); if (!found) found = [...appData.categories.expense, ...appData.categories.income].find(c => c.id === id); return found || { name: 'Khác', icon: 'fa-question', color: '#9ca3af' }; }
        function getFinancialDateRange(baseDate = new Date()) { const startDay = parseInt(appData.settings.startDay); let start = new Date(baseDate.getFullYear(), baseDate.getMonth(), startDay); let end = new Date(baseDate.getFullYear(), baseDate.getMonth() + 1, startDay - 1); if (baseDate.getDate() < startDay) { start = new Date(baseDate.getFullYear(), baseDate.getMonth() - 1, startDay); end = new Date(baseDate.getFullYear(), baseDate.getMonth(), startDay - 1); } start.setHours(0, 0, 0, 0); end.setHours(23, 59, 59, 999); return { start, end }; }
        function convertToVND(amount, currency) { return amount * (EXCHANGE_RATE[currency] || 1); }
        function getWallet(id) { return appData.wallets.find(w => w.id == id); }
        function scrollToTop() { document.getElementById('mainView').scrollTop = 0; }
        function toggleAddMenu() { const overlay = document.getElementById('addMenuOverlay'); if (overlay.classList.contains('hidden')) { overlay.classList.remove('hidden'); } else { overlay.classList.add('hidden'); } }

        // --- SERVICE WORKER REGISTRATION ---
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('sw.js').then(registration => {
                    console.log('SW registered: ', registration);
                }).catch(registrationError => {
                    console.log('SW registration failed: ', registrationError);
                });
            });
        }

        // --- RENDER UI ---
        function renderAll() { renderWallets(); renderTransactions(); updateHeaderStats(); updateSelects(); document.getElementById('settingStartDay').value = appData.settings.startDay; applyTheme(); }

        function updateHeaderStats() {
            const range = getFinancialDateRange(new Date());
            const startStr = range.start.toLocaleDateString('vi-VN', { day: '2-digit', month: '2-digit' });
            const endStr = range.end.toLocaleDateString('vi-VN', { day: '2-digit', month: '2-digit' });
            document.getElementById('dateRangeDisplay').innerText = `${startStr} - ${endStr}`;
            const totalVND = appData.wallets.filter(w => w.currency === 'VND').reduce((s, w) => s + w.balance, 0);
            const totalJPY = appData.wallets.filter(w => w.currency === 'JPY').reduce((s, w) => s + w.balance, 0);
            document.getElementById('totalVND').innerText = formatMoney(totalVND, 'VND');
            document.getElementById('totalJPY').innerText = formatMoney(totalJPY, 'JPY');
            const txs = appData.transactions.filter(t => { const d = new Date(t.date); return d >= range.start && d <= range.end; });
            const income = txs.filter(t => t.type === 'income').reduce((sum, t) => sum + convertToVND(t.amount, getWallet(t.walletId)?.currency || 'VND'), 0);
            const expense = txs.filter(t => t.type === 'expense').reduce((sum, t) => sum + convertToVND(t.amount, getWallet(t.walletId)?.currency || 'VND'), 0);
            document.getElementById('monthlyIncome').innerText = '+' + formatMoney(income, 'VND');
            document.getElementById('monthlyExpense').innerText = '-' + formatMoney(expense, 'VND');
        }

        function renderWallets() {
            const container = document.getElementById('walletList'); container.innerHTML = '';
            appData.wallets.forEach(w => {
                const div = document.createElement('div');
                div.className = 'wallet-card min-w-[160px] p-4 bg-white rounded-2xl shadow-sm border border-gray-100 flex flex-col justify-between h-32 relative overflow-hidden group dark:bg-dark-card dark:border-gray-700';
                div.innerHTML = `<div class="absolute -right-4 -top-4 w-16 h-16 bg-lime-50 rounded-full pointer-events-none dark:bg-lime-900/20"></div><button onclick="openWalletModal(${w.id})" class="absolute top-2 right-2 w-6 h-6 bg-white/80 rounded-full flex items-center justify-center text-gray-400 hover:text-lime-600 shadow-sm z-20 dark:bg-gray-700 dark:text-gray-300"><i class="fas fa-pencil-alt text-xs"></i></button><div class="flex justify-between items-start z-10 pointer-events-none"><i class="fas ${w.icon} ${w.color} text-xl dark:text-gray-300"></i><span class="text-[10px] bg-gray-100 px-2 py-1 rounded-full text-gray-500 font-bold dark:bg-gray-700 dark:text-gray-300">${w.currency}</span></div><div class="z-10 pointer-events-none"><p class="text-xs text-gray-500 font-medium truncate dark:text-gray-400">${w.name}</p><p class="text-lg font-bold text-gray-800 truncate dark:text-white">${formatMoney(w.balance, w.currency)}</p></div>`;
                container.appendChild(div);
            });
        }

        function renderTransactions() {
            const container = document.getElementById('transactionList'); container.innerHTML = '';
            const limit = document.getElementById('txLimit').value;
            const sorted = [...appData.transactions].sort((a, b) => new Date(b.date) - new Date(a.date));
            let visibleTxs = sorted;
            if (limit !== 'all') { visibleTxs = sorted.slice(0, parseInt(limit)); }
            if (visibleTxs.length === 0) { container.innerHTML = `<div class="text-center text-gray-400 py-4 text-sm">Chưa có giao dịch nào</div>`; return; }
            visibleTxs.forEach(t => {
                const w = getWallet(t.walletId);
                const wName = w ? w.name : 'Đã xóa'; const cur = w ? w.currency : 'VND';
                const catInfo = getCategoryInfo(t.categoryId, t.type);
                const isInc = t.type === 'income';
                const color = isInc ? 'text-green-600 dark:text-green-400' : 'text-red-500 dark:text-red-400';
                const sign = isInc ? '+' : '-';
                const div = document.createElement('div');
                div.className = 'group relative flex items-center justify-between p-3 bg-white rounded-xl shadow-sm border border-gray-50 overflow-hidden dark:bg-dark-card dark:border-gray-700';
                div.innerHTML = `<div class="flex items-center gap-3 relative z-10"><div class="w-10 h-10 rounded-full flex items-center justify-center text-sm text-white" style="background-color: ${catInfo.color}"><i class="fas ${catInfo.icon}"></i></div><div><p class="font-medium text-sm text-gray-800 truncate max-w-[150px] dark:text-gray-200">${t.note || catInfo.name}</p><p class="text-xs text-gray-400">${new Date(t.date).toLocaleDateString('vi-VN', { day: '2-digit', month: '2-digit' })} • ${wName}</p></div></div><div class="text-right relative z-10"><p class="font-bold text-sm ${color}">${sign}${formatMoney(t.amount, cur)}</p><p class="text-[10px] text-gray-400">${catInfo.name}</p></div><div class="absolute right-0 top-0 bottom-0 flex z-20 translate-x-full group-hover:translate-x-0 transition-transform bg-white/90 pl-4 items-center gap-2 pr-2 dark:bg-gray-800/90"><button onclick="openTransactionModal('${t.type}', ${t.id})" class="w-8 h-8 rounded-full bg-blue-100 text-blue-600 flex items-center justify-center hover:scale-110 transition-transform dark:bg-blue-900 dark:text-blue-300"><i class="fas fa-pencil-alt text-xs"></i></button><button onclick="deleteTransaction(${t.id})" class="w-8 h-8 rounded-full bg-red-100 text-red-600 flex items-center justify-center hover:scale-110 transition-transform dark:bg-red-900 dark:text-red-300"><i class="fas fa-trash text-xs"></i></button></div>`;
                container.appendChild(div);
            });
        }

        function deleteTransaction(id) {
            if (!confirm("Bạn chắc chắn muốn xóa giao dịch này? Số dư ví sẽ được hoàn lại.")) return;
            const idx = appData.transactions.findIndex(t => t.id === id);
            if (idx === -1) return;
            const t = appData.transactions[idx];
            const w = getWallet(t.walletId);
            if (w) { if (t.type === 'expense') w.balance += t.amount; else w.balance -= t.amount; }
            appData.transactions.splice(idx, 1);
            saveData();
        }

        function openTransactionModal(type, editId = null) {
            document.getElementById('transType').value = type;
            const title = document.getElementById('transModalTitle');
            const btn = document.getElementById('btnSaveTrans');
            const wrapper = document.getElementById('transAmountWrapper');
            const editIdField = document.getElementById('transEditId');
            editIdField.value = editId || '';
            renderTransCategories(type);
            if (editId) {
                const t = appData.transactions.find(x => x.id === editId);
                title.innerText = "Sửa Giao Dịch";
                document.getElementById('transAmount').value = t.amount.toLocaleString('vi-VN');
                document.getElementById('transNote').value = t.note;
                setTimeout(() => {
                    document.getElementById('transWallet').value = t.walletId;
                    updateTransCurrencyLabel();
                    const catPill = document.querySelector(`.category-pill[data-id="${t.categoryId}"]`);
                    if (catPill) catPill.click();
                }, 0);
            } else {
                title.innerText = type === 'income' ? 'Ghi Thu Nhập' : 'Ghi Chi Tiêu';
                document.getElementById('transAmount').value = '';
                document.getElementById('transNote').value = '';
                document.getElementById('selectedCategory').value = '';
            }
            const color = type === 'income' ? 'green' : 'red';
            title.className = `text-lg font-bold mb-4 text-center text-${color}-600 dark:text-${color}-400`;
            btn.className = `flex-1 py-3 bg-${color}-500 text-white font-bold rounded-xl shadow-lg active:scale-95 transition-transform`;
            wrapper.className = `flex items-end gap-2 border-b-2 border-${color}-200 dark:border-${color}-800`;
            document.getElementById('transAmount').className = `w-full outline-none py-2 text-3xl font-bold text-center bg-transparent text-${color}-600 dark:text-${color}-400`;
            toggleModal('transactionModal');
            updateTransCurrencyLabel();
        }

        function saveTransaction() {
            const type = document.getElementById('transType').value;
            const rawAmt = document.getElementById('transAmount').value.replace(/\./g, '');
            const amt = parseInt(rawAmt);
            const wid = parseInt(document.getElementById('transWallet').value);
            const note = document.getElementById('transNote').value;
            const catId = document.getElementById('selectedCategory').value;
            const editId = document.getElementById('transEditId').value;
            if (!amt) return alert("Nhập số tiền");
            if (!catId) return alert("Chọn danh mục");
            const w = getWallet(wid);
            if (!w) return alert("Ví không tồn tại");
            if (editId) {
                const oldIdx = appData.transactions.findIndex(t => t.id == editId);
                const oldT = appData.transactions[oldIdx];
                const oldW = getWallet(oldT.walletId);
                if (oldW) { if (oldT.type === 'expense') oldW.balance += oldT.amount; else oldW.balance -= oldT.amount; }
                oldT.amount = amt; oldT.walletId = wid; oldT.categoryId = catId; oldT.note = note;
                if (type === 'expense') w.balance -= amt; else w.balance += amt;
            } else {
                if (type === 'expense') w.balance -= amt; else w.balance += amt;
                appData.transactions.push({ id: Date.now(), type, amount: amt, walletId: wid, categoryId: catId, note, date: new Date().toISOString() });
            }
            saveData();
            toggleModal('transactionModal');
        }

        // --- CHAT LOGIC ---
        function openChat() { document.getElementById('chatOverlay').classList.remove('translate-y-full'); resetChat(); }
        function closeChat() { document.getElementById('chatOverlay').classList.add('translate-y-full'); }
        function setChatMode(m) { chatMode = m; document.getElementById('btnModeAuto').className = m === 'auto' ? "px-2 py-0.5 rounded text-[10px] font-bold bg-lime-100 text-lime-700 border border-lime-200 dark:bg-lime-900 dark:text-lime-300 dark:border-lime-800" : "px-2 py-0.5 rounded text-[10px] font-bold bg-gray-100 text-gray-500 border border-transparent dark:bg-gray-700 dark:text-gray-400"; document.getElementById('btnModeStep').className = m === 'step' ? "px-2 py-0.5 rounded text-[10px] font-bold bg-lime-100 text-lime-700 border border-lime-200 dark:bg-lime-900 dark:text-lime-300 dark:border-lime-800" : "px-2 py-0.5 rounded text-[10px] font-bold bg-gray-100 text-gray-500 border border-transparent dark:bg-gray-700 dark:text-gray-400"; resetChat(); }
        function resetChat() { const m = document.getElementById('chatMessages'); m.innerHTML = ''; document.getElementById('chatOptionsArea').innerHTML = ''; document.getElementById('chatOptionsArea').classList.add('hidden'); chatStep = 0; chatData = {}; lastChatTransaction = null; if (chatMode === 'auto') { addBotMessage("Chào bạn! Chế độ tự động (VD: Chi 50k ăn sáng)."); renderChatTemplates(); } else { chatStep = 1; renderStepPrompt(1); } }
        function renderChatTemplates() { const a = document.getElementById('chatOptionsArea'); a.innerHTML = ''; if (!appData.chatTemplates.length) { a.classList.add('hidden'); return; } a.classList.remove('hidden'); appData.chatTemplates.forEach(t => { const b = document.createElement('button'); b.className = 'chat-option-btn template-pill'; const m = new Intl.NumberFormat('en-US').format(t.amount); b.innerHTML = `<span>${t.type === 'income' ? '+' : '-'} ${m} ${t.name}</span><span class="template-delete" onclick="event.stopPropagation(); deleteChatTemplate(${t.id})"><i class="fas fa-times"></i></span>`; b.onclick = () => executeTemplate(t.id); a.appendChild(b); }); }
        function saveLastChatAsTemplate() { if (!lastChatTransaction) return; const n = prompt("Tên mẫu:", lastChatTransaction.note || "Mẫu mới"); if (!n) return; appData.chatTemplates.push({ id: Date.now(), name: n, ...lastChatTransaction }); saveData(); addBotMessage(`✅ Đã lưu mẫu: <b>${n}</b>.`); }
        function deleteChatTemplate(id) { if (confirm("Xóa mẫu?")) { appData.chatTemplates = appData.chatTemplates.filter(t => t.id !== id); saveData(); renderChatTemplates(); } }
        function executeTemplate(id) { const t = appData.chatTemplates.find(x => x.id === id); if (!t) return; const w = getWallet(t.walletId); if (!w) { addBotMessage("Ví không tồn tại"); return; } if (t.type === 'expense') w.balance -= t.amount; else w.balance += t.amount; appData.transactions.push({ id: Date.now(), type: t.type, amount: t.amount, walletId: t.walletId, categoryId: t.categoryId, note: t.note || t.name, date: new Date().toISOString() }); saveData(); addUserMessage(`[Mẫu] ${t.name}`); const c = getCategoryInfo(t.categoryId, t.type).name; addBotMessage(`✅ <b>Xong!</b> ${t.type === 'income' ? '+' : '-'}${formatMoney(t.amount, w.currency)} (${c})`); }
        function sendMessage() { const i = document.getElementById('chatInput'); const t = i.value.trim(); if (!t) return; addUserMessage(t); i.value = ''; if (chatMode === 'auto') setTimeout(() => processChatAuto(t), 600); else setTimeout(() => processChatStep(t), 600); }
        function showChatOptions(o, cb) { const a = document.getElementById('chatOptionsArea'); a.innerHTML = ''; a.classList.remove('hidden'); o.forEach(x => { const b = document.createElement('button'); b.className = 'chat-option-btn'; const l = typeof x === 'object' ? x.label : x; const v = typeof x === 'object' ? x.value : x; b.innerText = l; b.onclick = () => { addUserMessage(l); a.classList.add('hidden'); cb(v); }; a.appendChild(b); }); const m = document.getElementById('chatMessages'); m.scrollTop = m.scrollHeight; }
        function renderStepPrompt(s) { let o = []; const bk = { label: '⬅️ Quay lại', value: 'BACK' }, rs = { label: '🔄 Reset', value: 'RESET' }; if (s === 1) { addBotMessage("Bạn muốn ghi khoản gì?"); o = [{ label: '💸 Chi tiêu', value: 'expense' }, { label: '💰 Thu nhập', value: 'income' }]; } else if (s === 2) { addBotMessage(`Bạn chọn: <b>${chatData.type === 'expense' ? 'Chi tiêu' : 'Thu nhập'}</b>. Chọn ví?`); o = appData.wallets.map(w => ({ label: w.name, value: w.id })); o.push(bk, rs); } else if (s === 3) { const w = getWallet(chatData.walletId); addBotMessage(`Ví: <b>${w.name}</b>. Số tiền?`); o = ['50k', '100k', '500k', '1tr', '2tr', '5tr'].map(v => ({ label: v, value: v })); o.push(bk, rs); } else if (s === 4) { addBotMessage(`Tiền: <b>${formatNumber(chatData.amount)}</b>. Danh mục?`); const c = chatData.type === 'expense' ? appData.categories.expense : appData.categories.income; o = c.map(x => ({ label: x.name, value: x.id })); o.push(bk, rs); } else if (s === 5) { const i = getCategoryInfo(chatData.categoryId, chatData.type); addBotMessage(`Mục: <b>${i.name}</b>. Ghi chú?`); o = [{ label: 'Không', value: 'ko' }]; o.push(bk, rs); } showChatOptions(o, (v) => processChatStep(v)); }
        function processChatStep(inp) { if (inp === 'RESET') { resetChat(); return; } if (inp === 'BACK') { if (chatStep > 1) { chatStep--; renderStepPrompt(chatStep); } return; } switch (chatStep) { case 1: if (inp.toLowerCase().includes('chi') || inp === 'expense') chatData.type = 'expense'; else chatData.type = 'income'; chatStep = 2; renderStepPrompt(2); break; case 2: let w = null; if (typeof inp === 'number' || !isNaN(inp)) w = getWallet(parseInt(inp)); else w = appData.wallets.find(x => x.name.toLowerCase().includes(inp.toString().toLowerCase())); if (!w) w = appData.wallets[0]; chatData.walletId = w.id; chatStep = 3; renderStepPrompt(3); break; case 3: const m = inp.toString().match(/(\d+(?:\.\d+)?)\s*(k|ngàn|triệu|tr|m|jpy|yên|man)?/i); if (m) { let v = parseFloat(m[1]); let u = m[2] ? m[2].toLowerCase() : ''; if (['k', 'ngàn'].includes(u)) v *= 1000; if (['tr', 'triệu', 'm'].includes(u)) v *= 1000000; if (u === 'man') v *= 10000; chatData.amount = v; chatStep = 4; renderStepPrompt(4); } else addBotMessage("Số tiền sai (VD: 50k). Nhập lại:"); break; case 4: let c = null; const cats = chatData.type === 'expense' ? appData.categories.expense : appData.categories.income; if (typeof inp === 'string') c = cats.find(x => x.id === inp || x.name.toLowerCase().includes(inp.toLowerCase())); if (!c) c = cats.find(x => x.id === 'khac'); chatData.categoryId = c.id; chatStep = 5; renderStepPrompt(5); break; case 5: chatData.note = (inp === 'ko' || inp === 'không') ? '' : inp; const tw = getWallet(chatData.walletId); if (chatData.type === 'expense') tw.balance -= chatData.amount; else tw.balance += chatData.amount; appData.transactions.push({ id: Date.now(), type: chatData.type, amount: chatData.amount, walletId: chatData.walletId, categoryId: chatData.categoryId, note: chatData.note, date: new Date().toISOString() }); saveData(); lastChatTransaction = { ...chatData }; const cn = getCategoryInfo(chatData.categoryId, chatData.type).name; addBotMessage(`✅ <b>Xong!</b> ${chatData.type === 'income' ? '+' : '-'}${formatMoney(chatData.amount, tw.currency)} (${cn})`); setTimeout(() => { addBotMessage("Lưu mẫu này?<br><button onclick='saveLastChatAsTemplate()' class='mt-2 px-4 py-2 bg-yellow-100 text-yellow-700 font-bold rounded-xl text-xs border border-yellow-300'>⭐ Lưu mẫu</button>"); }, 500); setTimeout(() => { addBotMessage("---<br>Tiếp tục?"); chatStep = 1; renderStepPrompt(1); }, 1500); break; } }
        function processChatAuto(t) { t = t.toLowerCase(); const m = t.match(/(\d+(?:\.\d+)?)\s*(k|ngàn|triệu|tr|m|jpy|yên|man)?/); let a = 0; let cur = 'VND'; if (m) { let v = parseFloat(m[1]); let u = m[2]; if (['k', 'ngàn'].includes(u)) v *= 1000; if (['tr', 'triệu', 'm'].includes(u)) v *= 1000000; if (['jpy', 'yên'].includes(u)) cur = 'JPY'; if (u === 'man') { v *= 10000; cur = 'JPY'; } a = v; } if (a === 0) return addBotMessage("Số tiền sai. (VD: 50k)"); let typ = 'expense'; let cid = 'khac'; let nt = t; if (t.includes('lương') || t.includes('thưởng') || t.includes('thu')) { typ = 'income'; if (t.includes('lương')) cid = 'luong'; else if (t.includes('thưởng')) cid = 'thuong'; else if (t.includes('đầu tư')) cid = 'dau-tu'; } else { if (t.match(/(ăn|uống|cafe|cơm|phở)/)) cid = 'an-uong'; else if (t.match(/(xe|xăng|grab|taxi|đi)/)) cid = 'di-chuyen'; else if (t.match(/(áo|quần|mua|shopee|giày)/)) cid = 'mua-sam'; else if (t.match(/(điện|nước|nhà|net)/)) cid = 'nha-cua'; else if (t.match(/(phim|game|chơi)/)) cid = 'giai-tri'; } let w = appData.wallets.find(x => x.currency === cur) || appData.wallets[0]; if (typ === 'expense') w.balance -= a; else w.balance += a; appData.transactions.push({ id: Date.now(), type: typ, amount: a, walletId: w.id, categoryId: cid, note: `Chat Auto: ${nt}`, date: new Date().toISOString() }); saveData(); lastChatTransaction = { type: typ, amount: a, walletId: w.id, categoryId: cid, note: `Chat Auto: ${nt}` }; addBotMessage(`Đã ghi: <b>${formatMoney(a, cur)}</b> ví <b>${w.name}</b>.<br><button onclick='saveLastChatAsTemplate()' class='mt-2 px-3 py-1 bg-yellow-100 text-yellow-700 font-bold rounded text-[10px]'>⭐ Lưu mẫu</button>`); }
        function addUserMessage(t) { const d = document.createElement('div'); d.className = 'message-bubble message-user anim-pop text-sm'; d.innerText = t; document.getElementById('chatMessages').append(d); document.getElementById('chatMessages').scrollTop = 10000; }
        function addBotMessage(t) { const d = document.createElement('div'); d.className = 'message-bubble message-bot anim-pop text-sm'; d.innerHTML = t; document.getElementById('chatMessages').append(d); document.getElementById('chatMessages').scrollTop = 10000; }
        function toggleModal(id) { const e = document.getElementById(id); e.classList.toggle('hidden'); if (id === 'transactionModal' && !e.classList.contains('hidden')) updateSelects(); if (id === 'exchangeModal' && !e.classList.contains('hidden')) { const c = getRate(); if (c && c.rate) updateStatus(c.rate, c.time); else forceUpdateRate(); } }
        function updateSelects() { const o = appData.wallets.map(w => `<option value="${w.id}">${w.name} (${formatMoney(w.balance, w.currency)})</option>`).join(''); if (document.getElementById('transWallet')) document.getElementById('transWallet').innerHTML = o; }
        function updateTransCurrencyLabel() { const w = getWallet(document.getElementById('transWallet').value); document.getElementById('transCurrencyLabel').innerText = w ? w.currency : 'VND'; }
        function renderTransCategories(t) { const c = document.getElementById('categoryList'); c.innerHTML = ''; const l = t === 'expense' ? appData.categories.expense : appData.categories.income; l.forEach(x => { const p = document.createElement('div'); p.className = `category-pill px-3 py-2 rounded-xl border border-gray-200 text-xs font-bold cursor-pointer transition-colors flex items-center gap-2 text-gray-500 bg-white dark:bg-gray-700 dark:text-gray-300 dark:border-gray-600`; p.setAttribute('data-id', x.id); p.innerHTML = `<span style="color:${x.color}"><i class="fas ${x.icon}"></i></span> ${x.name}`; p.onclick = () => { document.querySelectorAll('.category-pill').forEach(z => { z.classList.remove('active'); z.style.backgroundColor = ''; z.style.color = ''; }); p.classList.add('active'); p.style.backgroundColor = x.color; p.style.color = 'white'; document.getElementById('selectedCategory').value = x.id; }; c.appendChild(p); }); }
        function openCategoryManager() { toggleModal('transactionModal'); toggleModal('categoryManagerModal'); renderCategoryManager(); }
        function closeCategoryManager() { toggleModal('categoryManagerModal'); toggleModal('transactionModal'); renderTransCategories(document.getElementById('transType').value); }
        function renderCategoryManager() { const t = document.getElementById('transType').value; const l = t === 'expense' ? appData.categories.expense : appData.categories.income; const c = document.getElementById('manageCategoryList'); c.innerHTML = ''; l.forEach((x, i) => { const d = document.createElement('div'); d.className = 'flex justify-between items-center p-3 bg-gray-50 mb-2 rounded-lg border border-gray-100 dark:bg-gray-700 dark:border-gray-600'; d.innerHTML = `<div class="flex items-center gap-2"><span style="color:${x.color}"><i class="fas ${x.icon}"></i></span><span class="text-sm font-medium dark:text-gray-200">${x.name}</span></div><button onclick="deleteCategory('${t}',${i})" class="text-red-400 hover:text-red-600 px-2"><i class="fas fa-trash"></i></button>`; c.appendChild(d); }); }
        function addCategory() { const n = document.getElementById('newCatName').value.trim(); const t = document.getElementById('transType').value; if (!n) return; const i = { id: n.toLowerCase().replace(/\s+/g, '-'), name: n, icon: 'fa-tag', color: '#' + Math.floor(Math.random() * 16777215).toString(16) }; if (t === 'expense') appData.categories.expense.push(i); else appData.categories.income.push(i); document.getElementById('newCatName').value = ''; saveData(); renderCategoryManager(); }
        function deleteCategory(t, i) { if (!confirm("Xóa?")) return; if (t === 'expense') { if (appData.categories.expense.length <= 1) return alert("Giữ 1"); appData.categories.expense.splice(i, 1); } else { if (appData.categories.income.length <= 1) return alert("Giữ 1"); appData.categories.income.splice(i, 1); } saveData(); renderCategoryManager(); }
        function saveRate(r) { const t = new Date().toLocaleString('vi-VN', { hour: '2-digit', minute: '2-digit', day: '2-digit', month: '2-digit' }); localStorage.setItem(LOCAL_KEY, JSON.stringify({ rate: r, time: t })); }
        function getRate() { const d = localStorage.getItem(LOCAL_KEY); return d ? JSON.parse(d) : null; }
        function formatNumber(n) { return n.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ","); }
        function getRawValue(id) { const v = document.getElementById(id).value.replace(/\./g, ''); return v ? parseInt(v) : 0; }
        function toggleMode() { isReverseMode = document.getElementById('modeToggle').checked; document.getElementById('modeLabel').innerText = isReverseMode ? "Chế độ: Đã bao gồm phí" : "Chế độ: Thường (Cộng thêm phí)"; document.getElementById('containerJPY').classList.toggle('highlight', isReverseMode); document.getElementById('rowRealSend').classList.toggle('hidden', !isReverseMode); calculate('inputJPY'); }
        function getFee(a) { if (a <= 0) return 0; if (a <= 10000) return 380; if (a <= 50000) return 450; if (a <= 100000) return 760; if (a <= 300000) return 980; if (a <= 1000000) return 1700; return 0; }
        function getPoints(a) { if (a <= 0) return 0; if (a <= 10000) return 10; if (a <= 50000) return 20; if (a <= 100000) return 50; if (a <= 300000) return 100; return 150; }
        function calculate(src) { if (currentRate === 0) return; const elJ = document.getElementById('inputJPY'), elV = document.getElementById('inputVND'); let vJ = getRawValue('inputJPY'), vP = getRawValue('inputPoints'); let real = 0, fee = 0, pay = 0; if (isReverseMode) { if (src === 'inputVND') { let vv = getRawValue('inputVND'); real = Math.ceil(vv / currentRate); fee = getFee(real); pay = real + fee - vP; if (pay < 0) pay = 0; elJ.value = formatNumber(pay).replace(/,/g, '.'); } else { let b = vJ + vP, tf = 0; if (b >= 301700) tf = 1700; else if (b >= 100980) tf = 980; else if (b >= 50760) tf = 760; else if (b >= 10450) tf = 450; else if (b >= 680) tf = 380; real = b - tf; let ef = getFee(real); if (ef !== tf) real = b - ef; if (real < 0) real = 0; if (src !== 'inputVND') elV.value = formatNumber(Math.floor(real * currentRate)).replace(/,/g, '.'); fee = getFee(real); pay = vJ; } } else { if (src === 'inputVND') { let vv = getRawValue('inputVND'); vJ = Math.ceil(vv / currentRate); elJ.value = formatNumber(vJ).replace(/,/g, '.'); } real = vJ; if (src !== 'inputVND') elV.value = formatNumber(Math.floor(real * currentRate)).replace(/,/g, '.'); fee = getFee(real); pay = real + fee - vP; if (pay < 0) pay = 0; } document.getElementById('feeDisplay').innerText = `¥${formatNumber(fee).replace(/,/g, '.')}`; document.getElementById('pointDisplay').innerText = `+${getPoints(real)} pts`; document.getElementById('realSendDisplay').innerText = `¥${formatNumber(real).replace(/,/g, '.')}`; document.getElementById('totalPayDisplay').innerText = `¥${formatNumber(pay).replace(/,/g, '.')}`; }
        async function copyContent(e, t) { try { await navigator.clipboard.writeText(document.getElementById(e).innerText.replace(/[^\d]/g, '')); const l = document.getElementById(t); l.classList.add('show'); setTimeout(() => l.classList.remove('show'), 1500); } catch (r) { } }
        function updateStatus(r, t) { currentRate = r; document.getElementById('rateDisplay').innerText = `1 JPY = ${r} VND`; if (t) document.getElementById('lastUpdatedTime').innerText = `Cập nhật: ${t}`; calculate('inputJPY'); }
        async function forceUpdateRate() { const btn = document.getElementById('btnRefresh'), el = document.getElementById('rateDisplay'); btn.classList.add('loading'); el.innerText = "Đang tải..."; const rules = { "currencies": { "selector": ".currency", "type": "list", "output": { "country": ".country_name", "rate": ".exchange_rate" } } }; let nr = 0; for (let k of SCRAPINGBEE_KEYS) { if (!k) continue; try { const u = `https://app.scrapingbee.com/api/v1/?api_key=${k}&url=${encodeURIComponent('https://www.smileswallet.com/japan/vi/ty-gia/')}&extract_rules=${encodeURIComponent(JSON.stringify(rules))}&render_js=false`; const res = await fetch(u); if (res.ok) { const d = await res.json(); const v = d.currencies?.find(c => c.country.includes("Vietnam") || c.country.includes("Việt Nam")); if (v) { nr = parseFloat(v.rate.match(/([\d,.]+)/)[0].replace(/,/g, '')); break; } } } catch (e) { } } btn.classList.remove('loading'); if (nr > 0) { saveRate(nr); updateStatus(nr, new Date().toLocaleString('vi-VN', { hour: '2-digit', minute: '2-digit', day: '2-digit', month: '2-digit' })); } else { el.innerText = "Lỗi!"; if (currentRate === 0) currentRate = 165.5; calculate('inputJPY'); } }
        function saveSettings() { const d = parseInt(document.getElementById('settingStartDay').value); if (d < 1 || d > 28) return alert("Ngày sai (1-28)"); appData.settings.startDay = d; saveData(); toggleModal('settingsModal'); }
        function resetData() { if (confirm("Xóa sạch?")) { localStorage.removeItem('limeWalletData'); location.reload(); } }
        function openWalletModal(e = null) { const t = document.getElementById('walletModalTitle'), n = document.getElementById('walletNameInput'), b = document.getElementById('walletBalanceInput'), c = document.getElementById('walletCurrencyInput'), i = document.getElementById('walletEditId'), d = document.getElementById('btnDeleteWallet'); if (e) { const w = getWallet(e); t.innerText = "Sửa Ví"; n.value = w.name; b.value = w.balance.toLocaleString('vi-VN'); c.value = w.currency; c.disabled = false; i.value = w.id; d.classList.remove('hidden'); selectedIcon = w.icon; } else { t.innerText = "Tạo Ví"; n.value = ""; b.value = ""; c.value = "VND"; c.disabled = false; i.value = ""; d.classList.add('hidden'); } toggleModal('walletModal'); }
        function saveWallet() { const n = document.getElementById('walletNameInput').value, b = parseInt(document.getElementById('walletBalanceInput').value.replace(/\./g, '')) || 0, c = document.getElementById('walletCurrencyInput').value, i = document.getElementById('walletEditId').value; if (!n) return alert("Cần tên"); let cl = 'text-gray-600'; if (selectedIcon === 'fa-credit-card') cl = 'text-blue-500'; if (selectedIcon === 'fa-piggy-bank') cl = 'text-pink-500'; if (i) { const w = getWallet(i); w.name = n; w.balance = b; w.currency = c; w.icon = selectedIcon; w.color = cl; } else { appData.wallets.push({ id: Date.now(), name: n, balance: b, currency: c, icon: selectedIcon, color: cl }); } saveData(); toggleModal('walletModal'); }
        function deleteWallet() { const i = parseInt(document.getElementById('walletEditId').value); if (appData.wallets.length <= 1) return alert("Giữ 1"); if (confirm("Xóa?")) appData.wallets = appData.wallets.filter(w => w.id !== i); saveData(); toggleModal('walletModal'); }
        function selectIcon(e, i) { document.querySelectorAll('#walletModal .border-lime-500').forEach(x => x.classList.remove('border-lime-500')); e.classList.add('border-lime-500'); selectedIcon = i; }
        function openReportModal() { currentReportDate = new Date(); currentReportTab = 'expense'; renderReport(); toggleModal('reportModal'); }
        function changeReportMonth(s) { currentReportDate.setMonth(currentReportDate.getMonth() + s); renderReport(); }
        function switchReportCurrency(c) { currentReportCurrency = c; renderReport(); }
        function switchReportTab(t) { currentReportTab = t;['expense', 'income', 'compare'].forEach(x => { const b = document.getElementById(`tab${x.charAt(0).toUpperCase() + x.slice(1)}`); if (t === x) { b.classList.add('active'); b.style.backgroundColor = '#ecfccb'; b.style.color = '#365314'; if (document.documentElement.classList.contains('dark')) { b.style.backgroundColor = '#3f6212'; b.style.color = '#ecfccb'; } } else { b.classList.remove('active'); b.style.backgroundColor = 'transparent'; b.style.color = '#6b7280'; if (document.documentElement.classList.contains('dark')) b.style.color = '#9ca3af'; } }); renderReport(); }
        function renderReport() {
            const ms = currentReportDate.toLocaleDateString('vi-VN', { month: 'long', year: 'numeric' }); document.getElementById('reportMonthLabel').innerText = ms.charAt(0).toUpperCase() + ms.slice(1);
            const r = getFinancialDateRange(currentReportDate); let txs = appData.transactions.filter(t => { const d = new Date(t.date); return d >= r.start && d <= r.end; }); txs = txs.filter(t => { const w = getWallet(t.walletId); return w && w.currency === currentReportCurrency; });
            let tv = 0; let cd = []; const ps = document.getElementById('pieChartSection'), cs = document.getElementById('compareSection'), dt = document.getElementById('detailTitle'), bc = document.getElementById('categoryBreakdown'); bc.innerHTML = '';
            if (currentReportTab === 'compare') { ps.classList.add('hidden'); cs.classList.remove('hidden'); dt.classList.add('hidden'); const ti = txs.filter(t => t.type === 'income').reduce((s, t) => s + t.amount, 0); const te = txs.filter(t => t.type === 'expense').reduce((s, t) => s + t.amount, 0); const net = ti - te; document.getElementById('compareIncVal').innerText = formatMoney(ti, currentReportCurrency); document.getElementById('compareExpVal').innerText = formatMoney(te, currentReportCurrency); document.getElementById('compareNet').innerText = formatMoney(net, currentReportCurrency); document.getElementById('compareNet').className = `text-xl font-bold ${net >= 0 ? 'text-green-600 dark:text-green-400' : 'text-red-600 dark:text-red-400'}`; const m = Math.max(ti, te) || 1; document.getElementById('barIncome').style.height = `${(ti / m) * 100}%`; document.getElementById('barExpense').style.height = `${(te / m) * 100}%`; } else { ps.classList.remove('hidden'); cs.classList.add('hidden'); dt.classList.remove('hidden'); const tf = currentReportTab; const st = txs.filter(t => t.type === tf); tv = st.reduce((s, t) => s + t.amount, 0); const cm = {}; st.forEach(t => { cm[t.categoryId] = (cm[t.categoryId] || 0) + t.amount; }); cd = Object.entries(cm).sort((a, b) => b[1] - a[1]); drawPieChart(cd, tv, tf); document.getElementById('pieTotal').innerText = formatMoney(tv, currentReportCurrency); document.getElementById('pieLabel').innerText = tf === 'expense' ? 'Tổng Chi' : 'Tổng Thu'; if (cd.length === 0) bc.innerHTML = '<p class="text-center text-gray-400 text-sm py-4">Không có dữ liệu</p>'; else cd.forEach(([id, v]) => { const i = getCategoryInfo(id, tf); const p = tv > 0 ? ((v / tv) * 100).toFixed(1) : 0; const d = document.createElement('div'); d.innerHTML = `<div class="flex items-center justify-between text-sm mb-1"><div class="flex items-center gap-2"><div class="w-2 h-2 rounded-full" style="background-color:${i.color}"></div><span class="font-medium text-gray-700 dark:text-gray-300">${i.name}</span></div><div class="text-right"><span class="font-bold block dark:text-gray-200">${formatMoney(v, currentReportCurrency)}</span><span class="text-[10px] text-gray-400">${p}%</span></div></div><div class="w-full bg-gray-100 rounded-full h-1.5 dark:bg-gray-700"><div class="h-1.5 rounded-full transition-all duration-500" style="width: ${p}%; background-color: ${i.color}"></div></div>`; bc.appendChild(d); }); }
        }
        function drawPieChart(d, t, tp) { const c = document.getElementById('pieChart'); if (t === 0 || d.length === 0) { c.style.background = document.documentElement.classList.contains('dark') ? '#374151' : '#f3f4f6'; return; } let g = []; let cd = 0; d.forEach(([id, v]) => { const i = getCategoryInfo(id, tp); const dg = (v / t) * 360; g.push(`${i.color} ${cd}deg ${cd + dg}deg`); cd += dg; }); c.style.background = `conic-gradient(${g.join(', ')})`; }

        // --- THEME ---
        function applyTheme() {
            const theme = appData.settings.theme || 'auto';
            const isDark = theme === 'dark' || (theme === 'auto' && window.matchMedia('(prefers-color-scheme: dark)').matches);
            document.documentElement.classList.toggle('dark', isDark);

            // Update Settings UI buttons
            ['auto', 'light', 'dark'].forEach(t => {
                const btn = document.getElementById('theme' + t.charAt(0).toUpperCase() + t.slice(1));
                if (btn) {
                    if (theme === t) {
                        btn.classList.add('bg-white', 'shadow-sm', 'text-lime-600');
                        if (isDark) { btn.classList.add('dark:bg-gray-600', 'dark:text-white'); }
                    } else {
                        btn.classList.remove('bg-white', 'shadow-sm', 'text-lime-600', 'dark:bg-gray-600', 'dark:text-white');
                        btn.classList.add('text-gray-500');
                    }
                }
            });
        }

        function setTheme(t) {
            appData.settings.theme = t;
            applyTheme();
        }

        // --- DATA IMPORT/EXPORT ---
        function exportData() { const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(appData)); const dlNode = document.createElement('a'); dlNode.setAttribute("href", dataStr); dlNode.setAttribute("download", "limewallet_backup_" + new Date().toISOString().slice(0, 10) + ".json"); document.body.appendChild(dlNode); dlNode.click(); dlNode.remove(); }
        function importData(input) { const file = input.files[0]; if (!file) return; const reader = new FileReader(); reader.onload = function (e) { try { const json = JSON.parse(e.target.result); if (json.wallets && json.transactions) { if (confirm("Dữ liệu hiện tại sẽ bị thay thế. Chắc chắn?")) { localStorage.setItem('limeWalletData', JSON.stringify(json)); alert("Thành công!"); location.reload(); } } else alert("File lỗi!"); } catch (err) { alert("Lỗi đọc file!"); } }; reader.readAsText(file); }

        renderAll();
    </script>
</body>

</html>