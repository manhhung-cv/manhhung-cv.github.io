<!DOCTYPE html>
<html lang="vi" data-theme="basic">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Share&Go - Chia sẻ chuyến đi</title>
    
    <!-- Tải Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Tải Leaflet (Bản đồ) -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin="" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>
    
    <!-- Tải Font Awesome (Icon) -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" xintegrity="sha512-DTOQO9RWCH3ppGqcWaEA1BIZOC6xxalwEsw9c2QQeAIftl+Vegovlnee1c9QX4TctnWMn13TZye+giMm8e2LwA==" crossorigin="anonymous" referrerpolicy="no-referrer" />
    
    <style>
        /* Tùy chỉnh font chữ Inter */
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');
        
        /* Định nghĩa CSS Variables cho Themes */
        :root, [data-theme="basic"] {
            --font-family: 'Inter', sans-serif;
            --bg-primary: #f3f4f6; /* gray-100 */
            --bg-secondary: #ffffff; /* white */
            --bg-muted: #f9fafb; /* gray-50 */
            --border-color: #e5e7eb; /* gray-200 */
            --text-primary: #1f2937; /* gray-800 */
            --text-secondary: #4b5563; /* gray-600 */
            --text-accent: #2563eb; /* blue-600 */
            --accent-primary: #2563eb; /* blue-600 */
            --accent-primary-hover: #1d4ed8; /* blue-700 */
            --accent-secondary: #10b981; /* green-500 */
            --accent-secondary-hover: #059669; /* green-600 */
            --destructive: #ef4444; /* red-500 */
        }
        
        [data-theme="dark"] {
            --bg-primary: #111827; /* gray-900 */
            --bg-secondary: #1f2937; /* gray-800 */
            --bg-muted: #374151; /* gray-700 */
            --border-color: #4b5563; /* gray-600 */
            --text-primary: #f9fafb; /* gray-50 */
            --text-secondary: #d1d5db; /* gray-300 */
            --text-accent: #60a5fa; /* blue-400 */
            --accent-primary: #3b82f6; /* blue-500 */
            --accent-primary-hover: #60a5fa; /* blue-400 */
            --accent-secondary: #34d399; /* green-400 */
            --accent-secondary-hover: #6ee7b7; /* green-300 */
            --destructive: #f87171; /* red-400 */
        }

        [data-theme="cute"] {
            --bg-primary: #fff5f7; /* pink-50 */
            --bg-secondary: #ffffff;
            --bg-muted: #fff0f3;
            --border-color: #fecdd3; /* pink-200 */
            --text-primary: #581c87; /* purple-900 */
            --text-secondary: #7e22ce; /* purple-700 */
            --text-accent: #db2777; /* pink-600 */
            --accent-primary: #ec4899; /* pink-500 */
            --accent-primary-hover: #db2777; /* pink-600 */
            --accent-secondary: #a855f7; /* purple-500 */
            --accent-secondary-hover: #9333ea; /* purple-600 */
            --destructive: #e11d48; /* rose-600 */
        }

        /* Áp dụng CSS Variables */
        body {
            font-family: var(--font-family);
            background-color: var(--bg-primary);
            color: var(--text-primary);
            transition: background-color 0.3s, color 0.3s;
        }

        .bg-primary { background-color: var(--bg-primary); }
        .bg-secondary { background-color: var(--bg-secondary); }
        .bg-muted { background-color: var(--bg-muted); }
        .border-color { border-color: var(--border-color); }
        .text-primary { color: var(--text-primary); }
        .text-secondary { color: var(--text-secondary); }
        .text-accent { color: var(--text-accent); }
        .text-destructive { color: var(--destructive); }
        .accent-primary { background-color: var(--accent-primary); color: white; }
        .accent-primary-hover:hover { background-color: var(--accent-primary-hover); }
        .accent-secondary { background-color: var(--accent-secondary); color: white; }
        .accent-secondary-hover:hover { background-color: var(--accent-secondary-hover); }

        /* Tùy chỉnh thanh cuộn */
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: var(--bg-primary); border-radius: 10px; }
        ::-webkit-scrollbar-thumb { background: var(--text-secondary); border-radius: 10px; }
        
        /* Sửa lỗi z-index của Leaflet */
        .leaflet-pane { z-index: 10 !important; }
        .leaflet-top, .leaflet-bottom { z-index: 20 !important; }
        
        /* Ẩn tab/view content mặc định */
        .main-view-pane, .internal-tab-pane, .internal-view-pane {
            display: none;
        }
        .main-view-pane.active, .internal-tab-pane.active, .internal-view-pane.active {
            display: block;
        }

        /* Gợi ý vị trí */
        #suggestions-box {
            position: absolute;
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-top: none;
            max-height: 200px;
            overflow-y: auto;
            z-index: 1000;
        }
        #suggestions-box div {
            padding: 10px;
            cursor: pointer;
            color: var(--text-primary);
        }
        #suggestions-box div:hover {
            background-color: var(--bg-muted);
        }
        
        /* (MỚI) CSS cho tab button (bên trong chuyến đi) */
        .internal-tab-button.active {
            background-color: var(--accent-primary);
            color: white;
        }
        .internal-tab-button {
             color: var(--text-secondary);
        }
        .internal-tab-button:hover:not(.active) {
            background-color: var(--bg-muted);
        }

        /* (MỚI) CSS cho Thanh Menu Dưới */
        #bottom-menu {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background-color: var(--bg-secondary);
            border-top: 1px solid var(--border-color);
            z-index: 30;
            box-shadow: 0 -2px 10px rgba(0,0,0,0.05);
        }
        .bottom-menu-button {
            color: var(--text-secondary);
            transition: color 0.2s;
        }
        .bottom-menu-button.active {
            color: var(--text-accent);
        }
    </style>
</head>
<body class="bg-primary text-primary">

    <!-- (MỚI) Bọc nội dung chính để thêm padding-bottom -->
    <main class="pb-24">
        <div class="container mx-auto max-w-5xl p-4 sm:p-6 lg:p-8">
            
            <!-- Tiêu đề (Chung cho các trang) -->
            <header class="text-center mb-6">
                <h1 class="text-3xl sm:text-4xl font-bold text-accent">
                    <i class="fa-solid fa-car-side mr-2"></i> Share&Go
                </h1>
            </header>

            <!-- (MỚI) View 1: Share&Go (Chuyến đi) -->
            <div id="view-share-go" class="main-view-pane active">
                
                <!-- (MỚI) View con 1.1: Danh sách chuyến đi -->
                <div id="view-trips-list" class="internal-view-pane active space-y-6">
                    <!-- Nút bật/tắt form tạo chuyến đi -->
                    <button id="toggle-create-trip-btn" class="w-full accent-secondary accent-secondary-hover text-white p-3 rounded-xl font-semibold transition shadow-md text-lg">
                        <i class="fa-solid fa-plus mr-2"></i> Tạo chuyến đi mới
                    </button>

                    <!-- Form tạo chuyến đi (ẩn mặc định) -->
                    <div id="create-trip-container" class="hidden">
                        <div class="bg-secondary p-4 sm:p-6 rounded-xl shadow-lg space-y-6">
                            <div>
                                <h2 class="text-2xl font-semibold text-primary border-b border-color pb-3 mb-4">
                                    <i class="fa-solid fa-suitcase-rolling mr-2"></i> Tạo chuyến đi mới
                                </h2>
                                <form id="create-trip-form" class="space-y-4">
                                    <div>
                                        <label for="trip-name" class="block text-sm font-medium text-secondary mb-1">Tên chuyến đi</label>
                                        <input type="text" id="trip-name" name="trip-name" required class="w-full p-3 border border-color rounded-lg focus:ring-2 focus:ring-[var(--text-accent)] bg-muted" placeholder="Ví dụ: Du lịch Đà Nẵng 3N2Đ">
                                    </div>
                                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                        <div>
                                            <label for="trip-participants" class="block text-sm font-medium text-secondary mb-1">Số người tham gia</label>
                                            <input type="number" id="trip-participants" name="trip-participants" min="1" required class="w-full p-3 border border-color rounded-lg focus:ring-2 focus:ring-[var(--text-accent)] bg-muted" placeholder="Ví dụ: 6">
                                        </div>
                                        <div>
                                            <label for="trip-description" class="block text-sm font-medium text-secondary mb-1">Mô tả</label>
                                            <input type="text" id="trip-description" name="trip-description" class="w-full p-3 border border-color rounded-lg focus:ring-2 focus:ring-[var(--text-accent)] bg-muted" placeholder="Ghi chú ngắn...">
                                        </div>
                                    </div>
                                    <button type="submit" class="w-full accent-secondary accent-secondary-hover text-white p-3 rounded-lg font-semibold transition shadow-md">
                                        <i class="fa-solid fa-plus mr-2"></i> Xác nhận
                                    </button>
                                </form>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Danh sách các chuyến đi -->
                    <div class="bg-secondary p-4 sm:p-6 rounded-xl shadow-lg">
                        <h2 class="text-2xl font-semibold text-primary border-b border-color pb-3 mb-4">
                            <i class="fa-solid fa-list-check mr-2"></i> Các chuyến đi của bạn
                        </h2>
                        <div id="trips-list" class="space-y-4">
                            <div id="empty-trips" class="text-center text-secondary p-8 border-2 border-dashed border-color rounded-lg">
                                <i class="fa-solid fa-suitcase text-4xl mb-4"></i>
                                <p>Chưa có chuyến đi nào.</p>
                                <p>Hãy tạo chuyến đi đầu tiên của bạn ở trên!</p>
                            </div>
                            <!-- Các thẻ Chuyến đi sẽ được JS thêm vào đây -->
                        </div>
                    </div>
                </div> <!-- Hết View con 1.1 -->

                <!-- (MỚI) View con 1.2: Chi tiết Chuyến đi -->
                <div id="view-trip-details" class="internal-view-pane">
                    <!-- Nút quay lại và Tiêu đề -->
                    <div class="flex items-center justify-between mb-6">
                        <button id="back-to-trips-btn" class="text-secondary font-medium hover:text-accent transition text-lg">
                            <i class="fa-solid fa-arrow-left mr-2"></i> Quay lại
                        </button>
                        <h2 id="current-trip-title" class="text-2xl font-semibold text-accent text-right truncate"></h2>
                    </div>

                    <!-- Tab điều hướng bên trong chuyến đi -->
                    <nav class="flex border-b-2 border-color mb-6 bg-secondary rounded-lg shadow-sm overflow-hidden">
                        <button class="internal-tab-button flex-1 p-4 font-semibold transition" data-tab="internal-tab-add">
                            <i class="fa-solid fa-plus-circle mr-2"></i> Thêm
                        </button>
                        <button class="internal-tab-button flex-1 p-4 font-semibold transition" data-tab="internal-tab-history">
                            <i class="fa-solid fa-history mr-2"></i> Lịch sử
                        </button>
                        <button class="internal-tab-button flex-1 p-4 font-semibold transition" data-tab="internal-tab-stats">
                            <i class="fa-solid fa-chart-pie mr-2"></i> Thống kê
                        </button>
                    </nav>
                    
                    <!-- Nội dung tab bên trong -->
                    <div>
                        <!-- Tab con: Thêm địa điểm -->
                        <div id="internal-tab-add" class="internal-tab-pane bg-secondary p-4 sm:p-6 rounded-xl shadow-lg space-y-6">
                            <form id="trip-form" class="space-y-4">
                                <div>
                                    <label for="place-name" class="block text-sm font-medium text-secondary mb-1">Tên địa điểm</label>
                                    <input type="text" id="place-name" name="place-name" required class="w-full p-3 border border-color rounded-lg focus:ring-2 focus:ring-[var(--text-accent)] bg-muted" placeholder="Ví dụ: Quán Phở Bát Đàn">
                                </div>

                                <!-- Vị trí -->
                                <div>
                                    <label for="location-name" class="block text-sm font-medium text-secondary mb-1">Vị trí địa điểm</label>
                                    <div class="flex gap-2 relative">
                                        <input type="text" id="location-name" name="location-name" class="flex-1 w-full p-3 border border-color rounded-lg focus:ring-2 focus:ring-[var(--text-accent)] bg-muted" placeholder="Nhập để tìm gợi ý..." autocomplete="off">
                                        <button type="button" id="search-location-btn" class="accent-primary accent-primary-hover text-white px-4 rounded-lg transition shadow-sm" title="Tìm kiếm vị trí">
                                            <i class="fa-solid fa-search"></i>
                                        </button>
                                        <div id="suggestions-box" class="absolute top-full left-0 right-0 shadow-lg rounded-b-md overflow-hidden hidden"></div>
                                    </div>
                                    <button type="button" id="geolocate-btn" class="w-full mt-2 bg-muted text-secondary p-2 rounded-lg font-medium hover:bg-gray-300 transition flex items-center justify-center">
                                        <i class="fa-solid fa-location-crosshairs mr-2"></i> Lấy vị trí hiện tại
                                    </button>
                                </div>
                                
                                <div class="relative">
                                    <div id="map" class="w-full h-64 rounded-lg border-2 border-color z-0"></div>
                                    <select id="map-layer-select" class="absolute top-2 right-2 z-[1000] p-2 rounded-lg border border-color bg-secondary text-primary shadow-lg text-sm">
                                        <option value="original">Nguyên bản</option>
                                        <option value="satellite">Vệ tinh</option>
                                        <option value="dark">Tối</option>
                                    </select>
                                </div>
                                <input type="hidden" id="location-lat" name="location-lat">
                                <input type="hidden" id="location-lng" name="location-lng">

                                <!-- Số người & Tổng tiền -->
                                <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                                    <div>
                                        <label for="people-count" class="block text-sm font-medium text-secondary mb-1">Số người</label>
                                        <div class="flex">
                                            <button type="button" id="people-decrement" class="bg-muted text-secondary px-3 rounded-l-lg hover:bg-gray-300 transition">-</button>
                                            <input type="number" id="people-count" name="people-count" min="1" required class="w-full p-3 border-t border-b border-color text-center focus:ring-2 focus:ring-[var(--text-accent)] bg-muted" placeholder="0">
                                            <button type="button" id="people-increment" class="bg-muted text-secondary px-3 rounded-r-lg hover:bg-gray-300 transition">+</button>
                                            <button type="button" id="people-max" class="accent-primary accent-primary-hover text-white px-3 rounded-lg transition ml-2 text-sm font-medium">Max</Sbutton>
                                        </div>
                                    </div>
                                    <div>
                                        <label for="total-cost" class="block text-sm font-medium text-secondary mb-1">Tổng tiền (VNĐ)</label>
                                        <input type="text" id="total-cost" name="total-cost" min="0" class="w-full p-3 border border-color rounded-lg focus:ring-2 focus:ring-[var(--text-accent)] bg-muted" placeholder="Ví dụ: 1.000.000">
                                    </div>
                                </div>

                                <!-- Ngày & Giờ -->
                                <div>
                                    <div class="flex justify-between items-center mb-1">
                                        <label class="block text-sm font-medium text-secondary">Ngày & Giờ</label>
                                        <!-- (MỚI) Nút lấy thời gian hiện tại -->
                                        <button type="button" id="get-current-time-btn" class="text-xs text-accent font-medium hover:underline">
                                            <i class="fa-solid fa-clock"></i> Bây giờ
                                        </button>
                                    </div>
                                    <div class="grid grid-cols-2 gap-4">
                                        <input type="text" id="trip-date" name="trip-date" class="w-full p-3 border border-color rounded-lg focus:ring-2 focus:ring-[var(--text-accent)] bg-muted" placeholder="DD/MM/YYYY">
                                        <!-- (SỬA ĐỔI) Thêm maxLength để xử lý auto-format -->
                                        <input type="text" id="trip-time" name="trip-time" class="w-full p-3 border border-color rounded-lg focus:ring-2 focus:ring-[var(--text-accent)] bg-muted" placeholder="HH:MM (ví dụ 1930)" maxlength="5">
                                    </div>
                                </div>

                                <!-- Đánh giá -->
                                <div>
                                    <label class="block text-sm font-medium text-secondary mb-2">Đánh giá</label>
                                    <div id="star-rating" class="flex items-center space-x-1 text-3xl text-gray-300">
                                        <i class="fa-regular fa-star cursor-pointer" data-value="1"></i>
                                        <i class="fa-regular fa-star cursor-pointer" data-value="2"></i>
                                        <i class="fa-regular fa-star cursor-pointer" data-value="3"></i>
                                        <i class="fa-regular fa-star cursor-pointer" data-value="4"></i>
                                        <i class="fa-regular fa-star cursor-pointer" data-value="5"></i>
                                    </div>
                                    <input type="hidden" id="rating-value" name="rating-value" value="0">
                                </div>

                                <!-- Ghi chú -->
                                <div>
                                    <label for="notes" class="block text-sm font-medium text-secondary mb-1">Ghi chú</label>
                                    <textarea id="notes" name="notes" rows="3" class="w-full p-3 border border-color rounded-lg focus:ring-2 focus:ring-[var(--text-accent)] bg-muted" placeholder="Thêm mô tả, bình luận..."></textarea>
                                </div>
                                
                                <div id="message-box-home" class="text-center font-medium h-6"></div>
                                
                                <!-- (SỬA ĐỔI) Thêm ID cho nút Submit -->
                                <button type="submit" id="form-submit-btn" class="w-full accent-primary accent-primary-hover text-white p-3 rounded-lg font-semibold transition shadow-md text-lg">
                                    <i class="fa-solid fa-check mr-2"></i> Xác nhận & Lưu
                                </button>
                            </form>
                        </div>
                        
                        <!-- Tab con: Lịch sử -->
                        <div id="internal-tab-history" class="internal-tab-pane bg-secondary p-4 sm:p-6 rounded-xl shadow-lg">
                            <div id="message-box-history" class="text-center font-medium h-6 mb-4"></div>
                            
                            <div class="flex flex-wrap gap-2 mb-4">
                                <button id="export-trip-txt" class="flex-1 min-w-[120px] accent-primary accent-primary-hover text-white px-3 py-2 rounded-lg text-sm font-medium transition shadow-sm">
                                    <i class="fa-solid fa-file-alt mr-1"></i> Xuất .txt
                                </button>
                                <button id="export-trip-csv" class="flex-1 min-w-[120px] accent-secondary accent-secondary-hover text-white px-3 py-2 rounded-lg text-sm font-medium transition shadow-sm">
                                    <i class="fa-solid fa-file-excel mr-1"></i> Xuất .csv
                                </button>
                            </div>

                            <div id="history-list" class="space-y-4 max-h-[800px] overflow-y-auto pr-2 mt-4">
                                <div id="empty-history" class="text-center text-secondary p-8 border-2 border-dashed border-color rounded-lg">
                                    <i class="fa-solid fa-map-signs text-4xl mb-4"></i>
                                    <p>Chuyến đi này chưa có địa điểm nào.</p>
                                    <p>Hãy thêm địa điểm đầu tiên ở tab "Thêm"!</p>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Tab con: Thống kê -->
                        <div id="internal-tab-stats" class="internal-tab-pane bg-secondary p-4 sm:p-6 rounded-xl shadow-lg">
                            <h2 class="text-2xl font-semibold text-primary border-b border-color pb-3 mb-4">
                                <i class="fa-solid fa-chart-pie mr-2"></i> Thống kê Chuyến đi
                            </h2>
                            <div id="stats-content" class="space-y-4">
                                <!-- Thống kê sẽ được JS thêm vào đây -->
                            </div>
                        </div>
                    </div>
                </div> <!-- Hết View con 1.2 -->

            </div> <!-- Hết View 1 -->

            <!-- (MỚI) View 2: Tiện ích -->
            <div id="view-utilities" class="main-view-pane">
                <div class="bg-secondary p-6 rounded-xl shadow-lg">
                    <h2 class="text-2xl font-semibold text-primary border-b border-color pb-3 mb-4">
                        <i class="fa-solid fa-wand-magic-sparkles mr-2"></i> Tiện ích
                    </h2>
                    <div class="text-center text-secondary p-8 border-2 border-dashed border-color rounded-lg">
                        <i class="fa-solid fa-helmet-safety text-4xl mb-4"></i>
                        <p>Tính năng đang được phát triển!</p>
                    </div>
                </div>
            </div>

            <!-- (MỚI) View 3: Cài đặt -->
            <div id="view-settings" class="main-view-pane">
                <div class="bg-secondary p-6 rounded-xl shadow-lg">
                    <h2 class="text-2xl font-semibold text-primary border-b border-color pb-3 mb-4">
                        <i class="fa-solid fa-cog mr-2"></i> Cài đặt
                    </h2>
                    
                    <!-- Chọn Giao diện (Theme) -->
                    <div class="space-y-2">
                        <h3 class="text-lg font-medium text-primary">Giao diện (Theme)</h3>
                        <div class="bg-muted p-4 rounded-lg space-y-3" id="theme-selector">
                            <label class="flex items-center space-x-3 cursor-pointer">
                                <input type="radio" name="theme" value="basic" class="text-[var(--accent-primary)] focus:ring-[var(--text-accent)] w-5 h-5">
                                <span class="text-secondary text-base">Cơ bản (Sáng)</span>
                            </label>
                            <label class="flex items-center space-x-3 cursor-pointer">
                                <input type="radio" name="theme" value="dark" class="text-[var(--accent-primary)] focus:ring-[var(--text-accent)] w-5 h-5">
                                <span class="text-secondary text-base">Tối (Dark Mode)</span>
                            </label>
                            <label class="flex items-center space-x-3 cursor-pointer">
                                <input type="radio" name="theme" value="cute" class="text-[var(--accent-primary)] focus:ring-[var(--text-accent)] w-5 h-5">
                                <span class="text-secondary text-base">Dễ thương (Hồng)</span>
                            </label>
                        </div>
                    </div>
                </div>
            </div>

        </div>
    </main>

    <!-- (MỚI) Thanh Menu Dưới -->
    <nav id="bottom-menu" class="flex justify-around p-2">
        <button class="bottom-menu-button active flex flex-col items-center p-2" data-view="share-go">
            <i class="fa-solid fa-route fa-lg"></i>
            <span class="text-xs font-medium mt-1">Share&Go</span>
        </button>
        <button class="bottom-menu-button flex flex-col items-center p-2" data-view="utilities">
            <i class="fa-solid fa-wand-magic-sparkles fa-lg"></i>
            <span class="text-xs font-medium mt-1">Tiện ích</span>
        </button>
        <button class="bottom-menu-button flex flex-col items-center p-2" data-view="settings">
            <i class="fa-solid fa-cog fa-lg"></i>
            <span class="text-xs font-medium mt-1">Cài đặt</span>
        </button>
    </nav>

    <script>
        document.addEventListener('DOMContentLoaded', () => {

            // --- Biến toàn cục ---
            let trips = [];
            let currentTripId = null;
            let map;
            let marker;
            let currentRating = 0;
            let currentTileLayer;
            let currentSettings = { theme: 'basic', mapLayer: 'original' };
            let editingPlaceId = null; // (MỚI) ID địa điểm đang sửa

            // URL các layer bản đồ
            const mapLayers = {
                original: {
                    url: 'https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',
                    attribution: '&copy; OpenStreetMap contributors | Hunq Maps'
                },
                satellite: {
                    url: 'https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}',
                    attribution: 'Tiles &copy; Esri'
                },
                dark: {
                    url: 'https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png',
                    attribution: '&copy; OpenStreetMap contributors &copy; CARTO'
                }
            };

            // --- (MỚI) Biến View Chính (Bottom Menu) ---
            const mainViewPanes = document.querySelectorAll('.main-view-pane');
            const bottomMenuButtons = document.querySelectorAll('.bottom-menu-button');

            // --- (MỚI) Biến View "ShareGo" (Internal Views) ---
            const viewTripsList = document.getElementById('view-trips-list');
            const viewTripDetails = document.getElementById('view-trip-details');
            const backToTripsBtn = document.getElementById('back-to-trips-btn');

            // --- Biến Tab bên trong Chuyến đi ---
            const internalTabButtons = document.querySelectorAll('.internal-tab-button');
            const internalTabPanes = document.querySelectorAll('.internal-tab-pane');

            // --- Biến Form Tạo Chuyến đi ---
            const toggleCreateTripBtn = document.getElementById('toggle-create-trip-btn');
            const createTripContainer = document.getElementById('create-trip-container');
            const createTripForm = document.getElementById('create-trip-form');
            const tripNameInput = document.getElementById('trip-name');
            const tripParticipantsInput = document.getElementById('trip-participants');
            const tripDescriptionInput = document.getElementById('trip-description');
            const tripsList = document.getElementById('trips-list');
            const emptyTrips = document.getElementById('empty-trips');

            // --- Biến Form Thêm Địa điểm ---
            const form = document.getElementById('trip-form');
            const formSubmitBtn = document.getElementById('form-submit-btn'); // (MỚI)
            const placeNameInput = document.getElementById('place-name');
            const locationNameInput = document.getElementById('location-name');
            const suggestionsBox = document.getElementById('suggestions-box');
            const searchLocationBtn = document.getElementById('search-location-btn');
            const geolocateBtn = document.getElementById('geolocate-btn');
            const latInput = document.getElementById('location-lat');
            const lngInput = document.getElementById('location-lng');
            const peopleInput = document.getElementById('people-count');
            const peopleDecrementBtn = document.getElementById('people-decrement');
            const peopleIncrementBtn = document.getElementById('people-increment');
            const peopleMaxBtn = document.getElementById('people-max');
            const costInput = document.getElementById('total-cost');
            const dateInput = document.getElementById('trip-date');
            const timeInput = document.getElementById('trip-time');
            const getCurrentTimeBtn = document.getElementById('get-current-time-btn'); // (MỚI)
            const stars = document.querySelectorAll('#star-rating .fa-star');
            const ratingValue = document.getElementById('rating-value');
            const notesInput = document.getElementById('notes');
            const msgBoxHome = document.getElementById('message-box-home');
            const mapLayerSelect = document.getElementById('map-layer-select');

            // --- Biến Lịch sử & Thống kê ---
            const historyList = document.getElementById('history-list');
            const emptyHistory = document.getElementById('empty-history');
            const msgBoxHistory = document.getElementById('message-box-history');
            const exportTripTxtBtn = document.getElementById('export-trip-txt');
            const exportTripCsvBtn = document.getElementById('export-trip-csv');
            const statsContent = document.getElementById('stats-content');
            
            // --- Biến Cài đặt ---
            const themeSelector = document.getElementById('theme-selector');

            // --- 1. Xử lý Navigation (Điều hướng) ---
            
            // (MỚI) Hiển thị View chính (Bottom Menu)
            function showMainView(viewId) {
                mainViewPanes.forEach(pane => pane.classList.remove('active'));
                document.getElementById(`view-${viewId}`).classList.add('active');
                
                bottomMenuButtons.forEach(btn => {
                    btn.classList.toggle('active', btn.dataset.view === viewId);
                });
            }

            bottomMenuButtons.forEach(btn => {
                btn.addEventListener('click', () => showMainView(btn.dataset.view));
            });

            // (MỚI) Hiển thị View con (bên trong Share&Go)
            function showInternalView(viewId) {
                document.querySelectorAll('.internal-view-pane').forEach(pane => pane.classList.remove('active'));
                document.getElementById(viewId).classList.add('active');
            }

            backToTripsBtn.addEventListener('click', () => {
                currentTripId = null;
                showInternalView('view-trips-list');
                createTripContainer.classList.add('hidden');
                toggleCreateTripBtn.innerHTML = '<i class="fa-solid fa-plus mr-2"></i> Tạo chuyến đi mới';
            });
            
            // Hiển thị Tab con (bên trong Chi tiết Chuyến đi)
            function showInternalTab(targetId) {
                internalTabPanes.forEach(pane => pane.classList.remove('active'));
                internalTabButtons.forEach(btn => btn.classList.remove('active'));
                
                const pane = document.getElementById(targetId);
                if (pane) pane.classList.add('active');
                
                const btn = document.querySelector(`.internal-tab-button[data-tab="${targetId}"]`);
                if (btn) btn.classList.add('active');

                if (targetId === 'internal-tab-add' && map) {
                    setTimeout(() => map.invalidateSize(), 100);
                }
            }

            internalTabButtons.forEach(btn => btn.addEventListener('click', () => showInternalTab(btn.dataset.tab)));

            // --- 2. Xử lý Cài đặt (Settings) ---
            function saveSettings() {
                try {
                    localStorage.setItem('shareGoSettings', JSON.stringify(currentSettings));
                } catch (e) { console.error("Lỗi lưu cài đặt:", e); }
            }

            function loadSettings() {
                try {
                    const data = localStorage.getItem('shareGoSettings');
                    if (data) {
                        currentSettings = JSON.parse(data);
                    }
                } catch (e) { console.error("Lỗi tải cài đặt:", e); }
                
                applyTheme(currentSettings.theme);
                updateMapLayer(currentSettings.mapLayer);
                
                const themeRadio = document.querySelector(`#theme-selector input[value="${currentSettings.theme}"]`);
                if (themeRadio) themeRadio.checked = true;
                
                mapLayerSelect.value = currentSettings.mapLayer;
            }

            function applyTheme(themeName) {
                document.documentElement.dataset.theme = themeName;
            }

            function updateMapLayer(layerName) {
                if (!mapLayers[layerName]) layerName = 'original';
                const { url, attribution } = mapLayers[layerName];

                if (currentTileLayer) {
                    map.removeLayer(currentTileLayer);
                }
                
                if(map) {
                     currentTileLayer = L.tileLayer(url, { attribution }).addTo(map);
                }
                
                currentSettings.mapLayer = layerName;
            }

            themeSelector.addEventListener('change', (e) => {
                const newTheme = e.target.value;
                currentSettings.theme = newTheme;
                applyTheme(newTheme);
                saveSettings();
            });

            mapLayerSelect.addEventListener('change', (e) => {
                const newLayer = e.target.value;
                updateMapLayer(newLayer);
                currentSettings.mapLayer = newLayer;
                saveSettings();
            });

            // --- 3. Xử lý lưu/tải Dữ liệu Chuyến đi ---
            function saveData() {
                try {
                    localStorage.setItem('shareGoTrips', JSON.stringify(trips));
                } catch (e) { console.error("Lỗi lưu chuyến đi:", e); }
            }

            function loadData() {
                try {
                    const data = localStorage.getItem('shareGoTrips');
                    return data ? JSON.parse(data) : [];
                } catch (e) {
                    console.error("Lỗi tải chuyến đi:", e);
                    return [];
                }
            }

            // --- 4. Khởi tạo Bản đồ Leaflet ---
            function initMap() {
                map = L.map('map', { attributionControl: false }).setView([21.0285, 105.8542], 13);
                updateMapLayer(currentSettings.mapLayer);
                map.on('click', onMapClick);
            }

            // --- 5. Xử lý sự kiện Bản đồ ---
            function onMapClick(e) {
                const { lat, lng } = e.latlng;
                updateMarker(lat, lng);
                reverseGeocode(lat, lng);
            }
            function updateMarker(lat, lng, shouldZoom = true) {
                if (marker) {
                    marker.setLatLng([lat, lng]);
                } else {
                    marker = L.marker([lat, lng], { draggable: true }).addTo(map);
                    marker.on('dragend', function(e) {
                        const { lat, lng } = e.target.getLatLng();
                        latInput.value = lat;
                        lngInput.value = lng;
                        reverseGeocode(lat, lng);
                    });
                }
                if (shouldZoom) map.setView([lat, lng], 15);
                latInput.value = lat;
                lngInput.value = lng;
            }
            function removeMarker() {
                if (marker) {
                    map.removeLayer(marker);
                    marker = null;
                }
            }
            async function reverseGeocode(lat, lng) {
                try {
                    const response = await fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lng}&accept-language=vi`);
                    if (!response.ok) throw new Error('Network error');
                    const data = await response.json();
                    if (data && data.display_name) {
                        locationNameInput.value = data.display_name;
                        clearSuggestions();
                    }
                } catch (error) {
                    console.error('Lỗi reverseGeocode:', error);
                    locationNameInput.value = `Tọa độ: ${lat.toFixed(5)}, ${lng.toFixed(5)}`;
                }
            }
            
            // --- 6. Xử lý Nút định vị & Tìm kiếm & Gợi ý ---
            geolocateBtn.addEventListener('click', () => {
                if (!navigator.geolocation) {
                    showMessage('home', 'Trình duyệt không hỗ trợ định vị.', 'error'); return;
                }
                geolocateBtn.disabled = true;
                geolocateBtn.innerHTML = '<i class="fa-solid fa-spinner fa-spin mr-2"></i> Đang tìm...';
                navigator.geolocation.getCurrentPosition(
                    (position) => {
                        const { latitude, longitude } = position.coords;
                        updateMarker(latitude, longitude);
                        reverseGeocode(latitude, longitude);
                        geolocateBtn.disabled = false;
                        geolocateBtn.innerHTML = '<i class="fa-solid fa-location-crosshairs mr-2"></i> Lấy vị trí hiện tại';
                    },
                    (error) => {
                        showMessage('home', 'Không thể lấy vị trí.', 'error');
                        geolocateBtn.disabled = false;
                        geolocateBtn.innerHTML = '<i class="fa-solid fa-location-crosshairs mr-2"></i> Lấy vị trí hiện tại';
                    }
                );
            });
            
            searchLocationBtn.addEventListener('click', async () => {
                const query = locationNameInput.value;
                if (!query) { showMessage('home', 'Vui lòng nhập địa chỉ để tìm.', 'error'); return; }
                searchLocationBtn.disabled = true;
                searchLocationBtn.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i>';
                try {
                    const response = await fetch(`https://nominatim.openstreetmap.org/search?q=${encodeURIComponent(query)}&format=json&limit=1&accept-language=vi`);
                    if (!response.ok) throw new Error('Network error');
                    const data = await response.json();
                    if (data && data.length > 0) {
                        const { lat, lon, display_name } = data[0];
                        locationNameInput.value = display_name;
                        updateMarker(parseFloat(lat), parseFloat(lon));
                        clearSuggestions();
                        showMessage('home', 'Đã tìm thấy vị trí!', 'success');
                    } else {
                        showMessage('home', 'Không tìm thấy vị trí.', 'error');
                    }
                } catch (error) {
                    console.error('Lỗi tìm kiếm:', error);
                    showMessage('home', 'Lỗi kết nối khi tìm kiếm.', 'error');
                }
                searchLocationBtn.disabled = false;
                searchLocationBtn.innerHTML = '<i class="fa-solid fa-search"></i>';
            });

            let debounceTimer;
            function debounce(func, delay) {
                return function() {
                    const context = this;
                    const args = arguments;
                    clearTimeout(debounceTimer);
                    debounceTimer = setTimeout(() => func.apply(context, args), delay);
                };
            }
            async function fetchSuggestions() {
                const query = locationNameInput.value;
                if (query.length < 3) { clearSuggestions(); return; }
                try {
                    const response = await fetch(`https://nominatim.openstreetmap.org/search?q=${encodeURIComponent(query)}&format=json&limit=5&accept-language=vi`);
                    if (!response.ok) throw new Error('Network error');
                    const data = await response.json();
                    if (data && data.length > 0) {
                        suggestionsBox.innerHTML = '';
                        suggestionsBox.classList.remove('hidden');
                        data.forEach(item => {
                            const div = document.createElement('div');
                            div.textContent = item.display_name;
                            div.onclick = () => {
                                locationNameInput.value = item.display_name;
                                updateMarker(parseFloat(item.lat), parseFloat(item.lon));
                                clearSuggestions();
                            };
                            suggestionsBox.appendChild(div);
                        });
                    } else {
                        clearSuggestions();
                    }
                } catch (error) {
                    console.error('Lỗi lấy gợi ý:', error);
                    clearSuggestions();
                }
            }
            function clearSuggestions() {
                suggestionsBox.innerHTML = '';
                suggestionsBox.classList.add('hidden');
            }
            locationNameInput.addEventListener('input', debounce(fetchSuggestions, 300));
            document.addEventListener('click', (e) => {
                if (!locationNameInput.contains(e.target) && !suggestionsBox.contains(e.target)) {
                    clearSuggestions();
                }
            });

            // --- 7. Xử lý Đánh giá Sao ---
            stars.forEach(star => {
                star.addEventListener('click', () => {
                    currentRating = parseInt(star.dataset.value);
                    ratingValue.value = currentRating;
                    updateStars();
                });
                star.addEventListener('mouseover', () => {
                    const hoverValue = parseInt(star.dataset.value);
                    stars.forEach((s, index) => {
                        s.classList.toggle('fa-solid', index < hoverValue);
                        s.classList.toggle('text-yellow-400', index < hoverValue);
                        s.classList.toggle('fa-regular', index >= hoverValue);
                        s.classList.toggle('text-gray-300', index >= hoverValue);
                    });
                });
                star.addEventListener('mouseout', () => updateStars());
            });
            function updateStars() {
                stars.forEach((s, index) => {
                    s.classList.toggle('fa-solid', index < currentRating);
                    s.classList.toggle('text-yellow-400', index < currentRating);
                    s.classList.toggle('fa-regular', index >= currentRating);
                    s.classList.toggle('text-gray-300', index >= currentRating);
                });
            }
            function resetStars() {
                currentRating = 0;
                ratingValue.value = 0;
                updateStars();
            }

            // --- 8. Xử lý Input đặc biệt (Số người, Tiền, Ngày/Giờ) ---
            peopleDecrementBtn.addEventListener('click', () => {
                let val = parseInt(peopleInput.value) || 1;
                if (val > 1) peopleInput.value = val - 1;
            });
            peopleIncrementBtn.addEventListener('click', () => {
                let val = parseInt(peopleInput.value) || 0;
                peopleInput.value = val + 1;
            });
            peopleMaxBtn.addEventListener('click', () => {
                const trip = trips.find(t => t.id == currentTripId);
                if (trip) peopleInput.value = trip.participants;
                
                
            });
            

            costInput.addEventListener('input', (e) => {
                let rawValue = e.target.value.replace(/\./g, '').replace(/[^0-9]/g, '');
                if (rawValue) e.target.value = new Intl.NumberFormat('vi-VN').format(parseInt(rawValue));
                else e.target.value = '';
            });

            // (MỚI) Auto-format giờ
            timeInput.addEventListener('input', (e) => {
                let val = e.target.value.replace(/[^0-9]/g, '');
                if (val.length > 2) {
                    val = val.substring(0, 2) + ':' + val.substring(2, 4);
                }
                e.target.value = val;
            });

            // (MỚI) Nút lấy giờ hiện tại
            getCurrentTimeBtn.addEventListener('click', setDefaultDateTime);

            function setDefaultDateTime() {
                const now = new Date();
                const day = String(now.getDate()).padStart(2, '0');
                const month = String(now.getMonth() + 1).padStart(2, '0');
                const year = now.getFullYear();
                const hours = String(now.getHours()).padStart(2, '0');
                const minutes = String(now.getMinutes()).padStart(2, '0');
                dateInput.value = `${day}/${month}/${year}`;
                timeInput.value = `${hours}:${minutes}`;
            }

            // --- 9. Xử lý Tab Chuyến đi (Tours) ---
            toggleCreateTripBtn.addEventListener('click', () => {
                const isHidden = createTripContainer.classList.toggle('hidden');
                toggleCreateTripBtn.innerHTML = isHidden
                    ? '<i class="fa-solid fa-plus mr-2"></i> Tạo chuyến đi mới'
                    : '<i class="fa-solid fa-times mr-2"></i> Hủy';
            });

            createTripForm.addEventListener('submit', (e) => {
                e.preventDefault();
                const newTrip = {
                    id: Date.now(),
                    name: tripNameInput.value,
                    description: tripDescriptionInput.value,
                    participants: parseInt(tripParticipantsInput.value),
                    places: []
                };
                trips.unshift(newTrip);
                saveData();
                renderTripsList();
                createTripForm.reset();
                
                createTripContainer.classList.add('hidden');
                toggleCreateTripBtn.innerHTML = '<i class="fa-solid fa-plus mr-2"></i> Tạo chuyến đi mới';
                showMessage('history', `Đã tạo chuyến đi "${newTrip.name}"!`, 'success');
            });

            function renderTripsList() {
                if (trips.length === 0) {
                    tripsList.innerHTML = '';
                    tripsList.appendChild(emptyTrips);
                    return;
                }
                tripsList.innerHTML = '';
                trips.forEach(trip => {
                    const item = document.createElement('div');
                    item.className = 'bg-muted border border-color p-4 rounded-lg shadow-sm';
                    item.innerHTML = `
                        <div class="flex justify-between items-start">
                            <div>
                                <h3 class="text-xl font-semibold text-accent">${trip.name}</h3>
                                
                                <p class="text-sm text-secondary italic">${trip.description || 'Không có mô tả'}</p>
                                <p class="text-sm text-secondary mt-1"><i class="fa-solid fa-users mr-2"></i> ${trip.participants} người</p>
                            </div>
                        </div>
                        <div class="mt-4 pt-4 border-t border-color flex gap-2">
                            <button class="manage-trip-btn flex-1 accent-primary accent-primary-hover text-white px-3 py-2 rounded-lg text-sm font-medium" data-id="${trip.id}">
                                <i class="fa-solid fa-folder-open mr-1"></i> Quản lý
                            </button>
                            <button class="delete-trip-btn text-destructive hover:text-red-700 transition px-3 py-2 rounded-lg bg-secondary border border-color" data-id="${trip.id}" title="Xóa chuyến đi">
                                <i class="fa-solid fa-trash-can"></i>
                            </button>
                        </div>
                    `;
                    tripsList.appendChild(item);
                });
            }

            tripsList.addEventListener('click', (e) => {
                const target = e.target.closest('button');
                if (!target) return;

                const tripId = target.dataset.id;
                const trip = trips.find(t => t.id == tripId);
                if (!trip) return;

                if (target.classList.contains('manage-trip-btn')) {
                    currentTripId = trip.id;
                    renderCurrentTripDetails(trip);
                    showInternalView('view-trip-details');
                    showInternalTab('internal-tab-add');
                    setDefaultDateTime();
                }

                if (target.classList.contains('delete-trip-btn')) {
                    if (confirm(`Bạn có chắc chắn muốn xóa chuyến đi "${trip.name}" không? Mọi địa điểm bên trong cũng sẽ bị xóa.`)) {
                        trips = trips.filter(t => t.id != tripId);
                        saveData();
                        renderTripsList();
                        showMessage('history', 'Đã xóa chuyến đi!', 'success');
                    }
                }
            });
            
            // --- 10. Xử lý Chi tiết Chuyến đi (View 2) ---
            function renderCurrentTripDetails(trip) {
                document.getElementById('current-trip-title').textContent = trip.name;
                renderTripHistory(trip);
                renderTripStats(trip);
                resetForm();
                
            }
            
            function renderTripHistory(trip) {
                if (trip.places.length === 0) {
                    historyList.innerHTML = '';
                    historyList.appendChild(emptyHistory);
                    return;
                }
                historyList.innerHTML = '';
                
                const sortedPlaces = [...trip.places].sort((a, b) => b.id - a.id);
                
                sortedPlaces.forEach(place => {
                    const item = document.createElement('div');
                    item.className = 'bg-muted border border-color p-4 rounded-lg shadow-sm space-y-2';
                    const costFormatter = new Intl.NumberFormat('vi-VN', { style: 'currency', currency: 'VND' });
                    let ratingStars = Array.from({ length: 5 }, (_, i) => 
                        i < place.rating
                            ? '<i class="fa-solid fa-star text-yellow-400"></i>'
                            : '<i class="fa-regular fa-star text-gray-300"></i>'
                    ).join('');
                    const googleMapsLink = (place.lat && place.lng)
                        ? `<a href="https://www.google.com/maps?q=${place.lat},${place.lng}" target="_blank" class="text-xs text-[var(--text-accent)] hover:underline ml-2">
                               <i class="fa-solid fa-map-location-dot mr-1"></i>Mở trên Google Maps
                           </a>`
                        : '';

                    item.innerHTML = `
                        <h3 class="text-lg font-semibold text-primary">${place.placeName}</h3>
                        <div class="flex items-center">
                            ${place.locationName ? `<p class="text-sm text-secondary"><i class="fa-solid fa-map-marker-alt w-4 mr-1 text-red-500"></i> ${place.locationName}</p>` : ''}
                            ${googleMapsLink}
                        </div>
                        <p class="text-sm text-secondary"><i class="fa-solid fa-calendar-alt w-4 mr-1 text-blue-500"></i> ${place.date || '...'} - ${place.time || '...'}</p>
                        <div class="flex flex-wrap justify-between text-sm pt-2 border-t border-color">
                            <span class="mb-1"><i class="fa-solid fa-users w-4 mr-1 text-teal-500"></i> ${place.people} người</span>
                            <span class="mb-1"><i class="fa-solid fa-money-bill-wave w-4 mr-1 text-green-500"></i> ${costFormatter.format(place.totalCost)}</span>
                            ${place.costPerPerson > 0 ? `<span class="font-medium text-green-700 mb-1"><i class="fa-solid fa-calculator w-4 mr-1"></i> ${costFormatter.format(place.costPerPerson)}/người</span>` : ''}
                        </div>
                        ${place.rating > 0 ? `<div class="text-base">${ratingStars}</div>` : ''}
                        ${place.notes ? `<p class="text-sm text-primary bg-primary p-2 rounded-md italic"><i class="fa-solid fa-pen w-4 mr-1 opacity-70"></i> ${place.notes.replace(/\n/g, '<br>')}</p>` : ''}
                        
                        <!-- (MỚI) Các nút hành động -->
                        <div class="flex gap-2 pt-2 border-t border-color mt-2">
                            <button class="edit-place-btn flex-1 bg-secondary text-secondary hover:text-accent border border-color px-3 py-1 rounded-lg text-xs font-medium transition" data-id="${place.id}">
                                <i class="fa-solid fa-pen-to-square mr-1"></i> Sửa
                            </button>
                            <button class="copy-place-btn flex-1 bg-secondary text-secondary hover:text-accent border border-color px-3 py-1 rounded-lg text-xs font-medium transition" data-id="${place.id}">
                                <i class="fa-solid fa-copy mr-1"></i> Sao chép
                            </button>
                            <button class="delete-place-btn flex-1 bg-secondary text-destructive hover:bg-red-50 border border-color px-3 py-1 rounded-lg text-xs font-medium transition" data-id="${place.id}">
                                <i class="fa-solid fa-trash-can mr-1"></i> Xóa
                            </button>
                        </div>
                    `;
                    historyList.appendChild(item);
                });
            }

            function renderTripStats(trip) {
                const totalPlaces = trip.places.length;
                const totalCost = trip.places.reduce((sum, place) => sum + (place.totalCost || 0), 0);
                const ratedPlaces = trip.places.filter(p => p.rating > 0);
                const avgRating = ratedPlaces.length > 0
                    ? (ratedPlaces.reduce((sum, p) => sum + p.rating, 0) / ratedPlaces.length)
                    : 0;
                const avgRatingStars = Array.from({ length: 5 }, (_, i) => 
                    i < Math.round(avgRating)
                        ? '<i class="fa-solid fa-star text-yellow-400"></i>'
                        : '<i class="fa-regular fa-star text-gray-300"></i>'
                ).join('');
                const costFormatter = new Intl.NumberFormat('vi-VN', { style: 'currency', currency: 'VND' });

                statsContent.innerHTML = `
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div class="bg-muted p-4 rounded-lg text-center">
                            <i class="fa-solid fa-map-pin text-3xl text-red-500 mb-2"></i>
                            <p class="text-lg font-semibold text-primary">${totalPlaces}</p>
                            <p class="text-sm text-secondary">Địa điểm đã ghé thăm</p>
                        </div>
                        <div class="bg-muted p-4 rounded-lg text-center">
                            <i class="fa-solid fa-money-bill-wave text-3xl text-green-500 mb-2"></i>
                            <p class="text-lg font-semibold text-primary">${costFormatter.format(totalCost)}</p>
                            <p class="text-sm text-secondary">Tổng chi tiêu</p>
                        </div>
                    </div>
                    <div class="bg-muted p-4 rounded-lg text-center mt-4">
                        <i class="fa-solid fa-star-half-alt text-3xl text-yellow-500 mb-2"></i>
                        <p class="text-lg font-semibold text-primary">${avgRating.toFixed(1)} / 5.0</p>
                        <div class="text-xl my-2">${avgRatingStars}</div>
                        <p class="text-sm text-secondary">Đánh giá trung bình</p>
                    </div>
                `;
            }

            // --- 11. Xử lý Form Submit (Thêm & Sửa Địa điểm) ---
            form.addEventListener('submit', (e) => {
                e.preventDefault();
                const selectedTrip = trips.find(t => t.id == currentTripId);
                if (!selectedTrip) {
                    showMessage('home', 'Lỗi: Không tìm thấy chuyến đi.', 'error');
                    return;
                }

                const people = parseInt(peopleInput.value);
                const cost = parseFloat(costInput.value.replace(/\./g, '')) || 0;
                let costPerPerson = (cost > 0 && people > 0) ? (cost / people) : 0;

                // (SỬA ĐỔI) Kiểm tra xem đang Sửa hay Thêm mới
                if (editingPlaceId) {
                    // --- CHẾ ĐỘ SỬA ---
                    const place = selectedTrip.places.find(p => p.id == editingPlaceId);
                    if (place) {
                        place.placeName = placeNameInput.value;
                        place.locationName = locationNameInput.value;
                        place.lat = latInput.value;
                        place.lng = lngInput.value;
                        place.people = people;
                        place.totalCost = cost;
                        place.date = dateInput.value;
                        place.time = timeInput.value;
                        place.rating = parseInt(ratingValue.value);
                        place.notes = notesInput.value;
                        place.costPerPerson = costPerPerson;
                    }
                    saveData();
                    renderTripHistory(selectedTrip);
                    renderTripStats(selectedTrip);
                    resetForm();
                    showInternalTab('internal-tab-history');
                    showMessage('history', 'Đã cập nhật địa điểm!', 'success');
                } else {
                    // --- CHẾ ĐỘ THÊM MỚI ---
                    const placeData = {
                        id: Date.now(),
                        placeName: placeNameInput.value,
                        locationName: locationNameInput.value,
                        lat: latInput.value,
                        lng: lngInput.value,
                        people: people,
                        totalCost: cost,
                        date: dateInput.value,
                        time: timeInput.value,
                        rating: parseInt(ratingValue.value),
                        notes: notesInput.value,
                        costPerPerson: costPerPerson
                    };
                    
                    selectedTrip.places.push(placeData);
                    saveData();
                    renderTripHistory(selectedTrip);
                    renderTripStats(selectedTrip);
                    resetForm();
                    showInternalTab('internal-tab-history');
                    showMessage('history', 'Đã thêm địa điểm thành công!', 'success');
                }
            });
            
            function resetForm() {
                form.reset();
                resetStars();
                removeMarker();
                latInput.value = '';
                lngInput.value = '';
                setDefaultDateTime();
                
                // (MỚI) Reset trạng thái Sửa
                editingPlaceId = null;
                formSubmitBtn.innerHTML = '<i class="fa-solid fa-check mr-2"></i> Xác nhận & Lưu';
            }

            // --- 12. (MỚI) Xử lý Nút Lịch sử (Sửa, Xóa, Sao chép) ---
            historyList.addEventListener('click', (e) => {
                const target = e.target.closest('button');
                if (!target) return;
                
                const placeId = target.dataset.id;
                const trip = trips.find(t => t.id == currentTripId);
                if (!trip) return;
                const place = trip.places.find(p => p.id == placeId);
                if (!place) return;

                // Nút XÓA
                if (target.classList.contains('delete-place-btn')) {
                    if (confirm(`Bạn có chắc muốn xóa địa điểm "${place.placeName}"?`)) {
                        trip.places = trip.places.filter(p => p.id != placeId);
                        saveData();
                        renderTripHistory(trip);
                        renderTripStats(trip);
                        showMessage('history', 'Đã xóa địa điểm.', 'success');
                    }
                }

                // Nút SAO CHÉP
                if (target.classList.contains('copy-place-btn')) {
                    const text = generatePlaceText(place);
                    copyToClipboard(text, 'Đã sao chép vào clipboard!');
                }

                // Nút SỬA
                if (target.classList.contains('edit-place-btn')) {
                    editingPlaceId = place.id;
                    
                    placeNameInput.value = place.placeName;
                    locationNameInput.value = place.locationName || '';
                    latInput.value = place.lat || '';
                    lngInput.value = place.lng || '';
                    peopleInput.value = place.people;
                    costInput.value = place.totalCost > 0 ? new Intl.NumberFormat('vi-VN').format(place.totalCost) : '';
                    dateInput.value = place.date;
                    timeInput.value = place.time;
                    notesInput.value = place.notes || '';
                    ratingValue.value = place.rating;
                    currentRating = place.rating;
                    updateStars();
                    
                    if (place.lat && place.lng) {
                        updateMarker(place.lat, place.lng, true);
                    } else {
                        removeMarker();
                    }
                    
                    formSubmitBtn.innerHTML = '<i class="fa-solid fa-save mr-2"></i> Cập nhật Địa điểm';
                    
                    showInternalTab('internal-tab-add');
                    viewTripDetails.scrollIntoView({ behavior: 'smooth' });
                }
            });

            // (MỚI) Hàm trợ giúp Sao chép
            function generatePlaceText(place) {
                const costFormatter = new Intl.NumberFormat('vi-VN');
                return `
Địa điểm: ${place.placeName}
Vị trí: ${place.locationName || 'N/A'}
Thời gian: ${place.date} - ${place.time}
Số người: ${place.people}
Tổng tiền: ${costFormatter.format(place.totalCost)} VNĐ
Đánh giá: ${place.rating}/5 sao
Ghi chú: ${place.notes || 'N/A'}
                `.trim().replace(/ +/g, ' '); // Xóa khoảng trắng thừa
            }

            function copyToClipboard(text, message) {
                if (navigator.clipboard && navigator.clipboard.writeText) {
                    navigator.clipboard.writeText(text).then(() => {
                        showMessage('history', message, 'success');
                    }).catch(err => {
                        console.error('Lỗi sao chép:', err);
                        showMessage('history', 'Lỗi khi sao chép.', 'error');
                    });
                } else {
                    // Fallback cho môi trường không an toàn (ít khả năng)
                    try {
                        const textArea = document.createElement("textarea");
                        textArea.value = text;
                        document.body.appendChild(textArea);
                        textArea.focus();
                        textArea.select();
                        document.execCommand('copy');
                        document.body.removeChild(textArea);
                        showMessage('history', message, 'success');
                    } catch (err) {
                        console.error('Lỗi sao chép (fallback):', err);
                        showMessage('history', 'Lỗi khi sao chép.', 'error');
                    }
                }
            }


            // --- 13. Các hàm Xuất File (Cho từng chuyến đi) ---
            exportTripTxtBtn.addEventListener('click', () => {
                const trip = trips.find(t => t.id == currentTripId);
                if (!trip || trip.places.length === 0) {
                    showMessage('history', 'Chuyến đi này chưa có dữ liệu.', 'error'); return;
                }
                const content = generateTripTextContent(trip);
                downloadFile('\uFEFF' + content, `ShareGo_Trip_${trip.name}.txt`, 'text/plain;charset=utf-8');
            });

            exportTripCsvBtn.addEventListener('click', () => {
                const trip = trips.find(t => t.id == currentTripId);
                 if (!trip || trip.places.length === 0) {
                    showMessage('history', 'Chuyến đi này chưa có dữ liệu.', 'error'); return;
                }
                const content = generatePlacesCSV(trip.places, trip.name);
                
                downloadFile('\uFEFF' + content, `ShareGo_Trip_${trip.name}.csv`, 'text/csv;charset=utf-8;');
            });
            
            function generateTripTextContent(trip) {
                let text = `LỊCH SỬ CHUYẾN ĐI: ${trip.name}\n`;
                text += `Mô tả: ${trip.description}\n`;
                text += `Số người tham gia: ${trip.participants}\n`;
                text += "===================================\n\n";
                
                const sortedPlaces = [...trip.places].sort((a, b) => a.id - b.id);
                
                sortedPlaces.forEach((place, index) => {
                    text += `ĐỊA ĐIỂM #${index + 1}\n-----------------------------------\n`;
                    text += generatePlaceText(place) + "\n\n"; // Tái sử dụng hàm helper
                });
                return text;
            }

            function generatePlacesCSV(places, tripName) {
                const escapeCSV = (str) => `"${String(str === null || str === undefined ? '' : str).replace(/"/g, '""')}"`;
                const headers = ["ID", "Tên Chuyến đi", "Tên địa điểm", "Vị trí", "Latitude", "Longitude", "Số người", "Tổng tiền (VND)", "Tiền/người (VND)", "Ngày", "Giờ", "Đánh giá (1-5)", "Ghi chú"];
                let csvContent = headers.join(',') + '\n';
                const sortedPlaces = [...places].sort((a, b) => a.id - b.id);
                
                sortedPlaces.forEach(place => {
                    const row = [place.id, tripName, place.placeName, place.locationName, place.lat, place.lng, place.people, place.totalCost, place.costPerPerson, place.date, place.time, place.rating, place.notes].map(escapeCSV).join(',');
                    csvContent += row + '\n';
                });
                return csvContent;
            }
            
            function downloadFile(content, fileName, mimeType) {
                const a = document.createElement('a');
                const blob = new Blob([content], { type: mimeType });
                a.href = URL.createObjectURL(blob);
                a.download = fileName;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(a.href);
            }

            // --- 14. Hiển thị thông báo ---
            function showMessage(location, message, type = 'success') {
                const box = (location === 'home') ? msgBoxHome : msgBoxHistory;
                if (!box) return;
                box.textContent = message;
                box.className = `text-center font-medium h-6 mb-4 ${type === 'success' ? 'text-green-600' : 'text-red-500'}`;
                setTimeout(() => {
                    box.textContent = '';
                    box.className = 'text-center font-medium h-6 mb-4';
                }, 3000);
            }
            
            // --- Khởi tạo ---
            loadSettings();
            trips = loadData();
            initMap();
            renderTripsList();
            
            showMainView('share-go'); // Hiển thị view chính
            showInternalView('view-trips-list'); // Hiển thị view con
        });
    </script>
</body>
</html>

