<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>KitchenMind | Smart Assistant</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: { sans: ['Inter', 'sans-serif'] },
                    colors: {
                        accent: '#0f766e', // Teal 700
                        surface: '#f8fafc',
                    }
                }
            }
        }
    </script>
    <style>
        body { font-weight: 400; color: #334155; }
        input { outline: none; transition: all 0.2s; }
        input:focus { border-color: #0f766e; }
        .hide-scrollbar::-webkit-scrollbar { display: none; }
        .animate-fade { animation: fadeIn 0.3s ease-in-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body class="bg-surface h-screen flex flex-col overflow-hidden text-sm">

    <header class="bg-white border-b border-gray-200 px-6 py-4 flex justify-between items-center z-10">
        <div class="flex items-center gap-3">
            <div class="w-8 h-8 bg-accent text-white flex items-center justify-center rounded-lg font-bold">K</div>
            <h1 class="font-semibold text-gray-800 tracking-tight text-lg">KitchenMind</h1>
        </div>
        <div class="text-xs text-gray-400 font-medium">DATABASE: <span id="db-count">0</span> SKUs</div>
    </header>

    <main class="flex-1 flex overflow-hidden">
        
        <nav class="w-20 bg-white border-r border-gray-200 flex flex-col items-center py-6 gap-6 z-10">
            <button onclick="setTab('shop')" id="nav-shop" class="nav-btn w-10 h-10 rounded-lg flex items-center justify-center text-gray-400 hover:bg-gray-50 hover:text-accent transition-all active">
                <i class="fa-solid fa-cart-shopping text-xl"></i>
            </button>
            <button onclick="setTab('fridge')" id="nav-fridge" class="nav-btn w-10 h-10 rounded-lg flex items-center justify-center text-gray-400 hover:bg-gray-50 hover:text-accent transition-all">
                <i class="fa-solid fa-box text-xl"></i>
            </button>
            <button onclick="setTab('history')" id="nav-history" class="nav-btn w-10 h-10 rounded-lg flex items-center justify-center text-gray-400 hover:bg-gray-50 hover:text-accent transition-all">
                <i class="fa-solid fa-clock-rotate-left text-xl"></i>
            </button>
        </nav>

        <div class="flex-1 overflow-y-auto p-6 relative" id="app-container">
            </div>
    </main>

    <script>
        // --- CORE DATABASE SYSTEM ---
        const DB_KEY = 'kitchen_mind_db';
        const APP_STATE = {
            cart: [],
            fridge: [],
            history: [],
            masterDB: {} // Key: ProductName, Value: {lastPrice, lastTax, lastUnit...}
        };

        // --- UTILS ---
        const formatMoney = (n) => new Intl.NumberFormat('vi-VN', { style: 'currency', currency: 'VND' }).format(n);
        const el = (id) => document.getElementById(id);

        function loadData() {
            const saved = localStorage.getItem(DB_KEY);
            if (saved) {
                const parsed = JSON.parse(saved);
                Object.assign(APP_STATE, parsed);
            }
            updateDBCount();
        }

        function saveData() {
            localStorage.setItem(DB_KEY, JSON.stringify(APP_STATE));
            updateDBCount();
        }

        function updateDBCount() {
            el('db-count').innerText = Object.keys(APP_STATE.masterDB).length;
        }

        // --- VIEW ENGINE ---
        function setTab(tab) {
            document.querySelectorAll('.nav-btn').forEach(b => {
                b.classList.remove('bg-gray-100', 'text-accent');
                b.classList.add('text-gray-400');
            });
            document.getElementById(`nav-${tab}`).classList.add('bg-gray-100', 'text-accent');
            document.getElementById(`nav-${tab}`).classList.remove('text-gray-400');
            
            const container = el('app-container');
            container.innerHTML = '';
            
            if (tab === 'shop') renderShop(container);
            if (tab === 'fridge') renderFridge(container);
            if (tab === 'history') renderHistory(container);
        }

        // --- 1. SMART SHOPPING MODULE (The Brain) ---
        function renderShop(container) {
            container.innerHTML = `
                <div class="max-w-5xl mx-auto grid grid-cols-12 gap-8 animate-fade">
                    <div class="col-span-12 lg:col-span-5 space-y-6">
                        <h2 class="text-xl font-semibold text-gray-800">C√¥ng c·ª• t√≠nh gi√°</h2>
                        
                        <div class="bg-white p-6 rounded-xl border border-gray-200 shadow-sm space-y-4">
                            <div>
                                <label class="block text-xs font-bold text-gray-400 uppercase tracking-wider mb-1">T√™n s·∫£n ph·∫©m</label>
                                <div class="relative">
                                    <input type="text" id="inp-name" oninput="handleNameSearch(this.value)" placeholder="V√≠ d·ª•: S·ªØa t∆∞∆°i Vinamilk" class="w-full text-base border-b border-gray-300 py-2 focus:border-accent bg-transparent placeholder-gray-300">
                                    <div id="db-hint" class="absolute right-0 top-2 text-xs text-accent font-medium hidden">‚ú® ƒê√£ t√¨m th·∫•y d·ªØ li·ªáu c≈©</div>
                                </div>
                            </div>

                            <div class="grid grid-cols-2 gap-4">
                                <div>
                                    <label class="block text-xs font-bold text-gray-400 uppercase tracking-wider mb-1">S·ªë l∆∞·ª£ng</label>
                                    <input type="number" id="inp-qty" value="1" oninput="calculatePreview()" class="w-full border-b border-gray-300 py-2 focus:border-accent">
                                </div>
                                <div>
                                    <label class="block text-xs font-bold text-gray-400 uppercase tracking-wider mb-1">ƒê∆°n v·ªã</label>
                                    <input type="text" id="inp-unit" value="c√°i" class="w-full border-b border-gray-300 py-2 focus:border-accent">
                                </div>
                            </div>

                            <div class="grid grid-cols-2 gap-4">
                                <div>
                                    <label class="block text-xs font-bold text-gray-400 uppercase tracking-wider mb-1">Kh·ªëi l∆∞·ª£ng/Dung t√≠ch</label>
                                    <input type="text" id="inp-weight" placeholder="VD: 500g" class="w-full border-b border-gray-300 py-2 focus:border-accent">
                                </div>
                                <div>
                                    <label class="block text-xs font-bold text-gray-400 uppercase tracking-wider mb-1">H·∫°n s·ª≠ d·ª•ng</label>
                                    <input type="date" id="inp-expiry" class="w-full border-b border-gray-300 py-2 focus:border-accent">
                                </div>
                            </div>

                            <hr class="border-gray-100 my-2">

                            <div>
                                <label class="block text-xs font-bold text-gray-400 uppercase tracking-wider mb-1">Gi√° G·ªëc (Ch∆∞a thu·∫ø/gi·∫£m)</label>
                                <input type="number" id="inp-price" placeholder="0" oninput="calculatePreview()" class="w-full text-lg font-medium border-b border-gray-300 py-2 focus:border-accent">
                            </div>

                            <div class="grid grid-cols-2 gap-4">
                                <div>
                                    <label class="block text-xs font-bold text-gray-400 uppercase tracking-wider mb-1">Thu·∫ø (%)</label>
                                    <input type="number" id="inp-tax" value="0" oninput="calculatePreview()" class="w-full border-b border-gray-300 py-2 focus:border-accent text-red-500">
                                </div>
                                <div>
                                    <label class="block text-xs font-bold text-gray-400 uppercase tracking-wider mb-1">Gi·∫£m gi√° (%)</label>
                                    <input type="number" id="inp-discount" value="0" oninput="calculatePreview()" class="w-full border-b border-gray-300 py-2 focus:border-accent text-green-600">
                                </div>
                            </div>

                            <div class="bg-gray-50 rounded-lg p-4 mt-4 border border-gray-100">
                                <div class="flex justify-between text-xs text-gray-500 mb-1">
                                    <span>ƒê∆°n gi√° th·ª±c t·∫ø:</span>
                                    <span id="preview-unit-price" class="font-medium text-gray-700">0 ‚Ç´</span>
                                </div>
                                <div class="flex justify-between items-end">
                                    <span class="text-sm font-bold text-gray-600">T·ªîNG TI·ªÄN:</span>
                                    <span id="preview-total" class="text-2xl font-bold text-accent">0 ‚Ç´</span>
                                </div>
                                <div id="decision-text" class="text-xs text-right mt-1 font-medium text-gray-400 h-4"></div>
                            </div>

                            <button onclick="addToCart()" class="w-full bg-gray-900 text-white py-3 rounded-lg font-medium hover:bg-gray-800 transition-colors shadow-lg shadow-gray-200">
                                Th√™m v√†o danh s√°ch
                            </button>
                        </div>
                    </div>

                    <div class="col-span-12 lg:col-span-7 flex flex-col h-full">
                        <div class="flex justify-between items-end mb-6">
                            <h2 class="text-xl font-semibold text-gray-800">Danh s√°ch c·∫ßn mua</h2>
                            <div class="text-right">
                                <div class="text-xs text-gray-400 uppercase">T·ªïng d·ª± to√°n</div>
                                <div class="text-2xl font-bold text-gray-800" id="cart-total">0 ‚Ç´</div>
                            </div>
                        </div>

                        <div class="bg-white rounded-xl border border-gray-200 shadow-sm flex-1 overflow-hidden flex flex-col">
                            <div class="overflow-y-auto flex-1 p-0">
                                <table class="w-full text-left border-collapse">
                                    <thead class="bg-gray-50 text-xs text-gray-500 uppercase font-medium sticky top-0">
                                        <tr>
                                            <th class="p-4 border-b">S·∫£n ph·∫©m</th>
                                            <th class="p-4 border-b text-right">SL</th>
                                            <th class="p-4 border-b text-right">Gi√° g·ªëc</th>
                                            <th class="p-4 border-b text-center">%</th>
                                            <th class="p-4 border-b text-right">Th√†nh ti·ªÅn</th>
                                            <th class="p-4 border-b w-10"></th>
                                        </tr>
                                    </thead>
                                    <tbody id="cart-list" class="divide-y divide-gray-100 text-sm">
                                        </tbody>
                                </table>
                                <div id="empty-cart-msg" class="text-center py-10 text-gray-400 italic">Ch∆∞a c√≥ s·∫£n ph·∫©m n√†o</div>
                            </div>
                            
                            <div class="p-4 border-t border-gray-100 bg-gray-50">
                                <button onclick="checkout()" id="btn-checkout" class="w-full bg-accent text-white py-3 rounded-lg font-bold shadow-md hover:bg-teal-800 transition-colors disabled:opacity-50 disabled:cursor-not-allowed" disabled>
                                    Thanh to√°n & L∆∞u kho
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            renderCartItems();
        }

        // --- SHOPPING LOGIC ---

        // 1. Logic t√≠nh to√°n th·ªùi gian th·ª±c
        function calculatePreview() {
            const price = parseFloat(el('inp-price').value) || 0;
            const qty = parseFloat(el('inp-qty').value) || 1;
            const tax = parseFloat(el('inp-tax').value) || 0;
            const discount = parseFloat(el('inp-discount').value) || 0;

            // C√¥ng th·ª©c: Gi√° * (1 - Gi·∫£m) * (1 + Thu·∫ø)
            const unitPrice = price * (1 - discount/100) * (1 + tax/100);
            const total = unitPrice * qty;

            el('preview-unit-price').innerText = formatMoney(unitPrice);
            el('preview-total').innerText = formatMoney(total);

            // G·ª£i √Ω th√¥ng minh (So s√°nh v·ªõi gi√° c≈© n·∫øu c√≥)
            const name = el('inp-name').value.trim();
            if (APP_STATE.masterDB[name]) {
                const oldPrice = APP_STATE.masterDB[name].lastFinalPrice;
                const diff = unitPrice - oldPrice;
                const textEl = el('decision-text');
                
                if (diff < 0) {
                    textEl.innerHTML = `<span class="text-green-600">R·∫ª h∆°n l·∫ßn tr∆∞·ªõc ${formatMoney(Math.abs(diff))}</span> üî•`;
                } else if (diff > 0) {
                    textEl.innerHTML = `<span class="text-red-500">ƒê·∫Øt h∆°n l·∫ßn tr∆∞·ªõc ${formatMoney(diff)}</span> ‚ö†Ô∏è`;
                } else {
                    textEl.innerHTML = `<span class="text-gray-400">B·∫±ng gi√° l·∫ßn tr∆∞·ªõc</span>`;
                }
            }
        }

        // 2. Logic "Product Memory" (T·ª± ƒë·ªông ƒëi·ªÅn)
        function handleNameSearch(val) {
            const product = APP_STATE.masterDB[val.trim()];
            if (product) {
                el('db-hint').classList.remove('hidden');
                // Auto fill
                if (!el('inp-unit').value || el('inp-unit').value === 'c√°i') el('inp-unit').value = product.unit;
                el('inp-price').value = product.lastBasePrice;
                el('inp-tax').value = product.lastTax;
                el('inp-discount').value = 0; // Reset discount th∆∞·ªùng xuy√™n thay ƒë·ªïi
                calculatePreview();
            } else {
                el('db-hint').classList.add('hidden');
            }
        }

        function addToCart() {
            const name = el('inp-name').value;
            if (!name) return alert("Vui l√≤ng nh·∫≠p t√™n");

            const price = parseFloat(el('inp-price').value) || 0;
            const qty = parseFloat(el('inp-qty').value) || 1;
            const tax = parseFloat(el('inp-tax').value) || 0;
            const discount = parseFloat(el('inp-discount').value) || 0;
            const unitPrice = price * (1 - discount/100) * (1 + tax/100);

            const item = {
                id: Date.now(),
                name,
                qty,
                unit: el('inp-unit').value,
                weight: el('inp-weight').value,
                expiry: el('inp-expiry').value,
                basePrice: price,
                tax,
                discount,
                finalUnitPrice: unitPrice,
                total: unitPrice * qty
            };

            APP_STATE.cart.push(item);
            saveData();
            
            // Reset form nh∆∞ng gi·ªØ l·∫°i context n·∫øu c·∫ßn (·ªü ƒë√¢y reset h·∫øt)
            el('inp-name').value = '';
            el('inp-qty').value = 1;
            el('inp-price').value = '';
            el('inp-tax').value = 0;
            el('inp-discount').value = 0;
            el('preview-total').innerText = '0 ‚Ç´';
            el('db-hint').classList.add('hidden');
            el('inp-name').focus();

            renderCartItems();
        }

        function renderCartItems() {
            const list = el('cart-list');
            list.innerHTML = '';
            let grandTotal = 0;

            APP_STATE.cart.forEach((item, index) => {
                grandTotal += item.total;
                
                // Show Tax/Discount details concisely
                let details = [];
                if(item.tax > 0) details.push(`Thu·∫ø ${item.tax}%`);
                if(item.discount > 0) details.push(`Gi·∫£m ${item.discount}%`);
                const detailStr = details.length ? `<div class="text-[10px] text-gray-400">${details.join(', ')}</div>` : '';

                list.innerHTML += `
                    <tr class="group hover:bg-gray-50 transition-colors">
                        <td class="p-4">
                            <div class="font-medium text-gray-800">${item.name}</div>
                            <div class="text-xs text-gray-400">${item.weight || ''} ${item.expiry ? '‚Ä¢ HSD: ' + item.expiry : ''}</div>
                        </td>
                        <td class="p-4 text-right">
                            <span class="font-semibold">${item.qty}</span> <span class="text-xs text-gray-400">${item.unit}</span>
                        </td>
                        <td class="p-4 text-right text-gray-500">${formatMoney(item.basePrice)}</td>
                        <td class="p-4 text-center">
                            ${detailStr}
                        </td>
                        <td class="p-4 text-right font-bold text-gray-800">${formatMoney(item.total)}</td>
                        <td class="p-4 text-right">
                            <button onclick="removeCart(${index})" class="text-gray-300 hover:text-red-500 transition-colors"><i class="fa-solid fa-trash"></i></button>
                        </td>
                    </tr>
                `;
            });

            if (APP_STATE.cart.length > 0) {
                el('empty-cart-msg').style.display = 'none';
                el('btn-checkout').disabled = false;
            } else {
                el('empty-cart-msg').style.display = 'block';
                el('btn-checkout').disabled = true;
            }

            el('cart-total').innerText = formatMoney(grandTotal);
        }

        function removeCart(idx) {
            APP_STATE.cart.splice(idx, 1);
            saveData();
            renderCartItems();
        }

        // --- CHECKOUT & DATABASE UPDATE (The Memory Logic) ---
        function checkout() {
            if (!confirm('X√°c nh·∫≠n ho√†n t·∫•t mua s·∫Øm v√† l∆∞u v√†o kho?')) return;

            const purchaseDate = new Date().toISOString();

            APP_STATE.cart.forEach(item => {
                // 1. Move to Fridge (Inventory)
                APP_STATE.fridge.push({
                    ...item,
                    dateAdded: purchaseDate
                });

                // 2. Update Master DB (Tr√≠ tu·ªá s·∫£n ph·∫©m)
                // Ghi ƒë√® th√¥ng tin m·ªõi nh·∫•t ƒë·ªÉ l·∫ßn sau g·ª£i √Ω
                APP_STATE.masterDB[item.name.trim()] = {
                    unit: item.unit,
                    lastBasePrice: item.basePrice,
                    lastTax: item.tax,
                    lastFinalPrice: item.finalUnitPrice,
                    lastUpdated: purchaseDate
                };

                // 3. Save History Log (Optional, for simplified list)
                // APP_STATE.history.push(...) -> Implement later
            });

            // Clear Cart
            APP_STATE.cart = [];
            saveData();
            renderCartItems();
            alert("ƒê√£ l∆∞u kho v√† c·∫≠p nh·∫≠t c∆° s·ªü d·ªØ li·ªáu gi√°!");
            setTab('fridge');
        }

        // --- 2. FRIDGE MODULE (Minimal List) ---
        function renderFridge(container) {
            container.innerHTML = `
                <div class="max-w-5xl mx-auto space-y-6 animate-fade">
                    <h2 class="text-xl font-semibold text-gray-800">Kho h√†ng hi·ªán t·∫°i</h2>
                    <div class="bg-white rounded-xl border border-gray-200 shadow-sm overflow-hidden">
                        <table class="w-full text-left">
                            <thead class="bg-gray-50 text-xs text-gray-500 uppercase font-medium">
                                <tr>
                                    <th class="p-4 border-b">T√™n s·∫£n ph·∫©m</th>
                                    <th class="p-4 border-b">S·ªë l∆∞·ª£ng</th>
                                    <th class="p-4 border-b">Ng√†y mua</th>
                                    <th class="p-4 border-b">H·∫°n s·ª≠ d·ª•ng</th>
                                    <th class="p-4 border-b text-right">Gi√° tr·ªã</th>
                                </tr>
                            </thead>
                            <tbody class="divide-y divide-gray-100 text-sm">
                                ${APP_STATE.fridge.map(item => `
                                    <tr>
                                        <td class="p-4 font-medium">${item.name}</td>
                                        <td class="p-4">${item.qty} ${item.unit}</td>
                                        <td class="p-4 text-gray-500">${new Date(item.dateAdded).toLocaleDateString('vi-VN')}</td>
                                        <td class="p-4 text-gray-500">${item.expiry || '-'}</td>
                                        <td class="p-4 text-right font-medium">${formatMoney(item.total)}</td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                        ${APP_STATE.fridge.length === 0 ? '<div class="p-8 text-center text-gray-400">Kho tr·ªëng</div>' : ''}
                    </div>
                </div>
            `;
        }

        // --- 3. HISTORY MODULE (Price History) ---
        function renderHistory(container) {
             const keys = Object.keys(APP_STATE.masterDB);
             container.innerHTML = `
                <div class="max-w-5xl mx-auto space-y-6 animate-fade">
                    <h2 class="text-xl font-semibold text-gray-800">C∆° s·ªü d·ªØ li·ªáu gi√°</h2>
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                        ${keys.map(k => {
                            const data = APP_STATE.masterDB[k];
                            return `
                                <div class="bg-white p-4 rounded-xl border border-gray-200 shadow-sm">
                                    <div class="font-bold text-gray-800 mb-1">${k}</div>
                                    <div class="text-xs text-gray-400 mb-3">C·∫≠p nh·∫≠t: ${new Date(data.lastUpdated).toLocaleDateString('vi-VN')}</div>
                                    <div class="flex justify-between items-center text-sm">
                                        <span class="text-gray-500">Gi√° l·∫ßn cu·ªëi:</span>
                                        <span class="font-bold text-accent">${formatMoney(data.lastFinalPrice)} / ${data.unit}</span>
                                    </div>
                                    <div class="flex justify-between items-center text-xs mt-1 text-gray-400">
                                        <span>Gi√° g·ªëc: ${formatMoney(data.lastBasePrice)}</span>
                                        <span>Thu·∫ø: ${data.lastTax}%</span>
                                    </div>
                                </div>
                            `
                        }).join('')}
                    </div>
                    ${keys.length === 0 ? '<div class="text-center text-gray-400">Ch∆∞a c√≥ d·ªØ li·ªáu l·ªãch s·ª≠</div>' : ''}
                </div>
             `;
        }

        // Init
        loadData();
        setTab('shop'); // Default to Shopping Calculator
    </script>
</body>
</html>