<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Food Assistant AI - Pro Calc</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="https://cdn.jsdelivr.net/npm/dayjs@1/dayjs.min.js"></script>
    
    <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>

    <style>
        /* CSS cho Toggle Switch đẹp */
        .toggle-checkbox:checked {
            right: 0;
            border-color: #10b981;
        }
        .toggle-checkbox:checked + .toggle-label {
            background-color: #10b981;
        }
        /* Ẩn input number arrows */
        input::-webkit-outer-spin-button,
        input::-webkit-inner-spin-button { -webkit-appearance: none; margin: 0; }
    </style>
</head>
<body class="bg-gray-50 text-gray-800 h-screen flex flex-col overflow-hidden">

    <header class="bg-emerald-600 text-white p-4 shadow-md z-10 flex justify-between items-center">
        <div>
            <h1 class="text-xl font-bold"><i class="fa-solid fa-leaf mr-2"></i>Food Assistant</h1>
            <p class="text-xs text-emerald-100">Sparring Partner Mode</p>
        </div>
        <button class="text-emerald-100"><i class="fa-solid fa-user-circle text-2xl"></i></button>
    </header>

    <main class="flex-1 overflow-y-auto p-4 pb-24 relative">
        
        <div id="view-shopping" class="view-section">
            <div class="bg-white p-6 rounded-xl shadow-lg text-center">
                <h2 class="text-lg font-bold text-gray-600 mb-4">Demo Máy Tính Mới</h2>
                <button onclick="openSuperCalculator()" class="bg-gradient-to-r from-emerald-500 to-teal-600 text-white px-6 py-3 rounded-full shadow-lg font-bold active:scale-95 transition w-full">
                    <i class="fa-solid fa-calculator mr-2"></i> Thêm Món & Tính Tiền
                </button>
                <p class="mt-4 text-sm text-gray-500">Bấm nút trên để test tính năng:<br>Scanner, Format tiền, Switch, Bóc tách giá.</p>
            </div>
        </div>

    </main>

    <script>
        // --- LOGIC XỬ LÝ TIỀN TỆ (FORMAT 1.000) ---
        function formatMoneyInput(input) {
            // 1. Lấy vị trí con trỏ hiện tại
            let cursorPosition = input.selectionStart;
            
            // 2. Xóa hết ký tự không phải số
            let rawValue = input.value.replace(/\D/g, "");
            
            // 3. Format lại có dấu chấm
            let formattedValue = new Intl.NumberFormat('vi-VN').format(rawValue);
            
            // 4. Cập nhật lại giá trị (nếu rỗng thì để rỗng)
            input.value = rawValue ? formattedValue : "";

            // 5. Trigger tính toán lại
            calculateDetailedTotal();
        }

        // --- HÀM MỞ MÁY TÍNH (MODAL) ---
        async function openSuperCalculator() {
            const { value: formValues } = await Swal.fire({
                title: 'Máy Tính Thông Minh',
                width: 600,
                // HTML FORM CHI TIẾT
                html: `
                    <div class="text-left space-y-4 font-sans px-1">
                        
                        <div>
                            <div id="reader" width="100%" class="hidden mb-2 rounded overflow-hidden"></div>
                            <div class="flex gap-2">
                                <button onclick="toggleScanner()" class="bg-gray-800 text-white px-3 rounded shadow hover:bg-gray-700">
                                    <i class="fa-solid fa-qrcode"></i>
                                </button>
                                <input id="calc-name" class="flex-1 border border-gray-300 rounded p-2 focus:ring-2 ring-emerald-500 outline-none" placeholder="Tên món hàng...">
                            </div>
                        </div>

                        <div class="bg-gray-50 p-3 rounded border border-gray-200">
                            <div class="flex justify-between mb-1">
                                <label class="text-xs font-bold text-gray-500 uppercase">Đơn giá</label>
                                <div class="flex items-center">
                                    <span class="text-xs mr-2 font-medium text-gray-500" id="tax-label">Giá chưa thuế</span>
                                    
                                    <div class="relative inline-block w-10 mr-2 align-middle select-none transition duration-200 ease-in">
                                        <input type="checkbox" name="toggle" id="calc-is-tax-included" class="toggle-checkbox absolute block w-5 h-5 rounded-full bg-white border-4 appearance-none cursor-pointer border-gray-300"/>
                                        <label for="calc-is-tax-included" class="toggle-label block overflow-hidden h-5 rounded-full bg-gray-300 cursor-pointer"></label>
                                    </div>
                                </div>
                            </div>
                            <div class="relative">
                                <span class="absolute left-3 top-2 text-gray-400">¥</span>
                                <input id="calc-price" type="text" oninput="formatMoneyInput(this)" class="w-full pl-8 p-2 border rounded font-mono text-lg font-bold text-right outline-none focus:border-emerald-500" placeholder="0">
                            </div>
                        </div>

                        <div class="grid grid-cols-2 gap-3">
                            <div>
                                <label class="text-xs font-bold text-gray-500 uppercase">Số lượng</label>
                                <div class="flex items-center mt-1">
                                    <button onclick="adjQty(-1)" class="bg-gray-200 w-8 h-8 rounded-l hover:bg-gray-300">-</button>
                                    <input id="calc-qty" type="number" value="1" class="w-full h-8 text-center border-y border-gray-200 font-bold" oninput="calculateDetailedTotal()">
                                    <button onclick="adjQty(1)" class="bg-gray-200 w-8 h-8 rounded-r hover:bg-gray-300">+</button>
                                </div>
                            </div>
                            <div>
                                <label class="text-xs font-bold text-gray-500 uppercase">Thuế suất (%)</label>
                                <div class="flex mt-1 relative">
                                    <input id="calc-tax-rate" type="number" value="8" class="w-full p-1 border rounded text-center font-bold pr-6" oninput="calculateDetailedTotal()">
                                    <span class="absolute right-3 top-1 text-gray-400">%</span>
                                </div>
                                <div class="flex justify-center gap-2 mt-1">
                                    <span onclick="setRate(8)" class="text-xs bg-emerald-100 text-emerald-700 px-2 rounded cursor-pointer border border-emerald-200">8%</span>
                                    <span onclick="setRate(10)" class="text-xs bg-gray-100 text-gray-600 px-2 rounded cursor-pointer border border-gray-200">10%</span>
                                </div>
                            </div>
                        </div>

                        <div class="border-t pt-3">
                            <div class="flex justify-between items-center mb-1">
                                <label class="text-xs font-bold text-orange-500 uppercase">Giảm giá</label>
                                <div class="flex items-center">
                                    <span class="text-xs mr-2 text-gray-500" id="discount-label">Theo Tiền (¥)</span>
                                    <div class="relative inline-block w-10 align-middle select-none">
                                        <input type="checkbox" id="calc-discount-mode" class="toggle-checkbox absolute block w-5 h-5 rounded-full bg-white border-4 appearance-none cursor-pointer border-gray-300"/>
                                        <label for="calc-discount-mode" class="toggle-label block overflow-hidden h-5 rounded-full bg-gray-300 cursor-pointer"></label>
                                    </div>
                                </div>
                            </div>
                            <input id="calc-discount-val" type="number" oninput="calculateDetailedTotal()" class="w-full p-2 border border-orange-200 bg-orange-50 rounded text-right font-bold text-orange-700 placeholder-orange-300" placeholder="0">
                        </div>

                        <div class="bg-slate-800 text-slate-200 p-3 rounded-lg text-sm space-y-1 mt-2">
                            <div class="flex justify-between">
                                <span>Tiền hàng (Gốc):</span>
                                <span id="out-base" class="font-mono">0</span>
                            </div>
                            <div class="flex justify-between text-emerald-400">
                                <span>+ Tiền Thuế:</span>
                                <span id="out-tax" class="font-mono">0</span>
                            </div>
                            <div class="flex justify-between text-orange-400">
                                <span>- Giảm giá:</span>
                                <span id="out-discount" class="font-mono">0</span>
                            </div>
                            <div class="border-t border-slate-600 my-1"></div>
                            <div class="flex justify-between items-end">
                                <span class="font-bold text-white">TỔNG THANH TOÁN:</span>
                                <span id="out-total" class="text-xl font-bold text-white font-mono">¥0</span>
                            </div>
                        </div>
                    </div>
                `,
                didOpen: () => {
                    // Gán sự kiện cho các switch
                    document.getElementById('calc-is-tax-included').addEventListener('change', (e) => {
                        document.getElementById('tax-label').innerText = e.target.checked ? "Giá ĐÃ gồm thuế" : "Giá CHƯA thuế";
                        calculateDetailedTotal();
                    });
                    
                    document.getElementById('calc-discount-mode').addEventListener('change', (e) => {
                        const isPercent = e.target.checked;
                        document.getElementById('discount-label').innerText = isPercent ? "Theo %" : "Theo Tiền (¥)";
                        document.getElementById('calc-discount-val').placeholder = isPercent ? "Nhập % giảm..." : "Nhập số tiền giảm...";
                        calculateDetailedTotal();
                    });
                },
                showCancelButton: true,
                confirmButtonText: 'Thêm vào giỏ',
                confirmButtonColor: '#059669',
                cancelButtonText: 'Đóng',
                focusConfirm: false,
                preConfirm: () => {
                    return {
                        name: document.getElementById('calc-name').value,
                        total: document.getElementById('out-total').innerText
                    }
                }
            }).then((result) => {
                if (result.isConfirmed) {
                    Swal.fire({
                        icon: 'success',
                        title: 'Đã lưu',
                        text: `Món: ${result.value.name} - Tổng: ${result.value.total}`,
                        timer: 1500,
                        showConfirmButton: false
                    });
                    // Stop scanner if running
                    if(html5QrCode && html5QrCode.isScanning) {
                        html5QrCode.stop();
                    }
                }
            });
        }

        // --- CORE LOGIC TÍNH TOÁN (SPARRING PARTNER APPROVED) ---
        function calculateDetailedTotal() {
            // 1. Lấy dữ liệu Input (và làm sạch format 1.000)
            const rawPrice = document.getElementById('calc-price').value.replace(/\./g, "") || 0;
            const price = parseFloat(rawPrice);
            
            const qty = parseFloat(document.getElementById('calc-qty').value) || 1;
            const taxRatePercent = parseFloat(document.getElementById('calc-tax-rate').value) || 0;
            const taxRate = taxRatePercent / 100;
            
            const isTaxIncluded = document.getElementById('calc-is-tax-included').checked; // True = Đã thuế
            
            const discountVal = parseFloat(document.getElementById('calc-discount-val').value) || 0;
            const isDiscountPercent = document.getElementById('calc-discount-mode').checked; // True = %

            // 2. Logic tính toán ngược xuôi
            let basePriceTotal = 0; // Tổng tiền hàng chưa thuế
            let taxAmountTotal = 0; // Tổng tiền thuế
            
            if (isTaxIncluded) {
                // Nếu giá nhập vào ĐÃ thuế (Ví dụ 108 yên, thuế 8%)
                // Gốc = 108 / 1.08 = 100
                const baseUnit = price / (1 + taxRate);
                basePriceTotal = baseUnit * qty;
                taxAmountTotal = (price * qty) - basePriceTotal;
            } else {
                // Nếu giá nhập vào CHƯA thuế (Ví dụ 100 yên, thuế 8%)
                basePriceTotal = price * qty;
                taxAmountTotal = basePriceTotal * taxRate;
            }

            // 3. Tính giảm giá
            let discountAmountTotal = 0;
            // Tính tổng tiền tạm tính (Gốc + Thuế) để áp giảm giá
            const subTotal = basePriceTotal + taxAmountTotal; 
            
            if (isDiscountPercent) {
                discountAmountTotal = subTotal * (discountVal / 100);
            } else {
                discountAmountTotal = discountVal; // Giảm tiền mặt
            }

            // 4. Tổng cuối cùng
            const finalTotal = subTotal - discountAmountTotal;

            // 5. Hiển thị ra UI (Format lại dấu chấm)
            const fmt = (num) => Math.round(num).toLocaleString('vi-VN'); // Làm tròn yên Nhật

            document.getElementById('out-base').innerText = fmt(basePriceTotal);
            document.getElementById('out-tax').innerText = fmt(taxAmountTotal);
            document.getElementById('out-discount').innerText = fmt(discountAmountTotal);
            document.getElementById('out-total').innerText = "¥" + fmt(finalTotal);
        }

        // --- SCANNER LOGIC ---
        let html5QrCode;
        function toggleScanner() {
            const readerDiv = document.getElementById('reader');
            
            if (readerDiv.classList.contains('hidden')) {
                // Mở Scanner
                readerDiv.classList.remove('hidden');
                html5QrCode = new Html5Qrcode("reader");
                
                html5QrCode.start(
                    { facingMode: "environment" }, // Camera sau
                    { fps: 10, qrbox: { width: 250, height: 250 } },
                    (decodedText, decodedResult) => {
                        // KHI QUÉT THÀNH CÔNG
                        console.log(`Scan result: ${decodedText}`);
                        document.getElementById('calc-name').value = `Sản phẩm ${decodedText}`; // Giả lập tìm thấy tên
                        
                        // Rung nhẹ để báo hiệu (nếu đt hỗ trợ)
                        if (navigator.vibrate) navigator.vibrate(200);
                        
                        // Tắt cam sau khi quét
                        stopScanner();
                    },
                    (errorMessage) => {
                        // Bỏ qua lỗi đang quét
                    }
                ).catch(err => {
                    console.error(err);
                    Swal.showValidationMessage('Không mở được Camera');
                });
            } else {
                stopScanner();
            }
        }

        function stopScanner() {
            if (html5QrCode) {
                html5QrCode.stop().then(() => {
                    document.getElementById('reader').classList.add('hidden');
                    html5QrCode.clear();
                });
            }
        }

        // --- HELPER UI ---
        function setRate(rate) {
            document.getElementById('calc-tax-rate').value = rate;
            calculateDetailedTotal();
        }
        function adjQty(delta) {
            const el = document.getElementById('calc-qty');
            let val = parseInt(el.value) || 0;
            val += delta;
            if (val < 1) val = 1;
            el.value = val;
            calculateDetailedTotal();
        }
    </script>
</body>
</html>