<!DOCTYPE html>
<html lang="vi">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Hunq JTracking | JP POST Tracking</title>
    <meta name="description" content="Tra c·ª©u h√†ng lo·∫°t ƒë∆°n h√†ng c·ªßa JP Post h·ªó tr·ª£ ti·∫øng vi·ªát.">
    <meta name="author" content="Hunq">
    <meta name="theme-color" content="#ffffff">
    <meta name="robots" content="index, follow">
    <link rel="canonical" href="mhung.siite">
    <link rel="icon" href="/Asset/logo/logo.png">


    <meta property="og:url" content="mhung.siite">
    <meta property="og:type" content="website">
    <meta property="og:title" content="Hunq JTracking | JP POST Tracking">
    <meta property="og:description" content="Tra c·ª©u h√†ng lo·∫°t ƒë∆°n h√†ng c·ªßa JP Post h·ªó tr·ª£ ti·∫øng vi·ªát.">
    <meta property="og:image" content="/Asset/Banner/Banner.png">


    <meta name="twitter:card" content="summary_large_image">
    <meta property="twitter:domain" content="mhung.siite">
    <meta property="twitter:url" content="mhung.siite">
    <meta name="twitter:title" content="Hunq JTracking | JP POST Tracking">
    <meta name="twitter:description" content="Tra c·ª©u h√†ng lo·∫°t ƒë∆°n h√†ng c·ªßa JP Post h·ªó tr·ª£ ti·∫øng vi·ªát.">
    <meta name="twitter:image" content="/Asset/Banner/Banner.png">


    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Hunq JTracking | JP POST Tracking">
    <link rel="apple-touch-icon" href="/Asset/logo/logo.png">

    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Inter', 'ui-sans-serif', 'system-ui', '-apple-system', 'Segoe UI', 'Roboto', 'sans-serif'],
                        mono: ['ui-monospace', 'SFMono-Regular', 'Menlo', 'Monaco', 'Consolas', 'monospace'],
                    },
                    colors: {
                        jp: {
                            red: '#E50012',
                            dark: '#cc0010'
                        }
                    }
                }
            }
        }
    </script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');

        ::-webkit-scrollbar {
            width: 6px;
        }

        ::-webkit-scrollbar-track {
            background: transparent;
        }

        ::-webkit-scrollbar-thumb {
            background: #d1d5db;
            border-radius: 6px;
        }

        .dark ::-webkit-scrollbar-thumb {
            background: #4b5563;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: #9ca3af;
        }

        .fade-in {
            animation: fadeIn 0.4s ease-in-out forwards;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* Copy Feedback */
        .copy-feedback {
            position: absolute;
            padding: 4px 8px;
            border-radius: 6px;
            font-size: 11px;
            font-weight: 500;
            top: -28px;
            left: 50%;
            transform: translateX(-50%);
            pointer-events: none;
            opacity: 0;
            transition: opacity 0.2s;
            white-space: nowrap;
            z-index: 10;
        }

        .copy-feedback.show {
            opacity: 1;
        }

        .copy-feedback::after {
            content: '';
            position: absolute;
            bottom: -3px;
            left: 50%;
            transform: translateX(-50%) rotate(45deg);
            width: 6px;
            height: 6px;
        }

        html:not(.dark) .copy-feedback {
            background: #111827;
            color: white;
        }

        html:not(.dark) .copy-feedback::after {
            background: #111827;
        }

        html.dark .copy-feedback {
            background: #f9fafb;
            color: #111827;
        }

        html.dark .copy-feedback::after {
            background: #f9fafb;
        }

        /* Lo·∫°i b·ªè border m·∫∑c ƒë·ªãnh c·ªßa textarea khi focus trong Tailwind */
        textarea:focus {
            outline: none !important;
            box-shadow: none !important;
        }
    </style>
</head>

<body
    class="font-sans min-h-screen p-4 md:p-8 selection:bg-gray-200 dark:selection:bg-gray-700 bg-gray-50 text-gray-900 dark:bg-gray-950 dark:text-gray-100 transition-colors duration-200">

    <div class="max-w-3xl mx-auto">
        <div
            class="bg-white dark:bg-gray-900 border border-gray-200 dark:border-gray-800 rounded-2xl mb-6 fade-in shadow-sm">

            <div
                class="flex flex-row p-5 md:p-7 border-b border-gray-100 dark:border-gray-800 md:items-center justify-between gap-4 bg-gray-50/50 dark:bg-gray-800/20 rounded-t-2xl">
                <div class="flex items-center gap-4">
                    <div
                        class="w-12 h-12 bg-jp-red text-white flex items-center justify-center text-xl rounded-xl shadow-sm shrink-0">
                        <i class="fa-solid fa-box-open"></i>
                    </div>
                    <div>
                        <h1 class="text-xl font-bold tracking-tight text-gray-900 dark:text-white">Hunq Tracking</h1>
                        <p class="text-[11px] md:text-xs text-gray-500 dark:text-gray-400 uppercase tracking-wide mt-1">
                            Tra c·ª©u JP Post</p>
                    </div>
                </div>

                <div
                    class="flex p-1 bg-white dark:bg-gray-800 border border-gray-200 dark:border-gray-700 rounded-xl gap-1 shrink-0 w-fit self-end md:self-auto">
                    <button data-theme="light"
                        class="theme-toggle w-9 h-9 md:w-8 md:h-8 rounded-lg flex items-center justify-center transition-colors text-gray-500 hover:bg-gray-100 dark:hover:bg-gray-700"
                        title="S√°ng"><i class="fa-solid fa-sun text-sm"></i></button>
                    <button data-theme="system"
                        class="theme-toggle w-9 h-9 md:w-8 md:h-8 rounded-lg flex items-center justify-center transition-colors text-gray-500 hover:bg-gray-100 dark:hover:bg-gray-700"
                        title="Theo thi·∫øt b·ªã"><i class="fa-solid fa-desktop text-sm"></i></button>
                    <button data-theme="dark"
                        class="theme-toggle w-9 h-9 md:w-8 md:h-8 rounded-lg flex items-center justify-center transition-colors text-gray-500 hover:bg-gray-100 dark:hover:bg-gray-700"
                        title="T·ªëi"><i class="fa-solid fa-moon text-sm"></i></button>
                </div>
            </div>

            <div class="p-4 md:p-8">
                <form id="trackForm">
                    <div
                        class="bg-gray-50 dark:bg-gray-800 border border-gray-300 dark:border-gray-700 rounded-2xl overflow-hidden focus-within:border-jp-red dark:focus-within:border-jp-red focus-within:ring-1 focus-within:ring-jp-red transition-all shadow-sm">

                        <div class="relative">
                            <textarea id="trackingCode" rows="3"
                                placeholder="Nh·∫≠p c√°c m√£ v·∫≠n ƒë∆°n c·∫ßn tra...&#10;M·ªói m√£ tr√™n 1 d√≤ng ho·∫∑c c√°ch nhau b·ªüi d·∫•u ph·∫©y."
                                class="w-full pl-5 pr-14 py-4 bg-transparent border-none text-base font-mono placeholder-gray-400 dark:placeholder-gray-500 text-gray-900 dark:text-white resize-y leading-relaxed block"></textarea>

                            <button type="button" id="pasteBtn"
                                class="absolute top-3 right-3 w-8 h-8 flex items-center justify-center text-gray-400 hover:text-gray-900 dark:hover:text-white bg-white dark:bg-gray-700 border border-gray-200 dark:border-gray-600 rounded-lg shadow-sm transition-colors tooltip"
                                title="D√°n m√£">
                                <i class="fa-solid fa-paste"></i>
                            </button>
                        </div>

                        <div
                            class="bg-white dark:bg-gray-900 border-t border-gray-200 dark:border-gray-700 px-4 py-3 flex flex-col sm:flex-row justify-between items-center gap-4">

                            <div class="flex items-center gap-2.5 w-full sm:w-auto">
                                <span
                                    class="text-[11px] font-bold text-gray-400 uppercase tracking-widest shrink-0 cursor-help"
                                    title="H√£y ƒë·ªïi sang S1, S2, S3 n·∫øu h·ªá th·ªëng b√°o l·ªói">
                                    <i class="fa-solid fa-server mr-1"></i> M√ÅY CH·ª¶
                                </span>
                                <div class="flex bg-gray-100 dark:bg-gray-800 p-1 rounded-lg w-full sm:w-auto">
                                    <label class="cursor-pointer flex-1 text-center">
                                        <input type="radio" name="serverMode" value="auto" class="peer sr-only" checked>
                                        <div
                                            class="px-3 py-1.5 rounded-md text-xs font-semibold text-gray-500 dark:text-gray-400 peer-checked:bg-white dark:peer-checked:bg-gray-700 peer-checked:text-gray-900 dark:peer-checked:text-white peer-checked:shadow-sm transition-all">
                                            Auto</div>
                                    </label>
                                    <label class="cursor-pointer flex-1 text-center">
                                        <input type="radio" name="serverMode" value="0" class="peer sr-only">
                                        <div
                                            class="px-3 py-1.5 rounded-md text-xs font-semibold text-gray-500 dark:text-gray-400 peer-checked:bg-white dark:peer-checked:bg-gray-700 peer-checked:text-gray-900 dark:peer-checked:text-white peer-checked:shadow-sm transition-all">
                                            S1</div>
                                    </label>
                                    <label class="cursor-pointer flex-1 text-center">
                                        <input type="radio" name="serverMode" value="1" class="peer sr-only">
                                        <div
                                            class="px-3 py-1.5 rounded-md text-xs font-semibold text-gray-500 dark:text-gray-400 peer-checked:bg-white dark:peer-checked:bg-gray-700 peer-checked:text-gray-900 dark:peer-checked:text-white peer-checked:shadow-sm transition-all">
                                            S2</div>
                                    </label>
                                    <label class="cursor-pointer flex-1 text-center">
                                        <input type="radio" name="serverMode" value="2" class="peer sr-only">
                                        <div
                                            class="px-3 py-1.5 rounded-md text-xs font-semibold text-gray-500 dark:text-gray-400 peer-checked:bg-white dark:peer-checked:bg-gray-700 peer-checked:text-gray-900 dark:peer-checked:text-white peer-checked:shadow-sm transition-all">
                                            S3</div>
                                    </label>
                                </div>
                            </div>

                            <button type="submit" id="submitBtn"
                                class="w-full sm:w-auto px-6 py-2.5 bg-jp-red hover:bg-jp-dark text-white font-semibold flex items-center justify-center space-x-2 transition-colors rounded-xl shadow-sm">
                                <span id="btnText">Tra c·ª©u ngay</span>
                            </button>
                        </div>
                    </div>
                </form>

                <div id="loadingInfo"
                    class="hidden mt-5 text-sm text-gray-600 dark:text-gray-300 bg-gray-50 dark:bg-gray-800 p-4 rounded-xl border border-gray-200 dark:border-gray-700 flex items-center shadow-inner">
                    <i class="fa-solid fa-circle-notch fa-spin mr-3 text-jp-red"></i>
                    <span id="activeProxyText" class="font-medium">ƒêang kh·ªüi t·∫°o k·∫øt n·ªëi...</span>
                </div>
            </div>

            <div id="historySection"
                class="hidden border-t border-gray-100 dark:border-gray-800 p-6 md:p-8 bg-gray-50/50 dark:bg-gray-800/20 rounded-b-2xl">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-xs font-bold text-gray-500 dark:text-gray-400 uppercase tracking-widest">L·ªãch s·ª≠ tra
                        c·ª©u</h3>
                    <button onclick="clearHistory()"
                        class="text-xs font-medium text-gray-400 hover:text-red-600 dark:hover:text-red-400 transition-colors bg-white dark:bg-gray-800 px-3 py-1.5 rounded-lg border border-gray-200 dark:border-gray-700 shadow-sm">X√≥a
                        t·∫•t c·∫£</button>
                </div>
                <div id="historyList" class="flex flex-col gap-3"></div>
            </div>
        </div>

        <div id="resultsContainer" class="hidden space-y-6"></div>
    </div>

    <script>
        // --- C·∫§U H√åNH DARK MODE THEME ---
        const themeToggleBtns = document.querySelectorAll('.theme-toggle');
        const html = document.documentElement;

        function setTheme(theme) {
            localStorage.setItem('theme', theme);
            updateThemeUI(theme);
            if (theme === 'dark' || (theme === 'system' && window.matchMedia('(prefers-color-scheme: dark)').matches)) {
                html.classList.add('dark');
            } else {
                html.classList.remove('dark');
            }
        }

        function updateThemeUI(theme) {
            themeToggleBtns.forEach(btn => {
                if (btn.dataset.theme === theme) {
                    btn.classList.add('bg-white', 'dark:bg-gray-600', 'text-gray-900', 'dark:text-white', 'shadow-sm', 'border', 'border-gray-200', 'dark:border-gray-500');
                    btn.classList.remove('text-gray-500', 'hover:bg-gray-100', 'dark:hover:bg-gray-700', 'border-transparent');
                } else {
                    btn.classList.remove('bg-white', 'dark:bg-gray-600', 'text-gray-900', 'dark:text-white', 'shadow-sm', 'border-gray-200', 'dark:border-gray-500');
                    btn.classList.add('text-gray-500', 'hover:bg-gray-100', 'dark:hover:bg-gray-700', 'border', 'border-transparent');
                }
            });
        }

        themeToggleBtns.forEach(btn => btn.addEventListener('click', () => setTheme(btn.dataset.theme)));
        setTheme(localStorage.getItem('theme') || 'system');
        window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', (e) => {
            if (localStorage.getItem('theme') === 'system') {
                if (e.matches) html.classList.add('dark');
                else html.classList.remove('dark');
            }
        });


        // --- LOGIC D·ªäCH THU·∫¨T ---
        window.currentGlobalData = [];
        const translationCache = JSON.parse(localStorage.getItem('jpLocationCache') || '{}');

        const translateDict = {
            "ÂºïÂèó": "ƒê√£ nh·∫≠n h√†ng", "Âà∞ÁùÄ": "ƒê√£ ƒë·∫øn b∆∞u c·ª•c", "‰∏≠Á∂ô": "ƒêang trung chuy·ªÉn", "ÊåÅ„Å°Âá∫„Åó‰∏≠": "ƒêang ƒëi giao",
            "„ÅäÂ±ä„ÅëÂÖà„Å´„ÅäÂ±ä„ÅëÊ∏à„Åø": "Giao h√†ng th√†nh c√¥ng", "„Åî‰∏çÂú®„ÅÆ„Åü„ÇÅÊåÅ„Å°Êàª„Çä": "V·∫Øng nh√†, mang v·ªÅ b∆∞u c·ª•c", "‰øùÁÆ°": "ƒêang l∆∞u kho",
            "Â∑ÆÂá∫‰∫∫„Å´ËøîÈÄÅ": "Ho√†n tr·∫£ ng∆∞·ªùi g·ª≠i", "Ëª¢ÈÄÅ": "ƒê√£ chuy·ªÉn ti·∫øp", "ÂõΩÈöõ‰∫§ÊèõÂ±Ä„Å´Âà∞ÁùÄ": "ƒê·∫øn b∆∞u c·ª•c qu·ªëc t·∫ø",
            "ÂõΩÈöõ‰∫§ÊèõÂ±Ä„Åã„ÇâÁô∫ÈÄÅ": "R·ªùi b∆∞u c·ª•c qu·ªëc t·∫ø", "ÈÄöÈñ¢ÊâãÁ∂ö‰∏≠": "Th·ªß t·ª•c h·∫£i quan", "Á™ìÂè£„Åß„ÅäÊ∏°„Åó": "Giao t·∫°i qu·∫ßy",
            "Ë™øÊüª‰∏≠": "ƒêang ƒëi·ªÅu tra", "Áô∫ÈÄÅ": "ƒê√£ g·ª≠i ƒëi", "„ÅÇ„Å¶ÊâÄ‰∏çÊòé„ÅÆ„Åü„ÇÅËøîÈÄÅ": "Sai ƒë·ªãa ch·ªâ",
            "„ÇÜ„ÅÜ„Éë„ÉÉ„ÇØ": "Yu-Pack", "„É¨„Çø„Éº„Éë„ÉÉ„ÇØ„Éó„É©„Çπ": "Letter Pack Plus", "„É¨„Çø„Éº„Éë„ÉÉ„ÇØ„É©„Ç§„Éà": "Letter Pack Light",
            "„ÇÜ„ÅÜ„Éë„Ç±„ÉÉ„Éà": "Yu-Packet", "EMS": "EMS"
        };

        const t = (text) => {
            if (!text) return ""; const trimmed = text.trim(); if (translateDict[trimmed]) return translateDict[trimmed];
            let res = trimmed; for (const [k, v] of Object.entries(translateDict)) { if (res.includes(k)) res = res.replace(k, v); }
            return res;
        };

        window.autoTranslateLocation = async (elementId, text, trackingCode, historyIdx) => {
            const el = document.getElementById(elementId);
            if (!el || !text) return;
            const cleanText = text.trim();

            const applyTranslation = (translated) => {
                el.innerHTML = `<span class="font-medium text-gray-900 dark:text-gray-100">${translated}</span> <span class="text-xs text-gray-400 ml-1">(${cleanText})</span>`;
                const targetData = window.currentGlobalData.find(d => d.summary.code === trackingCode);
                if (targetData && targetData.history[historyIdx]) {
                    targetData.history[historyIdx].translatedOffice = translated;
                }
            };

            if (translationCache[cleanText]) { applyTranslation(translationCache[cleanText]); return; }

            try {
                const response = await fetch(`https://api.mymemory.translated.net/get?q=${encodeURIComponent(cleanText)}&langpair=ja|vi`);
                const data = await response.json();
                if (data.responseData && data.responseData.translatedText) {
                    const translated = data.responseData.translatedText;
                    translationCache[cleanText] = translated;
                    localStorage.setItem('jpLocationCache', JSON.stringify(translationCache));
                    applyTranslation(translated);
                } else {
                    el.innerHTML = `<span class="font-medium text-gray-900 dark:text-gray-100">${cleanText}</span>`;
                }
            } catch (err) {
                el.innerHTML = `<span class="font-medium text-gray-900 dark:text-gray-100">${cleanText}</span> <span class="text-[10px] text-red-500">(L·ªói)</span>`;
            }
        };


        // --- DOM Elements ---
        const trackForm = document.getElementById('trackForm');
        const trackingCodeInput = document.getElementById('trackingCode');
        const submitBtn = document.getElementById('submitBtn');
        const resultsContainer = document.getElementById('resultsContainer');
        const activeProxyText = document.getElementById('activeProxyText');

        document.getElementById('pasteBtn').addEventListener('click', async () => {
            try { const text = await navigator.clipboard.readText(); if (text) trackingCodeInput.value = text.trim(); } catch (e) { }
        });

        // --- L·ªäCH S·ª¨ LOCALSTORAGE ---
        const loadHistory = () => {
            const history = JSON.parse(localStorage.getItem('jpPostHistory') || '[]');
            if (history.length === 0) { document.getElementById('historySection').classList.add('hidden'); return; }
            document.getElementById('historySection').classList.remove('hidden');
            document.getElementById('historyList').innerHTML = history.map(item => `
                <div class="flex items-center justify-between p-3.5 bg-white dark:bg-gray-900 border border-gray-200 dark:border-gray-700 hover:border-gray-400 dark:hover:border-gray-500 rounded-xl cursor-pointer transition-colors shadow-sm" onclick="reTrack('${item.code}')">
                    <div>
                        <p class="font-mono text-sm font-bold text-gray-900 dark:text-white">${item.code}</p>
                        <p class="text-xs text-gray-500 dark:text-gray-400 mt-0.5">${item.type} ‚Ä¢ ${item.status}</p>
                    </div>
                    <div class="flex gap-1" onclick="event.stopPropagation()">
                        <button onclick="copyHistoryCode('${item.code}', this)" class="w-8 h-8 rounded-lg flex items-center justify-center text-gray-400 hover:bg-gray-100 dark:hover:bg-gray-800 hover:text-gray-900 dark:hover:text-white transition-colors"><i class="fa-regular fa-copy"></i></button>
                        <button onclick="deleteHistoryItem('${item.code}')" class="w-8 h-8 rounded-lg flex items-center justify-center text-gray-400 hover:bg-red-50 dark:hover:bg-red-900/20 hover:text-red-600 dark:hover:text-red-400 transition-colors"><i class="fa-solid fa-xmark"></i></button>
                    </div>
                </div>
            `).join('');
        };

        const saveHistory = (code, type, status) => {
            let history = JSON.parse(localStorage.getItem('jpPostHistory') || '[]');
            history = history.filter(item => item.code !== code);
            history.unshift({ code, type, status, date: new Date().toLocaleDateString('vi-VN') });
            if (history.length > 5) history.pop();
            localStorage.setItem('jpPostHistory', JSON.stringify(history));
            loadHistory();
        };

        window.deleteHistoryItem = (code) => {
            let history = JSON.parse(localStorage.getItem('jpPostHistory') || '[]');
            localStorage.setItem('jpPostHistory', JSON.stringify(history.filter(i => i.code !== code)));
            loadHistory();
        };

        window.copyHistoryCode = (code, btn) => {
            navigator.clipboard.writeText(code).then(() => {
                const icon = btn.innerHTML;
                btn.innerHTML = '<i class="fa-solid fa-check text-green-500"></i>';
                setTimeout(() => { btn.innerHTML = icon; }, 1500);
            });
        };

        window.reTrack = (code) => { trackingCodeInput.value = code; trackForm.dispatchEvent(new Event('submit')); window.scrollTo({ top: 0, behavior: 'smooth' }); };
        window.clearHistory = () => { localStorage.removeItem('jpPostHistory'); loadHistory(); };

        window.copyText = (text, element) => {
            navigator.clipboard.writeText(text).then(() => {
                const fb = element.querySelector('.copy-feedback');
                if (fb) { fb.classList.add('show'); setTimeout(() => fb.classList.remove('show'), 2000); }
            });
        };

        window.copyFullHistory = (code) => {
            const d = window.currentGlobalData.find(x => x.summary.code === code);
            if (!d) return;

            const reversedHistory = [...d.history].reverse();
            let text = `üì¶ M√É V·∫¨N ƒê∆†N: ${d.summary.code}\nüè∑Ô∏è LO·∫†I: ${d.summary.type}\nüìå TR·∫†NG TH√ÅI: ${d.history[d.history.length - 1].status}\n\nL·ªäCH TR√åNH:\n`;
            reversedHistory.forEach(h => {
                const locationDisplay = h.translatedOffice ? `${h.translatedOffice} (${h.office})` : h.office;
                text += `[${h.date}] ${h.status} - ${locationDisplay}\n`;
            });

            navigator.clipboard.writeText(text).then(() => {
                const btn = document.getElementById(`copyBtn-${code}`);
                if (btn) {
                    const oldText = btn.innerHTML;
                    btn.innerHTML = '<i class="fa-solid fa-check mr-1.5"></i> ƒê√£ sao ch√©p';
                    setTimeout(() => { btn.innerHTML = oldText; }, 2000);
                }
            });
        };

        // --- FETCH V√Ä PARSE API ---
        const proxiesConfig = [
            { id: '0', name: 'Server 1', getUrl: (url) => `https://api.allorigins.win/raw?url=${encodeURIComponent(url)}` },
            { id: '1', name: 'Server 2', getUrl: (url) => `https://api.codetabs.com/v1/proxy?quest=${encodeURIComponent(url)}` },
            { id: '2', name: 'Server 3', getUrl: (url) => `https://corsproxy.io/?${encodeURIComponent(url)}` }
        ];

        const fetchHtml = async (targetUrl, mode) => {
            let tries = (mode === 'auto') ? proxiesConfig : [proxiesConfig.find(p => p.id === mode)];
            for (let p of tries) {
                try {
                    const res = await fetch(p.getUrl(targetUrl));
                    if (res.ok) { const html = await res.text(); if (html.includes('<html')) return { html, serverName: p.name }; }
                } catch (e) { }
            }
            throw new Error("L·ªói Server. Vui l√≤ng ch·ªçn m√°y ch·ªß kh√°c (S1, S2, S3) ·ªü thanh c√¥ng c·ª•.");
        };

        const parseHtml = (html) => {
            const parser = new DOMParser(); const doc = parser.parseFromString(html, 'text/html');
            if (doc.querySelector('.req_error')) throw new Error("M√£ kh√¥ng t·ªìn t·∫°i ho·∫∑c sai ƒë·ªãnh d·∫°ng.");
            const tables = doc.querySelectorAll('table.tableType01');
            let summary = {}, history = [];
            tables.forEach(tNode => {
                const head = tNode.querySelector('th')?.innerText;
                if (head?.includes('„ÅäÂïè„ÅÑÂêà„Çè„ÅõÁï™Âè∑')) {
                    const tds = tNode.querySelectorAll('tr')[1].querySelectorAll('td');
                    summary = { code: tds[0].innerText.trim(), type: t(tds[1].innerText) };
                }
                if (head?.includes('Áä∂ÊÖãÁô∫ÁîüÊó•')) {
                    tNode.querySelectorAll('tr').forEach((r, idx) => {
                        if (idx === 0) return; const c = r.querySelectorAll('td');
                        if (c.length >= 5) history.push({ date: c[0].innerText.trim(), status: t(c[1].innerText), rawStatus: c[1].innerText.trim(), office: c[3].innerText.trim(), translatedOffice: null });
                    });
                }
            });
            return { summary, history };
        };

        // RENDER T·ª™NG K·∫æT QU·∫¢ ƒê∆†N H√ÄNG
        const renderSingleResult = (data) => {
            const lastStatus = data.history[data.history.length - 1].status;
            const isDelivered = data.history[data.history.length - 1].rawStatus.includes('„ÅäÂ±ä„ÅëÊ∏à„Åø');
            const statusColor = isDelivered ? 'text-green-600 dark:text-green-400' : 'text-jp-red dark:text-red-400';
            const code = data.summary.code;

            const reversedHistory = data.history.map((h, i) => ({ ...h, originalIdx: i })).reverse();

            const wrapper = document.createElement('div');
            wrapper.className = 'bg-white dark:bg-gray-900 border border-gray-200 dark:border-gray-800 rounded-2xl shadow-sm fade-in overflow-hidden';

            wrapper.innerHTML = `
                <div class="grid grid-cols-1 md:grid-cols-3 divide-y md:divide-y-0 md:divide-x divide-gray-100 dark:divide-gray-800 bg-gray-50/30 dark:bg-gray-800/10">
                    <div class="p-5 relative cursor-pointer hover:bg-gray-50 dark:hover:bg-gray-800/50 transition-colors" onclick="copyText('${code}', this)">
                        <span class="copy-feedback">ƒê√£ sao ch√©p</span>
                        <p class="text-[11px] text-gray-500 dark:text-gray-400 uppercase tracking-widest mb-1 font-semibold">M√£ V·∫≠n ƒê∆°n</p>
                        <p class="text-xl font-mono font-bold text-gray-900 dark:text-white">${code}</p>
                    </div>
                    <div class="p-5 relative cursor-pointer hover:bg-gray-50 dark:hover:bg-gray-800/50 transition-colors" onclick="copyText('${data.summary.type}', this)">
                        <span class="copy-feedback">ƒê√£ sao ch√©p</span>
                        <p class="text-[11px] text-gray-500 dark:text-gray-400 uppercase tracking-widest mb-1 font-semibold">D·ªãch V·ª•</p>
                        <p class="text-xl font-semibold text-gray-900 dark:text-white truncate" title="${data.summary.type}">${data.summary.type}</p>
                    </div>
                    <div class="p-5 relative cursor-pointer hover:bg-gray-50 dark:hover:bg-gray-800/50 transition-colors" onclick="copyText('${lastStatus}', this)">
                        <span class="copy-feedback">ƒê√£ sao ch√©p</span>
                        <p class="text-[11px] text-gray-500 dark:text-gray-400 uppercase tracking-widest mb-1 font-semibold">Tr·∫°ng Th√°i</p>
                        <p class="text-xl font-bold ${statusColor} truncate" title="${lastStatus}">${lastStatus}</p>
                    </div>
                </div>

                <div class="border-t border-gray-100 dark:border-gray-800">
                    <div class="p-4 md:p-5 border-b border-gray-100 dark:border-gray-800 flex justify-between items-center bg-gray-50/50 dark:bg-gray-800/20">
                        <h2 class="text-sm font-bold text-gray-900 dark:text-white uppercase tracking-wide"><i class="fa-solid fa-list-ul mr-2 text-gray-400"></i>L·ªãch Tr√¨nh</h2>
                        <button id="copyBtn-${code}" onclick="copyFullHistory('${code}')" class="text-xs font-semibold text-gray-600 dark:text-gray-300 border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-800 rounded-lg px-3 py-1.5 hover:bg-gray-50 dark:hover:bg-gray-700 transition-colors shadow-sm flex items-center">
                            <i class="fa-regular fa-copy mr-1.5"></i> Ch√©p
                        </button>
                    </div>

                    <div class="p-6 md:p-8">
                        <div class="relative ml-2">
                            <div class="absolute left-[5px] top-2 bottom-2 w-px bg-gray-200 dark:bg-gray-700"></div>
                            
                            <div class="space-y-6 md:space-y-7">
                                ${reversedHistory.map((h, index) => {
                const isLatest = index === 0;
                const isFinish = isLatest && h.rawStatus.includes('„ÅäÂ±ä„ÅëÊ∏à„Åø');
                let dotColor = 'bg-gray-300 dark:bg-gray-600 border-white dark:border-gray-900';

                if (isLatest) {
                    dotColor = isFinish
                        ? 'bg-green-500 border-white dark:border-gray-900 ring-2 ring-green-100 dark:ring-green-900/50'
                        : 'bg-jp-red border-white dark:border-gray-900 ring-2 ring-red-100 dark:ring-red-900/50';
                }

                return `
                                    <div class="relative pl-8">
                                        <div class="absolute left-0 top-1.5 w-3 h-3 rounded-full border-2 ${dotColor}"></div>
                                        
                                        <div>
                                            <div class="flex flex-col md:flex-row md:items-baseline gap-1 md:gap-3 mb-1.5">
                                                <h3 class="text-base font-bold ${isLatest ? 'text-gray-900 dark:text-white' : 'text-gray-600 dark:text-gray-400'}">${h.status}</h3>
                                                <span class="text-xs font-mono text-gray-500 dark:text-gray-500">${h.date}</span>
                                            </div>
                                            
                                            <div class="text-sm mt-1 flex items-start text-gray-600 dark:text-gray-400">
                                                <span id="loc-${code}-${h.originalIdx}">
                                                    ${h.office ? `<span class="italic text-gray-400 dark:text-gray-500">ƒêang d·ªãch...</span>` : '<span class="text-gray-400 dark:text-gray-600">-</span>'}
                                                </span>
                                            </div>
                                        </div>
                                    </div>
                                    `;
            }).join('')}
                            </div>
                        </div>
                    </div>
                </div>
            `;

            resultsContainer.appendChild(wrapper);
            saveHistory(data.summary.code, data.summary.type, lastStatus);

            reversedHistory.forEach((h) => {
                if (h.office) {
                    autoTranslateLocation(`loc-${code}-${h.originalIdx}`, h.office, code, h.originalIdx);
                }
            });
        };

        const renderErrorResult = (code, message) => {
            const wrapper = document.createElement('div');
            wrapper.className = 'bg-red-50 dark:bg-red-900/20 border border-red-200 dark:border-red-800 rounded-2xl p-6 fade-in shadow-sm flex items-start gap-4';
            wrapper.innerHTML = `
                <div class="w-10 h-10 rounded-full bg-red-100 dark:bg-red-900/50 text-red-600 dark:text-red-400 flex items-center justify-center shrink-0">
                    <i class="fa-solid fa-triangle-exclamation"></i>
                </div>
                <div>
                    <h3 class="text-lg font-mono font-bold text-red-800 dark:text-red-300">${code}</h3>
                    <p class="text-sm text-red-600 dark:text-red-400 mt-1">${message}</p>
                </div>
            `;
            resultsContainer.appendChild(wrapper);
        };

        // --- SUBMIT EVENT H√ÄNG LO·∫†T ---
        trackForm.addEventListener('submit', async (e) => {
            e.preventDefault();

            const rawText = trackingCodeInput.value;
            let codes = rawText.split(/[\n,\s]+/).map(c => c.replace(/[^a-zA-Z0-9]/g, '')).filter(c => c.length >= 11);

            codes = [...new Set(codes)].slice(0, 10);

            if (codes.length === 0) {
                trackingCodeInput.focus();
                // Hi·ªáu ·ª©ng nh√°y ƒë·ªè nguy√™n kh·ªëi input
                const formBlock = trackingCodeInput.closest('.border-gray-300, .dark\\:border-gray-700');
                formBlock.classList.add('border-red-500', 'ring-1', 'ring-red-500');
                setTimeout(() => formBlock.classList.remove('border-red-500', 'ring-1', 'ring-red-500'), 1000);
                return;
            }

            submitBtn.disabled = true;
            resultsContainer.innerHTML = '';
            window.currentGlobalData = [];
            resultsContainer.classList.add('hidden');

            document.getElementById('loadingInfo').classList.remove('hidden');
            submitBtn.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i>';

            let serverMode = document.querySelector('input[name="serverMode"]:checked').value;

            for (let i = 0; i < codes.length; i++) {
                const code = codes[i];
                activeProxyText.innerText = `ƒêang x·ª≠ l√Ω: ${code} (${i + 1}/${codes.length})...`;

                try {
                    const result = await fetchHtml(`https://trackings.post.japanpost.jp/services/srv/search/direct?searchKind=S002&locale=ja&reqCodeNo1=${code}`, serverMode);
                    const data = parseHtml(result.html);
                    window.currentGlobalData.push(data);
                    renderSingleResult(data);
                } catch (err) {
                    renderErrorResult(code, err.message);
                }
            }

            document.getElementById('loadingInfo').classList.add('hidden');
            submitBtn.disabled = false;
            submitBtn.innerHTML = 'Tra c·ª©u ngay';
            resultsContainer.classList.remove('hidden');
        });

        // Kh·ªüi t·∫°o
        loadHistory();
        const savedS = localStorage.getItem('jpPostServerMode') || 'auto';
        const rad = document.querySelector(`input[value="${savedS}"]`); if (rad) rad.checked = true;
        document.querySelectorAll('.server-radio').forEach(r => r.addEventListener('change', e => localStorage.setItem('jpPostServerMode', e.target.value)));
    </script>
</body>

</html>