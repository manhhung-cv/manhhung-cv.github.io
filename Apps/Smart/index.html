<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tủ Lạnh AI - Quản Lý Thực Phẩm</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <style>
        :root {
            --primary: #4F46E5; /* Indigo */
            --primary-dark: #4338ca;
            --secondary: #10B981; /* Emerald */
            --bg: #F3F4F6;
            --white: #ffffff;
            --danger: #EF4444;
            --warning: #F59E0B;
            --text: #1F2937;
            --chat-bg: #E5E7EB;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
        body { background-color: var(--bg); color: var(--text); padding-bottom: 80px; }

        .container { max-width: 600px; margin: 0 auto; padding: 20px; }

        /* Header */
        header { 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            margin-bottom: 20px; 
            background: var(--white);
            padding: 15px;
            border-radius: 15px;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
        }
        h1 { font-size: 1.5rem; color: var(--primary); display: flex; align-items: center; gap: 10px; }
        
        /* Stats */
        .stats-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-bottom: 20px;
        }
        .stat-card {
            background: var(--white);
            padding: 15px;
            border-radius: 12px;
            text-align: center;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        }
        .stat-val { font-size: 1.8rem; font-weight: 800; color: var(--primary); }
        .stat-lbl { font-size: 0.85rem; color: #6B7280; }

        /* Quick Input Bar (Manual) */
        .manual-input {
            background: var(--white);
            padding: 15px;
            border-radius: 15px;
            margin-bottom: 20px;
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        }
        .input-group { flex: 1; min-width: 120px; }
        input, select { 
            width: 100%; 
            padding: 10px; 
            border: 1px solid #E5E7EB; 
            border-radius: 8px; 
            outline: none;
            transition: border 0.3s;
        }
        input:focus { border-color: var(--primary); }
        
        /* Suggestion Pills */
        .quick-dates { display: flex; gap: 5px; margin-top: 5px; }
        .date-pill {
            font-size: 0.75rem;
            background: #EEF2FF;
            color: var(--primary);
            padding: 4px 8px;
            border-radius: 20px;
            cursor: pointer;
            border: 1px solid transparent;
        }
        .date-pill:hover { border-color: var(--primary); background: #E0E7FF; }

        /* Inventory List */
        .list-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; }
        .inventory-list { list-style: none; padding-bottom: 100px; }
        
        .item-card {
            background: var(--white);
            margin-bottom: 12px;
            padding: 15px;
            border-radius: 12px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 1px 3px rgba(0,0,0,0.05);
            border-left: 5px solid #ccc;
            position: relative;
            overflow: hidden;
        }
        
        .item-card.safe { border-left-color: var(--secondary); }
        .item-card.warning { border-left-color: var(--warning); }
        .item-card.danger { border-left-color: var(--danger); }

        .item-details h3 { font-size: 1rem; margin-bottom: 4px; }
        .item-meta { font-size: 0.8rem; color: #6B7280; display: flex; gap: 10px; }
        
        .days-badge {
            font-size: 0.8rem;
            font-weight: bold;
            padding: 4px 8px;
            border-radius: 6px;
            background: #F3F4F6;
        }

        .delete-btn {
            background: #FEE2E2;
            color: var(--danger);
            border: none;
            width: 35px;
            height: 35px;
            border-radius: 50%;
            cursor: pointer;
            display: flex; align-items: center; justify-content: center;
            margin-left: 10px;
            transition: 0.2s;
        }
        .delete-btn:hover { background: var(--danger); color: var(--white); }

        /* CHAT BOT INTERFACE */
        .chat-overlay {
            position: fixed;
            bottom: 20px;
            right: 20px;
            left: 20px; /* Full width on mobile */
            max-width: 560px;
            margin: 0 auto;
            z-index: 1000;
            display: flex;
            flex-direction: column;
            align-items: flex-end;
            pointer-events: none; /* Let clicks pass through when collapsed */
        }

        .chat-window {
            width: 100%;
            background: var(--white);
            border-radius: 15px;
            box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.2);
            display: none; /* Hidden by default */
            flex-direction: column;
            overflow: hidden;
            pointer-events: auto;
            margin-bottom: 15px;
            border: 1px solid #E5E7EB;
        }

        .chat-header {
            background: var(--primary);
            color: white;
            padding: 12px 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-weight: bold;
        }

        .chat-messages {
            height: 250px;
            overflow-y: auto;
            padding: 15px;
            background: #F9FAFB;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .message {
            max-width: 80%;
            padding: 8px 12px;
            border-radius: 12px;
            font-size: 0.9rem;
            line-height: 1.4;
        }
        .msg-bot { background: #E0E7FF; color: var(--text); align-self: flex-start; border-bottom-left-radius: 2px; }
        .msg-user { background: var(--primary); color: white; align-self: flex-end; border-bottom-right-radius: 2px; }

        .chat-input-area {
            padding: 10px;
            background: var(--white);
            border-top: 1px solid #E5E7EB;
            display: flex;
            gap: 8px;
        }

        .chat-toggle-btn {
            pointer-events: auto;
            background: var(--primary);
            color: white;
            width: 60px;
            height: 60px;
            border-radius: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
            box-shadow: 0 4px 6px rgba(0,0,0,0.2);
            cursor: pointer;
            border: none;
            transition: transform 0.2s;
        }
        .chat-toggle-btn:hover { transform: scale(1.1); }

        .mic-btn {
            background: #F3F4F6;
            border: none;
            width: 40px;
            border-radius: 8px;
            cursor: pointer;
            color: var(--text);
            transition: all 0.3s ease;
        }
        .mic-btn.listening { color: var(--danger); animation: pulse 1.5s infinite; }
        /* Trạng thái chế độ hội thoại đang bật (dù đang không thu âm) */
        .mic-btn.active-mode { background: #fee2e2; border: 1px solid var(--danger); }

        @keyframes pulse { 0% { opacity: 1; transform: scale(1); } 50% { opacity: 0.5; transform: scale(1.1); } 100% { opacity: 1; transform: scale(1); } }
        
        /* Loading Indicator */
        .typing-indicator { font-style: italic; color: #9CA3AF; font-size: 0.8rem; margin-left: 10px; display: none;}

        /* Config Modal */
        .modal {
            display: none; 
            position: fixed; z-index: 2000; left: 0; top: 0; width: 100%; height: 100%; 
            background-color: rgba(0,0,0,0.5);
        }
        .modal-content {
            background-color: #fefefe; margin: 15% auto; padding: 20px; border: 1px solid #888; 
            width: 90%; max-width: 400px; border-radius: 10px;
        }

    </style>
</head>
<body>

<div class="container">
    <header>
        <h1><i class="fas fa-robot"></i> Tủ Lạnh AI</h1>
        <button onclick="openConfig()" style="border:none; background:none; cursor:pointer; font-size:1.2rem; color:#6B7280"><i class="fas fa-cog"></i></button>
    </header>

    <div class="stats-grid">
        <div class="stat-card">
            <div class="stat-val" id="total-count">0</div>
            <div class="stat-lbl">Món đồ</div>
        </div>
        <div class="stat-card">
            <div class="stat-val" id="expiring-count" style="color: var(--warning)">0</div>
            <div class="stat-lbl">Sắp hết hạn</div>
        </div>
    </div>

    <div class="list-header">
        <h2>Danh sách đồ trong tủ</h2>
        <button onclick="toggleManualInput()" style="color: var(--primary); background: none; border: none; font-weight: bold; cursor: pointer;">
            + Nhập tay
        </button>
    </div>

    <!-- Manual Input (Hidden by default) -->
    <div class="manual-input" id="manual-input-box" style="display:none;">
        <div class="input-group" style="flex: 2;">
            <input type="text" id="m-name" placeholder="Tên món (vd: Cá hồi)" list="food-suggestions">
            <datalist id="food-suggestions">
                <option value="Trứng gà">
                <option value="Sữa tươi">
                <option value="Thịt bò">
                <option value="Rau cải">
                <option value="Cà chua">
                <option value="Phô mai">
                <option value="Táo">
            </datalist>
        </div>
        <div class="input-group">
            <input type="date" id="m-date">
            <div class="quick-dates">
                <span class="date-pill" onclick="setDate(3)">+3 ngày</span>
                <span class="date-pill" onclick="setDate(7)">+1 tuần</span>
                <span class="date-pill" onclick="setDate(30)">+1 tháng</span>
            </div>
        </div>
        <button onclick="addManualItem()" style="background: var(--primary); color: white; border: none; border-radius: 8px; padding: 0 20px; cursor: pointer;">Lưu</button>
    </div>

    <ul class="inventory-list" id="inventory-list">
        <!-- JS render items here -->
    </ul>
</div>

<!-- Chat Interface -->
<div class="chat-overlay">
    <div class="chat-window" id="chat-window">
        <div class="chat-header">
            <span>Trợ lý Tủ Lạnh</span>
            <button onclick="toggleChat()" style="background:none; border:none; color:white; cursor:pointer;"><i class="fas fa-times"></i></button>
        </div>
        <div class="chat-messages" id="chat-messages">
            <div class="message msg-bot">Xin chào! Bạn muốn thêm gì vào tủ lạnh? Có thể nói hoặc gõ vào đây.</div>
        </div>
        <div class="typing-indicator" id="typing-indicator">AI đang suy nghĩ...</div>
        <div class="chat-input-area">
            <button class="mic-btn" id="mic-btn" onclick="toggleVoice()"><i class="fas fa-microphone"></i></button>
            <input type="text" id="chat-input" placeholder="VD: Mua 1 vỉ trứng hết hạn tuần sau..." onkeypress="handleChatKey(event)">
            <button onclick="processChatInput()" style="background: var(--primary); color: white; border: none; padding: 0 15px; border-radius: 8px; cursor: pointer;"><i class="fas fa-paper-plane"></i></button>
        </div>
    </div>
    
    <button class="chat-toggle-btn" onclick="toggleChat()">
        <i class="fas fa-comment-dots"></i>
    </button>
</div>

<!-- Config Modal -->
<div id="configModal" class="modal">
    <div class="modal-content">
        <h3>Cài đặt API</h3>
        <p style="font-size: 0.8rem; color: #666; margin-bottom: 10px;">Để dùng tính năng AI thông minh.</p>
        <input type="password" id="api-key-input" placeholder="Nhập Gemini API Key" style="margin-bottom: 10px;">
        <div style="text-align: right;">
            <button onclick="saveConfig()" style="padding: 8px 15px; background: var(--primary); color: white; border: none; border-radius: 5px; cursor: pointer;">Lưu</button>
            <button onclick="closeConfig()" style="padding: 8px 15px; background: #ddd; border: none; border-radius: 5px; cursor: pointer;">Đóng</button>
        </div>
    </div>
</div>

<script>
    // --- CẤU HÌNH ---
    const DEFAULT_API_KEY = "AIzaSyDt1hacR_iBfQ8fGYGSklF8F-RfzACNLwU"; 
    let currentApiKey = localStorage.getItem('gemini_api_key') || DEFAULT_API_KEY;

    // --- DATA STORE ---
    let inventory = JSON.parse(localStorage.getItem('smart_fridge_inventory')) || [];
    
    // --- CHAT & BOT LOGIC ---
    let isChatOpen = false;
    let isOfflineMode = false;
    let offlineStep = 0;
    let tempItem = {};
    
    // Voice & Conversation Logic
    let isConversationMode = false; // Chế độ hội thoại liên tục
    let isBotSpeaking = false;      // Bot đang nói

    // --- VOICE RECOGNITION SETUP ---
    const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
    let recognition;
    let isListening = false;

    if (SpeechRecognition) {
        recognition = new SpeechRecognition();
        recognition.lang = 'vi-VN';
        recognition.continuous = false; // Dùng false để ngắt sau mỗi câu, tránh lỗi buffer
        recognition.interimResults = false;
        
        recognition.onstart = () => {
            isListening = true;
            updateMicUI();
        };

        recognition.onend = () => {
            isListening = false;
            updateMicUI();
        };

        recognition.onresult = (event) => {
            const text = event.results[0][0].transcript;
            document.getElementById('chat-input').value = text;
            processChatInput(); // Tự động gửi
        };

        recognition.onerror = (event) => {
            console.warn("Lỗi nhận dạng giọng nói:", event.error);
            isListening = false;
            updateMicUI();
            // Nếu lỗi 'no-speech' và đang ở chế độ hội thoại, có thể thử bật lại (tuỳ chọn),
            // nhưng để tránh vòng lặp vô tận khi ồn, ta có thể dừng.
            // Ở đây ta giữ nguyên, người dùng bấm lại nếu cần.
            if(event.error === 'not-allowed') {
                isConversationMode = false;
                alert("Vui lòng cấp quyền Micro để sử dụng tính năng này.");
            }
        };
    }

    // --- MAIN FUNCTIONS ---

    function init() {
        document.getElementById('api-key-input').value = currentApiKey;
        renderInventory();
    }

    // --- RENDER & LOGIC ---
    function renderInventory() {
        const listEl = document.getElementById('inventory-list');
        listEl.innerHTML = '';
        
        inventory.sort((a, b) => new Date(a.date) - new Date(b.date));
        
        const today = new Date();
        today.setHours(0,0,0,0);

        let expiringCount = 0;

        inventory.forEach(item => {
            const expDate = new Date(item.date);
            const diffTime = expDate - today;
            const daysLeft = Math.ceil(diffTime / (1000 * 60 * 60 * 24));

            let statusClass = 'safe';
            let badgeText = `${daysLeft} ngày`;
            let badgeColor = '#10B981'; 

            if (daysLeft < 0) {
                statusClass = 'danger';
                badgeText = `Hết hạn ${Math.abs(daysLeft)} ngày`;
                badgeColor = '#EF4444';
            } else if (daysLeft <= 3) {
                statusClass = 'warning';
                badgeText = `Còn ${daysLeft} ngày`;
                badgeColor = '#F59E0B';
                expiringCount++;
            }

            const li = document.createElement('li');
            li.className = `item-card ${statusClass}`;
            li.innerHTML = `
                <div class="item-details">
                    <h3>${item.name}</h3>
                    <div class="item-meta">
                        <span><i class="far fa-calendar-alt"></i> ${item.date}</span>
                    </div>
                </div>
                <div style="display:flex; align-items:center;">
                    <span class="days-badge" style="color: ${badgeColor}; border: 1px solid ${badgeColor}">${badgeText}</span>
                    <button class="delete-btn" onclick="deleteItem(${item.id})"><i class="fas fa-trash"></i></button>
                </div>
            `;
            listEl.appendChild(li);
        });

        document.getElementById('total-count').innerText = inventory.length;
        document.getElementById('expiring-count').innerText = expiringCount;
        localStorage.setItem('smart_fridge_inventory', JSON.stringify(inventory));
    }

    function addManualItem() {
        const name = document.getElementById('m-name').value;
        const date = document.getElementById('m-date').value;
        if(name && date) {
            addItemToData(name, date);
            document.getElementById('m-name').value = '';
            document.getElementById('m-date').value = '';
            document.getElementById('manual-input-box').style.display = 'none';
        } else {
            alert("Vui lòng nhập tên và ngày hết hạn");
        }
    }

    function addItemToData(name, date) {
        inventory.push({
            id: Date.now(),
            name: capitalizeFirstLetter(name),
            date: date
        });
        renderInventory();
    }

    function deleteItem(id) {
        if(confirm("Bạn đã dùng món này rồi?")) {
            inventory = inventory.filter(i => i.id !== id);
            renderInventory();
        }
    }

    // --- AI & CHAT LOGIC ---

    function toggleChat() {
        const win = document.getElementById('chat-window');
        isChatOpen = !isChatOpen;
        win.style.display = isChatOpen ? 'flex' : 'none';
        if(isChatOpen) document.getElementById('chat-input').focus();
    }

    function toggleVoice() {
        if (!recognition) {
            alert("Trình duyệt không hỗ trợ nhận diện giọng nói.");
            return;
        }

        // Nếu đang bật chế độ hội thoại, bấm nút sẽ tắt
        if (isConversationMode) {
            isConversationMode = false;
            recognition.stop();
            window.speechSynthesis.cancel(); // Dừng nói
            updateMicUI();
        } else {
            // Bật chế độ hội thoại
            isConversationMode = true;
            recognition.start();
            updateMicUI();
        }
    }

    function updateMicUI() {
        const btn = document.getElementById('mic-btn');
        // Xóa hết class cũ
        btn.classList.remove('listening', 'active-mode');

        if (isConversationMode) {
            btn.classList.add('active-mode'); // Nền đỏ nhạt để báo đang bật chế độ rảnh tay
            if (isListening) {
                btn.classList.add('listening'); // Pulse effect khi thực sự đang nghe
            }
        }
    }

    // Hàm Bot nói phản hồi
    function speak(text) {
        if (!window.speechSynthesis) return;
        
        // Ngắt lời cũ
        window.speechSynthesis.cancel();
        isBotSpeaking = true;

        const utterance = new SpeechSynthesisUtterance(text);
        utterance.lang = 'vi-VN'; // Giọng đọc tiếng Việt
        utterance.rate = 1.0;

        // Khi nói xong, nếu đang ở chế độ hội thoại -> Bật lại Mic
        utterance.onend = () => {
            isBotSpeaking = false;
            if (isConversationMode) {
                try {
                    recognition.start();
                } catch(e) {
                    // Nếu mic đã bật sẵn thì bỏ qua
                }
            }
        };

        window.speechSynthesis.speak(utterance);
    }

    // Helper để Bot trả lời (vừa chat text vừa nói)
    function replyBot(text) {
        addMessage(text, 'bot');
        // Chỉ nói nếu đang ở chế độ hội thoại
        if (isConversationMode) {
            speak(text);
        }
    }

    function handleChatKey(e) {
        if(e.key === 'Enter') processChatInput();
    }

    function addMessage(text, type) {
        const msgDiv = document.getElementById('chat-messages');
        const div = document.createElement('div');
        div.className = `message ${type === 'user' ? 'msg-user' : 'msg-bot'}`;
        div.innerText = text;
        msgDiv.appendChild(div);
        msgDiv.scrollTop = msgDiv.scrollHeight;
    }

    async function processChatInput() {
        const inputEl = document.getElementById('chat-input');
        const text = inputEl.value.trim();
        if(!text) return;

        addMessage(text, 'user');
        inputEl.value = '';

        // OFFLINE BOT LOGIC
        if (isOfflineMode || offlineStep > 0) {
            handleOfflineBot(text);
            return;
        }

        // ONLINE AI LOGIC
        document.getElementById('typing-indicator').style.display = 'block';
        
        try {
            const aiResponse = await callGeminiAPI(text);
            document.getElementById('typing-indicator').style.display = 'none';

            if (aiResponse && aiResponse.items && aiResponse.items.length > 0) {
                let addedNames = [];
                aiResponse.items.forEach(item => {
                    addItemToData(item.name, item.expiryDate);
                    addedNames.push(item.name);
                });
                const replyText = `Đã thêm: ${addedNames.join(', ')} vào tủ lạnh. Bạn cần thêm gì nữa không?`;
                replyBot(replyText);
            } else {
                fallbackToOfflineBot();
            }

        } catch (error) {
            console.error(error);
            document.getElementById('typing-indicator').style.display = 'none';
            replyBot("Lỗi kết nối AI. Chuyển sang nhập thủ công từng bước.");
            fallbackToOfflineBot();
        }
    }

    function fallbackToOfflineBot() {
        isOfflineMode = true;
        offlineStep = 1;
        replyBot("Tôi chưa hiểu rõ. Tên món đồ bạn muốn thêm là gì?");
    }

    function handleOfflineBot(text) {
        if (offlineStep === 1) {
            tempItem.name = text;
            offlineStep = 2;
            replyBot(`Ok, món "${text}". Hạn sử dụng bao lâu?`);
        } else if (offlineStep === 2) {
            let date = parseRelativeDate(text);
            if (!date) {
                replyBot("Ngày không hợp lệ. Vui lòng thử lại hoặc dùng bảng nhập tay.");
                document.getElementById('manual-input-box').style.display = 'flex';
                document.getElementById('m-name').value = tempItem.name;
                offlineStep = 0;
                isOfflineMode = false;
                return;
            }
            
            addItemToData(tempItem.name, date);
            replyBot(`Đã thêm ${tempItem.name} hạn đến ${date}. Tiếp tục không?`);
            offlineStep = 1;
            tempItem = {};
        }
    }

    // --- GEMINI API INTEGRATION ---
    async function callGeminiAPI(userInput) {
        const today = new Date().toISOString().split('T')[0];
        
        const prompt = `
            Bạn là trợ lý tủ lạnh. Hôm nay là ${today}.
            Hãy trích xuất thông tin từ văn bản sau của người dùng: "${userInput}".
            Trả về CHỈ một JSON object (không có markdown) theo định dạng:
            {
                "items": [
                    { "name": "Tên món (viết hoa chữ cái đầu)", "expiryDate": "YYYY-MM-DD" }
                ]
            }
            Nếu người dùng nói "ngày mai", "tuần sau", "3 ngày nữa", hãy tự tính ra ngày cụ thể.
            Nếu không tìm thấy thông tin món ăn, trả về { "items": [] }.
        `;

        const url = `https://generativelanguage.googleapis.com/v1beta/models/gemini-pro:generateContent?key=${currentApiKey}`;
        
        const response = await fetch(url, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                contents: [{ parts: [{ text: prompt }] }]
            })
        });

        if (!response.ok) throw new Error('API Error');

        const data = await response.json();
        const rawText = data.candidates[0].content.parts[0].text;
        const jsonText = rawText.replace(/```json/g, '').replace(/```/g, '').trim();
        return JSON.parse(jsonText);
    }

    // --- UTILS ---
    function toggleManualInput() {
        const box = document.getElementById('manual-input-box');
        box.style.display = box.style.display === 'none' ? 'flex' : 'none';
    }

    function setDate(daysToAdd) {
        const date = new Date();
        date.setDate(date.getDate() + daysToAdd);
        document.getElementById('m-date').valueAsDate = date;
    }

    function parseRelativeDate(text) {
        const now = new Date();
        const lower = text.toLowerCase();
        
        if (lower.includes("mai")) now.setDate(now.getDate() + 1);
        else if (lower.includes("kia")) now.setDate(now.getDate() + 2);
        else if (lower.includes("tuần sau")) now.setDate(now.getDate() + 7);
        else if (lower.match(/\d+\s+ngày/)) {
            const days = parseInt(lower.match(/(\d+)\s+ngày/)[1]);
            now.setDate(now.getDate() + days);
        } else {
            const tryDate = new Date(text);
            if (!isNaN(tryDate)) return text;
            return now.toISOString().split('T')[0]; 
        }
        return now.toISOString().split('T')[0];
    }

    function capitalizeFirstLetter(string) {
        return string.charAt(0).toUpperCase() + string.slice(1);
    }

    function openConfig() { document.getElementById('configModal').style.display = "block"; }
    function closeConfig() { document.getElementById('configModal').style.display = "none"; }
    function saveConfig() {
        const val = document.getElementById('api-key-input').value;
        if(val) {
            currentApiKey = val;
            localStorage.setItem('gemini_api_key', val);
            alert("Đã lưu API Key!");
            closeConfig();
        }
    }

    window.onclick = function(event) {
        if (event.target == document.getElementById('configModal')) {
            closeConfig();
        }
    }

    init();

</script>
</body>
</html>