<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Smiles Remit Pro</title>
    <style>
        /* --- CẤU HÌNH MÀU SẮC VÀ FONTS --- */
        :root {
            --primary: #ffb700;
            --primary-hover: #ffaa00;
            --text-dark: #1a1a1a;
            --text-grey: #666;
            --card-bg: rgba(255, 255, 255, 0.92);
            --success: #2e7d32;
            --error: #d32f2f;
            --toggle-bg: #e0e0e0;
            --toggle-active: #28a745;
            --radius: 20px;
        }

        * { box-sizing: border-box; }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background: linear-gradient(135deg, #e0eafc 0%, #cfdef3 100%);
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            margin: 0;
            color: var(--text-dark);
            overflow-x: hidden;
        }

        /* HIỆU ỨNG NỀN */
        .bg-blobs { position: fixed; width: 100%; height: 100%; z-index: -1; top: 0; left: 0; overflow: hidden; }
        .blob { position: absolute; border-radius: 50%; filter: blur(60px); opacity: 0.6; animation: float 10s infinite alternate; }
        .blob-1 { width: 350px; height: 350px; background: #ffecd2; top: -10%; left: -10%; }
        .blob-2 { width: 300px; height: 300px; background: #fcb69f; bottom: -5%; right: -5%; animation-delay: -5s; }
        @keyframes float { from { transform: translate(0, 0); } to { transform: translate(30px, 50px); } }

        /* THẺ CHÍNH */
        .card {
            background: var(--card-bg);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border-radius: var(--radius);
            padding: 25px;
            width: 95%;
            max-width: 480px;
            box-shadow: 0 15px 35px rgba(0,0,0,0.1);
            border: 1px solid rgba(255,255,255,0.6);
        }

        h2 { text-align: center; margin: 0 0 5px 0; color: #333; font-weight: 800; letter-spacing: -0.5px; }

        /* TRẠNG THÁI */
        .status-bar { text-align: center; margin-bottom: 20px; }
        .rate-display { font-size: 1.1rem; font-weight: 700; color: var(--success); }
        .time-display { font-size: 0.75rem; color: #999; font-style: italic; margin-top: 4px; }

        /* TOGGLE SWITCH */
        .toggle-wrapper {
            display: flex; justify-content: space-between; align-items: center;
            background: #fff; padding: 12px 15px; border-radius: 16px; margin-bottom: 20px;
            border: 1px solid #eee; box-shadow: 0 4px 10px rgba(0,0,0,0.03);
        }
        .toggle-text { font-size: 0.9rem; font-weight: 600; color: #555; }
        .toggle-sub { font-size: 0.75rem; color: #999; font-weight: normal; display: block; margin-top: 2px;}
        
        .switch { position: relative; display: inline-block; width: 50px; height: 28px; }
        .switch input { opacity: 0; width: 0; height: 0; }
        .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #ccc; transition: .4s; border-radius: 34px; }
        .slider:before { position: absolute; content: ""; height: 22px; width: 22px; left: 3px; bottom: 3px; background-color: white; transition: .4s; border-radius: 50%; box-shadow: 0 2px 5px rgba(0,0,0,0.2); }
        input:checked + .slider { background-color: var(--toggle-active); }
        input:checked + .slider:before { transform: translateX(22px); }

        /* INPUTS */
        .input-container {
            background: #fff; border: 1px solid #e0e0e0; border-radius: 16px;
            padding: 10px 15px; margin-bottom: 12px; display: flex; align-items: center;
            transition: all 0.2s;
        }
        .input-container:focus-within { border-color: var(--primary); box-shadow: 0 0 0 4px rgba(255, 183, 0, 0.15); transform: translateY(-1px); }
        .input-container.highlight { border-color: var(--toggle-active); box-shadow: 0 0 0 4px rgba(40, 167, 69, 0.1); }
        
        .input-wrapper { flex: 1; }
        .input-label { font-size: 0.7rem; font-weight: 700; color: #888; text-transform: uppercase; display: block; margin-bottom: 2px; }
        .input-field { width: 100%; border: none; font-size: 1.5rem; font-weight: 700; color: #333; outline: none; padding: 0; background: transparent; }
        .currency { font-weight: 700; color: #bbb; font-size: 0.9rem; padding-left: 10px; }

        /* KẾT QUẢ */
        .result-box { background: #f8f9fa; border-radius: 16px; padding: 20px; border: 1px solid #eee; margin-bottom: 20px; }
        
        .points-input-row { display: flex; justify-content: space-between; align-items: center; padding-bottom: 12px; border-bottom: 1px dashed #ddd; margin-bottom: 12px; }
        .points-label { font-size: 0.9rem; color: #555; }
        .points-input { width: 80px; padding: 5px 8px; border: 1px solid #ddd; border-radius: 8px; text-align: right; font-weight: bold; color: #e65100; font-size: 1rem; outline: none; }
        .points-input:focus { border-color: var(--primary); }

        .info-row { display: flex; justify-content: space-between; margin-bottom: 8px; font-size: 0.95rem; }
        .row-label { color: #666; }
        .row-val { font-weight: 600; }
        .val-fee { color: var(--error); }
        .val-points { color: var(--success); background: #e8f5e9; padding: 2px 8px; border-radius: 6px; font-size: 0.85rem; }
        
        /* Dòng tiền thực chuyển */
        .real-send-row { 
            display: none; /* Ẩn mặc định */
            justify-content: space-between; 
            align-items: center;
            margin-bottom: 12px; 
            color: #0277bd; 
            font-weight: 600; 
            font-size: 0.95rem; 
            padding: 8px 12px; 
            background: #e1f5fe; 
            border-radius: 12px; 
        }
        .real-send-val { font-size: 1.2rem; font-weight: 800; }

        /* Tổng thanh toán */
        .total-row { display: flex; justify-content: space-between; align-items: center; margin-top: 15px; padding-top: 15px; border-top: 2px solid #e0e0e0; }
        .total-label { font-weight: 700; color: #333; font-size: 1rem; display: block; }
        .total-amount { font-size: 1.8rem; font-weight: 800; color: var(--primary-hover); letter-spacing: -1px; line-height: 1; }

        /* Wrapper cho nhóm nút bên phải (Số tiền + Nút copy) */
        .right-group { display: flex; align-items: center; gap: 10px; }

        /* NÚT COPY */
        .btn-copy {
            background: #fff; border: 1px solid #ddd; border-radius: 12px; width: 48px; height: 48px;
            display: flex; justify-content: center; align-items: center; cursor: pointer; transition: 0.2s; color: #555;
            position: relative;
        }
        .btn-copy:hover { background: var(--primary); border-color: var(--primary); color: #000; transform: translateY(-2px); }
        
        /* Copy size nhỏ cho dòng phụ */
        .btn-copy.mini { width: 36px; height: 36px; border-radius: 10px; }
        .btn-copy.mini svg { width: 18px; height: 18px; }

        .copy-tooltip {
            position: absolute; top: -35px; right: 0; background: #333; color: #fff;
            padding: 4px 10px; border-radius: 6px; font-size: 0.75rem; white-space: nowrap;
            opacity: 0; transform: translateY(10px); transition: all 0.2s; pointer-events: none; z-index: 10;
        }
        .copy-tooltip.show { opacity: 1; transform: translateY(0); }

        /* BUTTON REFRESH */
        .btn-refresh {
            width: 100%; padding: 16px; border: none; border-radius: 16px;
            background: var(--primary); color: #222; font-size: 1rem; font-weight: 700;
            cursor: pointer; transition: transform 0.1s, box-shadow 0.2s;
            display: flex; justify-content: center; align-items: center; gap: 10px;
            box-shadow: 0 5px 15px rgba(255, 183, 0, 0.3);
        }
        .btn-refresh:hover { background: var(--primary-hover); transform: translateY(-2px); }
        .btn-refresh:active { transform: scale(0.98); }

        /* SPINNER */
        .spinner {
            width: 16px; height: 16px; border: 3px solid rgba(0,0,0,0.1);
            border-top-color: #000; border-radius: 50%; animation: spin 0.8s linear infinite; display: none;
        }
        .btn-refresh.loading .spinner { display: block; }
        .btn-refresh.loading span { display: none; }
        @keyframes spin { to { transform: rotate(360deg); } }

    </style>
</head>
<body>

    <div class="bg-blobs">
        <div class="blob blob-1"></div>
        <div class="blob blob-2"></div>
    </div>

    <div class="card">
        <h2>Smiles Remit Pro</h2>
        
        <div class="status-bar">
            <div id="rateDisplay" class="rate-display">Đang tải tỷ giá...</div>
            <div id="lastUpdatedTime" class="time-display"></div>
        </div>

        <div class="toggle-wrapper">
            <div>
                <div class="toggle-text" id="modeLabel">Chế độ Thường (Cộng phí)</div>
                <span class="toggle-sub" id="modeSub">Nhập số tiền muốn gửi đi</span>
            </div>
            <label class="switch">
                <input type="checkbox" id="modeToggle" onchange="toggleMode()">
                <span class="slider"></span>
            </label>
        </div>

        <div class="input-container" id="containerJPY">
            <div class="input-wrapper">
                <label class="input-label" id="labelJPY">Bạn gửi đi (Tiền gốc)</label>
                <input type="text" id="inputJPY" class="input-field" placeholder="50,000" oninput="formatNumberInput(this)">
            </div>
            <span class="currency">JPY</span>
        </div>

        <div class="input-container">
            <div class="input-wrapper">
                <label class="input-label">Người nhận được</label>
                <input type="text" id="inputVND" class="input-field" placeholder="0" oninput="formatNumberInput(this)">
            </div>
            <span class="currency">VND</span>
        </div>

        <div class="result-box">
            
            <div class="points-input-row">
                <span class="points-label">Sử dụng điểm (-):</span>
                <div style="display:flex; align-items:center;">
                    <input type="text" id="inputPoints" class="points-input" placeholder="0" oninput="formatNumberInput(this)">
                    <span style="font-size: 0.8rem; color: #999; margin-left: 5px;">pts</span>
                </div>
            </div>

            <div id="rowRealSend" class="real-send-row">
                <span>Gửi thực tế:</span>
                <div class="right-group">
                    <span id="realSendDisplay" class="real-send-val">0 ¥</span>
                    <button class="btn-copy mini" onclick="copyContent('realSendDisplay', 'tooltipReal')" title="Sao chép">
                        <div class="copy-tooltip" id="tooltipReal">Đã sao chép!</div>
                        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path></svg>
                    </button>
                </div>
            </div>

            <div class="info-row">
                <span class="row-label">Phí chuyển tiền (+):</span>
                <span class="row-val val-fee" id="feeDisplay">0 ¥</span>
            </div>
            <div class="info-row">
                <span class="row-label">Điểm thưởng nhận được:</span>
                <span class="row-val val-points" id="pointDisplay">+0 pts</span>
            </div>

            <div class="total-row">
                <span class="total-label" id="labelTotal">Tổng thanh toán</span>
                <div class="right-group">
                    <div class="total-amount" id="totalPayDisplay">0 ¥</div>
                    <button class="btn-copy" onclick="copyContent('totalPayDisplay', 'tooltipTotal')" title="Sao chép">
                        <div class="copy-tooltip" id="tooltipTotal">Đã sao chép!</div>
                        <svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path></svg>
                    </button>
                </div>
            </div>
        </div>

        <button class="btn-refresh" id="btnRefresh" onclick="forceUpdateRate()">
            <div class="spinner"></div>
            <span>Cập nhật Tỷ giá Mới nhất</span>
        </button>
    </div>

<script>
    const SCRAPINGBEE_KEYS = ["YFH8ZPMDE27ABK3HAVVALLVZLVAF4PNMDYE12GSH2ILVSQ5AVLTGMTUZCDNG2SAGCII7PKXLZWJI7GD7"];
    const LOCAL_KEY = 'smiles_rate_data';
    let currentRate = 0;
    let isReverseMode = false;

    function saveRate(rate) {
        const timeStr = new Date().toLocaleString('vi-VN', { hour: '2-digit', minute: '2-digit', day: '2-digit', month: '2-digit' });
        localStorage.setItem(LOCAL_KEY, JSON.stringify({ rate: rate, time: timeStr }));
    }

    function getRate() {
        const data = localStorage.getItem(LOCAL_KEY);
        return data ? JSON.parse(data) : null;
    }

    function formatNumber(num) { return num.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ","); }
    
    function getRawValue(id) { 
        const val = document.getElementById(id).value.replace(/,/g, '');
        return val ? parseInt(val) : 0; 
    }

    function formatNumberInput(input) {
        let value = input.value.replace(/,/g, '');
        if (!value) { 
            input.value = ''; 
            calculate(input.id === 'inputPoints' ? 'inputJPY' : input.id); 
            return; 
        }
        input.value = parseInt(value).toLocaleString('en-US');
        calculate(input.id === 'inputPoints' ? 'inputJPY' : input.id);
    }

    function toggleMode() {
        const toggle = document.getElementById('modeToggle');
        isReverseMode = toggle.checked;
        
        const lblMode = document.getElementById('modeLabel');
        const lblSub = document.getElementById('modeSub');
        const lblJPY = document.getElementById('labelJPY');
        const containerJPY = document.getElementById('containerJPY');
        const rowReal = document.getElementById('rowRealSend');
        const lblTotal = document.getElementById('labelTotal');

        if (isReverseMode) {
            lblMode.innerText = "Chế độ: Đã bao gồm phí";
            lblMode.style.color = "var(--success)";
            lblSub.innerText = "Bạn có tổng bao nhiêu tiền?";
            
            lblJPY.innerText = "Tổng tiền bạn có (JPY)";
            lblJPY.style.color = "var(--success)";
            containerJPY.classList.add('highlight');
            
            rowReal.style.display = 'flex'; // Hiện dòng tiền thực
            lblTotal.innerText = "Tổng thanh toán (Bằng số tiền nhập)";
        } else {
            lblMode.innerText = "Chế độ: Thường (Cộng thêm phí)";
            lblMode.style.color = "#555";
            lblSub.innerText = "Nhập số tiền muốn gửi đi";

            lblJPY.innerText = "Bạn gửi đi (Tiền gốc)";
            lblJPY.style.color = "#888";
            containerJPY.classList.remove('highlight');

            rowReal.style.display = 'none'; // Ẩn dòng tiền thực
            lblTotal.innerText = "Tổng thanh toán (Gốc + Phí - Điểm)";
        }
        calculate('inputJPY');
    }

    function getFee(amount) {
        if (amount <= 0) return 0;
        if (amount <= 10000) return 380;
        if (amount <= 50000) return 450;
        if (amount <= 100000) return 760;
        if (amount <= 300000) return 980;
        if (amount <= 1000000) return 1700;
        return 0;
    }

    function getPoints(amount) {
        if (amount <= 0) return 0;
        if (amount <= 10000) return 10;
        if (amount <= 50000) return 20;
        if (amount <= 100000) return 50;
        if (amount <= 300000) return 100;
        return 150;
    }

    function calculate(source) {
        if (currentRate === 0) return;

        const elJPY = document.getElementById('inputJPY');
        const elVND = document.getElementById('inputVND');
        
        let valJPY = getRawValue('inputJPY'); 
        let valPoints = getRawValue('inputPoints');
        
        let realSend = 0;
        let fee = 0;
        let totalPay = 0;

        if (isReverseMode) {
            if (source === 'inputVND') {
                let vndVal = getRawValue('inputVND');
                realSend = Math.ceil(vndVal / currentRate);
                fee = getFee(realSend);
                totalPay = realSend + fee - valPoints;
                if (totalPay < 0) totalPay = 0;
                elJPY.value = formatNumber(totalPay);
            } else {
                let budget = valJPY + valPoints;
                let tempFee = 0;
                if (budget >= 301700) tempFee = 1700;
                else if (budget >= 100980) tempFee = 980;
                else if (budget >= 50760) tempFee = 760;
                else if (budget >= 10450) tempFee = 450;
                else if (budget >= 680) tempFee = 380;
                else tempFee = 0;

                realSend = budget - tempFee;
                let exactFee = getFee(realSend);
                if (exactFee !== tempFee) {
                    realSend = budget - exactFee;
                }
                if (realSend < 0) realSend = 0;

                if (source !== 'inputVND') elVND.value = formatNumber(Math.floor(realSend * currentRate));
                fee = getFee(realSend);
                totalPay = valJPY; 
            }
        } else {
            if (source === 'inputVND') {
                let vndVal = getRawValue('inputVND');
                valJPY = Math.ceil(vndVal / currentRate);
                elJPY.value = formatNumber(valJPY);
            }
            realSend = valJPY; 
            if (source !== 'inputVND') elVND.value = formatNumber(Math.floor(realSend * currentRate));
            fee = getFee(realSend);
            totalPay = realSend + fee - valPoints;
            if (totalPay < 0) totalPay = 0;
        }

        document.getElementById('feeDisplay').innerText = `¥${formatNumber(fee)}`;
        document.getElementById('pointDisplay').innerText = `+${getPoints(realSend)} pts`;
        document.getElementById('realSendDisplay').innerText = `¥${formatNumber(realSend)}`;
        document.getElementById('totalPayDisplay').innerText = `¥${formatNumber(totalPay)}`;
    }

    /* --- HÀM COPY CHUNG --- */
    async function copyContent(elementId, tooltipId) {
        const text = document.getElementById(elementId).innerText;
        const raw = text.replace(/[^\d]/g, ''); // Chỉ lấy số
        
        try {
            await navigator.clipboard.writeText(raw);
            const tooltip = document.getElementById(tooltipId);
            tooltip.classList.add('show');
            setTimeout(() => tooltip.classList.remove('show'), 1500);
        } catch (err) {
            console.error('Lỗi copy', err);
        }
    }

    function updateStatus(rate, timeStr) {
        const elRate = document.getElementById('rateDisplay');
        const elTime = document.getElementById('lastUpdatedTime');
        currentRate = rate;
        elRate.innerText = `1 JPY = ${rate} VND`;
        elRate.style.color = "var(--success)";
        if (timeStr) {
            elTime.innerText = `Cập nhật lúc: ${timeStr}`;
            elTime.style.display = 'block';
        }
        calculate('inputJPY');
    }

    async function forceUpdateRate() {
        const btn = document.getElementById('btnRefresh');
        const elRate = document.getElementById('rateDisplay');
        btn.classList.add('loading');
        elRate.innerText = "Đang kết nối Smiles...";
        elRate.style.color = "#e65100";

        const targetUrl = 'https://www.smileswallet.com/japan/vi/ty-gia/';
        const rules = { "currencies": { "selector": ".currency", "type": "list", "output": { "country": ".country_name", "rate": ".exchange_rate" } } };
        
        let newRate = 0;
        for (let key of SCRAPINGBEE_KEYS) {
            if (!key) continue;
            try {
                const url = `https://app.scrapingbee.com/api/v1/?api_key=${key}&url=${encodeURIComponent(targetUrl)}&extract_rules=${encodeURIComponent(JSON.stringify(rules))}&render_js=false`;
                const res = await fetch(url);
                if (res.ok) {
                    const data = await res.json();
                    const vnData = data.currencies?.find(c => c.country.includes("Vietnam") || c.country.includes("Việt Nam"));
                    if (vnData) {
                        const match = vnData.rate.match(/([\d,.]+)/);
                        if (match) { newRate = parseFloat(match[0].replace(/,/g, '')); break; }
                    }
                }
            } catch (e) { console.warn("API Error", e); }
        }

        btn.classList.remove('loading');
        if (newRate > 0) {
            saveRate(newRate);
            updateStatus(newRate, new Date().toLocaleString('vi-VN', { hour: '2-digit', minute: '2-digit', day: '2-digit', month: '2-digit' }));
        } else {
            elRate.innerText = "⚠️ Lỗi cập nhật. Dùng tỷ giá cũ.";
            elRate.style.color = "var(--error)";
            if(currentRate === 0) currentRate = 165.5; 
            calculate('inputJPY');
        }
    }

    (function init() {
        const cache = getRate();
        if (cache && cache.rate) updateStatus(cache.rate, cache.time);
        else forceUpdateRate();
    })();

</script>
</body>
</html>