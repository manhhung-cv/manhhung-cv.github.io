<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Trình Rút Gọn Link</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://kit.fontawesome.com/a076d05399.js" crossorigin="anonymous"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        .hidden {
            display: none;
        }
        /* Custom styles for loader and transitions */
        .loader {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #3498db;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="bg-gray-900 text-white flex items-center justify-center min-h-screen">

    <div class="w-full max-w-2xl mx-auto p-4 md:p-6">

        <!-- Main View: Shortener Form -->
        <div id="mainView">
            <div class="bg-gray-800 p-8 rounded-2xl shadow-2xl w-full">
                <div class="flex justify-between items-center mb-6">
                    <h1 class="text-3xl font-bold text-cyan-400">Rút Gọn Link</h1>
                    <div id="authContainer">
                        <!-- Nút đăng nhập/đăng xuất sẽ được thêm vào đây bằng JS -->
                    </div>
                </div>

                <p id="welcomeMessage" class="text-gray-400 mb-6">Dán link dài của bạn vào đây để rút gọn. Đăng nhập để có nhiều tùy chọn hơn!</p>
                
                <form id="shortenForm" class="space-y-4">
                    <div>
                        <label for="longUrl" class="block text-sm font-medium text-gray-300 mb-1">Link cần rút gọn</label>
                        <input type="url" id="longUrl" name="longUrl" placeholder="https://example.com/sieu-dai-va-phuc-tap" required
                               class="w-full bg-gray-700 border border-gray-600 text-white rounded-lg p-3 focus:ring-2 focus:ring-cyan-500 focus:border-cyan-500 transition">
                    </div>

                    <!-- Advanced Options - For logged in users -->
                    <div id="advancedOptions" class="hidden space-y-4 pt-4 border-t border-gray-700">
                        <div>
                            <label for="customAlias" class="block text-sm font-medium text-gray-300 mb-1">Tên tùy chỉnh (ví dụ: ABC123)</label>
                            <input type="text" id="customAlias" name="customAlias" placeholder="Để trống để tạo ngẫu nhiên"
                                   class="w-full bg-gray-700 border border-gray-600 text-white rounded-lg p-3 focus:ring-2 focus:ring-cyan-500 focus:border-cyan-500 transition">
                        </div>
                        <div>
                            <label for="title" class="block text-sm font-medium text-gray-300 mb-1">Tiêu đề trang chờ</label>
                            <input type="text" id="title" name="title" placeholder="Tiêu đề sẽ hiển thị khi chờ"
                                   class="w-full bg-gray-700 border border-gray-600 text-white rounded-lg p-3 focus:ring-2 focus:ring-cyan-500 focus:border-cyan-500 transition">
                        </div>
                         <div>
                            <label for="countdown" class="block text-sm font-medium text-gray-300 mb-1">Thời gian chờ (giây)</label>
                            <input type="number" id="countdown" name="countdown" min="0" max="60" value="5"
                                   class="w-full bg-gray-700 border border-gray-600 text-white rounded-lg p-3 focus:ring-2 focus:ring-cyan-500 focus:border-cyan-500 transition">
                        </div>
                        <div class="flex items-center justify-between">
                            <span class="text-sm font-medium text-gray-300">Hiện quảng cáo</span>
                            <label for="adsToggle" class="inline-flex relative items-center cursor-pointer">
                                <input type="checkbox" id="adsToggle" class="sr-only peer" checked>
                                <div class="w-11 h-6 bg-gray-600 rounded-full peer peer-focus:ring-4 peer-focus:ring-cyan-800 peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-0.5 after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-cyan-600"></div>
                            </label>
                        </div>
                    </div>

                    <button type="submit" id="submitButton"
                            class="w-full bg-cyan-600 hover:bg-cyan-700 text-white font-bold py-3 px-4 rounded-lg transition-all duration-300 shadow-lg focus:outline-none focus:ring-4 focus:ring-cyan-500/50">
                        Rút Gọn Link
                    </button>
                </form>

                <div id="result" class="mt-6 hidden">
                    <p class="text-gray-300">Link đã rút gọn của bạn:</p>
                    <div class="mt-2 flex items-center bg-gray-700 rounded-lg p-3">
                        <input id="shortUrl" type="text" readonly class="flex-grow bg-transparent text-cyan-400 outline-none">
                        <button id="copyButton" class="ml-4 text-gray-400 hover:text-white" title="Sao chép">
                            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z"></path></svg>
                        </button>
                    </div>
                </div>

                <!-- User's Links -->
                <div id="userLinksContainer" class="mt-8 hidden">
                    <h2 class="text-xl font-bold text-gray-200 mb-4">Các link đã tạo của bạn</h2>
                    <div id="userLinks" class="space-y-3 max-h-60 overflow-y-auto pr-2">
                        <!-- Links sẽ được hiển thị ở đây -->
                    </div>
                </div>

            </div>
        </div>

        <!-- Redirect View -->
        <div id="redirectView" class="hidden text-center">
            <div class="bg-gray-800 p-8 rounded-2xl shadow-2xl w-full">
                <h2 id="redirectTitle" class="text-2xl md:text-3xl font-bold text-cyan-400 mb-4">Đang chuyển hướng...</h2>
                <div id="adPlaceholder" class="my-6 w-full h-48 bg-gray-700 rounded-lg flex items-center justify-center">
                    <p class="text-gray-500">Khu vực quảng cáo</p>
                </div>
                <p id="countdownMessage" class="text-lg text-gray-300">
                    Bạn sẽ được chuyển hướng trong <span id="countdownTimer" class="font-bold text-2xl text-cyan-400">5</span> giây.
                </p>
                <a id="redirectLink" href="#" class="mt-6 inline-block bg-gray-600 text-white font-bold py-3 px-6 rounded-lg transition-colors cursor-not-allowed opacity-50">
                    Bỏ qua
                </a>
            </div>
        </div>

        <!-- Loading View -->
        <div id="loadingView" class="hidden text-center">
             <div class="loader"></div>
             <p class="mt-4 text-lg">Đang tải dữ liệu link...</p>
        </div>

        <!-- Error View -->
        <div id="errorView" class="hidden text-center">
            <div class="bg-red-900/50 border border-red-500 p-8 rounded-2xl shadow-2xl w-full">
                <h2 class="text-3xl font-bold text-red-400 mb-4">Lỗi!</h2>
                <p id="errorMessage" class="text-lg text-red-300">Không tìm thấy link này hoặc link đã bị xóa.</p>
                <a href="#" class="mt-6 inline-block bg-cyan-600 hover:bg-cyan-700 text-white font-bold py-3 px-6 rounded-lg transition-colors">
                    Trở về trang chủ
                </a>
            </div>
        </div>
    </div>

    <!-- Firebase SDK -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, GoogleAuthProvider, signInWithPopup, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, setDoc, collection, query, where, onSnapshot } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        
        // --- CẤU HÌNH FIREBASE ---
        // Biến này sẽ được cung cấp bởi môi trường chạy.
        // Đảm bảo bạn đã thiết lập dự án Firebase và bật Authentication (Google) và Firestore.
        const firebaseConfig = typeof __firebase_config !== 'undefined' 
            ? JSON.parse(__firebase_config)
            : {
                apiKey: "YOUR_API_KEY",
                authDomain: "YOUR_AUTH_DOMAIN",
                projectId: "YOUR_PROJECT_ID",
                storageBucket: "YOUR_STORAGE_BUCKET",
                messagingSenderId: "YOUR_MESSAGING_SENDER_ID",
                appId: "YOUR_APP_ID"
            };

        // Khởi tạo Firebase
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // --- DOM Elements ---
        const mainView = document.getElementById('mainView');
        const redirectView = document.getElementById('redirectView');
        const loadingView = document.getElementById('loadingView');
        const errorView = document.getElementById('errorView');
        const shortenForm = document.getElementById('shortenForm');
        const resultDiv = document.getElementById('result');
        const shortUrlInput = document.getElementById('shortUrl');
        const copyButton = document.getElementById('copyButton');
        const advancedOptions = document.getElementById('advancedOptions');
        const authContainer = document.getElementById('authContainer');
        const welcomeMessage = document.getElementById('welcomeMessage');
        const userLinksContainer = document.getElementById('userLinksContainer');
        const userLinksDiv = document.getElementById('userLinks');

        let currentUser = null;
        let unsubscribeUserLinks = null;

        // --- LOGIC XỬ LÝ ---

        // 1. Logic định tuyến (Routing)
        function handleRouting() {
            const hash = window.location.hash.substring(1);
            if (hash) {
                mainView.classList.add('hidden');
                lookupAndRedirect(hash);
            } else {
                mainView.classList.remove('hidden');
                redirectView.classList.add('hidden');
                loadingView.classList.add('hidden');
                errorView.classList.add('hidden');
            }
        }
        
        // 2. Tìm link trong Firestore và chuyển hướng
        async function lookupAndRedirect(shortId) {
            loadingView.classList.remove('hidden');
            const linkDocRef = doc(db, 'links', shortId);
            try {
                const docSnap = await getDoc(linkDocRef);
                if (docSnap.exists()) {
                    const data = docSnap.data();
                    loadingView.classList.add('hidden');
                    
                    if (data.adsEnabled && data.countdown > 0) {
                        // Hiển thị trang chờ
                        redirectView.classList.remove('hidden');
                        document.getElementById('redirectTitle').textContent = data.title || 'Đang chuyển hướng...';
                        const countdownTimer = document.getElementById('countdownTimer');
                        const redirectLink = document.getElementById('redirectLink');
                        let timeLeft = data.countdown;
                        countdownTimer.textContent = timeLeft;

                        const interval = setInterval(() => {
                            timeLeft--;
                            countdownTimer.textContent = timeLeft;
                            if (timeLeft <= 0) {
                                clearInterval(interval);
                                window.location.href = data.longUrl;
                            }
                        }, 1000);

                        setTimeout(() => {
                           redirectLink.href = data.longUrl;
                           redirectLink.classList.remove('cursor-not-allowed', 'opacity-50');
                           redirectLink.textContent = "Đi đến link";
                        }, timeLeft * 1000);

                    } else {
                        // Chuyển hướng ngay lập tức
                        window.location.href = data.longUrl;
                    }
                } else {
                    showError("Không tìm thấy link này.");
                }
            } catch (error) {
                console.error("Lỗi khi tìm link:", error);
                showError("Đã xảy ra lỗi khi truy xuất dữ liệu.");
            }
        }

        function showError(message) {
            loadingView.classList.add('hidden');
            mainView.classList.add('hidden');
            redirectView.classList.add('hidden');
            errorView.classList.remove('hidden');
            document.getElementById('errorMessage').textContent = message;
        }

        // 3. Logic xác thực người dùng (Authentication)
        onAuthStateChanged(auth, user => {
            currentUser = user;
            updateUIForAuthState();
        });

        function updateUIForAuthState() {
            if (currentUser) {
                // Đã đăng nhập
                authContainer.innerHTML = `<button id="logoutButton" class="bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-4 rounded-lg transition">Đăng xuất</button>`;
                document.getElementById('logoutButton').addEventListener('click', () => signOut(auth));
                advancedOptions.classList.remove('hidden');
                welcomeMessage.textContent = `Chào mừng, ${currentUser.displayName}! Giờ bạn có thể tùy chỉnh link của mình.`;
                userLinksContainer.classList.remove('hidden');
                fetchUserLinks();

            } else {
                // Chưa đăng nhập
                authContainer.innerHTML = `<button id="loginButton" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg transition">Đăng nhập với Google</button>`;
                document.getElementById('loginButton').addEventListener('click', () => {
                    const provider = new GoogleAuthProvider();
                    signInWithPopup(auth, provider);
                });
                advancedOptions.classList.add('hidden');
                welcomeMessage.textContent = 'Dán link dài của bạn vào đây để rút gọn. Đăng nhập để có nhiều tùy chọn hơn!';
                userLinksContainer.classList.add('hidden');
                if(unsubscribeUserLinks) unsubscribeUserLinks();
                userLinksDiv.innerHTML = '';
            }
        }

        // 4. Lấy danh sách link của người dùng
        function fetchUserLinks() {
            if (!currentUser) return;
            if (unsubscribeUserLinks) unsubscribeUserLinks(); // Hủy đăng ký listener cũ

            const q = query(collection(db, "links"), where("creatorUid", "==", currentUser.uid));
            unsubscribeUserLinks = onSnapshot(q, (querySnapshot) => {
                userLinksDiv.innerHTML = ''; // Xóa danh sách cũ
                if(querySnapshot.empty) {
                    userLinksDiv.innerHTML = '<p class="text-gray-500">Bạn chưa tạo link nào.</p>';
                    return;
                }
                querySnapshot.forEach((doc) => {
                    const link = doc.data();
                    const shortUrl = `${window.location.origin}${window.location.pathname}#${doc.id}`;
                    const linkEl = document.createElement('div');
                    linkEl.className = 'bg-gray-700 p-3 rounded-lg flex items-center justify-between';
                    linkEl.innerHTML = `
                        <div>
                            <a href="${shortUrl}" target="_blank" class="text-cyan-400 font-semibold">${shortUrl}</a>
                            <p class="text-sm text-gray-400 truncate">${link.longUrl}</p>
                        </div>
                        <button class="copy-user-link text-gray-400 hover:text-white" data-url="${shortUrl}" title="Sao chép">
                             <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z"></path></svg>
                        </button>
                    `;
                    userLinksDiv.appendChild(linkEl);
                });
            });
        }


        // 5. Logic Form rút gọn link
        shortenForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const submitButton = document.getElementById('submitButton');
            submitButton.disabled = true;
            submitButton.textContent = 'Đang xử lý...';

            const longUrl = e.target.longUrl.value;
            let shortId = e.target.customAlias.value.trim();

            if (shortId) {
                // Kiểm tra xem custom alias đã tồn tại chưa
                const docRef = doc(db, 'links', shortId);
                const docSnap = await getDoc(docRef);
                if(docSnap.exists()) {
                    alert('Tên tùy chỉnh này đã tồn tại. Vui lòng chọn tên khác.');
                    submitButton.disabled = false;
                    submitButton.textContent = 'Rút Gọn Link';
                    return;
                }
            } else {
                shortId = generateRandomId(6);
            }

            const linkData = {
                longUrl,
                creatorUid: currentUser ? currentUser.uid : 'anonymous',
                createdAt: new Date(),
                // Lấy các giá trị nâng cao nếu đã đăng nhập
                title: currentUser ? e.target.title.value : '',
                countdown: currentUser ? parseInt(e.target.countdown.value, 10) : 5,
                adsEnabled: currentUser ? e.target.adsToggle.checked : true,
            };

            try {
                await setDoc(doc(db, 'links', shortId), linkData);
                const newShortUrl = `${window.location.origin}${window.location.pathname}#${shortId}`;
                shortUrlInput.value = newShortUrl;
                resultDiv.classList.remove('hidden');
                shortenForm.reset();
            } catch (error) {
                console.error("Lỗi khi tạo link:", error);
                alert("Đã xảy ra lỗi. Vui lòng thử lại.");
            } finally {
                submitButton.disabled = false;
                submitButton.textContent = 'Rút Gọn Link';
            }
        });

        // 6. Logic nút sao chép
        copyButton.addEventListener('click', () => {
            shortUrlInput.select();
            document.execCommand('copy');
            copyButton.innerHTML = `<svg class="w-6 h-6 text-green-400" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path></svg>`;
            setTimeout(() => {
                copyButton.innerHTML = `<svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z"></path></svg>`;
            }, 2000);
        });

        // Sao chép link từ danh sách của người dùng
        userLinksDiv.addEventListener('click', (e) => {
            const button = e.target.closest('.copy-user-link');
            if (button) {
                const urlToCopy = button.dataset.url;
                navigator.clipboard.writeText(urlToCopy).then(() => {
                    button.innerHTML = `<svg class="w-5 h-5 text-green-400" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path></svg>`;
                    setTimeout(() => {
                        button.innerHTML = `<svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z"></path></svg>`;
                    }, 2000);
                });
            }
        });


        // 7. Hàm phụ trợ
        function generateRandomId(length) {
            const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789';
            let result = '';
            for (let i = 0; i < length; i++) {
                result += chars.charAt(Math.floor(Math.random() * chars.length));
            }
            return result;
        }

        // --- Khởi chạy ---
        window.addEventListener('hashchange', handleRouting);
        window.addEventListener('load', handleRouting);

    </script>
</body>
</html>
