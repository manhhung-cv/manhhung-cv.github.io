<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Hunq ShortLink - LiquidGlass OS</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        /* --- LiquidGlass Core Styles --- */
        :root {
            --glass-border: rgba(255, 255, 255, 0.2);
            --glass-bg: rgba(255, 255, 255, 0.65);
            --glass-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.15);
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            background-color: #0f172a;
            margin: 0;
            overflow-x: hidden;
            color: #1e293b;
            min-height: 100vh;
        }

        /* Animated Mesh Gradient Background */
        .liquid-bg {
            position: fixed;
            top: 0; left: 0; width: 100vw; height: 100vh;
            z-index: -1;
            background: 
                radial-gradient(at 0% 0%, rgba(99, 102, 241, 0.4) 0px, transparent 50%),
                radial-gradient(at 100% 0%, rgba(168, 85, 247, 0.4) 0px, transparent 50%),
                radial-gradient(at 100% 100%, rgba(236, 72, 153, 0.4) 0px, transparent 50%),
                radial-gradient(at 0% 100%, rgba(34, 211, 238, 0.4) 0px, transparent 50%);
            filter: blur(60px);
            animation: fluidMove 20s infinite alternate;
            background-size: 150% 150%;
        }

        @keyframes fluidMove {
            0% { background-position: 0% 0%; }
            100% { background-position: 100% 100%; }
        }

        /* Glassmorphism Components */
        .glass-card {
            background: var(--glass-bg);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border: 1px solid var(--glass-border);
            box-shadow: var(--glass-shadow);
            border-radius: 24px;
        }

        .glass-input {
            background: rgba(255, 255, 255, 0.5);
            border: 1px solid rgba(255, 255, 255, 0.6);
            border-radius: 16px;
            transition: all 0.3s ease;
            box-shadow: inset 0 2px 4px rgba(0,0,0,0.02);
        }
        .glass-input:focus {
            outline: none;
            background: rgba(255, 255, 255, 0.9);
            box-shadow: 0 0 0 4px rgba(99, 102, 241, 0.2);
            border-color: #6366f1;
        }

        /* Buttons (iOS Style) */
        .ios-btn {
            border-radius: 100px;
            font-weight: 600;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            overflow: hidden;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
        }
        .ios-btn:active { transform: scale(0.96); }
        
        .btn-primary {
            background: linear-gradient(135deg, #6366f1, #8b5cf6);
            color: white;
            box-shadow: 0 4px 15px rgba(99, 102, 241, 0.3);
            border: 1px solid rgba(255,255,255,0.2);
        }
        .btn-primary:hover {
            box-shadow: 0 8px 25px rgba(99, 102, 241, 0.4);
            filter: brightness(1.1);
        }

        .btn-secondary {
            background: rgba(255, 255, 255, 0.8);
            color: #334155;
            border: 1px solid rgba(255,255,255,0.5);
        }
        .btn-secondary:hover { background: rgba(255, 255, 255, 1); }

        .btn-danger {
            background: linear-gradient(135deg, #ef4444, #f43f5e);
            color: white;
            box-shadow: 0 4px 15px rgba(239, 68, 68, 0.3);
        }

        /* Tables */
        .glass-table thead {
            background: rgba(241, 245, 249, 0.6);
            color: #475569;
            font-size: 0.75rem;
            letter-spacing: 0.05em;
        }
        .glass-table tbody tr {
            border-bottom: 1px solid rgba(0,0,0,0.05);
            transition: background 0.2s;
        }
        .glass-table tbody tr:hover { background: rgba(255,255,255,0.4); }

        /* Toggle Switch */
        .toggle-checkbox:checked { right: 0; border-color: #6366f1; }
        .toggle-checkbox:checked + .toggle-label { background-color: #6366f1; }
        .toggle-label {
            width: 40px; height: 22px;
            background-color: #cbd5e1;
            border-radius: 99px;
            position: relative;
            cursor: pointer;
            transition: 0.3s;
        }
        .toggle-label:after {
            content: ''; position: absolute; top: 2px; left: 2px;
            width: 18px; height: 18px; background: #fff;
            border-radius: 50%; transition: 0.3s;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }
        .toggle-checkbox:checked + .toggle-label:after { transform: translateX(18px); }

        /* Animations */
        .fade-in-up {
            animation: fadeInUp 0.6s cubic-bezier(0.16, 1, 0.3, 1) forwards;
            opacity: 0; transform: translateY(20px);
        }
        @keyframes fadeInUp { to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body class="antialiased text-slate-800">

    <div class="liquid-bg"></div>

    <div id="app-container" class="min-h-screen flex flex-col items-center p-4 sm:p-6 max-w-7xl mx-auto">

        <header class="w-full flex justify-between items-center py-3 px-6 mb-8 glass-card sticky top-4 z-50">
            <div class="flex items-center gap-3 cursor-pointer" onclick="window.location.href = window.location.pathname">
                <div class="w-10 h-10 rounded-xl bg-gradient-to-br from-blue-500 to-purple-600 flex items-center justify-center text-white shadow-lg">
                    <i class="fas fa-bolt text-lg"></i>
                </div>
                <h1 class="text-xl font-bold bg-clip-text text-transparent bg-gradient-to-r from-blue-600 to-purple-600 hidden sm:block">Hunq ShortLink</h1>
            </div>
            
            <div id="auth-container">
                <button id="login-btn" class="ios-btn btn-primary py-2 px-5 text-sm">
                    <i class="fas fa-right-to-bracket mr-2"></i>ƒêƒÉng nh·∫≠p
                </button>
                
                <div id="user-info" class="hidden items-center gap-3">
                    <div class="flex items-center gap-2 px-3 py-1.5 rounded-full bg-white/50 border border-white/60 backdrop-blur-sm">
                        <img id="user-avatar" class="w-8 h-8 rounded-full border border-white shadow-sm" src="" alt="Avatar">
                        <span id="user-name" class="font-medium text-sm text-slate-700 truncate max-w-[80px] sm:max-w-xs"></span>
                    </div>
                    <button id="logout-btn" class="ios-btn btn-secondary w-10 h-10 !p-0 rounded-full text-red-500 hover:bg-red-50" title="ƒêƒÉng xu·∫•t">
                        <i class="fas fa-power-off"></i>
                    </button>
                </div>
            </div>
        </header>
        
        <div id="loading-view" class="w-full max-w-6xl text-center fade-in-up mt-20">
             <div class="glass-card p-10 flex flex-col items-center justify-center">
                <div class="w-10 h-10 border-4 border-blue-200 border-t-blue-600 rounded-full animate-spin mb-4"></div>
                <p class="text-slate-500 font-medium">ƒêang kh·ªüi ƒë·ªông...</p>
            </div>
        </div>

        <main class="w-full flex-grow flex flex-col items-center justify-start relative z-10 gap-8">
            
            <div id="shortener-view" class="w-full max-w-6xl text-center fade-in-up hidden">
                <div class="glass-card p-8 sm:p-12 relative overflow-hidden">
                    <div class="absolute top-0 left-1/2 -translate-x-1/2 w-2/3 h-32 bg-blue-400/20 blur-3xl rounded-full -z-10"></div>

                    <h2 class="text-4xl sm:text-5xl font-bold text-slate-800 mb-3 tracking-tight">R√∫t g·ªçn li√™n k·∫øt.</h2>
                    <p class="text-slate-500 mb-8 text-lg">N·ªÅn t·∫£ng qu·∫£n l√Ω link th√¥ng minh & an to√†n.</p>
                    
                    <form id="shorten-form" class="space-y-4 max-w-xl mx-auto">
                        <div class="relative group">
                            <div class="absolute inset-y-0 left-0 pl-4 flex items-center pointer-events-none text-slate-400">
                                <i class="fas fa-link"></i>
                            </div>
                            <input type="text" id="original-url" placeholder="D√°n li√™n k·∫øt d√†i t·∫°i ƒë√¢y (https://...)" class="glass-input w-full pl-12 pr-4 py-4 text-lg text-slate-700 placeholder:text-slate-400" required>
                        </div>
                        
                        <div id="logged-in-options" class="hidden text-left animate-fade-in">
                            <label class="block ml-2 mb-2 text-xs font-bold uppercase text-slate-500 tracking-wider">T√πy ch·ªânh (Optional)</label>
                            <div class="flex items-center">
                                <span class="inline-flex items-center px-4 py-3.5 rounded-l-2xl bg-slate-100/80 border border-r-0 border-slate-200 text-slate-500 text-sm font-mono">hunq.link/</span>
                                <input type="text" id="custom-alias" placeholder="ten-tuy-chon" class="glass-input w-full rounded-l-none !border-l-0 pl-4 py-3.5 text-base">
                            </div>
                        </div>

                        <button type="submit" class="ios-btn btn-primary w-full py-4 text-lg shadow-xl shadow-blue-500/20 mt-2">
                            <i class="fas fa-wand-magic-sparkles mr-2"></i>R√∫t G·ªçn Ngay
                        </button>
                    </form>
                    
                    <div id="result-view" class="hidden mt-8 p-1 rounded-2xl bg-gradient-to-r from-green-200 to-blue-200">
                        <div class="bg-white/90 backdrop-blur-xl rounded-xl p-6 flex flex-col sm:flex-row items-center justify-between gap-4">
                            <div class="flex-1 min-w-0 text-left overflow-hidden">
                                <p class="text-xs text-slate-500 font-bold uppercase mb-1">Short Link</p>
                                <a id="short-url" href="#" target="_blank" class="text-blue-600 font-bold text-xl truncate block hover:underline"></a>
                            </div>
                            <button id="copy-btn" class="ios-btn btn-secondary py-2 px-5 text-sm whitespace-nowrap shadow-sm">
                                <i class="fas fa-copy mr-2"></i>Copy
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <div id="redirect-view" class="hidden w-full max-w-6xl text-center fade-in-up">
                 <div class="glass-card p-8">
                    <div class="mb-4 inline-block p-4 rounded-full bg-blue-50 text-blue-600 shadow-inner">
                        <i class="fas fa-share-from-square text-3xl"></i>
                    </div>
                    <h2 class="text-2xl font-bold text-slate-800 mb-4">ƒêang chuy·ªÉn h∆∞·ªõng...</h2>
                    
                    <div id="ad-display-container" class="my-6 rounded-2xl overflow-hidden border border-slate-200 min-h-[150px] relative bg-slate-50 flex items-center justify-center">
                        <p class="text-slate-400 font-medium animate-pulse">ƒêang t·∫£i n·ªôi dung t√†i tr·ª£...</p>
                    </div>

                    <div id="countdown-wrapper" class="mb-6">
                         <div class="text-5xl font-bold text-transparent bg-clip-text bg-gradient-to-r from-blue-600 to-purple-600 font-mono" id="countdown">10</div>
                         <p class="text-slate-500 mt-2 text-sm">Vui l√≤ng ch·ªù gi√¢y l√°t</p>
                    </div>

                    <div id="vip-skip-wrapper" class="hidden mb-6 p-4 rounded-xl bg-amber-50 border border-amber-200 flex items-center gap-3 text-amber-700">
                         <i class="fas fa-crown text-xl text-amber-500"></i>
                         <p class="font-medium text-sm">Th√†nh vi√™n VIP! ƒê∆∞·ª£c b·ªè qua qu·∫£ng c√°o.</p>
                    </div>

                    <button id="get-link-btn" class="ios-btn w-full py-4 bg-slate-200 text-slate-400 cursor-not-allowed transition-all duration-300 font-bold" disabled>
                        ƒêang chu·∫©n b·ªã link...
                    </button>
                </div>
            </div>

            <div id="not-found-view" class="hidden w-full max-w-6xl text-center fade-in-up">
                 <div class="glass-card p-10">
                    <div class="text-6xl mb-4">üõ∏</div>
                    <h2 class="text-3xl font-bold text-slate-800 mb-2">404 Not Found</h2>
                    <p class="text-slate-500 mb-6">Li√™n k·∫øt n√†y kh√¥ng t·ªìn t·∫°i ho·∫∑c ƒë√£ b·ªã x√≥a.</p>
                    <a href="/" class="ios-btn btn-secondary py-2 px-6">V·ªÅ trang ch·ªß</a>
                </div>
            </div>

            <section id="dashboard-view" class="hidden w-full max-w-6xl mx-auto fade-in-up">
                <div class="glass-card overflow-hidden flex flex-col min-h-[300px]">
                    <div class="p-6 border-b border-slate-200/60 flex justify-between items-center bg-white/40">
                        <h3 class="text-lg font-bold text-slate-800"><i class="fas fa-list-ul mr-2 text-blue-500"></i>Link c·ªßa t√¥i</h3>
                    </div>
                    
                    <div class="overflow-x-auto">
                        <table class="w-full glass-table text-left border-collapse">
                            <thead>
                                <tr>
                                    <th class="p-4 pl-6">Link G·ªëc</th>
                                    <th class="p-4">R√∫t g·ªçn</th>
                                    <th class="p-4 text-center">Clicks</th>
                                    <th class="p-4 text-center">Ki·∫øm ti·ªÅn</th>
                                    <th class="p-4 text-right pr-6">X√≥a</th>
                                </tr>
                            </thead>
                            <tbody id="links-table-body" class="text-sm text-slate-600 font-medium">
                                </tbody>
                        </table>
                    </div>
                     <div id="no-links-message" class="hidden text-center py-12 text-slate-400">
                        <i class="fas fa-folder-open text-4xl mb-3 opacity-50"></i>
                        <p>Ch∆∞a c√≥ li√™n k·∫øt n√†o.</p>
                    </div>
                </div>
            </section>

            <section id="admin-view" class="hidden w-full max-w-6xl mx-auto space-y-6 fade-in-up pb-10">
                
                <h2 class="text-2xl font-bold text-white px-2">Admin Control Panel</h2>

                <div class="glass-card p-6 border-l-4 border-l-amber-400">
                    <h3 class="text-xl font-bold text-slate-800 mb-4 flex items-center gap-2">
                        <i class="fas fa-ad text-amber-500"></i> C√†i ƒë·∫∑t Qu·∫£ng C√°o
                    </h3>
                    <form id="admin-ads-form" class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div class="col-span-1 md:col-span-2">
                            <label class="block text-sm font-semibold text-slate-600 mb-2">Lo·∫°i hi·ªÉn th·ªã</label>
                            <div class="flex flex-wrap gap-4 bg-slate-100/50 p-3 rounded-xl border border-slate-200">
                                <label class="flex items-center gap-2 cursor-pointer px-3 py-1 rounded hover:bg-white transition">
                                    <input type="radio" name="ad-type" value="image" class="accent-blue-600 w-4 h-4" checked>
                                    <span>H√¨nh ·∫£nh</span>
                                </label>
                                <label class="flex items-center gap-2 cursor-pointer px-3 py-1 rounded hover:bg-white transition">
                                    <input type="radio" name="ad-type" value="video" class="accent-blue-600 w-4 h-4">
                                    <span>Video (Mp4)</span>
                                </label>
                                <label class="flex items-center gap-2 cursor-pointer px-3 py-1 rounded hover:bg-white transition">
                                    <input type="radio" name="ad-type" value="iframe" class="accent-blue-600 w-4 h-4">
                                    <span>Iframe/Embed</span>
                                </label>
                                <label class="flex items-center gap-2 cursor-pointer px-3 py-1 rounded hover:bg-white transition text-red-500">
                                    <input type="radio" name="ad-type" value="none" class="accent-red-600 w-4 h-4">
                                    <span>T·∫Øt QC</span>
                                </label>
                            </div>
                        </div>

                        <div class="col-span-1 md:col-span-2">
                            <label class="block text-sm font-semibold text-slate-600 mb-1">URL Ngu·ªìn (Source)</label>
                            <input type="text" id="ad-source-url" placeholder="Link ·∫£nh / video / iframe (vd: https://imgur.com/...)" class="glass-input w-full px-4 py-3 text-sm">
                        </div>

                        <div id="ad-dest-group" class="col-span-1 md:col-span-2">
                            <label class="block text-sm font-semibold text-slate-600 mb-1">Link ƒë√≠ch (Click Destination)</label>
                            <input type="text" id="ad-destination-url" placeholder="Trang web m·ªü ra khi click v√†o ·∫£nh..." class="glass-input w-full px-4 py-3 text-sm">
                        </div>

                        <div class="col-span-1 md:col-span-2 pt-2">
                            <button type="submit" class="ios-btn btn-primary w-full py-3 shadow-lg">
                                <i class="fas fa-save mr-2"></i>L∆∞u C·∫•u H√¨nh
                            </button>
                        </div>
                    </form>
                </div>

                <div class="glass-card p-6 bg-white/40">
                     <div class="flex justify-between items-center mb-4">
                        <h3 class="text-xl font-bold text-red-600"><i class="fas fa-shield-halved mr-2"></i>T·∫•t c·∫£ Links</h3>
                        <button id="delete-selected-btn" class="ios-btn btn-danger py-2 px-4 text-xs">
                            <i class="fas fa-trash-alt mr-2"></i>X√≥a m·ª•c ch·ªçn
                        </button>
                     </div>
                     
                     <div class="overflow-x-auto rounded-xl border border-slate-200 bg-white/50 max-h-[400px] overflow-y-auto">
                        <table class="w-full text-left text-sm">
                            <thead class="bg-slate-100/80 text-slate-700 font-semibold uppercase text-xs sticky top-0 backdrop-blur-md">
                                <tr>
                                    <th class="p-3 text-center w-10"><input type="checkbox" id="select-all-checkbox" class="rounded text-blue-600"></th>
                                    <th class="p-3">Original</th>
                                    <th class="p-3">Short</th>
                                    <th class="p-3">Owner</th>
                                    <th class="p-3 text-center">Views</th>
                                    <th class="p-3 text-right">Act</th>
                                </tr>
                            </thead>
                            <tbody id="all-links-table-body" class="divide-y divide-slate-200/60">
                                </tbody>
                        </table>
                    </div>
                </div>

                <div class="glass-card p-6">
                    <h3 class="text-xl font-bold text-slate-800 mb-4 flex items-center gap-2">
                        <i class="fas fa-ban text-red-500"></i> Ch·∫∑n T√™n Mi·ªÅn (Blocklist)
                    </h3>
                    <form id="add-blocklist-form" class="flex gap-3 mb-4">
                        <input type="text" id="new-blocked-domain" placeholder="Nh·∫≠p domain c·∫•m (vd: xxx.com)" class="glass-input flex-1 px-4 py-2 text-sm">
                        <button type="submit" class="ios-btn btn-secondary bg-slate-800 text-white hover:bg-slate-900 px-4 py-2 text-sm">Ch·∫∑n</button>
                    </form>
                    <div class="bg-slate-50/50 rounded-xl p-4 border border-slate-200 max-h-[200px] overflow-y-auto">
                        <ul id="blocklist-items" class="space-y-2">
                            </ul>
                    </div>
                </div>
            </section>

        </main>

        <div id="notification" class="hidden fixed top-6 right-6 z-[100] fade-in-up pointer-events-none">
            <div id="notif-card-content" class="glass-card px-6 py-4 flex items-center gap-3 shadow-2xl border-l-4 bg-white">
                <p id="notification-message" class="font-medium text-sm"></p>
            </div>
        </div>

    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, GoogleAuthProvider, signInWithPopup, signOut, onAuthStateChanged, signInAnonymously, setPersistence, browserLocalPersistence } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, setDoc, updateDoc, deleteDoc, collection, query, where, onSnapshot, writeBatch, arrayUnion, arrayRemove } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- C·∫§U H√åNH ---
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : { apiKey: "AIzaSyB_MUrLjqwC8uSXFsvnFKULbTtyqg7Wo_s", authDomain: "shortlink-4c40e.firebaseapp.com", projectId: "shortlink-4c40e", storageBucket: "shortlink-4c40e.appspot.com", messagingSenderId: "943265709525", appId: "1:943265709525:web:bef219b25ea6d75ebe915c", measurementId: "G-MRM4NZRPK7" };
        const appId = 'default-link-shortener-app';
        const ADMIN_UIDS = ["BHXy7X9TgAfLEY5cwPcz1cClfNP2"]; // !!! THAY UID C·ª¶A B·∫†N V√ÄO ƒê√ÇY

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const provider = new GoogleAuthProvider();
        
        let currentUser = null;
        let blockedDomains = [];
        let blocklistLoaded = false;

        // DOM Elements
        const views = {
            loading: document.getElementById('loading-view'),
            shortener: document.getElementById('shortener-view'),
            redirect: document.getElementById('redirect-view'),
            notFound: document.getElementById('not-found-view'),
            dashboard: document.getElementById('dashboard-view'),
            admin: document.getElementById('admin-view')
        };

        const els = {
            loginBtn: document.getElementById('login-btn'),
            logoutBtn: document.getElementById('logout-btn'),
            userInfo: document.getElementById('user-info'),
            userAvatar: document.getElementById('user-avatar'),
            userName: document.getElementById('user-name'),
            shortenForm: document.getElementById('shorten-form'),
            loggedInOptions: document.getElementById('logged-in-options'),
            resultView: document.getElementById('result-view'),
            shortUrlLink: document.getElementById('short-url'),
            copyBtn: document.getElementById('copy-btn'),
            // Admin Ads
            adminAdsForm: document.getElementById('admin-ads-form'),
            adSourceInput: document.getElementById('ad-source-url'),
            adDestInput: document.getElementById('ad-destination-url'),
            adDisplayContainer: document.getElementById('ad-display-container'),
            // Blocklist
            addBlocklistForm: document.getElementById('add-blocklist-form'),
            blocklistItemsUl: document.getElementById('blocklist-items')
        };

        // --- HELPERS ---
        function hideAllViews() {
            Object.values(views).forEach(v => v.classList.add('hidden'));
        }

        function showNotification(msg, type = 'success') {
            const notif = document.getElementById('notification');
            const content = document.getElementById('notif-card-content');
            const text = document.getElementById('notification-message');
            text.textContent = msg;
            
            content.className = `glass-card px-6 py-4 flex items-center gap-3 shadow-2xl border-l-4 ${type === 'success' ? 'border-green-500 bg-green-50/90 text-green-800' : 'border-red-500 bg-red-50/90 text-red-800'}`;
            
            notif.classList.remove('hidden');
            setTimeout(() => notif.classList.add('hidden'), 3500);
        }

        function getCleanBaseUrl() {
            // Logic: L·∫•y URL g·ªëc, b·ªè index.html, b·ªè d·∫•u / ·ªü cu·ªëi
            let path = window.location.pathname.replace('/index.html', '').replace(/\/$/, '');
            return `${window.location.origin}${path}`;
        }

        // --- MAIN LOGIC ---

        async function handleRouting() {
            const hash = window.location.hash.substring(1);
            if (hash) {
                hideAllViews();
                await handleRedirect(hash);
            } else {
                hideAllViews();
                views.shortener.classList.remove('hidden');
                if(currentUser && !currentUser.isAnonymous){
                    views.dashboard.classList.remove('hidden');
                    handleAdminCheck(currentUser);
                }
            }
        }

        // --- REDIRECT & ADS DISPLAY ---
        async function renderAdsOnRedirect() {
            const adsConfigRef = doc(db, 'artifacts', appId, 'public', 'data', 'config', 'ads_settings');
            const docSnap = await getDoc(adsConfigRef);
            els.adDisplayContainer.innerHTML = '';

            if (!docSnap.exists() || docSnap.data().type === 'none') {
                els.adDisplayContainer.innerHTML = '<p class="text-slate-400 text-sm">[ Khu v·ª±c tr·ªëng ]</p>';
                return;
            }

            const config = docSnap.data();
            let html = '';

            if (config.type === 'image') {
                html = `<a href="${config.destUrl || '#'}" target="_blank" class="w-full h-full flex items-center justify-center bg-black/5">
                            <img src="${config.sourceUrl}" class="max-w-full max-h-[300px] object-contain hover:scale-[1.01] transition duration-500" onerror="this.style.display='none'">
                        </a>`;
            } else if (config.type === 'video') {
                html = `<video src="${config.sourceUrl}" autoplay muted loop playsinline controls class="w-full max-h-[300px] bg-black rounded-lg"></video>`;
            } else if (config.type === 'iframe') {
                html = `<iframe src="${config.sourceUrl}" class="w-full h-[300px] border-0" allowfullscreen></iframe>`;
            }
            els.adDisplayContainer.innerHTML = html;
        }

        async function handleRedirect(alias) {
            const linkRef = doc(db, 'artifacts', appId, 'public', 'data', 'links', alias);
            const linkSnap = await getDoc(linkRef);

            if (linkSnap.exists()) {
                views.redirect.classList.remove('hidden');
                renderAdsOnRedirect(); // Load Ads

                const data = linkSnap.data();
                updateDoc(linkRef, { clickCount: (data.clickCount || 0) + 1 }); // Count View

                const btn = document.getElementById('get-link-btn');
                const counterWrap = document.getElementById('countdown-wrapper');
                const vipWrap = document.getElementById('vip-skip-wrapper');

                // Check VIP
                let isVip = false;
                if (currentUser && !currentUser.isAnonymous) {
                    const uSnap = await getDoc(doc(db, 'artifacts', appId, 'public', 'data', 'users', currentUser.uid));
                    if (uSnap.exists() && uSnap.data().isVip) isVip = true;
                }

                const enableBtn = () => {
                    btn.disabled = false;
                    btn.className = 'ios-btn btn-primary w-full py-4 text-lg shadow-lg transform hover:scale-[1.02]';
                    btn.textContent = "Truy c·∫≠p Link G·ªëc";
                    btn.onclick = () => window.location.href = data.originalUrl;
                };

                if (isVip || !data.adsEnabled) {
                    if (!data.adsEnabled) { window.location.href = data.originalUrl; return; }
                    counterWrap.classList.add('hidden');
                    vipWrap.classList.remove('hidden');
                    enableBtn();
                    return;
                }

                counterWrap.classList.remove('hidden');
                vipWrap.classList.add('hidden');
                let count = 10;
                const countEl = document.getElementById('countdown');
                countEl.textContent = count;

                const intv = setInterval(() => {
                    count--;
                    countEl.textContent = count;
                    if (count <= 0) { clearInterval(intv); enableBtn(); }
                }, 1000);

            } else {
                views.notFound.classList.remove('hidden');
            }
        }

        // --- SHORTENER LOGIC ---
        els.shortenForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            let url = document.getElementById('original-url').value.trim();
            const aliasCustom = document.getElementById('custom-alias').value.trim();

            if (!url) return;
            if (!/^https?:\/\//i.test(url)) url = 'https://' + url;

            // Security Checks
            if (blockedDomains.some(d => url.toLowerCase().includes(d.toLowerCase()))) {
                showNotification('Domain n√†y b·ªã c·∫•m.', 'error'); return;
            }
            if (['porn','sex','bet','casino'].some(k => url.toLowerCase().includes(k))) {
                showNotification('N·ªôi dung kh√¥ng h·ª£p l·ªá.', 'error'); return;
            }

            let alias = aliasCustom || Math.random().toString(36).substring(2, 8);
            const ref = doc(db, 'artifacts', appId, 'public', 'data', 'links', alias);

            if(aliasCustom) {
                const s = await getDoc(ref);
                if(s.exists()) { showNotification('T√™n n√†y ƒë√£ t·ªìn t·∫°i.', 'error'); return; }
            }

            try {
                await setDoc(ref, {
                    originalUrl: url,
                    ownerId: currentUser.uid,
                    createdAt: new Date(),
                    clickCount: 0,
                    adsEnabled: true
                });

                // Create Clean Link
                const shortLink = `${getCleanBaseUrl()}#${alias}`;
                els.shortUrlLink.href = shortLink;
                els.shortUrlLink.textContent = shortLink.replace(/^https?:\/\//, '');
                
                els.resultView.classList.remove('hidden');
                els.resultView.classList.add('fade-in-up');
                showNotification('T·∫°o link th√†nh c√¥ng!');
                els.shortenForm.reset();
            } catch (err) {
                console.error(err);
                showNotification('L·ªói h·ªá th·ªëng.', 'error');
            }
        });

        // --- USER DASHBOARD ---
        function loadUserLinks(uid) {
            const q = query(collection(db, 'artifacts', appId, 'public', 'data', 'links'), where("ownerId", "==", uid));
            onSnapshot(q, (snap) => {
                const tbody = document.getElementById('links-table-body');
                const noMsg = document.getElementById('no-links-message');
                tbody.innerHTML = '';
                noMsg.classList.toggle('hidden', !snap.empty);

                snap.forEach((d) => {
                    const l = d.data();
                    const alias = d.id;
                    const shortLink = `${getCleanBaseUrl()}#${alias}`;
                    
                    tbody.innerHTML += `
                        <tr>
                            <td class="p-4 pl-6"><div class="truncate max-w-[150px] sm:max-w-xs text-slate-500" title="${l.originalUrl}">${l.originalUrl}</div></td>
                            <td class="p-4"><a href="${shortLink}" target="_blank" class="text-blue-600 font-medium hover:underline">${alias}</a></td>
                            <td class="p-4 text-center font-bold text-slate-700">${l.clickCount}</td>
                            <td class="p-4 text-center">
                                <div class="flex justify-center">
                                    <input type="checkbox" id="toggle-${alias}" class="toggle-checkbox hidden user-toggle-ads" data-id="${alias}" ${l.adsEnabled ? 'checked' : ''}>
                                    <label for="toggle-${alias}" class="toggle-label"></label>
                                </div>
                            </td>
                            <td class="p-4 pr-6 text-right">
                                <button class="text-red-400 hover:text-red-600 transition p-2 user-del-btn" data-id="${alias}"><i class="fas fa-trash"></i></button>
                            </td>
                        </tr>
                    `;
                });

                // User Actions
                document.querySelectorAll('.user-del-btn').forEach(b => b.onclick = async (e) => {
                    if(confirm('X√≥a link n√†y?')) await deleteDoc(doc(db, 'artifacts', appId, 'public', 'data', 'links', e.currentTarget.dataset.id));
                });
                document.querySelectorAll('.user-toggle-ads').forEach(t => t.onchange = async (e) => {
                    await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'links', e.target.dataset.id), { adsEnabled: e.target.checked });
                });
            });
        }

        // --- ADMIN LOGIC ---
        async function loadAdsConfigToAdmin() {
            const snap = await getDoc(doc(db, 'artifacts', appId, 'public', 'data', 'config', 'ads_settings'));
            if (snap.exists()) {
                const d = snap.data();
                els.adSourceInput.value = d.sourceUrl || '';
                els.adDestInput.value = d.destUrl || '';
                const r = document.querySelector(`input[name="ad-type"][value="${d.type}"]`);
                if(r) r.checked = true;
                toggleDestInput(d.type);
            }
        }

        function toggleDestInput(type) {
            const g = document.getElementById('ad-dest-group');
            type === 'image' ? g.classList.remove('hidden') : g.classList.add('hidden');
        }

        function handleAdminCheck(user) {
            if (user && ADMIN_UIDS.includes(user.uid)) {
                views.admin.classList.remove('hidden');
                loadAllLinksForAdmin();
                
                // Admin Blocks
                if(!blocklistLoaded) {
                    onSnapshot(doc(db, 'artifacts', appId, 'public', 'data', 'config', 'blocklist'), (s) => {
                        blockedDomains = s.exists() ? (s.data().domains || []) : [];
                        renderBlocklist();
                    });
                    blocklistLoaded = true;
                }
                
                // Admin Ads
                loadAdsConfigToAdmin();
            } else {
                views.admin.classList.add('hidden');
            }
        }

        // Admin Ads Save
        els.adminAdsForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const type = document.querySelector('input[name="ad-type"]:checked').value;
            const src = els.adSourceInput.value.trim();
            const dest = els.adDestInput.value.trim();

            if(type !== 'none' && !src) { showNotification('Thi·∫øu URL ngu·ªìn!', 'error'); return; }

            try {
                await setDoc(doc(db, 'artifacts', appId, 'public', 'data', 'config', 'ads_settings'), {
                    type, sourceUrl: src, destUrl: dest,
                    updatedAt: new Date(), updatedBy: currentUser.uid
                });
                showNotification('ƒê√£ l∆∞u c·∫•u h√¨nh Qu·∫£ng c√°o!');
            } catch(err) { showNotification('L·ªói l∆∞u config.', 'error'); }
        });

        document.querySelectorAll('input[name="ad-type"]').forEach(r => r.addEventListener('change', (e) => toggleDestInput(e.target.value)));

        // Admin Links & Blocklist Render Logic (Simplified for length)
        function loadAllLinksForAdmin() {
             onSnapshot(query(collection(db, 'artifacts', appId, 'public', 'data', 'links')), (snap) => {
                const tb = document.getElementById('all-links-table-body');
                tb.innerHTML = '';
                snap.forEach(d => {
                    const l = d.data();
                    const alias = d.id;
                    tb.innerHTML += `
                        <tr class="hover:bg-slate-50">
                            <td class="p-3 text-center"><input type="checkbox" class="admin-chk rounded border-gray-300" data-id="${alias}"></td>
                            <td class="p-3"><div class="truncate max-w-[120px]" title="${l.originalUrl}">${l.originalUrl}</div></td>
                            <td class="p-3 text-blue-600 font-mono text-xs">${alias}</td>
                            <td class="p-3"><div class="truncate max-w-[60px] bg-slate-100 px-1 rounded text-xs">${l.ownerId}</div></td>
                            <td class="p-3 text-center">${l.clickCount}</td>
                            <td class="p-3 text-right"><button class="text-slate-400 hover:text-red-600 admin-del" data-id="${alias}"><i class="fas fa-trash"></i></button></td>
                        </tr>
                    `;
                });
                // Bind events
                document.querySelectorAll('.admin-del').forEach(b => b.onclick = async(e) => {
                    if(confirm('Admin: X√≥a link n√†y?')) await deleteDoc(doc(db, 'artifacts', appId, 'public', 'data', 'links', e.currentTarget.dataset.id));
                });
             });
             
             // Bulk Delete
             document.getElementById('select-all-checkbox').onchange = (e) => document.querySelectorAll('.admin-chk').forEach(c => c.checked = e.target.checked);
             document.getElementById('delete-selected-btn').onclick = async () => {
                 const ids = Array.from(document.querySelectorAll('.admin-chk:checked')).map(c => c.dataset.id);
                 if(ids.length && confirm(`X√≥a ${ids.length} links?`)) {
                     const batch = writeBatch(db);
                     ids.forEach(id => batch.delete(doc(db, 'artifacts', appId, 'public', 'data', 'links', id)));
                     await batch.commit();
                 }
             };
        }

        function renderBlocklist() {
            els.blocklistItemsUl.innerHTML = '';
            blockedDomains.forEach(d => {
                els.blocklistItemsUl.innerHTML += `<li class="flex justify-between items-center bg-white p-2 rounded shadow-sm border border-slate-100 text-sm"><span class="font-mono">${d}</span><button class="text-red-400 hover:text-red-600 blk-del" data-d="${d}">&times;</button></li>`;
            });
            document.querySelectorAll('.blk-del').forEach(b => b.onclick = async (e) => {
                await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'config', 'blocklist'), { domains: arrayRemove(e.currentTarget.dataset.d) });
            });
        }

        els.addBlocklistForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const d = document.getElementById('new-blocked-domain').value.trim().toLowerCase();
            if(!d) return;
            const ref = doc(db, 'artifacts', appId, 'public', 'data', 'config', 'blocklist');
            try { await updateDoc(ref, { domains: arrayUnion(d) }); } catch { await setDoc(ref, { domains: [d] }); }
            document.getElementById('new-blocked-domain').value = '';
        });

        // --- AUTH & INIT ---
        els.loginBtn.onclick = async () => {
            const r = await signInWithPopup(auth, provider);
            const u = r.user;
            const uRef = doc(db, 'artifacts', appId, 'public', 'data', 'users', u.uid);
            if(!(await getDoc(uRef)).exists()) await setDoc(uRef, { displayName: u.displayName, email: u.email, createdAt: new Date(), isVip: false });
        };
        els.logoutBtn.onclick = () => signOut(auth);
        els.copyBtn.onclick = () => {
            navigator.clipboard.writeText(els.shortUrlLink.href);
            showNotification('ƒê√£ sao ch√©p!');
        };

        setPersistence(auth, browserLocalPersistence).then(() => {
            onAuthStateChanged(auth, (user) => {
                if (user) {
                    currentUser = user;
                    if (user.isAnonymous) {
                        els.loginBtn.classList.remove('hidden');
                        els.userInfo.classList.add('hidden');
                    } else {
                        els.loginBtn.classList.add('hidden');
                        els.userInfo.classList.remove('hidden');
                        els.userInfo.classList.add('flex');
                        els.userAvatar.src = user.photoURL;
                        els.userName.textContent = user.displayName;
                        els.loggedInOptions.classList.remove('hidden');
                        loadUserLinks(user.uid);
                        handleAdminCheck(user);
                    }
                } else {
                    signInAnonymously(auth);
                }
                handleRouting();
            });
        });
    </script>
</body>
</html>